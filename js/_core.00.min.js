// 2024-12-09
var xul_mode,webkit_mode;var DragDrop={init:function(e,t,r){if(xul_mode){e.addEventListener("dragover",XPCOM_object._dragOver,true);e.addEventListener("drop",XPCOM_object._dragDrop,true)}else if(webkit_mode){e.addEventListener("dragenter",WebKit_object._dragEnter,false);e.addEventListener("dragexit",WebKit_object._dragExit,false);e.addEventListener("dragover",WebKit_object._dragOver,false);e.addEventListener("drop",WebKit_object._drop,false)}else{e.ondragenter=function(e){DragDrop.onDragEnter(e)};e.ondragover=function(e){DragDrop.onDragOver(e)};e.ondrop=function(e){DragDrop.onDrop(e)}}this.onDrop_finish=t;this.validate_func=r?r:function(e){return e.isFolder};if(!ie9_mode)return;this._ondrop_finish=t;this._ondrop_finish_process=async function(e,t){await DragDrop.drop_target(e.isFolder)._ondrop_finish(e,t)};Object.defineProperty(this,"onDrop_finish",{get:function(){return this._ondrop_finish_process},set:function(e){this._ondrop_finish=e}});this._validate_func=this.validate_func;this._validate_func_process=function(e,t){return DragDrop.drop_target(e.isFolder)._validate_func(e,t)};Object.defineProperty(this,"validate_func",{get:function(){return this._validate_func_process},set:function(e){this._validate_func=e}});this.drop_target=function(e){var t;if(!e&&!this._no_relay){var r=self.is_SA_child_animation?parent:self;var n=r.DragDrop.relay_id;if(n!=null&&r.SA_child_animation[n])t=r.document.getElementById("Ichild_animation"+n).contentWindow.DragDrop}if(!t){t=self.is_SA_child_animation&&self.ChildMirror_id!=null&&parent.SA_child_animation[ChildMirror_id]?parent.document.getElementById("Ichild_animation"+ChildMirror_id).contentWindow.DragDrop:this}return t}},validateDropItem:function(e){try{var t=System.Shell.itemFromFileDrop(e,0);return this.validate_func(t)}catch(r){return false}},_dragAccepted:false,onDragEnter:function(e){event.returnValue=false;if(this.validateDropItem(event.dataTransfer)){event.dataTransfer.dropEffect="link";this._dragAccepted=true}else{event.dataTransfer.dropEffect="none";this._dragAccepted=false}},onDragOver:function(e){if(this._dragAccepted){event.returnValue=false;event.dataTransfer.dropEffect="link"}},onDrop:function(e){event.returnValue=false;var t=System.Shell.itemFromFileDrop(event.dataTransfer,0);if(t==null)return;this.onDrop_finish(t)}};
var use_gallery_img_cache;var use_native_img;var native_img_objs=[];function imgCache_Object(i,e,t){self[i]=null;this.img_id=i;this.img_parent_id=e;this.use_native_img=!!t;if(t)native_img_objs.push(this);this.path_last="";this.img_cache=[];this.SS_mode=false;this.img_for_preload=null;this.SS_preload=imgCache_SS_Preload;this.SS_path_list_lvl=0;this.SS_path_list_index=-1;this.SS_path_list=[null,null];this.SS_path=null;this.load=imgCache_Load;this.show=imgCache_Show;this.clear=imgCache_Clear;this.createIMG=imgCache_CreateIMG;this.styleUpdate=imgCache_StyleUpdate}function imgCache_Clear(){self[this.img_id]=null;this.img_cache=[]}function imgCache_StyleObject(){this.posLeft=null;this.posTop=null;this.pixelWidth=null;this.pixelHeight=null}function imgCache_StyleUpdate(){if(!this.use_native_img)return;var i=self[this.img_id];var e=i.img;var t=i.width;var s=i.height;var h=e.width;var l=e.height;var a=i.style;if(a.pixelWidth!=null)e.width=h=a.pixelWidth;if(a.pixelHeight!=null)e.height=l=a.pixelHeight;if(a.posLeft!=null)e.left=a.posLeft+(h-t)/2;if(a.posTop!=null)e.top=a.posTop+(l-s)/2}function imgCache_CreateIMG(i){var e;if(this.use_native_img){var t=toLocalPath(i);e={img:BG.addImageObject(t,0,0),src:i,style:new imgCache_StyleObject};e.width=e.img.width;e.height=e.img.height}else{e=document.createElement("img");e.style.position="absolute";e.src=i;document.getElementById(this.img_parent_id).appendChild(e)}e.docked=System.Gadget.docked;return e}function imgCache_Show(i){var e=self[this.img_id];if(!e)return;if(this.use_native_img)e.img.opacity=i?100:0;else{if(use_gallery_img_cache||this.img_for_preload)e.style.display=i?"block":"none";else e.style.visibility=i?"inherit":"hidden"}}function imgCache_Load(i){var e;var t=false;if(!this.use_native_img&&!use_gallery_img_cache&&(!this.img_for_preload||!this.img_cache[i])){e=self[this.img_id];if(e){if(this.path_last==i)t=true;else{e.src=i;this.path_last=i}e.style.visibility="inherit"}else self[this.img_id]=this.createIMG(i);return t}e=this.img_cache[i];if(e){if(e.docked==System.Gadget.docked)t=e.initialized;else{e.docked=System.Gadget.docked;t=false}}else{e=this.img_cache[i]=this.createIMG(i);t=false}if(self[this.img_id])this.show(false);if(this.img_for_preload){this.img_for_preload=self[this.img_id];this.img_cache=[]}self[this.img_id]=e;this.show(true);return t}function imgCache_SS_Preload(){var i=this.SS_path_list[this.SS_path_list_lvl][++this.SS_path_list_index];if(++this.SS_path_list_index>=this.SS_path_list[this.SS_path_list_lvl].length){this.SS_path_list_index=-1;if(this.SS_path_list_lvl==0){var e=SEQ_gallery_all[SEQ_gallery_index];if(e.count+1>=e.loop)this.SS_path_list_lvl=1}}var t=this.img_cache[i];if(t){t.initialized=false;return}if(!use_gallery_img_cache&&this.img_for_preload){this.img_for_preload.src=i;t=this.img_cache[i]=this.img_for_preload}else{t=this.img_cache[i]=this.createIMG(i);if(!use_gallery_img_cache)this.img_for_preload=t}t.style.visibility="inherit";t.style.display="none";t.initialized=false}
if(!Date.now){Date.now=function now(){return(new Date).getTime()}}var seq_items=[];function Seq_object(){this.item=Seq_item;this.JS_timer_used=[];this.JS_timer_active=[];this.setInterval=Seq_setInterval;this.clearInterval=Seq_clearInterval;this.clearTimeout=Seq_clearInterval}function Seq_item(t){if(!seq_items[t])seq_items[t]=new Seq_core(t);return seq_items[t]}function Seq_core(t){this.name=t;this.count=0;this.At=Seq_at;this.Play=this.play=Seq_play;this.Pause=this.pause=Seq_pause;this.Stop=Seq_stop;this.exec=Seq_exec}function Seq_at(init_delay,func,max_count,interval){this.initialized=true;this.init_delay=parseInt(init_delay*1e3)+1;if(typeof func=="string")eval("this.func = function () {"+(func+(/^\s*\w+$/.test(func)?"()":""))+"}");else this.func=func;this.max_count=max_count;this.interval=this.interval_current=parseInt(interval*1e3);this.update_time_last=0}function Seq_play(){if(!this.initialized)return;this.paused=false;if(this.count){if(this.timerID)return;seq_items[this.name].exec()}else{if(this.timerID)clearTimeout(this.timerID);var t=this.name;this.timerID=setTimeout(function(){seq_items[t].exec();t=null},this.init_delay)}}var Seq_interval_current_min=10;function Seq_exec(){if(this.paused)return;if(this.count++==this.max_count){this.Stop();return}var t=Date.now();var e=this.update_time_last;var i=this.interval_current;this.interval_current=null;if(this.interval>Seq_interval_current_min&&e>0){var n=t-e-i;if(n>0){i=this.interval-n;if(i<Seq_interval_current_min)i=Seq_interval_current_min;this.interval_current=i}}this.update_time_last=t;if(this.interval_current==null)this.interval_current=this.interval;var s=this.name;this.timerID=setTimeout(function(){seq_items[s].exec();s=null},this.interval_current);this.func()}function Seq_stop(){this.Pause();this.count=0;if(Seq.onstop)Seq.onstop(this.name)}function Seq_pause(){this.paused=true;if(!this.timerID)return;clearTimeout(this.timerID);this.timerID=null}function Seq_setInterval(t,e){var i=-1;for(var n=0;n<this.JS_timer_used.length;n++){if(!this.JS_timer_used[n]){i=n;break}}if(i==-1)i=this.JS_timer_used.length;var s="T"+Date.now();while(this.JS_timer_active[s]){s+="-0"}this.JS_timer_active[s]=i+1;this.JS_timer_used[i]=true;e/=1e3;var r=Seq.item("JS-timer"+i);r.At(e,t,-1,e);r.Play();DEBUG_show("SI:"+i,2);return s}function Seq_clearInterval(t){var e=this.JS_timer_active[t];if(!e){return}e--;this.JS_timer_active[t]=null;this.JS_timer_used[e]=null;Seq.item("JS-timer"+e).Stop();DEBUG_show("CI:"+e,2)}var Seq,SeqOBJ;Seq=SeqOBJ=new Seq_object;
function Shell_ReturnItemsFromFolder(e,l,r){if(!l)l={};if(!l.RE_items)l.RE_items=/\.(bmp|gif|jpg|jpeg|png)$/i;if(!l.gallery)l.gallery=[];if(!l.item_limit)l.item_limit=9999;if(!r)l._shell_item_count=0;let t;try{t=System.Shell.itemFromPath(e)}catch(m){}if(!t)return r?null:[];let n=t.SHFolder.Items;for(let e=0,t=n.count;e<t;e++){if(++l._shell_item_count>l.item_limit){if(r)return null;else break}let i=n.item(e);if(i.isLink){if(l.skip_link)continue;let e;try{e=System.Shell.itemFromPath(i.link.path)}catch(m){}if(!e)continue;i=e}if(i.isFolder){if(l.skip_subfolder)continue;if(!Shell_ReturnItemsFromFolder(i.path,l,true)){if(r)return null}}else if(i.isFileSystem){let e=i.path;if(!l.RE_items.test(e))continue;let t={index:l.gallery.length,path:e,path_file:toFileProtocol(e)};l.gallery.push(t)}}return l.gallery}
