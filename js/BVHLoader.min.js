// 2024-11-23
var BVHLoader=function(){var e;var g,t,d;var E,h,y;var o,i;var v={};var o;function m(){if(e)return;e=true;g=new THREE.Vector3;t=new THREE.Vector3;d=new THREE.Vector3;E=new THREE.Quaternion;h=new THREE.Quaternion;y=new THREE.Quaternion;i=new Uint8Array([20,20,20,20,20,20,20,20,107,107,107,107,107,107,107,107]);T.prototype=Object.create(o.prototype);T.prototype.cameraKeys=[];T.prototype.lightKeys=[];T.prototype.morphKeys=[]}function D(e,t,o,r){this.name=e;this.time=t;this.pos=o;this.rot=r;this.interp=i}function T(e,t){this.boneKeys=e;this.timeMax=t}function r(e){const r=e;e=toFileProtocol(e);return promise=new Promise(t=>{var o=new XMLHttpRequestZIP;o.onload=function(){if(1||o.status===200){let e=s(o.response);e[0].url=r;t(e)}else{console.error(r,o.statusText)}o=null};o.open("GET",e,true);o.responseType="text";o.send()})}function s(e){function t(t){if(f(t)!=="HIERARCHY"){console.error("THREE.BVHLoader: HIERARCHY expected.")}const e=[];const o=_(t,f(t),e);if(f(t)!=="MOTION"){console.error("THREE.BVHLoader: MOTION expected.")}let r=f(t).split(/[\s]+/);const i=parseInt(r[1]);if(isNaN(i)){console.error("THREE.BVHLoader: Failed to read number of frames.")}r=f(t).split(/[\s]+/);const s=parseFloat(r[2]);if(isNaN(s)){console.error("THREE.BVHLoader: Failed to read frame time.")}for(let e=0;e<i;e++){r=f(t).split(/[\s]+/);l(r,e*s,o)}return e}function l(t,o,r){if(r.type==="ENDSITE")return;const i={time:o,position:new THREE.Vector3,rotation:new THREE.Quaternion};r.frames.push(i);const s=new THREE.Quaternion;const a=new THREE.Vector3(1,0,0);const n=new THREE.Vector3(0,1,0);const _=new THREE.Vector3(0,0,1);for(let e=0;e<r.channels.length;e++){switch(r.channels[e]){case"Xposition":i.position.x=parseFloat(t.shift().trim());break;case"Yposition":i.position.y=parseFloat(t.shift().trim());break;case"Zposition":i.position.z=parseFloat(t.shift().trim());break;case"Xrotation":s.setFromAxisAngle(a,parseFloat(t.shift().trim())*Math.PI/180);i.rotation.multiply(s);break;case"Yrotation":s.setFromAxisAngle(n,parseFloat(t.shift().trim())*Math.PI/180);i.rotation.multiply(s);break;case"Zrotation":s.setFromAxisAngle(_,parseFloat(t.shift().trim())*Math.PI/180);i.rotation.multiply(s);break;default:console.warn("THREE.BVHLoader: Invalid channel type.")}}for(let e=0;e<r.children.length;e++){l(t,o,r.children[e])}}function _(e,t,o){const r={name:"",type:"",frames:[]};o.push(r);let i=t.split(/[\s]+/);if(i[0].toUpperCase()==="END"&&i[1].toUpperCase()==="SITE"){r.type="ENDSITE";r.name="ENDSITE"}else{r.name=i.slice(1).join(" ");r.type=i[0].toUpperCase()}if(f(e)!=="{"){console.error("THREE.BVHLoader: Expected opening { after type & name")}i=f(e).split(/[\s]+/);if(i[0]!=="OFFSET"){console.error("THREE.BVHLoader: Expected OFFSET but got: "+i[0])}if(i.length!==4){console.error("THREE.BVHLoader: Invalid number of values for OFFSET.")}const s=new THREE.Vector3(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));if(isNaN(s.x)||isNaN(s.y)||isNaN(s.z)){console.error("THREE.BVHLoader: Invalid values of OFFSET.")}r.offset=s;if(r.type!=="ENDSITE"){i=f(e).split(/[\s]+/);if(i[0]!=="CHANNELS"){console.error("THREE.BVHLoader: Expected CHANNELS definition.")}const a=parseInt(i[1]);r.channels=i.splice(2,a);r.children=[]}while(true){const n=f(e);if(n==="}"){return r}else{r.children.push(_(e,n,o))}}}function f(e){let t;while((t=e.shift().trim()).length===0){}return t}function s(e){var t;if(/left/i.test(e))t="左";else if(/right/i.test(e))t="右";else if(/^(l|r)/.test(e))t=RegExp.$1=="r"?"右":"左";else if(/_(L|R)$/.test(e))t=RegExp.$1=="R"?"右":"左";else if(/(^|\s)(L|R)\s/.test(e))t=RegExp.$2=="R"?"右":"左";return t}function a(e){var t="指";var o;if(e.indexOf("Proximal")!=-1){o=1}else if(e.indexOf("Intermediate")!=-1){o=2}else if(e.indexOf("Distal")!=-1){o=3}else{o=parseInt(e.charAt(e.length-1))}o+=/thumb/i.test(e)?-1:0;t+=b[o];return t}const o=e.split(/[\r\n]+/g);const n=t(o);m();const p={};n[0].bones_MMD=p;n.forEach((o,e)=>{o.children&&o.children.forEach(e=>{e.parent=o});o._rot_accumulated=new THREE.Quaternion;o.group="";let t=o.name;if(/hip/i.test(t)&&!p["_root_"]){o.name_MMD="センター";o.root=true;p["_root_"]=o}else if(/lowerback/i.test(t)){}else if(!p["上半身"]&&/abdomen|spine|chest/i.test(t)){o.name_MMD="上半身";o.group="upper_body";o.use_axis=true}else if(/spine\d/i.test(t)||/chest\d/i.test(t)){if(!p["上半身2"]){o.name_MMD="上半身2";o.group="upper_body";o.use_axis=true}else{const r=p["上半身2"];r.frames.forEach((e,t)=>{e.rotation.multiply(o.frames[t].rotation)})}}else if(/lowerneck/i.test(t)){}else if(/neck$/i.test(t)){o.name_MMD="首";o.group="upper_body";o.use_axis=true}else if(!p["頭"]&&/head/i.test(t)){o.name_MMD="頭";o.group="upper_body";o.use_axis=true;o.parent_offset_as_axis=true}else if(/shoulder|collar/i.test(t)&&!p[s(t)+"肩"]){o.name_MMD=s(t)+"肩";if(o.offset.length()>.001){o.group="upper_body|arm";const i="_root_arm_"+s(t)+"_";p[i]=o;o.use_axis=true}}else if(/arm/i.test(t)&&(/up/i.test(t)||/forearm/i.test(n[e+1].name))||/shldr|shoulder/i.test(t)){o.name_MMD=s(t)+"腕";o.group="upper_body|arm";const i="_root_arm_"+s(t)+"_";if(!p[i]){p[i]=o}o.use_axis=true}else if(/arm/i.test(t)&&/low/i.test(t)||/forearm|elbow/i.test(t)){o.name_MMD=s(t)+"ひじ";o.group="upper_body|arm";o.use_axis=true}else if(/hand|wrist/i.test(t)&&!p[s(t)+"手首"]){o.name_MMD=s(t)+"手首";o.group="upper_body|arm";o.use_axis=true;o.parent_offset_as_axis=true}else if(/buttock/i.test(t)){const i="_root_leg_"+s(t)+"_";p[i]=o}else if(/hipjoint/i.test(t)){}else if(/leg/i.test(t)&&/up/i.test(t)||/thigh|.+hip/i.test(t)){o.name_MMD=s(t)+"足";o.group="lower_body|leg";const i="_root_leg_"+s(t)+"_";if(!p[i]){p[i]=o}o.use_axis=true}else if(/leg/i.test(t)&&(/low/i.test(t)||/up/i.test(n[e-1].name))||/shin|knee|calf/i.test(t)){o.name_MMD=s(t)+"ひざ";o.group="lower_body|leg";o.use_axis=true}else if(/foot|ankle/i.test(t)){o.name_MMD=s(t)+"足首";o.group="lower_body|leg";o.use_axis=true;Object.defineProperty(o,"ignore_axis_rot",function(){var e=null;return{get:function(){if(e==null){e=Math.abs(o.axis_rot_offset_inv.toAxisAngle()[1])>Math.PI/8}return e}}}())}else if(/toes/i.test(t)){o.name_MMD=s(t)+"足先EX";o.group="lower_body|leg";o.use_axis=false}else if(/thumb(\d|Proximal|Intermediate|Distal)/i.test(t)){o.name_MMD=s(t)+"親"+a(t);o.group="upper_body|finger";o.use_axis=true}else if(/index(\d|Proximal|Intermediate|Distal)/i.test(t)){o.name_MMD=s(t)+"人"+a(t);o.group="upper_body|finger";o.use_axis=true}else if(/(mid|middle)(\d|Proximal|Intermediate|Distal)/i.test(t)){o.name_MMD=s(t)+"中"+a(t);o.group="upper_body|finger";o.use_axis=true}else if(/ring(\d|Proximal|Intermediate|Distal)/i.test(t)){o.name_MMD=s(t)+"薬"+a(t);o.group="upper_body|finger";o.use_axis=true}else if(/(pinky|little)(\d|Proximal|Intermediate|Distal)/i.test(t)){o.name_MMD=s(t)+"小"+a(t);o.group="upper_body|finger";o.use_axis=true}if(o.name_MMD)p[o.name_MMD]=o});n.forEach((e,t)=>{if(e.name_MMD){if(!e.root&&!e.group){delete e.name_MMD;delete p[e.name_MMD]}else return}let o=e;while(!o.name_MMD){if(e.root||!o.children||!o.children.length){o=null;break}o=o.children[0]}if(o&&o.name_MMD){e.group=o.group}});n[0].leg_length=(p["左ひざ"].offset.length()+p["左足首"].offset.length())/10;console.log("leg_length (BVH)",n[0].leg_length);if(p["上半身"]&&p["_root_arm_左_"]&&p["_root_arm_右_"]){const r=MMD_SA._v3a.copy(p["上半身"].offset).normalize();const i=MMD_SA._v3b.copy(p["_root_arm_左_"].offset).sub(p["_root_arm_右_"].offset).normalize();const u=MMD_SA.TEMP_v3.crossVectors(i,r).normalize();const c=MMD_SA.TEMP_m4.set(i.x,i.y,i.z,0,r.x,r.y,r.z,0,u.x,u.y,u.z,0,0,0,0,1);p["上半身"].root_axis_rot=(new THREE.Quaternion).setFromBasis(c);p["上半身"].is_Tpose=Math.abs(p["上半身"].root_axis_rot.toAxisAngle()[1])<Math.PI/4}if(p["上半身"]&&p["_root_leg_左_"]&&p["_root_leg_右_"]){const r=MMD_SA._v3a.copy(p["上半身"].offset).normalize();const i=MMD_SA._v3b.copy(p["_root_leg_左_"].offset).sub(p["_root_leg_右_"].offset).normalize();const u=MMD_SA.TEMP_v3.crossVectors(i,r).normalize();const c=MMD_SA.TEMP_m4.set(i.x,i.y,i.z,0,r.x,r.y,r.z,0,u.x,u.y,u.z,0,0,0,0,1);p["下半身"]={root_axis_rot:(new THREE.Quaternion).setFromBasis(c)};p["下半身"].is_Tpose=Math.abs(p["下半身"].root_axis_rot.toAxisAngle()[1])<Math.PI/4}n.forEach((t,e)=>{if(!t.use_axis)return;if(t.parent_offset_as_axis){t.axis=t.offset.clone();let e=t.parent;while(e&&!e.name_MMD){t.axis.add(e.offset);e=e.parent}}else{t.axis=t.children[0].offset.clone();let e=t.children[0];while(e&&!e.name_MMD&&e.type!="ENDSITE"){t.axis.add(e.offset);e=e.children[0]}}t.axis.normalize();var o=t.name_MMD;var r=h.set(0,0,0,1);if(t.group.indexOf("upper_body")!=-1){if(p["上半身"]&&p["上半身"].root_axis_rot)r.copy(p["上半身"].root_axis_rot)}else if(t.group.indexOf("lower_body")!=-1){if(p["下半身"]&&p["下半身"].root_axis_rot)r.copy(p["下半身"].root_axis_rot)}t.axis.applyQuaternion(r);let i=o.charAt(0)=="左"?1:o.charAt(0)=="右"?-1:0;let s;var a,n,_;if(/arm|finger/.test(t.group)){s=p["上半身"].is_Tpose;a=MMD_SA._v3a.copy(t.axis);if(i==-1)a.x*=-1;_=MMD_SA._v3b.set(0,0,s?1:i).applyQuaternion(E.setFromUnitVectors(g.set(1,0,0),a));n=MMD_SA.TEMP_v3.crossVectors(a,_).normalize().negate()}else if(t.group.indexOf("leg")!=-1){s=p["下半身"].is_Tpose;t.axis.negate();t.axis.z*=-1;n=MMD_SA._v3a.copy(t.axis);a=MMD_SA._v3b.set(s?1:i,0,0).applyQuaternion(E.setFromUnitVectors(g.set(0,1,0),n));i=-1;_=MMD_SA.TEMP_v3.crossVectors(a,n).normalize()}else{n=MMD_SA._v3a.copy(t.axis);a=MMD_SA._v3b.set(1,0,0).applyQuaternion(E.setFromUnitVectors(g.set(0,1,0),n));_=MMD_SA.TEMP_v3.crossVectors(a,n).normalize();a.crossVectors(n,_)}let l=MMD_SA.TEMP_m4.set(a.x,a.y,a.z,0,n.x,n.y,n.z,0,_.x,_.y,_.z,0,0,0,0,1);t.axis_rot=(new THREE.Quaternion).setFromBasis(l);if(/arm|finger/.test(t.group)&&i==-1){t.axis_rot.z*=-1;t.axis_rot.y*=-1}if(/finger/.test(t.group))t.axis_rot.x*=-1;t.axis_rot_inv=t.axis_rot.clone().conjugate()});n.forEach((e,t)=>{if(!e.use_axis)return;e.axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(e.parent&&e.parent.axis_rot||y,MMD_SA.TEMP_q.copy(e.axis_rot).conjugate())});return n}const b=["０","１","２","３"];function a(f,s){function e(){var r=v[t.model_path]=v[t.model_path]||{axis_rot:{},axis_rot_offset_inv:{},_axis_rot_inv:{},_axis_rot_offset_inv:{}};var i=s.mesh.bones_by_name;["左","右"].forEach(o=>{["肩","腕","ひじ","手首","足首"].concat(["親","人","中","薬","小"].map(t=>b.map(e=>t+"指"+e)).flat()).forEach(e=>{let t=o+e;if(r.axis_rot[t]||!p[t]||!i[t])return;r.axis_rot[t]=MMD_SA.get_bone_axis_rotation(s.mesh,t,MMD_SA.THREEX.enabled&&e.indexOf("指")!=-1)})});for(var e in r.axis_rot){if(!r.axis_rot_offset_inv[e]){r._axis_rot_inv[e]=(new THREE.Quaternion).copy(r.axis_rot[e]).conjugate();r._axis_rot_offset_inv[e]=(new THREE.Quaternion).multiplyQuaternions(r.axis_rot[p[e].parent.name_MMD]||y,r._axis_rot_inv[e])}if(e.indexOf("腕")!=-1&&!p[e.charAt(0)+"肩"]){r.axis_rot_offset_inv[e]=r._axis_rot_inv[e];console.log("-"+e)}else{r.axis_rot_offset_inv[e]=r._axis_rot_offset_inv[e]}}r.leg_length=r.leg_length||t.para.left_leg_length||MMD_SA._v3a.fromArray(i["左足"].pmxBone.origin).distanceTo(MMD_SA._v3b.fromArray(i["左足首"].pmxBone.origin));return r}if(!s)s=THREE.MMD.getModels()[0];const t=MMD_SA.THREEX.get_model(0);var p=f[0].bones_MMD;var o=f[0].url;var r=o.replace(/^.+[\/\\]/,"").replace(/\.(vmd|bvh)$/i,"");var i=MMD_SA_options.motion_para[r]=MMD_SA_options.motion_para[r]||{};var a=Math.round(1/f[0].frames[1].time);var u=e();console.log("model para",u);var c=[];var m;var n=f[0].frames.length;m=d.set(0,0,0);if(p["下半身"]){const l=p["下半身"].is_Tpose;let e=0;let t=p["_root_leg_左_"].children[0].offset[l?"y":"x"]<0?p["_root_leg_左_"]:p["_root_leg_右_"];while(t){e-=l?t.offset.y:t.offset.x;t=t.children?.[0]}m.set(0,e,0);let o=p["_root_leg_左_"].parent;while(o&&!o.root){m.sub(o.offset);o=o.parent}m.multiplyScalar(.1)}var M=-1;for(let l=0;l<n;l++){const x=~~(l*30/a+.001);if(x>M){M=x}else{continue}let _;f.forEach(e=>e._rot_accumulated.set(0,0,0,1));f.forEach((t,e)=>{var o=t.frames[l];var r,i;var s;var a=t.name_MMD;if(!a){if(!t.group)return;if(!o.time)console.log(t.name)}if(t.root){r=g.copy(o.position);r.multiplyScalar(.1);r.sub(m);const n=u.leg_length/f[0].leg_length;if(l==0)console.log("leg_scale (BVH)",n);r.multiplyScalar(n);r=r.toArray();_=o.rotation;if(p["下半身"]){s="下半身";i=E.copy(p[s].root_axis_rot).conjugate().multiply(_)}}else{if(a=="上半身"){i=E.copy(t.root_axis_rot).conjugate().multiply(_).multiply(o.rotation);s="上半身"}else if(t.group.indexOf("upper_body")!=-1){i=E.copy(o.rotation);s="上半身"}else if(t.group.indexOf("lower_body")!=-1){i=E.copy(o.rotation);s="下半身"}else return}if(i&&t.parent)i.multiplyQuaternions(t.parent._rot_accumulated,i);if(s&&p[s]&&p[s].root_axis_rot){i.premultiply(p[s].root_axis_rot).multiply(h.copy(p[s].root_axis_rot).conjugate())}if(t.use_axis){if(!t.ignore_axis_rot){let e;i.premultiply(t.axis_rot).multiply(t.axis_rot_inv);i.premultiply(t.axis_rot_offset_inv);if(u.axis_rot[a]){i.premultiply(u.axis_rot[a]).multiply(u._axis_rot_inv[a]);i.premultiply(u.axis_rot_offset_inv[a])}}}else if(!a){t._rot_accumulated=(new THREE.Quaternion).multiplyQuaternions(t.parent&&t.parent._rot_accumulated||y,i);return}if(i)i=i.toArray();if(t.root){c.push(new D(a,M/30,r,[0,0,0,1]));c.push(new D("下半身",M/30,[0,0,0],i))}else{c.push(new D(a,M/30,r||[0,0,0],i||[0,0,0,1]))}})}var _=new T(c,c[c.length-1].time+Math.min(1/a,1/30));_.url=f[0].url;MMD_SA.vmd_by_filename[decodeURIComponent(_.url.replace(/^.+[\/\\]/,"").replace(/\.bvh$/i,""))]=_;console.log(f,_);return _}return{load:r,parse:s,toVMD:a,set VMD(e){o=e}}}();
