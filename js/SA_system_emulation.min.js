// (2024-01-15)
var System=function(){var System={_init:function(){try{if(!Shell_OBJ)Shell_OBJ=new ActiveXObject("Shell.Application");if(!FSO_OBJ)FSO_OBJ=new ActiveXObject("Scripting.FileSystemObject");if(!oShell)oShell=new ActiveXObject("WScript.Shell")}catch(err){alert(err.message)}this._child_html_filename=xul_mode?"SystemAnimator_xul.html":webkit_mode?WallpaperEngine_CEF_mode&&!browser_native_mode?"SystemAnimator_cef.html":"SystemAnimator_webkit.html":"SystemAnimator_ie.html";this.Gadget._init();this.Machine._init();if(!is_SA_child_animation){SA_top_window.getScreenBounds=function(){var last_updated=-1;var bounds;return function(x,y,force_update){if(force_update||last_updated!=RAF_timestamp){last_updated=RAF_timestamp;bounds=webkit_electron_mode?webkit_electron_screen.getDisplayNearestPoint({x:~~x,y:~~y}).bounds:{x:0,y:0,width:parent.screen.width,height:parent.screen.height}}return bounds}}()}else{SA_top_window.getScreenBounds=function(x,y,force_update){return SA_topmost_window.getScreenBounds(x,y,force_update)}}if(webkit_electron_mode){if(!is_SA_child_animation){SA_top_window.getPos=function(){var last_updated=-1;var pos;return function(force_update){if(force_update||last_updated!=RAF_timestamp){last_updated=RAF_timestamp;pos=webkit_window.getPosition()}return pos}}();SA_top_window.getCursorPos=function(){var last_updated=-1;var pos;return function(force_update){if(force_update||last_updated!=RAF_timestamp){last_updated=RAF_timestamp;pos=webkit_electron_screen.getCursorScreenPoint()}return pos}}()}else{SA_top_window.getPos=function(force_update){return SA_topmost_window.getPos(force_update)};SA_top_window.getCursorPos=function(force_update){return SA_topmost_window.getCursorPos(force_update)}}}SA_top_window.resizeToAbsolute=function(){var resized;return function(w,h){webkit_window.setContentSize(w,h);resized=true;if(absolute_screen_mode&&!System._browser._window_move_timerID){System._browser._window_move_timerID=setInterval(function(){var x=SA_top_window.screenLeftAbsolute;var y=SA_top_window.screenTopAbsolute;var loop=0;return function(){var xy=SA_top_window.getPos(true);if(x!=xy[0]||y!=xy[1]){DEBUG_show("(window position adjusted)",3);webkit_window.setPosition(x,y);System._browser.moveWallpaper(x,y);loop=999}if(++loop>10){clearInterval(System._browser._window_move_timerID);System._browser._window_move_timerID=null}}}(),100)}}}();(()=>{function adjust_window_size(){function f(){const bs=document.body.style;webkit_window.setContentSize(bs.pixelWidth,bs.pixelHeight)}if(webkit_electron_mode&&window.devicePixelRatio!=1){window.removeEventListener("resize",f);window.addEventListener("resize",f,{once:true})}}SA_top_window.moveToAbsolute=function(x,y,restricted){adjust_window_size();if(absolute_screen_mode&&!restricted){webkit_window.setPosition(~~x,~~y)}else{this.moveTo(x,y)}};SA_top_window.moveByAbsolute=function(x,y){adjust_window_size();if(absolute_screen_mode){let pos=SA_top_window.getPos(true);x+=~~pos[0];y+=~~pos[1];webkit_window.setPosition(x,y)}else{this.moveBy(x,y)}}})();Object.defineProperty(SA_top_window,"screenLeftAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[0]:this.screenLeft}});Object.defineProperty(SA_top_window,"screenTopAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[1]:this.screenTop}})},Gadget:{_init:function(){this.Settings.read=this.Settings.readString;this.Settings.write=this.Settings.writeString;Object.defineProperty(this,"onSettingsClosing",{get:function(){return this._onSettingsClosing},set:function(func){this._onSettingsClosing=func;this.settings_window.onbeforeunload=function(){func({closeAction:!!this.returnValue,Action:{commit:true}});System.Gadget.settings_window.System=null;System.Gadget.settings_window.onbeforeunload=null;System.Gadget.settings_window=null}}});var doc=new ActiveXObject("Microsoft.XMLDOM");doc["async"]=false;doc.resolveExternals=false;doc.validateOnParse=false;doc.load("gadget.xml");this.version=doc.selectSingleNode("//version").text},path:xul_mode?XPCOM_object._SA_root:use_SA_browser_mode?toLocalPath(self.location.href).replace(/[\/\\][^\/\\]+$/,""):"",_path_folder:function(){return this.path.replace(/[\/\\][^\/\\]+$/,"")},document:document,version:"1.0.0.0",docked:is_SA_child_animation,visible:true,Settings:{_settings_need_update:false,_settings:{},_changed:{},readString:function(name,raw_read){var v=this._settings[name];v=v?raw_read?decodeURIComponent(v):decodeURIComponent(v).replace(/\$([^\$]+)\$/g,function($0,$1,$2){return eval($1)}):Settings_default._custom_[name]||"";return v},writeString:function(name,value){var v_old=this._settings[name]||"";var v_new=encodeURIComponent(value);this._settings[name]=v_new;if(WallpaperEngine_CEF_mode){var Settings_by_path=JSON.parse(localStorage.Settings_by_path);if(!SA_HTA_folder||!Settings_by_path[SA_HTA_folder]){console.error(SA_HTA_folder)}else{if(Settings_by_path[SA_HTA_folder][name]!=v_new){Settings_by_path[SA_HTA_folder][name]=v_new;localStorage.Settings_by_path=JSON.stringify(Settings_by_path)}}}if(v_old!=v_new)this._changed[name]=this._settings_need_update=true},_writeSettings:function(always_write,save_settings_only){if(!always_write&&!this._settings_need_update)return;this._settings_need_update=false;SystemEXT._save_settings_only=save_settings_only;try{this._writeSettings_CORE()}catch(err){}SystemEXT._save_settings_only=false},_writeSettings_CORE:function(){var saved_settings=[];var settings=this._settings;settings._screenLeft=settings._screenTop="";for(var s in settings){var v=System.Gadget.Settings.readString(s);if(!v)continue;if(s=="_screenLeft"){v=SA_top_window.screenLeftAbsolute}else if(s=="_screenTop"){v=SA_top_window.screenTopAbsolute}saved_settings.push('"'+s+'":"'+encodeURIComponent(v)+'"')}SystemEXT.SaveLocalSettings(saved_settings)}}},Environment:{win32_env:null,getEnvironmentVariable:function(name){return oShell.ExpandEnvironmentStrings("%"+name+"%")}},Machine:{_init:function(){this._init_memory=function(){if(webkit_mode)return;if(this._WMI_obj_memory)return;try{this._WMI_obj_memory=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Memory","EV");this._WMI_obj_memory.init()}catch(err){}};Object.defineProperty(this,"availableMemory",{get:function(){if(webkit_mode)return SA_require("os").freemem()/(1024*1024);this._init_memory();var c=this._WMI_obj_memory.update();return c.length?parseInt(c[c.length-1].AvailableMBytes):0}});Object.defineProperty(this,"totalMemory",{get:function(){if(webkit_mode)return SA_require("os").totalmem()/(1024*1024);if(!this._totalMemory){try{var obj=new WMI_Refresher("Win32_OperatingSystem");obj.init();this._totalMemory=parseInt(obj.update()[0].TotalVisibleMemorySize)/1024}catch(err){}}return this._totalMemory}});this.totalMemory=0;var CPUs={_WMI_obj:null,_cpu_obj:null,_get_cpu_obj:null,_init:function(){if(webkit_mode){if(this._get_cpu_obj)return;this._cpu_obj=[{count:-1,cpus:SA_require("os").cpus()}];this._get_cpu_obj=function(){var cpus=this._cpu_obj;if(cpus[0].count!=PC_count_absolute){if(cpus.unshift({count:PC_count_absolute,cpus:SA_require("os").cpus()})==3)cpus.pop()}return cpus};return}if(this._WMI_obj)return;try{this._WMI_obj=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Processor","EV");this._WMI_obj.init()}catch(err){}},item:function(index){if(webkit_mode){var cpus=this._get_cpu_obj();var core_time=[];for(var i=0;i<2;i++){var times=cpus[i].cpus[index].times;var total=0;for(var type in times)total+=times[type];core_time[i]={total:total,idle:times.idle}}var idle=core_time[0].idle-core_time[1].idle;var total=core_time[0].total-core_time[1].total;return{usagePercentage:total?(1-idle/total)*100:0}}return{usagePercentage:parseFloat(this._WMI_obj.update()[index].PercentProcessorTime)}}};Object.defineProperty(CPUs,"count",{get:function(){if(webkit_mode){return this._get_cpu_obj()[0].cpus.length}return this._WMI_obj.update().length-1}});this._CPUs=CPUs;Object.defineProperty(this,"CPUs",{get:function(){this._CPUs._init();return this._CPUs}});var PowerStatus={_WMI_obj:null,_init:function(){if(this._battery)return;this._battery={level:1,charging:false};if("getBattery"in navigator){var that=this;navigator.getBattery().then(function(b){DEBUG_show("Use Battery Status API",2);that._battery=b})}}};Object.defineProperty(PowerStatus,"batteryPercentRemaining",{get:function(){return this._battery.level*100}});Object.defineProperty(PowerStatus,"isPowerLineConnected",{get:function(){return this._battery.level==1||this._battery.charging}});Object.defineProperty(PowerStatus,"isBatteryCharging",{get:function(){return this._battery.charging}});this._PowerStatus=PowerStatus;Object.defineProperty(this,"PowerStatus",{get:function(){this._PowerStatus._init();return this._PowerStatus}})}},Shell:{itemFromFileDrop:function(dataTransfer,index){return{path:""}},itemFromPath:function(path){path=toLocalPath(path);var f=path.replace(/[\/\\][^\/\\]+$/,"");var p=path.replace(/^.+[\/\\]/,"");var obj=Shell_OBJ.NameSpace(f);if(obj)obj=obj.ParseName(p);return obj?new this._FolderItem(obj):null},execute:function(path,para){Shell_OBJ.ShellExecute(path,para)},chooseFolder:function(title,iOptions){var f=Shell_OBJ.BrowseForFolder(0,title,iOptions);return f?new this._FolderItem(f.Self):null},_FolderItem:function(obj){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.metadata=function(name){var meta_dim=this.obj.ExtendedProperty("Dimensions");if(!meta_dim){var f=this.obj.Path.replace(/[\/\\][^\/\\]+$/,"");var dir=Shell_OBJ.NameSpace(f);meta_dim=dir.GetDetailsOf(this.obj,26)}return meta_dim};Object.defineProperty(this.constructor.prototype,"isFolder",{get:function(){return this.obj.IsFolder}});Object.defineProperty(this.constructor.prototype,"isFileSystem",{get:function(){return(ie9_native?!this.obj.IsFolder:true)&&this.obj.IsFileSystem}});Object.defineProperty(this.constructor.prototype,"isLink",{get:function(){return this.obj.IsLink}});Object.defineProperty(this.constructor.prototype,"link",{get:function(){return new System.Shell._FolderItem(this.obj.GetLink)}});Object.defineProperty(this.constructor.prototype,"path",{get:function(){return this.obj.Path}});Object.defineProperty(this.constructor.prototype,"type",{get:function(){return this.obj.Type}});Object.defineProperty(this.constructor.prototype,"SHFolder",{get:function(){return new System.Shell._Folder(this.obj.GetFolder)}})}this.obj=obj},_Folder:function(obj){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;Object.defineProperty(this.constructor.prototype,"Items",{get:function(){return new System.Shell._FolderItems(this.obj.Items())}})}this.obj=obj},_FolderItems:function(obj){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.item=function(index){return new System.Shell._FolderItem(this.obj.Item(index))};Object.defineProperty(this.constructor.prototype,"count",{get:function(){return this.obj.Count}})}this.obj=obj}},Debug:{outputString:function(str){}},_browser:{init:function(){document.ondragstart=document.onselectstart=function(e){return false};document.onmousedown=function(e){System._browser.onmousedown(e)};document.onmouseup=function(e){System._browser.onmouseup(e)};document.onmousemove=function(e){System._browser.onmousemove(e)};document.onkeydown=function(e){System._browser.onkeydown(e)};if(!WallpaperEngine_CEF_mode||!is_SA_child_animation||browser_native_mode){document.addEventListener("mouseover",function(e){System._browser.onmouseover(e)},false);document.addEventListener("mouseout",function(e){System._browser.onmouseout_waiting(e)},false)}Object.defineProperty(document,"onmouseover",{set:function(v){System._browser.onmouseover_custom=v}});Object.defineProperty(document,"onmouseout",{set:function(v){System._browser.onmouseout_waiting_custom=v}});var s=w3c_mode?CSSStyleDeclaration.prototype:document.body.style.constructor.prototype;this.document_body_style_pixelWidth=Object.getOwnPropertyDescriptor(s,"pixelWidth");this.document_body_style_pixelHeight=Object.getOwnPropertyDescriptor(s,"pixelHeight");var _set=function(){if(System._browser.resize_timerID)clearTimeout(System._browser.resize_timerID);if(System._browser._window_move_timerID){let xy=SA_top_window.getPos();System._browser.resize_timerID=setInterval(function(){var loop=0;return function(){let _xy=SA_top_window.getPos(true);if(++loop>10||xy[0]!=_xy[0]||xy[1]!=_xy[1]){clearInterval(System._browser.resize_timerID);System._browser.resize_timerID=setTimeout("System._browser.resize()",0)}}}(),10)}else System._browser.resize_timerID=setTimeout("System._browser.resize()",0)};Object.defineProperty(s,"_set",{get:function(){return _set}});if(ie9_native){Object.defineProperty(document.body.style,"pixelWidth",{get:function(){return System._browser.document_body_style_pixelWidth.get.call(this)},set:function(v){this._set();System._browser.document_body_style_pixelWidth.set.call(this,v)}});Object.defineProperty(document.body.style,"pixelHeight",{get:function(){return System._browser.document_body_style_pixelHeight.get.call(this)},set:function(v){this._set();System._browser.document_body_style_pixelHeight.set.call(this,v)}})}Object.defineProperty(this,"overlay_mode",function(){var overlay_mode=0;var bg_display_default=null;var bg_color_default=null;return{get:function(){return overlay_mode},set:function(v){if(v==overlay_mode)return;switch(v){case 2:if(bg_display_default==null)bg_display_default=LdesktopBG_host.style.display;LdesktopBG_host.style.display="none";if(bg_color_default==null)bg_color_default=document.body.style.backgroundColor;document.body.style.backgroundColor="#00FF00";case 1:Lmenu_host.style.visibility="hidden";if(this.camera.video_host){this.camera.video_host.style.visibility="hidden";this.camera.video_host.style.display="none"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="hidden";document.getElementById("Ldungeon_inventory").style.visibility="hidden";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden";DEBUG_show("(Press Esc to toggle "+(this.overlay_mode_TEMP?"UI":"bottom menu")+" display)",5)}break;default:if(bg_display_default!=null)LdesktopBG_host.style.display=bg_display_default;if(bg_color_default!=null)document.body.style.backgroundColor=bg_color_default;bg_display_default=bg_color_default=null;Lmenu_host.style.visibility="inherit";if(this.camera.video_host){this.camera.video_host.style.visibility="inherit";this.camera.video_host.style.display="block"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="inherit";document.getElementById("Ldungeon_inventory").style.visibility="inherit";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden"}}overlay_mode=v}}}());var child_animation_as_texture=is_SA_child_animation&&parent.MMD_SA_options&&parent.MMD_SA_options.child_animation_as_texture;if(child_animation_as_texture){this.onkeydown({keyCode:97+SA_child_animation_id})}var d=System.Gadget.Settings.readString("SA_docked");if(d)System.Gadget.docked=!!parseInt(d);else{if(child_animation_as_texture)System.Gadget.docked=false}var d=document.createElement("div");d.id="Ldrag_dummy";var ds=d.style;ds.position="absolute";ds.posLeft=ds.posTop=0;ds.zIndex=999;ds.border="1px solid rgba(128,128,128,0.5)";ds.visibility="hidden";document.body.appendChild(d);this.body=document.getElementById("Lbody_host")||document.body;if(w3c_mode)this.body.style.transition="opacity 0.5s";this.Opacity=1;var WallpaperAsBG=document.getElementById("LdesktopBG")&&!is_SA_BG_transparent;if(WallpaperAsBG){if(!self.SA_wallpaper_src){var SA_wallpaper_path=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_src.txt");if(FSO_OBJ.FileExists(SA_wallpaper_path)){try{var f=FSO_OBJ.OpenTextFile(SA_wallpaper_path,1);self.SA_wallpaper_src=f.ReadLine();f.Close()}catch(err){}}}if(!self.SA_wallpaper_mask_src){var SA_wallpaper_mask_path=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_mask_src.txt");if(FSO_OBJ.FileExists(SA_wallpaper_mask_path)){try{var f=FSO_OBJ.OpenTextFile(SA_wallpaper_mask_path,1);self.SA_wallpaper_mask_src=f.ReadLine();f.Close()}catch(err){}}}}if(WallpaperAsBG)WallpaperAsBG=System.Gadget.Settings.readString("WallpaperAsBG")||self.SA_wallpaper_src;var WallpaperAsBG_custom;if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay.use_wallpaper_as_bg||self.EQP_use_wallpaper){WallpaperAsBG_custom=WallpaperAsBG=true}var wallpaper_mask;var s_left,s_top;this.Opacity=is_SA_child_animation?parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style.opacity||1:parseFloat(System.Gadget.Settings.readString("Opacity")||1);if(is_SA_child_animation&&!self.SA_wallpaper_src&&!WallpaperAsBG_custom){WallpaperAsBG=WallpaperAsBG&&parent.WMP_wallpaper_mask&&parent.use_HTML5&&!parent.System.Gadget.Settings.readString("CSSTransform3D")&&!System.Gadget.Settings.readString("DisableWallpaperMask");if(WallpaperAsBG&&self.EQP_video_options&&EQP_video_options.use_canvas_video){WallpaperAsBG=false;this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");this.WMPMask_Draw()}this.wallpaper_mask_disabled=!WallpaperAsBG;if(WallpaperAsBG)wallpaper_mask=parent.WMP_wallpaper_mask}else{var use_body_opacity;if(!is_SA_child_animation){s_left=System.Gadget.Settings.readString("_screenLeft");s_top=System.Gadget.Settings.readString("_screenTop")}s_left=s_left?parseInt(s_left):null;s_top=s_top?parseInt(s_top):null;if(WallpaperAsBG){const video_wallpaper=w3c_mode&&self.SA_wallpaper_src&&/\.(mp4|mkv|webm)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;this.wallpaper_mask_disabled=WallpaperEngine_CEF_mode||!!System.Gadget.Settings.readString("DisableWallpaperMask");var desktop_reg,wallpaper,wallpaper_style;var ds=LdesktopBG.style;try{ds.pixelWidth=parent.screen.width;ds.pixelHeight=parent.screen.height;var wcolor_reg=oShell.RegRead("HKCU\\Control Panel\\Colors\\Background");ds.backgroundColor=/^\#/.test(wcolor_reg)?wcolor_reg:"rgb("+wcolor_reg.replace(/\W+/g,",")+")";desktop_reg="HKCU\\Control Panel\\Desktop\\";if(WallpaperEngine_CEF_mode)wallpaper=oShell.RegRead(desktop_reg+"Wallpaper")||self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;else wallpaper=self.SA_wallpaper_src==""?"":self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src||oShell.RegRead(desktop_reg+"Wallpaper");if(wallpaper){if(!this.wallpaper_mask_disabled){wallpaper_mask=self.SA_wallpaper_mask_src||wallpaper.replace(/\.\w{3,4}$/,"_mask.png");if(!ValidatePath(wallpaper_mask))wallpaper_mask=null}wallpaper_style=oShell.RegRead(desktop_reg+"WallpaperStyle");this.updateWallpaper(wallpaper,wallpaper_style)}if(video_wallpaper){this.updateWallpaper(video_wallpaper)}this.moveWallpaper(s_left||0,s_top||0);if(!is_SA_child_animation||self.SA_wallpaper_src)LdesktopBG_host.style.display="block"}catch(err){console.error(err);LdesktopBG_host.style.display="none"}if(wallpaper_mask){if(!this.bg_mask)this.bg_mask="(blank)"}else{use_body_opacity=true}}else{use_body_opacity=true}if(use_body_opacity&&this.Opacity<1&&(w3c_mode||HTA_use_GPU_acceleration)){this.body.style.opacity=this.Opacity;DEBUG_show("Opacity:"+this.Opacity*100+"%",2)}}if(WallpaperAsBG_custom&&!wallpaper_mask)this.bg_mask="(blank)";if(WallpaperAsBG&&(wallpaper_mask||this.bg_mask)){var c=document.createElement("canvas");c.id="C_wallpaper_mask";c._WallpaperAsBG_custom=WallpaperAsBG_custom;c.onmousedown=function(){return false};if(!is_SA_child_animation||WallpaperAsBG_custom){try{var w=c.width=parent.screen.width;var h=c.height=parent.screen.height;var context=c.getContext("2d");var wallpaper_img;if(!this.wallpaper_canvas_update){this.wallpaper_canvas_update=function(wallpaper,wallpaper_style){context.fillStyle=ds.backgroundColor;context.fillRect(0,0,w,h);if(!wallpaper){if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(ps){if(ps.is_wallpaper)ps.img.img_obj._match_str=null})}return}var wallpaper_onload;if(wallpaper_style=="0"){wallpaper_onload=function(){var w=this.width;var h=this.height;var sw=parent.screen.width;var sh=parent.screen.height;var x_source,y_source,w_source,h_source,x_target,y_target,w_target,h_target;if(sw>w){x_source=0;x_target=(sw-w)/2;w_source=w_target=w}else{x_source=(w-sw)/2;x_target=0;w_source=w_target=sw}if(sh>h){y_source=0;y_target=(sh-h)/2;h_source=h_target=h}else{y_source=(h-sh)/2;y_target=0;h_source=h_target=sh}var context=C_wallpaper_mask.getContext("2d");context.drawImage(this,x_source,y_source,w_source,h_source,x_target,y_target,w_target,h_target);System._browser.BGMask_Create(!wallpaper_mask);if(!wallpaper_mask)return;var mask_img=new Image;mask_img.onload=function(){var context=C_wallpaper_mask.getContext("2d");context.globalCompositeOperation="destination-in";context.drawImage(this,x_source,y_source,w_source,h_source,x_target,y_target,w_target,h_target);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};mask_img.src=toFileProtocol(wallpaper_mask)}}else{wallpaper_onload=function(){var w=this.width;var h=this.height;var sw=parent.screen.width;var sh=parent.screen.height;var ratio,ww,hh,x,y;var context=C_wallpaper_mask.getContext("2d");if(wallpaper_style=="6"){ratio=Math.max(w/sw,h/sh);x=Math.round((sw-w/ratio)/2);y=Math.round((sh-h/ratio)/2);ww=Math.round(w/ratio);hh=Math.round(h/ratio);context.drawImage(this,0,0,w,h,x,y,ww,hh)}else{ratio=Math.min(w/sw,h/sh);x=Math.round((w/ratio-sw)/2*ratio);y=Math.round((h/ratio-sh)/2*ratio);ww=Math.round(sw*ratio);hh=Math.round(sh*ratio);context.drawImage(this,x,y,ww,hh,0,0,C_wallpaper_mask.width,C_wallpaper_mask.height)}System._browser.BGMask_Create(!wallpaper_mask);if(!wallpaper_mask)return;var mask_img=new Image;mask_img.onload=function(){var context=C_wallpaper_mask.getContext("2d");context.globalCompositeOperation="destination-in";context.drawImage(this,x,y,ww,hh);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};mask_img.src=toFileProtocol(wallpaper_mask)}}if(wallpaper_img)wallpaper_img.onload=null;wallpaper_img=new Image;wallpaper_img.onload=wallpaper_onload;wallpaper_img.src=toFileProtocol(wallpaper)}}this.wallpaper_canvas_update(wallpaper,wallpaper_style);if(!wallpaper){setTimeout("System._browser.BGMask_Create(true)",0)}}catch(err){}}var cs=c.style;cs.position="absolute";cs.posLeft=-(s_left||0);cs.posTop=-(s_top||0);cs.zIndex=60;cs.visibility="hidden";document.body.appendChild(c);this.mouseover_hide_list.push(c);if(is_SA_child_animation){this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");if(this.bg_mask)System._browser.BGMask_Create(!wallpaper_mask);this.WMPMask_Draw()}}this._s_left=s_left;this._s_top=s_top},updateWallpaper:function(wallpaper,wallpaper_style){let v_bg=document.getElementById("VdesktopBG");if(wallpaper&&/\.(mp4|mkv|webm)$/i.test(wallpaper)){if(!v_bg){v_bg=document.createElement("video");v_bg.id="VdesktopBG";const vs=v_bg.style;vs.position="absolute";vs.top=vs.left="0px";vs.width=parent.screen.width+"px";vs.height=parent.screen.height+"px";vs.objectFit="cover";LdesktopBG.appendChild(v_bg);v_bg.autoplay=v_bg.loop=true}v_bg.src=toFileProtocol(wallpaper);v_bg.style.visibility="inherit";return}if(v_bg){v_bg.pause();v_bg.style.visibility="hidden"}var ds=LdesktopBG.style;var wallpaper_changed;if(wallpaper!=null){wallpaper=decodeURIComponent(wallpaper);if(this._wallpaper_last!=wallpaper){wallpaper_changed=true;this._wallpaper_last=wallpaper;ds.backgroundImage=wallpaper?"url("+toFileProtocol(/^(\/|[\w\-]+\:)/.test(wallpaper)?wallpaper:System.Gadget.path+"/"+wallpaper).replace(/\s/g,encodeURIComponent(" "))+")":"";if(this.wallpaper_opacity)ds.opacity=this.wallpaper_opacity;if(this.wallpaper_bg_color)LdesktopBG_host.style.backgroundColor=this.wallpaper_bg_color}}else wallpaper=this._wallpaper_last;var desktop_reg="HKCU\\Control Panel\\Desktop\\";if(wallpaper_style==null){wallpaper_style=oShell.RegRead(desktop_reg+"WallpaperStyle")}if(this._wallpaper_style!=wallpaper_style){wallpaper_changed=true;this._wallpaper_style=wallpaper_style}if(wallpaper_style=="0"){ds.backgroundSize="";ds.backgroundPosition="center center";if(oShell.RegRead(desktop_reg+"TileWallpaper")=="0"){ds.backgroundRepeat="no-repeat"}else{ds.backgroundRepeat=""}}else if(wallpaper_style=="2"){ds.backgroundSize="100% 100%";ds.backgroundPosition="";ds.backgroundRepeat=""}else if(wallpaper_style=="6"){ds.backgroundSize="contain";ds.backgroundPosition="center center";ds.backgroundRepeat="no-repeat"}else{ds.backgroundSize="cover";ds.backgroundPosition="center center";ds.backgroundRepeat="no-repeat";if(browser_native_mode){ds.width="100%";ds.height="100%"}else{ds.pixelWidth=parent.screen.width;ds.pixelHeight=parent.screen.height}if(windows_mode&&wallpaper){var dim=loadImageDim(/^(\/|[\w\-]+\:)/.test(wallpaper)?wallpaper:System.Gadget.path+toLocalPath("\\")+wallpaper);if(dim.w){var desk_ar=parent.screen.width/parent.screen.height;var desk_ar_ext=(parent.screen.width*2-parent.screen.availWidth)/(parent.screen.height*2-parent.screen.availHeight);var wall_ar=dim.w/dim.h;if(wall_ar<desk_ar){ds.pixelHeight=wall_ar<desk_ar_ext?parent.screen.height*2-parent.screen.availHeight:Math.round(parent.screen.width/wall_ar)}else if(wall_ar>desk_ar){ds.pixelWidth=wall_ar>desk_ar_ext?parent.screen.width*2-parent.screen.availWidth:Math.round(parent.screen.height*wall_ar)}}}}if(this.wallpaper_canvas_update&&wallpaper_changed){this.wallpaper_canvas_update(wallpaper,wallpaper_style);DEBUG_show("(Wallpaper canvas updated)",2)}},WMPMask_Draw:function(c_source){if(!this.C_WMP_wallpaper_mask_resized)return;if(!c_source)c_source=parent.SL;if(!c_source||!c_source.width)return;var bs=document.body.style;var w=bs.pixelWidth;var h=bs.pixelHeight;if(!w)return;var x_source=0;var y_source=0;var w_source=c_source.width;var h_source=c_source.height;var c_wall_mask_resized=this.C_WMP_wallpaper_mask_resized;if(c_wall_mask_resized.width!=w_source){c_wall_mask_resized.width=w_source;c_wall_mask_resized.height=h_source;var c_wall=parent.C_WMP_wallpaper_mask;c_wall_mask_resized.getContext("2d").drawImage(c_wall,0,0,c_wall.width,c_wall.height,0,0,w_source,h_source)}var bg_mask_image_resized=this.bg_mask_image_resized;if(bg_mask_image_resized&&bg_mask_image_resized.width!=w){bg_mask_image_resized.width=w;bg_mask_image_resized.height=h;var bg_mask_image=this.bg_mask_image;bg_mask_image_resized.getContext("2d").drawImage(bg_mask_image,0,0,bg_mask_image.width,bg_mask_image.height,0,0,w,h)}var w,h;w=self.B_content_width?B_content_width:document.body.style.pixelWidth;h=self.B_content_height?B_content_height:document.body.style.pixelHeight;var ani=parent.SA_child_animation[SA_child_animation_id];var x=ani.x;var y=ani.y;if(is_SA_child_animation&&parent.EQP_border_width){x-=parent.EQP_border_width;y-=parent.EQP_border_width}var x_target1=x-x_source;var x_target2=x_target1;if(x_target1<0)x_target1=0;if(x_target2<0)x_target2=-x_target2;else x_target2=0;var y_target1=y-y_source;var y_target2=y_target1;if(y_target1<0)y_target1=0;if(y_target2<0)y_target2=-y_target2;else y_target2=0;var w_target=w_source+x_source-x;if(w_target>w)w_target=w;var h_target=h_source+y_source-y;if(h_target>h)h_target=h;var c_wall_mask_mixed_resized=this.C_WMP_wallpaper_mask_mixed_resized;if(c_wall_mask_mixed_resized.width!=w||c_wall_mask_mixed_resized._x!=x_target1||c_wall_mask_mixed_resized._y!=y_target1){c_wall_mask_mixed_resized.width=w;c_wall_mask_mixed_resized.height=h;var context=c_wall_mask_mixed_resized.getContext("2d");context.drawImage(c_wall_mask_resized,x_target1,y_target1,w_target,h_target,x_target2,y_target2,w_target,h_target);if(bg_mask_image_resized)context.drawImage(bg_mask_image_resized,0,0);c_wall_mask_mixed_resized._x=x_target1;c_wall_mask_mixed_resized._y=y_target1}var c=document.getElementById("C_wallpaper_mask");if(!c)return;c.width=w;c.height=h;var context=c.getContext("2d");context.globalCompositeOperation="copy";context.drawImage(c_source,x_target1,y_target1,w_target,h_target,x_target2,y_target2,w_target,h_target);context.globalCompositeOperation="destination-in";context.drawImage(c_wall_mask_mixed_resized,0,0)},BGMask_CreateCanvas:function(bg_mask,empty_base){if(!bg_mask)return null;if(!/^\((.+)\)$/.test(bg_mask)){return null}var paras=RegExp.$1.split("|");var mask_name=paras[0];var c;if(mask_name=="circle"){var w=parseInt(paras[1]);var h=parseInt(paras[2]);c=document.createElement("canvas");c.width=w;c.height=h;var dim=w<h?w:h;var context=c.getContext("2d");context.beginPath();context.arc(w/2,h/2,dim/2,0,Math.PI*2);context.fill()}else if(mask_name=="feather"){var w=parseInt(paras[1]);var h=parseInt(paras[2]);var feather=parseInt(paras[3]);if(!feather)feather=parseInt(Math.sqrt(w*w+h*h)/25);c=document.createElement("canvas");c.width=w;c.height=h;var context=c.getContext("2d");var image_data;if(empty_base)image_data=context.createImageData(w,h);else{context.fillRect(0,0,w,h);image_data=context.getImageData(0,0,w,h)}var data=image_data.data;for(var a=3,a_max=data.length;a<a_max;a+=4){var pixel=(a-3)/4;var x=pixel%w;var y=parseInt(pixel/w);var f_mod=1.2;var mod_x=1;if(x<feather)mod_x=(x+1)/(feather+1);else if(x>=w-feather)mod_x=(w-x)/(feather+1);mod_x=1-(1-mod_x)*f_mod;if(mod_x<0)mod_x=0;var mod_y=1;if(y<feather)mod_y=(y+1)/(feather+1);else if(y>=h-feather)mod_y=(h-y)/(feather+1);mod_y=1-(1-mod_y)*f_mod;if(mod_y<0)mod_y=0;var mod=mod_x<mod_y?mod_x:mod_y;if(mod==1)continue;if(mod_x<1&&mod_y<1){var fx=1-mod_x;var fy=1-mod_y;var ff=fx>fy?fy/fx:fx/fy;var diagonal=Math.sqrt(1+ff*ff);mod=1-(1-mod)*diagonal;if(mod<0)mod=0}data[a]=empty_base?Math.round(255*(1-mod)):Math.round(255*mod)}context.putImageData(image_data,0,0)}return c},BGMask_Create:function(no_wallpaper_mask){var bg_mask=this.bg_mask;if(!bg_mask)return;if(no_wallpaper_mask){this.wallpaper_canvas=C_wallpaper_mask;C_wallpaper_mask.style.display="none"}else{var wallpaper=this.wallpaper_canvas=document.createElement("canvas");if(!is_SA_child_animation){wallpaper.width=parent.screen.width;wallpaper.height=parent.screen.height;wallpaper.getContext("2d").drawImage(C_wallpaper_mask,0,0)}}if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(ps){if(ps.is_wallpaper&&ps.img)ps.img.img_obj._match_str=null})}if(/^\((.+)\)$/.test(bg_mask)){this.bg_mask_image=this.BGMask_CreateCanvas(bg_mask,is_SA_child_animation);this.BGMask_onload();return}var mask_img=this.bg_mask_image=new Image;mask_img.onload=this.BGMask_onload;mask_img.src=toFileProtocol(bg_mask)},BGMask_onload:function(){var bg=document.getElementById("C_BG_mask");if(!bg){bg=document.createElement("canvas");bg.id="C_BG_mask";var bs=bg.style;bs.position="absolute";bs.posTop=bs.posLeft=0;bs.zIndex=60+1;document.body.appendChild(bg)}if(System._browser.mouseover_hide_list.indexOf(bg)==-1)System._browser.mouseover_hide_list.push(bg);if(is_SA_child_animation){System._browser.bg_mask_image_resized=document.createElement("canvas")}else{System._browser.BGMask_Draw()}},BGMask_Draw:function(target_canvas){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom)){this.WMPMask_Draw();return}if(!document.getElementById("C_BG_mask"))return;var cw,ch,w,h;cw=w=self.B_content_width?B_content_width:document.body.style.pixelWidth;ch=h=self.B_content_height?B_content_height:document.body.style.pixelHeight;if(w>parent.screen.width)w=parent.screen.width;if(h>parent.screen.height)h=parent.screen.height;var x_source,y_source,x_target,y_target;var cs=C_wallpaper_mask.style;if(cs.posLeft>0){x_source=0;x_target=cs.posLeft}else{x_source=-cs.posLeft;x_target=0}if(cs.posTop>0){y_source=0;y_target=cs.posTop}else{y_source=-cs.posTop;y_target=0}if(target_canvas){var match_str=x_source+","+y_source+","+w+","+h+","+x_target+","+y_target+","+w+","+h;if(target_canvas._match_str==match_str)return;target_canvas._match_str=match_str;target_canvas.width=cw;target_canvas.height=ch;var context=target_canvas.getContext("2d");context.globalCompositeOperation="copy";context.drawImage(this.wallpaper_canvas,x_source,y_source,w,h,x_target,y_target,w,h);return}if(!this.bg_mask_image&&this.Opacity==1){document.getElementById("C_BG_mask").style.display="none";return}C_BG_mask.width=cw;C_BG_mask.height=ch;var context=C_BG_mask.getContext("2d");context.globalCompositeOperation="copy";context.globalAlpha=this.bg_mask_image?1:1-this.Opacity;context.drawImage(this.wallpaper_canvas,x_source,y_source,w,h,x_target,y_target,w,h);if(this.bg_mask_image){context.globalCompositeOperation="destination-out";context.globalAlpha=this.Opacity;context.drawImage(this.bg_mask_image,0,0,w,h)}else C_BG_mask.style.display="block"},resize_timerID:null,resize_cooling_timestamp:0,resize:function(){var resized_once=false;function on_first_resize(){if(!resized_once){resized_once=true;setTimeout(function(){window.dispatchEvent(new CustomEvent("SA_resized_once"))},0)}}return function(){this.resize_timerID=null;if(use_SA_browser_mode){let oBody=document.body.style;if(is_SA_child_animation){let i_obj=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;i_obj.width=oBody.pixelWidth+"px";i_obj.height=oBody.pixelHeight+"px";on_first_resize()}else{if(webkit_electron_mode){if(webkit_electron_mode&&SA_topmost_window.System._browser.capturePage_in_process){this.resize_timerID=setTimeout("System._browser.resize()",50);return}if(webkit_electron_mode)System._browser.resize_cooling_timestamp=performance.now();SA_top_window.resizeToAbsolute(oBody.pixelWidth+(xul_mode?SA_top_window.outerWidth-SA_top_window.innerWidth:0),oBody.pixelHeight+(xul_mode?SA_top_window.outerHeight-SA_top_window.innerHeight:0))}on_first_resize()}}}}(),drag_mouse_x:-1,drag_mouse_y:-1,drag_timerID:null,is_dragging:false,mouseout_timerID:null,mouseover_hide_list:[],onmouseover_custom:null,onmouseover:function(event){if(webkit_electron_mode&&(SA_topmost_window.returnBoolean("IgnoreMouseEvents")||SA_topmost_window.returnBoolean("AutoItStayOnDesktop"))&&!SA_topmost_window.webkit_IgnoreMouseEvents_disabled)return;if(this.onmouseover_custom&&this.onmouseover_custom(event))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var list=this.mouseover_hide_list;for(var i=0;i<list.length;i++)list[i].style.visibility="hidden"},onmouseout_waiting_custom:null,onmouseout_waiting:function(event){if(this.onmouseout_waiting_custom&&this.onmouseout_waiting_custom(event))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var x=event.clientX;var y=event.clientY;var bs=document.body.style;var ignore_wallpaper_mask=x>0&&x<bs.pixelWidth&&(y>0&&y<bs.pixelHeight);if(w3c_mode)event.stopPropagation();this.mouseout_timerID=setTimeout("System._browser.onmouseout("+ignore_wallpaper_mask+")",200)},onmouseout:function(ignore_wallpaper_mask){this.mouseout_timerID=null;if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}if(this.is_dragging){this.is_dragging=false;ignore_wallpaper_mask=false;this.showFocus(false);System.Gadget.Settings._writeSettings(true,true)}else if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.is_dragging=false;this.showFocus(false)}if(ignore_wallpaper_mask)return;var list=this.mouseover_hide_list;for(var i=0;i<list.length;i++)list[i].style.visibility="inherit";this.BGMask_Draw()},onmousedown:function(event){if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}var list=this.mouseover_hide_list;var focused=true;for(var i=0;i<list.length;i++){var ls=list[i].style;if(ls.visibility!="hidden"){ls.visibility="hidden";focused=false}}var has_child;if(!focused&&!is_SA_child_animation&&SA_child_animation_max){for(var i=0;i<SA_child_animation_max;i++){if(SA_child_animation[i]){has_child=true;break}}}focused=!has_child;if(focused){var ex,ey;if(WallpaperEngine_mode){ex=event.x;ey=event.y}else{if(absolute_screen_mode){ex=SA_top_window.getCursorPos().x;ey=SA_top_window.getCursorPos().y}else{ex=event.screenX;ey=event.screenY}}if(!is_SA_child_animation||!parent.returnBoolean("ChildDragDisabled")||true)this.drag_timerID=setTimeout("System._browser.onmousedown_dragStart("+ex+","+ey+")",200)}else DEBUG_show("(focused)",1)},showFocus:function(show,show_input_target){if(is_SA_child_animation){if(!xul_mode||!this.is_dragging)parent.System._browser.showFocus(show)}if(!show){Ldrag_dummy.style.visibility="hidden";return}var bw=document.body.style.pixelWidth;var bh=document.body.style.pixelHeight;if(bw&&bh){var ds=Ldrag_dummy.style;ds.pixelWidth=bw-2;ds.pixelHeight=bh-2;ds.visibility="inherit"}if(show_input_target)DEBUG_show("(selected)",1)},arrangeChildZ:function(id){System.Gadget.Settings._settings_need_update=true;var ca=[];for(var i=0;i<SA_child_animation_max;i++){if(SA_child_animation[i])ca[i]={index:i,z:SA_child_animation[i].z}}ca.sort(function(a,b){return a.index==id?1:b.index==id?-1:a.z-b.z}).forEach(function(ani,idx){SA_child_animation[ani.index].z=document.getElementById("Ichild_animation"+ani.index).style.zIndex=idx})},_child_selected:null,_drag_disabled:false,_child_drag_disabled:false,onmousedown_dragStart:function(x,y){this.drag_timerID=null;if(WallpaperEngine_mode)return;if(is_SA_child_animation&&is_SA_child_animation_host){parent.System._browser.is_dragging=true;parent.System._browser.drag_mouse_x=x;parent.System._browser.drag_mouse_y=y;DEBUG_show("drag start",1);this.showFocus(true);return}if(!this._drag_disabled&&(!is_SA_child_animation||!parent.System._browser._child_drag_disabled)){this.is_dragging=true;this.drag_mouse_x=x;this.drag_mouse_y=y;DEBUG_show("drag start",1)}this.showFocus(true);if(is_SA_child_animation){parent.System._browser.arrangeChildZ(SA_child_animation_id)}},_BL_clicked:0,_BL_clicked_max:1,_BL_clicked_timerID:null,onmouseup_custom:null,onmouseup:function(event){if(this.onmouseup_custom&&this.onmouseup_custom(event))return;this.onmouseout(true);if(this._drag_disabled||is_SA_child_animation&&parent.System._browser._child_drag_disabled)this.showFocus(false);if(event.clientX>20||event.clientY<document.body.style.pixelHeight-20)return;if(this._BL_clicked_timerID){clearTimeout(this._BL_clicked_timerID);this._BL_clicked_timerID=null}if(++this._BL_clicked<this._BL_clicked_max){this._BL_clicked_timerID=setTimeout("System._browser._BL_clicked_timerID=null; System._browser._BL_clicked=0;",250);return}this._BL_clicked=0;if(!WallpaperEngine_mode&&(!self.Lquick_menu||!Lquick_menu._activated))this.confirmClose()},confirmClose:function(enforced){if(browser_native_mode){if(confirm("This will reload System Animator.")){SA_topmost_window.location.reload()}return}if(!enforced||xul_mode){System._browser.showFocus(true,true);var msg_extra=is_SA_child_animation?" (child"+(SA_child_animation_id+1)+")":"";if(SA_top_window.is_SA_hosted){if(confirm("Close "+SystemEXT._default.gadget_name+" (XUL host)?")){SA_top_window.opener.close();return}msg_extra+=" (this animation only)"}System._browser.showFocus(false)}if(is_SA_child_animation){if(is_SA_child_animation_host){parent.System._browser.confirmClose(enforced)}else{parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id]=null;var d=parent.document.getElementById("Ichild_animation"+SA_child_animation_id);d.style.pixelWidth=d.style.pixelHeight=0;d.style.visibility="hidden";d.contentWindow.location.replace("z_blank.html")}}else{if(WallpaperEngine_CEF_mode&&!W8_or_above){SA_top_window.location.reload()}else SA_top_window.close()}},onSettings:function(enforced){if(!enforced&&/XR Animator$/.test(Settings.f_path)&&MMD_SA.MMD_started){const branch=MMD_SA_options.Dungeon.dialogue_branch_mode?.find?.(b=>b.is_closing_event);if(MMD_SA_options.Dungeon.dialogue_branch_mode&&!branch)return false;new Promise(resolve=>{if(branch){const key=Array.isArray(branch.key)?branch.key[0]:branch.key;let code,keyCode;if(typeof key=="number"){keyCode=key+96}else if(key=="Esc"){code="Escape"}else{code="Key"+key}document.dispatchEvent(new KeyboardEvent("keydown",{code:code,keyCode:keyCode}));System._browser.on_animation_update.add(resolve,0,0)}else{resolve()}}).then(()=>{new Promise(resolve=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.settings.confirm"),branch_list:[{key:1,func:()=>{resolve()},ended:true},{key:2}]}}]])}).then(()=>{this.onSettings(true)})});return false}if(!System.Gadget.settingsUI)return false;if(use_inline_dialog){if(document.getElementById("Idialog").style.visibility=="hidden"){document.getElementById("Idialog").contentWindow.location.replace("settings.html")}return true}System._browser.showFocus(true,true);var v=showModalDialog(System.Gadget.settingsUI,self);v=xul_mode?self.returnValue:v;System._browser.showFocus(false);this.onSettingsClosed(v);return true},onSettingsClosed:function(v){if(System.Gadget.onSettingsClosed)System.Gadget.onSettingsClosed({closeAction:!!v,Action:{commit:true}})},onkeydown:function(event){var have_child=(is_SA_child_animation||document.getElementById("Lchild_animation_parent"))&&!is_SA_child_animation_host;const is_altKey=event.altKey;const is_safe_key=is_altKey||!self.MMD_SA||!MMD_SA_options.Dungeon_options||!event.preventDefault;var k=event.keyCode;if(k==67&&is_altKey){this.confirmClose();return true}else if(k==69&&is_safe_key){return this.onSettings()}else if(k==79&&is_safe_key){var o;if(is_SA_child_animation){var ds=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;o=this.Opacity;if("_opacity_"in event){o=event._opacity_}else{o-=.25;if(o<.25)o=1}parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id].opacity=o;ds.opacity=o}else if(this.bg_mask){o=this.Opacity;if("_opacity_"in event){o=event._opacity_}else{o-=.25;if(o<.25)o=1}System.Gadget.Settings.writeString("Opacity",o);this.Opacity=o;this.BGMask_Draw()}else if(w3c_mode||HTA_use_GPU_acceleration){var ds=this.body.style;o=this.Opacity;if("_opacity_"in event){o=event._opacity_}else{o-=.25;if(o<.25)o=1}System.Gadget.Settings.writeString("Opacity",o);ds.opacity=o}else return false;this.Opacity=o;DEBUG_show("Opacity:"+o*100+"%",2);this.update_tray();return true}else if(k==83&&is_safe_key){var f=System.Gadget.docked?System.Gadget.onUndock:System.Gadget.onDock;if(!f)return false;setTimeout(System._browser.ondockundock,0);return true}else if(have_child&&(k>=49&&k<49+SA_child_animation_max)&&is_safe_key){var id=k-49;var p=is_SA_child_animation?parent:self;var d=p.document.getElementById("Ichild_animation"+id);if(!d||!d.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(id+1)+" not found)",2);return true}var cw=d.contentWindow;var cp=cw.parent;var cp_browser=cp.System._browser;if(cw.System.Gadget.Settings.readString("CSSTransform3D")||cp.System.Gadget.Settings.readString("CSSTransform3D")){if(cp_browser._child_selected==id){cp_browser._child_selected=null;cw.DEBUG_show("(deselected)",2);cp.DEBUG_show("(child"+(id+1)+" deselected)",2);return true}cp_browser._child_selected=id}cw.DEBUG_show("(selected)",2);cp.DEBUG_show("(child"+(id+1)+" selected)",2);cp_browser.arrangeChildZ(id);cw.focus();return true}else if(have_child&&k==96&&is_safe_key){var p=is_SA_child_animation?parent:self;var ds=p.Lchild_animation_parent.style;ds.visibility=ds.visibility=="hidden"?"visible":"hidden";if(webkit_mode)ds.display=ds.visibility=="hidden"?"none":"block";p.System._browser._child_selected=null;return true}else if(have_child&&(k>=97&&k<97+SA_child_animation_max)&&is_safe_key){var id=k-97;var p=is_SA_child_animation?parent:self;var d=p.document.getElementById("Ichild_animation"+id);if(!d||!d.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(id+1)+" not found)",2);return true}var ds=d.style;ds.visibility=ds.visibility=="hidden"?"visible":"hidden";if(webkit_mode)ds.display=ds.visibility=="hidden"?"none":"block";p.System._browser._child_selected=null;var child_visible=false;for(var i=0;i<SA_child_animation_max;i++){var d=p.document.getElementById("Ichild_animation"+i);if(d&&d.contentWindow.is_SA_child_animation&&d.style.visibility!="hidden"){child_visible=true;break}}p.document.getElementById("Lchild_animation_parent").style.visibility=child_visible?"visible":"hidden";return true}else if(k>=96&&k<96+10){if(self.MMD_SA&&MMD_SA_options.motion_shuffle&&MMD_SA.use_jThree&&MMD_SA.MMD_started){if(this.camera.ML_enabled){}else if(k==96){if(MMD_SA_options._motion_shuffle){if(!MMD_SA_options.motion_shuffle_list_default&&MMD_SA_options._motion_shuffle_list_default){MMD_SA_options.motion_shuffle_list_default=MMD_SA_options._motion_shuffle_list_default.slice();MMD_SA._force_motion_shuffle=true}else{MMD_SA_options.motion_shuffle=MMD_SA_options._motion_shuffle.slice(0);MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motions shuffled)",2)}}}else{var id=k-97;if(MMD_SA_options.motion_by_song_name){if(MMD_SA_options.motion_by_song_name._loading_){DEBUG_show("(music/motion loading)",2);return true}let entry=Object.keys(MMD_SA_options.motion_by_song_name).find(p=>{return MMD_SA_options.motion_by_song_name[p].key==id+1});if(entry){let song_path=MMD_SA_options.motion_by_song_name[entry].song_path;if(/\.zip\#/i.test(song_path)){MMD_SA_options.motion_by_song_name._loading_=true;song_path=song_path.replace(/^.+[\/\\]([^\/\\]+\.zip)/i,"$1");let xhr=new self.XMLHttpRequestZIP;xhr.onload=function(){MMD_SA_options.motion_by_song_name._loading_=false;let blob=this.response;blob.name=song_path.replace(/^.+[\/\\]/,"");blob.isFileSystem=true;SA_DragDropEMU(blob)};xhr.open("GET",song_path,true);xhr.responseType="blob";xhr.send()}else SA_DragDropEMU(song_path);return true}}if(id>=MMD_SA.normal_action_length){DEBUG_show("(MMD motion not found)",2);return true}if(!MMD_SA_options._motion_shuffle)MMD_SA_options._motion_shuffle=MMD_SA_options.motion_shuffle.slice(0);MMD_SA_options.motion_shuffle=[id];MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motion changed)",2)}return true}}return false},ondockundock:function(){DEBUG_show("Dock state changed",2);var d=!System.Gadget.docked;System.Gadget.docked=d;System.Gadget.Settings.writeString("SA_docked",!!d==!!is_SA_child_animation?"":d?"1":"0");var f=!d?System.Gadget.onUndock:System.Gadget.onDock;if(!f)return;f()},onmousemove_custom:null,onmousemove:function(event){var ex,ey;ex=this._WE_mouse_x=event.x;ey=this._WE_mouse_y=event.y;if(this.onmousemove_custom&&this.onmousemove_custom(event))return;if(!this.is_dragging){if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.onmousemove(event)}return}if(!WallpaperEngine_mode){if(absolute_screen_mode){ex=SA_top_window.getCursorPos().x;ey=SA_top_window.getCursorPos().y}else{ex=event.screenX;ey=event.screenY}}if(is_SA_child_animation||this._child_selected!=null){var cw,cp,id;if(is_SA_child_animation){id=SA_child_animation_id;cw=self;cp=parent}else{id=this._child_selected;cw=document.getElementById("Ichild_animation"+id).contentWindow;cp=self}cp.System.Gadget.Settings._settings_need_update=true;var ani=cp.SA_child_animation[id];var i_obj=cp.document.getElementById("Ichild_animation"+id).style;var oBody=cw.document.body.style;var PBody=cp.document.body.style;var x=ani.x+ex-this.drag_mouse_x;var y=ani.y+ey-this.drag_mouse_y;i_obj.posLeft=ani.x=x;i_obj.posTop=ani.y=y;cw.document.getElementById("Ldebug").innerText=cp.document.getElementById("Ldebug").innerText="(moving)";cw.DEBUG_hide_sec=cp.DEBUG_hide_sec=0;cw.DEBUG_show("("+x+","+y+")",2)}else{System.Gadget.Settings._settings_need_update=true;this.moveBy(ex-this.drag_mouse_x,ey-this.drag_mouse_y,event)}this.moveWallpaper();this.drag_mouse_x=ex;this.drag_mouse_y=ey},moveWallpaper:function(x,y){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom))return;if(is_SA_child_animation||document.getElementById("LdesktopBG")&&LdesktopBG.style.display!="none"){if(WallpaperEngine_mode){x=0;y=0}else{if(absolute_screen_mode){if(x==null)x=SA_top_window.screenLeftAbsolute;if(y==null)y=SA_top_window.screenTopAbsolute;var b=SA_top_window.getScreenBounds(x,y);x=-(x-b.x);y=-(y-b.y)}else{if(x==null)x=SA_top_window.screenLeft;if(y==null)y=SA_top_window.screenTop;x=-(x%parent.screen.width);y=-(y%parent.screen.height)}}if(is_SA_child_animation){var ani=parent.SA_child_animation[SA_child_animation_id];x-=ani.x;y-=ani.y}else{var ds=(is_SA_child_animation_host&&Ichild_animation0.contentWindow.document.getElementById("LdesktopBG")||LdesktopBG).style;ds.posLeft=x;ds.posTop=y}if(document.getElementById("C_wallpaper_mask")){var cs=C_wallpaper_mask.style;cs.posLeft=x;cs.posTop=y}}},moveBy:function(x,y,event){SA_top_window.moveByAbsolute(x,y)},update_tray:function(para){try{if(!webkit_electron_mode||IPC.active_window!=self)return;if(this._tray_last_updated==RAF_timestamp){return}this._tray_last_updated=RAF_timestamp;if(!para){para={active_window_id:IPC.active_window_id,click_thru:SA_topmost_window.returnBoolean("IgnoreMouseEvents"),click_thru_partial:SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial"),always_on_top:SA_topmost_window.returnBoolean("AutoItAlwaysOnTop"),stay_on_desktop:SA_topmost_window.returnBoolean("AutoItStayOnDesktop"),use_electron_as_wallpaper:SA_topmost_window.WebKit_object.use_electron_as_wallpaper,auto_pause:SA_topmost_window.returnBoolean("AutoItAutoPause"),opacity:is_SA_child_animation?parent.SA_child_animation[SA_child_animation_id].opacity:parseFloat(System.Gadget.Settings.readString("Opacity")||1),opacity_on_hover:parseFloat(System.Gadget.Settings.readString("OpacityOnHover")||1),size:Settings.CSSTransformFullscreen?-1:Settings.CSSTransformScale,animation_path:Settings.f_path_folder,media_control:self.SL&&SL._mouse_event_main&&SL._mouse_event_main(),MMD:null};var w_list=[true];for(var i=0;i<SA_child_animation_max;i++)w_list.push(!!SA_topmost_window.SA_child_animation[i]);para.active_window=w_list;para.lock_child_dragging=returnBoolean("ChildDragDisabled");var tray_menu_custom=this.tray_menu_custom;if(tray_menu_custom){para.custom_menu_para=tray_menu_custom.para;tray_menu_custom.update_tray&&tray_menu_custom.update_tray(para)}else{para.custom_menu_para={}}if(self.MMD_SA&&MMD_SA._tray_updatable){var MME=MMD_SA_options.MME;var _MMD=para.MMD={use_webgl2:!!MMD_SA.use_webgl2,use_dungeon:!!MMD_SA_options.Dungeon,use_THREEX:!!MMD_SA.THREEX.enabled,look_at_camera:!!MMD_SA_options._look_at_screen,look_at_mouse:!!MMD_SA_options._look_at_mouse,trackball_camera:!!returnBoolean("MMDTrackballCamera"),random_camera:!!returnBoolean("MMDRandomCamera"),random_camera_available:!!MMD_SA_options.use_random_camera,override_default_for_external_model:!!returnBoolean("MMDOverrideDefaultForExternalModel"),VMC_sender_enabled:!!MMD_SA.OSC.VMC.sender_enabled,VMC_send_camera_data:!!MMD_SA.OSC.VMC.send_camera_data,VMC_app_mode:MMD_SA.OSC.app_mode||"",VMC_hide_3D_avatar:!!MMD_SA.hide_3D_avatar,light:{},MME:{self_overlay:{},HDR:{},serious_shader:{},SAO:{},PostProcessingEffects:{}}};_MMD._material_list=MMD_SA._material_list||[];if(MMD_SA._model_list){_MMD._model_list=MMD_SA._model_list;MMD_SA._model_list=null}var light=jThree("#MMD_DirLight").three(0);var light_color=light.color;_MMD.light.color=[Math.min(255,parseInt(light_color.r*256)),Math.min(255,parseInt(light_color.g*256)),Math.min(255,parseInt(light_color.b*256))];_MMD.light.position=light.position.clone().sub(MMD_SA_options.MMD_disabled&&{x:0,y:0,z:0}||THREE.MMD.getModels()[0].mesh.position).multiplyScalar(1/MMD_SA_options.light_position_scale).toArray();_MMD.shadow_darkness=MMD_SA_options.shadow_darkness;Object.assign(_MMD.MME.self_overlay,MME.self_overlay);Object.assign(_MMD.MME.HDR,MME.HDR);Object.assign(_MMD.MME.serious_shader,MME.serious_shader);Object.assign(_MMD.MME.SAO,MME.SAO);var PPE=MMD_SA_options.MME.PostProcessingEffects;var _PPE=_MMD.MME.PostProcessingEffects;_PPE.enabled=returnBoolean("Use3DPPE")||!!(MMD_SA_options.PPE_disabled_on_idle?MMD_SA_options._PPE_enabled:PPE.enabled);_PPE.use_SAO=!!PPE.use_SAO;_PPE.use_Diffusion=!!PPE.use_Diffusion;_PPE.use_BloomPostProcess=!!PPE.use_BloomPostProcess;_PPE.use_BloomPostProcess_blur_size=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessBlurSize")||.5);_PPE.use_BloomPostProcess_threshold=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessThreshold")||.5);_PPE.use_BloomPostProcess_intensity=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessIntensity")||.5);_MMD.MME_saved=!!MMD_SA_options.MME_saved[MMD_SA_options.model_para_obj._filename]}if(!document.getElementById("Lchild_animation_parent"))para.apply_to_child=null;else para.apply_to_child=returnBoolean("CSSTransformToChildAnimation")}webkit_electron_remote.getGlobal("update_tray")(para)}catch(err){console.error(err)}},load_file:function(url,callback,responseType,preload){if(!responseType)responseType="blob";if(!preload)preload=!(self.MMD_SA&&MMD_SA.fn);if(preload){if(self.MMD_SA&&MMD_SA.fn){MMD_SA.fn.load_length_extra++}else{MMD_SA_options.load_length_extra=(MMD_SA_options.load_length_extra||0)+1}}var xhr_init;if(/\.zip\#/i.test(url)||responseType!="blob"||typeof callback=="function"){xhr_init=function(){var xhr=new XMLHttpRequestZIP;xhr.onload=async function(){if(typeof callback=="function"){await callback(xhr)}else{callback.src=URL.createObjectURL(this.response)}if(preload){MMD_SA.fn.setupUI()}xhr=undefined};xhr.open("GET",toFileProtocol(url),true);xhr.responseType=responseType;xhr.send()}}else{xhr_init=function(){if(preload){var onload=function(){MMD_SA.fn.setupUI();callback.removeEventListener("load",onload)};callback.addEventListener("load",onload)}callback.src=toFileProtocol(url)}}if(!self.XMLHttpRequestZIP){window.addEventListener("jThree_ready",function(){xhr_init()})}else{xhr_init()}},on_animation_update:function(){var events=[[],[]];var count=0;return{add:function(func,frame_delay,phase,loop){events[phase].push({func:func,frame_count:frame_delay+phase,loop:loop,index:count++})},remove:function(func,phase){events[phase].forEach(e=>{if(e.func==func)e.canceled=true})},run:function(phase){var e_index_list=[];var ep=events[phase];if(!ep.length)return;var ep_new=[];for(let i=0;i<ep.length;i++){const e=ep[i];if(e.canceled)continue;if(--e.frame_count>=0){ep_new.push(e)}else{e.func();if(e.loop&&--e.loop!=0)ep_new.push(e)}}events[phase]=ep_new}}}(),get css_scale(){return window.devicePixelRatio>=2?.5:1},virtual_numpad_toggle:function(visible){if(visible==null)visible=Lnumpad_row0.style.display=="none";Lnumpad_row0.style.display=visible?"inline":"none";Lnumpad_rows.style.display=visible?"block":"none";if(visible&&self.ChatboxAT)ChatboxAT.chatW_minimize(0,true)},virtual_numpad:function(){var key_objs={};var key_map={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,X:9};return function(ev,e_type){ev.preventDefault();ev.stopPropagation();var combat_mode=MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.character.combat_mode;var key=ev.target.textContent;var key_obj=key_objs[key]=key_objs[key]||{};var keyCode,shiftKey,code;switch(key){case"S":keyCode=16;key_obj.pressed=!key_obj.pressed;const buttons=document.getElementsByClassName("Lnumpad_button");if(key_obj.pressed&&MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode){for(let i=0;i<buttons.length;i++){const b=buttons[i];if(/([1-9])/.test(b.textContent))b.textContent=Object.entries(key_map).find(v=>v[1]==RegExp.$1)[0]}}else{for(let i=0;i<buttons.length;i++){const b=buttons[i];if(/([A-HX])/.test(b.textContent))b.textContent=Object.entries(key_map).find(v=>v[0]==RegExp.$1)[1]}}e_type=key_obj.pressed?"keydown":"keyup";break;case"+":keyCode=107;if(combat_mode){if(e_type=="keyup")return;key_obj.pressed=!key_obj.pressed;e_type=key_obj.pressed?"keydown":"keyup"}break;case"-":keyCode=109;break;case"*":keyCode=106;break;case"/":keyCode=111;break;case"":keyCode=13;break;case"J":keyCode=32;break;case"":keyCode=38;code="ArrowUp";break;case"":keyCode=40;code="ArrowDown";break;case"":keyCode=37;code="ArrowLeft";break;case"":keyCode=39;code="ArrowRight";break;default:if(/([0-9])/.test(key))keyCode=parseInt(key)+96;else code="Key"+key}if(key_obj.timeoutID)clearTimeout(key_obj.timeoutID);if(key_obj.intervalID)clearTimeout(key_obj.intervalID);key_obj.timeoutID=key_obj.intervalID=null;let e=new KeyboardEvent(e_type,{bubbles:true,cancelable:true,key:key,keyCode:keyCode,code:code,shiftKey:key_objs["S"]&&key_objs["S"].pressed});document.dispatchEvent(e);if(e_type=="keydown"){if(/[\+S]/.test(key)&&(key!="+"||combat_mode)){ev.target.style.opacity="0.75"}else{key_obj.timeoutID=setTimeout(function(){key_obj.intervalID=setInterval(function(){document.dispatchEvent(e)},100)},400)}}else{ev.target.style.opacity=""}}}(),P2P_network:function(){var peer_default;var peer_count=0;var peer_para_default={events:{peer:{},connection:{handshake_request:function(peer,connection){console.log("P2P_network: Remote Peer"+"("+connection.peer+"/"+connection.label+"/host) responding handshake request from Peer-"+peer.index+"("+peer.id+")");connection.send({handshake:{request:true}})},handshake_respond:function(peer,connection,handshake){if(handshake.request){connection.status="connected";console.log("P2P_network: Remote Peer"+"("+connection.peer+"/"+connection.label+"/client)'s handshake request accepted from Peer-"+peer.index+"("+peer.id+")");connection.send({handshake:{accepted:true}})}else if(handshake.accepted){connection.status="connected";console.log("P2P_network: Remote Peer"+"("+connection.peer+"/"+connection.label+"/host) accepted handshake request from Peer-"+peer.index+"("+peer.id+")");if(peer.para.events.connection.handshake_request_accecpted&&peer.para.events.connection.handshake_request_accecpted[connection.label]){peer.para.events.connection.handshake_request_accecpted[connection.label]({peer:peer,connection:connection,handshake:handshake});delete peer.para.events.connection.handshake_request_accecpted[connection.label]}}else{console.log("P2P_network: Remote Peer"+"("+connection.peer+"/"+connection.label+"/host) rejected handshake request from Peer-"+peer.index+"("+peer.id+")");if(peer.para.events.connection.handshake_request_rejected&&peer.para.events.connection.handshake_request_rejected[connection.label]){peer.para.events.connection.handshake_request_rejected[connection.label]({peer:peer,connection:connection,handshake:handshake});delete peer.para.events.connection.handshake_request_rejected[connection.label]}}},data:function(peer,connection,data){}},send_message:function(para){if(!para.command)net.content_window.ChatboxAT.ChatShow([para.name+": "+para.msg]);return null}}};function P2P_Connection(peer,connection){this._connection=connection;this.status="connecting";peer.connections[connection.label]=this;var that=this;connection.on("data",function(data){if(data.handshake){peer.para.events.connection.handshake_respond(peer,that,data.handshake)}else{peer.para.events.connection.data(peer,that,data)}});connection.on("close",function(data){console.log("P2P_network: DataConnection"+"("+connection.peer+"/"+connection.label+"/host) closed");that.close(peer)})}P2P_Connection.prototype.send=function(data){this._connection.send(data)};P2P_Connection.prototype.close=function(peer){if(!peer.connections[this.label])return;if(peer.para.events.connection.close&&peer.para.events.connection.close(peer,this))return;delete peer.connections[this.label];var that=this;setTimeout(function(){that._connection.close();that._connection=null},1e3)};Object.defineProperty(P2P_Connection.prototype,"peer",{get:function(){return this._connection.peer}});Object.defineProperty(P2P_Connection.prototype,"label",{get:function(){return this._connection.label}});function P2P_Peer_connections(){}Object.defineProperty(P2P_Peer_connections.prototype,"length",{get:function(){return Object.keys(this).length}});function P2P_Peer(para=Object.clone(peer_para_default)){this.para=para;this.id=null;var _peer=this._peer=new Peer;this.index=peer_count;this.connections=new P2P_Peer_connections;this.status="connecting";var that=this;_peer.on("open",function(id){peer_count++;if(!peer_default)peer_default=that;that.id=id;that.status="connected";console.log("P2P_network: Peer-"+that.index+"("+id+") connected");that.para.events.peer.open&&that.para.events.peer.open(that)});_peer.on("error",function(err){console.log("P2P_network: Peer-"+that.index+" error",err);if(that.para.events.peer.error_by_connection){that.para.events.peer.error_by_connection(err);delete that.para.events.peer.error_by_connection}else that.para.events.peer.error&&that.para.events.peer.error(that,err)});_peer.on("connection",function(connection){if(para.events.peer.connection&&para.events.peer.connection(that,connection))return;console.log("P2P_network: Remote Peer"+"("+connection.peer+"/"+connection.label+"/client) connecting to Peer-"+that.index+"("+that.id+")");connection.on("open",function(){console.log("P2P_network: Remote Peer"+"("+connection.peer+"/"+connection.label+"/client) connected to Peer-"+that.index+"("+that.id+")");new P2P_Connection(that,connection)})})}P2P_Peer.prototype.connect=function(id,options){var that=this;return new Promise(function(resolve,reject){var on_peer_connect=function(){var connect_options={serialization:"json"};var connection=that._peer.connect(id,connect_options);connection.on("open",function(){console.log("P2P_network: Remote Peer"+"("+connection.peer+"/"+connection.label+"/host) connecting to Peer-"+that.index+"("+that.id+")");var connection_obj=new P2P_Connection(that,connection);that.para.events.connection.handshake_request(that,connection_obj);that.para.events.connection.handshake_request_accecpted=that.para.events.connection.handshake_request_accecpted||{};that.para.events.connection.handshake_request_rejected=that.para.events.connection.handshake_request_rejected||{};that.para.events.connection.handshake_request_accecpted[connection.label]=resolve;that.para.events.connection.handshake_request_rejected[connection.label]=reject;delete that.para.events.peer.error_by_connection});connection.on("error",function(err){console.log("P2P_network: Remote connection failed",err);reject(err)});that.para.events.peer.error_by_connection=reject};switch(that.status){case"connected":on_peer_connect();break;default:setTimeout(function(){reject(that)},0)}})};var net={peer:P2P_Peer,get peer_default(){return peer_default},status:"off",get content_window(){return is_SA_child_animation_host?document.getElementById("Ichild_animation0").contentWindow:self},process_message:function(msg,is_auto){var peer=this.peer_default;if(!peer)return msg;var id=this.content_window.document.getElementById("Flogin").id.value;var pass=this.content_window.document.getElementById("Flogin").pass.value;var options=this.content_window.MMD_SA_options;var name=(id||options&&options.model_para_obj.character&&options.model_para_obj.character.name||"Anonymous").substring(0,16);var online=peer&&peer.connections.length;var return_value;if(!/^\//.test(msg)){return_value=peer.para.events.send_message({name:name,msg:msg,id:id,pass:pass})}else{var command,para1,para2;var obj=this.content_window.ChatboxAT.checkChatCommand(msg);command=obj.command;para1=obj.para1;para2=obj.para2;return_value=peer.para.events.send_message({name:name,msg:msg,command:command,para1:para1,para2:para2,id:id,pass:pass})}if(!is_auto)this.content_window.document.getElementById("Fchat").msg.value="";if(return_value!=null)return return_value;return msg}};return net}(),camera:function(){var camera;var face_detection,fd_worker;var _bodyPix;var _facemesh,fm_worker;var _poseNet;var _handpose;var use_imagebitmap=true;var url_search_params=new URLSearchParams(self.location.search.substring(1));var _info_extra="";var DEBUG_msg="";var double_flip_mode=true;var video_flipped;var camera_video_timestamp=0;var camera_video_frame_id="";function update_video_canvas(){var video=camera.video;if(!video.videoWidth||video.readyState<2){return}if(_bodyPix.busy||RAF_animation_frame_unlimited&&!MMD_SA.WebXR.session&&camera_video_frame_id==camera.video_frame_id&&!_poseNet.bb_clear){return}camera_video_frame_id=camera.video_frame_id;camera_video_timestamp=RAF_timestamp;var video_canvas=camera.video_canvas;var context=video_canvas.getContext("2d");if(_poseNet.bb_clear){if(video.pause&&!video.paused||--_poseNet.bb_clear<=0||_poseNet._bb&&_poseNet._bb_waiting){_poseNet.bb_clear=_poseNet._bb=_poseNet._bb_waiting=null;context.globalCompositeOperation="copy"}else{if(_poseNet._bb){context.globalCompositeOperation="source-over";context.fillStyle="black";let x=_poseNet._bb[3];let y=_poseNet._bb[0];let w=_poseNet._bb[1]-x;let h=_poseNet._bb[2]-y;x=Math.max(x-w*.25,0);y=Math.max(y-h*.25,0);w=Math.min(w*1.5,video_canvas.width);h=Math.min(h*1.5,video_canvas.height);if(camera.video_flipped){x=video_canvas.width-(x+w)}context.fillRect(x,y,w,h);_poseNet._bb=null;_poseNet._bb_waiting=true}return}}var w,h;if(MMD_SA_options.user_camera.pixel_limit.disabled){w=video.videoWidth;h=video.videoHeight}else if(camera.is_local_media){w=video.videoWidth;h=video.videoHeight;const limit=MMD_SA_options.user_camera.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_;if(w*h>limit[0]*limit[1]){const target_ratio=Math.sqrt(w*h/(limit[0]*limit[1]));w=Math.round(w/target_ratio);h=Math.round(h/target_ratio)}}else{w=camera.target_width;h=camera.target_height}var vo=MMD_SA_options.user_camera.display.webcam_as_bg?{scale:1,top:0}:MMD_SA_options.user_camera.display.video;if(!vo.scale){if(video_canvas.style.pixelWidth!=window.innerWidth||video_canvas.style.pixelHeight!=window.innerHeight){video_canvas.style.width=window.innerWidth+"px";video_canvas.style.height=window.innerHeight+"px"}}else{let scale=vo.scale*(camera.display_floating?MMD_SA_options.user_camera.display.floating_scale||MMD_SA_options.user_camera.display.floating&&1||.5:1);let _w=~~(window.innerWidth*scale);let _h=~~(window.innerHeight*scale);if(video_canvas.style.pixelWidth!=_w||video_canvas.style.pixelHeight!=_h){video_canvas.style.width=_w+"px";video_canvas.style.height=_h+"px";let w_space=(window.innerWidth-_w)/2;let h_space=(window.innerHeight-_h)/2;video_canvas.style.left=w_space*(1+(vo.left!=null?vo.left:-1))+"px";video_canvas.style.top=h_space*(1+(vo.top!=null?vo.top:0))+"px"}video_canvas.style.objectFit="contain"}if(video_canvas.width!=w||video_canvas.height!=h){video_canvas.width=w;video_canvas.height=h;context.globalCompositeOperation="copy";if(camera.video_flipped){context.translate(w,0);context.scale(-1,1)}}if(w==video.videoWidth&&h==video.videoHeight){context.drawImage(video,0,0)}else{let ar=w/h;let ar_video=video.videoWidth/video.videoHeight;let xx,yy,ww,hh;if(ar<=ar_video){ww=video.videoHeight*ar;xx=(video.videoWidth-ww)/2;hh=video.videoHeight;yy=0}else{ww=video.videoWidth;xx=0;hh=video.videoWidth/ar;yy=(video.videoHeight-hh)/2}context.drawImage(video,xx,yy,ww,hh,0,0,w,h)}video_canvas.style.visibility=!camera.visible||_bodyPix.enabled||face_detection.initialized&&face_detection.worker_initialized&&!face_detection.dets||camera.hidden_enforced?"hidden":"inherit"}function video_capture(){if(_bodyPix.enabled){_bodyPix.update_frame()}else{if(_facemesh.enabled){_facemesh.update_frame(true)}else if(face_detection.enabled){face_detection.update_frame(true)}if(_poseNet.enabled||_handpose.enabled){pose_update_frame(true)}}const cs=camera.video_canvas_facemesh.style;const vs=camera.video_canvas.style;const scale=MMD_SA_options.user_camera.display.wireframe.align_with_video?1:MMD_SA_options.user_camera.display.wireframe.scale||(is_mobile?.25:1);const w=~~(vs.pixelWidth*scale);const h=~~(vs.pixelHeight*scale);if(cs.pixelWidth!=w||cs.pixelHeight!=h){cs.pixelWidth=w;cs.pixelHeight=h;if(MMD_SA_options.user_camera.display.wireframe.align_with_video){cs.posLeft=vs.posLeft;cs.posTop=vs.posTop}else{let w_space=(window.innerWidth-w)/2;let h_space=(window.innerHeight-h)/2;cs.left=w_space*(1+(MMD_SA_options.user_camera.display.wireframe.left!=null?MMD_SA_options.user_camera.display.wireframe.left:1))+"px";cs.top=h_space*(1+(MMD_SA_options.user_camera.display.wireframe.top!=null?MMD_SA_options.user_camera.display.wireframe.top:-1))+"px"}}cs.objectFit=vs.objectFit;cs.visibility=camera.ML_enabled&&!MMD_SA_options.user_camera.display.wireframe.hidden&&!MMD_SA_options.user_camera.display.webcam_as_bg?"inherit":"hidden"}var video_capture_active;function add_video_capture(){if(camera.initialized){SL.style.transform=SL_2D_front.style.transform=camera.mirror_3D?"scaleX(-1)":"none";camera.video_canvas.style.transform=camera.display_flipped?"scaleX(-1)":"none";camera.reset_video_canvas()}if(!video_capture_active&&camera.initialized){video_capture_active=true;System._browser.on_animation_update.add(update_video_canvas,0,0,-1);System._browser.on_animation_update.add(video_capture,2,1,-1)}}function remove_video_capture(){SL.style.transform=SL_2D_front.style.transform=camera.mirror_3D?"scaleX(-1)":"none";camera.video_canvas.style.transform="none";camera.reset_video_canvas();if(camera.visible)return;if(video_capture_active&&!camera.ML_enabled){video_capture_active=false;System._browser.on_animation_update.remove(update_video_canvas,0);System._browser.on_animation_update.remove(video_capture,1);camera.video_canvas_facemesh.style.visibility="hidden"}}var video_brightness=100;function adjust_video_brightness(e){if(!camera.visible)return;var keyCode=e.detail.keyCode;if(keyCode==107)video_brightness+=10;else if(keyCode==109)video_brightness-=10;else return;video_brightness=Math.max(Math.min(video_brightness,180),20);var context=camera.video_canvas.getContext("2d");if(video_brightness==1){context.filter="none";DEBUG_show("Brightness:100%",2)}else{context.filter="brightness("+video_brightness+"%) contrast("+(100+(video_brightness-100)*.25)+"%)";DEBUG_show("Brightness:"+video_brightness+"%",2)}e.detail.result.return_value=true}var target_devicePixelRatio=0;function video_fallback(src){if(!src)src=camera.local_src||(webkit_electron_mode?"C:\\Users\\user\\Documents\\_.mp4":System.Gadget.path+"/js/headtrackr.mp4");if(/\.(png|jpg|jpeg|bmp|webp)$/i.test(src)){if(!camera._image){camera._image=new Image;Object.defineProperty(camera._image,"videoWidth",{get:function(){return this.width}});Object.defineProperty(camera._image,"videoHeight",{get:function(){return this.height}});Object.defineProperty(camera._image,"readyState",{get:function(){return this.complete?4:0}})}if(camera.video&&camera.video.pause)camera.video.pause();camera.video=camera._image;camera._image.src=toFileProtocol(src)}else{camera.video=camera._video;camera.video.loop=true;if(!camera.video._initialized){camera.video._initialized=true;camera.video.addEventListener("canplaythrough",function(e){camera.media_control_enabled=true;SL_MC_simple_mode=true;SL_MC_video_obj=camera.video;SL_MC_Place(1,0,-64);var speed=motion_recorder.speed;if(speed){camera.video.playbackRate=speed;if(speed<1)camera.video.muted=true}else{camera.video.playbackRate=1}});camera.video.addEventListener("timeupdate",function(e){SL_MC_Timeupdate(this)},true);camera.video.addEventListener("ended",function(e){if(motion_recorder.speed)motion_recorder.stop()})}camera.video.src=toFileProtocol(src)}camera.video_id=src;camera.local_src=src}window.addEventListener("MMDStarted",()=>{function switch_arm_leg_control(e){if(!System._browser.camera.poseNet.enabled)return;const motion_para=MMD_SA.MMD.motionManager.para_SA;if(!motion_para.motion_tracking_upper_body_only||!motion_para.motion_tracking?.arm_as_leg)return;window.addEventListener("SA_camera_poseNet_update",()=>{motion_para.motion_tracking.arm_as_leg.enabled=!motion_para.motion_tracking.arm_as_leg.enabled;frames.reset_to_default_motion_once=true;DEBUG_show("Arm-as-leg control:"+(motion_para.motion_tracking.arm_as_leg.enabled?"ON":"OFF"),3)},{once:true})}const config={id:"arm_to_leg_control_mode",accelerator:["Alt+Q"],process:switch_arm_leg_control};if(System._browser.hotkeys._hotkey_config){System._browser.hotkeys._hotkey_config.push(config)}else{System._browser.hotkeys.add(config)}});var ML_enabled=false;function ML_init(){var enabled=_facemesh.enabled||_poseNet.enabled;if(ML_enabled==!!enabled)return;ML_enabled=!!enabled;if(enabled){add_video_capture();frames.reset();frames.add_events();DEBUG_show("(Camera ML Mode:ON)",2)}else{if(camera.initialized){camera.video_canvas_face_detection.style.visibility="hidden";camera.video_canvas_facemesh.style.visibility="hidden";remove_video_capture()}frames.remove_events();camera._info="";DEBUG_show("(Camera ML Mode:OFF)",2)}}var pose_initialized,pose_worker_initialized,pose_busy;var v3a,v3b,v3c,v3d;var q1,q2,q3,q4,q5,q6;var rot_m4,q_m4;var v2a,v2b;var pos_offset_last;var rot_parent_upper_body_inv;var shoulder_rot_filter={};var finger_list=["","","","",""];var finger_list_en=["thumb","index","middle","ring","pinky"];var nj_list=["","","",""];window.addEventListener("jThree_ready",()=>{v3a=new THREE.Vector3;v3b=new THREE.Vector3;v3c=new THREE.Vector3;v3d=new THREE.Vector3;pos_offset_last=new THREE.Vector3;q1=new THREE.Quaternion;q2=new THREE.Quaternion;q3=new THREE.Quaternion;q4=new THREE.Quaternion;q5=new THREE.Quaternion;q6=new THREE.Quaternion;rot_m4=new THREE.Matrix4;q_m4=new THREE.Quaternion;v2a=new THREE.Vector2;v2b=new THREE.Vector2;rot_parent_upper_body_inv=new THREE.Quaternion;["",""].forEach(d=>{shoulder_rot_filter[d]=new System._browser.data_filter([{type:"one_euro",id:"shoulder_rot",para:[30,1,5,1,1]}])})});var use_human;var use_mixed_human;var use_tfjs_posenet;var use_movenet=true;var use_blazepose=true;var use_mediapipe;var use_holistic=true;var use_human_only,use_human_pose,use_human_hands;var _no_pose_data=false;var posenet_part_name=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"];var blazepose_translated=[0,2,5,7,8,11,12,13,14,15,16,23,24,25,26,27,28];var posenet_part_dummy=[];posenet_part_name.forEach(name=>{posenet_part_dummy.push({part:name,score:0})});var rot_arm_adjust,rot_hand_adjust;var pose_core_initialized;function pose_init_core(){if(pose_core_initialized)return;pose_core_initialized=true;const model=THREE.MMD.getModels()[0];const bones_by_name=model.mesh.bones_by_name;const armL=bones_by_name[""].pmxBone.origin;const elbowL=bones_by_name[""].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_z_rot=Math.PI/2+Math.atan2(elbowL[1]-armL[1],elbowL[0]-armL[0]);const armIKL=bones_by_name[""].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_to_IK_xy=[armL[0]-armIKL[0],armL[1]-armIKL[1],armL[2]-armIKL[2]];MMD_SA_options.model_para_obj.left_arm_length=MMD_SA.TEMP_v3.fromArray(MMD_SA_options.model_para_obj.left_arm_to_IK_xy).length();MMD_SA_options.model_para_obj.arm_IK_offset={"":(new THREE.Vector3).fromArray(bones_by_name[""].pmxBone.origin).sub(v3b.fromArray(bones_by_name[""].parent.pmxBone.origin)),"":(new THREE.Vector3).fromArray(bones_by_name[""].pmxBone.origin).sub(v3b.fromArray(bones_by_name[""].parent.pmxBone.origin))};let armR=bones_by_name[""].pmxBone.origin;MMD_SA_options.model_para_obj.shoulder_width=Math.abs(armL[0]-armR[0]);MMD_SA_options.model_para_obj.arm_axis={"":(new THREE.Vector3).fromArray(armIKL).sub(MMD_SA.TEMP_v3.fromArray(armL)).normalize()};MMD_SA_options.model_para_obj.arm_axis[""]=MMD_SA_options.model_para_obj.arm_axis[""].clone().setX(-MMD_SA_options.model_para_obj.arm_axis[""].x);const legL=bones_by_name[""].pmxBone.origin;const footL=bones_by_name[""].pmxBone.origin;MMD_SA_options.model_para_obj.hip_center=(new THREE.Vector3).fromArray(legL).setX(0);MMD_SA_options.model_para_obj.spine_length=bones_by_name[""].pmxBone.origin[1]-MMD_SA_options.model_para_obj.hip_center.y;MMD_SA_options.model_para_obj.left_heel_height=footL[1];MMD_SA_options.model_para_obj.leg_IK_offset={"":(new THREE.Vector3).fromArray(bones_by_name[""].pmxBone.origin).sub(v3b.fromArray(bones_by_name[""].parent?.pmxBone?.origin||[0,0,0]).setY(0)),"":(new THREE.Vector3).fromArray(bones_by_name[""].pmxBone.origin).sub(v3b.fromArray(bones_by_name[""].parent?.pmxBone?.origin||[0,0,0]).setY(0))};MMD_SA_options.model_para_obj.left_leg_upper_length=legL[1]-bones_by_name[""].pmxBone.origin[1];MMD_SA_options.model_para_obj.left_leg_lower_length=bones_by_name[""].pmxBone.origin[1]-footL[1];MMD_SA_options.model_para_obj.left_leg_length=MMD_SA_options.model_para_obj.left_leg_upper_length+MMD_SA_options.model_para_obj.left_leg_lower_length;MMD_SA_options.model_para_obj.left_leg_IK=[legL[0]-footL[0],legL[1]-footL[1],legL[2]-footL[2]];let LR=["",""];rot_arm_adjust={};LR.forEach(d=>{["",""].forEach((n,idx)=>{let name_full=d+n;let r=MMD_SA.get_bone_axis_rotation(model.mesh,name_full);rot_arm_adjust[name_full]={name:name_full,axis_rot:r,parent:idx==0?{axis_rot:new THREE.Quaternion}:rot_arm_adjust[d+""]};rot_arm_adjust[name_full].axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(rot_arm_adjust[name_full].parent.axis_rot,MMD_SA.TEMP_q.copy(rot_arm_adjust[name_full].axis_rot).conjugate())})});const rot_hand_adjust_base={};rot_hand_adjust_base[1]=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(0,-Math.PI/2*1,Math.PI/2*1),"YZX");rot_hand_adjust_base[-1]=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(0,-Math.PI/2*-1,Math.PI/2*-1),"YZX");rot_hand_adjust={};rot_hand_adjust[1]=(new THREE.Quaternion).multiplyQuaternions(rot_hand_adjust_base[1],MMD_SA._q1.copy(rot_arm_adjust[""].axis_rot).conjugate());rot_hand_adjust[-1]=(new THREE.Quaternion).multiplyQuaternions(rot_hand_adjust_base[-1],MMD_SA._q1.copy(rot_arm_adjust[""].axis_rot).conjugate());MMD_SA_options.model_para_obj.rot_hand_adjust_base=rot_hand_adjust_base;MMD_SA_options.model_para_obj.rot_hand_adjust=rot_hand_adjust;MMD_SA_options.model_para_obj.finger_base={};LR.forEach(d=>{finger_list.forEach((f,f_idx)=>{let name=d+f+"";let f_base_index=f_idx==0&&bones_by_name[name+nj_list[0]]?0:1;if(!bones_by_name[name+nj_list[f_base_index+0]])return;let f_obj=MMD_SA_options.model_para_obj.finger_base[d+f_idx]={base_index:f_base_index};for(let _f_base_index=f_obj.base_index+(f_idx==0?0:-1),idx=_f_base_index;idx<3;idx++){let name_full=name+nj_list[f_obj.base_index+(idx-_f_base_index)];let r=MMD_SA.get_bone_axis_rotation(model.mesh,name_full,true);rot_arm_adjust[name_full]={name:name_full,axis_rot:r,parent:idx==_f_base_index?rot_arm_adjust[d+""]:rot_arm_adjust[name+nj_list[f_obj.base_index+(idx-1-_f_base_index)]]};rot_arm_adjust[name_full].axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(rot_arm_adjust[name_full].parent.axis_rot,MMD_SA.TEMP_q.copy(rot_arm_adjust[name_full].axis_rot).conjugate())}})});for(const name in rot_arm_adjust){if(name.indexOf("")!=-1){MMD_SA.TEMP_v3.setEulerFromQuaternion(rot_arm_adjust[name].axis_rot,"ZYX");MMD_SA.TEMP_v3.z*=-1;rot_arm_adjust[name].axis_rot.setFromEuler(MMD_SA.TEMP_v3,"ZYX")}rot_arm_adjust[name].axis_rot_inv=rot_arm_adjust[name].axis_rot.clone().conjugate()}for(const name in rot_arm_adjust){if(name.indexOf("")!=-1){rot_arm_adjust[name]._axis_rot_offset_inv_z=MMD_SA.TEMP_v3.setEulerFromQuaternion(MMD_SA.TEMP_q.copy(rot_arm_adjust[name].axis_rot_offset_inv).premultiply(rot_arm_adjust[name].parent.axis_rot_inv).multiply(rot_arm_adjust[name].parent.axis_rot),"ZYX").z}}MMD_SA_options.model_para_obj.rot_arm_adjust=rot_arm_adjust;console.log(rot_arm_adjust)}const pose_workers={};let pose_worker;let pose_worker_id;let pose_worker_url;class PoseWorker{constructor(id,worker){this.id=id;this.worker=worker}initialized=false}async function pose_init(){if(pose_initialized)return;pose_initialized=true;pose_init_core();var para=[];if(is_mobile){para.push("use_mobilenet=1")}if(use_holistic){para.push("use_holistic=1");use_human=use_mixed_human=false;use_blazepose=use_mediapipe=true}if(use_human){para.push("use_human=1");use_human_only=true;use_human=true;use_mixed_human=false;use_tfjs_posenet=false;use_human_pose=true;use_human_hands=true}else if(use_mixed_human){para.push("use_mixed_human=1");use_human=true;use_mixed_human=true;use_tfjs_posenet=true;use_human_hands=true}else{use_human=false;use_mixed_human=false;use_tfjs_posenet=true}if(use_blazepose){para.push("use_blazepose=1");use_mediapipe=true}if(use_mediapipe){para.push("use_mediapipe=1");if(use_human){use_human_pose=true;use_human_hands=false}use_movenet=true}if(use_movenet){para.push("use_movenet=1")}if(MMD_SA_options.user_camera.ML_models.worker_disabled&&_facemesh.initialized&&!_facemesh.worker_initialized){await new Promise(function(resolve,reject){var timerID=setInterval(()=>{if(_facemesh.worker_initialized){clearInterval(timerID);resolve()}},100)})}else{await _facemesh.init()}if(MMD_SA_options.user_camera.ML_models.worker_disabled){pose_worker={postMessage:function(msg,transfer){PoseAT.onmessage({data:msg})}};let script=document.createElement("script");script.onload=function(){PoseAT.init(pose_worker,para)};script.src="js/pose_lib.js";document.head.appendChild(script)}else{pose_worker_url="js/pose_worker.js"+(para.length?"?"+para.join("&"):"");pose_worker_id=_poseNet.use_holistic?"legacy_holistic":"tasks_vision";console.log("Web worker ID:"+pose_worker_id);pose_worker=new Worker(pose_worker_url);pose_workers[pose_worker_id]=new PoseWorker(pose_worker_id,pose_worker)}pose_worker.onmessage=pose_worker_onmessage}var process_head_rotation=function(){let head_rot_filter,head_chest_rot_filter;window.addEventListener("jThree_ready",()=>{head_rot_filter=new System._browser.data_filter([{type:"one_euro",id:"head_rot",para:[30,1,2,1,4]}]);head_chest_rot_filter=new System._browser.data_filter([{type:"one_euro",id:"head_chest_rot",para:[30,.25,.5,1,3]}])});return function(mesh,name){const bone=mesh.bones_by_name[name];const s=this.skin[name];let ratio=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);const q_identity=MMD_SA.TEMP_q.set(0,0,0,1);var rot=s[0].no_blending?MMD_SA._q2.copy(s[0].rot):MMD_SA._q2.copy(s[1].rot).slerp(s[0].rot,ratio);if(!bone){s[0]._rot_from_pose.copy(rot);return}const motion_para=MMD_SA.MMD.motionManager.para_SA;const use_motion_tracking_para=_poseNet.enabled||motion_para.motion_tracking_upper_body_only;var rot_parent=s[0].rot_parent;if(!rot_parent){const head_rotation_weight=use_motion_tracking_para&&motion_para.motion_tracking?.head_rotation_weight||0;if(head_rotation_weight==1){rot_parent=new THREE.Quaternion}else{rot_parent=MMD_SA.get_bone_rotation_parent(mesh,name,mesh).conjugate();if(use_motion_tracking_para)rot_parent.premultiply(q2.copy(this._rot_body_offset).multiply(this._rot_body_camera));if(head_rotation_weight)rot_parent.slerp(q_identity,head_rotation_weight)}}s[0]._rot_parent=rot_parent;if(s[0].info[1]=="facemesh"&&this.skin[name+"_DUMMY_"]){let _ratio=Math.min(Math.max(.25-s[0]._rot_ratio,0)*5,1);rot.slerp(this.skin[name+"_DUMMY_"][0]._rot_from_pose,_ratio*_ratio*.667);s[0]._rot_mixed=rot.clone()}var angle=rot.toAxisAngle()[1]%(Math.PI*2);if(angle>Math.PI)angle=Math.PI*2-angle;else if(angle<0&&angle<-Math.PI)angle+=Math.PI*2;angle=Math.abs(angle);ratio=_poseNet.use_3D_pose?.5:.3+Math.max(angle-Math.PI/2,0)/(Math.PI/2)*.2;var rot_head=q1.multiplyQuaternions(rot_parent,rot);rot_head.fromArray(head_rot_filter.filter(rot_head.toArray()));var rot_head_v3=v3a.setEulerFromQuaternion(rot_head,"YZX");var rot_head_ratio=[rot_head_v3.x<0?ratio+(.5-ratio)*.5:ratio,ratio,ratio];rot_head.setFromEuler(v3b.fromArray(rot_head_v3.toArray().map((a,i)=>Math.sign(a)*Math.min(Math.abs(a),Math.PI/2)*rot_head_ratio[i])),"YZX");if(use_motion_tracking_para){const motion_tracking=motion_para.motion_tracking;const rot0_ratio=1-(motion_tracking?.motion_default_weight?.head||0)*this.camera_weight;if(rot0_ratio){const rot0=q2.copy(bone.quaternion).premultiply(q3.copy(this._body_motion_rot[0][""]).conjugate());bone.quaternion.slerp(rot0,rot0_ratio);rot0.copy(mesh.bones_by_name[""].quaternion).premultiply(q3.copy(this._body_motion_rot[0][""]).conjugate());mesh.bones_by_name[""].quaternion.slerp(rot0,rot0_ratio)}}bone.quaternion.multiply(rot_head);mesh.bones_by_name[""].quaternion.premultiply(rot_head);s[0]._rot_neck=bone.quaternion.clone();s[0]._rot_head=mesh.bones_by_name[""].quaternion.clone();if(motion_recorder.active){motion_recorder.set_boneKey(name,null,bone.quaternion,true);motion_recorder.set_boneKey("",null,mesh.bones_by_name[""].quaternion,false)}if(ratio<.5){const bone=mesh.bones_by_name["2"];const rot_torso=q1.setFromEuler(v3a.fromArray(head_chest_rot_filter.filter(v3a.setEulerFromQuaternion(rot,"YZX").multiply(v3b.fromArray(rot_head_ratio.map(r=>1-r*2))).toArray())),"YZX");if(!_poseNet.enabled){frames.add("skin","2",{no_blending:true,rot:rot_torso.clone()})}else{bone.quaternion.multiply(rot_torso)}}}}();var camera_depth_scale=1*10;var camera_depth=function(){var camera_depth_data=[];var camera_depth_filter;var v_hip,v_hip_filter;window.addEventListener("jThree_ready",()=>{camera_depth_filter=new System._browser.data_filter([{type:"one_euro",id:"camera_depth",para:[30,1,1/5,1,1]}]);camera_depth.v_hip=v_hip=new THREE.Vector3;v_hip_filter=new System._browser.data_filter([{type:"one_euro",id:"v_hip",para:[30,1,1/2,1,3]}])});function prepare(pose){var armL=pose.keypoints[5];var armR=pose.keypoints[6];var hipL=pose.keypoints[11];var hipR=pose.keypoints[12];if(armL.score<=0||armR.score<=0)return;let armL3D,armR3D;if(pose.keypoints3D_raw){armL3D=pose.keypoints3D_raw[11];armR3D=pose.keypoints3D_raw[12]}else{armL3D=pose.keypoints3D[5];armR3D=pose.keypoints3D[6]}camera_depth_data=[{point2D:[{position:new THREE.Vector3},{position:new THREE.Vector3}],data3D:{length:0,z_diff:0}}];const spine_length_ref=_poseNet.spine_length_ref;let shoulder_reference_ratio=1;if(hipL.score>0&&hipR.score>0){let spine=MMD_SA._v3a.addVectors(armL3D,armR3D).multiplyScalar(.5);let spine3D_length=spine.length();let y_axis=MMD_SA.TEMP_v3.set(0,1,0);y_axis.y*=-1;let _ax=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(y_axis,spine.normalize()),"ZXY").x;shoulder_reference_ratio=Math.abs(_ax)/(Math.PI/2);shoulder_reference_ratio=shoulder_reference_ratio<=1?Math.max(shoulder_reference_ratio-.5,0)/.5:Math.max(2-shoulder_reference_ratio,0);let hip2D=v2a.copy(hipL.position).add(hipR.position).multiplyScalar(.5);let shoulder2D=v2b.copy(armL.position).add(armR.position).multiplyScalar(.5);let spine2D_length=hip2D.distanceTo(shoulder2D);shoulder2D.copy(hip2D);shoulder2D.y=shoulder2D.y-spine2D_length/Math.abs(Math.cos(_ax));camera_depth_data[0].point2D[0].position.copy(shoulder2D);camera_depth_data[0].point2D[1].position.copy(hip2D);camera_depth_data[0].data3D.length=spine_length_ref*(spine3D_length*2)}if(shoulder_reference_ratio){let shoulder=MMD_SA._v3b.copy(armL3D).sub(armR3D);let shoulder3D_length=shoulder.length();let x_axis=MMD_SA.TEMP_v3.set(1,0,0);let _ay=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(x_axis,shoulder.normalize()),"ZYX").y;let hip2D=v2b.copy(armL.position).add(armR.position).multiplyScalar(.5);let shoulder2D=hip2D.clone();let shoulder2D_length=v2a.copy(armL.position).distanceTo(armR.position);hip2D.y=hip2D.y+shoulder2D_length*1.5/Math.abs(Math.cos(_ay));if(hip2D.y>camera.video_canvas.height){shoulder2D.y=Math.max(shoulder2D.y-(hip2D.y-camera.video_canvas.height),0);hip2D.y=camera.video_canvas.height}if(camera_depth_data[0].data3D.length!=0){let spine_reference_ratio=Math.abs(_ay)/(Math.PI/2);spine_reference_ratio=spine_reference_ratio<=1?Math.max(spine_reference_ratio-.5,0)/.5:Math.max(2-spine_reference_ratio,0);shoulder_reference_ratio*=1-spine_reference_ratio}camera_depth_data[0].point2D[0].position.lerp(shoulder2D,shoulder_reference_ratio);camera_depth_data[0].point2D[1].position.lerp(hip2D,shoulder_reference_ratio);camera_depth_data[0].data3D.length=camera_depth_data[0].data3D.length*(1-shoulder_reference_ratio)+spine_length_ref*(shoulder3D_length*3)*shoulder_reference_ratio}}function estimate(){if(!camera_depth_data.length)return;var camera=System._browser.camera;var w=camera.video_canvas.width;var h=camera.video_canvas.height;var v3_screen=v3a;var camera_depth=[];const ar=w/h;const ar_3D=SL.width/SL.height;const w_ar=ar<ar_3D?ar/ar_3D:1;const h_ar=ar_3D<ar?ar_3D/ar:1;camera_depth_data.forEach(data=>{v3_screen.set((data.point2D[0].position.x/w*2-1)*w_ar,(-(data.point2D[0].position.y/h)*2+1)*h_ar,.5);var v3_armL=MMD_SA._v3a.copy(v3_screen.unproject(camera._camera_reset).sub(camera._camera_reset.position).normalize());v3_screen.set((data.point2D[1].position.x/w*2-1)*w_ar,(-(data.point2D[1].position.y/h)*2+1)*h_ar,.5);var v3_hipR=MMD_SA._v3b.copy(v3_screen.unproject(camera._camera_reset).sub(camera._camera_reset.position).normalize());var length,z_diff;length=data.data3D.length;z_diff=data.data3D.z_diff;let a=Math.sqrt(Math.pow(v3_armL.x-v3_hipR.x*v3_armL.z/v3_hipR.z,2)+Math.pow(v3_armL.y-v3_hipR.y*v3_armL.z/v3_hipR.z,2)+0);let b=v3_armL.x-v3_hipR.x*v3_armL.z/v3_hipR.z+(v3_armL.y-v3_hipR.y*v3_armL.z/v3_hipR.z)+0;let c=b/a;let _z_=1;let s_armL=(Math.sqrt(length*length+1)-1)/(a/c);v3_armL.multiplyScalar(s_armL);camera_depth.push({z:-v3_armL.z*1.5,id:data.id})});camera_depth.sort((a,b)=>b.z-a.z);var _z=camera_depth[0].z;this.z=_z;z=camera_depth_filter.filter(_z);this.z_smoothed=z;camera_depth_data=[]}function get_hip_center(pose){if(MMD_SA.WebXR.session){v_hip.set(0,0,0);return}const w=camera.video_canvas.width;const h=camera.video_canvas.height;const hipL=pose.keypoints[11];const hipR=pose.keypoints[12];const armL=pose.keypoints[5];const armR=pose.keypoints[6];const arm_center=armL.score>0&&armR.score>0?v2a.copy(armL.position).add(armR.position).multiplyScalar(.5):null;const ar=w/h;const ar_3D=SL.width/SL.height;const w_ar=ar<ar_3D?ar/ar_3D:1;const h_ar=ar_3D<ar?ar_3D/ar:1;let hip_center;let hip_ratio=0;if(hipL.score>0&&hipR.score>0){hip_center=v2b.copy(hipL.position).add(hipR.position).multiplyScalar(.5);const x=hip_center.x;const y=hip_center.y;hip_ratio=1;if(arm_center){if(y<0||y>h){hip_ratio=1-Math.min((y<0?-y:y-h)/Math.abs(arm_center.y-y),1)}if(x<0||x>w){hip_ratio=Math.min(hip_ratio,1-Math.min((x<0?-x:x-w)/Math.abs(arm_center.x-x),1))}hip_ratio=Math.max(hip_ratio-.5,0)/.5}v_hip.set(((hipL.position.x+hipR.position.x)/2/w*2-1)*w_ar,(-((hipL.position.y+hipR.position.y)/2/h)*2+1)*h_ar,.5).unproject(camera._camera_reset).sub(camera._camera_reset.position).normalize()}let v_hip_from_shoulder;if(hip_ratio<1){v_hip_from_shoulder=v3c.set(((armL.position.x+armR.position.x)/2/w*2-1)*w_ar,(-((armL.position.y+armR.position.y)/2/h)*2+1)*h_ar,.5).unproject(camera._camera_reset).sub(camera._camera_reset.position).normalize()}if(camera_depth_scale)camera_depth.estimate();const cam_distance_default=camera._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z;let cam_distance=cam_distance_default;if(camera_depth_scale&&camera_depth.z)cam_distance=camera_depth.z_smoothed||camera_depth.z;if(hip_ratio>0)v_hip.multiplyScalar(-cam_distance/v_hip.z);if(v_hip_from_shoulder){const spine_length=_poseNet.spine_length_ref;const v_hip_offset=MMD_SA.TEMP_v3.set(0,-spine_length,0);v_hip.lerp(v_hip_from_shoulder.multiplyScalar(-cam_distance/v_hip_from_shoulder.z).add(v_hip_offset),1-hip_ratio)}const filter=v_hip_filter.filters[0].filter;const f=Math.max(Math.abs(v_hip.z)-10,0)/10;const v=.2+f*.8;filter.minCutOff=Math.min(v,10);filter.beta=Math.min(v,1);v_hip.fromArray(v_hip_filter.filter(v_hip.toArray()))}return{prepare:prepare,estimate:estimate,get_hip_center:get_hip_center}}();var lock_elbow=(()=>{function findCircleLineIntersections(r,h,k,m,n){function sq(v){return v*v}const sqrt=Math.sqrt;var a=1+sq(m);var b=-h*2+m*(n-k)*2;var c=sq(h)+sq(n-k)-sq(r);var d=sq(b)-4*a*c;if(d>=0){var intersections=[(-b+sqrt(sq(b)-4*a*c))/(2*a),(-b-sqrt(sq(b)-4*a*c))/(2*a)];if(d==0){return[intersections[0]]}return intersections}return[]}var v3b,v3c,v3d;var q2;window.addEventListener("jThree_ready",()=>{v3b=new THREE.Vector3;v3c=new THREE.Vector3;v3d=new THREE.Vector3;q2=new THREE.Quaternion});return function(elbow_lock,mesh,d){const py=elbow_lock._elbow_y;const b_elbow=MMD_SA.get_bone_position(mesh,d+"",mesh);if(b_elbow.y>py)return;const b_hand=MMD_SA.get_bone_position(mesh,d+"",mesh);const b_arm=MMD_SA.get_bone_position(mesh,d+"",mesh);const a=b_arm;const m=v3d.copy(b_hand).sub(a);const p=b_elbow;const t=(p.x*m.x+p.y*m.y+p.z*m.z-(a.x*m.x+a.y*m.y+a.z*m.z))/m.lengthSq();const q=MMD_SA._v3b.set(a.x+m.x*t,a.y+m.y*t,a.z+m.z*t);const x_axis=m.normalize();const y_axis=v3c.copy(b_elbow).sub(q).normalize().negate();const z_axis=v3b.crossVectors(x_axis,y_axis).normalize();const p1=(new THREE.Plane).setFromNormalAndCoplanarPoint(x_axis,b_elbow);const p2=(new THREE.Plane).setFromNormalAndCoplanarPoint(MMD_SA.TEMP_v3.set(0,1,0),MMD_SA._v3a.set(0,py,0));const line=p1.intersectPlane(p2);if(!line)return;rot_m4.set(x_axis.x,x_axis.y,x_axis.z,0,y_axis.x,y_axis.y,y_axis.z,0,z_axis.x,z_axis.y,z_axis.z,0,0,0,0,1);q_m4.setFromBasis(rot_m4);const r=MMD_SA.TEMP_v3.copy(b_elbow).sub(q).length();let y_intercept=p2.intersectLine(new THREE.Line3(b_elbow,q),v3d);if(!y_intercept)return;y_intercept=-y_intercept.sub(b_elbow).length();line[1].applyQuaternion(q_m4);const slope=line[1].y/line[1].z;b_elbow.sub(b_arm);b_elbow.applyQuaternion(q_m4);const intersections=findCircleLineIntersections(r,b_elbow.z,b_elbow.y,slope,y_intercept);if(!intersections.length)return;const angle=intersections.map(x=>{x-=b_elbow.z;return Math.asin(x/r)});const sign_LR=d==""?1:-1;const rot_chest=MMD_SA.get_bone_rotation(mesh,"2",null,mesh);const rot_arm_parent=q2.copy(rot_chest).conjugate();const axis=v3c.copy(b_hand).sub(b_arm).normalize().applyQuaternion(rot_arm_parent);const _angle=elbow_lock.use_smallest_angle?angle.sort((a,b)=>Math.abs(a)-Math.abs(b))[0]:angle[sign_LR==-1?angle.length-1:0];const rot_adjust=MMD_SA.TEMP_q.setFromAxisAngle(axis,_angle);mesh.bones_by_name[d+""].quaternion.premultiply(rot_adjust)}})();const shoulder_z_angle=[0,0,0];var pose_worker_onmessage=function(){function rotate_arm(rot_arm,name){let r=rot_arm_adjust[name];rot_arm.premultiply(r.axis_rot).multiply(r.axis_rot_inv);rot_arm.multiplyQuaternions(r.axis_rot_offset_inv,rot_arm)}function adjust_leg_IK(mesh,name){if(_poseNet.IK_disabled_check(name))return;var bone=mesh.bones_by_name[name];var s=this.skin[name];var d=name.charAt(0);var hip_pmx=MMD_SA.TEMP_v3.fromArray(mesh.bones_by_name[d+""].pmxBone.origin);var hip_offset=MMD_SA.get_bone_position(mesh,d+"","").sub(hip_pmx);bone.position.add(hip_offset);mesh.bones_by_name[d+""].quaternion.set(0,0,0,1);if(motion_recorder.active){if(MMD_SA_options.user_camera.ML_models.pose.use_legIK){const pos_IK=MMD_SA.TEMP_v3.copy(bone.position);pos_IK.sub(v3a.fromArray(mesh.bones_by_name[name].pmxBone.origin).sub(v3b.fromArray(mesh.bones_by_name[name].parent?.pmxBone?.origin||[0,0,0])));motion_recorder.set_boneKey(name,pos_IK,s[0].rot?bone.quaternion:null,true)}window.addEventListener("SA_MMD_model"+mesh._model_index+"_process_bones_after_IK",()=>{motion_recorder.set_boneKey(d+"",null,mesh.bones_by_name[d+""].quaternion,false);motion_recorder.set_boneKey(d+"",null,mesh.bones_by_name[d+""].quaternion,false)},{once:true})}bone.quaternion.set(0,0,0,1)}function process_arm(mesh,name){const d=name.charAt(0);const bones=mesh.bones_by_name;const q=bones[name].quaternion;if(MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only){q.multiplyQuaternions(rot_parent_upper_body_inv,q)}process_arm_from_shoulder.call(this,mesh,name)}function process_arm_from_shoulder(mesh,name){const d=name.charAt(0);const bones=mesh.bones_by_name;const q=bones[name].quaternion;const s=this.skin[d+""];if(s){let ratio=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);q.premultiply(MMD_SA.TEMP_q.copy(s[1].rot).slerp(s[0].rot,ratio).conjugate())}}var adjust_hip_center=(()=>{var shoulder_y_offset_filter;window.addEventListener("jThree_ready",()=>{});return function(mesh,name){var bone=mesh.bones_by_name[name];var s=this.skin[name];var ratio=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);const v_hip=v3a.copy(camera_depth.v_hip);if(MMD_SA.WebXR.session){v_hip.set(0,0,0)}else{const cam_distance_default=camera._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z;v_hip.z=MMD_SA_options.user_camera.ML_models.pose.estimate_z_depth===false?0:cam_distance_default+v_hip.z}if(MMD_SA_options.user_camera.ML_models.pose.position_offset)v_hip.add(MMD_SA_options.user_camera.ML_models.pose.position_offset);s[0].pos.copy(v_hip);var pos_offset=(new THREE.Vector3).copy(s[1].pos).lerp(s[0].pos,ratio);var hipL=MMD_SA.get_bone_position(mesh,"","");var hipR=MMD_SA.get_bone_position(mesh,"","");var hip_offset=MMD_SA.TEMP_v3.copy(hipL).add(hipR).multiplyScalar(.5).sub(MMD_SA_options.model_para_obj.hip_center).negate();if(_poseNet.auto_grounding){let legL=MMD_SA.get_bone_position(mesh,"","");let legR=MMD_SA.get_bone_position(mesh,"","");let leg_on_ground=legL.y<legR.y?legL:legR;let leg_offset=MMD_SA_options.model_para_obj.left_heel_height+.2-leg_on_ground.y;leg_offset-=pos_offset.y;hip_offset.y=leg_offset}pos_offset.add(hip_offset);pos_offset.x*=camera.x_flipped?-1:1;if(s[0].absolute)bone.position.set(0,0,0);bone.position.add(pos_offset);motion_recorder.active&&motion_recorder.set_boneKey(name,pos_offset,null,true);var dis_offset=pos_offset_last.distanceTo(pos_offset)-5;if(dis_offset>0){THREE.MMD.getModels()[mesh._model_index].resetPhysics(15+dis_offset*2)}pos_offset_last.copy(pos_offset)}})();function transform_position(name,pos,p,transform_default){function get_value(v,axis,len){if(typeof v=="number")return v;if(/^(\w+)([\+\-])([\d\.])$/.test(v)){const f=(RegExp.$2=="+"?1:-1)*parseFloat(RegExp.$3);const _pos=MMD_SA.TEMP_v3.copy(pos);const pos_name=RegExp.$1;if(pos_name=="default"){_pos.copy(frames._skin[name].pos).sub(name.indexOf("")!=-1?MMD_SA_options.model_para_obj.arm_IK_offset[d]:MMD_SA_options.model_para_obj.leg_IK_offset[d]).applyQuaternion(frames._skin[name].rot_parent_inv)}else if(pos_name=="elbow"){if(axis=="y"){const elbow_y=motion_para?.motion_tracking?.arm_tracking?.elbow_lock?.[d==""?"left":"right"]?._elbow_y;if(elbow_y!=null&&elbow_y!=0){_pos.y=elbow_y-MMD_SA.get_bone_position(mesh,d+"",mesh).y}}}return(_pos[axis]+f)/len}return 0}const d=name.charAt(0);const pos_length_unit=name.indexOf("")!=-1?MMD_SA_options.model_para_obj.left_arm_length:MMD_SA_options.model_para_obj.left_leg_length;const dir=d==""?"left":"right";const model=THREE.MMD.getModels()[0];const mesh=model.mesh;const motion_para=MMD_SA.motion[model.skin._motion_index].para_SA;let rot_upper_leg;if(p){for(const axis of["x","y","z"]){const a=p[axis];if(!a)continue;const len=a.unit_length||pos_length_unit;if(a.scale!=null)pos[axis]*=typeof a.scale?.[dir]=="number"&&a.scale[dir]||a.scale;if(a.add)pos[axis]+=get_value(a.add?.[dir]||a.add,axis,len)*len;if(a.min!=null)pos[axis]=Math.max(pos[axis],get_value(a.min?.[dir]||a.min,axis,len)*len);if(a.max!=null)pos[axis]=Math.min(pos[axis],get_value(a.max?.[dir]||a.max,axis,len)*len)}if(p.rotation)pos.applyEuler(MMD_SA.TEMP_v3.copy(p.rotation).multiplyScalar(Math.PI/180));if(p.camera_weight&&name.indexOf("")==-1)pos.applyQuaternion(MMD_SA.TEMP_q.set(0,0,0,1).slerp(frames._rot_camera,p.camera_weight));const pp=p.position_to_rotation;if(pp){const bones=mesh.bones_by_name;const pos_rot=v3c.set(Math.atan2(pos.z,pos.y),0,-Math.atan2(pos.x,pos.z));const rot_motion={upper:{q:q1},lower:{q:q2}};for(const part of["upper","lower"]){const bone_name=d+(part=="upper"?"":"");const bone=bones[bone_name];rot_motion[part].name=bone_name;rot_motion[part].q.copy(bone.quaternion);bone.quaternion.set(0,0,0,1);if(!pp[part])continue;const rot=v3d.set(0,0,0);for(const axis of["x","y","z"]){const a=pp[part][axis];if(!a)continue;let angle=0;const rot_formula=a.rot_formula?.[dir]||a.rot_formula;if(rot_formula?.length==1){angle=pos_rot[rot_formula]*180/Math.PI}if(a.add)angle+=a.add?.[dir]||a.add;if(a.scale!=null)angle*=typeof a.scale?.[dir]=="number"&&a.scale[dir]||a.scale;if(a.curve){const ac=a.curve?.[dir]||a.curve;const v=(angle-ac.ini)/(ac.end-ac.ini);if(v>0&&v<1)angle=Math.pow(v,ac.pow_factor)*(ac.end-ac.ini)+ac.ini}if(a.min!=null)angle=Math.max(angle,a.min?.[dir]||a.min);if(a.max!=null)angle=Math.min(angle,a.max?.[dir]||a.max);rot[axis]=angle/180*Math.PI}bone.quaternion.setFromEuler(rot,"XZY");if(part=="upper")rot_upper_leg=bone.quaternion.clone()}const leg0=MMD_SA.get_bone_position(mesh,d+"","");const pos0=MMD_SA.get_bone_position(mesh,d+"","");const x_dir=camera.x_flipped?-1:1;const hip_pmx=v3c.fromArray(bones[d+""].pmxBone.origin);const hip_offset=hip_pmx.sub(leg0).negate();const IK_pos=leg0.sub(pos0);IK_pos.x*=x_dir;IK_pos.y*=-1;IK_pos.z*=-1;IK_pos.add(MMD_SA_options.model_para_obj.leg_IK_offset[d]);IK_pos.add(hip_offset);IK_pos.y-=MMD_SA_options.model_para_obj.left_leg_IK[1]+(bones[""].position.y-bones[""].pmxBone.origin[1]);pos.copy(IK_pos);for(const part in rot_motion)bones[rot_motion[part].name].quaternion.copy(rot_motion[part].q)}}else{if(transform_default)transform_default(pos)}p?.magnet?.forEach(m=>{const hand=m.hand_affected[dir];if(!hand)return;if(!frames.skin[name]?.[0]._hand_visible)return;const modelX=MMD_SA.THREEX.get_model(0);let reference_point=MMD_SA._v3a.set(0,0,0);let pos_local;let rot_local=MMD_SA._q1.set(0,0,0,1);let x_object;if(m.type=="object3D"){const object3d=MMD_SA.THREEX._XR_Animator_scene_?.object3D_list.find(obj=>obj.id==m.id);if(!object3d)return;x_object=MMD_SA.THREEX._object3d_list_.find(obj=>obj.uuid==object3d._object3d_uuid);reference_point.copy(m.reference_point).multiply(x_object._mesh.scale);rot_local=MMD_SA._q1.copy(mesh.quaternion).conjugate().multiply(x_object._mesh.quaternion);reference_point.applyQuaternion(rot_local);pos_local=MMD_SA._v3b.copy(x_object._mesh.position).sub(mesh.position).applyQuaternion(MMD_SA.TEMP_q.copy(mesh.quaternion).conjugate());reference_point.add(pos_local)}else if(m.type=="bone"){const name_MMD=MMD_SA.THREEX.VRM.bone_map_VRM_to_MMD[m.name];reference_point=modelX.get_bone_position_by_MMD_name(name_MMD,true);if(m.offset){rot_local=modelX.get_bone_rotation_by_MMD_name(name_MMD,true);reference_point.add(MMD_SA._v3a.copy(m.offset).applyQuaternion(rot_local))}}else{reference_point.copy(m.position)}const bone_pos_local=modelX.get_bone_position_by_MMD_name(name.substring(0,2),true);reference_point.sub(bone_pos_local);let arm_scale=1;if(MMD_SA.THREEX.enabled){arm_scale=MMD_SA_options.model_para_obj.left_arm_length/modelX.para.left_arm_length;reference_point.multiplyScalar(arm_scale)}let pos_offset=MMD_SA._v3a_.set(0,0,0);if(hand.offset){if(hand.offset=="parent_bone"){pb=MMD_SA.THREEX._object3d_list_.find(obj=>obj.parent_bone?.name==d+""&&!obj.parent_bone.disabled)?.parent_bone;if(pb)pos_offset.set(pb.position.x,pb.position.y,-pb.position.z)}else{pos_offset.copy(hand.offset);if(!modelX.is_T_pose)pos_offset.applyQuaternion(MMD_SA_options.model_para_obj.rot_arm_adjust[d+""].axis_rot)}pos_offset.applyQuaternion(modelX.get_bone_rotation_by_MMD_name(d+"",true))}pos.add(pos_offset);let ratio=0;let peak;if(m.magnet_type=="line"){const line=MMD_SA.THREEX.l1;line.start.copy(reference_point);if(m.line_end){line.end.copy(m.line_end).multiply(x_object._mesh.scale).applyQuaternion(rot_local);line.end.add(pos_local)}else{line.end.copy(pos_local||MMD_SA.TEMP_v3.set(0,0,0))}line.end.sub(bone_pos_local).multiplyScalar(arm_scale);if(m.line_offset){const offset=MMD_SA.TEMP_v3.copy(m.line_offset).multiply(x_object._mesh.scale).applyQuaternion(rot_local).multiplyScalar(arm_scale);line.start.add(offset);line.end.add(offset)}line.closestPointToPoint(pos,true,reference_point);let dis=pos.distanceTo(reference_point);if(dis<m.effective_distance){peak=m.peak_distance||0;ratio=1-Math.abs(dis-peak)/(m.effective_distance-peak);if(m.power)ratio=Math.pow(ratio,1-m.power)}}else if(m.magnet_type=="plane"){const plane=MMD_SA.THREEX.p1.setFromNormalAndCoplanarPoint(MMD_SA.TEMP_v3.copy(m.plane_normal).applyQuaternion(rot_local),reference_point);const line=MMD_SA.THREEX.l1;line.start.copy(pos);line.end.copy(MMD_SA.TEMP_v3.copy(plane.normal).multiplyScalar(999).add(pos));let intersected=plane.intersectsLine(line);if(intersected&&!m.plane_crossable){ratio=1}else{if(!intersected)line.end.sub(pos).negate().add(pos);const dis=plane.distanceToPoint(pos);if(dis<m.effective_distance){peak=m.peak_distance||0;ratio=1-Math.abs(dis-peak)/(m.effective_distance-peak);if(m.power)ratio=Math.pow(ratio,1-m.power)}}const ref_pt=MMD_SA.THREEX.v1;plane.intersectLine(line,ref_pt);reference_point.copy(ref_pt)}else{const dis=pos.distanceTo(reference_point);if(dis<m.radius){peak=m.peak_radius||0;if(m.peak_barrier&&dis<peak){ratio=1}else{ratio=1-Math.abs(dis-peak)/(m.radius-peak);if(m.power)ratio=Math.pow(ratio,1-m.power)}}}if(ratio){if(peak)reference_point.add(pos.clone().sub(reference_point).normalize().multiplyScalar(peak));pos.lerp(reference_point,ratio)}m._frame_count_=EV_sync_update.count_frame;m._weight_=ratio;pos.sub(pos_offset)});const len_default=pos.length();let len=len_default*(typeof p?.length?.scale=="number"?p?.length?.scale:p?.length?.scale?.[dir]||1);for(const limit of["max","min"]){const limit_default="length_"+limit;let len_limit,len_unit=pos_length_unit;if(p?.[limit_default]||p?.length){if(typeof p[limit_default]=="number"){len_limit=p[limit_default]}else{len_limit=p.length[limit];if(len_limit==null)continue;if(typeof len_limit!="number"){len_limit=len_limit[dir];if(len_limit==null)continue}if(p.length.unit_length)len_unit=p.length.unit_length}}else{continue}if(limit=="max"){if(len>len_unit*len_limit)len=len_unit*len_limit}else{if(len<len_unit*len_limit)len=len_unit*len_limit}}if(len!=len_default)pos.normalize().multiplyScalar(len);const result=[pos];if(rot_upper_leg)result.push(rot_upper_leg);return result}var process_armIK=(()=>{var armIK_data_filter;window.addEventListener("jThree_ready",()=>{armIK_data_filter=new System._browser.data_filter([{type:"one_euro",id:"armIK",para:[30,1,1/5,1,3]}])});return function(mesh,name){if(_poseNet.IK_disabled_check(name))return;var bone=mesh.bones_by_name[name];var s=this.skin[name];var ratio=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);var d=name.charAt(0);var pos=v3a.copy(s[1].pos).lerp(s[0].pos,ratio);const motion_para=MMD_SA.MMD.motionManager.para_SA;const dir=d==""?"left":"right";const t=motion_para?.motion_tracking?.arm_tracking?.transformation;if(t){const p=t.position;transform_position(d+"",pos,p);let root_rotation=t.root_rotation?.[dir];if(root_rotation){const root_bone=d+"";const rot=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(root_rotation.x,root_rotation.y,root_rotation.z).multiplyScalar(Math.PI/180),root_rotation.order);let r=rot_arm_adjust[root_bone];rot.premultiply(r.axis_rot).multiply(r.axis_rot_inv);mesh.bones_by_name[root_bone].quaternion.premultiply(rot)}}if(s[0].data_filter||s[1].data_filter){pos.fromArray(armIK_data_filter.filter(pos.toArray()))}const body_rot=MMD_SA.get_bone_rotation_parent(mesh,name,mesh);if(!s[0]._IK_absolute){pos.applyQuaternion(this.offset_upper_body_camera_rotation(q1.copy(body_rot).conjugate(),motion_para?.motion_tracking?.arm_tracking?.transformation?.position?.camera_weight||1))}const _arm_IK_adjust=_poseNet._arm_IK_adjust?.[d];if(_arm_IK_adjust){const len=MMD_SA_options.model_para_obj.left_arm_length;const axis=["x","y","z"];if(_arm_IK_adjust.min){if(typeof _arm_IK_adjust.min=="number"){}else{for(const a of axis){if(_arm_IK_adjust.min[a]){if(pos[a]<_arm_IK_adjust.min[a]*len)pos[a]=_arm_IK_adjust.min[a]*len}}}}if(_arm_IK_adjust.scale){if(typeof _arm_IK_adjust.scale=="number"){}else{for(const a of axis){if(_arm_IK_adjust.scale[a]){pos.multiplyScalar(_arm_IK_adjust.scale[a])}}}}}var arm_pmx=v3b.fromArray(mesh.bones_by_name[d+""].pmxBone.origin).sub(v3c.fromArray(bone.parent.pmxBone.origin));var arm_offset=MMD_SA.get_bone_position(mesh,d+"",bone.parent.name).sub(arm_pmx);pos.add(arm_offset);const a=this.arm_IK_constraint[d];if(a.enabled){arm0=MMD_SA.get_bone_position(mesh,d+"",mesh);const IK_pos=v3b.copy(pos).applyQuaternion(body_rot).add(a.arm_pos);const target=v3c.copy(a.target).sub(IK_pos);if(!a.target_radius||target.length()>a.target_radius){const IK_offset=IK_pos.sub(a.target).add(target.normalize().multiplyScalar(a.target_radius));pos.sub(IK_offset.applyQuaternion(body_rot.conjugate()))}}pos.add(MMD_SA_options.model_para_obj.arm_IK_offset[d]);bone.position.copy(pos)}})();var process_arm_as_leg=function(){let hand_rot_filter={};let finger_x_filter={};window.addEventListener("jThree_ready",()=>{hand_rot_filter[""]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,4]}]);hand_rot_filter[""]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,4]}]);finger_x_filter[""]=[];finger_x_filter[""]=[];for(let i=0;i<5;i++){finger_x_filter[""][i]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,1]}]);finger_x_filter[""][i]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,1]}])}});return function(mesh,name){var model=THREE.MMD.getModels()[mesh._model_index];var bone=mesh.bones_by_name[name];var d=name.charAt(0);var rot=bone.quaternion;const s=this.skin[name];const ratio=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);rot.copy(s[1].rot).slerp(s[0].rot,ratio);rot.fromArray(hand_rot_filter[d].filter(rot.toArray()));const euler_order="YXZ";const rot_euler=MMD_SA.TEMP_v3.setEulerFromQuaternion(rot,euler_order);const rot_para=MMD_SA.MMD.motionManager.para_SA.motion_tracking.arm_as_leg.transformation?.rotation||{};let rot_y=Math.sign(rot_euler.y)*Math.min(Math.abs(rot_euler.y*(rot_para.y?.scale||1)),Math.PI/2);const rot_y_ratio=rot_para.y?.foot_ratio||.25;rot_euler.y=rot_y*rot_y_ratio;rot_euler.z=Math.sign(rot_euler.z)*Math.min(Math.abs(rot_euler.z*(rot_para.z?.scale||.5)),Math.PI/3);rot_euler.x*=rot_para.x?.scale||.5;let finger_x=[];let foot_x=0;let _finger_x;if(s[0]._finger_x){if(s[1]._finger_x){_finger_x=s[0]._finger_x.map((f,i)=>f*ratio+s[1]._finger_x[i]*(1-ratio))}else{_finger_x=s[0]._finger_x}}if(_finger_x){for(let i=0;i<5;i++)finger_x[i]=finger_x_filter[d][i].filter(_finger_x[i]);finger_x[0]=(finger_x[0]+finger_x[1])/2;finger_x.forEach(x=>{foot_x+=x});foot_x/=5;rot_euler.x-=foot_x}rot_euler.x=Math.sign(rot_euler.x)*Math.min(Math.abs(rot_euler.x),Math.PI/2);rot.setFromEuler(rot_euler,euler_order);this._rot_=rot.clone();this._rot_y=rot_y;const blend_ratio=this.get_blend_default_motion("skin",d+"",true);if(blend_ratio)rot_y*=1-blend_ratio;const b_leg=MMD_SA.get_bone_position(mesh,d+"",mesh);const rot_leg_parent=MMD_SA.get_bone_rotation_parent(mesh,d+"",mesh).conjugate();const axis=MMD_SA.get_bone_position(mesh,name,mesh).sub(b_leg).negate().normalize().applyQuaternion(rot_leg_parent);const rot_adjust=MMD_SA.TEMP_q.setFromAxisAngle(axis,rot_y*(1-rot_y_ratio));if(0&&mesh.bones_by_name[d+"D"]){mesh.bones_by_name[d+""].quaternion.premultiply(rot_adjust);mesh.bones_by_name[d+"D"].quaternion.premultiply(rot_adjust)}else{model._update_IK_and_AddTrans(false,d+"","",true);if(this.skin[d+""]&&this.skin[d+""][0]._rot_){mesh.bones_by_name[d+""].quaternion.copy(this.skin[d+""][0]._rot_)}else{const axis_upper_leg=MMD_SA.get_bone_position(mesh,d+"",mesh).sub(b_leg).negate().normalize().applyQuaternion(rot_leg_parent);const rot_upper_leg=q1.setFromUnitVectors(v3a.set(0,1,0),axis);mesh.bones_by_name[d+""].quaternion.copy(rot_upper_leg).multiply(q2.setFromEuler(v3a.set(-axis_upper_leg.angleTo(axis),0,0)))}mesh.bones_by_name[d+""].quaternion.premultiply(rot_adjust);model._update_IK_and_AddTrans(false,d+"","")}if(foot_x&&mesh.bones_by_name[d+"EX"]){const name=d+"";const b=!MMD_SA.MMD.motionManager.para_SA.motion_tracking.arm_as_leg.toes_disabled&&(mesh.bones_by_name[name]||mesh.bones_by_name[name+nj_list[1]]);if(!b){let x=0;for(let i=1;i<4;i++){x+=finger_x[i]}x/=4;const z=(finger_x[1]-x)/2;mesh.bones_by_name[d+"EX"].quaternion.setFromEuler(v3a.set(-foot_x*.5,0,z),"XZY")}else{mesh.bones_by_name[d+"EX"].quaternion.setFromEuler(v3a.set(-foot_x*.5,0,0))}model._update_IK_and_AddTrans(false,d+"EX")}if(_finger_x){finger_list.forEach((f,i)=>{const name=d+""+f+"";const b=mesh.bones_by_name[name]||mesh.bones_by_name[name+nj_list[1]];if(b)b.quaternion.multiply(q1.setFromEuler(v3a.set(-finger_x[i]*.5,0,0)))})}}}();var process_hand=function(){let hand_rot_filter={};window.addEventListener("jThree_ready",()=>{for(const d of["",""]){hand_rot_filter[d]=new System._browser.data_filter([{type:"one_euro",id:"hand_rot_filter",para:[30,1,1,1,4]}])}});return function(mesh,name){var model=THREE.MMD.getModels()[mesh._model_index];var is_T_pose=MMD_SA.THREEX.get_model(mesh._model_index).is_T_pose;var bone=mesh.bones_by_name[name];var d=name.charAt(0);var rot_axis,rot,fixedAxis,angle;var _bone=mesh.bones_by_name[d+""];var _rot;var s=this.skin[name];var ratio=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);const motion_para=MMD_SA.motion[model.skin._motion_index].para_SA;rot=q1.set(0,0,0,1);if(_bone){if(_bone.quaternion.x||_bone.quaternion.y||_bone.quaternion.z){_bone.quaternion.conjugate();model._update_IK_and_AddTrans(false,d+"")}_bone.quaternion.set(0,0,0,1)}const sign_LR=d==""?1:-1;var rot_parent=s[0].rot_parent;if(!rot_parent){rot_parent=MMD_SA.get_bone_rotation(mesh,"2",null,mesh);rot_parent.premultiply(q2.copy(this._rot_body_offset).multiply(this._rot_camera).conjugate());rot_parent.multiply(MMD_SA.get_bone_rotation_parent(mesh,d+"","2")).conjugate()}s[0]._rot_parent=rot_parent;const rot_hand=s[0].no_blending?q3.copy(s[0].rot):q3.copy(s[1].rot).slerp(s[0].rot,ratio);if(s[0]._rot_pose&&s[0]._rot_pose_ratio){let _ratio=s[0]._rot_pose_ratio;if(s[0]._rot_pose_ratio_by_angle_difference){let a=MMD_SA.TEMP_q.copy(rot_hand).conjugate().multiply(s[0]._rot_pose).toAxisAngle()[1]%(Math.PI*2);if(a>Math.PI){a-=Math.PI*2}else if(a<-Math.PI){a+=Math.PI*2}const f=Math.pow(1-Math.abs(a)/Math.PI,1-s[0]._rot_pose_ratio_by_angle_difference);_ratio*=f}if(s[0]._rot_pose_constrained){const e_rot_hand=v3a.setEulerFromQuaternion(rot_hand,"YXZ");const e_rot_pose=v3b.setEulerFromQuaternion(s[0]._rot_pose,"YXZ");let y_diff=Math.abs(e_rot_hand.y-e_rot_pose.y);if(y_diff>Math.PI)y_diff=Math.PI*2-y_diff;if(y_diff>Math.PI*2/3&&Math.abs(e_rot_hand.x)<Math.PI/3&&Math.abs(e_rot_hand.z)<Math.PI/3){rot_hand.setFromEuler(MMD_SA.TEMP_v3.copy(e_rot_hand).setY(0),"YXZ").slerp(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(e_rot_pose).setY(0),"YXZ"),_ratio);let y=s[0]._rot_pose_constrained==1?e_rot_pose.y+(e_rot_hand.y>e_rot_pose.y?Math.PI*2:0)-e_rot_hand.y:-(e_rot_hand.y+(e_rot_hand.y<e_rot_pose.y?Math.PI*2:0)-e_rot_pose.y);rot_hand.premultiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,e_rot_hand.y+y*_ratio,0),"YXZ"));_rot_hand=rot_hand}else{rot_hand.slerp(s[0]._rot_pose,_ratio)}}else{rot_hand.slerp(s[0]._rot_pose,_ratio)}}rot.multiply(rot_hand);rot.multiplyQuaternions(rot_parent,rot).multiply(rot_hand_adjust[sign_LR]);rot.fromArray(hand_rot_filter[d].filter(rot.toArray()));bone.quaternion.copy(rot);if(_bone){fixedAxis=_bone.pmxBone.fixedAxis;if(fixedAxis){fixedAxis=MMD_SA._v3a.fromArray(fixedAxis);if(is_T_pose)fixedAxis.setY(0).setZ(0).normalize();const aa=bone.quaternion.toAxisAngle();let rot_axis=v3a.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromAxisAngle(aa[0].applyQuaternion(MMD_SA._q1.copy(rot_arm_adjust[d+""].axis_rot).conjugate()),aa[1]),"XZY").x*-sign_LR;if(rot_axis*sign_LR<-Math.PI/1.5)rot_axis+=Math.PI*2*sign_LR;angle=-rot_axis*.5;_rot=q2.setFromAxisAngle(fixedAxis,angle);this.skin[d+""][0].rot.copy(_rot);bone.quaternion.multiplyQuaternions(_rot.conjugate(),bone.quaternion)}}if(motion_recorder.active){motion_recorder.set_boneKey(name,null,bone.quaternion,true);if(!_poseNet.IK_disabled_check(d+"")){motion_recorder.set_boneKey(d+"",null,mesh.bones_by_name[d+""].quaternion,false);motion_recorder.set_boneKey(d+"",null,mesh.bones_by_name[d+""].quaternion,false)}}}}();function shoulder_adjust(mesh,name){function f(){if(MMD_SA.THREEX.shoulder_adjust=="None")return;const model=THREE.MMD.getModels()[mesh._model_index];const is_T_pose=MMD_SA.THREEX.get_model(mesh._model_index).is_T_pose;const d=name.charAt(0);const motion_para=MMD_SA.motion[model.skin._motion_index].para_SA;let shoulder_weight=frames.skin[d+""]&&(motion_para.motion_tracking_upper_body_only?(1-(motion_para.motion_tracking?.motion_default_weight?.shoulder||0))*(1-frames.get_blend_default_motion("skin",d+"")):1);if(!shoulder_weight)return;const q_arm=mesh.bones_by_name[d+""].quaternion;const arm_rot=!is_T_pose?MMD_SA.TEMP_q.fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(d+"",q_arm.toArray())):MMD_SA.TEMP_q.copy(q_arm);let arm_z=MMD_SA.TEMP_v3.setEulerFromQuaternion(arm_rot,"YZX").z;const arm_sign=d==""?1:-1;arm_z=arm_z*arm_sign+Math.PI/2;if(arm_z>Math.PI/4){const weight=arm_z<Math.PI/2?(arm_z-Math.PI/4)/(Math.PI/4):Math.min(1+(arm_z-Math.PI/2)/(Math.PI/2)*4,1+4);const a=(Math.min(weight,1)*(!MMD_SA.THREEX.shoulder_adjust?12.5*.5:MMD_SA.THREEX.shoulder_adjust=="Full"?12.5:0)+Math.max(weight-1,0)*12.5)*Math.PI/180*shoulder_weight*-arm_sign;const shoulder_offset=MMD_SA.TEMP_q.set(0,0,Math.sin(a/2),Math.cos(a/2));q_arm.premultiply(shoulder_offset);mesh.bones_by_name[d+""].quaternion.multiply(shoulder_offset.conjugate());if(motion_recorder.active){motion_recorder.set_boneKey(d+"",null,mesh.bones_by_name[d+""].quaternion,false);motion_recorder.set_boneKey(d+"",null,q_arm,false)}}}window.addEventListener("SA_MMD_model"+mesh._model_index+"_process_bones_after_IK",f,{once:true})}var fps=0,fps_count=0,fps_ms=0,fps_timestamp=0;var fps_hands=0,fps_count_hands=0,fps_ms_hands=0,fps_timestamp_hands=0;let torso_rot_filter,chest_rot_filter;let shoulder_rot_z_filter;let arm_IK_filter={};let arm_rot_filter={};let hand_depth_filter={};let hand_depth_weight_filter;let rot_pose_ratio_filter={};window.addEventListener("jThree_ready",()=>{torso_rot_filter=new System._browser.data_filter([{type:"one_euro",id:"torso_rot",para:[30,.5,1,1,3]}]);chest_rot_filter=new System._browser.data_filter([{type:"one_euro",id:"chest_rot",para:[30,.5,1,1,3]}]);shoulder_rot_z_filter=new System._browser.data_filter([{type:"one_euro",id:"shoulder_rot_z_filter",para:[30,1,1,1,1]}]);hand_depth_weight_filter=new System._browser.data_filter([{type:"one_euro",id:"hand_depth_weight",para:[30,.5,.1,1,1]}]);for(const d of["",""]){arm_IK_filter[d]=new System._browser.data_filter([{type:"one_euro",id:"arm_IK"+d,para:[30,.5,1/2,1,3]}]);arm_rot_filter[d]=new System._browser.data_filter([{type:"one_euro",id:"arm_IK"+d,para:[30,.5,1/2,1,4]}]);hand_depth_filter[d]=new System._browser.data_filter([{type:"one_euro",id:"hand_depth"+d,para:[30,.5,.1,1,1]}]);rot_pose_ratio_filter[d]=new System._browser.data_filter([{type:"one_euro",id:"rot_pose_ratio"+d,para:[30,.5,.1,1,1]}])}});return function(e){var data=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof data==="string"){if(data=="OK"){_poseNet.worker_initialized=true}else{DEBUG_show(data,2);System._browser.console.log(data)}}else if(_poseNet.enabled){window.dispatchEvent(new CustomEvent("SA_camera_poseNet_update"));camera._needs_RAF=true;_poseNet._bb=null;const warmed_up_status=ML_warmed_up_status[_poseNet.use_holistic?1:0];let on_warmed_up;if(_poseNet.enabled&&!warmed_up_status.poseNet){on_warmed_up=true;warmed_up_status.poseNet=true}if(_handpose.enabled&&!warmed_up_status.handpose){on_warmed_up=true;warmed_up_status.handpose=true}if(on_warmed_up)DEBUG_show("Pose ML ready",2);_info_extra=(_facemesh.enabled?"\n":"")+camera.video_canvas.width+"x"+camera.video_canvas.height+"("+_poseNet.camera_video_frame_id+")\n";let t_now=camera.video_timestamp;let _t=0;if(fps_timestamp){_t=Math.max(Math.min(t_now-fps_timestamp,1e3),10);fps_ms+=_t;if(++fps_count>=20){fps=1e3/(fps_ms/fps_count);fps_count=fps_ms=0}}fps_timestamp=t_now;_poseNet._t=data._t;frames.t_delta=((frames.t_delta||_t)+_t)/2;if(data.handpose){_t=0;if(fps_timestamp_hands){_t=Math.max(Math.min(t_now-fps_timestamp_hands,1e3),10);fps_ms_hands+=_t;if(++fps_count_hands>=20){fps_hands=1e3/(fps_ms_hands/fps_count_hands);fps_count_hands=fps_ms_hands=0}}fps_timestamp_hands=t_now;_poseNet._t_hands=data._t_hands;frames.t_delta_hands=((frames.t_delta_hands||_t)+_t)/2}if(_poseNet.use_holistic){warmed_up_status.facemesh=true;if(!data.facemesh){_facemesh.data_detected=0}}let arms=[];let hands=[];let sign_flip=camera.x_flipped?1:-1;let upper_body_only_mode;const model=THREE.MMD.getModels()[0];const bones_by_name=model.mesh.bones_by_name;const is_T_pose=MMD_SA.THREEX.get_model(0).is_T_pose;const motion_para=MMD_SA.MMD.motionManager.para_SA;const _arm_as_leg=motion_para.motion_tracking&&motion_para.motion_tracking.arm_as_leg;const arm_as_leg={"":_arm_as_leg&&_arm_as_leg.enabled&&(!_arm_as_leg.linked_side||_arm_as_leg.linked_side=="left"),"":_arm_as_leg&&_arm_as_leg.enabled&&(!_arm_as_leg.linked_side||_arm_as_leg.linked_side=="right")};let tilt_adjustment;let _q_tilt_angle,_tilt_angle;let pose;if(_poseNet.enabled){if(data.posenet&&data.posenet.score>.3){_poseNet.data_detected++;_poseNet.initial_data_detected=true;if(_poseNet.data_detected_stable){if(_no_pose_data){_no_pose_data=false;model.mesh.visible=true}tilt_adjustment=motion_para.motion_tracking?.camera?.tilt_adjustment||camera.tilt_adjustment;if(tilt_adjustment.enabled){_tilt_angle=tilt_adjustment.angle*tilt_adjustment.pose_weight*Math.PI/180;_q_tilt_angle=(new THREE.Quaternion).set(Math.sin(_tilt_angle/2),0,0,Math.cos(_tilt_angle/2))}pose=data.posenet;let use_3D_pose=_poseNet.use_3D_pose;if(use_blazepose){pose._keypoints=pose.keypoints;pose._keypoints3D=pose.keypoints3D;let _keypoints=[];let _keypoints3D=[];blazepose_translated.forEach((i,idx)=>{let kp=pose.keypoints[i];kp.part=posenet_part_name[idx];_keypoints.push(kp);kp=pose.keypoints3D[i];kp.part=posenet_part_name[idx];_keypoints3D.push(kp)});pose.keypoints=_keypoints;pose.keypoints3D=_keypoints3D}const score_threshold=use_movenet?.3:!use_human_pose?.5:.1;pose.keypoints.forEach(p=>{p.score-=score_threshold});if(use_3D_pose){pose._keypoints3D.forEach(p=>{p.score-=score_threshold})}if(use_human_pose){let _keypoints_map={};pose.keypoints.forEach(kp=>{_keypoints_map[kp.part]=kp});let _keypoints=[];for(let i=0;i<=16;i++){let kp=pose.keypoints[i];if(!kp)_keypoints.push(posenet_part_dummy[i]);else if(kp.part!=posenet_part_name[i])_keypoints.push(_keypoints_map[posenet_part_name[i]]||posenet_part_dummy[i]);else _keypoints.push(kp)}pose.keypoints=_keypoints}let kp_bb=pose._keypoints||pose.keypoints;let kp_x=kp_bb.map(p=>p.position.x);let kp_y=kp_bb.map(p=>p.position.y);const bb_body=[Math.min(...kp_y),Math.max(...kp_x),Math.max(...kp_y),Math.min(...kp_x)];kp_bb=pose.keypoints.slice(0,5);kp_x=kp_bb.map(p=>p.position.x);kp_y=kp_bb.map(p=>p.position.y);const bb_head=[Math.min(...kp_y),Math.max(...kp_x),Math.max(...kp_y),Math.min(...kp_x)];const dim_head=Math.max(bb_head[1]-bb_head[3],bb_head[2]-bb_head[0])/2;bb_body[0]=Math.min(bb_body[0],bb_head[0]-dim_head);bb_body[1]=Math.max(bb_body[1],bb_head[1]+dim_head);bb_body[2]=Math.max(bb_body[2],bb_head[2]-dim_head);bb_body[3]=Math.min(bb_body[3],bb_head[3]-dim_head);_poseNet._bb=bb_body;if(!_facemesh.head_pose_enabled){_facemesh.bb_center[0]=pose.keypoints[0].position.x/camera.video_canvas.width;_facemesh.bb_center[1]=pose.keypoints[0].position.y/camera.video_canvas.height}if(use_3D_pose){let _nose=pose._keypoints[0].position;let _eyeL=pose._keypoints[3].position;let _eyeR=pose._keypoints[6].position;const a=v3a.copy(_eyeR);const m=v3b.copy(_eyeL);m.sub(a);const p=MMD_SA._v3a_.copy(_nose);const t=(p.x*m.x+p.y*m.y+p.z*m.z-(a.x*m.x+a.y*m.y+a.z*m.z))/m.lengthSq();const q=MMD_SA._v3b.set(a.x+m.x*t,a.y+m.y*t,a.z+m.z*t);let y_axis=p.sub(q).normalize();let x_axis=MMD_SA._v3b_.copy(_eyeL).sub(MMD_SA._v3b.copy(_eyeR));x_axis.normalize();let z_axis=MMD_SA.TEMP_v3.crossVectors(x_axis,y_axis).normalize();x_axis.crossVectors(y_axis,z_axis);rot_m4.set(x_axis.x,x_axis.y,x_axis.z,0,y_axis.x,y_axis.y,y_axis.z,0,z_axis.x,z_axis.y,z_axis.z,0,0,0,0,1);q_m4.setFromBasis(rot_m4);let rot=q_m4.conjugate();rot=rot.clone().multiply(MMD_SA.TEMP_q.set(Math.sin(Math.PI/3.5/2),0,0,Math.cos(Math.PI/3.5/2)));_facemesh._neck.shoulder_center=v3b.copy(pose._keypoints[11].position).add(MMD_SA.TEMP_v3.copy(pose._keypoints[12].position)).multiplyScalar(.5).toArray();if(_q_tilt_angle)rot.premultiply(_q_tilt_angle);if(!_facemesh.head_pose_enabled){frames.add("skin","",{after_IK:true,rot:rot,onProcessRotation:process_head_rotation});frames.skin[""][1]._rot_mixed&&frames.skin[""][1].rot.copy(frames.skin[""][1]._rot_mixed)}frames.add("skin","_DUMMY_",{rot:rot,_rot_from_pose:rot.clone(),onProcessRotation:process_head_rotation})}let armL=pose.keypoints[5];let armR=pose.keypoints[6];let rot_center=new THREE.Quaternion;upper_body_only_mode=motion_para.motion_tracking_upper_body_only;_info_extra+="\n"+(upper_body_only_mode?(motion_para.motion_tracking?.arm_as_leg?.enabled?"":"")+"upper body":"full body");const hand_camera=MMD_SA_options.Dungeon_options?.item_base.hand_camera;if(hand_camera&&hand_camera._hand_camera_side){_info_extra+="/"+(hand_camera.selfie_mode?"selfie":"handcam")+(hand_camera._hand_camera_side==""?"-L":"-R")}_info_extra+="\n";if(use_3D_pose&&camera_depth_scale)camera_depth.prepare(pose);let hip_z=0,hip_x=0;if(_handpose.enabled&&data.handpose)_handpose.hand_visible_timestamp={};shoulder_z_angle[0]=shoulder_z_angle[1]=0;let body_rot_parent;if(armL.score>0&&armR.score>0){let armL3D,armR3D;let rot_torso,rot_chest;if(use_3D_pose){armL3D=pose.keypoints3D[5];armR3D=pose.keypoints3D[6];let hipL3D=pose.keypoints3D[11];let hipR3D=pose.keypoints3D[12];let rot_center_euler;if(upper_body_only_mode||hipL3D.score<=0||hipR3D.score<=0){upper_body_only_mode=true}else{if(pose.keypoints[11].position.y>camera.video_canvas.height||pose.keypoints[12].position.y>camera.video_canvas.height){upper_body_only_mode=true}let hip=MMD_SA._v3b.copy(hipL3D).sub(hipR3D).normalize();let x_axis=MMD_SA.TEMP_v3.set(1,0,0);rot_center_euler=v3c.setFromVectorSpherical(x_axis,hip);hip_z=rot_center_euler.z;if(1||upper_body_only_mode)rot_center_euler.z=0;rot_center.setFromEuler(rot_center_euler,"YZX")}let y_axis=MMD_SA.TEMP_v3.set(0,1,0);y_axis.y*=-1;let spine=MMD_SA._v3a.addVectors(armL3D,armR3D).multiplyScalar(.5);if(spine.z<0){spine.normalize();if(_poseNet.body_bend_reduction_power==1){spine.z=0}else{spine_yz=MMD_SA._v3b.set(0,spine.y,spine.z).normalize();spine.z*=Math.pow(-spine_yz.z,Math.pow(1.6,(_poseNet.body_bend_reduction_power||0)/.25))/-spine_yz.z}}spine.normalize();_facemesh.calculate_neck_data({is_pose:true,timestamp:_poseNet.camera_video_frame_id,shoulder_center:_facemesh._neck.shoulder_center,spine_rot_absolute:v3b.setFromVectorSpherical(y_axis,spine).toArray()});spine.applyQuaternion(MMD_SA.TEMP_q.copy(rot_center).conjugate());const rot_torso_euler=v3b.setFromVectorSpherical(y_axis,spine);if(motion_para.motion_tracking_upper_body_only){rot_torso_euler.fromArray(torso_rot_filter.filter(rot_torso_euler.toArray()));rot_torso=(new THREE.Quaternion).setFromEuler(rot_torso_euler,"XZY")}else{if(upper_body_only_mode){if(rot_center_euler){rot_torso_euler.add(rot_center_euler)}rot_center.set(0,0,0,1);rot_torso_euler.fromArray(torso_rot_filter.filter(rot_torso_euler.toArray()));rot_torso=(new THREE.Quaternion).setFromEuler(rot_torso_euler,"YXZ")}else{rot_torso=(new THREE.Quaternion).setFromEuler(rot_torso_euler,"XZY")}}hip_x=rot_torso_euler.x;let shoulder=MMD_SA._v3b.copy(armL3D).sub(armR3D).normalize();shoulder.applyQuaternion(MMD_SA.TEMP_q.multiplyQuaternions(rot_center,rot_torso).conjugate());x_axis=MMD_SA.TEMP_v3.set(1,0,0);let rot_chest_euler=v3b.setFromVectorSpherical(x_axis,shoulder);let sf=_poseNet.shoulder_tracking?.5:0;let sz=shoulder_rot_z_filter.filter(rot_chest_euler.z*(MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?3:5))*sf;let _sf=Math.min(Math.PI/12/Math.abs(sz),1);sz*=_sf;if(upper_body_only_mode){rot_chest_euler.fromArray(chest_rot_filter.filter(rot_chest_euler.toArray()))}shoulder_z_angle[0]=sz;shoulder_z_angle[1]=sz;rot_chest_euler.z*=1-sf;rot_chest=(new THREE.Quaternion).setFromEuler(rot_chest_euler,"YZX");let y_angle_torso=0;let y_angle_chest=rot_chest_euler.y;let y_angle=(y_angle_torso+y_angle_chest)%(Math.PI*2);if(y_angle>Math.PI)y_angle=Math.PI*2-y_angle;else if(y_angle<0&&y_angle<-Math.PI)y_angle+=Math.PI*2;rot_torso.multiply(q1.set(0,Math.sin((y_angle/2-y_angle_torso)/2),0,Math.cos((y_angle/2-y_angle_torso)/2)));rot_chest.multiply(q1.set(0,Math.sin((y_angle/2-y_angle_chest)/2),0,Math.cos((y_angle/2-y_angle_chest)/2)));frames.add("skin","",{rot:rot_center.clone(),priority:9});if(motion_recorder.active){if(!frames.skin[""][0].pos&&frames.skin[""][1].pos)frames.skin[""][0].pos=frames.skin[""][1].pos}const _rot_torso=rot_torso.clone();if(_q_tilt_angle){const _q=q1.copy(_q_tilt_angle);const _pose=motion_para.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(_pose.upper_rotation_offset){const y=-(_pose.upper_rotation_offset-y_angle)*2/3*Math.PI/180;const aa=_q_tilt_angle.toAxisAngle();_q.setFromAxisAngle(aa[0].applyQuaternion(MMD_SA.TEMP_q.set(0,Math.sin(y/2),0,Math.cos(y/2))),aa[1])}q1.premultiply(MMD_SA.TEMP_q.copy(rot_center).conjugate()).multiply(rot_center);_rot_torso.premultiply(_q)}frames.add("skin","",{rot:_rot_torso});frames.add("skin","2",{rot:rot_chest.clone()});body_rot_parent=q1.copy(rot_center).multiply(rot_torso).multiply(rot_chest);body_rot_parent.conjugate()}const shoulder_width_scale=MMD_SA.TEMP_v3.set(1,1,1/3);_poseNet.shoulder_width=v3a.copy(armL.position).multiply(shoulder_width_scale).distanceTo(v3b.copy(armR.position).multiply(shoulder_width_scale));let shoulder_width=Math.sqrt(Math.pow(armL.position.x-armR.position.x,2)+Math.pow(armL.position.y-armR.position.y,2));let a_shoulder=0;if(!use_3D_pose){a_shoulder=Math.asin((armL.position.y-armR.position.y)/shoulder_width);a_shoulder=Math.max(Math.min(a_shoulder/(Math.PI/4),1),-1)*Math.PI/4*sign_flip}let LR=sign_flip==1?[1,0]:[0,1];shoulder_width=_facemesh.face_width*2||shoulder_width;_poseNet._upper_body_only_mode=upper_body_only_mode;const arm_z_angle=[0,0];const q_shoulder=[];LR.forEach(function(dir,idx){let x,y,z;let z_posenet;let d=idx==0?"":"";let arm=pose.keypoints[5+dir];let elbow=pose.keypoints[7+dir];let hand=pose.keypoints[9+dir];let IK_disabled=(motion_para.motion_tracking?.arm_tracking?.use_IK!=null?!motion_para.motion_tracking.arm_tracking.use_IK:MMD_SA_options.user_camera.ML_models.pose.use_armIK==null?!upper_body_only_mode&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=d:!MMD_SA_options.user_camera.ML_models.pose.use_armIK)&&!arm_as_leg[d];let IK_absolute=false;let hand_visible=hand.score>0&&hand.position.x>=0&&hand.position.x<=camera.video_canvas.width&&hand.position.y>=0&&hand.position.y<=camera.video_canvas.height;if(motion_para.motion_tracking_upper_body_only&&!hand_visible){IK_disabled=false}q_shoulder[idx]=new THREE.Quaternion;if(is_T_pose)q_shoulder[idx].fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(d+"",q_shoulder[idx].toArray()));let arm3D,elbow3D,hand3D;if(use_3D_pose){arm3D=pose.keypoints3D[5+dir];elbow3D=pose.keypoints3D[7+dir];hand3D=pose.keypoints3D[9+dir]}let x_dir=sign_flip*(dir==0?-1:1);if(use_3D_pose&&hand.score>0&&_handpose.enabled&&_handpose.stabilize_hand_percent&&_poseNet.shoulder_width){const w=camera.video_canvas.width;const h=camera.video_canvas.height;const hand_last=_handpose._hand_last[d];let _hand;if(data.handpose&&data.handpose.length){const handpose=data.handpose.find(h=>h.label==(d==""?"Left":"Right"));if(handpose){_hand=hand_last.hand=handpose.annotations.palm[0];hand_last.timestamp=RAF_timestamp;hand_last.w=w;hand_last.h=h}}if(!_hand){_hand=hand_last.hand}const time_limit=1e3*(_handpose.stabilize_hand_percent/100)*(upper_body_only_mode||!IK_disabled?1:.5);let time_diff=RAF_timestamp-hand_last.timestamp;if(_hand&&hand_last.w==w&&hand_last.h==h&&time_diff<time_limit){const armL3D=pose.keypoints3D[5];const armR3D=pose.keypoints3D[6];const arm_length=_poseNet.shoulder_width*1.5/v3a.copy(armL3D).distanceTo(armR3D);const hand_offset=MMD_SA.TEMP_v3.fromArray(_hand).sub(hand.position).multiplyScalar(1/arm_length);let ratio=1;const shoulder_scale=Math.max(w,h)/_poseNet.shoulder_width;const depth_factor=1-Math.min(Math.max(shoulder_scale-5,0)/5,1);time_diff/=.5+(1-.5)*depth_factor;ratio*=1-Math.min(time_diff/time_limit,1);hand3D.x+=hand_offset.x*ratio;hand3D.y+=hand_offset.y*ratio}else{hand_last.timestamp=0}}let v_arm_upper,axis,rot_arm_upper;const euler_order="YZX";if(use_3D_pose&&elbow.score>0){v_arm_upper=MMD_SA._v3b.copy(arm3D).sub(elbow3D).normalize().applyQuaternion(body_rot_parent);axis=MMD_SA.TEMP_v3.set(x_dir,0,0);rot_arm_upper=(new THREE.Quaternion).setFromUnitVectors(axis,v_arm_upper);arm_z_angle[idx]=v3b.setFromVectorSpherical(axis,v_arm_upper).z}let arm_IK_f=arm_IK_filter[d].filters[0].filter;if(hand.score>0){let handpose_worker;if(upper_body_only_mode&&_handpose.enabled&&_handpose.use_hands_worker&&!data.handpose){if(_handpose.hand_visible_timestamp[d]+200>RAF_timestamp)hand_visible=handpose_worker=true}let handpose,palm_offset;if(_handpose.enabled&&data.handpose){handpose=data.handpose.find(h=>h.label==(d==""?"Left":"Right"));if(handpose){hand_visible=true}}if(handpose){_handpose.hand_visible_timestamp[d]=RAF_timestamp;if(!upper_body_only_mode)_handpose.hand_visible_session[d]=RAF_timestamp}if(_handpose.enabled&&upper_body_only_mode){let adjust_filter;let reset_hand;let hand_visible_session=_handpose.hand_visible_session[d]||0;if(handpose||handpose_worker){if(hand_visible_session<1e3){_handpose.hand_visible_session[d]=1e3;if(!_handpose.stabilize_arm_time){adjust_filter=true}else{reset_hand=true}}else if(hand_visible_session<1200){_handpose.hand_visible_session[d]+=_poseNet._t_hands;if(_handpose.hand_visible_session[d]>1e3+_handpose.stabilize_arm_time){adjust_filter=true}else{reset_hand=true}}else{_handpose.hand_visible_session[d]=RAF_timestamp}}else{_handpose.hand_visible_timestamp[d]=0;let fade_out=!hand_visible;if(hand_visible&&hand_visible_session<1e3+_handpose.stabilize_arm_time){if(hand_visible_session>=1e3)hand_visible_session=_handpose.hand_visible_session[d]=201;fade_out=true;reset_hand=true}if(fade_out){adjust_filter=hand_visible;if(!hand_visible_session){_handpose.hand_visible_session[d]=0;reset_hand=true}else if(hand_visible_session>200){_handpose.hand_visible_session[d]=200}else{_handpose.hand_visible_session[d]-=_poseNet._t_hands;if(_handpose.hand_visible_session[d]<0)_handpose.hand_visible_session[d]=0}}}if(adjust_filter){arm_IK_f.beta=1/10;arm_IK_f=null}if((motion_para.motion_tracking?.hand_tracking?.stabilize_arm_disabled?0:_handpose.stabilize_arm)>(motion_para.motion_tracking_upper_body_only?0:1)){if(reset_hand){hand_visible=false;handpose=null;hand.score=0;if(frames.skin[d+""]?.[0].rot.w!=1){const q0=new THREE.Quaternion;frames.add("skin",d+"",{absolute:true,no_blending:true,rot:q0});frames.add("skin",d+"",{after_IK:true,absolute:true,no_blending:true,rot:q0});frames.add("skin",d+"",{after_IK:true,absolute:true,no_blending:true,rot:q0})}}}}hands.push({pos:hand.position,dir:dir,d:d,visible:hand_visible,handpose:handpose,palm_offset:palm_offset})}else{_handpose.hand_visible_session[d]=0}let data_filter_weight=0;const data_filter=motion_para.motion_tracking?.arm_tracking?.data_filter?.[d==""?"left":"right"];if(data_filter){data_filter_weight=1;if(data_filter.weight_by_magnet){const magnet=motion_para.motion_tracking.arm_tracking?.transformation?.position?.magnet?.find(m=>m.magnet_id==data_filter.weight_by_magnet.id);data_filter_weight=magnet&&magnet._frame_count_>=EV_sync_update.count_frame-1-(_handpose.use_hands_worker?6:0)?magnet._weight_:0}}if(arm_IK_f){arm_IK_f.beta=.5*(1-data_filter_weight)+(data_filter?.beta||.5)*data_filter_weight}if(hand.score>0){if(use_3D_pose){let rot_arm_lower;if(elbow.score>0){let v_arm_lower=v3a.copy(elbow3D).sub(hand3D).normalize().applyQuaternion(body_rot_parent).applyQuaternion(MMD_SA.TEMP_q.copy(rot_arm_upper).conjugate());axis=MMD_SA.TEMP_v3.set(x_dir,0,0);rot_arm_lower=(new THREE.Quaternion).setFromUnitVectors(axis,v_arm_lower)}if(!IK_disabled||elbow.score<=0){IK_disabled=false;let v_arm=MMD_SA._v3a.copy(arm3D).sub(hand3D);if(_q_tilt_angle)v_arm.applyQuaternion(_q_tilt_angle);let arm_length=elbow.score>0?MMD_SA.TEMP_v3.copy(arm3D).distanceTo(elbow3D)+MMD_SA.TEMP_v3.copy(elbow3D).distanceTo(hand3D):.5;let v_arm_length=Math.min(v_arm.length()/arm_length,1);v_arm.normalize().multiplyScalar(v_arm_length*MMD_SA_options.model_para_obj.left_arm_length);x=v_arm.x;y=v_arm.y;z=z_posenet=v_arm.z;if(rot_arm_upper){let rot_hand_parent;if(arm_as_leg[d]){rot_hand_parent=body_rot_parent.clone().conjugate().multiply(rot_arm_upper).multiply(rot_arm_lower).conjugate()}rotate_arm(rot_arm_upper,d+"");if(upper_body_only_mode)rot_arm_upper.fromArray(arm_rot_filter[d].filter(rot_arm_upper.toArray()));frames.add("skin",d+"",{absolute:true,rot:rot_arm_upper,_rot_hand_parent:rot_hand_parent,onFinish:process_arm_from_shoulder});if(rot_arm_lower){rotate_arm(rot_arm_lower,d+"");frames.add("skin",d+"",{absolute:true,rot:rot_arm_lower})}}}else{rotate_arm(rot_arm_lower,d+"");rotate_arm(rot_arm_upper,d+"");frames.add("skin",d+"",{absolute:true,rot:rot_arm_upper,priority:-1,onFinish:process_arm});frames.add("skin",d+"",{absolute:true,rot:rot_arm_lower})}}else{IK_absolute=true;let x_diff=arm.position.x-hand.position.x;let y_diff=arm.position.y-hand.position.y;x=x_diff/shoulder_width*MMD_SA_options.model_para_obj.shoulder_width*sign_flip;y=y_diff/shoulder_width*MMD_SA_options.model_para_obj.shoulder_width;if(elbow.score>0){let arm_upper_length=Math.min(Math.sqrt(Math.pow(hand.position.x-elbow.position.x,2)+Math.pow(hand.position.y-elbow.position.y,2))/shoulder_width,1);let arm_lower_length=Math.min(Math.sqrt(Math.pow(arm.position.x-elbow.position.x,2)+Math.pow(arm.position.y-elbow.position.y,2))/shoulder_width,1);z_posenet=(.25+(Math.sin(Math.acos(arm_upper_length))+Math.sin(Math.acos(arm_lower_length)))/2*.75)*MMD_SA_options.model_para_obj.left_arm_length}}}else{if(arm_as_leg[d]){frames.add("skin",d+"",{rot:new THREE.Quaternion});frames.remove("skin",d+"")}if(elbow.score>0){if(use_3D_pose){if(!IK_disabled){IK_disabled=false;v_arm_upper=MMD_SA._v3a.copy(arm3D).sub(elbow3D).normalize();v_arm_upper.multiplyScalar(MMD_SA_options.model_para_obj.left_arm_length);x=v_arm_upper.x*sign_flip;y=v_arm_upper.y;z=z_posenet=v_arm_upper.z}else{IK_disabled=true;rotate_arm(rot_arm_upper,d+"");frames.add("skin",d+"",{absolute:true,rot:rot_arm_upper,priority:-1,onFinish:process_arm})}}else{IK_disabled=false;IK_absolute=true;let x_diff=arm.position.x-elbow.position.x;let y_diff=arm.position.y-elbow.position.y;let dis=Math.sqrt(x_diff*x_diff+y_diff*y_diff);let a=Math.asin(x_diff/dis);x=Math.sin(a)*MMD_SA_options.model_para_obj.left_arm_length*sign_flip;y=Math.cos(a)*MMD_SA_options.model_para_obj.left_arm_length*Math.sign(y_diff)}}else{if(use_3D_pose){if(!motion_para.motion_tracking_upper_body_only)return;z=z_posenet=0}else{IK_absolute=true}if(x==null){IK_disabled=false;x=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*(d==""?1:-1)*.2;y=-Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-x*x)}}}if(!IK_disabled&&(motion_para.motion_tracking?.arm_tracking?.use_IK||upper_body_only_mode)&&!data_filter?.disabled){let arm_IK_f=arm_IK_filter[d].filters[0].filter;arm_IK_f.minCutOff=.5*(1-data_filter_weight)+(data_filter?.minCutOff||.5)*data_filter_weight;const xyz=arm_IK_filter[d].filter([x,y,z]);x=xyz[0];y=xyz[1];z=xyz[2]}arms.push({pos:{x:x,y:y,z:z,z_posenet:z_posenet},dir:dir,d:d,IK_disabled:IK_disabled,IK_absolute:IK_absolute})});arm_z_angle[0]=arm_z_angle[0]==null?0:Math.max(arm_z_angle[0]+Math.PI/2,0);arm_z_angle[1]=arm_z_angle[1]==null?0:Math.max(Math.PI/2-arm_z_angle[1],0);const idx_to_adjust=arm_z_angle[0]>arm_z_angle[1]?1:0;const scale_to_adjust=Math.min(Math.abs(arm_z_angle[0]-arm_z_angle[1])/(Math.PI/2),1);arm_z_angle[idx_to_adjust==0?1:0]=1;arm_z_angle[idx_to_adjust]=1-scale_to_adjust*scale_to_adjust*.5;LR.forEach(function(dir,idx){let d=idx==0?"":"";if(q_shoulder[idx]){shoulder_z_angle[idx]*=arm_z_angle[idx];let _rot_shrug=shoulder_z_angle[2]*(idx==0?1:-1);let a=shoulder_z_angle[idx]+_rot_shrug;const a_limit=Math.PI/6;if(Math.abs(a)>a_limit){_rot_shrug=Math.sign(_rot_shrug)*(a_limit-Math.abs(shoulder_z_angle[idx]));a=shoulder_z_angle[idx]+_rot_shrug}a=shoulder_rot_filter[d].filter(a);q_shoulder[idx].multiply(MMD_SA.TEMP_q.set(0,0,Math.sin(a/2),Math.cos(a/2)));frames.add("skin",d+"",{priority:-2,absolute:!(motion_para.motion_tracking_upper_body_only&&motion_para.motion_tracking?.motion_default_weight?.shoulder),rot:q_shoulder[idx],_rot_z:shoulder_z_angle[idx],_rot_shrug:_rot_shrug,_rot_total:a,onFinish:shoulder_adjust})}})}else{upper_body_only_mode=true}if(use_3D_pose&&!upper_body_only_mode){const _hip_z=hip_z;if(_q_tilt_angle){rot_center.premultiply(MMD_SA.TEMP_q.copy(_q_tilt_angle).conjugate());hip_z=_hip_z-MMD_SA.TEMP_v3.setEulerFromQuaternion(rot_center,"YZX").z}camera_depth.get_hip_center(pose);let LR=sign_flip==1?[1,0]:[0,1];let legs=[];let feet=[];let hip_angle=0;let leg_offset=[];LR.forEach(function(dir,idx){let d=idx==0?"":"";let hip=pose.keypoints3D[11+dir];let knee=pose.keypoints3D[13+dir];let ankle=pose.keypoints3D[15+dir];let v_leg,v_leg_length,leg_length;if(ankle.score>0){v_leg=MMD_SA._v3a.copy(hip).sub(ankle);v_leg_length=v_leg.length();leg_length=knee.score>0?MMD_SA.TEMP_v3.copy(hip).distanceTo(knee)+MMD_SA.TEMP_v3.copy(knee).distanceTo(ankle):.7;v_leg.normalize().multiplyScalar(Math.min(v_leg_length/leg_length,1)*MMD_SA_options.model_para_obj.left_leg_length)}if(_poseNet.leg_scale_adjustment&&ankle.score>0){let leg_scale=1;let pq_scale=1;let leg_scale2,pq_scale2,over_limit;let pq_length,hip_to_knee,hip_to_q;const a=v3c.copy(hip);const m=v3d.copy(ankle).sub(a);let q,pq;if(knee.score>0){const p=v3b.copy(knee);const t=(p.x*m.x+p.y*m.y+p.z*m.z-(a.x*m.x+a.y*m.y+a.z*m.z))/m.lengthSq();q=v3a.set(a.x+m.x*t,a.y+m.y*t,a.z+m.z*t);pq=p.sub(q);hip_to_knee=v3c.copy(hip).sub(knee).length();hip_to_q=v3c.copy(hip).sub(q).length();pq_length=pq.length()}else{hip_to_knee=leg_length/2;hip_to_q=Math.min(m.length()/2,hip_to_knee);pq_length=Math.sqrt(hip_to_knee*hip_to_knee-hip_to_q*hip_to_q)}const pq_ratio=pq_length/leg_length;const w=camera.video_canvas.width;const h=camera.video_canvas.height;const v3_screen=MMD_SA.TEMP_v3;const v_hip=camera_depth.v_hip;const hip2D=pose.keypoints[11+dir];const ankle2D=pose.keypoints[15+dir];const leg_length_ref=MMD_SA_options.model_para_obj.left_leg_length;const ar=w/h;const ar_3D=SL.width/SL.height;const w_ar=ar<ar_3D?ar/ar_3D:1;const h_ar=ar_3D<ar?ar_3D/ar:1;v3_screen.set((hip2D.position.x/w*2-1)*w_ar,(-(hip2D.position.y/h)*2+1)*h_ar,.5);const hip_p=MMD_SA._v3a_.copy(v3_screen.unproject(camera._camera_reset).sub(camera._camera_reset.position).normalize());hip_p.multiplyScalar((v_hip.z-hip.z/leg_length*leg_length_ref)/hip_p.z);v3_screen.set((ankle2D.position.x/w*2-1)*w_ar,(-(ankle2D.position.y/h)*2+1)*h_ar,.5);const ankle_p=MMD_SA._v3b_.copy(v3_screen.unproject(camera._camera_reset).sub(camera._camera_reset.position).normalize());ankle_p.multiplyScalar((v_hip.z-ankle.z/leg_length*leg_length_ref)/ankle_p.z);v_leg_length=v_leg.length();leg_scale=Math.min(hip_p.distanceTo(ankle_p),leg_length_ref)/v_leg_length;if(knee.score>0){pq_scale=Math.sqrt((hip_to_knee*hip_to_knee-leg_scale*leg_scale*hip_to_q*hip_to_q)/(pq_length*pq_length))||0;if(pq_scale){}else{pq_scale2=0;over_limit=true;leg_scale2=hip_to_knee/hip_to_q}if(pq_scale2!=null){_info_extra+="\n"+d+":"+leg_scale2+"(x"+pq_scale2+")"+(over_limit?"<>":"")+"\n";leg_scale=leg_scale2;pq_scale=pq_scale2}else _info_extra+="\n"+d+":"+leg_scale+"(x"+pq_scale+")\n";if(leg_scale!=1){const ankle_offset=v3c.copy(hip).add(m.multiplyScalar(leg_scale)).sub(ankle);for(const index of[27,29,31]){const p=pose._keypoints3D[index+dir];Object.assign(p,MMD_SA.TEMP_v3.copy(p).add(ankle_offset))}ankle=pose.keypoints3D[15+dir];const knee2=q.sub(hip).multiplyScalar(leg_scale).add(hip).add(pq.multiplyScalar(pq_scale));knee=pose.keypoints3D[13+dir]=Object.assign(knee,knee2);v_leg.multiplyScalar(leg_scale)}}else{v_leg.multiplyScalar(leg_scale);_info_extra+="\n"+d+"(IK):"+leg_scale+"(x"+pq_scale+")\n"}}let rot_leg_upper,rot_leg_upper_euler;let v_leg_upper;if(knee.score>0){v_leg_upper=MMD_SA._v3b.copy(hip).sub(knee).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(rot_center).conjugate());let y_axis=MMD_SA.TEMP_v3.set(0,1,0);y_axis.y*=-1;rot_leg_upper_euler=v3b.setFromVectorSpherical(y_axis,v_leg_upper);rot_leg_upper=(new THREE.Quaternion).setFromEuler(rot_leg_upper_euler,"XZY");const a=v3a.setFromVectorSpherical(y_axis,MMD_SA._v3b.copy(hip).sub(knee).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(rot_center).multiply(MMD_SA._q2.set(0,0,Math.sin(_hip_z/2),Math.cos(_hip_z/2))).multiply(MMD_SA._q1.set(Math.sin(hip_x/2),0,0,Math.cos(hip_x/2))).conjugate()));hip_angle+=a.x}let IK_disabled=!MMD_SA_options.user_camera.ML_models.pose.use_legIK;if(ankle.score>0){let v_leg_lower_,v_leg_lower;if(knee.score>0){v_leg_lower_=v3a.copy(knee).sub(ankle).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(rot_center).conjugate());v_leg_lower=v3c.copy(v_leg_lower_).applyQuaternion(MMD_SA.TEMP_q.copy(rot_leg_upper).conjugate());v_leg_lower.z=Math.max(-v_leg_lower.z,0);v_leg_lower.x*=-1;let sc=v_leg_lower.normalize().toSphericalCoords();let rot_y_ratio=Math.sqrt(Math.min((Math.PI-sc[2])/(Math.PI/2),1));rot_leg_upper_euler.y=sc[1]*rot_y_ratio;rot_leg_upper.setFromEuler(rot_leg_upper_euler,"XZY")}if(!IK_disabled||knee.score<=0){_poseNet.enable_IK(d+"",true);legs.push({pos:v_leg.clone(),rot:[rot_leg_upper],dir:dir,d:d})}else{v_leg_lower=v3c.copy(v_leg_lower_).applyQuaternion(MMD_SA.TEMP_q.copy(rot_leg_upper).conjugate());let y_axis=MMD_SA.TEMP_v3.set(0,1,0);y_axis.y*=-1;let rot_leg_lower=(new THREE.Quaternion).setFromVectorSpherical(y_axis,v_leg_lower);_poseNet.enable_IK(d+"",false);legs.push({rot:[rot_leg_upper,rot_leg_lower],dir:dir,d:d})}const heel=pose._keypoints3D[29+dir];const foot=pose._keypoints3D[31+dir];if(heel.score>0&&foot.score>0){let y_axis=MMD_SA._v3a_.copy(heel).sub(ankle).normalize();let z_axis=MMD_SA._v3b_.copy(heel).sub(foot).normalize();let x_axis=v3a.crossVectors(y_axis,z_axis).normalize();y_axis.crossVectors(z_axis,x_axis);rot_m4.set(x_axis.x,x_axis.y,x_axis.z,0,y_axis.x,y_axis.y,y_axis.z,0,z_axis.x,z_axis.y,z_axis.z,0,0,0,0,1);q_m4.setFromBasis(rot_m4);let rot=q_m4.conjugate();const foot_angle_x=-Math.PI/(MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?10:8);rot=rot.clone().multiply(MMD_SA.TEMP_q.set(Math.sin(foot_angle_x/2),0,0,Math.cos(foot_angle_x/2)));if(_q_tilt_angle)rot.premultiply(_q_tilt_angle);const _rot_center=q1.copy(rot_center);if(_q_tilt_angle)_rot_center.premultiply(_q_tilt_angle);const rot_center_YZX=MMD_SA.TEMP_v3.setEulerFromQuaternion(_rot_center,"YZX");const rot_center_y=Math.abs(rot_center_YZX.y)%Math.PI;let ratio=rot_center_y>Math.PI/2?1-(rot_center_y-Math.PI/2)/(Math.PI/2):1;if(MMD_SA_options.user_camera.ML_models.pose.use_legIK){const rot_IK=rot.clone();if(ratio<1){rot_center_YZX.x=rot_center_YZX.z=0;rot_IK.slerp(q2.setFromEuler(rot_center_YZX,"YZX"),1-ratio)}legs[legs.length-1].rot[2]=rot_IK}frames.add("skin",d+"",{after_IK:true,absolute:true,parent_based:true,motion_recorder_disabled:MMD_SA_options.user_camera.ML_models.pose.use_legIK,rot:rot,ratio:ratio,ratio_euler:MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?{x:1,y:1,z:.5,order:"YXZ"}:null})}}else{if(knee.score>0){if(!IK_disabled){v_leg=MMD_SA._v3a.copy(hip).sub(knee).normalize().multiplyScalar(MMD_SA_options.model_para_obj.left_leg_length);if(_q_tilt_angle)v_leg.applyQuaternion(_q_tilt_angle);_poseNet.enable_IK(d+"",true);legs.push({pos:v_leg.clone(),rot:[rot_leg_upper],dir:dir,d:d})}else{_poseNet.enable_IK(d+"",false);legs.push({rot:[rot_leg_upper],dir:dir,d:d})}}if(frames.skin[d+""]?.[0].rot.w!=1)frames.add("skin",d+"",{after_IK:true,absolute:true,no_blending:true,rot:new THREE.Quaternion})}});let leg_offset_y=0;leg_offset.forEach(offset=>{const y=offset.y*(1-offset.scale);if(y>0){leg_offset_y=Math.max(y,leg_offset_y)}else if(leg_offset.length>1){leg_offset_y=Math.max(y,leg_offset_y||y)}});if(leg_offset_y){camera_depth.v_hip.y+=leg_offset_y;_info_extra+="\nleg_offset_y:"+leg_offset_y+"\n"}hip_angle*=.5*.5;hip_angle+=hip_x;let rot_hip=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(hip_angle,0,hip_z),"YZX");frames.add("skin","",{absolute:true,rot:rot_hip.clone()});if(!upper_body_only_mode){frames.add("skin","",{pos:new THREE.Vector3,after_IK:true,priority:999,onProcessPosition:adjust_hip_center})}rot_hip.conjugate();legs.forEach(leg=>{var d=leg.d;if(leg.rot[0]){leg.rot[0].multiplyQuaternions(rot_hip,leg.rot[0]);frames.add("skin",d+"",{absolute:true,rot:leg.rot[0]})}if(leg.pos){leg.pos.add(MMD_SA_options.model_para_obj.leg_IK_offset[d]);const rot=leg.rot[2]||frames.skin[d+""]&&frames.skin[d+""][0].rot;frames.add("skin",d+"",{absolute:true,pos:leg.pos,rot:rot,priority:999,onFinish:adjust_leg_IK})}else{if(leg.rot[1]){frames.add("skin",d+"",{absolute:true,rot:leg.rot[1]})}else if(frames.skin[d+""]?.[0].rot.w!=1){frames.add("skin",d+"",{absolute:true,no_blending:true,rot:new THREE.Quaternion})}}})}else{if(motion_para.motion_tracking_upper_body_only){frames.add("skin","",{is_dummy:true,pos:true,after_IK:true,priority:999})}else if(use_3D_pose&&armL.score>0&&armR.score>0&&camera.video_canvas.width){camera_depth.get_hip_center(pose);frames.add("skin","",{pos:new THREE.Vector3,after_IK:true,priority:999,onProcessPosition:adjust_hip_center})}if(!arm_as_leg[""]||!arm_as_leg[""])frames.add("skin","",{is_dummy:true,rot:true});for(const d of["",""]){if(!arm_as_leg[d]){frames.add("skin",d+"",{is_dummy:true,pos:true,priority:999});frames.add("skin",d+"",{is_dummy:true,rot:true});frames.add("skin",d+"",{is_dummy:true,rot:true});frames.add("skin",d+"",{is_dummy:true,after_IK:true,rot:true})}}}}}else{_poseNet.data_detected=0}}if(_poseNet.enabled&&!_poseNet.data_detected_stable&&!_no_pose_data){_no_pose_data=true;if(!motion_para.motion_tracking_upper_body_only&&_poseNet.initial_data_detected)model.mesh.visible=false}let hand_data;let hand_info=[];const request_hand_pose_rot=!_handpose.enabled&&pose&&_poseNet.use_3D_pose;const _LR=sign_flip==1?[1,0]:[0,1];const _rot_pose={};const _rot_pose_ratio_=_handpose.enabled&&_poseNet.shoulder_width?Math.min(Math.max(Math.max(camera.video_canvas.width,camera.video_canvas.height)/_poseNet.shoulder_width-5,0)/5,1)*.5:0;const _rot_pose_ratio={"":_rot_pose_ratio_,"":_rot_pose_ratio_};if(request_hand_pose_rot||!motion_para.motion_tracking_upper_body_only&&_rot_pose_ratio_){_LR.forEach(function(dir,idx){let d=idx==0?"":"";if(!hands.find(h=>h.d==d)?.visible)return;let wrist=pose._keypoints3D[15+dir];let pinky=pose._keypoints3D[17+dir];let index=pose._keypoints3D[19+dir];if(wrist.score<=0||pinky.score<=0||index.score<=0)return;let LR=dir==1?[index,pinky]:[pinky,index];let y_axis=MMD_SA._v3a_.copy(wrist).sub(MMD_SA._v3b.copy(pinky).add(index).multiplyScalar(.5)).normalize();y_axis.x=y_axis.x*sign_flip;let x_axis=MMD_SA._v3b_.copy(LR[0]).sub(LR[1]).normalize();x_axis.z=x_axis.z*sign_flip;x_axis.y=x_axis.y*sign_flip;let z_axis=MMD_SA.TEMP_v3.crossVectors(x_axis,y_axis).normalize();x_axis.crossVectors(y_axis,z_axis);rot_m4.set(x_axis.x,x_axis.y,x_axis.z,0,y_axis.x,y_axis.y,y_axis.z,0,z_axis.x,z_axis.y,z_axis.z,0,0,0,0,1);q_m4.setFromBasis(rot_m4);let rot=new THREE.Quaternion;rot.copy(q_m4).conjugate();if(_q_tilt_angle)rot.premultiply(_q_tilt_angle);_rot_pose[d]=rot})}if(_handpose.enabled&&data.handpose&&data.handpose.length&&hands.length){const z_scale=use_mediapipe?1:2;data.handpose.forEach(handpose=>{handpose._offset={};hand_data=handpose.annotations;if(z_scale>1){for(let name in hand_data){hand_data[name].forEach(xyz=>{xyz[2]*=z_scale})}}});hands.forEach((hand,hand_idx)=>{var hand_dir=hand.dir;let handpose=hand.handpose;if(handpose&&hand.visible){hand.visible=true;handpose._used=true;let d=hand.d;handpose._d=d;hand_data=handpose.annotations;let arm=arms.find(arm=>arm.dir==hand_dir);const palm_scale=v3d.set(1,1,handpose.z_adjust_ratio||1);let hand_depth_weight=motion_para.motion_tracking?.hand_tracking?.depth_adjustment_disabled?0:MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent/100;if(hand_depth_weight&&upper_body_only_mode&&arm.pos.z>0&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=d){const palm_size=(MMD_SA._v3a.fromArray(hand_data.palm[0]).multiply(palm_scale).distanceTo(MMD_SA._v3b.fromArray(hand_data.middle[0]).multiply(palm_scale))+MMD_SA._v3a.fromArray(hand_data.index[0]).multiply(palm_scale).distanceTo(MMD_SA._v3b.fromArray(hand_data.pinky[0]).multiply(palm_scale)))/2/_poseNet.shoulder_width;const palm_shoulder_scale=MMD_SA_options.user_camera.ML_models.hands.palm_shoulder_scale_percent/100;const shoulder_scale=Math.max(camera.video_canvas.width,camera.video_canvas.height)/_poseNet.shoulder_width;hand_depth_weight_filter.filter(Math.max(3-Math.max(shoulder_scale-5,0),0)/3);palm_far_scale=(1.8+(1-Math.min(Math.max(shoulder_scale-4,0),1))*.4)*((1-MMD_SA_options.user_camera.ML_models.hands.depth_scale_percent/100)*2);hand_depth_filter[d].filter(Math.min(Math.max(palm_size-palm_shoulder_scale,0)/Math.max(palm_shoulder_scale*palm_far_scale-palm_shoulder_scale,.1),1))}if(handpose.worldLandmarks){hand_data=handpose.worldLandmarks.annotations;palm_scale.set(1,1,1)}hand_info.push(d+"");let LR=hand_dir==1?[hand_data.index[0],hand_data.ring[0]]:[hand_data.ring[0],hand_data.index[0]];let x_rot,y_rot,z_rot;let y_axis=MMD_SA._v3a_.fromArray(hand_data.palm[0]).multiply(palm_scale).sub(MMD_SA._v3b.fromArray(hand_data.middle[0]).multiply(palm_scale)).normalize();y_axis.x=y_axis.x*sign_flip;let x_axis=MMD_SA._v3b_.fromArray(LR[0]).multiply(palm_scale).sub(MMD_SA._v3b.fromArray(LR[1]).multiply(palm_scale)).normalize();x_axis.z=x_axis.z*sign_flip;x_axis.y=x_axis.y*sign_flip;let z_axis=MMD_SA.TEMP_v3.crossVectors(x_axis,y_axis).normalize();x_axis.crossVectors(y_axis,z_axis);rot_m4.set(x_axis.x,x_axis.y,x_axis.z,0,y_axis.x,y_axis.y,y_axis.z,0,z_axis.x,z_axis.y,z_axis.z,0,0,0,0,1);q_m4.setFromBasis(rot_m4);let rot=new THREE.Quaternion;rot.copy(q_m4).conjugate();if(tilt_adjustment.enabled){const tilt_angle=tilt_adjustment.angle*Math.PI/180;const q_tilt=MMD_SA._q2.set(Math.sin(tilt_angle/2),0,0,Math.cos(tilt_angle/2));rot.premultiply(q_tilt)}frames.add("skin",d+"",{after_IK:true,rot:rot,onProcessRotation:process_hand});frames.add("skin",d+"",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion});const hand_ry=MMD_SA.TEMP_v3.setEulerFromQuaternion(rot,"YXZ").y;const hand_facing_sign=1;const hand_facing=(Math.abs(hand_ry)<Math.PI/6?1:Math.abs(Math.abs(hand_ry)-Math.PI)<Math.PI/6?-1:0)*hand_facing_sign;const hand_back_ratio=Math.max((Math.abs(hand_ry)-Math.PI/2)*hand_facing_sign,0)/(Math.PI/2);let rot_dummy=new THREE.Quaternion;let f_base=MMD_SA_options.model_para_obj.finger_base;let hand_rot_inv=q1.copy(q_m4);hand_rot_inv.x*=-1;hand_rot_inv.z*=-1;let sign_LR=d==""?1:-1;finger_list.forEach((f,f_idx)=>{let f_obj=f_base[(sign_flip==1?d:d==""?"":"")+f_idx];let f_base_index=f_obj.base_index+(f_idx==0?0:-1);let finger=hand_data[finger_list_en[f_idx]];let rot_parent=q2.copy(hand_rot_inv);const euler_order="XZY";if(hand_facing&&f_idx>0){const ref_length=Math.max(MMD_SA._v3a.fromArray(finger[2]).sub(MMD_SA._v3b.fromArray(finger[1])).length()*1.2,MMD_SA._v3a.fromArray(hand_data.palm[0]).sub(MMD_SA._v3b.fromArray(finger[0])).length()*(hand_facing==1?.2:.3));const f1=MMD_SA._v3a.fromArray(finger[1]).sub(MMD_SA._v3b.fromArray(finger[0]));if(ref_length/f1.length()>1){const z_mod=-hand_facing*Math.sqrt(ref_length*ref_length-(f1.x*f1.x+f1.y*f1.y))-f1.z;for(let i=1;i<3;i++)finger[i][2]+=z_mod}}const name_base=d+f+""+nj_list[f_obj.base_index];const f_base_active_index=f_idx==0?1:0;for(let idx=f_base_index;idx<3;idx++){let name=d+f+""+nj_list[f_obj.base_index+(idx-f_base_index)];let f0=MMD_SA._v3a.fromArray(finger[idx+0]);let f1=MMD_SA._v3b.fromArray(finger[idx+1]);let _f=MMD_SA.TEMP_v3.fromArray(idx==f_base_index?hand_data.palm[0]:finger[idx-1]);f0.y=-f0.y;f1.y=-f1.y;_f.y=-_f.y;let v0=MMD_SA._v3a_.copy(f0).sub(_f);let v1=MMD_SA._v3b_.copy(f1).sub(f0);v0.normalize();v1.normalize();let angle,axis;let rot_v3;v0.applyQuaternion(rot_parent);v1.applyQuaternion(rot_parent);if(idx==f_base_index){let rot_to_y=MMD_SA.TEMP_q.set(0,0,0,1);rot_to_y.setFromVectorSpherical(MMD_SA.TEMP_v3.set(0,1,0),v0).conjugate();v1.applyQuaternion(rot_to_y);rot_parent.multiplyQuaternions(rot_to_y,rot_parent)}let rot=MMD_SA._q1.set(0,0,0,1);let rot_mirror=MMD_SA._q2.set(0,0,0,1);v0.set(0,1,0);rot_v3=v3b.setFromVectorSpherical(v0,v1);rot.setFromEuler(rot_v3,euler_order);rot_mirror.copy(rot);if(Math.abs(rot_v3.z)>Math.PI/(f_idx==0?1.1:2.5)||rot_v3.x>Math.PI/(f_idx==0?1.1:3)){rot_v3.set(-Math.abs(v0.angleTo(v1)),0,0)}if(f_idx==0&&idx>f_base_index+1){rot_v3.x=0}else if(rot_v3.x>0){rot_v3.x*=f_idx==0?0:idx>f_base_index?0:.75}else{rot_v3.x=Math.max(rot_v3.x,-Math.PI/(f_idx==0?1.25:2))}if(f_idx==0||idx==f_base_index){rot_v3.z+=(f_idx-2)/2*Math.PI/8*sign_LR*(f_idx>0?1:.5);rot_v3.z*=f_idx>0?Math.min(Math.max(Math.PI/2-Math.abs(rot_v3.x),0)/(Math.PI/2.5),1):1}else{rot_v3.z=0}if(hand_back_ratio&&f_idx>0&&idx==f_base_index){const f1=MMD_SA._v3a.fromArray(finger[idx+1]);f1.y*=-1;f1.applyQuaternion(hand_rot_inv);const f2=MMD_SA._v3b.fromArray(finger[idx+3]);f2.y*=-1;f2.applyQuaternion(hand_rot_inv);if(f1.y>f2.y){rot_v3.x-=Math.abs(rot_v3.z)*hand_back_ratio;rot_v3.z*=1-hand_back_ratio}}rot_v3.y=0;if(f_idx==0&&idx==f_base_active_index)rot_v3.multiplyScalar(1.5);if(f_idx==0)rot_parent.multiplyQuaternions(rot.conjugate(),rot_parent);rot.setFromEuler(rot_v3,euler_order);if(f_idx>0){rot_parent.multiplyQuaternions(rot.conjugate(),rot_parent);rot.conjugate()}let name_adjust=name;let aa=rot.toAxisAngle();axis=aa[0];angle=aa[1];axis.z*=-1;const f_thumb=!MMD_SA.THREEX.enabled&&f_idx==0?Math.min((Math.PI/8-rot_arm_adjust[name_base]._axis_rot_offset_inv_z*sign_LR)/(Math.PI/8),1.5):1;if(!MMD_SA.THREEX.enabled&&f_idx==0)axis.applyEuler(MMD_SA.TEMP_v3.set(0,Math.PI/4*sign_LR*f_thumb,0));axis.applyEuler(v3a.set(MMD_SA.THREEX.enabled?Math.PI/2:0,-Math.PI/2*sign_LR,0),"YXZ");if(MMD_SA.THREEX.enabled){rot.setFromAxisAngle(axis,angle)}else{axis.applyQuaternion(rot_arm_adjust[name_adjust].axis_rot);rot.setFromAxisAngle(axis,angle)}if(idx==f_base_active_index)rot.premultiply(MMD_SA.TEMP_q.set(0,0,0,1).slerp(rot_arm_adjust[name_base].axis_rot_offset_inv,f_idx==0?.5*f_thumb:1));if(arm_as_leg[d]){if(idx==f_base_index){const hand=frames.skin[d+""][0];if(!hand._finger_x)hand._finger_x=[];hand._finger_x[f_idx]=rot_v3.x}}else{frames.add("skin",name,{absolute:true,rot:rot.clone()})}}})}else{const d=hand.d;if(motion_para.motion_tracking_upper_body_only&&(!motion_para.motion_tracking?.hand_tracking?.stabilize_arm_disabled&&_handpose.stabilize_arm)&&frames.get_blend_default_motion("skin",d+(arm_as_leg[d]?"":""))!=0){hand.visible=false}}})}else if(request_hand_pose_rot){_LR.forEach(function(dir,idx){let d=idx==0?"":"";if(_rot_pose[d]){frames.add("skin",d+"",{after_IK:true,rot:_rot_pose[d],onProcessRotation:process_hand});frames.add("skin",d+"",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})}})}const _rot_pose_constrained={};const _rot_pose_ratio_by_angle_difference={};_LR.forEach(function(dir,idx){let d=idx==0?"":"";const rot_ref=motion_para.motion_tracking?.hand_tracking?.rotation_reference?.[d==""?"left":"right"];if(rot_ref){let weight=rot_ref.weight||1;if(rot_ref.type=="object3D"){const object3d=MMD_SA.THREEX._XR_Animator_scene_.object3D_list.find(obj=>obj.id==rot_ref.name);if(!object3d)return;const x_object=MMD_SA.THREEX._object3d_list_.find(obj=>obj.uuid==object3d._object3d_uuid);if(x_object._rot_aligned_&&x_object.parent_bone.name==d+""){if(x_object._rot_aligned_weight_!=null)weight=x_object._rot_aligned_weight_}_rot_pose_ratio_by_angle_difference[d]=rot_ref.weight_by_angle_difference;_rot_pose_constrained[d]=rot_ref.constrained_direction}if(rot_ref.weight_by_magnet){const magnet=motion_para.motion_tracking.arm_tracking?.transformation?.position?.magnet?.find(m=>m.magnet_id==rot_ref.weight_by_magnet.id);weight=magnet&&magnet._frame_count_>=EV_sync_update.count_frame-1-(_handpose.use_hands_worker?6:0)?magnet._weight_*(rot_ref.weight_by_magnet.max||weight):0}if(!hands.find(h=>h.d==d)?.handpose?._used){weight=1}weight=rot_pose_ratio_filter[d].filter(weight);_rot_pose_ratio[d]=weight;if(weight){if(!frames.skin[d+""]){const rot=new THREE.Quaternion;frames.add("skin",d+"",{after_IK:true,rot:rot,onProcessRotation:process_hand});frames.add("skin",d+"",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})}else if(frames.skin[d+""][0].timestamp<RAF_timestamp-100){frames.skin[d+""][0]._rot_parent=null}}weight=rot_ref.fingers_weight||Math.min(weight*(rot_ref.fingers_weight_scale||1),1);if(weight){if(rot_ref.fingers_from_opposite_hand||rot_ref.fingers){const nj_list=["","","",""];const f_name_map={thumb:"",index:"",middle:"",ring:"",pinky:""};if(rot_ref.fingers_from_opposite_hand){const d_opposite=d==""?"":"";Object.values(f_name_map).forEach(f=>{nj_list.forEach(i=>{const f_name=d+f+""+i;const f_name_opposite=d_opposite+f+""+i;let rot_opposite=frames.skin[f_name_opposite]?.[0].rot;if(rot_opposite){rot_opposite=MMD_SA.TEMP_q.copy(rot_opposite);rot_opposite.y*=-1;rot_opposite.z*=-1;if(!frames.skin[f_name]){frames.add("skin",f_name,{absolute:true,rot:rot_opposite.clone()})}else{frames.skin[f_name][0].rot.slerp(rot_opposite,weight)}}})})}else if(rot_ref.fingers){for(const name in rot_ref.fingers){let[f_name,f_index]=name.split("|");f_name=f_name_map[f_name];f_index=nj_list[parseInt(f_index)+(f_name==""?-1:0)];f_name=d+f_name+""+f_index;const f=frames.skin[f_name];if(f&&f[0].timestamp==RAF_timestamp){const f_rot=rot_ref.fingers[name];let q=MMD_SA.TEMP_q;if(f_rot.w==null){q=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(f_rot).multiplyScalar(Math.PI/180));f_rot.x=q.x;f_rot.y=q.y;f_rot.z=q.z;f_rot.w=q.w}else{q.copy(f_rot)}f[0].rot.slerp(q,weight)}}}}}}});for(const d of["",""]){const hand=frames.skin[d+""];if(hand){hand[0]._rot_pose=_rot_pose[d];hand[0]._rot_pose_ratio=_rot_pose_ratio[d];hand[0]._rot_pose_constrained=_rot_pose_constrained[d];hand[0]._rot_pose_ratio_by_angle_difference=_rot_pose_ratio_by_angle_difference[d];if(!hand[0]._finger_x)hand[0]._finger_x=hand[1]._finger_x}}const arm_as_leg_process=[];arms.forEach(function(arm){var d=arm.d;let hand_depth_weight=motion_para.motion_tracking?.hand_tracking?.depth_adjustment_disabled?0:MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent/100;if(hand_depth_weight&&_handpose.enabled&&upper_body_only_mode&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=d){let hand_depth=hand_depth_filter[d].filter();let _time_delta=(RAF_timestamp-hand_depth_filter[d].timestamp)/1e3;let _weight=1-Math.min(Math.max(_time_delta-.2,0)/(1-.2),1);if(_weight){let _hand_depth_weight=hand_depth_weight_filter.filter();hand_depth_weight*=_weight*_hand_depth_weight;let hand_z=hand_depth*MMD_SA_options.model_para_obj.left_arm_length*hand_depth_weight+arm.pos.z*(1-hand_depth_weight);const hand_z_max=Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-arm.pos.x*arm.pos.x-arm.pos.y*arm.pos.y);hand_z=Math.min(hand_z,hand_z_max);arm.pos.z=hand_z}}if(arm_as_leg[d]){if(arm.IK_disabled)return;_poseNet.enable_IK(d+"",true);if(frames.skin[d+""]&&frames.skin[d+""]&&frames.skin[d+""][0].timestamp==frames.skin[d+""][0].timestamp){let rot_hand_parent;if(rot_hand_parent){}else{const axis_rot=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(Math.PI/2,0,0));const rot_foot=frames.skin[d+""][0].rot.premultiply(axis_rot).multiply(axis_rot.conjugate());frames.add("skin",d+"",{after_IK:true,rot:rot_foot,_finger_x:frames.skin[d+""][0]._finger_x,absolute:true,onFinish:process_arm_as_leg})}}else{const foot=frames.skin[d+""];if(foot){foot[0].rot_parent=foot[0]._rot_parent}}frames.remove("skin",d+"");frames.remove("skin",d+"");frames.remove("skin",d+"");frames.remove("skin",d+"");frames.remove("skin",d+"");if(_handpose.enabled){finger_list.forEach((f,i)=>{let ini=i==0?0:1;for(let n=ini;n<ini+3;n++)frames.remove("skin",d+f+""+nj_list[n])})}const pos=(new THREE.Vector3).copy(arm.pos);const p=_arm_as_leg.transformation?.position;const pos_and_rot=transform_position(d+"",pos,p,pos=>{const pos_length_unit=MMD_SA_options.model_para_obj.left_leg_length;pos.y+=pos_length_unit*1/3;pos.z+=pos_length_unit*.25;pos.multiplyScalar(1.5)});arm_as_leg_process.push({d:d,pos:pos,rot:pos_and_rot[1]})}else{_poseNet.enable_IK(d+"",!arm.IK_disabled);if(!arm.IK_disabled){if(arm.pos.z==null)arm.pos.z=arm.pos.z_posenet||(_poseNet.use_3D_pose?0:MMD_SA_options.model_para_obj.left_arm_length*.2);const hand_visible=hands.find(h=>h.d==d)?.visible;const IK_pos=(new THREE.Vector3).copy(arm.pos);frames.add("skin",d+"",{priority:999,pos:IK_pos,_IK_absolute:arm.IK_absolute,_hand_visible:hand_visible,onProcessPosition:process_armIK})}const hand=frames.skin[d+""];if(hand){hand[0].rot_parent=hand[0]._rot_parent}}});if(arm_as_leg_process.length&&_arm_as_leg.transformation?.position?.process)_arm_as_leg.transformation.position.process(arm_as_leg_process);arm_as_leg_process.forEach(leg=>{const d=leg.d;const pos=leg.pos;pos.y+=MMD_SA_options.model_para_obj.left_leg_IK[1]+(bones_by_name[""].position.y-bones_by_name[""].pmxBone.origin[1]);if(leg.rot){frames.add("skin",d+"",{absolute:true,rot:leg.rot,onFinish:function(mesh,name){this.skin[name][0]._rot_=mesh.bones_by_name[name].quaternion.clone()}})}else{frames.remove("skin",d+"")}frames.remove("skin",d+"");frames.add("skin",d+"",{absolute:true,priority:999,pos:pos})});if(_no_pose_data){if(motion_para.motion_tracking_upper_body_only){for(const d of["",""]){_poseNet.enable_IK(d+"",motion_para.has_arm_IK)}}}else if(motion_para.motion_tracking_upper_body_only){for(const d of["",""]){const state=!hands.find(h=>h.d==d)?.visible;if(arm_as_leg[d]){frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state)}else{if(motion_para.has_leg_IK){frames.set_blend_default_motion("skin",d+"",true);frames.remove("skin",d+"")}else{frames.set_blend_default_motion("skin",d+"",true);frames.set_blend_default_motion("skin",d+"",true);frames.set_blend_default_motion("skin",d+"",true)}_poseNet.enable_IK(d+"",motion_para.has_leg_IK);_poseNet.enable_IK(d+"",motion_para.has_leg_IK);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);if(_handpose.enabled){finger_list.forEach((f,i)=>{let ini=i==0?0:1;for(let n=ini;n<ini+3;n++)frames.set_blend_default_motion("skin",d+f+""+nj_list[n],state)})}}}}_info_extra+=System._browser.motion_control.debug_msg;_info_extra+=(_info_extra?"":"\n")+"P-FPS:"+Math.round(fps)+"/"+Math.round(data.fps||0)+(_handpose.use_hands_worker?"\nH-FPS:"+Math.round(fps_hands):"");System._browser.motion_control.process({posenet_data:data});if(camera.motion_recorder.speed){const stats=camera.motion_recorder.stats;_info_extra+="\n "+camera.motion_recorder.time+"(-"+stats[0]+"/"+stats[1]+"-"+stats[3]+"/"+stats[2]+"-"+stats[4]+")"}if(_info_extra&&!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden&&(_poseNet.use_holistic?!data.facemesh:!_facemesh.enabled)){System._browser.on_animation_update.add(()=>{DEBUG_show((_poseNet.use_holistic&&"(no facemesh data)\n"||"")+(DEBUG_msg?"\n"+DEBUG_msg+"\n":"")+_info_extra+"\n"+"FPS:"+EV_sync_update.fps_last)},0,0)}if(data.facemesh){_facemesh.worker_onmessage({data:data.facemesh})}if(pose&&_facemesh.worker_initialized){let _data={posenet:pose,w:camera.video_canvas.width,h:camera.video_canvas.height,flip_canvas:camera.display_flipped};if(data.handpose&&data.handpose.length)_data.handpose=data.handpose;if(data.facemesh)_data.facemesh=data.facemesh.faces;if(_poseNet.use_holistic||!_facemesh.enabled){_data.draw_canvas=true;if(self.FacemeshAT){_data.canvas=camera.video_canvas_facemesh}else if(!camera.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){_data.canvas=camera.video_canvas_facemesh.transferControlToOffscreen();camera.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}}fm_worker.postMessage(_data,_data.canvas?[_data.canvas]:undefined)}pose_busy=0}pose_update_frame()}}();function pose_update_frame(delay_update){async function update_worker(){var pose_ready=_poseNet.enabled&&_poseNet.worker_initialized&&camera_video_timestamp&&!_poseNet.busy&&video_capture_active&&_poseNet.camera_video_timestamp!=camera_video_timestamp;if(!pose_ready)return;pose_busy=RAF_timestamp;_poseNet.camera_video_timestamp=camera_video_timestamp;_poseNet.camera_video_frame_id=camera_video_frame_id;if(_poseNet.use_holistic&&_facemesh.blink_detection){MMD_SA_options.auto_blink=_facemesh.auto_blink||false}let video_canvas,w,h;video_canvas=camera.video_canvas;w=video_canvas.width;h=video_canvas.height;let rgba=self.PoseAT?video_canvas:use_imagebitmap?await createImageBitmap(video_canvas):video_canvas.getContext("2d").getImageData(0,0,w,h).data.buffer;_poseNet._timestamp=camera.video_timestamp;let data={rgba:rgba,w:w,h:h,options:{video_flipped:camera.video_flipped,use_canvas_hands:!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only&&!_poseNet.use_holistic,use_holistic:_poseNet.use_holistic,use_posenet:true,use_handpose:_handpose.enabled,use_hands_worker:_handpose.use_hands_worker,skip_hand_countdown_max:_poseNet.skip_hand_countdown_max,model_quality:MMD_SA_options.user_camera.ML_models.pose.model_quality||"",z_depth_scale:MMD_SA_options.user_camera.ML_models.pose.z_depth_scale,timestamp:_poseNet._timestamp}};Object.assign(data.options,MMD_SA.MMD.motionManager.para_SA.motion_tracking?.hand_tracking?.mocap_options);let data_to_transfer=[data.rgba];if(!_poseNet.canvas_hands){const c=_poseNet.canvas_hands=document.createElement("canvas");c.width=c.height=768;data.canvas_hands=c.transferControlToOffscreen();data_to_transfer.push(data.canvas_hands)}if(_handpose.use_hands_worker&&!_handpose.canvas_hands_worker){const c=_handpose.canvas_hands_worker=document.createElement("canvas");c.width=c.height=768;data.canvas_hands_worker=c.transferControlToOffscreen();data_to_transfer.push(data.canvas_hands_worker)}pose_worker.postMessage(data,data_to_transfer);data_to_transfer.length=0;data_to_transfer=undefined;data.rgba=rgba=undefined;data=undefined}if(delay_update||self.PoseAT){setTimeout(()=>{update_worker()},0)}else{update_worker()}}var frames_object=function(){const func_dummy=()=>{};var pos_dummy,rot_dummy;var _body_rot_updated={};var _IK_links={},_IK_links_result={},_IK_links_result_final={};var _arm_IK_constraint={};var hip_rot_filter,hip_mov_filter;window.addEventListener("jThree_ready",e=>{pos_dummy=new THREE.Vector3;rot_dummy=new THREE.Quaternion;for(const name of["","","2","",""]){_body_rot_updated[name]=new THREE.Quaternion}for(const d of["",""]){_arm_IK_constraint[d]={target:new THREE.Vector3,arm_pos:new THREE.Vector3};_IK_links[d]={target:new THREE.Vector3,effector:new THREE.Quaternion,links:[]};_IK_links_result[d]={effector:new THREE.Quaternion,links:[]};_IK_links_result_final[d]={effector:new THREE.Quaternion,parent:new THREE.Quaternion,links:[]};for(let i=0;i<2;i++){_IK_links[d].links[i]=new THREE.Quaternion;_IK_links_result[d].links[i]=new THREE.Quaternion;_IK_links_result_final[d].links[i]=new THREE.Quaternion}}hip_rot_filter=new System._browser.data_filter([{type:"one_euro",id:"hip_rot",para:[30,1,.2,.2,4]}]);hip_mov_filter=new System._browser.data_filter([{type:"one_euro",id:"hip_mov",para:[30,1,.2,.2,3]}])});const fadein_blend_default_motion=250;const fadeout_blend_default_motion=500;const idle_blend_default_motion=0;function get_blend_default_motion(type,name,non_linear){if(!this[type][name])return 0;const obj=this[type][name][0];let ratio;if(obj._blend_default_motion>0){ratio=Math.min((RAF_timestamp-obj._blend_default_motion)/fadeout_blend_default_motion,1)}else if(obj._blend_default_motion<0){ratio=1-Math.min((RAF_timestamp+obj._blend_default_motion)/fadein_blend_default_motion,1)}else{ratio=0}if(ratio==0){this[type][name].forEach(obj=>{obj._blend_default_motion=0})}else if(non_linear){const f=2;ratio=ratio<.5?Math.pow(ratio*2,f)*.5:.5+Math.pow((ratio-.5)*2,1/f)*.5}return ratio}function set_blend_default_motion(type,name,v,idle_duration){if(!this[type][name]){if(!v)return;const is_pos=name.indexOf("")!=-1;const para={_blend_default_motion:v?1:0};if(is_pos)para.pos=new THREE.Vector3;else para.rot=new THREE.Quaternion;this.add("skin",name,para)}else{const obj_last=this[type][name][1];const _blend_default_motion=this[type][name][1]._blend_default_motion;if(v){if(this.reset_to_default_motion_once){obj_last._idle_blend_default_motion=0;obj_last._blend_default_motion=1}else if(!obj_last._blend_default_motion){if(!obj_last._idle_blend_default_motion)obj_last._idle_blend_default_motion=RAF_timestamp;if(RAF_timestamp-obj_last._idle_blend_default_motion>=(typeof idle_duration=="number"?idle_duration:idle_blend_default_motion)){obj_last._idle_blend_default_motion=0;obj_last._blend_default_motion=RAF_timestamp-RAF_timestamp_delta}}else if(obj_last._blend_default_motion<0){obj_last._blend_default_motion=RAF_timestamp-this.get_blend_default_motion(type,name)*fadeout_blend_default_motion}}else{obj_last._idle_blend_default_motion=0;if(obj_last._blend_default_motion>0){obj_last._blend_default_motion=-(RAF_timestamp-(1-this.get_blend_default_motion(type,name))*fadein_blend_default_motion)}}this[type][name][0]._blend_default_motion=obj_last._blend_default_motion;this[type][name][0]._idle_blend_default_motion=obj_last._idle_blend_default_motion}if(!this["_"+type][name])this["_"+type][name]={pos:new THREE.Vector3,rot:new THREE.Quaternion}}const RE_arm=new RegExp("("+toRegExp([""],"|")+")$");function process_bones_core(mesh,name){const model=THREE.MMD.getModels()[mesh._model_index];const motion_para=MMD_SA.motion[model.skin._motion_index].para_SA;let update_IK_and_AddTrans;const bones=mesh.bones_by_name;const bone=bones[name];const s=this.skin[name];if(_poseNet.enabled&&!_poseNet.data_detected_stable)return;if(s[0].info[1]=="facemesh"){}let record_rot,record_pos;s[0].t_delta+=RAF_timestamp_delta;let ratio=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);if(s[0].rot){if(s[0].after_IK){update_IK_and_AddTrans=!bone._update_IK_and_AddTrans||bone._update_IK_and_AddTrans.length;if(update_IK_and_AddTrans){if(bone.quaternion.x||bone.quaternion.y||bone.quaternion.z){bone.quaternion.conjugate();model._update_IK_and_AddTrans(false,name);bone.quaternion.conjugate()}}}if(s[0].onProcessRotation){s[0].onProcessRotation.call(this,mesh,name)}else{let rot=q1.set(0,0,0,1);if(s[0].absolute){bone.quaternion.set(0,0,0,1)}else{let motion_weight;if(motion_para.motion_tracking_upper_body_only){if(name.indexOf("")!=-1){motion_weight=motion_para.motion_tracking?.motion_default_weight?.upper_body}else if(name.indexOf("")!=-1){motion_weight=motion_para.motion_tracking?.motion_default_weight?.shoulder}}if(motion_weight==null)motion_weight=1;if(motion_weight<1)bone.quaternion.slerp(MMD_SA.TEMP_q.set(0,0,0,1),1-motion_weight)}if(s[0].parent_based){let rot_parent=s[0].rot_parent;if(!rot_parent){rot_parent=MMD_SA.get_bone_rotation_parent(mesh,name,mesh).conjugate()}s[0]._rot_parent=rot_parent;rot.copy(rot_parent)}rot.multiply(s[0].no_blending?s[0].rot:MMD_SA.TEMP_q.copy(s[1].rot).slerp(s[0].rot,ratio));const ratio_euler=s[0].ratio_euler;if(ratio_euler){const rot_euler=MMD_SA.TEMP_v3.setEulerFromQuaternion(rot,ratio_euler.order);const r=s[0].ratio<1?s[0].ratio:1;rot_euler.x*=ratio_euler.x*r;rot_euler.y*=ratio_euler.y*r;rot_euler.z*=ratio_euler.z*r;rot.setFromEuler(rot_euler,ratio_euler.order)}else if(s[0].ratio<1){rot.slerp(q2.set(0,0,0,1),1-s[0].ratio)}const sd=MMD_SA_options.model_para_obj_all[mesh._model_index].skin_default[name];if(sd&&sd.rot_scale){if(typeof sd.rot_scale=="number")sd.rot_scale={x:sd.rot_scale,y:sd.rot_scale,z:sd.rot_scale};rot.setFromEuler(MMD_SA.TEMP_v3.setEulerFromQuaternion(rot,"YXZ").multiply(sd.rot_scale),"YXZ")}bone.quaternion.multiply(rot);record_rot=motion_recorder.active&&!s[0].motion_recorder_disabled&&name.indexOf("")==-1}}if(s[0].pos){if(s[0].onProcessPosition){s[0].onProcessPosition.call(this,mesh,name)}else{if(s[0].absolute)bone.position.set(0,0,0);const pos=MMD_SA.TEMP_v3.copy(s[1].pos).lerp(s[0].pos,ratio);bone.position.add(pos);record_pos=motion_recorder.active&&!s[0].motion_recorder_disabled&&name.indexOf("")==-1}}s[0].onFinish&&s[0].onFinish.call(this,mesh,name);if(record_rot)motion_recorder.set_boneKey(name,null,bone.quaternion,true);if(record_pos)motion_recorder.set_boneKey(name,v3a.copy(bone.position).sub(v3b.fromArray(bone.pmxBone.origin)),null,true);const _ratio=this.get_blend_default_motion("skin",name,true);if(_ratio){if(s[0].rot&&this._skin[name]?.rot){const rot=MMD_SA.TEMP_q.copy(this._skin[name].rot);bone.quaternion.slerp(this._skin[name].onProcessRotation&&this._skin[name].onProcessRotation.call(this,mesh,name,rot)||rot,_ratio)}if(s[0].pos&&this._skin[name]?.pos){bone.position.lerp(this._skin[name].pos,_ratio)}if(motion_recorder.active&&!s[0].motion_recorder_disabled){if(name.indexOf("")!=-1)motion_recorder.set_boneKey(name,s[0].pos&&bone.position,s[0].rot&&bone.quaternion,false)}}update_IK_and_AddTrans&&model._update_IK_and_AddTrans(false,name)}var _poseNet_data_detected_last=0;function process_bones(e){function get_mocap_body_rot(){if(body_rot_updated)return;body_rot_updated=_body_rot_updated;for(const name of["","","2",""]){const s=this.skin[name];if(!s){body_rot_updated[name].set(0,0,0,1);continue}if(name==""){body_rot_updated[name].copy(s[0]._rot_neck||s[1]._rot_neck||MMD_SA._q1.set(0,0,0,1));body_rot_updated[""].copy(s[0]._rot_head||s[1]._rot_head||MMD_SA._q1.set(0,0,0,1))}else{const rot=MMD_SA._q1.set(0,0,0,1);const ratio=Math.max(Math.min((s[0].t_delta+RAF_timestamp_delta)/s[0].t_delta_frame,1),0);rot.multiply(s[0].no_blending?s[0].rot:MMD_SA.TEMP_q.copy(s[1].rot).slerp(s[0].rot,ratio));if(s[0].ratio<1)rot.slerp(MMD_SA._q2.set(0,0,0,1),1-s[0].ratio);body_rot_updated[name].copy(rot)}}rot_body_parent=MMD_SA._q1.copy(body_rot_updated[""]).multiply(body_rot_updated[""]).multiply(body_rot_updated["2"]).conjugate()}function get_arm_IK(d){const b_list=["","","2","",""];let dependent;const d_parent=arm_default_stickiness&&arm_default_stickiness.parent;const IK_offset=v3a.set(0,0,0);if(d_parent){const name=d_parent.name||d+"";const _d=name.charAt(0);const ratio=1-this.get_blend_default_motion("skin",name.indexOf("")!=-1?_d+"":name,true);let pos0,pos1;switch(name){case"":dependent=ratio&&this.skin[""];if(dependent){for(const name of["",""])bones[name].quaternion.copy(body_rot_updated[name]);pos0=MMD_SA.get_bone_position(mesh,"","").add(v3b.set(0,.75,.75).applyQuaternion(MMD_SA.TEMP_q.copy(bones[""].quaternion).multiply(bones[""].quaternion)));bones[""].quaternion.copy(this._body_motion_rot[0][""]);bones[""].quaternion.copy(this._body_motion_rot[0][""]);pos1=MMD_SA.get_bone_position(mesh,"","").add(v3b.set(0,.75,.75).applyQuaternion(MMD_SA.TEMP_q.copy(bones[""].quaternion).multiply(bones[""].quaternion)))}break;case"":case"":dependent=ratio;if(dependent){if(!_IK_links_result[_d].updated){_IK_links[_d].enabled=true;dependent=false}}else{_IK_links[_d].enabled=false;_IK_links_result[_d].updated=0}if(dependent){const leg=v3b.fromArray(bones[d+""].pmxBone.origin).sub(v3c.fromArray(bones[name].pmxBone.origin));pos0=v3c.copy(leg).applyQuaternion(q1.copy(_IK_links_result_final[_d].parent).multiply(_IK_links_result_final[_d].links[1]));pos1=leg.applyQuaternion(q1.copy(_IK_links_result_final[_d].parent).multiply(_IK_links_result[_d].links[1]))}break}if(dependent){dependent=name;IK_offset.copy(pos0).sub(pos1);let weight=d_parent.weight||.5;if(typeof weight=="object"){IK_offset.x*=IK_offset.x<0?weight.x.left:weight.x.right;IK_offset.y*=IK_offset.y<0?weight.y.down:weight.y.up;IK_offset.z*=IK_offset.z<0?weight.z.backward:weight.z.forward}else{IK_offset.multiplyScalar(weight)}IK_offset.multiplyScalar(ratio)}}let arm0,pos0,body_rot_inv0;for(const name of b_list)bones[name].quaternion.copy(this._body_motion_rot[0][name]);const elbow_lock=motion_para.motion_tracking?.arm_tracking?.elbow_lock?.[d==""?"left":"right"];if(elbow_lock){elbow_lock._elbow_y=elbow_lock.y_absolute!=null?elbow_lock.y_absolute:MMD_SA.get_bone_position(mesh,d+"",mesh).y+(elbow_lock.y||0)}if(!dependent||dependent!=""){arm0=MMD_SA.get_bone_position(mesh,d+"",mesh);body_rot_inv0=MMD_SA.get_bone_rotation_parent(mesh,d+"",mesh);pos0=!motion_para.has_arm_IK?MMD_SA.get_bone_position(mesh,d+"",mesh):(new THREE.Vector3).copy(bones[d+""].position).sub(MMD_SA_options.model_para_obj.arm_IK_offset[d]).applyQuaternion(body_rot_inv0).add(arm0);body_rot_inv0.conjugate()}for(const name of b_list)bones[name].quaternion.copy(this._body_motion_rot[1][name]);if(!arm0){arm0=MMD_SA.get_bone_position(mesh,d+"",mesh);body_rot_inv0=MMD_SA.get_bone_rotation_parent(mesh,d+"",mesh);pos0=!motion_para.has_arm_IK?MMD_SA.get_bone_position(mesh,d+"",mesh):(new THREE.Vector3).copy(bones[d+""].position).sub(MMD_SA_options.model_para_obj.arm_IK_offset[d]).applyQuaternion(body_rot_inv0).add(arm0);body_rot_inv0.conjugate()}for(const name of["","","2"]){let motion_weight;if(name.indexOf("")!=-1)motion_weight=motion_para.motion_tracking?.motion_default_weight?.upper_body;if(motion_weight==null)motion_weight=1;if(this.skin[name]){if(motion_weight<1)bones[name].quaternion.slerp(MMD_SA.TEMP_q.set(0,0,0,1),1-motion_weight);bones[name].quaternion.multiply(body_rot_updated[name])}}let default_position_weight=arm_default_stickiness&&arm_default_stickiness.default_position_weight;if(typeof default_position_weight!="number")default_position_weight=.5;const body_rot_inv1=MMD_SA.get_bone_rotation_parent(mesh,d+"",mesh).conjugate();let arm1;let arm_IK_constraint=motion_para.motion_tracking?.arm_tracking?.IK_constraint;if(arm_IK_constraint)arm_IK_constraint=arm_IK_constraint[d==""?"left":"right"]||arm_IK_constraint;if(arm_IK_constraint&&this.skin[d+""]&&this.get_blend_default_motion("skin",d+"")<1){const a=_arm_IK_constraint[d];a.enabled=true;a.target.copy(pos0);a.target_radius=0;if(arm_IK_constraint.target_offset){const target_offset=v3a.fromArray(arm_IK_constraint.target_offset);a.target.add(target_offset);a.target_radius=target_offset.length()}if(arm_IK_constraint.target_radius)a.target_radius+=arm_IK_constraint.target_radius;arm1=MMD_SA.get_bone_position(mesh,d+"",mesh);a.arm_pos.copy(arm1)}arm1=default_position_weight==0?arm0:(arm1||MMD_SA.get_bone_position(mesh,d+"",mesh)).lerp(arm0,1-default_position_weight);const IK_pos=arm1.sub(pos0);if(default_position_weight<1)body_rot_inv1.slerp(body_rot_inv0,1-default_position_weight);if(dependent&&dependent.indexOf("")!=-1){IK_offset.applyQuaternion(body_rot_inv1)}const x_dir=camera.x_flipped?-1:1;IK_pos.x*=x_dir;IK_pos.y*=-1;IK_pos.z*=-1;if(dependent&&dependent==""){IK_pos.applyQuaternion(body_rot_inv1)}else{IK_pos.applyQuaternion(body_rot_inv1)}if(!this._skin[d+""])this._skin[d+""]={pos:new THREE.Vector3,rot:new THREE.Quaternion};if(!this._skin[d+""].rot_parent_inv)this._skin[d+""].rot_parent_inv=new THREE.Quaternion;this._skin[d+""].rot_parent_inv.copy(body_rot_inv1).conjugate();IK_pos.add(MMD_SA_options.model_para_obj.arm_IK_offset[d]);IK_pos.add(IK_offset);for(const name of b_list)bones[name].quaternion.copy(this._body_motion_rot[1][name]);const hand=this.skin[d+""];if(hand){if(hand_default_rotation_weight){hand[0].after_IK=true;if(this._skin[d+""])this._skin[d+""]._rot_absolute=MMD_SA.get_bone_rotation(mesh,d+"",false,mesh)}if(this._skin[d+""])this._skin[d+""].onProcessRotation=fix_hand_rotation;if(this._skin[d+""])this._skin[d+""].onProcessRotation=fix_hand_twist_rotation}return IK_pos}function fix_hand_rotation(mesh,name,rot){const d=name.charAt(0);const hand_default_rotation_weight=motion_para.motion_tracking&&motion_para.motion_tracking.arm_default_stickiness&&(motion_para.motion_tracking.arm_default_stickiness[d]||motion_para.motion_tracking.arm_default_stickiness).default_rotation_weight;if(!hand_default_rotation_weight)return rot;const rot_parent=MMD_SA.get_bone_rotation_parent(mesh,name,mesh).conjugate();const _rot=rot_parent.multiply(this._skin[name]._rot_absolute);return _rot.slerp(rot,1-hand_default_rotation_weight)}function fix_hand_twist_rotation(mesh,name,rot){return rot.set(0,0,0,1)}function wait_for_data(){if(_poseNet.data_detected){add_events();System._browser.on_animation_update.remove(wait_for_data,0)}}const model=e.detail.model;const is_T_pose=MMD_SA.THREEX.get_model(model._model_index).is_T_pose;const mesh=model.mesh;const bones=mesh.bones_by_name;const motion_para=MMD_SA.motion[model.skin._motion_index].para_SA;for(const d of["",""]){const rot_ref=motion_para.motion_tracking?.hand_tracking?.rotation_reference?.[d==""?"left":"right"];if(!rot_ref)continue;hand_f=frames.skin[d+""]?.[0];if(!hand_f||!hand_f._rot_pose_ratio)continue;let rot_pose;if(rot_ref.type=="object3D"){const object3d=MMD_SA.THREEX._XR_Animator_scene_.object3D_list.find(obj=>obj.id==rot_ref.name);if(!object3d)return;const x_object=MMD_SA.THREEX._object3d_list_.find(obj=>obj.uuid==object3d._object3d_uuid);if(x_object._rot_aligned_&&x_object.parent_bone.name==d+""){rot_pose=x_object._rot_aligned_}else{rot_pose=x_object._mesh.quaternion.clone()}if(rot_ref.offset){if(rot_ref.offset=="parent_bone"){const aa=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(-x_object.parent_bone.rotation.x,-x_object.parent_bone.rotation.y,x_object.parent_bone.rotation.z).multiplyScalar(Math.PI/180),"YXZ").toAxisAngle();rot_pose.multiply(MMD_SA.TEMP_q.setFromAxisAngle(aa[0].applyQuaternion(q1.copy(rot_hand_adjust[d==""?1:-1]).conjugate()),aa[1]))}else{if(rot_ref.offset.w==null){const q=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(rot_ref.offset).multiplyScalar(Math.PI/180));rot_ref.offset.x=q.x;rot_ref.offset.y=q.y;rot_ref.offset.z=q.z;rot_ref.offset.w=q.w}rot_pose.multiply(MMD_SA.TEMP_q.copy(rot_ref.offset))}}}else{if(rot_ref.rotation){if(rot_ref.rotation.w==null){const q=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(rot_ref.rotation).multiplyScalar(Math.PI/180));rot_ref.rotation.x=q.x;rot_ref.rotation.y=q.y;rot_ref.rotation.z=q.z;rot_ref.rotation.w=q.w}rot_pose=MMD_SA.TEMP_q.copy(rot_ref.rotation)}}if(!hand_f._rot_pose)hand_f._rot_pose=new THREE.Quaternion;if(rot_pose){hand_f._rot_pose.copy(rot_pose)}else{hand_f._rot_pose.set(0,0,0,1)}}if(!this._reset_disabled&&this._motion_path&&(this._motion_path!=motion_para._path||this._motion_tracking_upper_body_only!=!!motion_para.motion_tracking_upper_body_only)){this._motion_path=motion_para._path;this._motion_tracking_upper_body_only=!!motion_para.motion_tracking_upper_body_only;this.reset();remove_events();_poseNet.data_detected=0;_poseNet.initial_data_detected=false;System._browser.on_animation_update.remove(wait_for_data,0);System._browser.on_animation_update.add(wait_for_data,0,0,-1);return}this._motion_path=motion_para._path;this._motion_tracking_upper_body_only=!!motion_para.motion_tracking_upper_body_only;if(motion_recorder.enabled&&_poseNet_data_detected_last!=_poseNet.data_detected){_poseNet_data_detected_last=_poseNet.data_detected;motion_recorder.timestamp_for_recording=RAF_timestamp;if(motion_recorder.active)window.dispatchEvent(new CustomEvent("SA_motion_recorder_on_active",e))}for(const d of["",""]){this.arm_IK_constraint[d].enabled=false}rot_parent_upper_body_inv.copy(this.get_upper_body_rotation()).multiply(this._rot_body_camera_offset);this.upper_body_rotation_limiter(rot_parent_upper_body_inv);let body_rot_updated,rot_body_parent,arm_default_stickiness,hand_default_rotation_weight;if((_poseNet.enabled||_facemesh.enabled)&&motion_para.motion_tracking_upper_body_only){const _arm_as_leg=motion_para.motion_tracking&&motion_para.motion_tracking.arm_as_leg;const arm_as_leg={"":_arm_as_leg&&_arm_as_leg.enabled&&(!_arm_as_leg.linked_side||_arm_as_leg.linked_side=="left"),"":_arm_as_leg&&_arm_as_leg.enabled&&(!_arm_as_leg.linked_side||_arm_as_leg.linked_side=="right")};for(const name in this._skin){this._skin[name].pos.copy(bones[name].position);this._skin[name].rot.copy(bones[name].quaternion)}const hip_adjustment_weight_percent=_poseNet.hip_adjustment_weight_percent/100;let adjust_lower_body=hip_adjustment_weight_percent&&(_poseNet.data_detected||!_poseNet.enabled&&_facemesh.data_detected);let rot_lower_body,pos_lower_body;if(adjust_lower_body){get_mocap_body_rot.call(this);const body_rot=q1.copy(rot_body_parent);const _pose=motion_para.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(_pose.upper_rotation_offset){const y=_pose.upper_rotation_offset*Math.PI/180;body_rot.premultiply(MMD_SA.TEMP_q.set(0,Math.sin(y/2),0,Math.cos(y/2)))}body_rot.conjugate();const rotation_weight=motion_para.motion_tracking?.hip_adjustment?.rotation_weight;rot_lower_body=(new THREE.Quaternion).copy(body_rot).slerp(q2.set(0,0,0,1),1-(typeof rotation_weight=="number"?rotation_weight:.5)*hip_adjustment_weight_percent);let hip_adjustment_smoothing=_poseNet.hip_adjustment_smoothing_percent/100;if(hip_adjustment_smoothing)hip_adjustment_smoothing=.1+(1-hip_adjustment_smoothing)*(1-hip_adjustment_smoothing)*.9;if(hip_adjustment_smoothing){hip_rot_filter.filters[0].filter.minCutOff=hip_adjustment_smoothing;rot_lower_body.fromArray(hip_rot_filter.filter(rot_lower_body.toArray()))}this.remove("skin","");this.add("skin","",{no_blending:true,rot:rot_lower_body});if(this.skin[""]){let hip_displacement=motion_para.motion_tracking?.hip_adjustment?.displacement_weight;if(hip_displacement==null)hip_displacement=.25;const axis=v3a;const scale=v3b;if(typeof hip_displacement=="number"){if(hip_displacement){hip_displacement*=hip_adjustment_weight_percent;axis.set(0,MMD_SA_options.model_para_obj.left_leg_length/3*hip_displacement,0);scale.set(-1,1,-1)}}else{axis.copy(hip_displacement.axis||MMD_SA.TEMP_v3.set(0,hip_displacement.weight,0)).multiplyScalar(MMD_SA_options.model_para_obj.left_leg_length/3*hip_adjustment_weight_percent);scale.copy(hip_displacement.scale)}scale.x*=_poseNet.hip_adjustment_scale_x_percent/100;scale.y*=_poseNet.hip_adjustment_scale_y_percent/100;scale.z*=_poseNet.hip_adjustment_scale_z_percent/100;const hip_adjustment_adjust_y_axis_percent=_poseNet.hip_adjustment_adjust_y_axis_percent/100;if(hip_adjustment_adjust_y_axis_percent&&!hip_displacement.axis){const a=Math.PI/4*hip_adjustment_adjust_y_axis_percent;const m=axis.y;axis.y=m*Math.cos(a);axis.z=m*Math.sin(a)}if(hip_displacement){axis_default=v3c.copy(axis);body_rot.multiply(MMD_SA.TEMP_q.set(0,0,0,1).slerp(body_rot_updated[""],_poseNet.hip_adjustment_head_weight_percent/100));axis.applyQuaternion(body_rot);axis.sub(axis_default).multiply(scale);if(hip_adjustment_smoothing){hip_mov_filter.filters[0].filter.minCutOff=hip_adjustment_smoothing;axis.fromArray(hip_mov_filter.filter(axis.toArray()))}this.skin[""][0].pos=(this.skin[""][0].pos||new THREE.Vector3).copy(axis);this.skin[""][0]._hip_adjustment_offset=(this.skin[""][0]._hip_adjustment_offset||new THREE.Vector3).copy(axis);this.skin[""][1].pos=this.skin[""][0].pos;pos_lower_body=this.skin[""][0].pos}}}for(const d of["",""]){const dir=d==""?"left":"right";arm_default_stickiness=motion_para.motion_tracking&&motion_para.motion_tracking.arm_default_stickiness&&(motion_para.motion_tracking.arm_default_stickiness[dir]||motion_para.motion_tracking.arm_default_stickiness);hand_default_rotation_weight=arm_default_stickiness&&arm_default_stickiness.default_rotation_weight;let feet_fixed_weight=motion_para.motion_tracking?.hip_adjustment?.[dir]?motion_para.motion_tracking.hip_adjustment[dir].feet_fixed_weight:motion_para.motion_tracking?.hip_adjustment?.feet_fixed_weight;if(typeof feet_fixed_weight!="number")feet_fixed_weight=1;if(feet_fixed_weight<1||(adjust_lower_body||arm_as_leg[d])&&!motion_para.has_leg_IK){const name=d+"";let _rot_lower_body,_pos_lower_body;if(rot_lower_body){_rot_lower_body=q1.copy(bones[""].quaternion);bones[""].quaternion.multiply(rot_lower_body)}if(pos_lower_body){_pos_lower_body=v3a.copy(bones[""].position);bones[""].position.add(pos_lower_body)}const leg0=motion_para.has_leg_IK?null:MMD_SA.get_bone_position(mesh,d+"","");const pos0=feet_fixed_weight<1?MMD_SA.get_bone_position(mesh,d+"",""):v3b;if(_rot_lower_body)bones[""].quaternion.copy(_rot_lower_body);if(pos_lower_body)bones[""].position.copy(_pos_lower_body);const pos1=motion_para.has_leg_IK||feet_fixed_weight>0?MMD_SA.get_bone_position(mesh,d+"",""):pos0;const x_dir=camera.x_flipped?-1:1;if(motion_para.has_leg_IK){const IK_pos=v3a.copy(pos1).sub(pos0.lerp(pos1,feet_fixed_weight));IK_pos.x*=x_dir;IK_pos.y*=-1;IK_pos.z*=-1;if(!this._skin[name])this._skin[name]={pos:new THREE.Vector3,rot:new THREE.Quaternion};this._skin[name].pos.add(IK_pos);bones[name].position.add(IK_pos)}else{const hip_pmx=v3a.fromArray(bones[d+""].pmxBone.origin);const hip_offset=hip_pmx.sub(leg0).negate();const IK_pos=leg0.sub(pos0.lerp(pos1,feet_fixed_weight));IK_pos.x*=x_dir;IK_pos.y*=-1;IK_pos.z*=-1;IK_pos.add(MMD_SA_options.model_para_obj.leg_IK_offset[d]);IK_pos.add(hip_offset);if(!this._skin[name])this._skin[name]={pos:new THREE.Vector3,rot:new THREE.Quaternion};this._skin[name].pos.copy(IK_pos);if(!arm_as_leg[d]){_poseNet.enable_IK(name,true);if(!this.skin[name])this.add("skin",name,{absolute:true,is_dummy:true,pos:true,priority:999})}bones[name].position.copy(IK_pos);if(_poseNet.data_detected)bones[d+""].quaternion.set(0,0,0,1)}bones[name].position.y+=this._skin[name]._offset_y_||0}if(arm_as_leg[d]){get_mocap_body_rot.call(this);const IK_pos=get_arm_IK.call(this,d);bones[d+""].position.copy(IK_pos);_poseNet.enable_IK(d+"",true)}else{const name=d+"";let IK_pos;const hand=this.skin[d+""];if(hand){get_mocap_body_rot.call(this);if(!_poseNet.IK_disabled_check(name)){IK_pos=get_arm_IK.call(this,d)}else{if(this._skin[d+""])this._skin[d+""].rot.premultiply(rot_body_parent);if(this._skin[d+""])this._skin[d+""].rot.premultiply(MMD_SA.TEMP_q.copy(rot_body_parent).conjugate())}}if(IK_pos)this._skin[name].pos.copy(IK_pos)}if(_IK_links[d].enabled){const b=bones[d+""];const obj=_IK_links[d];obj.target.copy(b.position);const ik=b.pmxBone.IK;obj.effector.copy(mesh.bones[ik.effector].quaternion);for(let i=0;i<ik.links.length;i++)obj.links[i].copy(mesh.bones[ik.links[i].bone].quaternion);window.addEventListener("SA_IK_"+(d+"")+"_onupdate",e=>{e.detail.result.links=obj;e.detail.result.links_result=_IK_links_result[d]},{once:true});window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const obj=_IK_links_result_final[d];obj.parent.copy(MMD_SA.get_bone_rotation_parent(mesh,d+"",""));obj.effector.copy(mesh.bones[ik.effector].quaternion);for(let i=0;i<ik.links.length;i++)obj.links[i].copy(mesh.bones[ik.links[i].bone].quaternion)},{once:true})}}for(let i=0;i<2;i++){const d=i==0?"":"";const s=this.skin[d+""];if(s&&this._skin[d+""]){let ratio=Math.max(Math.min((s[0].t_delta+RAF_timestamp_delta)/s[0].t_delta_frame,1),0);const z=(s[0]._rot_total||0)*ratio+(s[1]._rot_total||0)*(1-ratio);this._skin[d+""].rot.premultiply(MMD_SA.TEMP_q.set(0,0,Math.sin(z/2),Math.cos(z/2)))}}const _pose=motion_para.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(_pose.upper_rotation_offset){window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const model=e.detail.model;const bones=model.mesh.bones_by_name;let y=_pose.upper_rotation_offset*Math.PI/180;const q_offset=MMD_SA.TEMP_q.set(0,Math.sin(y/2*-.5),0,Math.cos(y/2*-.5));bones[""].quaternion.premultiply(q_offset);bones["2"].quaternion.premultiply(q_offset);q_offset.set(0,Math.sin(y/2),0,Math.cos(y/2));bones[""].quaternion.premultiply(q_offset);if(motion_recorder.active){motion_recorder.set_boneKey("",null,bones[""].quaternion,false);motion_recorder.set_boneKey("2",null,bones["2"].quaternion,false);motion_recorder.set_boneKey("",null,bones[""].quaternion,false)}},{once:true})}if(motion_recorder.active){window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const model=e.detail.model;const bones=model.mesh.bones_by_name;for(const d of["",""]){motion_recorder.set_boneKey(d+"",null,bones[d+""].quaternion,false);motion_recorder.set_boneKey(d+"",null,bones[d+""].quaternion,false);motion_recorder.set_boneKey(d+"",null,bones[d+""].quaternion,false);if(bones[d+"EX"])motion_recorder.set_boneKey(d+"EX",null,bones[d+"EX"].quaternion,false);for(const name of[d+"",d+"",d+"",d+""]){if(bones[name])motion_recorder.set_boneKey(name,null,bones[name].quaternion,false)}finger_list.forEach((f,i)=>{let ini=i==0?0:1;for(let n=ini;n<ini+3;n++){const name=d+f+""+nj_list[n];if(bones[name]&&!this.skin[name])motion_recorder.set_boneKey(name,null,bones[name].quaternion,false)}})}},{once:true})}}if(_poseNet.data_detected)this.reset_to_default_motion_once=false;window.dispatchEvent(new CustomEvent("SA_camera_poseNet_process_bones_onstart",e));var skin=this.skin;var skin_sorted=Object.keys(skin).filter(n=>!skin[n][0].after_IK).sort((a,b)=>{let _a=skin[a][0].priority||0;let _b=skin[b][0].priority||0;return _a-_b});skin_sorted.forEach(name=>{let bone=bones[name];if(!bone&&!/_DUMMY_/.test(name))return;var info=skin[name][0].info[1];if((!info||/pose/.test(info))&&!motion_para.motion_tracking_enabled)return;process_bones_core.call(this,mesh,name)})}function process_bones_after_IK(e){var model=e.detail.model;var mesh=model.mesh;var motion_para=MMD_SA.motion[model.skin._motion_index].para_SA;if(motion_para.motion_tracking_upper_body_only){for(const d of["",""]){const elbow_lock=motion_para.motion_tracking?.arm_tracking?.elbow_lock?.[d==""?"left":"right"];if(elbow_lock){const elbow_y=elbow_lock._elbow_y!=null?elbow_lock._elbow_y:null;if(elbow_y!=null)lock_elbow(elbow_lock,mesh,d)}}}var skin=this.skin;var skin_sorted=Object.keys(skin).filter(n=>skin[n][0].after_IK).sort((a,b)=>{let _a=skin[a][0].priority||0;let _b=skin[b][0].priority||0;return _a-_b});skin_sorted.forEach(name=>{let bone=mesh.bones_by_name[name];if(!bone&&!/_DUMMY_/.test(name))return;var info=skin[name][0].info[1];if((!info||/pose/.test(info))&&!motion_para.motion_tracking_enabled)return;process_bones_core.call(this,mesh,name)});window.dispatchEvent(new CustomEvent("SA_camera_poseNet_process_bones_onended",e))}function process_morphs(e){if(_poseNet.enabled&&!_poseNet.data_detected_stable)return;var model=e.detail.model;var mesh=model.mesh;var targets=model.morph.targets;model.pmx.morphs.forEach(function(m){if(m.panel!=3)return;var name=m.name;if(!model.pmx.morphs_weight_by_name[name])return;var morph_index=model.morph.target_index_by_name[name];if(morph_index==null)return;var target=targets[morph_index];var key0=target.keys[0];if(key0.morph_type==1){mesh.morphTargetInfluences[morph_index]=0}else{let key_new={name:name,weight:0,morph_type:key0.morph_type,morph_index:key0.morph_index};model.morph.onupdate(key_new,key_new,0,morph_index)}});var facemesh_morph=MMD_SA_options.model_para_obj.facemesh_morph;var morph=this.morph;var morph_weight={};var morph_weight_non_zero_count=0;Object.keys(morph).forEach(function(name){let m=morph[name];if(m.disabled)return;m[0].t_delta+=RAF_timestamp_delta;let ratio=Math.max(Math.min(m[0].t_delta/m[0].t_delta_frame,1),0);let weight=m[0].weight*ratio+m[1].weight*(1-ratio);morph_weight[name]=weight;if(weight)morph_weight_non_zero_count++});Object.keys(morph_weight).forEach(function(name){let m=morph[name];let weight=morph_weight[name];if(weight<0){motion_recorder.morph_active&&motion_recorder.set_morphKey(name,0,true);switch(name){case"":name="";break;case"":name="";break;case"":name="";break}weight=-weight}if(motion_recorder.morph_active){let name_MR=name;if(name=="L")name_MR="";else if(name=="R")name_MR="";motion_recorder.set_morphKey(name_MR,weight,true)}let fm=facemesh_morph[name];let m_name=fm&&fm.name||name;let morph_index=model.morph.target_index_by_name[m_name];if(morph_index==null)return;weight*=fm&&fm.weight||1;let target=targets[morph_index];let key0=target.keys[0];if(key0.morph_type==1){mesh.morphTargetInfluences[morph_index]=weight}else{let key_new={name:m_name,weight:weight,morph_type:key0.morph_type,morph_index:key0.morph_index};model.morph.onupdate(key_new,key_new,0,morph_index)}})}function add(info,name,obj){obj.name=name;obj.info=info.split("|");var type=obj.info[0];var target=this[type][name];if(obj.is_dummy){if(target&&target[0].is_dummy)return;obj.no_blending=true;obj.onProcessPosition=obj.onProcessRotation=func_dummy;if(obj.pos)obj.pos=pos_dummy;if(obj.rot)obj.rot=rot_dummy}const is_hand=name.indexOf("")!=-1||name.indexOf("")!=-1;obj.timestamp=RAF_timestamp;obj.t_delta=0;obj.t_delta_frame=_handpose.enabled&&is_hand&&this.t_delta_hands||this.t_delta||0;obj.t_delta_frame=Math.max(Math.min(obj.t_delta_frame,200),16.6667);if(target){if(RAF_timestamp==target[0].timestamp){target[0]=Object.assign(target[0],obj)}else{if(!obj.no_blending&&!camera.video.paused){let blending_ratio=_poseNet.use_3D_pose||obj.info[1]=="facemesh"?.5+Math.max(Math.min((Math.max(obj.t_delta_frame,RAF_timestamp-target[0].timestamp)-50)/150,1),0)*.5:1;if(obj.pos&&target[0].pos){obj.pos.lerp(target[0].pos,1-blending_ratio)}if(obj.rot&&target[0].rot){obj.rot.slerp(target[0].rot,1-blending_ratio)}if(obj.weight!=null&&target[0].weight!=null){obj.weight=obj.weight*blending_ratio+target[0].weight*(1-blending_ratio)}}this[type][name]=[obj,target[0]]}obj._blend_default_motion=target[1]._blend_default_motion;obj._idle_blend_default_motion=target[1]._idle_blend_default_motion}else{this[type][name]=[obj,obj]}if(motion_recorder.speed&&camera.is_local_video&&motion_recorder.speed<1)obj.no_blending=true}function remove(type,name){delete this[type][name]}function reset(){this.skin={};this.morph={};this._skin={};this._morph={};this.reset_to_default_motion_once=true;this._motion_path=""}function add_events(){window.addEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_before_IK",this.process_bones);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}function remove_events(){window.removeEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_before_IK",this.process_bones);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}var f=function(model_num){this.model_num=model_num;this.reset();this._body_motion_rot=[{},{}];this._rot_body_motion=new THREE.Quaternion;this._rot_body_camera=new THREE.Quaternion;this._rot_body_camera_offset=new THREE.Quaternion;this._rot_head_camera=new THREE.Quaternion;this._rot_head_camera_offset=new THREE.Quaternion;this._rot_body_offset=new THREE.Quaternion;this._rot_camera=new THREE.Quaternion;this._rot_camera_angle=0;this.process_bones=process_bones.bind(this);this.process_bones_after_IK=process_bones_after_IK.bind(this);this.process_morphs=process_morphs.bind(this)};f.prototype.set_upper_body_rotation=function(model_num,stage){if(!camera.ML_enabled||this.model_num!=model_num)return;const bones=THREE.MMD.getModels()[this.model_num].mesh.bones_by_name;for(const name of["","","2","",""]){if(!bones[name])continue;let _rot=this._body_motion_rot[stage][name];if(!_rot)_rot=this._body_motion_rot[stage][name]=new THREE.Quaternion;_rot.copy(bones[name].quaternion)}};f.prototype.get_upper_body_rotation=function(){const bones=THREE.MMD.getModels()[this.model_num].mesh.bones_by_name;this._rot_camera.setFromEuler(MMD_SA.TEMP_v3.set(MMD_SA._rx_last,MMD_SA._ry_last,0));this._rot_camera_angle=this._rot_camera.toAxisAngle()[1];const rot_motion=q1.set(0,0,0,1);const rot_motion_and_camera=q2.set(0,0,0,1);for(const name of["","","2"]){rot_motion.multiply(this._body_motion_rot[0][name]||bones[name].quaternion);rot_motion_and_camera.multiply(this._body_motion_rot[1][name]||bones[name].quaternion)}this._rot_body_camera.copy(rot_motion).conjugate().multiply(rot_motion_and_camera);this._rot_body_camera_offset.copy(this._rot_body_camera).conjugate().multiply(this._rot_camera);this._rot_body_motion.copy(rot_motion);const body_rot=q3.copy(rot_motion).conjugate();return body_rot};f.prototype.upper_body_rotation_limiter=function(rot_parent,angle_limit=Math.PI/3){var aa=rot_parent.toAxisAngle();var angle=aa[1];this._rot_body_offset.set(0,0,0,1);if(Math.abs(angle)>angle_limit){let angle_adjusted;if(Math.abs(angle)<angle_limit*2){angle_adjusted=Math.sign(angle)*angle_limit}else{angle_adjusted=Math.sign(angle)*angle_limit*(1-(angle-angle_limit*2)/(Math.PI-angle_limit*2))}rot_parent.setFromAxisAngle(aa[0],angle_adjusted);this._rot_body_offset.setFromAxisAngle(aa[0],angle_adjusted-angle)}return this._rot_body_offset};f.prototype.offset_upper_body_camera_rotation=function(rot,weight=1){return rot.premultiply(this._q2.copy(this._rot_body_offset).multiply(weight==1?this._rot_body_camera:this._q1.set(0,0,0,1).slerp(this._rot_body_camera,weight))).multiply(weight==1?this._rot_body_camera_offset:this._q1.set(0,0,0,1).slerp(this._rot_body_camera_offset,weight))};Object.defineProperty(f.prototype,"camera_weight",{get:function(){return Math.max((Math.PI/2-Math.abs(this._rot_camera_angle))/(Math.PI/2),0)}});Object.defineProperty(f.prototype,"arm_IK_constraint",{get:function(){return _arm_IK_constraint}});f.prototype.add=add;f.prototype.remove=remove;f.prototype.reset=reset;f.prototype.add_events=add_events;f.prototype.remove_events=remove_events;f.prototype.get_blend_default_motion=get_blend_default_motion;f.prototype.set_blend_default_motion=set_blend_default_motion;return f}();let frames;window.addEventListener("jThree_ready",()=>{frames_object.prototype._q1=new THREE.Quaternion;frames_object.prototype._q2=new THREE.Quaternion;frames=new frames_object(0)});var motion_recorder=function(){function BoneKey(name,pos,rot,time){this.name=name;this.pos=pos&&pos.toArray()||[0,0,0];this.rot=rot&&rot.toArray()||[0,0,0,1];this.time=time;boneKey_f[name].index=vmd.boneKeys.length}function MorphKey(name,weight,time){this.name=name;this.weight=weight;this.time=time;morphKey_f[name].index=vmd.morphKeys.length}var vmd;var boneKey_f,morphKey_f;var frame_count=0;var frame_dropped=0;var boneKey_saved=0;var morphKey_saved=0;var _frame_id;var _timestamp=0;var _speed=0;const morphKey_interval=2;return{timestamp_for_recording:0,get enabled(){return _speed&&!camera.video.paused},get morph_active(){return _poseNet.enabled?this.enabled:this.active},get active(){if(!this.enabled)return false;if(this.timestamp_for_recording&&this.timestamp_for_recording!=RAF_timestamp)return false;if(_frame_id!=camera_video_frame_id){let f_offset=1;if(_frame_id){f_offset=this.get_frame(camera_video_frame_id)-this.get_frame(_frame_id);if(f_offset<0||f_offset>30)f_offset=1;if(f_offset>1){const _f=f_offset-1;frame_dropped+=_f;for(const name in boneKey_f){boneKey_f[name].frame_length+=_f}for(const name in morphKey_f){morphKey_f[name].frame_length+=_f}}}frame_count+=f_offset;_frame_id=camera_video_frame_id;_timestamp=RAF_timestamp}if(_timestamp==RAF_timestamp){return true}return false},get_frame:function(frame_id){var parts=frame_id.split(":");return parseInt(parts[0])*30+(parseInt(parts[1])-1)},get frame_count(){return frame_count},get stats(){return[frame_dropped,vmd.boneKeys.length,vmd.morphKeys.length,boneKey_saved,morphKey_saved]},get time(){return Math.floor(frame_count/30)+":"+(frame_count%30+1)},get speed(){return _speed},set speed(speed){_speed=speed;if(speed)this.start(speed);else this.stop()},get vmd(){return _speed?null:vmd},set vmd(v){vmd=null},set_boneKey:function(name,pos,rot,check_timestamp){let bkf=boneKey_f[name];if(bkf==null){bkf=boneKey_f[name]={frame_length:1};if(frame_count>0)vmd.boneKeys.push(new BoneKey(name,null,null,0))}if(check_timestamp&&frames.skin[name]&&bkf.timestamp==frames.skin[name][0].timestamp){let data_identical;if(bkf.frame_count==frame_count){const k=vmd.boneKeys[bkf.index];data_identical=(!pos||k.pos)&&(!rot||k.rot)}else data_identical=true;if(data_identical){if(bkf.frame_count!=frame_count){bkf.frame_length++;boneKey_saved++}return}}if(!pos&&rot&&bkf.is_rot_identity&&rot.w==1){boneKey_saved++;return}bkf.is_rot_identity=rot?rot.w==1:bkf.is_rot_identity;if(bkf.frame_count==frame_count){const k=vmd.boneKeys[bkf.index];if(pos)k.pos=pos.toArray();if(rot)k.rot=rot.toArray()}else{if(bkf.index!=null&&name.indexOf("")==-1&&name.indexOf("")==-1){const k=vmd.boneKeys[bkf.index];const frame_length=Math.round(frame_count-k.time*30);if(frame_length>bkf.frame_length||frame_length>10){const k_copy=new BoneKey(name,null,null,(frame_count-1)/30);k_copy.pos=k.pos;k_copy.rot=k.rot;vmd.boneKeys.push(k_copy);boneKey_saved--}}bkf.timestamp=frames.skin[name]&&frames.skin[name][0].timestamp||0;vmd.boneKeys.push(new BoneKey(name,pos,rot,frame_count/30))}bkf.frame_length=1;bkf.frame_count=frame_count;return true},set_morphKey:(()=>{function _set_morphKey(name,weight,check_timestamp){let mkf=morphKey_f[name];if(mkf==null){mkf=morphKey_f[name]={frame_length:1};if(frame_count>0)vmd.morphKeys.push(new MorphKey(name,0,0))}if(check_timestamp&&frames.morph[name]&&mkf.timestamp==frames.morph[name][0].timestamp){if(mkf.frame_count!=frame_count){mkf.frame_length++;morphKey_saved++}return}weight=Math.round(weight*20)/20;if(weight==mkf.weight){morphKey_saved++;return}mkf.weight=weight;if(mkf.frame_count==frame_count){const k=vmd.morphKeys[mkf.index];k.weight=weight}else{if(mkf.index!=null){const k=vmd.morphKeys[mkf.index];const frame_length=Math.round(frame_count-k.time*30);if(frame_length<morphKey_interval){mkf.frame_length++;return}if(frame_length>mkf.frame_length||frame_length>10){vmd.morphKeys.push(new MorphKey(name,k.weight,(frame_count-morphKey_interval)/30));morphKey_saved--}}mkf.timestamp=frames.morph[name]&&frames.morph[name][0].timestamp||0;vmd.morphKeys.push(new MorphKey(name,weight,frame_count/30))}mkf.frame_length=1;mkf.frame_count=frame_count;return true}return function(name,weight,check_timestamp){if(_poseNet.enabled){window.addEventListener("SA_motion_recorder_on_active",()=>{_set_morphKey.call(this,name,weight,check_timestamp)},{once:true})}}})(),start:function(speed){_speed=speed;if(MMD_SA.THREEX.get_model(0).use_faceBlendshapes){MMD_SA.THREEX.get_model(0)._disable_faceBlendshapes=true;for(const name of _facemesh.faceBlendshapes_list){frames.remove("morph",name)}}_frame_id="";_timestamp=0;if(camera.is_local_video){camera.video.playbackRate=speed;if(speed<1)camera.video.muted=true;camera.video.loop=false;camera.video.pause();MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed.begin_recording"),5*1e3);C_media_control.style.visibility="inherit"}frame_count=-1;frame_dropped=0;boneKey_saved=0;morphKey_saved=0;boneKey_f={};morphKey_f={};vmd={boneKeys:[],morphKeys:[]}},stop:function(){_speed=0;MMD_SA.THREEX.get_model(0)._disable_faceBlendshapes=false;if(camera.is_local_video){camera.video.playbackRate=1;camera.video.muted=false;camera.video.loop=true;camera.video.pause();MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed.begin_recording.recording_stopped"),5*1e3)}else if(camera.is_local_photo){vmd.boneKeys=vmd.boneKeys.filter(k=>k.time==0);vmd.morphKeys=vmd.morphKeys.filter(k=>k.time==0);vmd.boneKeys=vmd.boneKeys.concat(vmd.boneKeys.map(k=>{const _k={name:k.name,pos:k.pos.slice(),rot:k.rot.slice(),time:60};return _k}));vmd.morphKeys=vmd.morphKeys.concat(vmd.morphKeys.map(k=>{const _k={name:k.name,weight:k.weight,time:60};return _k}))}}}}();const streamer_mode=(()=>{function show_status(){msgs=msgs.slice(Math.max(msgs.length-8,0),msgs.length);MMD_SA_options.Dungeon.run_event([[{message:{content:msgs.join("\n")+"\n("+System._browser.translation.get("XR_Animator.UI.streamer_mode.press_x_to_abort")+")",para:sb_para,branch_list:[{key:"X",is_closing_event:true,event_id:{func:()=>{_x_quit=true;if(_resolve)_resolve()},ended:true}}]}}]])}function check_model(){if(--_mocap_step_count==0){msgs.push(""+System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_model_loaded"));if(_resolve)_resolve()}}function facemesh_loaded(e){if(!_facemesh.calibrated){_mocap_step_count++;window.addEventListener("SA_camera_facemesh_calibrating",check_calibration);msgs.push(""+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrating")+"...");show_status()}check_model(e)}function check_calibration(e){const percent=e.detail.percent;if(percent>=100){window.removeEventListener("SA_camera_facemesh_calibrating",check_calibration);MMD_SA.SpeechBubble.list[1].message(0,"("+System._browser.translation.get("XR_Animator.UI.streamer_mode.calibrating_face_data")+" - 100%)",0,sb_para);msgs.push(""+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrated"));check_model()}else{MMD_SA.SpeechBubble.list[1].message(0,"("+System._browser.translation.get("XR_Animator.UI.streamer_mode.calibrating_face_data")+" - "+percent+"%)\n"+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrating_message"),0,sb_para)}}let running;let msgs=[];let _mocap_step_count;let _resolve;let _x_quit;const sb_para={font_scale:1,font:'"Segoe UI",Roboto,Ubuntu,"SF Pro"'};const _streamer_mode={get running(){return running},init_mocap:function(type){function change_motion(){if(running){if(MMD_SA_options.user_camera.streamer_mode.motion_id!=null){const motion_index=typeof MMD_SA_options.user_camera.streamer_mode.motion_id=="number"?MMD_SA_options.user_camera.streamer_mode.motion_id+(System._browser.camera.facemesh.enabled&&!System._browser.camera.poseNet.enabled?1:0):MMD_SA_options._XRA_pose_list?.[2].findIndex(m=>m.name==MMD_SA_options.user_camera.streamer_mode.motion_id);if(typeof motion_index=="number"&&motion_index>=0)MMD_SA_options.Dungeon_options.item_base.pose?._change_motion_(motion_index,true);return new Promise(resolve=>{window.addEventListener("SA_MMD_model0_onmotionchange",e=>{msgs.push(""+System._browser.translation.get("XR_Animator.UI.streamer_mode.motion_changed")+" ("+e.detail.motion_new.filename+")");resolve()},{once:true})})}}if(MMD_SA.WebXR.user_camera.poseNet.enabled){if(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_enabled)MMD_SA_options.Dungeon_options.item_base.pose?._change_motion_(0,true)}}switch(type){case"Face":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=false;MMD_SA.WebXR.user_camera.handpose.enabled=false;DEBUG_show("Facemesh AI:ON",2);_mocap_step_count=1;break;case"Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=false;MMD_SA.WebXR.user_camera.facemesh.enabled=false;DEBUG_show("Pose AI:ON",3);_mocap_step_count=1;break;case"Body+Hands":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;MMD_SA.WebXR.user_camera.facemesh.enabled=false;DEBUG_show("Pose/Hands AI:ON",3);_mocap_step_count=1;break;case"Face+Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=false;DEBUG_show("Facemesh/Pose AI:ON",3);_mocap_step_count=2;break;case"Full Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;DEBUG_show("Facemesh/Pose/Hands AI:ON",4);_mocap_step_count=2;break;case"Full Body Holistic":MMD_SA.WebXR.user_camera.poseNet.use_holistic=true;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;DEBUG_show("Facemesh/Pose/Hands AI:ON",4);_mocap_step_count=2;break;default:return}MMD_SA_options.user_camera.streamer_mode.mocap_type=type;return change_motion()},start:async function(){function reset(){msgs.length=0;_resolve=null;_x_quit=false;running=false}function quit(){reset();MMD_SA_options.Dungeon.event_mode=false}if(running){DEBUG_show("(Streamer mode running)");return}reset();running=true;MMD_SA_options.Dungeon.event_mode=true;const label_current=camera.stream&&MMD_SA_options.user_camera.streamer_mode.camera_preference.label;MMD_SA.WebXR.user_camera.video_flipped=!!MMD_SA_options.user_camera.streamer_mode.camera_preference.video_flipped;const camera_result=await camera.start();if(!camera_result){MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.streamer_mode.webcam_not_accessible"),5*1e3);quit();return}if(label_current!=MMD_SA_options.user_camera.streamer_mode.camera_preference.label)msgs.push(""+System._browser.translation.get("XR_Animator.UI.streamer_mode.webcam_on")+" ("+MMD_SA_options.user_camera.streamer_mode.camera_preference.label+")");let VMC_mode;if(webkit_electron_mode&&MMD_SA.THREEX.enabled){VMC_mode=!!MMD_SA_options.user_camera.streamer_mode.VMC_sender_enabled;if(VMC_mode){if(!MMD_SA.OSC.VMC.sender_enabled){MMD_SA_options.user_camera.streamer_mode.VMC_sender_enabled=MMD_SA.OSC.VMC.sender_enabled=true;msgs.push(""+System._browser.translation.get("XR_Animator.UI.streamer_mode.VMC_protocol_on"));MMD_SA.OSC.VMC.send_camera_data=!!MMD_SA_options.user_camera.streamer_mode.VMC_send_camera_data;if(MMD_SA.OSC.VMC.send_camera_data)msgs.push("- "+System._browser.translation.get("XR_Animator.UI.streamer_mode.VMC_protocol_on.send_camera_data"));System._browser.update_tray()}}}if(!camera.ML_enabled){const mocap_type_raw=MMD_SA_options.user_camera.streamer_mode.mocap_type||(is_mobile?System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.face","en"):System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.full_body","en"));const mocap_type=MMD_SA_options.user_camera.streamer_mode.mocap_type||(is_mobile?System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.face"):System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.full_body"));msgs.push(""+System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing")+" ("+mocap_type+")...");show_status();await new Promise(resolve=>{_resolve=resolve;if(/Face|Full Body/.test(mocap_type_raw))window.addEventListener("SA_camera_facemesh_update",facemesh_loaded,{once:true});if(/Body/.test(mocap_type_raw))window.addEventListener("SA_camera_poseNet_update",check_model,{once:true});const promise=streamer_mode.init_mocap(mocap_type_raw);if(promise)promise.then(show_status)})}if(_x_quit){window.removeEventListener("SA_camera_poseNet_update",check_model);window.removeEventListener("SA_camera_facemesh_update",facemesh_loaded);window.removeEventListener("SA_camera_facemesh_calibrating",check_calibration);MMD_SA.SpeechBubble.list.forEach(sb=>{sb.hide()});quit();return}_resolve=null;MMD_SA.SpeechBubble.hide();if(VMC_mode){if(msgs.length){await new Promise(resolve=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.UI.streamer_mode.finish_VMC"),para:sb_para,index:1,branch_list:[{key:1,event_id:{func:()=>{MMD_SA.hide_3D_avatar=true;System._browser.update_tray();resolve()},ended:true}},{key:"X",is_closing_event:true,event_id:{func:()=>{resolve()},ended:true}}]}}]])})}}else{if(msgs.length){await new Promise(resolve=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.UI.streamer_mode.finish"),para:sb_para,index:1,branch_list:[{key:1,event_id:{func:()=>{System._browser.overlay_mode=1;resolve()},ended:true}},{key:"X",is_closing_event:true,event_id:{func:()=>{resolve()},ended:true}}]}}]])})}}if(!msgs.length)MMD_SA.SpeechBubble.message(0,"XR Animator is ready!",3e3);if(camera.initialized&&camera.visible)camera.hide();quit()}};return _streamer_mode})();var ML_warmed_up_status=[{},{}];var hidden_enforced=url_search_params.get("camera_hidden");var _display_floating;camera={initialized:false,get ML_enabled(){return ML_enabled},get ML_busy(){return _facemesh.busy||_poseNet.busy},get ML_fps(){return 1e3/(_poseNet.enabled&&_poseNet._t||_facemesh.enabled&&_facemesh._t||1e3)},get ML_warmed_up(){var warmed_up_status=ML_warmed_up_status[_poseNet.use_holistic?1:0];var facemesh_ready=!_facemesh.enabled||warmed_up_status.facemesh;var poseNet_ready=!_poseNet.enabled||warmed_up_status.poseNet;var handpose_ready=!_handpose.enabled||warmed_up_status.handpose;return facemesh_ready&&poseNet_ready&&handpose_ready},get target_devicePixelRatio(){return target_devicePixelRatio||window.devicePixelRatio},set target_devicePixelRatio(v){target_devicePixelRatio=v==window.devicePixelRatio?0:v},get double_flip_mode(){return double_flip_mode&&!camera.mirror_3D},set double_flip_mode(v){double_flip_mode=v},get video_flipped(){return!ML_enabled?video_flipped:!!video_flipped^!!camera.double_flip_mode},set video_flipped(v){video_flipped=v;this.reset_video_canvas()},get display_flipped(){return camera.mirror_3D?false:video_flipped!=camera.video_flipped},get mirror_3D(){return!ML_enabled||!MMD_SA_options.user_camera.mirror_3D?false:MMD_SA_options.user_camera.mirror_3D==1?camera.visible:true},get x_flipped(){return camera.double_flip_mode||camera.mirror_3D},get hidden_enforced(){return hidden_enforced||(MMD_SA_options.user_camera.display.video.hidden==null?!!this.stream:MMD_SA_options.user_camera.display.video.hidden)||System._browser.overlay_mode>0||this.stream&&MMD_SA_options.user_camera.display.video.hidden_on_webcam},get display_floating(){return MMD_SA_options.user_camera.display.floating||_display_floating},set display_floating(v){_display_floating=v;if(this.video_host)this.video_host.style.zIndex=this.display_floating?2:0},get video_timestamp(){return camera.video.currentTime==null?performance.now()/2:camera.video.currentTime*1e3},get video_frame_id(){const t=this.video_timestamp/1e3;const t_int=Math.floor(t);return t_int+":"+Math.floor((t-t_int)*30+1)},get is_local_media(){return this.local_src&&!this.stream},get is_local_video(){return this.is_local_media&&this.video.currentTime!=null},get is_local_photo(){return this.is_local_media&&this.video.currentTime==null},DEBUG_show:(()=>{let msg_last="";let _DEBUG_msg="";let timestamp=0;let msg_list=[];window.addEventListener("MMDStarted",()=>{System._browser.on_animation_update.add(()=>{msg_list=msg_list.filter(m=>RAF_timestamp<m.timestamp+m.duration);_DEBUG_msg=msg_list.length?msg_list.map(m=>m.msg).join("\n")+"\n":"";DEBUG_msg=_DEBUG_msg+msg_last},0,0,-1)});return function(msg,hide_sec,always_visible){if(!camera.ML_enabled||!_poseNet.data_detected&&!_facemesh.data_detected){DEBUG_show(msg,hide_sec,always_visible);return}if(hide_sec){msg_list.push({msg:msg,duration:hide_sec*1e3,timestamp:RAF_timestamp});return}if(timestamp!=RAF_timestamp){timestamp=RAF_timestamp;msg_last=""}msg_last=(msg_last?msg_last+"\n":msg_last)+msg;DEBUG_msg=_DEBUG_msg+msg_last}})(),motion_recorder:motion_recorder,tilt_adjustment:{enabled:false,angle:0,pose_weight:.5},camera_list:null,deviceId:null,start:async function(src){async function request_camera(){try{stream=await navigator.mediaDevices.getUserMedia(constraints);return stream}catch(err){console.error(err)}}var AR_options=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;MMD_SA.reset_camera();this._camera_reset=MMD_SA._trackball_camera.object.clone();if(this.initialized&&!streamer_mode.running){if(this.visible){this.hide();DEBUG_show("User camera:HIDDEN",2);return}}var constraints={video:this.set_constraints()};try{if(src){this.init_stream(src)}else{if(is_mobile){constraints.video.facingMode="user"}if(MMD_SA_options.Dungeon){MMD_SA_options.Dungeon.run_event([[{message:{get content(){return System._browser.translation.get("XR_Animator.UI.webcam_media.finding_camera")}}},{goto_branch:0}]])}let stream;if(is_mobile){if(!this.stream)stream=await request_camera();if(MMD_SA_options.Dungeon)MMD_SA_options.Dungeon.run_event(null,0,2);if(!this.stream&&!stream){DEBUG_show("(Camera not accessible)",3);return}}else{let list=this.camera_list;if(!list){try{list=await navigator.mediaDevices.enumerateDevices();list=list.filter(d=>d.kind=="videoinput");const preference=MMD_SA_options.user_camera.streamer_mode.camera_preference&&{label:{test:s=>s.indexOf(MMD_SA_options.user_camera.streamer_mode.camera_preference.label)!=-1}}||MMD_SA_options.user_camera.preference;list.sort((a,b)=>preference?.label?.test(a.label)&&-1||preference?.label?.test(b.label)&&1||/warudo/i.test(a.label)&&1||/warudo/i.test(b.label)&&-1||0);this.camera_list=list=list.slice(0,7);if(streamer_mode.running&&!list.length)throw new Error("(No camera detected)")}catch(err){console.error(err);if(MMD_SA_options.Dungeon)MMD_SA_options.Dungeon.run_event(null,0,2);DEBUG_show("(No camera detected)",3);return}}let canceled;if(MMD_SA_options.Dungeon){await new Promise(resolve=>{MMD_SA_options.Dungeon.run_event([[{message:{get content(){return(list.length?System._browser.translation.get("XR_Animator.UI.webcam_media.choose_an_input")+list.map((d,idx)=>"\n"+(idx+1)+". "+d.label.substring(0,25)).join(""):System._browser.translation.get("XR_Animator.UI.webcam_media.no_camera"))+"\n"+(list.length+1)+". "+System._browser.translation.get("XR_Animator.UI.webcam_media.local_media_file")+"\n"+(list.length+2)+". "+System._browser.translation.get("Misc.cancel")},para:{row_max:11,no_word_break:true},bubble_index:3,branch_list:list.map((d,idx)=>{return{key:idx+1,branch_index:idx+1}}).concat([{key:Math.min(list.length+1,8),branch_index:Math.min(list.length+1,8)},{key:Math.min(list.length+2,9),is_closing_event:true,branch_index:Math.min(list.length+2,9)}])}}]].concat(list.map(d=>[{func:()=>{const label=d.label;MMD_SA_options.user_camera.streamer_mode.camera_preference=Object.assign(MMD_SA_options.user_camera.streamer_mode.camera_preference||{},{label:label,video_flipped:!!video_flipped});list.sort((a,b)=>a.label==label&&-1||b.label==label&&1||0);constraints.video.deviceId=d.deviceId;resolve()},ended:true}]).concat([[{func:()=>{if(camera.local_src){src=camera.local_src;resolve();return true}else{DEBUG_show("(No local media file found)",3);MMD_SA_options.Dungeon.run_event(null,0,0)}}}],[{func:()=>{canceled=true;resolve()},ended:true}]])));if(streamer_mode.running&&MMD_SA_options.user_camera.streamer_mode.camera_preference?.label){MMD_SA_options.Dungeon.run_event(null,1,0)}})}if(canceled){DEBUG_show("(Canceled)",2);return}if(!src&&constraints.video.deviceId!=this.deviceId){stream=await request_camera();if(!stream){DEBUG_show("(Camera not accessible)",3);return}}}if(src){camera.init_stream(src)}else if(stream){camera.init_stream(stream);this.deviceId=constraints.video.deviceId}if(AR_options&&AR_options.dom_overlay)AR_options.dom_overlay.use_dummy_webgl=true;DEBUG_show("(User camera:ON)",2)}if(!this.visible){this.show();DEBUG_show("User camera:VISIBLE",2)}return streamer_mode.running}catch(err){if(MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode)MMD_SA_options.Dungeon.run_event({ended:true});camera.init_stream();console.error(err);DEBUG_show("(ERROR: Camera unavailable, using fallback video instead)",3)}},init_stream:function(stream){if(!this.initialized){this.video=this._video=document.createElement("video");this.video.autoplay=true;let vs;this.video_host=document.createElement("div");vs=this.video_host.style;vs.position="absolute";vs.left="0px";vs.top="0px";vs.zIndex=this.display_floating?2:0;vs.visibility=System._browser.overlay_mode?"hidden":"inherit";vs.display=System._browser.overlay_mode?"none":"block";SL_Host.appendChild(this.video_host);this.video_canvas=document.createElement("canvas");vs=this.video_canvas.style;vs.position="absolute";vs.left="0px";vs.top="0px";vs.zIndex=0;vs.visibility="hidden";this.video_host.appendChild(this.video_canvas);this.video_canvas_bodyPix=document.createElement("canvas");vs=this.video_canvas_bodyPix.style;vs.position="absolute";vs.left="0px";vs.top="0px";vs.zIndex=0;vs.visibility="hidden";this.video_host.appendChild(this.video_canvas_bodyPix);this.video_canvas_face_detection=document.createElement("canvas");vs=this.video_canvas_face_detection.style;vs.position="absolute";vs.left="0px";vs.top="0px";vs.zIndex=0;vs.visibility="hidden";this.video_host.appendChild(this.video_canvas_face_detection);this.video_canvas_facemesh=document.createElement("canvas");vs=this.video_canvas_facemesh.style;vs.position="absolute";vs.left="0px";vs.top="0px";vs.zIndex=0;vs.visibility="hidden";this.video_host.appendChild(this.video_canvas_facemesh);is_mobile&&window.addEventListener("resize",function(){camera.video_track?.applyConstraints(camera.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)})["catch"](function(err){DEBUG_show("ERROR:camera size failed to update")})});navigator.mediaDevices.addEventListener("devicechange",()=>{console.log("mediaDevices: new device detected");this.camera_list=null})}this.initialized=true;this.show();if(this.stream){this.stream.getTracks().forEach(track=>{track.stop()});this.video.srcObject=this.stream=this.video_track=this.deviceId=null;console.log("(Previous stream stopped)")}if(!stream||typeof stream=="string"){video_fallback(stream)}else{this.stream=stream;this.video_id=stream.id;this.video_track=stream.getVideoTracks()[0];this.video=this._video;this.video.srcObject=stream;console.log("(New stream started)");setTimeout(function(){let capabilities=camera.video_track.getCapabilities?.();if(!capabilities)return;System._browser.console.log(Object.entries(capabilities).map(s=>s[0]+":"+JSON.stringify(s[1])).join("\n"));let settings=camera.video_track.getSettings();const para=Object.entries(settings).map(s=>s[0]+":"+JSON.stringify(s[1])).join("\n");console.log("MediaTrackCapabilities",para);if(is_mobile)System._browser.console.log()},2e3)}if(_facemesh.enabled)_facemesh.reset_calibration()},get use_armIK(){return _poseNet.enabled||_handpose.enabled||_facemesh.enabled},bodyPix:function(){var net;var enabled=false;_bodyPix={get enabled(){return enabled},set enabled(v){if(enabled==!!v)return;enabled=!!v;const SL=MMD_SA.THREEX.SL;if(enabled){MMD_SA._renderer.devicePixelRatio=1;MMD_SA._renderer.__resize(EV_width,EV_height);SL.style.visibility="hidden"}else{MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);SL.style.visibility="inherit";camera.video_canvas_bodyPix.style.visibility="hidden"}},busy:0,mask:null,allPoses:null,use_bodySegmentation:true,load:async function(options){this.enabled=true;if(net)return;if(!this.mask){this.mask=document.createElement("canvas");face_detection.load_face_cover()}if(this.use_bodySegmentation){const model=bodySegmentation.SupportedModels.MediaPipeSelfieSegmentation;const segmenterConfig={runtime:"mediapipe",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"};net=await bodySegmentation.createSegmenter(model,segmenterConfig)}else{net=await bodyPix.load(options||(1||is_mobile)?{architecture:"MobileNetV1",outputStride:16,multiplier:.5,quantBytes:2}:{architecture:"ResNet50",outputStride:32,quantBytes:2})}console.log("bodyPix loaded")},segmentPerson:async function(image,options){await this.load();if(this.use_bodySegmentation){return await net.segmentPeople(image)}else{return await net.segmentPerson(image,options||{flipHorizontal:false,internalResolution:"medium",segmentationThreshold:.7})}},toMask:async function(image,options_seg,options){const seg=await this.segmentPerson(image,options_seg);options=options||{foregroundColor:{r:0,g:0,b:0,a:255},backgroundColor:{r:0,g:0,b:0,a:0}};if(this.use_bodySegmentation){return await bodySegmentation.toBinaryMask(seg,options.foregroundColor,options.backgroundColor)}else{this.allPoses=seg.allPoses;return bodyPix.toMask(seg,options.foregroundColor,options.backgroundColor)}},update_frame:async function(image=camera.video_canvas,options_seg,options_mask,options_draw){const SL=MMD_SA.THREEX.SL;if(System._browser.snapshot.check_bodyPix()){camera.video_canvas.style.visibility="inherit";camera.video_canvas_bodyPix.style.visibility="hidden";SL.style.visibility="inherit";return}if(this.busy)return;this.busy=RAF_timestamp;const mask=await this.toMask(image,options_seg,options_mask);this.busy=0;if(!this.enabled)return;if(this.mask.width!=mask.width||this.mask.height!=mask.height){this.mask.width=mask.width;this.mask.height=mask.height}this.mask.getContext("2d").putImageData(mask,0,0);const w=SL.width;const h=SL.height;if(camera.video_canvas_bodyPix.width!=w||camera.video_canvas_bodyPix.height!=h){camera.video_canvas_bodyPix.width=w;camera.video_canvas_bodyPix.height=h}const ar=w/h/(image.width/image.height);const ww=Math.round(w*Math.min(1/ar,1));const hh=Math.round(h*Math.min(ar,1));const xx=(w-ww)/2;const yy=(h-hh)/2;const context=camera.video_canvas_bodyPix.getContext("2d");context.globalCompositeOperation="copy";context.filter="blur("+Math.ceil(3/window.devicePixelRatio)+"px)";context.drawImage(this.mask,0,0,mask.width,mask.height,xx,yy,ww,hh);context.globalCompositeOperation="source-out";context.filter="none";context.save();if(camera.mirror_3D){context.translate(w,0);context.scale(-1,1)}context.drawImage(SL,0,0);context.restore();context.globalCompositeOperation="destination-over";context.drawImage(image,0,0,image.width,image.height,xx,yy,ww,hh);camera.video_canvas_bodyPix.style.visibility="inherit";SL.style.visibility="hidden";this.update_frame_for_face_detection();System._browser.snapshot.check_bodyPix()},update_frame_for_face_detection:function(){let face_cover=face_detection.face_cover;if(!face_detection.enabled||!face_cover.complete)return;camera.video_canvas_face_detection.style.visibility="hidden";let cw=face_cover.width;let ch=face_cover.height;let dets=[];this.allPoses.forEach(function(pose){let keypoints=pose.keypoints;let nose=keypoints.find(kp=>kp.part=="nose");if(!nose)return;let leftEye=keypoints.find(kp=>kp.part=="leftEye");let rightEye=keypoints.find(kp=>kp.part=="rightEye");let dim;if(leftEye&&rightEye){let x_diff=leftEye.position.x-rightEye.position.x;let y_diff=leftEye.position.y-rightEye.position.y;dim=Math.sqrt(x_diff*x_diff+y_diff*y_diff)*4}else{dim=ch}dets.push([nose.position.y,nose.position.x,Math.max(dim,ch/2),100])});this.allPoses=undefined;face_detection.update_frame_local(camera.video_canvas_bodyPix,dets)}};return _bodyPix}(),face_detection:function(){var enabled=false;function init(){face_detection.initialized=true;if(!self.OffscreenCanvas)face_detection.load_face_cover();fd_worker=new Worker("js/pico.worker.js");fd_worker.onmessage=function(e){var data=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof data==="string"){DEBUG_show(data,2);face_detection.worker_initialized=true}else{camera._needs_RAF=true;if(data._t)DEBUG_show(data._t);face_detection.dets=data.dets;face_detection.busy=0;camera.video_canvas_face_detection.style.left=camera.video_canvas.style.left;camera.video_canvas_face_detection.style.top=camera.video_canvas.style.top;if(!self.OffscreenCanvas){System._browser.on_animation_update.add(function(){face_detection.update_frame_local(null,face_detection.dets)},0,0)}}face_detection.update_frame()}}face_detection={initialized:false,worker_initialized:false,get enabled(){return enabled},set enabled(v){if(enabled==!!v)return;enabled=!!v;if(enabled){this.dets=null;if(!this.initialized)init()}else{if(camera.initialized)camera.video_canvas_face_detection.style.visibility="hidden"}},load_face_cover:function(){if(!this.face_cover){this.face_cover=new Image;this.face_cover.src="images/laughing_man_134x120.png"}},dets:null,camera_video_timestamp:0,update_frame:function(delay_update){function update_worker(){var ready=face_detection.enabled&&face_detection.worker_initialized&&camera_video_timestamp&&!face_detection.busy&&video_capture_active&&face_detection.camera_video_timestamp!=camera_video_timestamp;if(!ready)return;face_detection.busy=RAF_timestamp;face_detection.camera_video_timestamp=camera_video_timestamp;face_detection.camera_video_frame_id=camera_video_frame_id;camera.video_canvas_face_detection.style.visibility="inherit";let video_canvas,w,h;video_canvas=camera.video_canvas;w=video_canvas.width;h=video_canvas.height;let rgba=video_canvas.getContext("2d").getImageData(0,0,w,h).data.buffer;let cs=camera.video_canvas_face_detection.style;if(cs.width!=video_canvas.style.width||cs.height!=video_canvas.style.height){cs.width=video_canvas.style.width;cs.height=video_canvas.style.height}let data={rgba:rgba,w:w,h:h};if(!camera.video_canvas_face_detection._offscreen&&self.OffscreenCanvas){data.canvas=camera.video_canvas_face_detection.transferControlToOffscreen();camera.video_canvas_face_detection._offscreen=true;console.log("(Face detection: use offscreen canvas)")}fd_worker.postMessage(data,data.canvas?[data.canvas,data.rgba]:[data.rgba]);data.rgba=rgba=undefined;data=undefined}if(delay_update||self.PoseAT){setTimeout(()=>{update_worker()},0)}else{update_worker()}},update_frame_local:function(canvas,dets){let ww=camera.video_canvas.width;let hh=camera.video_canvas.height;let context;if(!canvas){canvas=camera.video_canvas_face_detection;if(canvas.width!=ww||canvas.height!=hh){canvas.width=ww;canvas.height=hh}context=canvas.getContext("2d");context.clearRect(0,0,ww,hh)}else{context=canvas.getContext("2d")}context.globalCompositeOperation="source-over";let face_cover=this.face_cover;let cw=face_cover.width;let ch=face_cover.height;let h,w,x,y;if(dets.length){let scale=1;dets.forEach(function(det){h=det[2]*scale;w=h*cw/ch;x=det[1]*scale-w/2;y=det[0]*scale-h/2;context.drawImage(face_cover,0,0,cw,ch,x,y,w,h)})}else{h=Math.min(ww,hh);w=h*cw/ch;x=(ww-w)/2;y=(hh-h)/2;context.drawImage(face_cover,0,0,cw,ch,x,y,w,h)}}};return face_detection}(),streamer_mode:streamer_mode,facemesh:function(){var enabled=false;var calibration_timestamp=0;var calibration_percent=0;var calibrating=true;var lips_width_average=0;var lips_width_data=[];var eyebrow_data;var eye_data;var neck_length_average;var neck_length_data=[];var blink_detection;var auto_blink=false;var blendshape_accumulated;var facemesh_type=-1;var video_id;function reset_calibration(enforced){if(!enforced&&video_id&&video_id==camera.video_id)return;video_id=camera.video_id;calibration_timestamp=0;calibration_percent=0;calibrating=true;lips_width_average=0;lips_width_data=[];eyebrow_data={};eye_data={L:[],R:[]};neck_length_average=0;neck_length_data=[];var eye_data_height_ref_pts={L:[159,145],R:[386,374]};["L","R"].forEach(function(dir){for(var i=0;i<1;i++){let data=eye_data[dir][i]={};data.index=i;data._eye_open_average=0;data.eye_open_average=0;data.eye_open_lower=999;data.eye_open_data=[];data.height_ref_pts=eye_data_height_ref_pts[dir]}eyebrow_data[dir]={_height_average:0,height_average:0,height_data:[],height_ref_pts:dir=="R"?[334,330]:[105,101]}});blendshape_accumulated={sad:0,angry:0,surprise:0,blush:0,tongue_out:0}}var auto_blink_default;var _v3=[];var use_faceLandmarksDetection,use_human_facemesh,use_mediapipe_facemesh;use_faceLandmarksDetection=!is_mobile;use_mediapipe_facemesh=!is_chrome||is_mobile;var TRIANGULATION;function init(){if(_facemesh.initialized)return;_facemesh.initialized=true;for(var i=0;i<4;i++)_v3[i]=new THREE.Vector3;var params=[];if(System._browser.use_WASM_SIMD){params.push("simd=1")}if(use_holistic){use_faceLandmarksDetection=true}if(use_mediapipe_facemesh){use_faceLandmarksDetection=true;params.push("use_mediapipe_facemesh=1")}if(use_faceLandmarksDetection){use_faceLandmarksDetection=true;if(_facemesh.blink_detection==null)_facemesh.blink_detection=true;params.push("use_face_landmarks=1")}if(use_human_facemesh){params.push("use_human_facemesh=1")}var promise;if(MMD_SA_options.user_camera.ML_models.facemesh.worker_disabled){promise=new Promise((resolve,reject)=>{fm_worker={postMessage:function(msg,transfer){FacemeshAT.onmessage({data:msg})}};let script=document.createElement("script");script.onload=async function(){await FacemeshAT.init(fm_worker,params);resolve()};script.src="js/facemesh_lib.js";document.head.appendChild(script)})}else{fm_worker=new Worker("js/facemesh_worker.js"+(params.length?"?"+params.join("&"):""))}fm_worker.onmessage=facemesh_worker_onmessage;return promise}function drawPath(ctx,points,closePath){const region=new Path2D;region.moveTo(points[0][0]/2,points[0][1]/2);for(let i=1;i<3;i++){const point=points[i];region.lineTo(point[0]/2,point[1]/2)}if(closePath){region.closePath()}ctx.stroke(region)}const faceBlendshapes_list=["_neutral","BrowInnerUp","BrowDownLeft","BrowDownRight","BrowOuterUpLeft","BrowOuterUpRight","EyeLookUpLeft","EyeLookUpRight","EyeLookDownLeft","EyeLookDownRight","EyeLookInLeft","EyeLookInRight","EyeLookOutLeft","EyeLookOutRight","EyeBlinkLeft","EyeBlinkRight","EyeSquintRight","EyeSquintLeft","EyeWideLeft","EyeWideRight","CheekPuff","CheekSquintLeft","CheekSquintRight","NoseSneerLeft","NoseSneerRight","JawOpen","JawForward","JawLeft","JawRight","MouthFunnel","MouthPucker","MouthLeft","MouthRight","MouthRollUpper","MouthRollLower","MouthShrugUpper","MouthShrugLower","MouthClose","MouthSmileLeft","MouthSmileRight","MouthFrownLeft","MouthFrownRight","MouthDimpleLeft","MouthDimpleRight","MouthUpperUpLeft","MouthUpperUpRight","MouthLowerDownLeft","MouthLowerDownRight","MouthPressLeft","MouthPressRight","MouthStretchLeft","MouthStretchRight","TongueOut"];let faceBlendshapes_index;const MMD_morph_list=["","","","","","","","","","","","","","","","","","","","L","R"];var facemesh_worker_onmessage=function(){function build_faceBlendshapes_index(b){if(!b||faceBlendshapes_index)return;faceBlendshapes_index={};b.categories.forEach((c,i)=>{const n=c.categoryName;faceBlendshapes_index[n.charAt(0)+n.substring(1)]=i})}var _info_extra_facemesh;var fps=0,fps_count=0,fps_ms=0,fps_timestamp=0;const facemesh_filter={};window.addEventListener("jThree_ready",()=>{for(const name of MMD_morph_list.concat([""])){facemesh_filter[name]=new System._browser.data_filter([{type:"one_euro",id:name,para:name==""?[30,1,5,1,4]:[30,1,1,1,1]}])}});return function(e){var data=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof data==="string"){if(data=="OK"){_facemesh.worker_initialized=true}else{DEBUG_show(data,2);System._browser.console.log(data)}}else if(data.posenet){pose_worker_onmessage({data:data})}else if(_facemesh.enabled){window.dispatchEvent(new CustomEvent("SA_camera_facemesh_update"));camera._needs_RAF=true;const warmed_up_status=ML_warmed_up_status[_poseNet.use_holistic?1:0];if(!warmed_up_status.facemesh){warmed_up_status.facemesh=true;DEBUG_show("Facemesh ML ready",2)}let info="";if(data.faces.length){_facemesh.data_detected++}else{_facemesh.data_detected=0}if(data.faces.length&&data.faces[0].bb_center){bb_center=data.faces[0].bb_center}else if(!_poseNet.enabled){bb_center=[.5,.5]}if(data.faces.length&&_facemesh.data_detected_stable){let face=data.faces[0];build_faceBlendshapes_index(face.faceBlendshapes);let sign_flip=camera.x_flipped?1:-1;const motion_control_data={facemesh_data:face};let x_rot,y_rot,z_rot;if(face.rotation){const rm=face.rotation.matrix;rot_m4.set(rm[0],rm[1],rm[2],0,rm[3],rm[4],rm[5],0,rm[6],rm[7],rm[8],0,0,0,0,1)}else{let y_axis=MMD_SA._v3a_.fromArray(face.mesh[152]).sub(MMD_SA._v3b.fromArray(face.mesh[10])).normalize();let x_axis=MMD_SA._v3b_.fromArray(face.mesh[454]).sub(MMD_SA._v3b.fromArray(face.mesh[234])).normalize();let z_axis=MMD_SA.TEMP_v3.crossVectors(x_axis,y_axis).normalize();x_axis.crossVectors(y_axis,z_axis);rot_m4.set(x_axis.x,x_axis.y,x_axis.z,0,y_axis.x,y_axis.y,y_axis.z,0,z_axis.x,z_axis.y,z_axis.z,0,0,0,0,1)}let xyz=MMD_SA.TEMP_v3.setEulerFromRotationMatrix(rot_m4,"YZX");x_rot=-xyz.x;y_rot=-xyz.y;z_rot=-xyz.z;let _x_diff=face.scaledMesh[454][0]-face.scaledMesh[234][0];let _y_diff=face.scaledMesh[454][1]-face.scaledMesh[234][1];let _dis;if(data.recalculate_z_rotation_from_scaledMesh){_x_diff/=Math.cos(y_rot);_y_diff/=Math.cos(x_rot);_dis=Math.sqrt(_x_diff*_x_diff+_y_diff*_y_diff)}else{_x_diff/=Math.cos(z_rot);_dis=Math.abs(_x_diff/Math.cos(y_rot))}_facemesh.face_width=_dis;let _z_rot;if(data.recalculate_z_rotation_from_scaledMesh){_z_rot=Math.asin(_y_diff/_dis)}else{_z_rot=z_rot}let rot=new THREE.Quaternion;let rot_v3=MMD_SA._v3a.set(x_rot,y_rot*sign_flip,_z_rot*sign_flip);rot.setFromEuler(rot_v3,"YZX");_facemesh.calculate_neck_data({is_face:true,timestamp:_facemesh.camera_video_frame_id,f_axis:v3a.set(face.scaledMesh[454][0],face.scaledMesh[454][1],0).add(MMD_SA.TEMP_v3.set(face.scaledMesh[234][0],face.scaledMesh[234][1],0)).multiplyScalar(.5).setZ(0).toArray(),face_width:_facemesh.face_width,face_rot:rot.toArray()});const motion_para=MMD_SA.MMD.motionManager.para_SA;let tilt_angle=0;let tilt_adjustment=motion_para.motion_tracking?.camera?.tilt_adjustment||camera.tilt_adjustment;if(tilt_adjustment.enabled){tilt_angle=tilt_adjustment.angle*Math.PI/180;const q_tilt=MMD_SA._q2.set(Math.sin(tilt_angle/2),0,0,Math.cos(tilt_angle/2));rot.premultiply(q_tilt)}let t_now=camera.video_timestamp;let _t=0;if(fps_timestamp){_t=Math.max(Math.min(t_now-fps_timestamp,1e3),10);fps_ms+=_t;if(++fps_count>=20){fps=1e3/(fps_ms/fps_count);fps_count=fps_ms=0}}fps_timestamp=t_now;_facemesh._t=data._t;frames.t_delta=fps&&1e3/fps||_t||data.fps&&1e3/data.fps||data._t;_info_extra_facemesh="";if(_facemesh.head_pose_enabled){if(System._browser.motion_control.enabled)motion_control_data.head_rot=MMD_SA._v3a.clone();frames.add("skin|facemesh","",{after_IK:true,rot:rot,_rot_ratio:_facemesh.face_width/Math.min(camera.video_canvas.width,camera.video_canvas.height),onProcessRotation:process_head_rotation})}calibration_timestamp+=Math.min(data._t,75);if(calibrating){calibration_percent=~~(Math.min(calibration_timestamp/5e3,lips_width_data.length/60,blink_detection?eye_data.L[0].eye_open_data.length/60:1,_poseNet.enabled?neck_length_data.length/60:1,1)*100);calibrating=calibration_percent<100;window.dispatchEvent(new CustomEvent("SA_camera_facemesh_calibrating",{detail:{percent:calibration_percent}}))}let calibration_condition=face.faceInViewConfidence>(use_human_facemesh?.75:.9)&&(camera.video==camera._image||!camera.video.paused&&Math.abs(y_rot)<Math.PI/4&&Math.abs(x_rot+tilt_angle)<Math.PI/6);let lips_inner_height=MMD_SA._v3a.fromArray(face.mesh[13]).distanceTo(MMD_SA._v3b.fromArray(face.mesh[14]));let lips_width=face.faceBlendshapes?Math.max(face.faceBlendshapes.categories[faceBlendshapes_index["mouthPucker"]].score,.01):MMD_SA._v3a.fromArray(face.mesh[61]).distanceTo(MMD_SA._v3b.fromArray(face.mesh[291]));let _lips_width_average=lips_width_average;if(!_lips_width_average){if(calibration_condition&&lips_inner_height<2*(1+Math.abs(tilt_angle)/(Math.PI/4)*4))lips_width_data.push(lips_width);if(!lips_width_data.length){_lips_width_average=0}else{let edge_size=parseInt(lips_width_data.length*.3);_lips_width_average=lips_width_data.sort((a,b)=>a-b).slice(edge_size,lips_width_data.length-edge_size).reduce((accumulator,currentValue)=>accumulator+currentValue)/(lips_width_data.length-edge_size*2);if(!calibrating){lips_width_average=_lips_width_average}}}let mouth_open_x=0;let mouth_wide=0;let eyebrow_up=0;let smile=0;["L","R"].forEach(function(dir){let e=eyebrow_data[dir];e.height=face.faceBlendshapes?Math.max(face.faceBlendshapes.categories[faceBlendshapes_index["eyeSquint"+(dir=="L"?"Left":"Right")]].score,.01):MMD_SA._v3a.fromArray(face.mesh[e.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(face.mesh[e.height_ref_pts[1]]));e._height_average=e.height_average;if(!e._height_average){if(calibration_condition)e.height_data.push(e.height);if(!e.height_data.length){e._height_average=e.height}else{let edge_size=parseInt(lips_width_data.length*.3);e._height_average=e.height_data.sort((a,b)=>a-b).slice(edge_size,e.height_data.length-edge_size).reduce((accumulator,currentValue)=>accumulator+currentValue)/(e.height_data.length-edge_size*2);if(!calibrating){e.height_average=e._height_average}}}eyebrow_up+=e.height/e._height_average});eyebrow_up/=2;eyebrow_up=(eyebrow_up-1)/.25*(eyebrow_up>1?2:1);if(_lips_width_average){if(lips_width>_lips_width_average*1.05){mouth_wide=Math.sqrt(Math.min((lips_width-_lips_width_average*1.05)/(_lips_width_average*.25),1))}else if(lips_width<_lips_width_average*.98){mouth_wide=-Math.sqrt(Math.min((_lips_width_average*.98-lips_width)/(_lips_width_average*.2),1))}if(lips_inner_height>2){mouth_open_x=Math.pow(Math.min((lips_inner_height-2)/(_lips_width_average*1/3),1),.5);if(mouth_wide>.25)smile=(mouth_wide-.25)/.75*.3}}let happy=0;let sad=0;let angry=0;let fear=0;let surprise=0;let tongue_out=0;const face_factor=_facemesh.face_width/Math.min(camera.video_canvas.width,camera.video_canvas.height);const _blink_factor=MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only||face_factor>.2?1:Math.max(1-(.2-face_factor)*8,0);let blink={L:[0],R:[0]};if(use_faceLandmarksDetection){["L","R"].forEach(function(dir){let i=0;blink[dir][i]=0;let LR=eye_data[dir][i];let e_data=face.faceBlendshapes?Math.max(1-face.faceBlendshapes.categories[faceBlendshapes_index["eyeBlink"+(dir=="L"?"Left":"Right")]].score*.9,.2):MMD_SA._v3a.fromArray(face.mesh[LR.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(face.mesh[LR.height_ref_pts[1]]));let _eye_open_average=LR.eye_open_average;if(!_eye_open_average){if(calibration_condition){LR.eye_open_data.push(e_data);let edge_size=parseInt(LR.eye_open_data.length*.3);_eye_open_average=LR.eye_open_data.sort((a,b)=>a-b).slice(edge_size,LR.eye_open_data.length-edge_size).reduce((accumulator,currentValue)=>accumulator+currentValue)/(LR.eye_open_data.length-edge_size*2);if(!calibrating){LR.eye_open_average=_eye_open_average}}else{_eye_open_average=LR._eye_open_average}}if(calibration_condition){if(LR.eye_open_lower>e_data)LR.eye_open_lower=e_data}LR._eye_open_average=_eye_open_average;if(_eye_open_average){if(e_data>_eye_open_average){blink[dir][i]=Math.min(e_data/_eye_open_average,1.25)}else{let _eye_open_lower=Math.min(LR.eye_open_lower,_eye_open_average/2);blink[dir][i]=Math.max((e_data-_eye_open_lower)/(_eye_open_average-_eye_open_lower),0)}}})}const use_faceBlendshapes=MMD_SA.THREEX.get_model(0).use_faceBlendshapes;if(face.faceBlendshapes){const b=face.faceBlendshapes.categories;const blink=[b[faceBlendshapes_index["eyeBlinkLeft"]].score,b[faceBlendshapes_index["eyeBlinkRight"]].score];blink.forEach((v,i)=>{const d=i==0?"L":"R";const e_data=eye_data[d][0];const eyeBlink_upper=1-(1-Math.max(e_data._eye_open_average||0,.5))*.8;const eyeBlink_lower=Math.min(e_data.eye_open_lower,.3);const blink_range=eyeBlink_upper-eyeBlink_lower;v=Math.min(Math.max(v-(1-eyeBlink_upper),0)/blink_range,1);blink[i]=v<.5?Math.pow(v*2,1.5)/2:Math.pow((v-.5)*2,.667)/2+.5});const use_eye_LR=!_facemesh.blink_sync;const blink_factor=(use_eye_LR?Math.min(Math.abs(blink[0]-blink[1])/.4,1):0)*_blink_factor;let blink0=use_eye_LR?Math.min(...blink):(blink[0]+blink[1])/2;b[faceBlendshapes_index["eyeBlinkLeft"]].score=blink[0]*blink_factor+blink0*(1-blink_factor);b[faceBlendshapes_index["eyeBlinkRight"]].score=blink[1]*blink_factor+blink0*(1-blink_factor);for(const p of["eyeSquintLeft","eyeSquintRight"]){const d=p=="eyeSquintLeft"?"L":"R";const eyeSquint_factor=Math.min(Math.max((eyebrow_data[d]._height_average||0)*.8,.2),.5);b[faceBlendshapes_index[p]].score=Math.max(b[faceBlendshapes_index[p]].score-eyeSquint_factor,0)/(1-eyeSquint_factor)}const mouthPucker_factor=Math.min(Math.max((_lips_width_average||0)*.8,.2),.6);b[faceBlendshapes_index["mouthPucker"]].score=Math.pow(Math.max(b[faceBlendshapes_index["mouthPucker"]].score-mouthPucker_factor,0)/(1-mouthPucker_factor),2);if(use_faceBlendshapes){b.forEach(c=>{const n=c.categoryName;let name=n.charAt(0).toUpperCase()+n.substring(1);name=name.indexOf("Left")!=-1?name.replace("Left","Right"):name.replace("Right","Left");frames.add("morph|facemesh",name,{weight:c.score})})}}if(Array.isArray(face.emotion)){face.emotion.forEach(e=>{switch(e.emotion){case"happy":happy+=e.score;break;case"sad":sad+=e.score;break;case"angry":case"disgust":angry+=e.score;break;case"fear":fear+=e.score;break;case"surprise":surprise+=e.score;break}})}const modelX=MMD_SA.THREEX.get_model(0);if(face.faceBlendshapes){const is_VRM=modelX.type=="VRM";const b=face.faceBlendshapes.categories;let jawOpen=b[faceBlendshapes_index["jawOpen"]].score;let smile=(b[faceBlendshapes_index["mouthSmileLeft"]].score+b[faceBlendshapes_index["mouthSmileRight"]].score)/2;let mouth_up=(b[faceBlendshapes_index["mouthUpperUpLeft"]].score+b[faceBlendshapes_index["mouthUpperUpRight"]].score)/2;let mouth_down=(b[faceBlendshapes_index["mouthLowerDownLeft"]].score+b[faceBlendshapes_index["mouthLowerDownRight"]].score)/2;let mouthPucker=b[faceBlendshapes_index["mouthPucker"]].score;let mouthFunnel=b[faceBlendshapes_index["mouthFunnel"]].score;let mouthShrugLower=b[faceBlendshapes_index["mouthShrugLower"]].score;mouthShrugLower*=mouthShrugLower;const f_sad=.3*(x_rot>0?1-Math.min(x_rot/(Math.PI/12),1):1);sad=Math.min(Math.max(mouthShrugLower-f_sad,0)/.7,1);if(x_rot<0){const f=Math.min(Math.abs(x_rot)/(Math.PI/4),1);sad=Math.pow(Math.max(sad-f*.5,0)/(1-f*.5),f*3)}let browInnerUp=b[faceBlendshapes_index["browInnerUp"]].score;browInnerUp*=browInnerUp;let brow_up=(b[faceBlendshapes_index["browOuterUpLeft"]].score+b[faceBlendshapes_index["browOuterUpRight"]].score)/2;let brow_down=(b[faceBlendshapes_index["browDownLeft"]].score+b[faceBlendshapes_index["browDownRight"]].score)/2;let a=0,i=0,u=0,e=0,o=0;const jawOpen_max_ini=.3;if(jawOpen<.2){if(mouthPucker>.1){u=mouthPucker;if(mouthFunnel>.1)o=(mouthFunnel-.1)/2}else{i=Math.min(mouth_up+mouth_down/2,1);e=Math.min(smile+mouth_up/2,1);const f=Math.min(smile/(mouth_up+mouth_down||.1),1);i*=1-f;e*=f}const af=1-Math.min(Math.max(i,u,e,o),.2)/.2;a=Math.pow(jawOpen/.2,1-jawOpen/.2*.35-af*.3)*jawOpen_max_ini;if(use_faceBlendshapes){jawOpen=a;frames.morph["JawOpen"][0].weight=jawOpen}}else{jawOpen=jawOpen_max_ini+(jawOpen-.2)/.8*(1-jawOpen_max_ini);if(use_faceBlendshapes)frames.morph["JawOpen"][0].weight=jawOpen;o=Math.min(jawOpen+mouthFunnel/2,1);a=Math.min(jawOpen+(smile+mouth_up)/3,1);if(mouthPucker>.1){const f=Math.min((mouthPucker-.1)*5,1);o*=f;a*=1-f}else{o=0}}if(mouthFunnel>.1){mouth_wide=-(mouthFunnel-.1)*.75}else{mouth_wide=Math.min(Math.max(smile-.2,0)*1+Math.max(mouth_up-.5,0)*1.5,1);if(mouth_wide>.5)e*=1-(mouth_wide-.5)*2*.25}happy=Math.min(Math.max(mouth_wide,0)-sad,1);if(happy<0){sad=-happy;happy=0}else{sad=0}const angry_mod=.2+mouthPucker/2;angry=Math.max(b[faceBlendshapes_index["mouthLeft"]].score-angry_mod,b[faceBlendshapes_index["mouthRight"]].score-angry_mod,0);smile=Math.min(happy*.8,is_VRM?.7-Math.max(happy*.4-.3,0):.6);happy*=.4;sad*=.5;angry=Math.max(angry-happy,0);let blush=Math.max(Math.max((b[faceBlendshapes_index["mouthPressLeft"]].score+b[faceBlendshapes_index["mouthPressRight"]].score)/2,(b[faceBlendshapes_index["mouthRollLower"]].score+b[faceBlendshapes_index["mouthRollUpper"]].score)/2)-.2,0);if(brow_down>.1){brow_up=-(brow_down-.1)/.9}else if(browInnerUp>.1&&brow_up>.1){brow_up=((browInnerUp-.1)/.9+(brow_up-.1)/.9)/2}let blink=(b[faceBlendshapes_index["eyeBlinkRight"]].score+b[faceBlendshapes_index["eyeBlinkLeft"]].score)/2;surprise=Math.max(brow_up-blink-.1,0);surprise=surprise*surprise/2;if(is_VRM)surprise=Math.min(surprise*Math.max(jawOpen*3,1),1);let tongue_out_rot_factor=1;const use_tongue_out_expression=_facemesh.use_tongue_out&&modelX.blendshape_map_by_MMD_name?.[""];const use_tongue_out=_facemesh.use_tongue_out&&(modelX.use_tongue_out||use_tongue_out_expression);let mouth_down_min=Math.min(b[faceBlendshapes_index["mouthLowerDownLeft"]].score,b[faceBlendshapes_index["mouthLowerDownRight"]].score);if(use_tongue_out&&mouth_down_min>.2){let mouth_up_max=Math.max(b[faceBlendshapes_index["mouthUpperUpLeft"]].score,b[faceBlendshapes_index["mouthUpperUpRight"]].score);tongue_out=Math.max(mouth_down_min-mouth_up_max*1.2,0);if(Math.abs(y_rot)>Math.PI/18){tongue_out_rot_factor=Math.max(1-(Math.abs(y_rot)-Math.PI/18)/(Math.PI/4),1/3);tongue_out*=tongue_out_rot_factor}if(tongue_out<.1){tongue_out=0}else{tongue_out=Math.min(tongue_out*(1+(b[faceBlendshapes_index["mouthDimpleLeft"]].score+b[faceBlendshapes_index["mouthDimpleRight"]].score)/2),1)}}let emotion_weight=_facemesh.emotion_weight_percent/100;if(use_faceBlendshapes)emotion_weight*=emotion_weight;for(const name in blendshape_accumulated){let v=blendshape_accumulated[name];let ew=_facemesh.emotion_weight_by_name(name,emotion_weight);let mod=-1,mod_scale=1;let max=is_VRM?1:ew*.8;let max_low=ew*.75;let b=0;let b_threshold;switch(name){case"sad":b=sad;b_threshold=.25;break;case"angry":b=angry;b_threshold=.25;break;case"surprise":b=surprise;if(is_VRM){b_threshold=.25}break;case"blush":b=blush;b_threshold=.2;mod_scale=.5;max=1;break;case"tongue_out":b=tongue_out;b_threshold=.2;max_low=.6;max=1;break}if(b_threshold){let scale=Math.min(b/b_threshold,1);scale*=scale;max=Math.min(b+Math.max(max-b,0)*scale*(scale<1?max_low:1),max);mod=b*scale*mod_scale}blendshape_accumulated[name]=THREE.Math.clamp(Math.max(v,b)+mod*_facemesh._t/1e3*4,0,max)}({sad,angry,surprise,blush,tongue_out}=blendshape_accumulated);if(tongue_out){if(use_tongue_out_expression){tongue_out=tongue_out<.5?Math.pow(tongue_out*2,2)/2:Math.pow((tongue_out-.5)*2,.5)/2+.5}else{if(tongue_out<.5){tongue_out=0}else{tongue_out=Math.sqrt(tongue_out);a*=1-tongue_out+tongue_out/2}}}if(use_faceBlendshapes&&!use_tongue_out_expression)frames.add("morph|facemesh","TongueOut",{weight:tongue_out});if(!is_VRM){emotion_weight=Math.min(emotion_weight/.75,1);if(blush)sad+=blush*.25*emotion_weight}const smile_weight=_facemesh.emotion_weight_by_name("smile",Math.sqrt(emotion_weight));smile*=smile_weight;happy*=smile_weight;sad=Math.min(sad,_facemesh.emotion_weight_by_name("sad",emotion_weight));angry=Math.min(angry,_facemesh.emotion_weight_by_name("angry",emotion_weight));blush=Math.min(blush,Math.min(_facemesh.emotion_weight_by_name("blush",emotion_weight)/.75,1));surprise=Math.min(surprise,_facemesh.emotion_weight_by_name("surprise",emotion_weight));if(is_VRM)surprise*=surprise;frames.add("morph|facemesh","",{weight:a});frames.add("morph|facemesh","",{weight:i});frames.add("morph|facemesh","",{weight:u});frames.add("morph|facemesh","",{weight:e});frames.add("morph|facemesh","",{weight:o});frames.add("morph|facemesh","",{weight:mouth_wide});frames.add("morph|facemesh","",{weight:mouth_up-mouthShrugLower});frames.add("morph|facemesh","",{weight:brow_up});frames.add("morph|facemesh","",{weight:smile});frames.add("morph|facemesh","",{weight:sad});frames.add("morph|facemesh","",{weight:angry});frames.add("morph|facemesh","",{weight:happy});frames.add("morph|facemesh","",{weight:surprise});frames.add("morph|facemesh","",{weight:blush});frames.add("morph|facemesh","",{weight:tongue_out});const use_eye_LR=!_facemesh.blink_sync&&THREE.MMD.getModels()[0].pmx.morphs_index_by_name["L"]!=null;if(use_eye_LR){frames.add("morph|facemesh","L",{weight:Math.max(b[faceBlendshapes_index["eyeBlinkRight"]].score-happy,0)});frames.add("morph|facemesh","R",{weight:Math.max(b[faceBlendshapes_index["eyeBlinkLeft"]].score-happy,0)});frames.add("morph|facemesh","",{weight:0})}else{frames.add("morph|facemesh","L",{weight:0});frames.add("morph|facemesh","R",{weight:0});frames.add("morph|facemesh","",{weight:Math.max(blink-happy,0)})}let eye_up,eye_right,two_eyes,eye_bone_rotation_weight;if(_facemesh.auto_look_at_camera){const mesh=THREE.MMD.getModels()[0].mesh;const eye_v3=MMD_SA.TEMP_v3.copy(MMD_SA._trackball_camera.object.position).sub(MMD_SA._head_pos).normalize().applyQuaternion(MMD_SA.get_bone_rotation(mesh,"").conjugate());const eye_rot=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(MMD_SA._v3a.set(0,0,1),eye_v3));eye_up=-Math.sign(eye_rot.x)*Math.min(Math.abs(eye_rot.x/(Math.PI/4)),1);eye_right=-Math.sign(eye_rot.y)*Math.min(Math.abs(eye_rot.y/(Math.PI/4)),1);eye_bone_rotation_weight=1}else{eye_up=(b[faceBlendshapes_index["eyeLookUpLeft"]].score+b[faceBlendshapes_index["eyeLookUpRight"]].score)/2-(b[faceBlendshapes_index["eyeLookDownLeft"]].score+b[faceBlendshapes_index["eyeLookDownRight"]].score)/2;eye_right=(b[faceBlendshapes_index["eyeLookInRight"]].score+b[faceBlendshapes_index["eyeLookOutLeft"]].score)/2-(b[faceBlendshapes_index["eyeLookInLeft"]].score+b[faceBlendshapes_index["eyeLookOutRight"]].score)/2;eye_bone_rotation_weight=_facemesh.eye_bone_rotation_percent/100}two_eyes={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-eye_up*15/180*Math.PI,-eye_right*20/180*Math.PI,0).multiplyScalar(eye_bone_rotation_weight),"YZX")};frames.add("skin|facemesh","",two_eyes)}else{let happy_abs=happy-(sad+angry+fear+surprise*.5);if(happy_abs<0){smile*=Math.max(1+happy_abs*2,0)}else{smile=Math.min(happy_abs*.2+smile*(1+happy_abs*.5),.4)}frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(Math.min(smile+happy*.75,.75))});frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(Math.min((sad+fear)/2*.75+(eyebrow_up<0?Math.max(-eyebrow_up*1-Math.max(mouth_wide,0)*.5,0):0),.75))});frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(Math.min(angry*.75,.75))});eyebrow_up+=surprise*.2;frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(smile)});frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(surprise*.75)});frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(mouth_wide)});let rot_inv=MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(x_rot,y_rot,z_rot),"YZX").conjugate();let L=[];[13,14,61,291].forEach(function(index,i){L[index]=_v3[i].fromArray(face.mesh[index]).applyQuaternion(rot_inv).setZ(0)});let L_center=MMD_SA._v3a.copy(L[61]).add(L[291]).multiplyScalar(.5);let L_half=L[61].distanceTo(L[291])*.5;let m_up=Math.atan2(L[13].y-L_center.y,L_half);let m_down=Math.atan2(L[14].y-L_center.y,L_half);let mouth_open_y=Math.max(-(m_up+m_down)*180/Math.PI+20*mouth_open_x,0);if(mouth_open_y)mouth_open_y=Math.min(mouth_open_y/20,.75);mouth_open_y=Math.min(mouth_open_y+sad*.25,1);mouth_open_y*=.5;mouth_open_x=mouth_open_x*(1-mouth_open_y);frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(mouth_open_x)});frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(mouth_open_y)});let _eye_data_order={L:[],R:[]};if(!_facemesh.eye_tracking){}else if(use_faceLandmarksDetection){let _eye_x_rot=[0,0];let _eye_y_rot=[0,0];face.eyes.forEach(function(eye,i){if(eye){_eye_x_rot[i]=Math.max(Math.min((eye[3]*2+x_rot/(Math.PI/2))*(1-Math.abs(x_rot)/Math.PI),1),-1);_eye_y_rot[i]=Math.max(Math.min((eye[2]*2-y_rot/(Math.PI/2))*(1-Math.abs(y_rot)/Math.PI),1),-1)}});let eyebrow_factor=(blink.L[0]+blink.R[0])/2;if(eyebrow_factor>1)eyebrow_up+=(eyebrow_factor-1)*2;else eyebrow_up-=(1-eyebrow_factor)*.5;eyebrow_up=Math.min(eyebrow_up,1);let rot_ratio=blink.L[0]+blink.R[0];if(rot_ratio)rot_ratio=blink.L[0]/rot_ratio;else rot_ratio=.5;let eye_x_rot=_eye_x_rot[0]*rot_ratio+_eye_x_rot[1]*(1-rot_ratio);let eye_y_rot=_eye_y_rot[0]*rot_ratio+_eye_y_rot[1]*(1-rot_ratio);let two_eyes={absolute:true,rot:(new THREE.Quaternion).fromArray(facemesh_filter[""].filter(MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(-(eye_x_rot-.3)*15/180*Math.PI,eye_y_rot*sign_flip*20/180*Math.PI,0),"YZX").toArray()))};frames.add("skin|facemesh","",two_eyes);let use_eye_LR=!_facemesh.blink_sync&&THREE.MMD.getModels()[0].pmx.morphs_index_by_name["L"]!=null;let blink_factor=(use_eye_LR?Math.min(Math.max(Math.abs(blink.L[0]-blink.R[0])-(.25+(1-Math.min(Math.max((Math.PI/6-Math.abs(y_rot))/(Math.PI/12),0),1))*1),0)/.25,1):0)*_blink_factor;let blink0=use_eye_LR?Math.min(blink.L[0],blink.R[0]):(blink.L[0]+blink.R[0])/2;blink.L[0]=blink.L[0]*blink_factor+blink0*(1-blink_factor);blink.R[0]=blink.R[0]*blink_factor+blink0*(1-blink_factor);if(use_eye_LR){let blink_name=""+(sign_flip==1?"L":"R");frames.add("morph|facemesh",blink_name,{weight:facemesh_filter[blink_name].filter(Math.max(Math.min(1-blink.L[0]*.8-smile,1),0))});blink_name=""+(sign_flip==1?"R":"L");frames.add("morph|facemesh",blink_name,{weight:facemesh_filter[blink_name].filter(Math.max(Math.min(1-blink.R[0]*.8-smile,1),0))});frames.add("morph|facemesh","",{weight:0})}else{frames.add("morph|facemesh","L",{weight:0});frames.add("morph|facemesh","R",{weight:0});frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(Math.max(Math.min(1-blink.L[0]*.8-smile,1),0))})}}else{let eye=face.eyes[0];let eye_x_rot=0;let eye_y_rot=0;if(eye){eye_x_rot=Math.max(Math.min((eye[3]*2+x_rot/(Math.PI/2))*(1-Math.abs(x_rot)/Math.PI),1),-1);eye_y_rot=Math.max(Math.min((eye[2]*2-y_rot/(Math.PI/2))*(1-Math.abs(y_rot)/Math.PI),1),-1)}let eyebrow_factor=eyebrow_up*.25;if(eyebrow_factor<0)eyebrow_factor=Math.min(eyebrow_factor+smile,0);let weight=Math.max(Math.min(.1-eye_x_rot*(eye_x_rot<0?2:1)*.2-eyebrow_factor,.5),0);frames.add("morph|facemesh","",{weight:weight});let eye_rot_confidence=1.25+Math.pow((blink.L[0]+blink.R[0])/2,2)*1.75;eye_x_rot=Math.sign(eye_x_rot)*Math.pow(Math.abs(eye_x_rot),eye_rot_confidence);eye_y_rot=Math.sign(eye_y_rot)*Math.pow(Math.abs(eye_y_rot),eye_rot_confidence);let two_eyes={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-eye_x_rot*15/180*Math.PI,eye_y_rot*sign_flip*20/180*Math.PI,0),"YZX")};frames.add("skin|facemesh","",two_eyes)}if(_facemesh.eye_tracking)frames.add("morph|facemesh","",{weight:facemesh_filter[""].filter(Math.max(Math.min(eyebrow_up,1),-1))})}if(!_poseNet.enabled){if(!frames.skin[""])frames.add("skin","",{rot:new THREE.Quaternion});const motion_para=MMD_SA.MMD.motionManager.para_SA;if(motion_para.motion_tracking_upper_body_only){for(const d of["",""]){const state=true;if(motion_para.has_leg_IK){frames.set_blend_default_motion("skin",d+"",true);frames.remove("skin",d+"")}else{frames.set_blend_default_motion("skin",d+"",true);frames.set_blend_default_motion("skin",d+"",true);frames.set_blend_default_motion("skin",d+"",true)}_poseNet.enable_IK(d+"",motion_para.has_leg_IK);_poseNet.enable_IK(d+"",motion_para.has_leg_IK);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);frames.set_blend_default_motion("skin",d+"",state);_poseNet.enable_IK(d+"",true)}}else{for(const d of["",""]){_poseNet.enable_IK(d+"",motion_para.has_arm_IK)}frames.remove("skin","")}}info=info||face.eyes.length&&[(!_poseNet.enabled?camera.video_canvas.width+"x"+camera.video_canvas.height+"("+_facemesh.camera_video_frame_id+")\n":"")+(calibrating?"Calibrating("+calibration_percent+"%):Make a calm face!":"(face data calibrated)")+"/"+Math.round(face.faceInViewConfidence*100)+"%",face.emotion?JSON.stringify(face.emotion):"Neutral"].join("\n");if(_info_extra_facemesh)info+="\n"+_info_extra_facemesh;info+=(_info_extra||!_poseNet.enabled?DEBUG_msg?"\n"+DEBUG_msg+"\n":"":"")+(_info_extra||"");System._browser.motion_control.process(motion_control_data)}else{info="(no facemesh data)\n"+_info_extra}if(!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden){System._browser.on_animation_update.add(()=>{DEBUG_show(info&&info+(!_poseNet.enabled||!_poseNet.use_holistic?"\nF-FPS:"+Math.round(fps)+"/"+Math.round(data.fps||0):"")+"\n"+"FPS:"+EV_sync_update.fps_last||"")},0,0)}_facemesh.busy=0}_facemesh.update_frame()}}();var canvas_resized=document.createElement("canvas");var eye_tracking=true;var use_tongue_out;var emotion_weight_percent,emotion_joy_fun_percent,emotion_angry_percent,emotion_sorrow_percent,emotion_surprised_percent,emotion_others_percent;var eye_bone_rotation_percent;var bb_center=[];var _data_detected=0;var _data_detected_ini_timestamp=0;_facemesh={initialized:false,worker_initialized:false,faceBlendshapes_list:faceBlendshapes_list,MMD_morph_list:MMD_morph_list,get data_detected(){return _data_detected},set data_detected(v){if(v){if(!_data_detected){_data_detected_ini_timestamp=RAF_timestamp}}else{_data_detected_ini_timestamp=0}_data_detected=v},get data_detected_stable(){return enabled&&_data_detected_ini_timestamp&&RAF_timestamp-_data_detected_ini_timestamp>250},get head_pose_enabled(){return this.data_detected_stable||!_poseNet.enabled},get blink_detection(){return blink_detection},set blink_detection(v){blink_detection=v;if(enabled){if(blink_detection){reset_calibration()}else{MMD_SA_options.auto_blink=auto_blink_default!=null?auto_blink_default:MMD_SA_options.auto_blink}}},get auto_blink(){return auto_blink},set auto_blink(v){auto_blink=v},get eye_bone_rotation_percent(){return eye_bone_rotation_percent==null?100:eye_bone_rotation_percent},set eye_bone_rotation_percent(v){eye_bone_rotation_percent=v},get eye_tracking(){return eye_tracking},set eye_tracking(v){eye_tracking=v;if(eye_tracking){this.blink_detection=!!use_faceLandmarksDetection}else{this.blink_detection=false}if(enabled){if(!eye_tracking){frames.remove("skin","");frames.remove("morph","L");frames.remove("morph","R");frames.remove("morph","");frames.remove("morph","");frames.remove("morph","")}}},get use_faceLandmarksDetection(){return use_faceLandmarksDetection},set use_faceLandmarksDetection(v){if(!this.initialized)use_faceLandmarksDetection=v},get use_mediapipe(){return use_mediapipe_facemesh||_poseNet.enabled&&_poseNet.use_holistic},set use_mediapipe(v){return use_mediapipe_facemesh=v},get use_faceBlendshapes(){return!_poseNet.enabled||!_poseNet.use_holistic},get calibrated(){return!calibrating&&calibration_percent>=100},get use_tongue_out(){return use_tongue_out==null?1:use_tongue_out},set use_tongue_out(v){use_tongue_out=v},get emotion_weight_percent(){return emotion_weight_percent==null?75:emotion_weight_percent},set emotion_weight_percent(v){emotion_weight_percent=v},get emotion_joy_fun_percent(){return emotion_joy_fun_percent==null?100:emotion_joy_fun_percent},set emotion_joy_fun_percent(v){emotion_joy_fun_percent=v},get emotion_angry_percent(){return emotion_angry_percent==null?100:emotion_angry_percent},set emotion_angry_percent(v){emotion_angry_percent=v},get emotion_sorrow_percent(){return emotion_sorrow_percent==null?100:emotion_sorrow_percent},set emotion_sorrow_percent(v){emotion_sorrow_percent=v},get emotion_surprised_percent(){return emotion_surprised_percent==null?100:emotion_surprised_percent},set emotion_surprised_percent(v){emotion_surprised_percent=v},get emotion_others_percent(){return emotion_others_percent==null?100:emotion_others_percent},set emotion_others_percent(v){emotion_others_percent=v},emotion_weight_by_name:function(name,v=1){switch(name){case"smile":return v*this.emotion_joy_fun_percent/100;case"angry":return v*this.emotion_angry_percent/100;case"sad":return v*this.emotion_sorrow_percent/100;case"surprise":return v*this.emotion_surprised_percent/100;case"blush":return v*this.emotion_others_percent/100;default:return v}},export_calibration:function(){const c_json={facemesh_calibration_type:_poseNet.use_holistic?"holistic":"facemesh",lips_width_average:lips_width_average,eyebrow_data:{L:{height_average:eyebrow_data.L.height_average},R:{height_average:eyebrow_data.R.height_average}},eye_data:{L:{eye_open_average:eye_data.L[0].eye_open_average},R:{eye_open_average:eye_data.R[0].eye_open_average}},neck_length_average:neck_length_average};System._browser.save_file("facemesh_calibration.json",JSON.stringify(c_json,null,"\t"),"application/json")},import_calibration:function(json){this.reset_calibration();lips_width_average=json.lips_width_average;for(const dir of["L","R"]){Object.assign(eyebrow_data[dir],json.eyebrow_data[dir]);Object.assign(eye_data[dir][0],json.eye_data[dir])}neck_length_average=json.neck_length_average||1.25;calibration_percent=100;calibrating=false},face_width:0,_neck:{},calculate_neck_data:(()=>{let v3a,v3b,v3c;let q1;let neck_length_filter;window.addEventListener("jThree_ready",()=>{v3a=new THREE.Vector3;v3b=new THREE.Vector3;v3c=new THREE.Vector3;q1=new THREE.Quaternion;neck_length_filter=new System._browser.data_filter([{type:"one_euro",id:"neck_length",para:[30,1,1,1,1]}])});return function(para){if(!_poseNet.enabled||!_facemesh.enabled||!this._neck.data)return false;let p=this._neck.data.find(d=>d.timestamp===para.timestamp);if(!p){this._neck.data.unshift(para);return false}Object.assign(p,para);if(!(p.is_pose&&p.is_face))return false;const f_axis=v3a.fromArray(p.f_axis);const s_axis=v3b.fromArray(p.shoulder_center).setZ(0);const mod=v3c.set(0,0,p.face_width/3).applyQuaternion(q1.fromArray(p.face_rot).conjugate()).setZ(0).y;const motion_para=MMD_SA.MMD.motionManager.para_SA;let tilt_adjustment=motion_para.motion_tracking?.camera?.tilt_adjustment||camera.tilt_adjustment;let tilt_angle=tilt_adjustment.enabled?tilt_adjustment.angle*Math.PI/180:0;const _pose=motion_para.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(_pose.upper_rotation_offset){const y=_pose.upper_rotation_offset*Math.PI/180;tilt_angle*=Math.cos(y)}const spine_rot_x=p.spine_rot_absolute[0]+tilt_angle;this._neck._spine_rot_absolute=p.spine_rot_absolute.slice();this._neck._spine_rot_absolute[0]+=tilt_angle;let neck_length=neck_length_filter.filter(f_axis.distanceTo(s_axis)+mod)/p.face_width/Math.max(Math.abs(Math.cos(spine_rot_x)));if(calibrating){window.addEventListener("SA_camera_facemesh_calibrating",()=>{neck_length_data.push(neck_length);let edge_size=parseInt(neck_length_data.length*.3);neck_length_average=neck_length_data.sort((a,b)=>a-b).slice(edge_size,neck_length_data.length-edge_size).reduce((accumulator,currentValue)=>accumulator+currentValue)/(neck_length_data.length-edge_size*2)},{once:true})}this._neck.data.length=0;if(!neck_length_average)return false;let r=neck_length/neck_length_average;shoulder_z_angle[2]=!_poseNet.shoulder_tracking||r>.95?0:(1-Math.max((r/.95-.8)/(1-.8),0))*Math.PI/8;if(para.is_pose)return true;return true}})(),get enabled(){return enabled},set enabled(v){if(enabled==!!v)return;enabled=!!v;pose_init_core();this.busy=0;this.data_detected=0;bb_center[0]=bb_center[1]=.5;this._neck={data:[]};if(enabled){if(!this.initialized)init();auto_blink_default=MMD_SA_options.auto_blink;const _facemesh_type=_poseNet.use_holistic?1:0;reset_calibration(facemesh_type!=_facemesh_type);facemesh_type=_facemesh_type}else{MMD_SA_options.auto_blink=auto_blink_default}ML_init()},get bb_center(){return bb_center},set bb_center(v){bb_center=v},reset_calibration:reset_calibration,get frames(){return frames},init:init,worker_onmessage:facemesh_worker_onmessage,camera_video_timestamp:0,update_frame:function(delay_update){async function update_worker(){var ready=_facemesh.enabled&&_facemesh.worker_initialized&&camera_video_timestamp&&!_facemesh.busy&&!(_poseNet.enabled&&_poseNet.use_holistic)&&video_capture_active&&_facemesh.camera_video_timestamp!=camera_video_timestamp;if(!ready)return;_facemesh.busy=RAF_timestamp;_facemesh.camera_video_timestamp=camera_video_timestamp;_facemesh.camera_video_frame_id=camera_video_frame_id;if(blink_detection){MMD_SA_options.auto_blink=auto_blink||false}let video_canvas;let cw,ch;let sw,sh;let sx,sy;let need_resize;video_canvas=camera.video_canvas;let vw=video_canvas.width,vh=video_canvas.height;sx=sy=0;cw=sw=vw;ch=sh=vh;let target_ratio=1;let limit=MMD_SA_options.user_camera.pixel_limit.facemesh;if(limit){if(cw*ch>limit[0]*limit[1]){target_ratio=Math.sqrt(cw*ch/(limit[0]*limit[1]));cw=sw=Math.round(cw/target_ratio);ch=sh=Math.round(ch/target_ratio);video_canvas=canvas_resized;need_resize=true}}let facemesh_bb_ratio,facemesh_bb_scale,d;if(MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio){facemesh_bb_ratio=MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio;d=Math.round(Math.min(cw,ch)*facemesh_bb_ratio);sw=d;sh=d;let bb_scale=1;const threshold=5*(use_mediapipe_facemesh?2:1);if(_facemesh.data_detected<threshold&&facemesh_bb_ratio<1&&!_poseNet.enabled){bb_scale=facemesh_bb_ratio+(1-facemesh_bb_ratio)*(1-Math.min(_facemesh.data_detected/threshold,1));d=Math.round(Math.min(cw,ch)*bb_scale);facemesh_bb_scale=facemesh_bb_ratio/bb_scale;facemesh_bb_ratio=bb_scale;video_canvas=canvas_resized;need_resize=true}sx=Math.max(Math.min(cw*bb_center[0]-d/2,cw-d),0)*(facemesh_bb_scale||1);sy=Math.max(Math.min(ch*bb_center[1]-d/2,ch-d),0)*(facemesh_bb_scale||1)}let ctx=video_canvas.getContext("2d");if(need_resize){ctx.globalCompositeOperation="copy";let _sx=sx,_sy=sy,_sw=sw,_sh=sh;if(facemesh_bb_scale){_sw=_sh=d;if(video_canvas.width!=sw||video_canvas.height!=sh){video_canvas.width=sw;video_canvas.height=sh;console.log("Facemesh canvas("+cw+"x"+ch+"=>"+sw+"x"+sh+"):"+[_sx,_sy,d,d].join(",")+"=>"+[sx,sy,sw,sh].join(","))}}else{if(video_canvas.width!=sw||video_canvas.height!=sh){video_canvas.width=sw;video_canvas.height=sh;console.log("Facemesh canvas("+cw+"x"+ch+")")}}ctx.drawImage(camera.video_canvas,Math.round(_sx*target_ratio),Math.round(_sy*target_ratio),Math.round(_sw*target_ratio),Math.round(_sh*target_ratio),0,0,sw,sh)}let rgba=use_imagebitmap&&use_mediapipe_facemesh?await createImageBitmap(video_canvas,need_resize?0:sx,need_resize?0:sy,sw,sh):ctx.getImageData(need_resize?0:sx,need_resize?0:sy,sw,sh).data.buffer;_facemesh._timestamp=camera.video_timestamp;let data={rgba:rgba,w:cw*(facemesh_bb_scale||1),h:ch*(facemesh_bb_scale||1),options:{use_facemesh:true,draw_canvas:true,flip_canvas:camera.display_flipped,bb:{x:Math.round(sx),y:Math.round(sy),w:sw,h:sh,ratio:facemesh_bb_ratio||0,scale:facemesh_bb_scale||1,timestamp:_facemesh._timestamp}}};if(self.FacemeshAT){data.canvas=camera.video_canvas_facemesh}else if(!camera.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){data.canvas=camera.video_canvas_facemesh.transferControlToOffscreen();camera.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}fm_worker.postMessage(data,data.canvas?[data.canvas,data.rgba]:[data.rgba]);data.rgba=rgba=undefined;data=undefined}if(delay_update||self.FacemeshAT){setTimeout(()=>{update_worker()},0)}else{update_worker()}}};return _facemesh}(),poseNet:function(){var enabled=false;var _use_3D_pose=true;var _IK_disabled=true;var _IK_enabled_list={};var _use_holistic=null;var _data_detected=0;var _data_detected_ini_timestamp=0;var _no_data_detected_ini_timestamp=0;var _auto_grounding=null;var _ground_plane_visible=null;var _spine_length_ref=0;var shoulder_tracking;var hip_adjustment_weight_percent,hip_adjustment_head_weight_percent,hip_adjustment_adjust_y_axis_percent,hip_adjustment_smoothing_percent;var hip_adjustment_scale_x_percent,hip_adjustment_scale_y_percent,hip_adjustment_scale_z_percent;_poseNet={get enabled(){return enabled},set enabled(v){if(enabled==!!v)return;enabled=!!v;pose_busy=0;_no_pose_data=false;this.data_detected=0;this.initial_data_detected=false;_no_data_detected_ini_timestamp=0;THREE.MMD.getModels()[0].mesh.visible=true;pos_offset_last.set(0,0,0);if(enabled){if(!this.initialized)pose_init();if(pose_worker_url){worker_id=_poseNet.use_holistic?"legacy_holistic":"tasks_vision";if(!pose_workers[worker_id]){ML_warmed_up_status=[{},{}];pose_worker.terminate();for(const id in pose_workers)delete pose_workers[id];pose_worker=new Worker(pose_worker_url);pose_worker.onmessage=pose_worker_onmessage;pose_worker_id=worker_id;pose_workers[pose_worker_id]=new PoseWorker(pose_worker_id,pose_worker)}console.log("Web worker ID:"+pose_worker_id);pose_worker=pose_workers[pose_worker_id].worker;pose_worker_initialized=pose_workers[pose_worker_id].initialized}MMD_SA_options.user_camera.ML_models.pose.events.enabled&&MMD_SA_options.user_camera.ML_models.pose.events.enabled()}else{THREE.MMD.getModels()[0].resetPhysics();MMD_SA_options.user_camera.ML_models.pose.events.disabled&&MMD_SA_options.user_camera.ML_models.pose.events.disabled()}ML_init();if(_poseNet.use_holistic){setTimeout(()=>{if(enabled)_facemesh.enabled=_handpose.enabled=true;else _handpose.enabled=false;DEBUG_show("(Holistic Mode:"+(enabled?"ON":"OFF")+")",2)},0)}},get data_detected(){return _data_detected},set data_detected(v){if(1){if(v){if(!_data_detected){_data_detected_ini_timestamp=RAF_timestamp}if(this.data_detected_stable){_no_data_detected_ini_timestamp=0}}else{_data_detected_ini_timestamp=0;if(!_no_data_detected_ini_timestamp){_no_data_detected_ini_timestamp=RAF_timestamp}if(RAF_timestamp-_no_data_detected_ini_timestamp>250){frames.reset()}}}_data_detected=v},get data_detected_stable(){return enabled&&(!_no_data_detected_ini_timestamp||RAF_timestamp-_no_data_detected_ini_timestamp<250||_data_detected_ini_timestamp&&RAF_timestamp-_data_detected_ini_timestamp>500)},get use_3D_pose(){return enabled&&_use_3D_pose&&use_blazepose},set use_3D_pose(v){_use_3D_pose=v},get use_holistic(){return _use_holistic==null?use_holistic:_use_holistic},set use_holistic(v){_use_holistic=v},get _use_holistic_(){return use_holistic},set _use_holistic_(v){use_holistic=v},get skip_hand_countdown_max(){return 0},set IK_disabled(v){_IK_disabled=v},get auto_grounding(){return _auto_grounding!=null?_auto_grounding:MMD_SA_options.user_camera.ML_models.pose.auto_grounding||MMD_SA.WebXR.session},set auto_grounding(v){_auto_grounding=v},get ground_plane_visible(){return _ground_plane_visible!=null?_ground_plane_visible:!enabled||!!MMD_SA_options.user_camera.ML_models.pose.auto_grounding||MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only},set ground_plane_visible(v){_ground_plane_visible=v},get spine_length_ref(){if(_spine_length_ref)return _spine_length_ref;const spine_ratio=MMD_SA_options.model_para_obj.left_leg_length/MMD_SA_options.model_para_obj.spine_length;return _poseNet.leg_scale_adjustment?Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length*(spine_ratio/1.83))*(21-_poseNet.leg_scale_adjustment)/20:Math.max(4.97462,MMD_SA_options.model_para_obj.spine_length)},set spine_length_ref(v){_spine_length_ref=v},get shoulder_tracking(){return shoulder_tracking==null?1:shoulder_tracking},set shoulder_tracking(v){shoulder_tracking=v},get hip_adjustment_weight_percent(){return hip_adjustment_weight_percent==null?100:hip_adjustment_weight_percent},set hip_adjustment_weight_percent(v){hip_adjustment_weight_percent=v},get hip_adjustment_head_weight_percent(){return hip_adjustment_head_weight_percent==null?100:hip_adjustment_head_weight_percent},set hip_adjustment_head_weight_percent(v){hip_adjustment_head_weight_percent=v},get hip_adjustment_adjust_y_axis_percent(){return hip_adjustment_adjust_y_axis_percent==null?66:hip_adjustment_adjust_y_axis_percent},set hip_adjustment_adjust_y_axis_percent(v){hip_adjustment_adjust_y_axis_percent=v},get hip_adjustment_scale_x_percent(){return hip_adjustment_scale_x_percent==null?100:hip_adjustment_scale_x_percent},set hip_adjustment_scale_x_percent(v){hip_adjustment_scale_x_percent=v},get hip_adjustment_scale_y_percent(){return hip_adjustment_scale_y_percent==null?100:hip_adjustment_scale_y_percent},set hip_adjustment_scale_y_percent(v){hip_adjustment_scale_y_percent=v},get hip_adjustment_scale_z_percent(){return hip_adjustment_scale_z_percent==null?100:hip_adjustment_scale_z_percent},set hip_adjustment_scale_z_percent(v){hip_adjustment_scale_z_percent=v},get hip_adjustment_smoothing_percent(){return hip_adjustment_smoothing_percent==null?0:hip_adjustment_smoothing_percent},set hip_adjustment_smoothing_percent(v){hip_adjustment_smoothing_percent=v},leg_scale_adjustment:0,IK_disabled_check:function(){var RE_default=new RegExp("("+toRegExp(["","",""],"|")+")$");var RE_default_upper_body=new RegExp("("+toRegExp([""],"|")+")$");return function(name){const para_SA=MMD_SA.MMD.motionManager.para_SA;if(!_IK_disabled||!this.data_detected&&(this.enabled||!_facemesh.enabled||!_facemesh.data_detected)||!para_SA.motion_tracking_enabled)return null;let disabled=!name||RE_default.test(name);if(disabled&&name){if(_IK_enabled_list[name])disabled=false}return disabled}}(),enable_IK:function(name,enabled){_IK_enabled_list[name]=enabled},get frames(){return frames},camera_video_timestamp:0,get busy(){return pose_busy},get initialized(){return pose_initialized},get worker_initialized(){return pose_worker_initialized},set worker_initialized(v){pose_worker_initialized=v;if(!self.PoseAT)pose_workers[pose_worker_id].initialized=v}};return _poseNet}(),handpose:function(){var enabled=false;var hand_visible_timestamp={};var hand_visible_session={};var stabilize_arm,stabilize_arm_time;var stabilize_hand_percent;_handpose={get enabled(){return enabled},set enabled(v){if(enabled==!!v)return;enabled=!!v;if(enabled){hand_visible_timestamp={};hand_visible_session={};if(!this.initialized)pose_init()}},get hand_visible_timestamp(){return hand_visible_timestamp},get hand_visible_session(){return hand_visible_session},get frames(){return frames},get busy(){return pose_busy},get initialized(){return pose_initialized},get worker_initialized(){return pose_worker_initialized},set worker_initialized(v){pose_worker_initialized=pose_workers[pose_worker_id].initialized=v},get stabilize_arm(){return stabilize_arm==null?2:stabilize_arm},set stabilize_arm(v){stabilize_arm=v},get stabilize_arm_time(){return stabilize_arm_time==null?0:stabilize_arm_time},set stabilize_arm_time(v){stabilize_arm_time=v},get stabilize_hand_percent(){return stabilize_hand_percent==null?20:stabilize_hand_percent},set stabilize_hand_percent(v){stabilize_hand_percent=v},_hand_last:{"":{},"":{}}};return _handpose}(),reset_video_canvas:function(){if(this.video_canvas){this.video_canvas.width=this.video_canvas.height=camera_video_timestamp=0;camera_video_frame_id=""}},show:function(){if(!this.initialized||this.visible)return;this.visible=true;if(camera.target_devicePixelRatio!=window.devicePixelRatio){camera.target_devicePixelRatio=0;camera.video_track.applyConstraints(camera.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)})["catch"](function(err){DEBUG_show("ERROR:camera size failed to update")})}add_video_capture();if(this.hidden_enforced)this.hide()},hide:function(){if(!this.initialized||!this.visible)return;this.visible=false;this.video_canvas.style.visibility="hidden";face_detection.enabled=false;_bodyPix.enabled=false;remove_video_capture()},set_constraints:function(constraints_extra){var constraints={};const DPR=window.devicePixelRatio/this.target_devicePixelRatio;let w,h;const ratio=is_mobile?Math.min(270/Math.min(window.innerWidth,window.innerHeight),DPR):DPR;w=Math.round(window.innerWidth*ratio);h=Math.round(window.innerHeight*ratio);var limit=MMD_SA_options.user_camera.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_;if(!target_devicePixelRatio){if(MMD_SA_options.user_camera.pixel_limit.fixed){w=limit[0];h=limit[1]}else if(w*h>limit[0]*limit[1]){const target_ratio=Math.sqrt(w*h/(limit[0]*limit[1]));w=Math.round(w/target_ratio);h=Math.round(h/target_ratio)}}camera.target_width=w;camera.target_height=h;if(!MMD_SA_options.user_camera.pixel_limit.disabled){if(!is_mobile||!screen.orientation||/landscape/.test(screen.orientation.type)){constraints.width=w;constraints.height=h}else{constraints.width=h;constraints.height=w}}if(MMD_SA_options.user_camera.fps)constraints.frameRate=MMD_SA_options.user_camera;if(constraints_extra)constraints=Object.assign(constraints,constraints_extra);console.log("Camera constraints",constraints);return constraints}};return camera}(),data_filter:function(){class pass_through{constructor(){}filter(data){return data}}class data_filter{constructor(filters){this.filters=filters;filters.forEach(f=>{switch(f.type){case"one_euro":if(f.transition_time){f.para[1]=1/(1/(1/f.transition_time/60)-1)*60/(2*Math.PI);console.log("transition_time => minCutoff",f.para[1])}f.filter=new OneEuroFilter(...f.para||[]);break}if(f.id)f.filter.id=f.id})}filter(data,timestamp=System._browser.camera.initialized&&System._browser.camera.ML_enabled?System._browser.camera.video_timestamp:RAF_timestamp){if(data!=null){this.filters.forEach(f=>{if(!f.condition||f.condition()){this.data=f.filter.filter(data,timestamp);this.timestamp=RAF_timestamp}})}return this.data}}return data_filter}(),motion_control:function(){var getActiveWindow,Point,centerOf,mouse,keyboard,Key;var GE_common;var handedness;var keys=function(){var key_pressed={};var key_map={};return{pressed:key_pressed,map:key_map,temp:{},set_options:function(options){if(!initialized)return;if(!options.timeout_list){const list=["W","A","S","D"];for(const side of["L","R"]){for(const name in options[side]){const action=options[side][name];if(action.press)list.push(...action.press)}}options.timeout_list=list.map(k=>Key[k])}if(!options.clear_list)options.clear_list={};for(const side of["L","R"]){if(!options.clear_list[side]){const list=side=="L"?["W","A","S","D"]:[];for(const name in options[side]){const action=options[side][name];if(action.press)list.push(...action.press)}options.clear_list[side]=list.map(k=>[Key[k]])}}this.temp={};Object.assign(key_map,options);console.log(key_map)},action:function(ge,side,id){var obj=key_map[side][id]||{};return{press:obj.press&&(!obj.press_check||obj.press_check(ge))&&obj.press||[],release:obj.release||[],click:obj.click&&(!obj.click_check||obj.click_check(ge))&&obj.click||[]}},activate:async function(ge,side,id,k_to_release=[]){const action=this.action(ge,side,id);if(action.click.length)await keys.click(...action.click.map(k=>[Key[k]]));if(action.press.length){const k_to_press=action.press.map(k=>Key[k]);k_to_release=[...k_to_release.filter(k=>k_to_press.indexOf(k[0])==-1),...action.release.map(k=>[Key[k]])];if(k_to_release.length)await keys.releaseKey(...k_to_release);await keys.pressKey(...k_to_press.map(k=>[k]))}},clear_list:function(side){return key_map.clear_list[side]},pressKey:async function(...ks){let ks_filtered=Array.isArray(ks[0])&&ks||[ks];var promise_list=[];for(const _ks of ks_filtered){const ks_to_press=_ks.filter(k=>!key_pressed[k]);if(ks_to_press.length){for(const k of ks_to_press)key_pressed[k]=-1;await keyboard.pressKey(...ks_to_press);const ks_to_release=ks_to_press.filter(k=>key_pressed[k]==-2);if(ks_to_release.length){await keyboard.releaseKey(...ks_to_release);for(const k of ks_to_release)key_pressed[k]=0;console.log("key released enforced",ks_to_release.length)}}for(const k of _ks){if(key_pressed[k])key_pressed[k]=RAF_timestamp}}},releaseKey:async function(...ks){const ks_filtered=!ks.length?Object.keys(key_pressed).map(k=>[parseInt(k)]):Array.isArray(ks[0])&&ks||[ks];const promise_list=[];for(const _ks of ks_filtered){const ks_to_release=_ks.filter(k=>key_pressed[k]>0);if(ks_to_release.length){promise_list.push(keyboard.releaseKey(...ks_to_release).then(()=>{for(const k of ks_to_release)key_pressed[k]=0}))}const ks_waiting=_ks.filter(k=>key_pressed[k]<0);ks_waiting.forEach(k=>{key_pressed[k]=-2})}if(promise_list.length){await Promise.all(promise_list)}},releaseIdleKey:async function(...ks){const ks_filtered=!ks.length?Object.keys(key_pressed).map(k=>[parseInt(k)]):Array.isArray(ks[0])&&ks||[ks];const ks_to_release=ks_filtered.map(k_array=>k_array.filter(k=>key_pressed[k]&&(key_map.timeout_list.indexOf(k)==-1||RAF_timestamp-(key_pressed[k]>0?key_pressed[k]:RAF_timestamp)>500))).filter(k_array=>k_array.length);if(ks_to_release.length){await keys.releaseKey(...ks_to_release)}},click:async function(...ks){const ks_filtered=Array.isArray(ks[0])&&ks||[ks];await this.pressKey(...ks_filtered);await this.releaseKey(...ks_filtered)}}}();var gestures={custom:{},list:[],estimate:function(GE,handpose,score=9){const estimatedGestures=GE.estimate(handpose.keypoints,score);if(estimatedGestures.gestures.length){estimatedGestures.gestures.forEach(ge=>{ge._d=handpose._d;ge.hand_facing=this.list[0].hand_facing[handpose._d];ge.hand_rot_YXZ=this.list[0].hand_rot_YXZ[handpose._d];ge.thumb_out=this.list[0].thumb_out[handpose._d];ge.poseData=estimatedGestures.poseData});this.list[0].gestures=this.list[0].gestures.concat(estimatedGestures.gestures)}return estimatedGestures},search:function(name,para={}){function find(g){return g.gestures.find(ge=>name.split("|").some(name=>ge.name==name&&(!para.hand||para.hand._d==ge._d)&&(!para.hand_facing||para.hand_facing===ge.hand_facing)&&(para.thumb_out==null||para.thumb_out===ge.thumb_out)&&(!para.condition||ge._condition_passed||para.condition(ge)&&(ge._condition_passed=true))))}var time_limit=para.time_limit||0;var g_result;for(let i=0,i_max=this.list.length;i<i_max;i++){const g=this.list[i];if(g.timestamp<RAF_timestamp-time_limit)break;const ge=find(g);if(!ge)continue;if(para.duration&&i<i_max-1){let duration=g.timestamp-this.list[i+1].timestamp;let j;for(j=i+1;j<i_max;j++){const _g=this.list[j];if(find(_g)){duration=j==i_max-1?9999:g.timestamp-this.list[j+1].timestamp;if(duration>=para.duration)break}else break}if(duration<para.duration){i=j;continue}}g_result=ge;g_result.search_para=Object.assign({},para);break}return g_result}};var v3a,v3b,v3c,v3d;var q1,q2,q3,q4;var enabled=false;var initialized,busy;var enabled_nut=false;var initialized_nut;var paused=true;async function init(){async function init_basic(){if(initialized)return;initialized=true;v3a=new THREE.Vector3;v3b=new THREE.Vector3;v3c=new THREE.Vector3;v3d=new THREE.Vector3;busy=true;await System._browser.load_script("js/fingerpose.js");const index_up=new fp.GestureDescription("index_up");index_up.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);index_up.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);for(let finger of[fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){index_up.addCurl(finger,fp.FingerCurl.FullCurl,1);index_up.addCurl(finger,fp.FingerCurl.HalfCurl,.9)}gestures.custom.index_up=index_up;const index_thumb=new fp.GestureDescription("index_thumb");index_thumb.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);index_thumb.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalLeft,1);index_thumb.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalRight,1);for(let finger of[fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){index_thumb.addCurl(finger,fp.FingerCurl.FullCurl,1);index_thumb.addCurl(finger,fp.FingerCurl.HalfCurl,.9)}gestures.custom.index_thumb=index_thumb;const index_middle=new fp.GestureDescription("index_middle");index_middle.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);index_middle.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);index_middle.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,1);index_middle.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpRight,1);index_middle.addCurl(fp.Finger.Middle,fp.FingerCurl.NoCurl,1);index_middle.addDirection(fp.Finger.Middle,fp.FingerDirection.VerticalUp,1);index_middle.addDirection(fp.Finger.Middle,fp.FingerDirection.DiagonalUpLeft,1);index_middle.addDirection(fp.Finger.Middle,fp.FingerDirection.DiagonalUpRight,1);for(let finger of[fp.Finger.Ring,fp.Finger.Pinky]){index_middle.addCurl(finger,fp.FingerCurl.FullCurl,1);index_middle.addCurl(finger,fp.FingerCurl.HalfCurl,.9)}gestures.custom.index_middle=index_middle;const index_pinky=new fp.GestureDescription("index_pinky");index_pinky.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);index_pinky.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);index_pinky.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,1);index_pinky.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpRight,1);index_pinky.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalLeft,1);index_pinky.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalRight,1);index_pinky.addCurl(fp.Finger.Pinky,fp.FingerCurl.NoCurl,1);for(let finger of[fp.Finger.Middle,fp.Finger.Ring]){index_pinky.addCurl(finger,fp.FingerCurl.FullCurl,1);index_pinky.addCurl(finger,fp.FingerCurl.HalfCurl,.9)}gestures.custom.index_pinky=index_pinky;for(const name of["thumb","thumb_index","thumb_palm"]){const g=new fp.GestureDescription(name);for(const finger of[fp.Finger.Index,fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){const no_curl=name=="thumb_palm"||(finger==fp.Finger.Index?name=="thumb_index":false);if(no_curl){g.addCurl(finger,fp.FingerCurl.NoCurl,1);if(name=="thumb_palm")g.addCurl(finger,fp.FingerCurl.HalfCurl,.7)}else{g.addCurl(finger,fp.FingerCurl.FullCurl,1);g.addCurl(finger,fp.FingerCurl.HalfCurl,.9)}}gestures.custom[name]=g}const palm_open=new fp.GestureDescription("palm_open");for(const finger of[fp.Finger.Thumb,fp.Finger.Index,fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){palm_open.addCurl(finger,fp.FingerCurl.NoCurl,1)}palm_open.addDirection(fp.Finger.Middle,fp.FingerDirection.VerticalUp,1);palm_open.addDirection(fp.Finger.Thumb,fp.FingerDirection.DiagonalUpLeft,1);palm_open.addDirection(fp.Finger.Thumb,fp.FingerDirection.DiagonalUpRight,1);palm_open.addDirection(fp.Finger.Thumb,fp.FingerDirection.HorizontalLeft,1);palm_open.addDirection(fp.Finger.Thumb,fp.FingerDirection.HorizontalRight,1);palm_open.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpLeft,1);palm_open.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpRight,1);palm_open.addDirection(fp.Finger.Pinky,fp.FingerDirection.HorizontalLeft,1);palm_open.addDirection(fp.Finger.Pinky,fp.FingerDirection.HorizontalRight,1);gestures.custom.palm_open=palm_open;GE_common=new fp.GestureEstimator([gestures.custom.index_up]);System._browser.on_animation_update.add(()=>{const list=gestures.list;for(let i=list.length-1;i>=0;i--){if(list[i].timestamp>RAF_timestamp-3e3){if(i<list.length-1)list.length=i+1;break}}},0,1,-1);DEBUG_show("Motion control initialized",3)}async function init_nut(){if(initialized_nut)return;initialized_nut=true;return;({getActiveWindow,Point,centerOf,mouse,keyboard,Key}=require("node_modules.asar/nut.js/node_modules/@nut-tree/nut-js"));mouse.config.autoDelayMs=0;keyboard.config.autoDelayMs=0;enabled_nut=true}await init_basic();await init_nut();busy=false}function get_virtual_joystick_data(gesture,hand){var thumb=hand.annotations.thumb;var pts_y=[hand.annotations.index[0][1],hand.annotations.middle[0][1],hand.annotations.ring[0][1],hand.annotations.pinky[0][1]];var is_back=thumb[1][1]>Math.max(...pts_y);var info,angle;if(is_back){angle=gesture.hand_rot_YXZ[1];if(angle<=20)info="Horizontal Left";else if(angle>20&&angle<=50)info="Diagonal Down Left";else if(angle>130&&angle<=160)info="Diagonal Down Right";else if(angle>160)info="Horizontal Right";else info="Vertical Down";if(!gesture.thumb_out&&/Horizontal/.test(info)){info="";angle=0}}else{if(!gesture.thumb_out){info="";angle=0}else{const y=-(thumb[3][1]-thumb[1][1]);const x=thumb[3][0]-thumb[1][0];angle=Math.atan2(y,x)*180/Math.PI-90;if(angle<-180)angle+=360;angle=-angle;if(angle>20&&angle<=60)info="Diagonal Up Right";else if(angle>60&&angle<=120)info="Horizontal Right";else if(angle<-20&&angle>=-60)info="Diagonal Up Left";else if(angle<-60&&angle>=-120)info="Horizontal Left";else info="Vertical Up"}}return[info+"\n"+(thumb[1][1]>Math.max(...pts_y))+"\n"+gesture.hand_rot_YXZ.join("\n"),angle]}var get_active_window=function(){var w_active,title,region,timestamp,resolve_list;return function(){if(timestamp!=RAF_timestamp){timestamp=RAF_timestamp;w_active=null;resolve_list=[];getActiveWindow().then(async w=>{[title,region]=await Promise.all([w.title,w.region]);w_active=w;const result={w:w_active,title:title,region:region};resolve_list.forEach(resolve=>{resolve(result)})})}return new Promise((resolve,reject)=>{if(w_active){resolve({w:w_active,title:title,region:region})}else{resolve_list.push(resolve)}})}}();var nj_list=["","","",""];var debug_msg=[];var plugins=[];const motion_control={get enabled(){return enabled},set enabled(v){if(enabled==!!v)return;enabled=!!v;if(enabled){init()}else{this.setMousePosition(null)}DEBUG_show("Motion control:"+(enabled?"ON":"OFF"),3)},get enabled_nut(){return enabled_nut},get ready(){return enabled&&!busy},get handedness(){return handedness},get off_hand(){return handedness==""?"":""},get window_active(){return window_active},get _debug_msg(){return debug_msg},get debug_msg(){return enabled&&debug_msg.length?debug_msg.join("\n")+"\n":""},get Key(){return Key},get key_pressed(){return keys.pressed},gestures:gestures,get plugins(){return plugins},add_plugin:function(p){if(plugins.indexOf(p)==-1)plugins.push(p)},process:async function(para){if(!this.ready)return;if(para.posenet_data){if(!gestures.list.length||gestures.list[0].timestamp!=RAF_timestamp){gestures.list.unshift({timestamp:RAF_timestamp,gestures:[]})}debug_msg=["Motion control"+(paused?"(PAUSED)":"")+":"];const handpose=para.posenet_data.handpose;if(handpose&&handpose.length){const hand_facing={};const hand_rot_YXZ={};const thumb_out={};handpose.forEach(hand=>{if(!hand._used)return;const f=System._browser.camera.poseNet.frames.skin[hand._d+""];if(!f)return;const r=MMD_SA.TEMP_v3.setEulerFromQuaternion(f[0].rot,"YXZ");hand_rot_YXZ[hand._d]=r.toArray().map(a=>a*180/Math.PI);hand_facing[hand._d]=Math.abs(r.y)<Math.PI/4?"front":Math.abs(Math.abs(r.y)-Math.PI)<Math.PI/4?"back":"sideway";const hand_data=hand.annotations;const a=v3a.fromArray(hand_data.index[0]);const m=v3b.fromArray(hand_data.middle[0]).sub(a);const p=MMD_SA._v3a.fromArray(hand_data.thumb[3]);const t=(p.x*m.x+p.y*m.y+p.z*m.z-(a.x*m.x+a.y*m.y+a.z*m.z))/m.lengthSq();thumb_out[hand._d]=-t>1.3*Math.abs(Math.abs(hand_rot_YXZ[hand._d][1])-90)/90+.2});gestures.list[0].hand_rot_YXZ=hand_rot_YXZ;gestures.list[0].hand_facing=hand_facing;gestures.list[0].thumb_out=thumb_out;handpose.forEach(hand=>{if(!enabled_nut)return;if(!hand._used)return;if(paused){gestures.estimate(GE_common,hand);const ge=gestures.search("index_up",{duration:1e3,hand_facing:"front",thumb_out:false});if(ge){paused=false;handedness=ge._d;DEBUG_show("Motion control:READY",2)}}else if(hand._d==handedness){gestures.estimate(GE_common,hand);const ge=gestures.search("index_up",{duration:1e3,hand_facing:"back",thumb_out:false});if(ge){paused=true;DEBUG_show("Motion control:PAUSED",2)}}})}}else if(para.facemesh_data){}plugins.forEach(p=>{p.process(para)});if(!enabled_nut)return;if(paused)return;this.virtual_mouse.process(para);this.game01.process(para)},setMousePosition:function(){var mouse_pt;return async function(pt){if(pt===null){mouse_pt=null;return}if(!enabled)return;if(!enabled_nut)return;if(pt){mouse_pt=pt}else if(!pt){return}await mouse.setPosition(mouse_pt)}}(),game01:function(){var _enabled,_initialized;var _key_map={id:"PSO2NGS",L:{thumb:{release:["Space","X"]},thumb_index:{press:["X"],release:["Space"]},thumb_palm:{press:["Space"],release:["X"]}},R:function(){function index_middle_click_check(ge){const click_state=keys.temp.index_middle||0;const clikc_state_new=ge.thumb_out?1:0;keys.temp.index_middle=clikc_state_new;return click_state!=clikc_state_new}return{index_thumb:{press:["Tab"],press_check:function(){if(!keys.temp.index_thumb)keys.temp.index_thumb={};keys.temp.index_thumb.clicked=true;return true}},index_up:{press:["Q"],press_check:function(){var index_thumb_active=keys.temp.index_thumb&&keys.temp.index_thumb.clicked;if(index_thumb_active)keys.temp.index_thumb.clicked=false;return index_thumb_active}},index_middle1:{press:["Period"],click:["Semicolon"],click_check:index_middle_click_check},index_middle2:{press:["Slash"],click:["Semicolon"],click_check:index_middle_click_check},index_middle3:{press:["Quote"],click:["Semicolon"],click_check:index_middle_click_check},thumb_palm:{press:["Backslash"]}}}()};var GE;var rot_x,rot_y;function init(){if(_initialized)return;GE=new fp.GestureEstimator([gestures.custom.index_up,gestures.custom.index_thumb,gestures.custom.index_middle,gestures.custom.index_pinky,gestures.custom.palm_open,gestures.custom.thumb,gestures.custom.thumb_index,gestures.custom.thumb_palm]);keys.set_options(_key_map);_initialized=true}return{get enabled(){return _enabled},set enabled(v){_enabled=v;if(_enabled){keys.set_options(_key_map)}else{}},process:async function(para){if(!this.enabled){await keys.releaseKey();return}init();const win=await get_active_window();const title=await win.title;if(para.facemesh_data&&para.head_rot){let rx=para.head_rot.x*180/Math.PI;let ry=para.head_rot.y*180/Math.PI;let my=Math.round(Math.sign(rx)*Math.pow(Math.min(Math.max((Math.abs(rx)-8)/15,0),1),2)*40);let mx=Math.round(Math.sign(ry)*Math.pow(Math.min(Math.max((Math.abs(ry)-10)/20,0),1),2)*40);debug_msg.push(rx,ry,mx,my);Promise.resolve(win.region).then(async region=>{const pt_center=await centerOf(region);const w_dim=region.width-1280<64?[1280,720]:[1920,1080];pt_center.y+=Math.round((region.height-w_dim[1]-(region.width-w_dim[0]))/2);pt_center.x+=mx;pt_center.y+=my;pt_center.y+=1;pt_center.x+=1;await motion_control.setMousePosition(pt_center)})}let handpose;if(para.posenet_data){handpose=para.posenet_data.handpose;let _debug_msg="";if(!handpose||!handpose.length){handpose=null;if(gestures.search("palm_open",{time_limit:500,hand_facing:"front",condition:()=>{}})){_debug_msg+="/CANCEL";await keys.releaseKey()}else{await keys.releaseIdleKey()}}debug_msg.push((handpose?"":"(no hand data)")+_debug_msg+"/key active:"+Object.keys(keys.pressed).filter(k=>keys.pressed[k]).join(","))}if(!handpose)return;for(const hand of handpose){if(!hand._used)continue;const action_side=hand._d==handedness?"R":"L";debug_msg.push(action_side+":");gestures.estimate(GE,hand);let ge;ge=gestures.search("palm_open",{hand:hand,hand_facing:"front",condition:function(ge){const hand=this.hand;const v1=v3a.fromArray(hand.annotations.index[0]).sub(v3b.fromArray(hand.annotations.index[3]));const v2=v3c.fromArray(hand.annotations.pinky[0]).sub(v3d.fromArray(hand.annotations.pinky[3]));return v1.angleTo(v2)*180/Math.PI>30}});if(ge){debug_msg.push("CANCEL");await keys.releaseKey(...keys.clear_list(action_side));continue}if(hand._d==handedness){ge=gestures.search("index_thumb",{hand:hand,hand_facing:"back",thumb_out:true});if(ge){await keys.activate(ge,action_side,ge.name,keys.clear_list(action_side));debug_msg.push("index_thumb");continue}ge=gestures.search("index_up",{hand:hand,hand_facing:"front",thumb_out:true});if(ge){await keys.activate(ge,action_side,ge.name,keys.clear_list(action_side));debug_msg.push("index_up");continue}ge=gestures.search("index_middle",{hand:hand});if(ge){let action_name=ge.name;switch(ge.poseData[1][2]){case"Vertical Up":action_name+=2;break;case"Diagonal Up Left":action_name+=handedness==""?1:3;break;case"Diagonal Up Right":action_name+=handedness==""?3:1;break}await keys.activate(ge,action_side,action_name,keys.clear_list(action_side));debug_msg.push(action_name);continue}ge=gestures.search("thumb_palm",{hand:hand,condition:function(ge){if(!/(Horizontal|Diagonal Up)/.test(ge.poseData[2][2]))return false;const hand=this.hand;const v1=v3a.fromArray(hand.annotations.index[0]).sub(v3b.fromArray(hand.annotations.index[3]));const v2=v3c.fromArray(hand.annotations.pinky[0]).sub(v3d.fromArray(hand.annotations.pinky[3]));return v1.angleTo(v2)*180/Math.PI<20}});if(ge){await keys.activate(ge,action_side,ge.name,keys.clear_list(action_side));debug_msg.push("thumb_palm");continue}ge=gestures.search("thumb",{hand:hand});if(ge){debug_msg.push("CANCEL");await keys.releaseKey(...keys.clear_list(action_side));continue}ge=gestures.search("index_pinky",{hand:hand});if(ge){debug_msg.push("index_pinky");continue}}else{ge=gestures.search("thumb_palm|thumb_index|thumb",{hand:hand,condition:function(ge){if(ge.name!="thumb_palm")return true;const hand=this.hand;const v1=v3a.fromArray(hand.annotations.index[0]).sub(v3b.fromArray(hand.annotations.index[3]));const v2=v3c.fromArray(hand.annotations.pinky[0]).sub(v3d.fromArray(hand.annotations.pinky[3]));return v1.angleTo(v2)*180/Math.PI<20}});if(ge){const dir_data=get_virtual_joystick_data(ge,hand);const dir=dir_data[0];let k_to_press=[];let k_to_release=[];switch(dir){case"Vertical Up":k_to_press.push("W");k_to_release.push("A","S","D");break;case"Diagonal Up Right":k_to_press.push("W","A");k_to_release.push("S","D");break;case"Horizontal Right":k_to_press.push("A");k_to_release.push("W","S","D");break;case"Diagonal Up Left":k_to_press.push("W","D");k_to_release.push("A","S");break;case"Horizontal Left":k_to_press.push("D");k_to_release.push("W","A","S");break;case"Diagonal Down Right":k_to_press.push("S","A");k_to_release.push("W","D");break;case"Diagonal Down Left":k_to_press.push("S","D");k_to_release.push("W","A");break;case"Vertical Down":k_to_press.push("S");k_to_release.push("W","A","D");break;default:k_to_release.push("W","A","S","D")}var action=keys.action(ge,action_side,ge.name);if(action.press.length)k_to_press.push(...action.press);if(action.release.length)k_to_release.push(...action.release);if(k_to_press.length)await keys.pressKey(...k_to_press.map(k=>[Key[k]]));if(k_to_release.length)await keys.releaseKey(...k_to_release.map(k=>[Key[k]]));debug_msg.push([ge.name,dir].join("/")+"/"+RAF_timestamp);continue}}if(!ge)await keys.releaseIdleKey(...keys.clear_list(action_side))}for(const hand_index of[[0,handpose.findIndex(hand=>hand._used&&hand._d==handedness)],[1,handpose.findIndex(hand=>hand._used&&hand._d!=handedness)]]){if(hand_index[1]!=-1)continue;const action_side=hand_index[0]==0?"R":"L";if(gestures.search("palm_open",{time_limit:500,hand:{_d:hand_index[0]==0?handedness:motion_control.off_hand},hand_facing:"front",condition:()=>{}})){await keys.releaseKey(...keys.clear_list(action_side))}else{await keys.releaseIdleKey(...keys.clear_list(action_side))}}}}}(),virtual_mouse:function(){var initialized;var GE;function init(){if(initialized)return;GE=new fp.GestureEstimator([fp.Gestures.VictoryGesture,fp.Gestures.ThumbsUpGesture,gestures.custom.index_up]);initialized=true}return{enabled:false,process:async function(para){if(!this.enabled)return;if(!para.posenet_data)return;init();const handpose=para.posenet_data.handpose;if(!handpose||!handpose.length)return;const hand_index=handpose[0]._d==handedness?0:1;const dir=handedness==""?0:1;if(!handpose[hand_index]||!handpose[hand_index]._used)return;const w_half=screen.width/2;const h_half=screen.height/2;const video_canvas=System._browser.camera.video_canvas;const AR=video_canvas.width/video_canvas.height/(w_half/h_half);const r=.5;const pointer=handpose[hand_index].annotations.index[0];const screen_pos={x:-(-video_canvas.width/2+pointer[0])/(video_canvas.width/2*r),y:(-video_canvas.height/2+pointer[1])/(video_canvas.height/2*r)};screen_pos.x=Math.round(w_half+THREE.Math.clamp(screen_pos.x*AR,-1,1)*w_half);screen_pos.y=Math.round(h_half+THREE.Math.clamp(screen_pos.y/AR,-1,1)*h_half);const target=new Point(screen_pos.x,screen_pos.y);await motion_control.setMousePosition(target)}}}()};return motion_control}(),snapshot:function(){var waiting=false;var waiting_for_bodyPix=false;var time_ini;var countdown;function countdown_to_snapshot(){const SL=MMD_SA.THREEX.SL;const camera=System._browser.camera;var countdown_now=Math.ceil(3-(Date.now()-time_ini)/1e3);if(countdown_now<=0){if(!camera.visible){canvas_capture(SL);return}DEBUG_show("Capturing...");if(!camera.stream){if(!camera.bodyPix.enabled){draw_video_and_3D();return}waiting_for_bodyPix=true}else{camera.target_devicePixelRatio=1;camera.video_track.applyConstraints(camera.set_constraints()).then(function(){System._browser.console.log("(Ready to capture)");System._browser.on_animation_update.add(function(){MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);if(!camera.bodyPix.enabled){System._browser.on_animation_update.add(function(){draw_video_and_3D()},0,1);return}waiting_for_bodyPix=true},0,0)})["catch"](function(err){DEBUG_show("ERROR:camera size failed to update");clear()})}System._browser.on_animation_update.remove(countdown_to_snapshot,0)}else if(countdown!=countdown_now){countdown=countdown_now;DEBUG_show(countdown)}}function draw_video_and_3D(){const SL=MMD_SA.THREEX.SL;const camera=System._browser.camera;let canvas=camera.video_canvas_bodyPix;canvas.width=SL.width;canvas.height=SL.height;let context=canvas.getContext("2d");context.globalCompositeOperation="source-over";const w=camera.video_canvas.width;const h=camera.video_canvas.height;const scale=Math.min(SL.width/w,SL.height/h);const w2=Math.round(w*scale);const h2=Math.round(h*scale);context.drawImage(camera.video_canvas,0,0,w,h,(SL.width-w2)/2,(SL.height-h2)/2,w2,h2);if(camera.face_detection.enabled)context.drawImage(camera.video_canvas_face_detection,0,0);context.save();context.translate(canvas.width,0);context.scale(-1,1);context.drawImage(SL,0,0);context.restore();canvas_capture(canvas)}function canvas_capture(canvas){waiting=true;waiting_for_bodyPix=false;System._browser.on_animation_update.remove(countdown_to_snapshot,0);canvas.toBlob(function(blob){if(webkit_electron_mode){System._browser.save_file("snapshot_"+Date.now()+".png",blob)}else{const url=URL.createObjectURL(blob);window.open(url)}clear()})}function clear(){const camera=System._browser.camera;Ldebug.style.posLeft=Ldebug.style.posTop=0;Ldebug.style.transform=Ldebug.style.transformOrigin="";DEBUG_show();waiting_for_bodyPix=false;camera.target_devicePixelRatio=0;waiting=false}const snapshot={init:function(){if(waiting){return true}const SL=MMD_SA.THREEX.SL;const camera=System._browser.camera;if(MMD_SA.WebXR.session){let AR_options=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;if(!AR_options.dom_overlay||!AR_options.dom_overlay.use_dummy_webgl){DEBUG_show("(No snapshot in AR WebGL)",3);return true}}if(!camera.visible){canvas_capture(SL)}else{waiting=true;time_ini=Date.now();Ldebug.style.posLeft=Ldebug.style.posTop=50;Ldebug.style.transformOrigin="0 0";Ldebug.style.transform="scale(5,5)";countdown=3;DEBUG_show();DEBUG_show(countdown);System._browser.on_animation_update.add(countdown_to_snapshot,0,0,-1)}},check_bodyPix:function(){if(!waiting)return false;const camera=System._browser.camera;if(waiting_for_bodyPix){canvas_capture(camera.video_canvas_bodyPix)}return true}};return snapshot}(),video_capture:(()=>{const canvas=document.createElement("canvas");function init(){const specs=video_capture.get_specs();canvas.width=specs.width;canvas.height=specs.height;video_capture._fps=specs.fps;video_capture.mime_type=specs.mime_type;System._browser.on_animation_update.add(update_canvas,0,1,-1)}function update_canvas(){const SL=MMD_SA.THREEX.SL;const ctx=canvas.getContext("2d");if(MMD_SA.music_mode){const video=SL_MC_video_obj.vo.media_linked&&SL_MC_video_obj.vo.media_linked.find(m=>m.id=="motion_bg_video");if(video&&video.style.visibility!="hidden"){const ratio=Math.min(video.videoWidth/video.videoHeight,canvas.width/canvas.height);const dim=Math.round(Math.min(video.videoWidth,video.videoHeight)*ratio);const w=Math.min(dim,video.videoWidth);const h=Math.min(dim,video.videoHeight);const x=(video.videoWidth-w)/2;const y=(video.videoHeight-h)/2;ctx.drawImage(video,x,y,w,h,0,0,canvas.width,canvas.height)}}else{ctx.fillStyle=document.body.style.backgroundColor||"white";ctx.fillRect(0,0,canvas.width,canvas.height)}if(canvas.width==SL.width&&canvas.height==SL.height){ctx.drawImage(SL,0,0)}else{ctx.drawImage(SL,0,0,canvas.width,canvas.height)}}let start_recorder_resolve;function start_recorder(){if(!video_capture.media_recorder||video_capture.started)return;video_capture.started=true;video_capture.media_recorder.start();if(start_recorder_resolve&&video_capture.stream.getAudioTracks().length&&(MMD_SA.music_mode?SL_MC_video_obj.vo.audio_obj.paused:MMD_SA.motion_player_control.enabled&&MMD_SA.motion_player_control.paused)){SL_MC_Play()}}function event_video_capture_stop(){System._browser.video_capture.stop()}var data_chunks=[];const video_capture={enabled:false,started:false,fps:undefined,target_width:undefined,target_height:undefined,FFmpeg:(()=>{var initialized;var ffmpeg;var worker;var promise_for_encoded;const _FFmpeg={enabled:webkit_electron_mode,load:async function(){if(initialized)return;initialized=true;return new Promise(resolve=>{worker=new Worker("js/ffmpeg_worker.js");worker.onmessage=e=>{const data=e.data;if(typeof data==="string"){if(data=="OK"){resolve()}}else{const blob=new Blob([data.buffer],{type:data.output_type});return promise_for_encoded(blob)}}})},encode:async function(...inputs){await this.load();const data={inputs:[]};for(const input of inputs){if(input.blob)input.blob=await input.blob.arrayBuffer();data.inputs.push(input)}worker.postMessage(data,data.inputs.filter(input=>input.blob).map(input=>input.blob));return new Promise(resolve=>{promise_for_encoded=resolve})}};return _FFmpeg})(),get_specs:function(){const SL=MMD_SA.THREEX.SL;const SL_pixels=SL.width*SL.height;let w=this.target_width,h=this.target_height,fps=this.fps;if(!w){if(is_mobile){w=1280;h=720;if(SL.width<SL.height){const _w=w;w=h;h=_w}}else{if(System._browser.camera.ML_enabled||System._browser.camera.bodyPix.enabled){w=1280;h=720}else{w=1920;h=1080}}}if(!fps){if(is_mobile){fps=30}else{if(System._browser.camera.ML_enabled||System._browser.camera.bodyPix.enabled){fps=30}else if(Math.min(w*h,SL_pixels)<=1280*720){fps=-1}else{fps=30}}}if(SL_pixels>w*h){const scale=Math.min(w/SL.width,h/SL.height);w=Math.min(Math.round(SL.width*scale/4)*4,w);h=Math.min(Math.round(SL.height*scale/4)*4,h)}else{w=SL.width;h=SL.height}const video_types=["video/webm;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"];let mime_type;for(const type of video_types){if(MediaRecorder.isTypeSupported(type)){mime_type=type;break}}return{width:w,height:h,fps:fps,mime_type:mime_type}},start:function(){if(this.busy){DEBUG_show("(Media recorder still in use)",3);return}if(this.enabled)return;this.enabled=true;init();const fps=this._fps==-1?undefined:this._fps;const video_stream=canvas.captureStream(fps);this.stream=new MediaStream;this.stream.addTrack(video_stream.getTracks()[0]);this.audio_src=MMD_SA.music_mode&&SL_MC_video_obj.vo.audio_obj.src;if(this.audio_src&&(!this.FFmpeg.enabled||this.target_mime_type||!SL_MC_video_obj.vo.motion_by_song_name_mode||SL_MC_video_obj.vo.audio_obj.currentTime)){const audio_stream=SL_MC_video_obj.vo.audio_obj.captureStream();this.stream.addTrack(audio_stream.getTracks()[0])}this.file_ext="."+(this.mime_type.indexOf("x-matroska")!=-1?"mkv":this.mime_type.replace(/^.+[\/]/,"").replace(/\;.+$/,""));this.media_recorder=new MediaRecorder(this.stream,{videoBitsPerSecond:canvas.width*canvas.height*4,mimeType:this.mime_type});data_chunks.length=0;this.media_recorder.addEventListener("dataavailable",async e=>{data_chunks.push(e.data);if(!this.enabled){let blob=new Blob(data_chunks,{type:this.mime_type});this.stream.getTracks().forEach(s=>{s.stop()});let file_ext=this.file_ext;this.busy=true;if(this.FFmpeg.enabled&&/h264/.test(this.mime_type)&&!this.target_mime_type){try{DEBUG_show("Encoding MP4...");const inputs=[{name:"video",blob:blob}];if(this.audio_src){const input_audio={name:"audio"};if(!this.stream.getAudioTracks().length)input_audio.blob=await fetch(this.audio_src).then(r=>r.blob());inputs.push(input_audio)}blob=await this.FFmpeg.encode(...inputs);file_ext=".mp4"}catch(err){console.error(err);this.FFmpeg.enabled=false}}this.busy=false;data_chunks.length=0;DEBUG_show("Video Capture:OFF",5);System._browser.save_file("video_"+Date.now()+file_ext,blob)}});const promise=new Promise(resolve=>{start_recorder_resolve=resolve;this.media_recorder.addEventListener("start",()=>{DEBUG_show();DEBUG_show("Video Capture:ON ("+(canvas.width+"x"+canvas.height+(video_capture._fps>-1?"/"+video_capture._fps+"fps":""))+"/"+video_capture.mime_type+")",10);if(MMD_SA.music_mode?SL_MC_video_obj.vo.audio_obj.paused:MMD_SA.motion_player_control.enabled&&MMD_SA.motion_player_control.paused){SL_MC_Play()}start_recorder_resolve();start_recorder_resolve=null},{once:true})});DEBUG_show();const time=MMD_SA.THREEX.get_model(0).animation.time;if(time||(MMD_SA.music_mode?!SL_MC_video_obj.vo.motion_by_song_name_mode||!SL_MC_video_obj.vo.audio_obj.paused:!MMD_SA.motion_player_control.enabled||!MMD_SA.motion_player_control.paused)){start_recorder()}else{if(video_capture.audio_src){window.addEventListener("SA_audio_onended",e=>{System._browser.video_capture.stop()},{once:true})}else if(MMD_SA.motion_player_control.enabled){const animation=MMD_SA.THREEX.get_model(0).animation;if(animation.enabled){animation.mixer.addEventListener("loop",event_video_capture_stop,{once:true});animation.mixer.addEventListener("finished",event_video_capture_stop,{once:true})}else{window.addEventListener("SA_MMD_model0_onmotionended",event_video_capture_stop,{once:true})}}const _reset_rigid_body_physics_step=MMD_SA_options.reset_rigid_body_physics_step;MMD_SA_options.reset_rigid_body_physics_step=0;new Promise(resolve=>{DEBUG_show("(Resetting physics)",3);let count=60*3;System._browser.on_animation_update.add(()=>{MMD_SA.seek_motion(time,true);if(MMD_SA.THREEX.get_model(0).animation.enabled)THREE.MMD.getModels()[0].seekMotion(0);if(--count==0)resolve()},0,0,count)}).then(()=>{MMD_SA.seek_motion(time);if(MMD_SA.motion_player_control.enabled){MMD_SA.motion_player_control.pause()}else{jThree.MMD.pause()}MMD_SA_options.reset_rigid_body_physics_step=_reset_rigid_body_physics_step;start_recorder()})}DEBUG_show("Video Capture",3);return promise},stop:function(){if(!this.media_recorder)return;if(!this.enabled)return;this.enabled=false;System._browser.on_animation_update.remove(update_canvas,1);const animation=MMD_SA.THREEX.get_model(0).animation;if(animation.enabled){animation.mixer.removeEventListener("loop",event_video_capture_stop);animation.mixer.removeEventListener("finished",event_video_capture_stop)}else{window.removeEventListener("SA_MMD_model0_onmotionended",event_video_capture_stop)}this.media_recorder.stop();this.media_recorder=undefined;this.started=false},pause:function(){if(this.started&&this.media_recorder.state!="paused")this.media_recorder.pause()},resume:function(){if(this.started&&this.media_recorder.state=="paused")this.media_recorder.resume()}};return video_capture})(),hotkeys:(()=>{class Hotkey{constructor(config,index){this.id=config.id;this.index=index;this.config=Hotkey.config_by_id[this.id]=config;this.event={};this.accelerator=config.accelerator[index];const keys=this.accelerator.split("+");keys.forEach(key=>{if(/^(Cmd|Command|Ctrl|Control)$/.test(key)){this.event.ctrlKey=true}else if(key=="Shift"){this.event.shiftKey=true}else if(key=="Alt"){this.event.altKey=true}else if(/^[0-9]$/.test(key)){this.event.code="Digit"+key}else if(/^num([0-9])$/.test(key)){this.event.code="Numpad"+RegExp.$1}else if(/^[A-Z]$/.test(key)){this.event.code="Key"+key}})}static config_by_id={};static get_config(id){return Hotkey.config_by_id[id]}static accelerators={};static register(id,accelerator,para){if(!Hotkey.unregister(id))return false;const config_current=Hotkey.get_config(id);if(para)Object.assign(config_current,para);config_current.accelerator=accelerator;accelerator.forEach((acc,i)=>{Hotkey.accelerators[acc]=new Hotkey(config_current,i)});return Hotkey.enable_global(id)}static unregister(id){const config_current=Hotkey.get_config(id);if(!config_current)return false;config_current.accelerator.forEach(acc=>{if(Hotkey.accelerators[acc].is_global){try{webkit_electron_remote.globalShortcut.unregister(acc)}catch(err){}}delete Hotkey.accelerators[acc]});return true}static enable_global(id,is_global){if(!webkit_electron_mode)return true;const config_current=Hotkey.get_config(id);if(!config_current)return;let global_disabled=is_global==null?!!Hotkey.accelerators[config_current.accelerator[0]].config.global_disabled:!is_global;is_global=global_disabled?false:Hotkey.is_global;let registered=true;config_current.accelerator.forEach(acc=>{const hotkey=Hotkey.accelerators[acc];hotkey.config.global_disabled=global_disabled;try{if(is_global){if(!hotkey.is_global&&!hotkey.config.global_disabled)webkit_electron_remote.globalShortcut.register(acc,()=>{SA_topmost_window.SA_OnKeyDown(hotkey.event)})}else{if(hotkey.is_global)webkit_electron_remote.globalShortcut.unregister(acc)}hotkey.is_global=webkit_electron_remote.globalShortcut.isRegistered(hotkey.accelerator);if(registered&&is_global&&!hotkey.config.global_disabled)registered=hotkey.is_global}catch(err){}});return registered}static remove(id){if(Hotkey.unregister(id))delete Hotkey.config_by_id[id]}static add(acc_obj){Hotkey.remove(acc_obj.id);acc_obj.accelerator.forEach((acc,i)=>{Hotkey.accelerators[acc]=new Hotkey(acc_obj,i)});Hotkey.enable_global(acc_obj.id)}static _is_global=null;static get is_global(){return this._is_global==null?true:this._is_global}static set is_global(v){this._is_global=v}static register_global(is_global){if(browser_native_mode){DEBUG_show("(Global hotkey is for app mode only.)",5);return}Hotkey.is_global=is_global==null?Hotkey.is_global:is_global;DEBUG_show("Global hotkey:"+(is_global?"ON":"OFF"),3);Object.values(Hotkey.accelerators).forEach(hotkey=>{try{if(is_global){if(!hotkey.is_global&&!hotkey.config.global_disabled)webkit_electron_remote.globalShortcut.register(hotkey.accelerator,()=>{SA_topmost_window.SA_OnKeyDown(hotkey.event)})}else{if(hotkey.is_global)webkit_electron_remote.globalShortcut.unregister(hotkey.accelerator)}hotkey.is_global=webkit_electron_remote.globalShortcut.isRegistered(hotkey.accelerator)}catch(err){}})}}window.addEventListener("SA_keydown",ev=>{const e=ev.detail.e;Object.values(Hotkey.config_by_id).some(config=>{const acc_matched=config.accelerator.some(acc=>{const a=Hotkey.accelerators[acc].event;if(a.code&&a.code!=e.code)return false;if(a.ctrlKey&&!e.ctrlKey)return false;if(a.shiftKey&&!e.shiftKey)return false;if(a.altKey&&!e.altKey)return false;return true});if(acc_matched){const return_value=config.process(ev);if(return_value!==false)ev.detail.result.return_value=true;return true}})});return Hotkey})(),load_script:function(){var script_loader_cache={};var script_loader=function(url,is_module){this.url=url;this.name=url.replace(/^.+[\/\\]/,"");this.loaded=false;this.resolve_list=[];this.reject_list=[];if(is_module){const that=this;import(url).then(module=>{that.module=module;that.check_loaded()})}else{const script=document.createElement("script");script.onload=this.check_loaded.bind(this);script.src=url;document.head.appendChild(script)}};script_loader.prototype.check_loaded=function(){this.loaded=true;console.log(this.name+" loaded");this.resolve_list.forEach(resolve=>{resolve(this.module)})};script_loader.prototype.make_promise=function(resolve,reject){this.resolve_list.push(resolve);if(reject)this.reject_list.push(reject)};return function(url,is_module){var name=url.replace(/^.+[\/\\]/,"");var m=script_loader_cache[name]=script_loader_cache[name];if(m){if(m.loaded)return Promise.resolve(m.module)}else{m=script_loader_cache[name]=new script_loader(url,is_module)}return new Promise((resolve,reject)=>{m.make_promise(resolve,reject)})}}(),save_file:function(){var link_file;return function(filename,content,mime_type){const blob=!mime_type?content:new Blob([content],{type:mime_type});const objectURL=URL.createObjectURL(blob);if(!link_file){link_file=document.createElement("a");link_file.style.display="none";document.body.appendChild(link_file)}else{URL.revokeObjectURL(link_file.href)}link_file.href=objectURL;link_file.download=filename||"";link_file.click()}}(),update_obj_url:async function(src,type){if(/^(.+\.zip)\#[\/\\](.+)$/i.test(src)){const src_local=SA_topmost_window.DragDrop._obj_url[src];if(!src_local||src==src_local){const zip=XMLHttpRequestZIP.zip_by_url(RegExp.$1);let blob=await zip.file(RegExp.$2.replace(/\\/g,"/"))["async"]("blob");if(type)blob=new Blob([blob],{type:type});console.log("Object URL (inside zip) updated",src);SA_topmost_window.DragDrop._obj_url[src]=SA_topmost_window.URL.createObjectURL(blob)}}},skip_background_rendering:true,skip_rendering:false,rendering_check:function(){if(this.skip_rendering&&!this.hidden)return false;if(!returnBoolean("DisableBackgroundThrottling"))return true;const skip_rendering=this.skip_background_rendering&&this.hidden;let c_dummy=document.getElementById("canvas_DisableBackgroundThrottling");if(skip_rendering){if(!c_dummy){c_dummy=document.createElement("canvas");c_dummy.id="canvas_DisableBackgroundThrottling";c_dummy.width=c_dummy.height=1;c_dummy.style.position="absolute";c_dummy.style.posLeft=c_dummy.style.posTop="0px";c_dummy.style.zIndex=9999;document.getElementById("Lbody_host").appendChild(c_dummy)}c_dummy.getContext("2d").clearRect(0,0,c_dummy.width,c_dummy.height)}if(c_dummy)c_dummy.style.visibility=skip_rendering?"inherit":"hidden";return!skip_rendering},console:{content_list:[],log:function(){for(var i=0;i<arguments.length;i++){this.content_list.push(arguments[i])}},reset:function(){this.content_list=[]},get output_text(){return this.content_list.join("\n")||"(EMPTY)"}},get use_screen_data(){if(this._use_screen_data)return true;if(!webkit_electron_mode)return false;let opacity_on_hover,IgnoreMouseEventsPartial;if(!SA_topmost_window.returnBoolean("AutoItStayOnDesktop")){opacity_on_hover=System.Gadget.Settings.readString("OpacityOnHover");IgnoreMouseEventsPartial=SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial")}let capture_pixel=opacity_on_hover||IgnoreMouseEventsPartial;let use_screen_data=capture_pixel||self.MMD_SA&&MMD_SA.MMD_started&&MMD_SA_options.look_at_mouse;return use_screen_data},set use_screen_data(v){this._use_screen_data=v},translation:(()=>{var language_full,language,language_info;const language_default=navigator.language+"-default";var dictionary;var font={ja:'"Meiryo UI"'};const translation={get language(){return language},set language(v){language_full=v||language_default;language=language_full.split("-")[0].toLowerCase();if(language_full==language_default){language_info="System default"}else{switch(language){case"en":language_info="English";break;case"ja":language_info="Japanese";break;default:language_info="System default"}}},get language_full(){return language_full},get language_info(){return language_info},get language_default(){return language_default},get dictionary(){return dictionary},set dictionary(v){dictionary=Object.assign(dictionary||{},v)},get font(){return font[language]},get:function(path,language_now=language){if(!dictionary)return"(Now loading...)";let obj=dictionary;path.split(".").every(node=>{obj=obj[node];return obj});const result=obj&&(obj._translation_?.[language_now]||obj._translation_?._default_);return result!=null?result:"("+path+")"}};translation.language=null;return translation})(),DEBUG_show:function(){const _DEBUG_show=self.DEBUG_show;self.DEBUG_show=function(...args){if(System._browser.overlay_mode>0){if(!args.length)_DEBUG_show()}else{_DEBUG_show(...args)}};return _DEBUG_show}()},_hash_sha256:{_hash_cache:{},hash:function(str){if(webkit_electron_mode){var f=webkit_electron_remote.getGlobal("HASH_SHA256");if(f)return f.hash(str)}var cache=this._hash_cache[str];if(cache)return cache;var hash=require("crypto").createHash("sha256");hash.update(str);cache=this._hash_cache[str]=hash.digest("hex");return cache}},_media_objs_paused_:[],_gadget_resume:function(is_auto){if(is_auto&&!SA_topmost_window.EV_sync_update.RAF_auto_paused)return false;if(!SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=false;SA_topmost_window.EV_sync_update.RAF_auto_paused=false;SA_topmost_window.System._media_objs_paused_.forEach(function(v){if(v.SL_MC_Play)v.SL_MC_Play();else if(v.paused)v.play()});SA_topmost_window.System._media_objs_paused_=[];System._browser.update_tray();return true},_gadget_pause:function(is_auto){if(SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=true;SA_topmost_window.EV_sync_update.RAF_auto_paused=is_auto;var _media_objs_paused_=SA_topmost_window.System._media_objs_paused_;var wins=[top];for(var i=0;i<SA_child_animation_max;i++){if(SA_topmost_window.SA_child_animation[i])wins.push(SA_topmost_window.document.getElementById("Ichild_animation"+i).contentWindow)}var seq_count=0;var video_count=0;var mc_count=0;wins.forEach(function(w_obj){for(var name in w_obj.seq_items){var seq=w_obj.seq_items[name];if(!seq._gadget_pause_disabled&&!seq.paused&&seq.count){seq_count++;seq.pause();_media_objs_paused_.push(seq)}}var v_list=[];var _v;_v=document.getElementById("VdesktopBG");if(_v)v_list.push(_v);_v=w_obj.CANVAS_Video_Overlay&&w_obj.CANVAS_Video_Overlay._video;if(_v)v_list.push(_v);v_list.forEach(function(v){if(v&&!v.paused&&!v.ended){video_count++;v.pause();_media_objs_paused_.push(v)}});if(w_obj.SL&&w_obj.SL._mouse_event_main&&w_obj.SL._mouse_event_main()){var paused;if(w_obj.SL_MC_simple_mode)paused=w_obj.SL_MC_video_obj.paused;else if(w_obj.MMD_SA)paused=w_obj.SL_MC_video_obj.vo.audio_obj.paused;else if(w_obj.use_WMP&&w_obj.WMP.in_use)paused=w_obj.WMP.player.playState!=3;else paused=w_obj.SL_MC_video_obj&&w_obj.SL_MC_video_obj.paused;if(!paused){mc_count++;w_obj.SL_MC_Play();_media_objs_paused_.push(w_obj)}}});console.log("Gadget PAUSED (Seq/Video/MC):"+[seq_count,video_count,mc_count].join("/"));System._browser.update_tray();return true},_returnRelativePath:function(path){if(!WallpaperEngine_CEF_mode)return path;if(System.Gadget.path&&path.indexOf(System.Gadget.path)==0)path=path.substr(System.Gadget.path.length);path=/\:/.test(path)?toFileProtocol(path):path.replace(/\\/g,"/").replace(/^\//,"");return path}};System._init();return System}();
