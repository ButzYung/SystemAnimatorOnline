// (2025-02-22)
var System=function(){var System={_init:function(){try{if(!Shell_OBJ)Shell_OBJ=new ActiveXObject("Shell.Application");if(!FSO_OBJ)FSO_OBJ=new ActiveXObject("Scripting.FileSystemObject");if(!oShell)oShell=new ActiveXObject("WScript.Shell")}catch(e){alert(e.message)}this._child_html_filename=xul_mode?"SystemAnimator_xul.html":webkit_mode?WallpaperEngine_CEF_mode&&!browser_native_mode?"SystemAnimator_cef.html":"SystemAnimator_webkit.html":"SystemAnimator_ie.html";this.Gadget._init();this.Machine._init();if(!is_SA_child_animation){SA_top_window.getScreenBounds=function(){var n=-1;var o;return function(e,t,i){if(i||n!=RAF_timestamp){n=RAF_timestamp;o=webkit_electron_mode?webkit_electron_screen.getDisplayNearestPoint({x:~~e,y:~~t}).bounds:{x:0,y:0,width:parent.screen.width,height:parent.screen.height}}return o}}()}else{SA_top_window.getScreenBounds=function(e,t,i){return SA_topmost_window.getScreenBounds(e,t,i)}}if(webkit_electron_mode){if(!is_SA_child_animation){SA_top_window.getPos=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_window.getPosition()}return i}}();SA_top_window.getCursorPos=function(){var t=-1;var i;return function(e){if(e||t!=RAF_timestamp){t=RAF_timestamp;i=webkit_electron_screen.getCursorScreenPoint()}return i}}()}else{SA_top_window.getPos=function(e){return SA_topmost_window.getPos(e)};SA_top_window.getCursorPos=function(e){return SA_topmost_window.getCursorPos(e)}}}SA_top_window.resizeToAbsolute=function(){var i;return function(e,t){webkit_window.setContentSize(e,t);i=true;if(absolute_screen_mode&&!System._browser._window_move_timerID){System._browser._window_move_timerID=setInterval(function(){var t=SA_top_window.screenLeftAbsolute;var i=SA_top_window.screenTopAbsolute;var n=0;return function(){var e=SA_top_window.getPos(true);if(t!=e[0]||i!=e[1]){DEBUG_show("(window position adjusted)",3);webkit_window.setPosition(t,i);System._browser.moveWallpaper(t,i);n=999}if(++n>10){clearInterval(System._browser._window_move_timerID);System._browser._window_move_timerID=null}}}(),100)}}}();(()=>{function n(){function e(){const e=document.body.style;webkit_window.setContentSize(e.pixelWidth,e.pixelHeight)}if(webkit_electron_mode&&window.devicePixelRatio!=1){window.removeEventListener("resize",e);window.addEventListener("resize",e,{once:true})}}SA_top_window.moveToAbsolute=function(e,t,i){n();if(absolute_screen_mode&&!i){webkit_window.setPosition(~~e,~~t)}else{this.moveTo(e,t)}};SA_top_window.moveByAbsolute=function(t,i){n();if(absolute_screen_mode){let e=SA_top_window.getPos(true);t+=~~e[0];i+=~~e[1];webkit_window.setPosition(t,i)}else{this.moveBy(t,i)}}})();Object.defineProperty(SA_top_window,"screenLeftAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[0]:this.screenLeft}});Object.defineProperty(SA_top_window,"screenTopAbsolute",{get:function(){return absolute_screen_mode?SA_top_window.getPos()[1]:this.screenTop}})},Gadget:{_init:function(){this.Settings.read=this.Settings.readString;this.Settings.write=this.Settings.writeString;Object.defineProperty(this,"onSettingsClosing",{get:function(){return this._onSettingsClosing},set:function(e){this._onSettingsClosing=e;this.settings_window.onbeforeunload=function(){e({closeAction:!!this.returnValue,Action:{commit:true}});System.Gadget.settings_window.System=null;System.Gadget.settings_window.onbeforeunload=null;System.Gadget.settings_window=null}}});var e=new ActiveXObject("Microsoft.XMLDOM");e.async=false;e.resolveExternals=false;e.validateOnParse=false;e.load("gadget.xml");this.version=e.selectSingleNode("//version").text},path:xul_mode?XPCOM_object._SA_root:use_SA_browser_mode?toLocalPath(self.location.href).replace(/[\/\\][^\/\\]+$/,""):"",_path_folder:function(){return this.path.replace(/[\/\\][^\/\\]+$/,"")},document:document,version:"1.0.0.0",docked:is_SA_child_animation,visible:true,Settings:{_settings_need_update:false,_settings:{},_changed:{},readString:function(name,raw_read){var v=this._settings[name];v=v?raw_read?decodeURIComponent(v):decodeURIComponent(v).replace(/\$([^\$]+)\$/g,function($0,$1,$2){return eval($1)}):Settings_default._custom_[name]||"";return v},writeString:function(e,t){var i=this._settings[e]||"";var n=encodeURIComponent(t);this._settings[e]=n;if(save_settings_by_localStorage){var o=JSON.parse(localStorage.Settings_by_path);if(!SA_HTA_folder||!o[SA_HTA_folder]){console.error(SA_HTA_folder)}else{if(o[SA_HTA_folder][e]!=n){o[SA_HTA_folder][e]=n;localStorage.Settings_by_path=JSON.stringify(o)}}}if(i!=n)this._changed[e]=this._settings_need_update=true},_writeSettings:function(e,t){if(!e&&!this._settings_need_update)return;this._settings_need_update=false;SystemEXT._save_settings_only=t;try{this._writeSettings_CORE()}catch(e){}SystemEXT._save_settings_only=false},_writeSettings_CORE:function(){var e=[];var t=this._settings;t._screenLeft=t._screenTop="";for(var i in t){var n=System.Gadget.Settings.readString(i);if(!n)continue;if(i=="_screenLeft"){n=SA_top_window.screenLeftAbsolute}else if(i=="_screenTop"){n=SA_top_window.screenTopAbsolute}e.push('"'+i+'":"'+encodeURIComponent(n)+'"')}SystemEXT.SaveLocalSettings(e)}}},Environment:{win32_env:null,getEnvironmentVariable:function(e){return oShell.ExpandEnvironmentStrings("%"+e+"%")}},Machine:{_init:function(){this._init_memory=function(){if(webkit_mode)return;if(this._WMI_obj_memory)return;try{this._WMI_obj_memory=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Memory","EV");this._WMI_obj_memory.init()}catch(e){}};Object.defineProperty(this,"availableMemory",{get:function(){if(webkit_mode)return SA_require("os").freemem()/(1024*1024);this._init_memory();var e=this._WMI_obj_memory.update();return e.length?parseInt(e[e.length-1].AvailableMBytes):0}});Object.defineProperty(this,"totalMemory",{get:function(){if(webkit_mode)return SA_require("os").totalmem()/(1024*1024);if(!this._totalMemory){try{var e=new WMI_Refresher("Win32_OperatingSystem");e.init();this._totalMemory=parseInt(e.update()[0].TotalVisibleMemorySize)/1024}catch(e){}}return this._totalMemory}});this.totalMemory=0;var e={_WMI_obj:null,_cpu_obj:null,_get_cpu_obj:null,_init:function(){if(webkit_mode){if(this._get_cpu_obj)return;this._cpu_obj=[{count:-1,cpus:SA_require("os").cpus()}];this._get_cpu_obj=function(){var e=this._cpu_obj;if(e[0].count!=PC_count_absolute){if(e.unshift({count:PC_count_absolute,cpus:SA_require("os").cpus()})==3)e.pop()}return e};return}if(this._WMI_obj)return;try{this._WMI_obj=new WMI_Refresher("Win32_PerfFormattedData_PerfOS_Processor","EV");this._WMI_obj.init()}catch(e){}},item:function(e){if(webkit_mode){var t=this._get_cpu_obj();var i=[];for(var n=0;n<2;n++){var o=t[n].cpus[e].times;var a=0;for(var s in o)a+=o[s];i[n]={total:a,idle:o.idle}}var r=i[0].idle-i[1].idle;var a=i[0].total-i[1].total;return{usagePercentage:a?(1-r/a)*100:0}}return{usagePercentage:parseFloat(this._WMI_obj.update()[e].PercentProcessorTime)}}};Object.defineProperty(e,"count",{get:function(){if(webkit_mode){return this._get_cpu_obj()[0].cpus.length}return this._WMI_obj.update().length-1}});this._CPUs=e;Object.defineProperty(this,"CPUs",{get:function(){this._CPUs._init();return this._CPUs}});var t={_WMI_obj:null,_init:function(){if(this._battery)return;this._battery={level:1,charging:false};if("getBattery"in navigator){var t=this;navigator.getBattery().then(function(e){DEBUG_show("Use Battery Status API",2);t._battery=e})}}};Object.defineProperty(t,"batteryPercentRemaining",{get:function(){return this._battery.level*100}});Object.defineProperty(t,"isPowerLineConnected",{get:function(){return this._battery.level==1||this._battery.charging}});Object.defineProperty(t,"isBatteryCharging",{get:function(){return this._battery.charging}});this._PowerStatus=t;Object.defineProperty(this,"PowerStatus",{get:function(){this._PowerStatus._init();return this._PowerStatus}})}},Shell:{itemFromFileDrop:function(e,t){return{path:""}},itemFromPath:function(e){e=toLocalPath(e);var t=e.replace(/[\/\\][^\/\\]+$/,"");var i=e.replace(/^.+[\/\\]/,"");var n=Shell_OBJ.NameSpace(t);if(n)n=n.ParseName(i);return n?new this._FolderItem(n):null},execute:function(e,t){Shell_OBJ.ShellExecute(e,t)},chooseFolder:function(e,t){var i=Shell_OBJ.BrowseForFolder(0,e,t);return i?new this._FolderItem(i.Self):null},_FolderItem:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.metadata=function(e){var t=this.obj.ExtendedProperty("Dimensions");if(!t){var i=this.obj.Path.replace(/[\/\\][^\/\\]+$/,"");var n=Shell_OBJ.NameSpace(i);t=n.GetDetailsOf(this.obj,26)}return t};Object.defineProperty(this.constructor.prototype,"isFolder",{get:function(){return this.obj.IsFolder}});Object.defineProperty(this.constructor.prototype,"isFileSystem",{get:function(){return(ie9_native?!this.obj.IsFolder:true)&&this.obj.IsFileSystem}});Object.defineProperty(this.constructor.prototype,"isLink",{get:function(){return this.obj.IsLink}});Object.defineProperty(this.constructor.prototype,"link",{get:function(){return new System.Shell._FolderItem(this.obj.GetLink)}});Object.defineProperty(this.constructor.prototype,"path",{get:function(){return this.obj.Path}});Object.defineProperty(this.constructor.prototype,"type",{get:function(){return this.obj.Type}});Object.defineProperty(this.constructor.prototype,"SHFolder",{get:function(){return new System.Shell._Folder(this.obj.GetFolder)}})}this.obj=e},_Folder:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;Object.defineProperty(this.constructor.prototype,"Items",{get:function(){return new System.Shell._FolderItems(this.obj.Items())}})}this.obj=e},_FolderItems:function(e){if(!this._constructor_initialized){this.constructor.prototype._constructor_initialized=true;this.constructor.prototype.item=function(e){return new System.Shell._FolderItem(this.obj.Item(e))};Object.defineProperty(this.constructor.prototype,"count",{get:function(){return this.obj.Count}})}this.obj=e}},Debug:{outputString:function(e){}},_browser:{init:function(){document.ondragstart=document.onselectstart=function(e){return false};document.onmousedown=function(e){System._browser.onmousedown(e)};document.onmouseup=function(e){System._browser.onmouseup(e)};document.onmousemove=function(e){System._browser.onmousemove(e)};document.onkeydown=function(e){System._browser.onkeydown(e)};if(!WallpaperEngine_CEF_mode||!is_SA_child_animation||browser_native_mode){document.addEventListener("mouseover",function(e){System._browser.onmouseover(e)},false);document.addEventListener("mouseout",function(e){System._browser.onmouseout_waiting(e)},false)}Object.defineProperty(document,"onmouseover",{set:function(e){System._browser.onmouseover_custom=e}});Object.defineProperty(document,"onmouseout",{set:function(e){System._browser.onmouseout_waiting_custom=e}});var e=w3c_mode?CSSStyleDeclaration.prototype:document.body.style.constructor.prototype;this.document_body_style_pixelWidth=Object.getOwnPropertyDescriptor(e,"pixelWidth");this.document_body_style_pixelHeight=Object.getOwnPropertyDescriptor(e,"pixelHeight");var t=function(){if(System._browser.resize_timerID)clearTimeout(System._browser.resize_timerID);if(System._browser._window_move_timerID){let i=SA_top_window.getPos();System._browser.resize_timerID=setInterval(function(){var t=0;return function(){let e=SA_top_window.getPos(true);if(++t>10||i[0]!=e[0]||i[1]!=e[1]){clearInterval(System._browser.resize_timerID);System._browser.resize_timerID=setTimeout("System._browser.resize()",0)}}}(),10)}else System._browser.resize_timerID=setTimeout("System._browser.resize()",0)};Object.defineProperty(e,"_set",{get:function(){return t}});if(ie9_native){Object.defineProperty(document.body.style,"pixelWidth",{get:function(){return System._browser.document_body_style_pixelWidth.get.call(this)},set:function(e){this._set();System._browser.document_body_style_pixelWidth.set.call(this,e)}});Object.defineProperty(document.body.style,"pixelHeight",{get:function(){return System._browser.document_body_style_pixelHeight.get.call(this)},set:function(e){this._set();System._browser.document_body_style_pixelHeight.set.call(this,e)}})}Object.defineProperty(this,"overlay_mode",function(){var t=0;var i=null;var n=null;if(is_mobile){document.addEventListener("contextmenu",e=>{e.preventDefault();Lnumpad.style.visibility="inherit"})}return{get:function(){return this.skipping_rendering&&this.hidden?Math.max(t,1):t},set:function(e){if(e==t)return;switch(e){case 2:if(i==null)i=LdesktopBG_host.style.display;LdesktopBG_host.style.display="none";if(n==null)n=document.body.style.backgroundColor;document.body.style.backgroundColor="#00FF00";case 1:Lmenu_host.style.visibility="hidden";Lnumpad.style.visibility="hidden";if(this.camera.video_host){this.camera.video_host.style.visibility="hidden";this.camera.video_host.style.display="none"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="hidden";document.getElementById("Ldungeon_inventory").style.visibility="hidden";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden";DEBUG_show("(Press Esc to toggle "+(this.overlay_mode_TEMP?"UI":"bottom menu")+" display)",5)}break;default:if(i!=null)LdesktopBG_host.style.display=i;if(n!=null)document.body.style.backgroundColor=n;i=n=null;Lmenu_host.style.visibility="inherit";if(this.camera.video_host){this.camera.video_host.style.visibility="inherit";this.camera.video_host.style.display="block"}if(document.getElementById("Ldungeon_UI")){document.getElementById("Ldungeon_UI").style.visibility="inherit";document.getElementById("Ldungeon_inventory").style.visibility="inherit";document.getElementById("Ldungeon_inventory_backpack").style.visibility="hidden"}}t=e}}}());var i=is_SA_child_animation&&parent.MMD_SA_options&&parent.MMD_SA_options.child_animation_as_texture;if(i){this.onkeydown({keyCode:97+SA_child_animation_id})}var n=System.Gadget.Settings.readString("SA_docked");if(n)System.Gadget.docked=!!parseInt(n);else{if(i)System.Gadget.docked=false}var n=document.createElement("div");n.id="Ldrag_dummy";var o=n.style;o.position="absolute";o.posLeft=o.posTop=0;o.zIndex=999;o.border="1px solid rgba(128,128,128,0.5)";o.visibility="hidden";document.body.appendChild(n);this.body=document.getElementById("Lbody_host")||document.body;if(w3c_mode)this.body.style.transition="opacity 0.5s";this.Opacity=1;var a=document.getElementById("LdesktopBG")&&!is_SA_BG_transparent;if(a){if(!self.SA_wallpaper_src){var s=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_src.txt");if(FSO_OBJ.FileExists(s)){try{var r=FSO_OBJ.OpenTextFile(s,1);self.SA_wallpaper_src=r.ReadLine();r.Close()}catch(e){}}}if(!self.SA_wallpaper_mask_src){var _=System.Gadget.path+toLocalPath("\\TEMP\\SA_wallpaper_mask_src.txt");if(FSO_OBJ.FileExists(_)){try{var r=FSO_OBJ.OpenTextFile(_,1);self.SA_wallpaper_mask_src=r.ReadLine();r.Close()}catch(e){}}}}if(a)a=System.Gadget.Settings.readString("WallpaperAsBG")||self.SA_wallpaper_src;var l;if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay.use_wallpaper_as_bg||self.EQP_use_wallpaper){l=a=true}var u;var c,d;this.Opacity=is_SA_child_animation?parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style.opacity||1:parseFloat(System.Gadget.Settings.readString("Opacity")||1);if(is_SA_child_animation&&!self.SA_wallpaper_src&&!l){a=a&&parent.WMP_wallpaper_mask&&parent.use_HTML5&&!parent.System.Gadget.Settings.readString("CSSTransform3D")&&!System.Gadget.Settings.readString("DisableWallpaperMask");if(a&&self.EQP_video_options&&EQP_video_options.use_canvas_video){a=false;this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");this.WMPMask_Draw()}this.wallpaper_mask_disabled=!a;if(a)u=parent.WMP_wallpaper_mask}else{var p;if(!is_SA_child_animation&&webkit_electron_mode){c=System.Gadget.Settings.readString("_screenLeft");d=System.Gadget.Settings.readString("_screenTop")}c=c?parseInt(c):null;d=d?parseInt(d):null;if(a){const A=w3c_mode&&self.SA_wallpaper_src&&/\.(mp4|mkv|webm)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;this.wallpaper_mask_disabled=WallpaperEngine_CEF_mode||!!System.Gadget.Settings.readString("DisableWallpaperMask");var m,f,h;var o=LdesktopBG.style;try{o.pixelWidth=parent.screen.width;o.pixelHeight=parent.screen.height;var M=oShell.RegRead("HKCU\\Control Panel\\Colors\\Background");o.backgroundColor=/^\#/.test(M)?M:"rgb("+M.replace(/\W+/g,",")+")";m="HKCU\\Control Panel\\Desktop\\";if(WallpaperEngine_CEF_mode)f=oShell.RegRead(m+"Wallpaper")||self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src;else f=self.SA_wallpaper_src==""?"":self.SA_wallpaper_src&&/\.(png|bpm|jpg|jpeg)$/i.test(SA_wallpaper_src)&&SA_wallpaper_src||oShell.RegRead(m+"Wallpaper");if(f){if(!this.wallpaper_mask_disabled){u=self.SA_wallpaper_mask_src||f.replace(/\.\w{3,4}$/,"_mask.png");if(!ValidatePath(u))u=null}h=oShell.RegRead(m+"WallpaperStyle");this.updateWallpaper(f,h)}if(A){this.updateWallpaper(A)}this.moveWallpaper(c||0,d||0);if(!is_SA_child_animation||self.SA_wallpaper_src)LdesktopBG_host.style.display="block"}catch(e){console.error(e);LdesktopBG_host.style.display="none"}if(u){if(!this.bg_mask)this.bg_mask="(blank)"}else{p=true}}else{p=true}if(p&&this.Opacity<1&&(w3c_mode||HTA_use_GPU_acceleration)){this.body.style.opacity=this.Opacity;DEBUG_show("Opacity:"+this.Opacity*100+"%",2)}}if(l&&!u)this.bg_mask="(blank)";if(a&&(u||this.bg_mask)){var g=document.createElement("canvas");g.id="C_wallpaper_mask";g._WallpaperAsBG_custom=l;g.onmousedown=function(){return false};if(!is_SA_child_animation||l){try{var y=g.width=parent.screen.width;var b=g.height=parent.screen.height;var v=g.getContext("2d");var w;if(!this.wallpaper_canvas_update){this.wallpaper_canvas_update=function(e,d){v.fillStyle=o.backgroundColor;v.fillRect(0,0,y,b);if(!e){if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(e){if(e.is_wallpaper)e.img.img_obj._match_str=null})}return}var t;if(d=="0"){t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var n=parent.screen.height;var o,a,s,r,_,l,c,d;if(i>e){o=0;_=(i-e)/2;s=c=e}else{o=(e-i)/2;_=0;s=c=i}if(n>t){a=0;l=(n-t)/2;r=d=t}else{a=(t-n)/2;l=0;r=d=n}var p=C_wallpaper_mask.getContext("2d");p.drawImage(this,o,a,s,r,_,l,c,d);System._browser.BGMask_Create(!u);if(!u)return;var m=new Image;m.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,o,a,s,r,_,l,c,d);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};m.src=toFileProtocol(u)}}else{t=function(){var e=this.width;var t=this.height;var i=parent.screen.width;var n=parent.screen.height;var o,a,s,r,_;var l=C_wallpaper_mask.getContext("2d");if(d=="6"){o=Math.max(e/i,t/n);r=Math.round((i-e/o)/2);_=Math.round((n-t/o)/2);a=Math.round(e/o);s=Math.round(t/o);l.drawImage(this,0,0,e,t,r,_,a,s)}else{o=Math.min(e/i,t/n);r=Math.round((e/o-i)/2*o);_=Math.round((t/o-n)/2*o);a=Math.round(i*o);s=Math.round(n*o);l.drawImage(this,r,_,a,s,0,0,C_wallpaper_mask.width,C_wallpaper_mask.height)}System._browser.BGMask_Create(!u);if(!u)return;var c=new Image;c.onload=function(){var e=C_wallpaper_mask.getContext("2d");e.globalCompositeOperation="destination-in";e.drawImage(this,r,_,a,s);C_wallpaper_mask.style.visibility="inherit";DEBUG_show("Use wallpaper mask",2)};c.src=toFileProtocol(u)}}if(w)w.onload=null;w=new Image;w.onload=t;w.src=toFileProtocol(e)}}this.wallpaper_canvas_update(f,h);if(!f){setTimeout("System._browser.BGMask_Create(true)",0)}}catch(e){}}var S=g.style;S.position="absolute";S.posLeft=-(c||0);S.posTop=-(d||0);S.zIndex=60;S.visibility="hidden";document.body.appendChild(g);this.mouseover_hide_list.push(g);if(is_SA_child_animation){this.C_WMP_wallpaper_mask_resized=document.createElement("canvas");this.C_WMP_wallpaper_mask_mixed_resized=document.createElement("canvas");if(this.bg_mask)System._browser.BGMask_Create(!u);this.WMPMask_Draw()}}this._s_left=c;this._s_top=d},updateWallpaper:function(e,t){let i=document.getElementById("VdesktopBG");if(e&&/\.(mp4|mkv|webm)$/i.test(e)){if(!i){i=document.createElement("video");i.id="VdesktopBG";const c=i.style;c.position="absolute";c.top=c.left="0px";c.width=parent.screen.width+"px";c.height=parent.screen.height+"px";c.objectFit="cover";LdesktopBG.appendChild(i);i.autoplay=i.loop=true}i.src=toFileProtocol(e);i.style.visibility="inherit";return}if(i){i.pause();i.style.visibility="hidden"}var n=LdesktopBG.style;var o;if(e!=null){e=decodeURIComponent(e);if(this._wallpaper_last!=e){o=true;this._wallpaper_last=e;n.backgroundImage=e?"url("+toFileProtocol(/^(\/|[\w\-]+\:)/.test(e)?e:System.Gadget.path+"/"+e).replace(/\s/g,encodeURIComponent(" "))+")":"";if(this.wallpaper_opacity)n.opacity=this.wallpaper_opacity;if(this.wallpaper_bg_color)LdesktopBG_host.style.backgroundColor=this.wallpaper_bg_color}}else e=this._wallpaper_last;var a="HKCU\\Control Panel\\Desktop\\";if(t==null){t=oShell.RegRead(a+"WallpaperStyle")}if(this._wallpaper_style!=t){o=true;this._wallpaper_style=t}if(t=="0"){n.backgroundSize="";n.backgroundPosition="center center";if(oShell.RegRead(a+"TileWallpaper")=="0"){n.backgroundRepeat="no-repeat"}else{n.backgroundRepeat=""}}else if(t=="2"){n.backgroundSize="100% 100%";n.backgroundPosition="";n.backgroundRepeat=""}else if(t=="6"){n.backgroundSize="contain";n.backgroundPosition="center center";n.backgroundRepeat="no-repeat"}else{n.backgroundSize="cover";n.backgroundPosition="center center";n.backgroundRepeat="no-repeat";if(browser_native_mode){n.width="100%";n.height="100%"}else{n.pixelWidth=parent.screen.width;n.pixelHeight=parent.screen.height}if(windows_mode&&e){var s=loadImageDim(/^(\/|[\w\-]+\:)/.test(e)?e:System.Gadget.path+toLocalPath("\\")+e);if(s.w){var r=parent.screen.width/parent.screen.height;var _=(parent.screen.width*2-parent.screen.availWidth)/(parent.screen.height*2-parent.screen.availHeight);var l=s.w/s.h;if(l<r){n.pixelHeight=l<_?parent.screen.height*2-parent.screen.availHeight:Math.round(parent.screen.width/l)}else if(l>r){n.pixelWidth=l>_?parent.screen.width*2-parent.screen.availWidth:Math.round(parent.screen.height*l)}}}}if(this.wallpaper_canvas_update&&o){this.wallpaper_canvas_update(e,t);DEBUG_show("(Wallpaper canvas updated)",2)}},WMPMask_Draw:function(e){if(!this.C_WMP_wallpaper_mask_resized)return;if(!e)e=parent.SL;if(!e||!e.width)return;var t=document.body.style;var i=t.pixelWidth;var n=t.pixelHeight;if(!i)return;var o=0;var a=0;var s=e.width;var r=e.height;var _=this.C_WMP_wallpaper_mask_resized;if(_.width!=s){_.width=s;_.height=r;var l=parent.C_WMP_wallpaper_mask;_.getContext("2d").drawImage(l,0,0,l.width,l.height,0,0,s,r)}var c=this.bg_mask_image_resized;if(c&&c.width!=i){c.width=i;c.height=n;var d=this.bg_mask_image;c.getContext("2d").drawImage(d,0,0,d.width,d.height,0,0,i,n)}var i,n;i=self.B_content_width?B_content_width:document.body.style.pixelWidth;n=self.B_content_height?B_content_height:document.body.style.pixelHeight;var p=parent.SA_child_animation[SA_child_animation_id];var m=p.x;var u=p.y;if(is_SA_child_animation&&parent.EQP_border_width){m-=parent.EQP_border_width;u-=parent.EQP_border_width}var f=m-o;var h=f;if(f<0)f=0;if(h<0)h=-h;else h=0;var M=u-a;var g=M;if(M<0)M=0;if(g<0)g=-g;else g=0;var y=s+o-m;if(y>i)y=i;var b=r+a-u;if(b>n)b=n;var v=this.C_WMP_wallpaper_mask_mixed_resized;if(v.width!=i||v._x!=f||v._y!=M){v.width=i;v.height=n;var w=v.getContext("2d");w.drawImage(_,f,M,y,b,h,g,y,b);if(c)w.drawImage(c,0,0);v._x=f;v._y=M}var S=document.getElementById("C_wallpaper_mask");if(!S)return;S.width=i;S.height=n;var w=S.getContext("2d");w.globalCompositeOperation="copy";w.drawImage(e,f,M,y,b,h,g,y,b);w.globalCompositeOperation="destination-in";w.drawImage(v,0,0)},BGMask_CreateCanvas:function(e,t){if(!e)return null;if(!/^\((.+)\)$/.test(e)){return null}var i=RegExp.$1.split("|");var n=i[0];var o;if(n=="circle"){var a=parseInt(i[1]);var s=parseInt(i[2]);o=document.createElement("canvas");o.width=a;o.height=s;var r=a<s?a:s;var _=o.getContext("2d");_.beginPath();_.arc(a/2,s/2,r/2,0,Math.PI*2);_.fill()}else if(n=="feather"){var a=parseInt(i[1]);var s=parseInt(i[2]);var l=parseInt(i[3]);if(!l)l=parseInt(Math.sqrt(a*a+s*s)/25);o=document.createElement("canvas");o.width=a;o.height=s;var _=o.getContext("2d");var c;if(t)c=_.createImageData(a,s);else{_.fillRect(0,0,a,s);c=_.getImageData(0,0,a,s)}var d=c.data;for(var p=3,m=d.length;p<m;p+=4){var u=(p-3)/4;var f=u%a;var h=parseInt(u/a);var M=1.2;var g=1;if(f<l)g=(f+1)/(l+1);else if(f>=a-l)g=(a-f)/(l+1);g=1-(1-g)*M;if(g<0)g=0;var y=1;if(h<l)y=(h+1)/(l+1);else if(h>=s-l)y=(s-h)/(l+1);y=1-(1-y)*M;if(y<0)y=0;var b=g<y?g:y;if(b==1)continue;if(g<1&&y<1){var v=1-g;var w=1-y;var S=v>w?w/v:v/w;var A=Math.sqrt(1+S*S);b=1-(1-b)*A;if(b<0)b=0}d[p]=t?Math.round(255*(1-b)):Math.round(255*b)}_.putImageData(c,0,0)}return o},BGMask_Create:function(e){var t=this.bg_mask;if(!t)return;if(e){this.wallpaper_canvas=C_wallpaper_mask;C_wallpaper_mask.style.display="none"}else{var i=this.wallpaper_canvas=document.createElement("canvas");if(!is_SA_child_animation){i.width=parent.screen.width;i.height=parent.screen.height;i.getContext("2d").drawImage(C_wallpaper_mask,0,0)}}if(self.CANVAS_Video_Overlay&&CANVAS_Video_Overlay._canvas_wall)CANVAS_Video_Overlay._canvas_wall._match_str=null;if(self.EQP_use_wallpaper){EQP_ps.forEach(function(e){if(e.is_wallpaper&&e.img)e.img.img_obj._match_str=null})}if(/^\((.+)\)$/.test(t)){this.bg_mask_image=this.BGMask_CreateCanvas(t,is_SA_child_animation);this.BGMask_onload();return}var n=this.bg_mask_image=new Image;n.onload=this.BGMask_onload;n.src=toFileProtocol(t)},BGMask_onload:function(){var e=document.getElementById("C_BG_mask");if(!e){e=document.createElement("canvas");e.id="C_BG_mask";var t=e.style;t.position="absolute";t.posTop=t.posLeft=0;t.zIndex=60+1;document.body.appendChild(e)}if(System._browser.mouseover_hide_list.indexOf(e)==-1)System._browser.mouseover_hide_list.push(e);if(is_SA_child_animation){System._browser.bg_mask_image_resized=document.createElement("canvas")}else{System._browser.BGMask_Draw()}},BGMask_Draw:function(e){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom)){this.WMPMask_Draw();return}if(!document.getElementById("C_BG_mask"))return;var t,i,n,o;t=n=self.B_content_width?B_content_width:document.body.style.pixelWidth;i=o=self.B_content_height?B_content_height:document.body.style.pixelHeight;if(n>parent.screen.width)n=parent.screen.width;if(o>parent.screen.height)o=parent.screen.height;var a,s,r,_;var l=C_wallpaper_mask.style;if(l.posLeft>0){a=0;r=l.posLeft}else{a=-l.posLeft;r=0}if(l.posTop>0){s=0;_=l.posTop}else{s=-l.posTop;_=0}if(e){var c=a+","+s+","+n+","+o+","+r+","+_+","+n+","+o;if(e._match_str==c)return;e._match_str=c;e.width=t;e.height=i;var d=e.getContext("2d");d.globalCompositeOperation="copy";d.drawImage(this.wallpaper_canvas,a,s,n,o,r,_,n,o);return}if(!this.bg_mask_image&&this.Opacity==1){document.getElementById("C_BG_mask").style.display="none";return}C_BG_mask.width=t;C_BG_mask.height=i;var d=C_BG_mask.getContext("2d");d.globalCompositeOperation="copy";d.globalAlpha=this.bg_mask_image?1:1-this.Opacity;d.drawImage(this.wallpaper_canvas,a,s,n,o,r,_,n,o);if(this.bg_mask_image){d.globalCompositeOperation="destination-out";d.globalAlpha=this.Opacity;d.drawImage(this.bg_mask_image,0,0,n,o)}else C_BG_mask.style.display="block"},resize_timerID:null,resize_cooling_timestamp:0,resize:function(){var e=false;function i(){if(!e){e=true;setTimeout(function(){window.dispatchEvent(new CustomEvent("SA_resized_once"))},0)}}return function(){this.resize_timerID=null;if(use_SA_browser_mode){let t=document.body.style;if(is_SA_child_animation){let e=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;e.width=t.pixelWidth+"px";e.height=t.pixelHeight+"px";i()}else{if(webkit_electron_mode){if(webkit_electron_mode&&SA_topmost_window.System._browser.capturePage_in_process){this.resize_timerID=setTimeout("System._browser.resize()",50);return}if(webkit_electron_mode)System._browser.resize_cooling_timestamp=performance.now();SA_top_window.resizeToAbsolute(t.pixelWidth+(xul_mode?SA_top_window.outerWidth-SA_top_window.innerWidth:0),t.pixelHeight+(xul_mode?SA_top_window.outerHeight-SA_top_window.innerHeight:0))}i()}}}}(),drag_mouse_x:-1,drag_mouse_y:-1,drag_timerID:null,_is_dragging:false,get is_dragging(){return this._is_dragging},set is_dragging(e){this._is_dragging=e;document.body.style.cursor=e?"move":"auto"},mouseout_timerID:null,mouseover_hide_list:[],onmouseover_custom:null,onmouseover:function(e){if(webkit_electron_mode&&(SA_topmost_window.returnBoolean("IgnoreMouseEvents")||SA_topmost_window.returnBoolean("AutoItStayOnDesktop"))&&!SA_topmost_window.webkit_IgnoreMouseEvents_disabled)return;if(this.onmouseover_custom&&this.onmouseover_custom(e))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var t=this.mouseover_hide_list;for(var i=0;i<t.length;i++)t[i].style.visibility="hidden"},onmouseout_waiting_custom:null,onmouseout_waiting:function(e){if(this.onmouseout_waiting_custom&&this.onmouseout_waiting_custom(e))return;if(this.mouseout_timerID){clearTimeout(this.mouseout_timerID);this.mouseout_timerID=null}var t=e.clientX;var i=e.clientY;var n=document.body.style;var o=t>0&&t<n.pixelWidth&&(i>0&&i<n.pixelHeight);if(w3c_mode)e.stopPropagation();this.mouseout_timerID=setTimeout("System._browser.onmouseout("+o+")",200)},onmouseout:function(e){this.mouseout_timerID=null;if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}if(this.is_dragging){this.is_dragging=false;e=false;this.showFocus(false);System.Gadget.Settings._writeSettings(true,true)}else if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.is_dragging=false;this.showFocus(false)}if(e)return;var t=this.mouseover_hide_list;for(var i=0;i<t.length;i++)t[i].style.visibility="inherit";this.BGMask_Draw()},onmousedown:function(i){if(this.drag_timerID){clearTimeout(this.drag_timerID);this.drag_timerID=null}var e=this.mouseover_hide_list;var t=true;for(var n=0;n<e.length;n++){var o=e[n].style;if(o.visibility!="hidden"){o.visibility="hidden";t=false}}var a;if(!t&&!is_SA_child_animation&&SA_child_animation_max){for(var n=0;n<SA_child_animation_max;n++){if(SA_child_animation[n]){a=true;break}}}t=!a;if(t){let e,t;if(WallpaperEngine_mode){e=i.x;t=i.y}else{if(absolute_screen_mode){e=SA_top_window.getCursorPos().x;t=SA_top_window.getCursorPos().y}else{e=i.screenX;t=i.screenY}}if(!is_SA_child_animation?i.button==2:!parent.returnBoolean("ChildDragDisabled")){this.drag_timerID=setTimeout("System._browser.onmousedown_dragStart("+e+","+t+")",200)}}else DEBUG_show("(focused)",1)},showFocus:function(e,t){if(is_SA_child_animation){if(!xul_mode||!this.is_dragging)parent.System._browser.showFocus(e)}if(!e){Ldrag_dummy.style.visibility="hidden";return}var i=document.body.style.pixelWidth;var n=document.body.style.pixelHeight;if(i&&n){var o=Ldrag_dummy.style;o.pixelWidth=i-2;o.pixelHeight=n-2;o.visibility="inherit"}if(t)DEBUG_show("(selected)",1)},arrangeChildZ:function(i){System.Gadget.Settings._settings_need_update=true;var e=[];for(var t=0;t<SA_child_animation_max;t++){if(SA_child_animation[t])e[t]={index:t,z:SA_child_animation[t].z}}e.sort(function(e,t){return e.index==i?1:t.index==i?-1:e.z-t.z}).forEach(function(e,t){SA_child_animation[e.index].z=document.getElementById("Ichild_animation"+e.index).style.zIndex=t})},_child_selected:null,_drag_disabled:false,_child_drag_disabled:false,onmousedown_dragStart:function(e,t){this.drag_timerID=null;if(WallpaperEngine_mode)return;if(is_SA_child_animation&&is_SA_child_animation_host){parent.System._browser.is_dragging=true;parent.System._browser.drag_mouse_x=e;parent.System._browser.drag_mouse_y=t;DEBUG_show("drag start",1);this.showFocus(true);return}if(!this._drag_disabled&&(!is_SA_child_animation||!parent.System._browser._child_drag_disabled)){this.is_dragging=true;this.drag_mouse_x=e;this.drag_mouse_y=t;DEBUG_show("drag start",1)}this.showFocus(true);if(is_SA_child_animation){parent.System._browser.arrangeChildZ(SA_child_animation_id)}},_BL_clicked:0,_BL_clicked_max:1,_BL_clicked_timerID:null,onmouseup_custom:null,onmouseup:function(e){if(this.onmouseup_custom&&this.onmouseup_custom(e))return;this.onmouseout(true);if(this._drag_disabled||is_SA_child_animation&&parent.System._browser._child_drag_disabled)this.showFocus(false);if(e.clientX>20||e.clientY<document.body.style.pixelHeight-20)return;if(this._BL_clicked_timerID){clearTimeout(this._BL_clicked_timerID);this._BL_clicked_timerID=null}if(++this._BL_clicked<this._BL_clicked_max){this._BL_clicked_timerID=setTimeout("System._browser._BL_clicked_timerID=null; System._browser._BL_clicked=0;",250);return}this._BL_clicked=0;if(!WallpaperEngine_mode&&(!self.Lquick_menu||!Lquick_menu._activated))this.confirmClose()},confirmClose:function(e){if(browser_native_mode){if(confirm("This will reload System Animator.")){SA_topmost_window.location.reload()}return}if(!e||xul_mode){System._browser.showFocus(true,true);var t=is_SA_child_animation?" (child"+(SA_child_animation_id+1)+")":"";if(SA_top_window.is_SA_hosted){if(confirm("Close "+SystemEXT._default.gadget_name+" (XUL host)?")){SA_top_window.opener.close();return}t+=" (this animation only)"}System._browser.showFocus(false)}if(is_SA_child_animation){if(is_SA_child_animation_host){parent.System._browser.confirmClose(e)}else{parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id]=null;var i=parent.document.getElementById("Ichild_animation"+SA_child_animation_id);i.style.pixelWidth=i.style.pixelHeight=0;i.style.visibility="hidden";i.contentWindow.location.replace("z_blank.html")}}else{if(WallpaperEngine_CEF_mode&&!W8_or_above){SA_top_window.location.reload()}else SA_top_window.close()}},onSettings:function(e){if(!e&&/XR Animator$/.test(Settings.f_path)&&MMD_SA.MMD_started){const o=MMD_SA_options.Dungeon.dialogue_branch_mode?.find?.(e=>e.is_closing_event);if(MMD_SA_options.Dungeon.dialogue_branch_mode&&!o)return false;new Promise(i=>{if(o){const n=Array.isArray(o.key)?o.key[0]:o.key;let e,t;if(typeof n=="number"){t=n+96}else if(n=="Esc"){e="Escape"}else{e="Key"+n}document.dispatchEvent(new KeyboardEvent("keydown",{code:e,keyCode:t}));System._browser.on_animation_update.add(i,0,0)}else{i()}}).then(()=>{new Promise(e=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.settings.confirm"),branch_list:[{key:1,func:()=>{e()},ended:true},{key:2}]}}]])}).then(()=>{this.onSettings(true)})});return false}if(!System.Gadget.settingsUI)return false;if(use_inline_dialog){if(document.getElementById("Idialog").style.visibility=="hidden"){document.getElementById("Idialog").contentWindow.location.replace("settings.html")}return true}System._browser.showFocus(true,true);var t=showModalDialog(System.Gadget.settingsUI,self);t=xul_mode?self.returnValue:t;System._browser.showFocus(false);this.onSettingsClosed(t);return true},onSettingsClosed:function(e){if(System.Gadget.onSettingsClosed)System.Gadget.onSettingsClosed({closeAction:!!e,Action:{commit:true}})},onkeydown:function(e){var t=(is_SA_child_animation||document.getElementById("Lchild_animation_parent"))&&!is_SA_child_animation_host;const i=e.altKey;const n=i||!self.MMD_SA||!MMD_SA_options.Dungeon_options||!e.preventDefault;var o=e.keyCode;if(o==67&&i){this.confirmClose();return true}else if(o==69&&n){return this.onSettings()}else if(o==79&&n){var a;if(is_SA_child_animation){var s=parent.document.getElementById("Ichild_animation"+SA_child_animation_id).style;a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}parent.System.Gadget.Settings._settings_need_update=true;parent.SA_child_animation[SA_child_animation_id].opacity=a;s.opacity=a}else if(this.bg_mask){a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}System.Gadget.Settings.writeString("Opacity",a);this.Opacity=a;this.BGMask_Draw()}else if(w3c_mode||HTA_use_GPU_acceleration){var s=this.body.style;a=this.Opacity;if("_opacity_"in e){a=e._opacity_}else{a-=.25;if(a<.25)a=1}System.Gadget.Settings.writeString("Opacity",a);s.opacity=a}else return false;this.Opacity=a;DEBUG_show("Opacity:"+a*100+"%",2);this.update_tray();return true}else if(o==83&&n){var r=System.Gadget.docked?System.Gadget.onUndock:System.Gadget.onDock;if(!r)return false;setTimeout(System._browser.ondockundock,0);return true}else if(t&&(o>=49&&o<49+SA_child_animation_max)&&n){var _=o-49;var l=is_SA_child_animation?parent:self;var c=l.document.getElementById("Ichild_animation"+_);if(!c||!c.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(_+1)+" not found)",2);return true}var d=c.contentWindow;var p=d.parent;var m=p.System._browser;if(d.System.Gadget.Settings.readString("CSSTransform3D")||p.System.Gadget.Settings.readString("CSSTransform3D")){if(m._child_selected==_){m._child_selected=null;d.DEBUG_show("(deselected)",2);p.DEBUG_show("(child"+(_+1)+" deselected)",2);return true}m._child_selected=_}d.DEBUG_show("(selected)",2);p.DEBUG_show("(child"+(_+1)+" selected)",2);m.arrangeChildZ(_);d.focus();return true}else if(t&&o==96&&n){var l=is_SA_child_animation?parent:self;var s=l.Lchild_animation_parent.style;s.visibility=s.visibility=="hidden"?"visible":"hidden";if(webkit_mode)s.display=s.visibility=="hidden"?"none":"block";l.System._browser._child_selected=null;return true}else if(t&&(o>=97&&o<97+SA_child_animation_max)&&n){var _=o-97;var l=is_SA_child_animation?parent:self;var c=l.document.getElementById("Ichild_animation"+_);if(!c||!c.contentWindow.is_SA_child_animation){DEBUG_show("(child animation "+(_+1)+" not found)",2);return true}var s=c.style;s.visibility=s.visibility=="hidden"?"visible":"hidden";if(webkit_mode)s.display=s.visibility=="hidden"?"none":"block";l.System._browser._child_selected=null;var u=false;for(var f=0;f<SA_child_animation_max;f++){var c=l.document.getElementById("Ichild_animation"+f);if(c&&c.contentWindow.is_SA_child_animation&&c.style.visibility!="hidden"){u=true;break}}l.document.getElementById("Lchild_animation_parent").style.visibility=u?"visible":"hidden";return true}else if(o>=96&&o<96+10||o>=48&&o<48+10){if(o<96)o+=48;if(self.MMD_SA&&MMD_SA_options.motion_shuffle&&MMD_SA.use_jThree&&MMD_SA.MMD_started){if(this.camera.ML_enabled){}else if(o==96){if(MMD_SA_options.audio_to_dance_disabled)return true;if(MMD_SA_options._motion_shuffle){if(!MMD_SA_options.motion_shuffle_list_default&&MMD_SA_options._motion_shuffle_list_default){MMD_SA_options.motion_shuffle_list_default=MMD_SA_options._motion_shuffle_list_default.slice();MMD_SA._force_motion_shuffle=true}else{MMD_SA_options.motion_shuffle=MMD_SA_options._motion_shuffle.slice(0);MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motions shuffled)",2)}}}else{let t=o-97;if(MMD_SA_options.motion_by_song_name){if(MMD_SA_options.motion_by_song_name._loading_){DEBUG_show("(music/motion loading)",2);return true}let e=Object.keys(MMD_SA_options.motion_by_song_name).find(e=>{return MMD_SA_options.motion_by_song_name[e].key==t+1});if(e){let t=MMD_SA_options.motion_by_song_name[e].song_path;if(/\.zip\#/i.test(t)){MMD_SA_options.motion_by_song_name._loading_=true;t=t.replace(/^.+[\/\\]([^\/\\]+\.zip)/i,"$1");let e=new self.XMLHttpRequestZIP;e.onload=function(){MMD_SA_options.motion_by_song_name._loading_=false;let e=this.response;e.name=t.replace(/^.+[\/\\]/,"");e.isFileSystem=true;SA_DragDropEMU(e)};e.open("GET",t,true);e.responseType="blob";e.send()}else SA_DragDropEMU(t);return true}}if(MMD_SA_options.audio_to_dance_disabled)return true;if(t>=MMD_SA.normal_action_length){DEBUG_show("(MMD motion not found)",2);return true}if(!MMD_SA_options._motion_shuffle)MMD_SA_options._motion_shuffle=MMD_SA_options.motion_shuffle.slice(0);MMD_SA_options.motion_shuffle=[t];MMD_SA_options.motion_shuffle_list_default=null;MMD_SA._force_motion_shuffle=true;DEBUG_show("(MMD motion changed)",2)}return true}}return false},ondockundock:function(){DEBUG_show("Dock state changed",2);var e=!System.Gadget.docked;System.Gadget.docked=e;System.Gadget.Settings.writeString("SA_docked",!!e==!!is_SA_child_animation?"":e?"1":"0");var t=!e?System.Gadget.onUndock:System.Gadget.onDock;if(!t)return;t()},onmousemove_custom:null,onmousemove:function(e){var t,i;t=this._WE_mouse_x=e.x;i=this._WE_mouse_y=e.y;if(this.onmousemove_custom&&this.onmousemove_custom(e))return;if(!this.is_dragging){if(is_SA_child_animation&&parent.System._browser.is_dragging){parent.System._browser.onmousemove(e)}return}if(!WallpaperEngine_mode){if(absolute_screen_mode){t=SA_top_window.getCursorPos().x;i=SA_top_window.getCursorPos().y}else{t=e.screenX;i=e.screenY}}if(is_SA_child_animation||this._child_selected!=null){var n,o,a;if(is_SA_child_animation){a=SA_child_animation_id;n=self;o=parent}else{a=this._child_selected;n=document.getElementById("Ichild_animation"+a).contentWindow;o=self}o.System.Gadget.Settings._settings_need_update=true;var s=o.SA_child_animation[a];var r=o.document.getElementById("Ichild_animation"+a).style;var _=n.document.body.style;var l=o.document.body.style;var c=s.x+t-this.drag_mouse_x;var d=s.y+i-this.drag_mouse_y;r.posLeft=s.x=c;r.posTop=s.y=d;n.document.getElementById("Ldebug").innerText=o.document.getElementById("Ldebug").innerText="(moving)";n.DEBUG_hide_sec=o.DEBUG_hide_sec=0;n.DEBUG_show("("+c+","+d+")",2)}else{System.Gadget.Settings._settings_need_update=true;this.moveBy(t-this.drag_mouse_x,i-this.drag_mouse_y,e)}this.moveWallpaper();this.drag_mouse_x=t;this.drag_mouse_y=i},moveWallpaper:function(e,t){if(is_SA_child_animation&&(!document.getElementById("C_wallpaper_mask")||!C_wallpaper_mask._WallpaperAsBG_custom))return;if(is_SA_child_animation||document.getElementById("LdesktopBG")&&LdesktopBG.style.display!="none"){if(WallpaperEngine_mode){e=0;t=0}else{if(absolute_screen_mode){if(e==null)e=SA_top_window.screenLeftAbsolute;if(t==null)t=SA_top_window.screenTopAbsolute;var i=SA_top_window.getScreenBounds(e,t);e=-(e-i.x);t=-(t-i.y)}else{if(e==null)e=SA_top_window.screenLeft;if(t==null)t=SA_top_window.screenTop;e=-(e%parent.screen.width);t=-(t%parent.screen.height)}}if(is_SA_child_animation){var n=parent.SA_child_animation[SA_child_animation_id];e-=n.x;t-=n.y}else{var o=(is_SA_child_animation_host&&Ichild_animation0.contentWindow.document.getElementById("LdesktopBG")||LdesktopBG).style;o.posLeft=e;o.posTop=t}if(document.getElementById("C_wallpaper_mask")){var a=C_wallpaper_mask.style;a.posLeft=e;a.posTop=t}}},moveBy:function(e,t,i){SA_top_window.moveByAbsolute(e,t)},update_tray:function(e,t){try{if(!webkit_electron_mode||IPC.active_window!=self)return;if(!t&&this._tray_last_updated==RAF_timestamp)return;this._tray_last_updated=RAF_timestamp;if(!e){e={active_window_id:IPC.active_window_id,click_thru:SA_topmost_window.returnBoolean("IgnoreMouseEvents"),click_thru_partial:SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial"),always_on_top:SA_topmost_window.returnBoolean("AutoItAlwaysOnTop"),stay_on_desktop:SA_topmost_window.returnBoolean("AutoItStayOnDesktop"),use_electron_as_wallpaper:SA_topmost_window.WebKit_object.use_electron_as_wallpaper,auto_pause:SA_topmost_window.returnBoolean("AutoItAutoPause"),opacity:is_SA_child_animation?parent.SA_child_animation[SA_child_animation_id].opacity:parseFloat(System.Gadget.Settings.readString("Opacity")||1),opacity_on_hover:parseFloat(System.Gadget.Settings.readString("OpacityOnHover")||1),size:Settings.CSSTransformFullscreen?-1:Settings.CSSTransformScale,animation_path:Settings.f_path_folder,media_control:self.SL&&SL._mouse_event_main&&SL._mouse_event_main(),MMD:null};var i=[true];for(var n=0;n<SA_child_animation_max;n++)i.push(!!SA_topmost_window.SA_child_animation[n]);e.active_window=i;e.lock_child_dragging=returnBoolean("ChildDragDisabled");var o=this.tray_menu_custom;if(o){e.custom_menu_para=o.para;o.update_tray&&o.update_tray(e)}else{e.custom_menu_para={}}if(self.MMD_SA&&MMD_SA._tray_updatable){var a=MMD_SA_options.MME;var s=e.MMD={use_webgl2:!!MMD_SA.use_webgl2,use_dungeon:!!MMD_SA_options.Dungeon,use_THREEX:!!MMD_SA.THREEX.enabled,look_at_camera:!!MMD_SA_options._look_at_screen,look_at_mouse:!!MMD_SA_options._look_at_mouse,trackball_camera:!!returnBoolean("MMDTrackballCamera"),random_camera:!!returnBoolean("MMDRandomCamera"),random_camera_available:!!MMD_SA_options.use_random_camera,override_default_for_external_model:!!returnBoolean("MMDOverrideDefaultForExternalModel"),VMC_sender_enabled:!!MMD_SA.OSC.VMC.sender_enabled,VMC_send_camera_data:!!MMD_SA.OSC.VMC.send_camera_data,VMC_app_mode:MMD_SA.OSC.app_mode||"",VMC_hide_3D_avatar:!!MMD_SA.hide_3D_avatar,light:{},MME:{self_overlay:{},HDR:{},serious_shader:{},SAO:{},PostProcessingEffects:{}}};s._material_list=MMD_SA._material_list||[];if(MMD_SA._model_list){s._model_list=MMD_SA._model_list;MMD_SA._model_list=null}var r=jThree("#MMD_DirLight").three(0);var _=r.color;s.light.color=[Math.min(255,parseInt(_.r*256)),Math.min(255,parseInt(_.g*256)),Math.min(255,parseInt(_.b*256))];s.light.position=r.position.clone().sub(MMD_SA_options.MMD_disabled&&{x:0,y:0,z:0}||THREE.MMD.getModels()[0].mesh.position).multiplyScalar(1/MMD_SA_options.light_position_scale).toArray();s.shadow_darkness=MMD_SA_options.shadow_darkness;Object.assign(s.MME.self_overlay,a.self_overlay);Object.assign(s.MME.HDR,a.HDR);Object.assign(s.MME.serious_shader,a.serious_shader);Object.assign(s.MME.SAO,a.SAO);var l=MMD_SA_options.MME.PostProcessingEffects;var c=s.MME.PostProcessingEffects;c.enabled=returnBoolean("Use3DPPE")||!!(MMD_SA_options.PPE_disabled_on_idle?MMD_SA_options._PPE_enabled:l.enabled);c.use_SAO=!!l.use_SAO;c.use_Diffusion=!!l.use_Diffusion;c.use_BloomPostProcess=!!l.use_BloomPostProcess;c.use_BloomPostProcess_blur_size=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessBlurSize")||.5);c.use_BloomPostProcess_threshold=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessThreshold")||.5);c.use_BloomPostProcess_intensity=parseFloat(System.Gadget.Settings.readString("Use3DBloomPostProcessIntensity")||.5);s.MME_saved=!!MMD_SA_options.MME_saved[MMD_SA_options.model_para_obj._filename]}if(!document.getElementById("Lchild_animation_parent"))e.apply_to_child=null;else e.apply_to_child=returnBoolean("CSSTransformToChildAnimation")}webkit_electron_remote.getGlobal("update_tray")(e)}catch(e){console.error(e)}},load_file:function(t,i,n,o){if(!n)n="blob";if(!o)o=!(self.MMD_SA&&MMD_SA.fn);if(o){if(self.MMD_SA&&MMD_SA.fn){MMD_SA.fn.load_length_extra++}else{MMD_SA_options.load_length_extra=(MMD_SA_options.load_length_extra||0)+1}}var e;if(/\.zip\#/i.test(t)||n!="blob"||typeof i=="function"){e=function(){var e=new XMLHttpRequestZIP;e.onload=async function(){if(typeof i=="function"){await i(e)}else{i.src=URL.createObjectURL(this.response)}if(o){MMD_SA.fn.setupUI()}e=undefined};e.open("GET",toFileProtocol(t),true);e.responseType=n;e.send()}}else{e=function(){if(o){var e=function(){MMD_SA.fn.setupUI();i.removeEventListener("load",e)};i.addEventListener("load",e)}i.src=toFileProtocol(t)}}if(!self.XMLHttpRequestZIP){window.addEventListener("jThree_ready",function(){e()})}else{e()}},on_animation_update:function(){var a=[[],[]];var o=0;return{add:function(e,t,i,n){a[i].push({func:e,frame_count:t+i,loop:n,index:o++})},remove:function(t,e){a[e].forEach(e=>{if(e.func==t){e.canceled=true}})},run:function(e){var t=[];var i=a[e];if(!i.length)return;var n=[];for(let e=0;e<i.length;e++){const o=i[e];if(o.canceled){continue}if(--o.frame_count>=0){n.push(o)}else{o.func();if(o.loop&&--o.loop!=0)n.push(o)}}a[e]=n}}}(),get css_scale(){return window.devicePixelRatio>=2?.5:1},virtual_numpad_toggle:function(e){if(e==null)e=Lnumpad_row0.style.display=="none";Lnumpad_row0.style.display=e?"inline":"none";Lnumpad_rows.style.display=e?"block":"none";if(e&&self.ChatboxAT)ChatboxAT.chatW_minimize(0,true)},virtual_numpad:function(){var d={};var p={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,X:9};return function(e,t){e.preventDefault();e.stopPropagation();var i=MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.character.combat_mode;var n=e.target.textContent;var o=d[n]=d[n]||{};var a,s,r;switch(n){case"S":a=16;o.pressed=!o.pressed;const l=document.getElementsByClassName("Lnumpad_button");if(o.pressed&&MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode){for(let e=0;e<l.length;e++){const c=l[e];if(/([1-9])/.test(c.textContent))c.textContent=Object.entries(p).find(e=>e[1]==RegExp.$1)[0]}}else{for(let e=0;e<l.length;e++){const c=l[e];if(/([A-HX])/.test(c.textContent))c.textContent=Object.entries(p).find(e=>e[0]==RegExp.$1)[1]}}t=o.pressed?"keydown":"keyup";break;case"+":a=107;if(i){if(t=="keyup")return;o.pressed=!o.pressed;t=o.pressed?"keydown":"keyup"}break;case"-":a=109;break;case"*":a=106;break;case"/":a=111;break;case"⏎":a=13;break;case"J":a=32;break;case"↑":a=38;r="ArrowUp";break;case"↓":a=40;r="ArrowDown";break;case"←":a=37;r="ArrowLeft";break;case"→":a=39;r="ArrowRight";break;default:if(/([0-9])/.test(n))a=parseInt(n)+96;else r="Key"+n}if(o.timeoutID)clearTimeout(o.timeoutID);if(o.intervalID)clearTimeout(o.intervalID);o.timeoutID=o.intervalID=null;let _=new KeyboardEvent(t,{bubbles:true,cancelable:true,key:n,keyCode:a,code:r,shiftKey:d["S"]&&d["S"].pressed});document.dispatchEvent(_);if(t=="keydown"){if(/[\+S]/.test(n)&&(n!="+"||i)){e.target.style.opacity="0.75"}else{o.timeoutID=setTimeout(function(){o.intervalID=setInterval(function(){document.dispatchEvent(_)},100)},400)}}else{e.target.style.opacity=""}}}(),P2P_network:function(){var n;var o=0;var a={events:{peer:{},connection:{handshake_request:function(e,t){console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) responding handshake request from Peer-"+e.index+"("+e.id+")");t.send({handshake:{request:true}})},handshake_respond:function(e,t,i){if(i.request){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/client)'s handshake request accepted from Peer-"+e.index+"("+e.id+")");t.send({handshake:{accepted:true}})}else if(i.accepted){t.status="connected";console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) accepted handshake request from Peer-"+e.index+"("+e.id+")");if(e.para.events.connection.handshake_request_accecpted&&e.para.events.connection.handshake_request_accecpted[t.label]){e.para.events.connection.handshake_request_accecpted[t.label]({peer:e,connection:t,handshake:i});delete e.para.events.connection.handshake_request_accecpted[t.label]}}else{console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) rejected handshake request from Peer-"+e.index+"("+e.id+")");if(e.para.events.connection.handshake_request_rejected&&e.para.events.connection.handshake_request_rejected[t.label]){e.para.events.connection.handshake_request_rejected[t.label]({peer:e,connection:t,handshake:i});delete e.para.events.connection.handshake_request_rejected[t.label]}}},data:function(e,t,i){}},send_message:function(e){if(!e.command)t.content_window.ChatboxAT.ChatShow([e.name+": "+e.msg]);return null}}};function s(t,i){this._connection=i;this.status="connecting";t.connections[i.label]=this;var n=this;i.on("data",function(e){if(e.handshake){t.para.events.connection.handshake_respond(t,n,e.handshake)}else{t.para.events.connection.data(t,n,e)}});i.on("close",function(e){console.log("P2P_network: DataConnection"+"("+i.peer+"/"+i.label+"/host) closed");n.close(t)})}s.prototype.send=function(e){this._connection.send(e)};s.prototype.close=function(e){if(!e.connections[this.label])return;if(e.para.events.connection.close&&e.para.events.connection.close(e,this))return;delete e.connections[this.label];var t=this;setTimeout(function(){t._connection.close();t._connection=null},1e3)};Object.defineProperty(s.prototype,"peer",{get:function(){return this._connection.peer}});Object.defineProperty(s.prototype,"label",{get:function(){return this._connection.label}});function r(){}Object.defineProperty(r.prototype,"length",{get:function(){return Object.keys(this).length}});function e(t=Object.clone(a)){this.para=t;this.id=null;var e=this._peer=new Peer;this.index=o;this.connections=new r;this.status="connecting";var i=this;e.on("open",function(e){o++;if(!n)n=i;i.id=e;i.status="connected";console.log("P2P_network: Peer-"+i.index+"("+e+") connected");i.para.events.peer.open&&i.para.events.peer.open(i)});e.on("error",function(e){console.log("P2P_network: Peer-"+i.index+" error",e);if(i.para.events.peer.error_by_connection){i.para.events.peer.error_by_connection(e);delete i.para.events.peer.error_by_connection}else i.para.events.peer.error&&i.para.events.peer.error(i,e)});e.on("connection",function(e){if(t.events.peer.connection&&t.events.peer.connection(i,e))return;console.log("P2P_network: Remote Peer"+"("+e.peer+"/"+e.label+"/client) connecting to Peer-"+i.index+"("+i.id+")");e.on("open",function(){console.log("P2P_network: Remote Peer"+"("+e.peer+"/"+e.label+"/client) connected to Peer-"+i.index+"("+i.id+")");new s(i,e)})})}e.prototype.connect=function(o,e){var a=this;return new Promise(function(i,n){var e=function(){var e={serialization:"json"};var t=a._peer.connect(o,e);t.on("open",function(){console.log("P2P_network: Remote Peer"+"("+t.peer+"/"+t.label+"/host) connecting to Peer-"+a.index+"("+a.id+")");var e=new s(a,t);a.para.events.connection.handshake_request(a,e);a.para.events.connection.handshake_request_accecpted=a.para.events.connection.handshake_request_accecpted||{};a.para.events.connection.handshake_request_rejected=a.para.events.connection.handshake_request_rejected||{};a.para.events.connection.handshake_request_accecpted[t.label]=i;a.para.events.connection.handshake_request_rejected[t.label]=n;delete a.para.events.peer.error_by_connection});t.on("error",function(e){console.log("P2P_network: Remote connection failed",e);n(e)});a.para.events.peer.error_by_connection=n};switch(a.status){case"connected":e();break;default:setTimeout(function(){n(a)},0)}})};var t={peer:e,get peer_default(){return n},status:"off",get content_window(){return is_SA_child_animation_host?document.getElementById("Ichild_animation0").contentWindow:self},process_message:function(e,t){var i=this.peer_default;if(!i)return e;var n=this.content_window.document.getElementById("Flogin").id.value;var o=this.content_window.document.getElementById("Flogin").pass.value;var a=this.content_window.MMD_SA_options;var s=(n||a&&a.model_para_obj.character&&a.model_para_obj.character.name||"Anonymous").substring(0,16);var r=i&&i.connections.length;var _;if(!/^\//.test(e)){_=i.para.events.send_message({name:s,msg:e,id:n,pass:o})}else{var l,c,d;var p=this.content_window.ChatboxAT.checkChatCommand(e);l=p.command;c=p.para1;d=p.para2;_=i.para.events.send_message({name:s,msg:e,command:l,para1:c,para2:d,id:n,pass:o})}if(!t)this.content_window.document.getElementById("Fchat").msg.value="";if(_!=null)return _;return e}};return t}(),camera:function(){var Ye;var d,r;var p;var Ze,$e;var Je;var et;var tt;var H=true;var e=new URLSearchParams(self.location.search.substring(1));var it="";var ct="";var t=true;var _;var F=0;var L="";function i(){var s=Ye.video;if(!s.videoWidth||s.readyState<2){return}if(p.busy||RAF_animation_frame_unlimited&&!MMD_SA.WebXR.session&&L==Ye.video_frame_id&&!Je.bb_clear){Ze.wireframe._skip_frame=true;return}L=Ye.video_frame_id;F=RAF_timestamp;var o=Ye.video_canvas;var r=o.getContext("2d");if(Je.bb_clear){if(s.pause&&!s.paused||--Je.bb_clear<=0||Je._bb&&Je._bb_waiting){Je.bb_clear=Je._bb=Je._bb_waiting=null;r.globalCompositeOperation="copy"}else{if(Je._bb){r.globalCompositeOperation="source-over";r.fillStyle="black";let e=Je._bb[3];let t=Je._bb[0];let i=Je._bb[1]-e;let n=Je._bb[2]-t;e=Math.max(e-i*.25,0);t=Math.max(t-n*.25,0);i=Math.min(i*1.5,o.width);n=Math.min(n*1.5,o.height);if(Ye.video_flipped){e=o.width-(e+i)}r.fillRect(e,t,i,n);Je._bb=null;Je._bb_waiting=true}return}}var _,l;if(MMD_SA_options.user_camera.pixel_limit.disabled){_=s.videoWidth;l=s.videoHeight}else if(Ye.is_local_media){_=s.videoWidth;l=s.videoHeight;const n=MMD_SA_options.user_camera.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_;if(_*l>n[0]*n[1]){const c=Math.sqrt(_*l/(n[0]*n[1]));_=Math.round(_/c);l=Math.round(l/c)}}else{_=Ye.target_width;l=Ye.target_height}var a=MMD_SA_options.user_camera.display.webcam_as_bg?{scale:1,top:0}:MMD_SA_options.user_camera.display.video;if(!a.scale){if(o.style.pixelWidth!=window.innerWidth||o.style.pixelHeight!=window.innerHeight){o.style.width=window.innerWidth+"px";o.style.height=window.innerHeight+"px"}}else{let e=a.scale*(Ye.display_floating?MMD_SA_options.user_camera.display.floating_scale||MMD_SA_options.user_camera.display.floating&&1||.5:1);let i=~~(window.innerWidth*e);let n=~~(window.innerHeight*e);if(o.style.pixelWidth!=i||o.style.pixelHeight!=n){o.style.width=i+"px";o.style.height=n+"px";let e=(window.innerWidth-i)/2;let t=(window.innerHeight-n)/2;o.style.left=e*(1+(a.left!=null?a.left:-1))+"px";o.style.top=t*(1+(a.top!=null?a.top:0))+"px"}o.style.objectFit="contain"}let e,t;const i=Ye.stream?MMD_SA_options.user_camera.portrait_mode:0;if(i>1){e=l;t=_}else{e=_;t=l}if(o.width!=e||o.height!=t){o.width=e;o.height=t;r.globalCompositeOperation="copy";if(Ye.video_flipped){r.translate(e,0);r.scale(-1,1)}if(i>1){if(i==2){r.translate(e,0);r.rotate(Math.PI/2)}else{r.translate(0,t);r.rotate(-Math.PI/2)}}}if(_==s.videoWidth&&l==s.videoHeight){r.drawImage(s,0,0)}else{let e=_/l;let t=s.videoWidth/s.videoHeight;let i,n,o,a;if(e<=t){o=s.videoHeight*e;i=(s.videoWidth-o)/2;a=s.videoHeight;n=0}else{o=s.videoWidth;i=0;a=s.videoWidth/e;n=(s.videoHeight-a)/2}r.drawImage(s,i,n,o,a,0,0,_,l)}o.style.visibility=!Ye.visible||p.enabled||d.initialized&&d.worker_initialized&&!d.dets||Ye.hidden_enforced?"hidden":"inherit"}function o(){if(p.enabled){p.update_frame()}else{if(Ze.enabled){Ze.update_frame(true)}else if(d.enabled){d.update_frame(true)}if(Je.enabled||tt.enabled){I(true)}}const i=Ye.video_canvas_facemesh.style;if(!MMD_SA_options.user_camera.display.webcam_as_bg){const e=Ye.video_canvas.style;const t=MMD_SA_options.user_camera.display.wireframe.align_with_video?1:MMD_SA_options.user_camera.display.wireframe.scale||(is_mobile?.25:1);const n=~~(e.pixelWidth*t);const o=~~(e.pixelHeight*t);if(i.pixelWidth!=n||i.pixelHeight!=o){i.pixelWidth=n;i.pixelHeight=o;if(MMD_SA_options.user_camera.display.wireframe.align_with_video){i.posLeft=e.posLeft;i.posTop=e.posTop}else{let e=(window.innerWidth-n)/2;let t=(window.innerHeight-o)/2;i.left=e*(1+(MMD_SA_options.user_camera.display.wireframe.left!=null?MMD_SA_options.user_camera.display.wireframe.left:1))+"px";i.top=t*(1+(MMD_SA_options.user_camera.display.wireframe.top!=null?MMD_SA_options.user_camera.display.wireframe.top:-1))+"px"}}i.objectFit=e.objectFit}i.visibility=Ye.ML_enabled&&!MMD_SA_options.user_camera.display.wireframe.hidden?"inherit":"hidden"}var C;function a(){if(Ye.initialized){SL.style.transform=SL_2D_front.style.transform=Ye.mirror_3D?"scaleX(-1)":"none";Ye.video_canvas.style.transform=Ye.display_flipped?"scaleX(-1)":"none";Ye.reset_video_canvas()}if(!C&&Ye.initialized){C=true;System._browser.on_animation_update.add(i,0,0,-1);System._browser.on_animation_update.add(o,2,1,-1)}}function s(){SL.style.transform=SL_2D_front.style.transform=Ye.mirror_3D?"scaleX(-1)":"none";Ye.video_canvas.style.transform="none";Ye.reset_video_canvas();if(Ye.visible)return;if(C&&!Ye.ML_enabled){C=false;System._browser.on_animation_update.remove(i,0);System._browser.on_animation_update.remove(o,1);Ye.video_canvas_facemesh.style.visibility="hidden"}}var n=100;function l(e){if(!Ye.visible)return;var t=e.detail.keyCode;if(t==107)n+=10;else if(t==109)n-=10;else return;n=Math.max(Math.min(n,180),20);var i=Ye.video_canvas.getContext("2d");if(n==1){i.filter="none";DEBUG_show("Brightness:100%",2)}else{i.filter="brightness("+n+"%) contrast("+(100+(n-100)*.25)+"%)";DEBUG_show("Brightness:"+n+"%",2)}e.detail.result.return_value=true}var c=0;function m(e){if(!e)e=Ye.local_src||(webkit_electron_mode?"C:\\Users\\user\\Documents\\_.mp4":System.Gadget.path+"/js/headtrackr.mp4");if(/\.(png|jpg|jpeg|bmp|webp)$/i.test(e)){if(!Ye._image){Ye._image=new Image;Object.defineProperty(Ye._image,"videoWidth",{get:function(){return this.width}});Object.defineProperty(Ye._image,"videoHeight",{get:function(){return this.height}});Object.defineProperty(Ye._image,"readyState",{get:function(){return this.complete?4:0}})}if(Ye.video&&Ye.video.pause)Ye.video.pause();Ye.video=Ye._image;Ye._image.src=toFileProtocol(e)}else{Ye.video=Ye._video;Ye.video.loop=true;if(!Ye.video._initialized){Ye.video._initialized=true;Ye.video.addEventListener("canplaythrough",function(e){if(Ye.stream){if(Ye.media_control_enabled){Ye.media_control_enabled=false}}else{Ye.media_control_enabled=true;let e=lt.speed;if(e){Ye.video.playbackRate=e;if(e<1)Ye.video.muted=true}else{Ye.video.playbackRate=1}}});Ye.video.addEventListener("ended",function(e){if(lt.speed)lt.stop()})}Ye.video.src=toFileProtocol(e)}Ye.video_id=e;Ye.local_src=e}let u=false;function f(e){SL_MC_Timeupdate(Ye.video)}window.addEventListener("MMDStarted",()=>{function e(e){if(!System._browser.camera.poseNet.enabled)return;const t=MMD_SA.MMD.motionManager.para_SA;if(!t.motion_tracking_upper_body_only||!t.motion_tracking?.arm_as_leg)return;window.addEventListener("SA_camera_poseNet_update",()=>{t.motion_tracking.arm_as_leg.enabled=!t.motion_tracking.arm_as_leg.enabled;_t.reset_to_default_motion_once=true;DEBUG_show("Arm-as-leg control:"+(t.motion_tracking.arm_as_leg.enabled?"ON":"OFF"),3)},{once:true})}const t={id:"arm_to_leg_control_mode",accelerator:["Alt+Q"],process:e};if(System._browser.hotkeys._hotkey_config){System._browser.hotkeys._hotkey_config.push(t)}else{System._browser.hotkeys.add(t)}});var h=false;function V(){at();var e=Ze.enabled||Je.enabled;if(h==!!e)return;h=!!e;_t.reset();if(e){a();_t.add_events();DEBUG_show("(Camera ML Mode:ON)",2)}else{if(Ye.initialized){Ye.video_canvas_face_detection.style.visibility="hidden";Ye.video_canvas_facemesh.style.visibility="hidden";s()}if(!Ye.mocap_enabled)_t.remove_events();Ye._info="";DEBUG_show("(Camera ML Mode:OFF)",2)}}var G,Q,dt;var nt,Be,Oe,qe;var Xe,Ue,Ce,pt,mt,ut;var ot,Ke;var W,N;var Y;var ft;var ht={};var Ve=["親","人","中","薬","小"];var Mt=["thumb","index","middle","ring","pinky"];var Ge=["０","１","２","３"];var gt={};window.addEventListener("jThree_ready",()=>{nt=new THREE.Vector3;Be=new THREE.Vector3;Oe=new THREE.Vector3;qe=new THREE.Vector3;Y=new THREE.Vector3;Xe=new THREE.Quaternion;Ue=new THREE.Quaternion;Ce=new THREE.Quaternion;pt=new THREE.Quaternion;mt=new THREE.Quaternion;ut=new THREE.Quaternion;ot=new THREE.Matrix4;Ke=new THREE.Quaternion;W=new THREE.Vector2;N=new THREE.Vector2;ft=new THREE.Quaternion;["左","右"].forEach(e=>{ht[e]=new System._browser.data_filter([{type:"one_euro",id:"shoulder_rot",para:[30,.5,.25,1,1]}])});for(const e of["左","右"]){const i=gt[e]=[];for(let t=0;t<5;t++){i[t]=[];for(let e=0;e<4;e++){i[t][e]={pos:new THREE.Vector3,rot:new THREE.Vector3}}}}});var M;var g;var y;var yt=true;var bt=true;var vt;var Z=true;var b,wt,v;var Qe=false;var St=["nose","leftEye","rightEye","leftEar","rightEar","leftShoulder","rightShoulder","leftElbow","rightElbow","leftWrist","rightWrist","leftHip","rightHip","leftKnee","rightKnee","leftAnkle","rightAnkle"];var At=[0,2,5,7,8,11,12,13,14,15,16,23,24,25,26,27,28];var Dt=[];St.forEach(e=>{Dt.push({part:e,score:0})});var We,S,He;var A;function B(){if(A)return;A=true;const r=THREE.MMD.getModels()[0];const n=r.mesh.bones_by_name;const s=MMD_SA.THREEX.get_model(0);const e=n["左腕"].pmxBone.origin;const t=n["左ひじ"].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_z_rot=Math.PI/2+Math.atan2(t[1]-e[1],t[0]-e[0]);const i=n["左腕ＩＫ"].pmxBone.origin;MMD_SA_options.model_para_obj.left_arm_to_IK_xy=[e[0]-i[0],e[1]-i[1],e[2]-i[2]];MMD_SA_options.model_para_obj.left_arm_length=MMD_SA.TEMP_v3.fromArray(MMD_SA_options.model_para_obj.left_arm_to_IK_xy).length();MMD_SA_options.model_para_obj.left_palm_length=MMD_SA.TEMP_v3.fromArray(n["左手首"].pmxBone.origin).distanceTo(MMD_SA._v3a.fromArray(n["左中指１"].pmxBone.origin));MMD_SA_options.model_para_obj.arm_IK_offset={"左":(new THREE.Vector3).fromArray(n["左腕"].pmxBone.origin).sub(Be.fromArray(n["左腕ＩＫ"].parent.pmxBone.origin)),"右":(new THREE.Vector3).fromArray(n["右腕"].pmxBone.origin).sub(Be.fromArray(n["右腕ＩＫ"].parent.pmxBone.origin))};let o=n["右腕"].pmxBone.origin;MMD_SA_options.model_para_obj.shoulder_width=Math.abs(e[0]-o[0]);MMD_SA_options.model_para_obj.arm_axis={"左":(new THREE.Vector3).fromArray(i).sub(MMD_SA.TEMP_v3.fromArray(e)).normalize()};MMD_SA_options.model_para_obj.arm_axis["右"]=MMD_SA_options.model_para_obj.arm_axis["左"].clone().setX(-MMD_SA_options.model_para_obj.arm_axis["左"].x);const a=n["左足"].pmxBone.origin;const _=n["左足首"].pmxBone.origin;MMD_SA_options.model_para_obj.hip_center=(new THREE.Vector3).fromArray(a).setX(0);MMD_SA_options.model_para_obj.hip_center_offset=(new THREE.Vector3).fromArray(n["下半身"].pmxBone.origin).sub(MMD_SA_options.model_para_obj.hip_center);MMD_SA_options.model_para_obj.spine_length=n["首"].pmxBone.origin[1]-MMD_SA_options.model_para_obj.hip_center.y;MMD_SA_options.model_para_obj.left_heel_height=_[1];MMD_SA_options.model_para_obj.head_height_absolute=r.mesh.geometry.boundingBox.max.y-n["頭"].pmxBone.origin[1];MMD_SA_options.model_para_obj.leg_IK_offset={"左":(new THREE.Vector3).fromArray(n["左足"].pmxBone.origin).sub(Be.fromArray(n["左足ＩＫ"].parent?.pmxBone?.origin||[0,0,0])),"右":(new THREE.Vector3).fromArray(n["右足"].pmxBone.origin).sub(Be.fromArray(n["右足ＩＫ"].parent?.pmxBone?.origin||[0,0,0]))};MMD_SA_options.model_para_obj.left_leg_upper_length=a[1]-n["左ひざ"].pmxBone.origin[1];MMD_SA_options.model_para_obj.left_leg_lower_length=n["左ひざ"].pmxBone.origin[1]-_[1];MMD_SA_options.model_para_obj.left_leg_length=MMD_SA_options.model_para_obj.left_leg_upper_length+MMD_SA_options.model_para_obj.left_leg_lower_length;MMD_SA_options.model_para_obj.left_leg_IK=[a[0]-_[0],a[1]-_[1],a[2]-_[2]];let l=["左","右"];We={};l.forEach(o=>{["腕","ひじ"].forEach((e,t)=>{let i=o+e;let n=MMD_SA.get_bone_axis_rotation(r.mesh,i);We[i]={name:i,axis_rot:n,parent:t==0?{axis_rot:new THREE.Quaternion}:We[o+"腕"]};We[i].axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(We[i].parent.axis_rot,MMD_SA.TEMP_q.copy(We[i].axis_rot).conjugate())})});S={};S[1]=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(0,-Math.PI/2*1,Math.PI/2*1),"YZX");S[-1]=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(0,-Math.PI/2*-1,Math.PI/2*-1),"YZX");He={};He[1]=(new THREE.Quaternion).multiplyQuaternions(S[1],MMD_SA._q1.copy(We["左腕"].axis_rot).conjugate());He[-1]=(new THREE.Quaternion).multiplyQuaternions(S[-1],MMD_SA._q1.copy(We["右腕"].axis_rot).conjugate());MMD_SA_options.model_para_obj.rot_hand_adjust_base=S;MMD_SA_options.model_para_obj.rot_hand_adjust=He;MMD_SA_options.model_para_obj.finger_base={};l.forEach(s=>{Ve.forEach((e,t)=>{let o=s+e+"指";let i=t==0&&n[o+Ge[0]]?0:1;if(!n[o+Ge[i+0]])return;let a=MMD_SA_options.model_para_obj.finger_base[s+t]={base_index:i};for(let i=a.base_index+(t==0?0:-1),n=i;n<3;n++){let e=o+Ge[a.base_index+(n-i)];let t=MMD_SA.get_bone_axis_rotation(r.mesh,e,true);We[e]={name:e,axis_rot:t,parent:n==i?We[s+"ひじ"]:We[o+Ge[a.base_index+(n-1-i)]]};We[e].axis_rot_offset_inv=(new THREE.Quaternion).multiplyQuaternions(We[e].parent.axis_rot,MMD_SA.TEMP_q.copy(We[e].axis_rot).conjugate())}})});for(const M in We){if(M.indexOf("指")!=-1){MMD_SA.TEMP_v3.setEulerFromQuaternion(We[M].axis_rot,"ZYX");MMD_SA.TEMP_v3.z*=-1;We[M].axis_rot.setFromEuler(MMD_SA.TEMP_v3,"ZYX")}We[M].axis_rot_inv=We[M].axis_rot.clone().conjugate()}for(const M in We){if(M.indexOf("指")!=-1){We[M]._axis_rot_offset_inv_z=MMD_SA.TEMP_v3.setEulerFromQuaternion(MMD_SA.TEMP_q.copy(We[M].axis_rot_offset_inv).premultiply(We[M].parent.axis_rot_inv).multiply(We[M].parent.axis_rot),"ZYX").z}}MMD_SA_options.model_para_obj.rot_arm_adjust=We;console.log(We);const c=MMD_SA_options.model_para_obj.colliders_for_hands=MMD_SA_options.model_para_obj.colliders_for_hands||{};const d=nt.fromArray(s.get_bone_origin_by_MMD_name("左手首")).distanceTo(Be.fromArray(s.get_bone_origin_by_MMD_name("左中指"+Ge[1])));c.left_hand={children:[{bone:"leftHand",offset:[d,0,0],radius:d}]};c.generate_hand_parameters=function(){const e=this.left_hand.children[0].offset;const t=.5;const i={left:{offset:{x:e[0]*t,y:e[1]*t,z:e[2]*t}},right:{offset:{x:-e[0]*t,y:e[1]*t,z:e[2]*t}}};return i};c.reset_hit=function(){this._hit_={};for(const e of["左","右"])this._hit_[e]={}};c.reset_hit();c.record_hit=function(e,t){c._hit_[t][e.name.split("|")[0]]=true};c.debug_hit=(()=>{const o={head:"Head",chest:"Chest",spine:"Waist","下半身":"Hip"};return function(e,t){let i="";if(Je.enabled&&Je.body_collider.enabled){for(const t of["左","右"]){const n=t=="左"?"L":"R";i+="👊-"+n+":"+(Object.keys(this._hit_[t]).map(e=>o[e]).join(",")||"(no collider hit)")+"\n"}}this.reset_hit();return i}})();let p;if(s.type=="VRM"){p=s.model.springBoneManager.colliders.filter(e=>{if(!e.shape.radius)return false;let t=e;while(t){t=t.parent;if(t?.isBone){if(t.name=="Head")return true;break}}})}else if(!MMD_SA.THREEX.enabled){const g=n["頭"]._index;p=r.pmx.rigids.filter(e=>e.bone==g&&(e.shape==0||e.shape==2)).map(e=>{return{shape:{radius:e.size[0],offset:{x:e.ofs[0],y:e.ofs[1],z:e.ofs[2]}}}})}const m=s.get_bone_origin_by_MMD_name("頭")[1]-s.get_bone_origin_by_MMD_name("首")[1];const u=Math.max(s.para.shoulder_width/3,m);const f=s.type=="VRM"?1/MMD_SA.THREEX.VRM.vrm_scale:1;let h=[{shape:{radius:u,offset:{x:0,y:u*f,z:u*.5*f}}}];if(!c.head){c.head={get scale(){return Je.body_collider.head.size_percent/100},_head_colliders:p,_head_colliders_default:h,reset:function(){let e=this._head_colliders_default;const i=.7071067811865476;const n=nt.set(9999,9999,9999);const o=Be.set(-9999,-9999,-9999);e.forEach(e=>{let t=MMD_SA.TEMP_v3.copy(e.shape.offset).addScalar(e.shape.radius*i);o.max(t);t=MMD_SA.TEMP_v3.copy(e.shape.offset).addScalar(-e.shape.radius*i);n.min(t)});const t=new MMD_SA.THREEX.THREEX.Box3(n,o);const a=t.getBoundingSphere(new MMD_SA.THREEX.THREEX.Sphere(t.getCenter(Oe)));c.head.parent={is_parent:true,bone:"head",offset:s.type=="VRM"?s.process_position(Oe.multiplyScalar(MMD_SA.THREEX.VRM.vrm_scale)).toArray():Oe.toArray(),radius:a.radius};c.head.children=e.map(e=>{function t(e,t,i){const n=-s.para.spine_length/5;return e.z>n}const i={validate:t,rotation_base:true};return{bone:"head",offset:s.type=="VRM"?s.process_position(MMD_SA.TEMP_v3.copy(e.shape.offset).multiplyScalar(MMD_SA.THREEX.VRM.vrm_scale)).toArray():MMD_SA.TEMP_v3.copy(e.shape.offset).toArray(),radius:e.shape.radius,z_push:i}});if(c.head.children.length==1){c.head.children=[Object.assign({},c.head.parent,{is_parent:false,z_push:c.head.children[0].z_push,use_vector_filter:true})];c.head.parent=null}console.log(c.head)},generate_colliders:(()=>{let o,e;let t;return function(){if(!Je.body_collider.head.enabled)return[];if(o===this.scale&&e===Je.body_collider.head.reaction_type)return t;o=this.scale;e=Je.body_collider.head.reaction_type;t=(this.parent&&[this.parent]||[]).concat(this.children||[]).map((e,t)=>{const i=c.generate_hand_parameters();const n=e.radius*o+i.left.offset.x;return Object.assign({type:"bone",name:e.bone,offset:{x:e.offset[0],y:e.offset[1],z:e.offset[2]},hand_affected:i,auto_scale:false,peak_barrier:true,is_parent:e.is_parent,use_vector_filter:e.use_vector_filter,z_push:!e.is_parent&&Je.body_collider.head.reaction_type=="z_push"?e.z_push:null,magnet_id:"head_collider"+t,keep_validation_state_until_reset:true,on_hit:!e.is_parent&&c.record_hit},e.line_end?{magnet_type:"line",line_end:{x:e.line_end[0],y:e.line_end[1],z:e.line_end[2]},effective_distance:n,peak_distance:n}:{radius:n,peak_radius:n})});return t}})()}}c.head.reset();if(!c.chest){const y=s.para.shoulder_width/4;c.chest={get scale(){return Je.body_collider.chest.size_percent/100},children:[-1,1].map(e=>{function t(e,t,i){return true}const i=s.get_bone_origin_by_MMD_name("首")[1]-s.para.spine_length/3-s.get_bone_origin_by_MMD_name("上半身2")[1];return{bone:"chest",offset:[y*e,i,y*.5],radius:y,z_push:{validate:t,rotation_base:true}}}),generate_colliders:(()=>{let n;let e;return function(){if(!Je.body_collider.chest.enabled)return[];if(n===this.scale)return e;n=this.scale;e=(this.children||[]).map(e=>{const t=c.generate_hand_parameters();const i=e.radius*n+t.left.offset.x;return{type:"bone",name:e.bone,offset:{x:e.offset[0]*(1-THREE.Math.clamp(n-1,0,1)*.5),y:e.offset[1],z:e.offset[2]*(1+THREE.Math.clamp(n-1,0,2)*.5)},hand_affected:t,auto_scale:false,radius:i,peak_radius:i,peak_barrier:true,is_parent:e.is_parent,z_push:e.z_push,on_hit:c.record_hit}})}})()}}if(!c.waist){const b=s.para.shoulder_width/4;c.waist={get scale(){return Je.body_collider.waist.size_percent/100},children:[0,-b*.75,-b*1.5].map(e=>{function t(e,t,i){return true}return{bone:"spine",offset:[-b*1,e,-b*.5],radius:b*1.5,line_end:[b*1*2,0,0],z_push:{validate:t,rotation_base:true}}}),generate_colliders:(()=>{let n;let e;return function(){if(!Je.body_collider.waist.enabled)return[];if(n===this.scale)return e;n=this.scale;e=(this.children||[]).map(e=>{const t=c.generate_hand_parameters();const i=e.radius*n+t.left.offset.x;return{type:"bone",name:e.bone,offset:{x:e.offset[0],y:e.offset[1],z:e.offset[2]},hand_affected:t,magnet_type:"line",line_end:{x:e.line_end[0],y:e.line_end[1],z:e.line_end[2]},auto_scale:false,effective_distance:i,peak_distance:i,peak_barrier:true,is_parent:e.is_parent,use_vector_filter:true,z_push:e.z_push,on_hit:c.record_hit}})}})()}}if(!c.hip){const v=s.get_bone_origin_by_MMD_name("左足")[0];const w=MMD_SA.TEMP_v3.copy(s.para.hip_center_offset).negate();c.hip={get scale(){return Je.body_collider.hip.size_percent/100},children:[{bone:"下半身|hips",offset:[w.x-v*.5,w.y-v,w.z-v*.5],radius:v*.6,line_end:[v+v*.5*2,0,0],z_push:{validate:()=>true,rotation_base:true}},{bone:"下半身|hips",offset:[w.x-v*.5,w.y-v,w.z],radius:v*1.2,line_end:[v+v*.5*2,0,0]}],generate_colliders:(()=>{let o;let e;return function(){if(!Je.body_collider.hip.enabled)return[];if(o===this.scale)return e;o=this.scale;e=(this.children||[]).map((e,t)=>{const i=c.generate_hand_parameters();const n=e.radius*o+i.left.offset.x;return{type:"bone",name:e.bone,offset:{x:e.offset[0],y:e.offset[1]-Math.max(o-1,0)*e.radius*.5,z:e.offset[2]},hand_affected:i,magnet_type:"line",line_end:{x:e.line_end[0],y:e.line_end[1],z:e.line_end[2]},auto_scale:false,effective_distance:n,peak_distance:n,peak_barrier:true,is_parent:e.is_parent,use_vector_filter:true,z_push:e.z_push,on_hit:c.record_hit}})}})()}}}window.addEventListener("MMDStarted",()=>{if(MMD_SA_options.is_XR_Animator)B()});const X={};let U;let K;let $;class J{constructor(e,t){this.id=e;this.worker=t}initialized=false}async function ee(){if(G)return;G=true;B();var t=[];if(is_mobile){t.push("use_mobilenet=1")}if(Z){t.push("use_holistic=1");M=g=false;bt=vt=true}if(M){t.push("use_human=1");b=true;M=true;g=false;y=false;wt=true;v=true}else if(g){t.push("use_mixed_human=1");M=true;g=true;y=true;v=true}else{M=false;g=false;y=true}if(bt){t.push("use_blazepose=1");vt=true}if(vt){t.push("use_mediapipe=1");if(M){wt=true;v=false}yt=true}if(yt){t.push("use_movenet=1")}if(MMD_SA_options.user_camera.ML_models.worker_disabled&&Ze.initialized&&!Ze.worker_initialized){await new Promise(function(e,t){var i=setInterval(()=>{if(Ze.worker_initialized){clearInterval(i);e()}},100)})}else{await Ze.init()}if(MMD_SA_options.user_camera.ML_models.worker_disabled){U={postMessage:function(e,t){PoseAT.onmessage({data:e})}};let e=document.createElement("script");e.onload=function(){PoseAT.init(U,t)};e.src="js/pose_lib.js";document.head.appendChild(e)}else{$="js/pose_worker.js"+(t.length?"?"+t.join("&"):"");K=Je.use_holistic?"legacy_holistic":"tasks_vision";console.log("Web worker ID:"+K);U=new Worker($);X[K]=new J(K,U)}U.onmessage=Rt}var Et=function(){let P,e;let R;window.addEventListener("jThree_ready",()=>{P=new System._browser.data_filter([{type:"one_euro",id:"head_rot",para:[30,1,2,1,4]}]);e=new System._browser.data_filter([{type:"one_euro",id:"head_chest_rot",para:[30,.25,.5,1,3]}]);R=new System._browser.data_filter([{type:"one_euro",id:"rot_chest_offset",para:[30,.25,.5,1,4]}])});return function(e,t){const i=e.bones_by_name[t];const n=this.skin[t];let o=Math.max(Math.min(n[0].t_delta/n[0].t_delta_frame,1),0);const a=n[0].no_blending?MMD_SA._q2.copy(n[0].rot):MMD_SA._q2.copy(n[1].rot).slerp(n[0].rot,o);const s=pt.set(0,0,0,1);if(!i){n[0]._rot_from_pose.copy(a);return}const r=MMD_SA.MMD.motionManager.para_SA;const _=Je.enabled||r.motion_tracking_upper_body_only;const l=this.skin["上半身2"]?.[0].rot_append;var c=n[0].rot_parent;if(!c){const y=_&&r.motion_tracking?.head_rotation_weight||0;if(y==1){c=new THREE.Quaternion}else{c=MMD_SA.get_bone_rotation_parent(e,"首",e).conjugate();if(l)c.multiply(Ue.copy(l).conjugate());if(_)c.premultiply(Ue.copy(this._rot_body_offset).multiply(this._rot_body_camera));if(y)c.slerp(s,y)}if(l)c.multiply(l)}n[0]._rot_parent=c;if(n[0].info[1]=="facemesh"&&this.skin[t+"_DUMMY_"]){let e=Math.min(Math.max(.25-n[0]._rot_ratio,0)*5,1);n[0]._rot_mixed_ratio=e=e*e*2/3;a.slerp(this.skin[t+"_DUMMY_"][0]._rot_from_pose,e);n[0]._rot_mixed=a.clone()}let d,p;let m=(Ze.enabled||Je.pose_enabled)&&!Ye.VMC_receiver.mocap_head_constraint;let u=m||!Ye.VMC_receiver.head_pose_relative;let f;let h;if(u){d=Xe.multiplyQuaternions(c,a);h=m;p=d.clone()}else{const b=Ue.copy(c).multiply(Ye.VMC_receiver.rot_body);const n=this.skin["首"];if(n){const o=Math.max(Math.min(n[0].t_delta/n[0].t_delta_frame,1),0);f=n[0].no_blending?Ce.copy(n[0].rot):Ce.copy(n[1].rot).slerp(n[0].rot,o)}else{f=Ce.set(0,0,0,1)}p=(new THREE.Quaternion).copy(f).multiply(a);b.slerp(s,.5);d=Xe.copy(a).premultiply(b);e.bones_by_name["首"].quaternion.multiply(MMD_SA.TEMP_q.copy(f).conjugate());f.premultiply(b)}if(n[0]._upper_body_default_offset)p.premultiply(n[0]._upper_body_default_offset);if(l){p.premultiply(l)}p.fromArray(R.filter(p.toArray()));if(h){let e=n[0]._blending_ratio_factor||1;const v=P.filters[0].filter;v.minCutOff=1*e;v.beta=2*e*e;if(n[0]._blending_ratio_factor){n[0]._blending_ratio_factor+=RAF_timestamp_delta/1e3;if(n[0]._blending_ratio_factor>=1)n[0]._blending_ratio_factor=undefined}d.fromArray(P.filter(d.toArray()))}o=.5;if(u){let e=nt.setEulerFromQuaternion(d,"YZX");let i=[e.x<0?o+(.5-o)*.5:o,o,o];d.setFromEuler(Be.fromArray(e.toArray().map((e,t)=>Math.sign(e)*Math.min(Math.abs(e),Math.PI/2)*i[t])),"YZX")}if(_){const w=r.motion_tracking;const S=1-(w?.motion_default_weight?.head||0)*this.camera_weight;if(S){const A=Ue.copy(e.bones_by_name["首"].quaternion).premultiply(MMD_SA.TEMP_q.copy(this._body_motion_rot[0]["首"]).conjugate());e.bones_by_name["首"].quaternion.slerp(A,S);A.copy(e.bones_by_name["頭"].quaternion).premultiply(MMD_SA.TEMP_q.copy(this._body_motion_rot[0]["頭"]).conjugate());e.bones_by_name["頭"].quaternion.slerp(A,S)}}if(u){e.bones_by_name["首"].quaternion.multiply(d);e.bones_by_name["頭"].quaternion.premultiply(d)}else{e.bones_by_name["首"].quaternion.multiply(f);e.bones_by_name["頭"].quaternion.premultiply(d)}n[0]._rot_neck=e.bones_by_name["首"].quaternion.clone();n[0]._rot_head=e.bones_by_name["頭"].quaternion.clone();if(lt.active){lt.set_boneKey("首",null,e.bones_by_name["首"].quaternion,false);lt.set_boneKey("頭",null,e.bones_by_name["頭"].quaternion,false)}Je.hip_adjustment_set=MMD_SA.MMD.motionManager.filename;let M=Math.min(Je.hip_adjustment_weight_percent/100*Je.hip_adjustment_head_weight_percent/100*Je.hip_adjustment_head_chest_rotation_offset_percent/100,1);let g=Je.hip_adjustment_weight_percent/100;if(!r.motion_tracking_upper_body_only){const D=Je.pose_enabled?Je._upper_body_only_mode:Ye.VMC_receiver.pose_upper_body;const E=at("hip_adjustment",D?1:0,!!D);M*=E+Je.hip_adjustment_full_body_weighting_percent/100*(1-E)}if(M){const k=p.toAxisAngle();let e=k[1]%(Math.PI*2);if(e>Math.PI){e-=Math.PI*2}else if(e<-Math.PI){e+=Math.PI*2}e*=M;e=-Math.sign(e)*Math.min(Math.abs(e),Math.abs(M)*Math.PI/2);p.setFromAxisAngle(k[0],e);n[0]._rot_chest_offset=p;if(Je.pose_enabled||Ye.VMC_receiver.pose_enabled){const x=this.skin["上半身2"];if(x){for(let e=0;e<2;e++){x[e].rot_append=p}}}else{_t.add("skin","上半身2",{no_blending:true,rot:p.clone()})}}else{n[0]._rot_chest_offset=null}}}();var kt=1*10;var Ne=function(){var y=[];var a;var L;var C,H,B,O,q;window.addEventListener("jThree_ready",()=>{a=new System._browser.data_filter([{type:"one_euro",id:"camera_depth",para:[30,1,1/5,1,1]}]);L=new System._browser.data_filter([{type:"one_euro",id:"camera_distance",para:[30,1,1/5,1,1]}]);Ne.v_hip=C=new THREE.Vector3;Ne.v_hip_raw=H=new THREE.Vector3;O=new THREE.Vector3;q=new THREE.Vector3;B=new System._browser.data_filter([{type:"one_euro",id:"v_hip",para:[30,1,1/2,1,3]}])});var X;var i;function e(e){X=null;i=0;var r=e.keypoints[5];var _=e.keypoints[6];var l=e.keypoints[11];var c=e.keypoints[12];if(r.score<=0||_.score<=0)return;let d,p;if(e.keypoints3D_raw){d=e.keypoints3D_raw[11];p=e.keypoints3D_raw[12]}else{d=e.keypoints3D[5];p=e.keypoints3D[6]}y=[{point2D:[{position:new THREE.Vector2},{position:new THREE.Vector2}],data3D:{length:0,z_diff:0}}];const m=Je.spine_length_ref;var t=Ye.video_canvas.width;var u=Ye.video_canvas.height;var f=true;let h=1;if(l.score>0&&c.score>0){f=l.position.y>u||c.position.y>u;let e=MMD_SA._v3a.addVectors(d,p).multiplyScalar(.5);let t=e.length();let i=MMD_SA.TEMP_v3.set(0,1,0);i.y*=-1;let n=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(i,e.normalize()),"ZXY").x;h=Math.abs(n)/(Math.PI/2);h=h<=1?Math.max(h-.5,0)/.5:Math.max(2-h,0);let o=W.copy(l.position).add(c.position).multiplyScalar(.5);let a=N.copy(r.position).add(_.position).multiplyScalar(.5);let s=o.distanceTo(a);a.copy(o);a.y=a.y-s/Math.abs(Math.cos(n));y[0].point2D[0].position.copy(a);y[0].point2D[1].position.copy(o);y[0].data3D.length=m*(t*2)}if(h){let e=MMD_SA._v3b.copy(d).sub(p);let t=e.length();let i=MMD_SA.TEMP_v3.set(1,0,0);let n=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(i,e.normalize()),"ZYX").y;let o=N.copy(r.position).add(_.position).multiplyScalar(.5);let a=o.clone();let s=W.copy(r.position).distanceTo(_.position);const M=1.5;o.y=o.y+s*M/Math.abs(Math.cos(n));X=o.y;if(o.y>Ye.video_canvas.height){a.y=Math.max(a.y-(o.y-Ye.video_canvas.height),0);o.y=Ye.video_canvas.height}if(y[0].data3D.length!=0){let e=Math.abs(n)/(Math.PI/2);e=e<=1?Math.max(e-.5,0)/.5:Math.max(2-e,0);h*=1-e}y[0].point2D[0].position.lerp(a,h);y[0].point2D[1].position.lerp(o,h);y[0].data3D.length=y[0].data3D.length*(1-h)+m*(t*M*2)*h}i=y[0].point2D[1].position.y<Ye.video_canvas.height?(Ye.video_canvas.height-y[0].point2D[1].position.y)/y[0].point2D[0].position.distanceTo(y[0].point2D[1].position):0}function t(){if(!y.length)return;var p=System._browser.camera;var m=p.video_canvas.width;var u=p.video_canvas.height;var f=nt;var h=[];const e=m/u;const t=SL.width/SL.height;const M=e<t?e/t:1;const g=t<e?t/e:1;y.forEach(e=>{f.set((e.point2D[0].position.x/m*2-1)*M,(-(e.point2D[0].position.y/u)*2+1)*g,.5);var t=MMD_SA._v3a.copy(f.unproject(p._camera_reset).sub(p._camera_reset.position).normalize());f.set((e.point2D[1].position.x/m*2-1)*M,(-(e.point2D[1].position.y/u)*2+1)*g,.5);var i=MMD_SA._v3b.copy(f.unproject(p._camera_reset).sub(p._camera_reset.position).normalize());var n,o;n=e.data3D.length;o=e.data3D.z_diff;let a=Math.sqrt(Math.pow(t.x-i.x*t.z/i.z,2)+Math.pow(t.y-i.y*t.z/i.z,2)+0);let s=t.x-i.x*t.z/i.z+(t.y-i.y*t.z/i.z)+0;let r=s/a;let _=1;let l=(Math.sqrt(n*n+1)-1)/(a/r);t.multiplyScalar(l);let c=2*Math.tan(Math.PI/180*MMD_SA.THREEX.camera.obj.fov/2)/.9326153163099972;c=1+(c-1)*.5;let d=c*Je.hip_depth_scale_percent/100;h.push({z:-t.z*1.5*d,id:e.id})});h.sort((e,t)=>t.z-e.z);let i=h[0].z;const n=MMD_SA.THREEX.get_model(0);i-=Je.hip_z_position_offset_percent/100*n.para.left_leg_length*2;const o=n.para.spine_length/4.97462;i=Math.max(i,5*o+(n.get_bone_position_by_MMD_name("頭").z-n.get_bone_position_by_MMD_name("センター").z));this.z=i;z=a.filter(i);this.z_smoothed=z;y=[]}var U;function n(e){if(MMD_SA.WebXR.session){C.set(0,0,0);return}q.copy(H);O.copy(C);const F=MMD_SA.MMD.motionManager.para_SA;const t=Ye.video_canvas.width;const i=Ye.video_canvas.height;const n=e.keypoints[11];const o=e.keypoints[12];const a=e.keypoints[5];const s=e.keypoints[6];const r=a.score>0&&s.score>0?W.copy(a.position).add(s.position).multiplyScalar(.5):null;const _=t/i;const l=SL.width/SL.height;const c=_<l?_/l:1;const d=l<_?l/_:1;let p;let m=0;if(n.score>0&&o.score>0){p=N.copy(n.position).add(o.position).multiplyScalar(.5);const T=p.x;const I=p.y;m=1;if(r){if(I<0||I>i){m=1-Math.min((I<0?-I:I-i)/Math.abs(r.y-I),1)}if(T<0||T>t){m=Math.min(m,1-Math.min((T<0?-T:T-t)/Math.abs(r.x-T),1))}m=Math.max(m-.5,0)/.5}C.set(((n.position.x+o.position.x)/2/t*2-1)*c,(-((n.position.y+o.position.y)/2/i)*2+1)*d,.5).unproject(Ye._camera_reset).sub(Ye._camera_reset.position).normalize()}let u;if(m<1){u=Oe.set(((a.position.x+s.position.x)/2/t*2-1)*c,(-((a.position.y+s.position.y)/2/i)*2+1)*d,.5).unproject(Ye._camera_reset).sub(Ye._camera_reset.position).normalize()}if(kt)Ne.estimate();const f=Ye._camera_reset.position.z-THREE.MMD.getModels()[0].mesh.position.z;let h=f;if(kt&&Ne.z)h=Ne.z_smoothed||Ne.z;const M=MMD_SA.THREEX.get_model(0).para.spine_length;const g=.95;let y=m;if(y==0&&X){const I=X;if(I>i){y=1-Math.min((I<0?-I:I-i)/Math.abs(r.y-I),1);y=Math.max(y-.5,0)/.5}}let b=y+(1-y)*g;L.filter(b);h*=b;if(m>0)C.multiplyScalar(-h/C.z);if(u){const z=Je.spine_length_ref;const j=MMD_SA.TEMP_v3.set(0,-z,0);C.lerp(u.multiplyScalar(-h/u.z).add(j),1-m)}let v=MMD_SA.THREEX.get_model(0).para.left_leg_length/10.569580078125;const w=v>1?1:Math.pow(1/v,.75);let S=Je.hip_depth_scale_percent/100;let A;if(w*S>1){U=w*S;A=1/S}else{U=1;A=w}H.copy(C);C.multiply(MMD_SA.TEMP_v3.set(A,A,w));if(isNaN(C.x)||isNaN(C.y)||isNaN(C.z)){console.error("(Invalid v_hip)");C.copy(O);H.copy(q);return}let D=1;C.z=at("v_hip_z",C.z,!!Je._upper_body_only_mode);const E=B.filters[0].filter;const k=Math.min(Math.max(M/4.97462,1),Math.max(MMD_SA.THREEX.get_model(0).para.left_leg_length/10.569580078125,1));const x=k*10;const P=Math.max(Math.abs(C.z)-x,0)/x*D;let R=Je._upper_body_only_mode?.25:.25+P*.75;E.minCutOff=Math.min(R,10);E.beta=Math.min(R/k*.5,1);E.dCutOff=Math.min(R,1)}return{prepare:e,estimate:t,get_hip_center:n,get z_scale_base(){return U},get grounding_factor(){return Math.min(i/.75,1)},get grounding_factor2(){return Math.min(i/1,1)},get v_hip_filter(){return B}}}();var w=(()=>{function k(e,t,i,n,o){function a(e){return e*e}const s=Math.sqrt;var r=1+a(n);var _=-t*2+n*(o-i)*2;var l=a(t)+a(o-i)-a(e);var c=a(_)-4*r*l;if(c>=0){var d=[(-_+s(a(_)-4*r*l))/(2*r),(-_-s(a(_)-4*r*l))/(2*r)];if(c==0){return[d[0]]}return d}return[]}var x,P,R;var T;var I,z;window.addEventListener("jThree_ready",()=>{x=new THREE.Vector3;P=new THREE.Vector3;R=new THREE.Vector3;T=new THREE.Quaternion;I=new THREE.Plane;z=new THREE.Plane});return function(e,t,i){const n=e._elbow_y;const o=MMD_SA.get_bone_position(t,i+"ひじ",t);if(o.y>n)return;const a=MMD_SA.get_bone_position(t,i+"手首",t);const s=MMD_SA.get_bone_position(t,i+"腕",t);const r=s;const _=R.copy(a).sub(r);const l=o;const c=(l.x*_.x+l.y*_.y+l.z*_.z-(r.x*_.x+r.y*_.y+r.z*_.z))/_.lengthSq();const d=MMD_SA._v3b.set(r.x+_.x*c,r.y+_.y*c,r.z+_.z*c);const p=_.normalize();const m=P.copy(o).sub(d).normalize().negate();const u=x.crossVectors(p,m).normalize();I.setFromNormalAndCoplanarPoint(p,o);z.setFromNormalAndCoplanarPoint(MMD_SA.TEMP_v3.set(0,1,0),MMD_SA._v3a.set(0,n,0));const f=I.intersectPlane(z);if(!f)return;ot.set(p.x,p.y,p.z,0,m.x,m.y,m.z,0,u.x,u.y,u.z,0,0,0,0,1);Ke.setFromBasis(ot);const h=MMD_SA.TEMP_v3.copy(o).sub(d).length();let M=z.intersectLine(new THREE.Line3(o,d),R);if(!M)return;M=-M.sub(o).length();f[1].applyQuaternion(Ke);const g=f[1].y/f[1].z;o.sub(s);o.applyQuaternion(Ke);const y=k(h,o.z,o.y,g,M);if(!y.length)return;const b=y.map(e=>{e-=o.z;return Math.asin(e/h)});const v=i=="左"?1:-1;const w=MMD_SA.get_bone_rotation(t,"上半身2",null,t);const S=T.copy(w).conjugate();const A=P.copy(a).sub(s).normalize().applyQuaternion(S);const D=e.use_smallest_angle?b.sort((e,t)=>Math.abs(e)-Math.abs(t))[0]:b[v==-1?b.length-1:0];const E=MMD_SA.TEMP_q.setFromAxisAngle(A,D);t.bones_by_name[i+"腕"].quaternion.premultiply(E)}})();function xt(){if(Je.enabled||Ye.VMC_receiver.pose_enabled)return;if(!_t.skin["センター"])_t.add("skin","センター",{rot:new THREE.Quaternion});if(Ze.enabled){const t=MMD_SA.TEMP_v3.set(0,1,0);Pt(t,true);const i=t.z?Math.atan2(t.z,t.y):0;_t.add("skin","上半身",{rot:new THREE.Quaternion(Math.sin(-i/2),0,0,Math.cos(-i/2))})}const e=MMD_SA.MMD.motionManager.para_SA;if(e.motion_tracking_upper_body_only){for(const n of["左","右"]){const o=true;if(e.has_leg_IK){_t.set_blend_default_motion("skin",n+"足ＩＫ",true);_t.remove("skin",n+"足首")}else{_t.set_blend_default_motion("skin",n+"足",true);_t.set_blend_default_motion("skin",n+"ひざ",true);_t.set_blend_default_motion("skin",n+"足首",true)}Je.enable_IK(n+"足ＩＫ",e.has_leg_IK);Je.enable_IK(n+"つま先ＩＫ",e.has_leg_IK);_t.set_blend_default_motion("skin",n+"肩",o);_t.set_blend_default_motion("skin",n+"腕",o);_t.set_blend_default_motion("skin",n+"ひじ",o);_t.set_blend_default_motion("skin",n+"手捩",o);_t.set_blend_default_motion("skin",n+"手首",o);_t.set_blend_default_motion("skin",n+"腕ＩＫ",o);Je.enable_IK(n+"腕ＩＫ",true)}}else{for(const n of["左","右"]){Je.enable_IK(n+"腕ＩＫ",e.has_arm_IK)}_t.remove("skin","センター")}}var Pt=(()=>{let l;let t;window.addEventListener("jThree_ready",()=>{t=new THREE.Vector3;l=new System._browser.data_filter([{type:"one_euro",id:"z_lean",para:[30,.5,.5,1,1]}])});return function(a,e){const s=MMD_SA.MMD.motionManager.para_SA;let r=at("lean",e?1:0,e);if(!r)return;if(Ze.enabled&&Ze.lean_tracking&&Ze.face_width_average&&Ze.face_width_average>.075){let n=0;n+=(2-(Ze.lean_tracking-1))/2;let o=Ze.face_width/Math.max(Ye.video_canvas.width,Ye.video_canvas.height);const _=Ze.face_width_average*(1.1+.1*n);if(o>_){let t=!Je.enabled||s.motion_tracking_upper_body_only?1:.5;let i=Math.sqrt(a.x*a.x+a.y*a.y);if(a.z*t<i){let e=l.filter(Math.pow(Math.min((o-_)/(Ze.face_width_average*(.5*(1+.5*n))),1),1.5))*r;e*=t- -a.z/i;a.z-=e*i}}}if(s.motion_tracking?.lean_reduction_power){if(s.motion_tracking.lean_reduction_power>10){a.z=0}else{a.normalize();t.set(0,a.y,a.z).normalize();a.z*=Math.pow(Math.abs(t.z)/2,s.motion_tracking.lean_reduction_power)*2/Math.abs(t.z)}}}})();const at=(()=>{let a={};return function(e,i,t){if(!e){a={};return}let n=a[e];if(!n){n=a[e]={};switch(e){case"lean":n.type=1;n.duration=500;break;case"hip_angle_x":n.type=1;n.duration=1e3;break;case"v_hip_z":case"hip_adjustment":n.type=1;n.duration=500;break;case"hip":n.type=3;n.duration=1e3;n.v=new THREE.Vector3;n.v_to_lerp=new THREE.Vector3;break}}const o=n.type;if(n.state==null){n.timestamp=n.duration;if(o==1){n.v=n.v_to_lerp=i}else if(o>=3){n.v.copy(i);n.v_to_lerp.copy(i)}}else if(n.state===t){let e=RAF_timestamp-(n._timestamp||RAF_timestamp);n.timestamp=Math.min(n.timestamp+e,n.duration);let t=1-n.timestamp/n.duration;if(n.type==1){if(t)i=i*(1-t)+n.v_to_lerp*t;n.v=i}else if(n.type==3){if(t)i.lerp(n.v_to_lerp,t);n.v.copy(i)}else if(n.type==4){if(t)i.slerp(n.v_to_lerp,t);n.v.copy(i)}}else{n.timestamp=0;if(o==1){i=n.v;n.v_to_lerp=i}else if(o>=3){i.copy(n.v);n.v_to_lerp.copy(i)}}n._timestamp=RAF_timestamp;n.state=t;return i}})();const st=[0,0,0];var Rt=function(){function we(e,t){let i=We[t];e.premultiply(i.axis_rot).multiply(i.axis_rot_inv);e.multiplyQuaternions(i.axis_rot_offset_inv,e)}function Se(e,t){const i=t.charAt(0);const n=e.bones_by_name;const o=n[t].quaternion;s.call(this,e,t);if(MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only){const a=MMD_SA.MMD.motionManager.para_SA.motion_tracking?.arm_rotation_offset_from_motion_weight?.[i=="左"?"left":"right"];o.premultiply(a!=null?MMD_SA.TEMP_q.set(0,0,0,1).slerp(ft,a):ft)}}function Ae(e,t){const i=this.skin[t];if(!i._IK_disabled)e.bones_by_name[t].quaternion.set(0,0,0,1)}function s(e,t){const i=t.charAt(0);const n=e.bones_by_name;const o=n[t].quaternion;const a=this.skin[i+"肩"];if(a){let e=Math.max(Math.min(a[0].t_delta/a[0].t_delta_frame,1),0);o.premultiply(MMD_SA.TEMP_q.copy(a[1].rot).slerp(a[0].rot,e).conjugate())}}var ee=(()=>{var h;var M;window.addEventListener("jThree_ready",()=>{h=new THREE.Vector3;M=new System._browser.data_filter([{type:"one_euro",id:"grounding_y",para:[30,1,1,1,1]}])});return function(o,e){var t=o.bones_by_name[e];var i=this.skin[e];var n=Math.max(Math.min(i[0].t_delta/i[0].t_delta_frame,1),0);const a=MMD_SA.THREEX.get_model(0);const s=MMD_SA.MMD.motionManager.para_SA;const r=nt.copy(Ne.v_hip);if(MMD_SA.WebXR.session){r.set(0,0,0)}else{const f=Ye._camera_reset.position.z-o.position.z;r.z=MMD_SA_options.user_camera.ML_models.pose.estimate_z_depth===false?0:f+r.z}if(MMD_SA_options.user_camera.ML_models.pose.position_offset)r.add(MMD_SA_options.user_camera.ML_models.pose.position_offset);i[0].pos.copy(r);h.copy(i[1].pos).lerp(i[0].pos,n);h.fromArray(Ne.v_hip_filter.filter(h.toArray()));let _=Be.set(0,0,0);let l=a.para.left_leg_length/MMD_SA_options.model_para_obj.left_leg_length;let c,d;if(!MMD_SA.THREEX.enabled||s.motion_tracking_upper_body_only){c=MMD_SA.get_bone_position(o,"左足","全ての親");d=MMD_SA.get_bone_position(o,"右足","全ての親");_.copy(c).add(d).multiplyScalar(.5).sub(MMD_SA_options.model_para_obj.hip_center).negate();_.multiplyScalar(Math.max(l,1))}else{c=a.get_bone_position_by_MMD_name("左足",true);d=a.get_bone_position_by_MMD_name("右足",true);let e=a.get_bone_position_by_MMD_name("センター",true).sub(a.para.hip_center_offset);e.sub(MMD_SA.TEMP_v3.copy(_t.skin["センター"]?.[0]._hip_adjustment_offset||MMD_SA.TEMP_v3.set(0,0,0)).multiplyScalar(l));_.copy(c).add(d).multiplyScalar(.5).sub(e).negate()}_.add(MMD_SA.TEMP_v3.copy(_t.skin["センター"]?.[0]._hip_adjustment_offset||MMD_SA.TEMP_v3.set(0,0,0)).multiplyScalar(l));if(s.motion_tracking_upper_body_only)h.y/=Ne.z_scale_base;let p=a.para.hip_center.y+a.para.spine_length/2-(11.364640235900879+4.97462/2);p*=.75;if(p<0)p*=.85;if(!s.motion_tracking_upper_body_only){h.y-=p*.5}h.y+=Je.hip_y_position_offset_percent/100*a.para.left_leg_length;if(Je.auto_grounding&&!s.motion_tracking_upper_body_only){let e,t;e=a.get_bone_position_by_MMD_name("左足首",true);t=a.get_bone_position_by_MMD_name("右足首",true);let i=e.y<t.y?e:t;i.sub(MMD_SA.TEMP_v3.setFromMatrixPosition(o.bones_by_name["全ての親"].skinMatrix));let n=a.para.left_heel_height+.2-i.y;n-=h.y;_.y=M.filter(n*Ne.grounding_factor)}h.x*=Ye.x_flipped?-1:1;h.add(_);if(s.motion_tracking_upper_body_only){if(Je.hip_camera){let e=MMD_SA.MMD.motionManager.filename=="stand_simple"?a.get_bone_origin_by_MMD_name("首")[1]/16.33926010131836:MMD_SA.camera_auto_adjust_scale;h.negate();h.y+=8*e-(Ye._camera_reset.position.y-o.position.y);h.z+=5*e+(_t._z_max||0)*1/3;MMD_SA.Camera_MOD.adjust_camera("hip_camera",h,h)}return}MMD_SA.TEMP_v3.set(0,0,0);MMD_SA.Camera_MOD.adjust_camera("hip_camera",MMD_SA.TEMP_v3,MMD_SA.TEMP_v3);if(i[0].absolute)t.position.set(0,0,0);t.position.add(h);lt.active&&lt.set_boneKey(e,h,null,true);const m=a.para.left_leg_length/10.569580078125;var u=Y.distanceTo(h)-5*m;if(u>0){THREE.MMD.getModels()[o._model_index].resetPhysics(15+u*2/m)}Y.copy(h)}})();var De=function(){let D={};let E={};window.addEventListener("jThree_ready",()=>{for(const t of["左","右"]){D[t]=new System._browser.data_filter([{type:"one_euro",para:[30,.3,.3,.3,3]}]);E[t]=[];for(let e=0;e<5;e++){E[t][e]=new System._browser.data_filter([{type:"one_euro",para:[30,1,1,1,1]}])}}});return function(o,e){var t=THREE.MMD.getModels()[o._model_index];var i=o.bones_by_name[e];var a=e.charAt(0);var n=i.quaternion;const s=this.skin[e];const r=Math.max(Math.min(s[0].t_delta/s[0].t_delta_frame,1),0);n.copy(s[1].rot).slerp(s[0].rot,r);const _="YXZ";const l=MMD_SA.TEMP_v3.setEulerFromQuaternion(n,_);const c=MMD_SA.MMD.motionManager.para_SA.motion_tracking.arm_as_leg.transformation?.rotation||{};let d=Math.sign(l.y)*Math.min(Math.abs(l.y*(c.y?.scale||1)),Math.PI/2.5)+(c.y?.add||0)*Math.PI/180;const p=c.y?.foot_ratio||.25;l.y=d*p;l.z=Math.sign(l.z)*Math.min(Math.abs(l.z*(c.z?.scale||.5)),Math.PI/4);l.x*=c.x?.scale||.4;let m=[];let u=0;let f;if(s[0]._finger_x){if(s[1]._finger_x){f=s[0]._finger_x.map((e,t)=>e*r+s[1]._finger_x[t]*(1-r))}else{f=s[0]._finger_x}}if(f){for(let e=0;e<5;e++)m[e]=E[a][e].filter(f[e]);m[0]=(m[0]+m[1])/2;m.forEach(e=>{u+=e});u/=5;l.x-=u}l.x=Math.sign(l.x)*Math.min(Math.abs(l.x),Math.PI/2.5);l.fromArray(D[a].filter(l.toArray()));d=l.y/p;n.setFromEuler(l,_);this._rot_=n.clone();this._rot_y=d;const h=this.get_blend_default_motion("skin",a+"足ＩＫ",true);if(h)d*=1-h;const M=MMD_SA.get_bone_position(o,a+"足",o);const g=MMD_SA.get_bone_rotation_parent(o,a+"足",o).conjugate();const y=MMD_SA.get_bone_position(o,e,o).sub(M).negate().normalize().applyQuaternion(g);const b=MMD_SA.TEMP_q.setFromAxisAngle(y,d*(1-p));if(0&&o.bones_by_name[a+"足D"]){o.bones_by_name[a+"足"].quaternion.premultiply(b);o.bones_by_name[a+"足D"].quaternion.premultiply(b)}else{t._update_IK_and_AddTrans(false,a+"足","下半身",true);if(this.skin[a+"足"]&&this.skin[a+"足"][0]._rot_){o.bones_by_name[a+"足"].quaternion.copy(this.skin[a+"足"][0]._rot_)}else{const v=MMD_SA.get_bone_position(o,a+"ひざ",o).sub(M).negate().normalize().applyQuaternion(g);const w=Xe.setFromUnitVectors(nt.set(0,1,0),y);o.bones_by_name[a+"足"].quaternion.copy(w).multiply(Ue.setFromEuler(nt.set(-v.angleTo(y),0,0)))}o.bones_by_name[a+"足"].quaternion.premultiply(b);t._update_IK_and_AddTrans(false,a+"足","下半身")}if(u&&o.bones_by_name[a+"足先EX"]){const e=a+"足人指";const S=!MMD_SA.MMD.motionManager.para_SA.motion_tracking.arm_as_leg.toes_disabled&&(o.bones_by_name[e]||o.bones_by_name[e+Ge[1]]);if(!S){let t=0;for(let e=1;e<4;e++){t+=m[e]}t/=4;const A=(m[1]-t)/2;o.bones_by_name[a+"足先EX"].quaternion.setFromEuler(nt.set(-u*.5,0,A),"XZY")}else{o.bones_by_name[a+"足先EX"].quaternion.setFromEuler(nt.set(-u*.5,0,0))}t._update_IK_and_AddTrans(false,a+"足先EX")}if(f){Ve.forEach((e,t)=>{const i=a+"足"+e+"指";const n=o.bones_by_name[i]||o.bones_by_name[i+Ge[1]];if(n)n.quaternion.multiply(Xe.setFromEuler(nt.set(-m[t]*.5,0,0)))})}}}();function te(p,m){function e(){if(MMD_SA.THREEX.shoulder_adjust=="None")return;const e=THREE.MMD.getModels()[p._model_index];const t=MMD_SA.THREEX.get_model(p._model_index).is_T_pose;const i=m.charAt(0);const n=MMD_SA.motion[e.skin._motion_index].para_SA;let o=_t.skin[i+"腕"]&&(n.motion_tracking_upper_body_only?(1-(n.motion_tracking?.motion_default_weight?.shoulder||0))*(1-_t.get_blend_default_motion("skin",i+"腕")):1);if(!o)return;const a=p.bones_by_name[i+"腕"].quaternion;const s=!t?MMD_SA.TEMP_q.fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(i+"腕",a.toArray())):MMD_SA.TEMP_q.copy(a);let r=MMD_SA.TEMP_v3.setEulerFromQuaternion(s,"YZX").z;const _=i=="左"?1:-1;r=r*_+Math.PI/2;if(r>Math.PI/4){const l=r<Math.PI/2?(r-Math.PI/4)/(Math.PI/4):Math.min(1+(r-Math.PI/2)/(Math.PI/2)*4,1+4);const c=(Math.min(l,1)*(!MMD_SA.THREEX.shoulder_adjust?12.5*.5:MMD_SA.THREEX.shoulder_adjust=="Full"?12.5:0)+Math.max(l-1,0)*12.5)*Math.PI/180*o*-_;const d=MMD_SA.TEMP_q.set(0,0,Math.sin(c/2),Math.cos(c/2));a.premultiply(d);p.bones_by_name[i+"肩"].quaternion.multiply(d.conjugate());if(lt.active){lt.set_boneKey(i+"肩",null,p.bones_by_name[i+"肩"].quaternion,false);lt.set_boneKey(i+"腕",null,a,false)}}}window.addEventListener("SA_MMD_model"+p._model_index+"_process_bones_after_IK",e,{once:true})}var ie=0,ne=0,oe=0,ae=0;var se=0,re=0,Ee=0,ke=0;let t,xe;let Pe;let Re;let Te={};let Ie={};let ze={};let je={};let Fe;let Le={};let Ce={};let He={};window.addEventListener("jThree_ready",()=>{t=new System._browser.data_filter([{type:"one_euro",id:"torso_rot",para:[30,.5,1,1,3]}]);xe=new System._browser.data_filter([{type:"one_euro",id:"chest_rot",para:[30,.5,1,1,3]}]);Pe=new System._browser.data_filter([{type:"one_euro",id:"shoulder_rot_z_filter",para:[30,1,1,1,1]}]);Fe=new System._browser.data_filter([{type:"one_euro",id:"hand_depth_weight",para:[30,.5,.1,1,1]}]);Re=new System._browser.data_filter([{type:"one_euro",id:"spine",para:[30,.1,.1,1,3]}]);for(const e of["左","右"]){Te[e]=new System._browser.data_filter([{type:"one_euro",id:"arm_IK"+e,para:[30,.5,1/2,1,3]}]);Ie[e]=new System._browser.data_filter([{type:"one_euro",id:"_arm_IK"+e,para:[30,.5,1/2,1,3]}]);ze[e]=new System._browser.data_filter([{type:"one_euro",id:"arm_rot"+e,para:[30,.5,1/2,1,4]}]);je[e]=new System._browser.data_filter([{type:"one_euro",id:"hand_depth"+e,para:[30,.5,.1,1,1]}]);Le[e]=new System._browser.data_filter([{type:"one_euro",id:"rot_pose_ratio"+e,para:[30,.5,.1,1,1]}]);Ce[e]=new System._browser.data_filter([{type:"one_euro",id:"knee_pos"+e,para:[30,1,1,1,3]}]);He[e]=new System._browser.data_filter([{type:"one_euro",id:"ankle_pos"+e,para:[30,1,1,1,3]}])}});return function(e){var fe=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof fe==="string"){if(fe=="OK"){Je.worker_initialized=true}else{DEBUG_show(fe,2);System._browser.console.log(fe)}}else if(Je.enabled){window.dispatchEvent(new CustomEvent("SA_camera_poseNet_update"));Ye._needs_RAF=true;Je._bb=null;const he=MMD_SA.THREEX.get_model(0).model_para;const o=Lt[Je.use_holistic?1:0];let e;if(Je.enabled&&!o.poseNet){e=true;o.poseNet=true}if(tt.enabled&&!o.handpose){e=true;o.handpose=true}if(e)DEBUG_show("Pose ML ready",2);it=(Ze.enabled?"\n":"")+Ye.video_canvas.width+"x"+Ye.video_canvas.height+"("+Je.camera_video_frame_id+")\n";let t=Ye.video_timestamp_absolute;let i=0;if(ae){i=Math.max(Math.min(t-ae,1e3),10);oe+=i;if(++ne>=20){ie=1e3/(oe/ne);ne=oe=0}}ae=t;Je._t=fe._t;_t.t_delta=((_t.t_delta||i)+i)/2;if(fe.handpose){i=0;if(ke){i=Math.max(Math.min(t-ke,1e3),10);Ee+=i;if(++re>=20){se=1e3/(Ee/re);re=Ee=0}}ke=t;Je._t_hands=fe._t_hands;_t.t_delta_hands=((_t.t_delta_hands||i)+i)/2}if(Je.use_holistic){o.facemesh=true;if(!fe.facemesh){Ze.data_detected=0}}let _e=[];let le=[];let ce=Ye.x_flipped?1:-1;let de;const a=THREE.MMD.getModels()[0];const L=a.mesh.bones_by_name;const ve=MMD_SA.THREEX.get_model(0).is_T_pose;const C=MMD_SA.THREEX.get_model(0);const Me=MMD_SA.MMD.motionManager.para_SA;const M=Me.motion_tracking&&Me.motion_tracking.arm_as_leg;const ge={"左":M&&M.enabled&&(!M.linked_side||M.linked_side=="left"),"右":M&&M.enabled&&(!M.linked_side||M.linked_side=="right")};let S;let pe,n;let me;let ue;if(Je.enabled){Je._RAF_timestamp=RAF_timestamp;const _=fe.posenet&&fe.posenet.score>.3;if(Je.pose_enabled&&_){Je.data_detected++;Je.initial_data_detected=true;if(Je.data_detected_stable){if(Qe){_t.reset();Qe=false;a.mesh.visible=true}}}if(!Je.pose_enabled||Je.data_detected_stable){S=Me.motion_tracking?.camera?.tilt_adjustment||Ye.tilt_adjustment;if(S.enabled){n=S.angle*S.pose_weight*Math.PI/180;pe=(new THREE.Quaternion).set(Math.sin(n/2),0,0,Math.cos(n/2))}if(_){me=fe.posenet;ue=Je.use_3D_pose;if(bt){me._keypoints=me.keypoints;me._keypoints3D=me.keypoints3D;let n=[];let o=[];At.forEach((e,t)=>{let i=me.keypoints[e];i.part=St[t];n.push(i);i=me.keypoints3D[e];i.part=St[t];o.push(i)});me.keypoints=n;me.keypoints3D=o}const X=yt?.3:!wt?.5:.1;me.keypoints.forEach(e=>{e.score-=X});if(ue){me._keypoints3D.forEach(e=>{e.score-=X})}if(wt){let i={};me.keypoints.forEach(e=>{i[e.part]=e});let n=[];for(let t=0;t<=16;t++){let e=me.keypoints[t];if(!e)n.push(Dt[t]);else if(e.part!=St[t])n.push(i[St[t]]||Dt[t]);else n.push(e)}me.keypoints=n}let e=me._keypoints||me.keypoints;let t=e.map(e=>e.position.x);let i=e.map(e=>e.position.y);const l=[Math.min(...i),Math.max(...t),Math.max(...i),Math.min(...t)];e=me.keypoints.slice(0,5);t=e.map(e=>e.position.x);i=e.map(e=>e.position.y);const c=[Math.min(...i),Math.max(...t),Math.max(...i),Math.min(...t)];const p=Math.max(c[1]-c[3],c[2]-c[0])/2;l[0]=Math.min(l[0],c[0]-p);l[1]=Math.max(l[1],c[1]+p);l[2]=Math.max(l[2],c[2]-p);l[3]=Math.min(l[3],c[3]-p);Je._bb=l;if(!Ze.head_pose_enabled){Ze.bb_center[0]=me.keypoints[0].position.x/Ye.video_canvas.width;Ze.bb_center[1]=me.keypoints[0].position.y/Ye.video_canvas.height}if(ue&&Je.use_head_mocap){let e=me._keypoints[0].position;let t=me._keypoints[3].position;let i=me._keypoints[6].position;const m=nt.copy(i);const u=Be.copy(t);u.sub(m);const f=MMD_SA._v3a_.copy(e);const h=(f.x*u.x+f.y*u.y+f.z*u.z-(m.x*u.x+m.y*u.y+m.z*u.z))/u.lengthSq();const U=MMD_SA._v3b.set(m.x+u.x*h,m.y+u.y*h,m.z+u.z*h);let n=f.sub(U).normalize();let o=MMD_SA._v3b_.copy(t).sub(MMD_SA._v3b.copy(i));o.normalize();let a=MMD_SA.TEMP_v3.crossVectors(o,n).normalize();o.crossVectors(n,a);ot.set(o.x,o.y,o.z,0,n.x,n.y,n.z,0,a.x,a.y,a.z,0,0,0,0,1);Ke.setFromBasis(ot);let s=Ke.conjugate();s=s.clone().multiply(MMD_SA.TEMP_q.set(Math.sin(Math.PI/3.5/2),0,0,Math.cos(Math.PI/3.5/2)));Ze._neck.shoulder_center=Be.copy(me._keypoints[11].position).add(MMD_SA.TEMP_v3.copy(me._keypoints[12].position)).multiplyScalar(.5).toArray();if(pe)s.premultiply(pe);if(Ze.enabled||Je.pose_enabled&&(!Ye.VMC_receiver.active||Ye.VMC_receiver.face_independent<2)){if(!Ze.head_pose_enabled){let e,t;const y=_t.skin["首"]?.[0];if(y?._rot_mixed){t=.5+.5*(y._rot_mixed_ratio||0);y.rot.copy(y._rot_mixed);const b=.5;e=1-(1-b)*((y._blending_ratio_factor||1)-b)/(1-b)*(1-(y._rot_mixed_ratio||0))}_t.add("skin","首",{after_IK:true,_blending_start:t,_blending_ratio_factor:e||y?._blending_ratio_factor,rot:s,_rot_chest_offset:y?._rot_chest_offset,_rot_mixed_ratio:y?._rot_mixed_ratio,onProcessRotation:Et})}_t.add("skin","首_DUMMY_",{rot:s,_rot_from_pose:s.clone(),onProcessRotation:Et})}else{_t.remove("skin","首_DUMMY_")}}}}if(!Je.pose_enabled){}else if(_){if(Je.data_detected_stable){let i=me.keypoints[5];let n=me.keypoints[6];let S=new THREE.Quaternion;de=Me.motion_tracking_upper_body_only;it+="\n"+(de?(Me.motion_tracking?.arm_as_leg?.enabled?"🦶":"🙋")+"upper body":"💃full body"+(Je.auto_grounding?"👣":""));const v=MMD_SA_options.Dungeon_options?.item_base.hand_camera;if(v&&v._hand_camera_side){it+="/"+(v.selfie_mode?"🤳selfie":"📷handcam")+(v._hand_camera_side=="左"?"-L":"-R")}else if(de&&Je.hip_camera){it+="/"+"📷hip cam"}it+="\n";if(ue&&kt)Ne.prepare(me);let M=0,A=0;if(tt.enabled&&fe.handpose)tt.hand_visible_timestamp={};st[0]=st[1]=0;let re;if(i.score>0&&n.score>0&&[i,n].some(e=>e.position.x>=0&&e.position.x<=Ye.video_canvas.width&&e.position.y>=0&&e.position.y<=Ye.video_canvas.height)){let m,u;let f,h;if(ue){m=me.keypoints3D[5];u=me.keypoints3D[6];let e=me.keypoints3D[11];let i=me.keypoints3D[12];Je._hip_visible=e.score>0&&i.score>0&&me.keypoints[11].position.y<Ye.video_canvas.height&&me.keypoints[12].position.y<Ye.video_canvas.height;let n;if(de){de=true}else{if(!Je._hip_visible){de=true}let t=de?MMD_SA._v3b.set(1,0,0):MMD_SA._v3b.copy(e).sub(i).normalize();at("hip",t,!!de);if(t.x!=1){let e=MMD_SA.TEMP_v3.set(1,0,0);n=Oe.setFromVectorSpherical(e,t);M=n.z;if(1||de)n.z=0;S.setFromEuler(n,"YZX")}}let t=MMD_SA.TEMP_v3.set(0,1,0);t.y*=-1;let o=MMD_SA._v3a.addVectors(m,u).multiplyScalar(.5);Re.filters[0].filter.minCutOff=de?.5:Math.pow(Math.max(-Ne.v_hip.z/C.para.spine_length+o.z,1)/3,4);o.fromArray(Re.filter(o.toArray()));if(o.z){if(Je.body_bend_reduction_power==1){o.z=0}else{o.normalize();let e=MMD_SA._v3b.set(0,o.y,o.z).normalize();o.z*=Math.pow(Math.abs(e.z),Math.pow(1.6,(Je.body_bend_reduction_power||0)/.25))/Math.abs(e.z)}}Pt(o,!!de);o.normalize();Ze.calculate_neck_data({is_pose:true,timestamp:Je.camera_video_frame_id,shoulder_center:Ze._neck.shoulder_center,spine_rot_absolute:Be.setFromVectorSpherical(t,o).toArray()});o.applyQuaternion(MMD_SA.TEMP_q.copy(S).conjugate());const w=Be.setFromVectorSpherical(t,o);if(Me.motion_tracking_upper_body_only){f=(new THREE.Quaternion).setFromEuler(w,"XZY")}else{if(de){f=(new THREE.Quaternion).setFromEuler(w,"YXZ")}else{f=(new THREE.Quaternion).setFromEuler(w,"XZY")}}A=w.x;let a=MMD_SA._v3b.copy(m).sub(u).normalize();a.applyQuaternion(MMD_SA.TEMP_q.multiplyQuaternions(S,f).conjugate());x_axis=MMD_SA.TEMP_v3.set(1,0,0);let s=Be.setFromVectorSpherical(x_axis,a);let r=Je.shoulder_tracking?.5:0;let _=Pe.filter(s.z*(MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?3:5))*r;let l=Math.min(Math.PI/12/Math.abs(_),1);_*=l;if(de){s.fromArray(xe.filter(s.toArray()))}st[0]=_;st[1]=_;s.z*=1-r;h=(new THREE.Quaternion).setFromEuler(s,"YZX");let c=0;let d=s.y;let p=(c+d)%(Math.PI*2);if(p>Math.PI)p=Math.PI*2-p;else if(p<0&&p<-Math.PI)p+=Math.PI*2;f.multiply(Xe.set(0,Math.sin((p/2-c)/2),0,Math.cos((p/2-c)/2)));h.multiply(Xe.set(0,Math.sin((p/2-d)/2),0,Math.cos((p/2-d)/2)));_t.add("skin","センター",{rot:S.clone(),priority:9});if(lt.active){if(!_t.skin["センター"][0].pos&&_t.skin["センター"][1].pos)_t.skin["センター"][0].pos=_t.skin["センター"][1].pos}const Q=f.clone();if(pe){const W=Xe.copy(pe);const N=Me.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(N.upper_rotation_offset){const Y=-(N.upper_rotation_offset-p)*2/3*Math.PI/180;const Z=pe.toAxisAngle();W.setFromAxisAngle(Z[0].applyQuaternion(MMD_SA.TEMP_q.set(0,Math.sin(Y/2),0,Math.cos(Y/2))),Z[1])}Xe.premultiply(MMD_SA.TEMP_q.copy(S).conjugate()).multiply(S);Q.premultiply(W)}_t.add("skin","上半身",{rot:Q});const E=_t.skin["首"]?.[0]._rot_chest_offset||_t.skin["頭"]?.[0]._rot_chest_offset;_t.add("skin","上半身2",{rot_append:E,rot:h.clone()});if(E){h.multiply(E)}re=Xe.copy(S).multiply(f).multiply(h);re.conjugate()}const K=MMD_SA.TEMP_v3.set(1,1,1/3);Je.shoulder_width=nt.copy(i.position).multiply(K).distanceTo(Be.copy(n.position).multiply(K));let se=Math.sqrt(Math.pow(i.position.x-n.position.x,2)+Math.pow(i.position.y-n.position.y,2));let e=0;if(!ue){e=Math.asin((i.position.y-n.position.y)/se);e=Math.max(Math.min(e/(Math.PI/4),1),-1)*Math.PI/4*ce}let t=ce==1?[1,0]:[0,1];se=Ze.face_width*2||se;Je._upper_body_only_mode=de;const ye=[0,0];const be=[];t.forEach(function(i,n){let o,a,s;let r;let c=n==0?"左":"右";let _=me.keypoints[5+i];let d=me.keypoints[7+i];let l=me.keypoints[9+i];let p=(Me.motion_tracking?.arm_tracking?.use_IK!=null?!Me.motion_tracking.arm_tracking.use_IK:MMD_SA_options.user_camera.ML_models.pose.use_armIK==null?!de&&!Je.body_collider.active&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=c:!MMD_SA_options.user_camera.ML_models.pose.use_armIK)&&!ge[c];let m=false;be[n]=new THREE.Quaternion;if(ve)be[n].fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(c+"肩",be[n].toArray()));let u,f,h;if(ue){u=me.keypoints3D[5+i];f=me.keypoints3D[7+i];h=me.keypoints3D[9+i];let e=(he.camera?.poseNet?.arm_vertical_offset_percent||0)/100+(Je.arm_vertical_offset_percent||0)/100;if(e){const x=MMD_SA.TEMP_v3.copy(f).distanceTo(u)+MMD_SA.TEMP_v3.distanceTo(h);const X=MMD_SA.TEMP_v3.copy(h).sub(u);const U=-(1-Math.abs(X.y)/x)*(x*e);h={x:h.x,y:h.y+U,z:h.z};f={x:f.x,y:f.y+U/2,z:f.z}}let t=(he.camera?.poseNet?.arm_horizontal_offset_percent||0)/100+(Je.arm_horizontal_offset_percent||0)/100;if(t){const P=t>0?1/(1+t):1-t;const K=Be.copy(me.keypoints3D[5]).add(me.keypoints3D[6]).multiplyScalar(.5);const R=Oe.copy(u).sub(K);const T=qe.copy(R).multiplyScalar(P).add(K);R.copy(T).sub(u).multiplyScalar(.5);u={x:T.x,y:T.y,z:T.z};T.copy(f).add(R);f={x:T.x,y:T.y,z:T.z}}}let M=l.score>0&&l.position.x>=0&&l.position.x<=Ye.video_canvas.width&&l.position.y>=0&&l.position.y<=Ye.video_canvas.height;if(M&&ge[c]&&Je._hip_visible&&ue){let e=MMD_SA.TEMP_v3.copy(u).distanceTo(f);e+=MMD_SA.TEMP_v3.copy(f).distanceTo(h);let t=MMD_SA.TEMP_v3.copy(h).sub(u).y;if(e-t<e*.4){M=false;l.score=0}}if(Me.motion_tracking_upper_body_only&&!M){p=false}let L=ce*(i==0?-1:1);if(ue&&l.score>0&&tt.enabled&&tt.stabilize_hand_percent&&Je.shoulder_width){const I=Ye.video_canvas.width;const V=Ye.video_canvas.height;const z=tt._hand_last[c];let n;if(fe.handpose&&fe.handpose.length){const Q=fe.handpose.find(e=>e.label==(c=="左"?"Left":"Right"));if(Q){n=z.hand=Q.annotations.palm[0];z.timestamp=RAF_timestamp;z.w=I;z.h=V}}if(!n){n=z.hand}const G=1e3*(tt.stabilize_hand_percent/100)*(de||!p?1:.5);let o=RAF_timestamp-z.timestamp;if(n&&z.w==I&&z.h==V&&o<G){const e=me.keypoints3D[5];const t=me.keypoints3D[6];const x=Je.shoulder_width*1.5/nt.copy(e).distanceTo(t);const W=MMD_SA.TEMP_v3.fromArray(n).sub(l.position).multiplyScalar(1/x);let i=1;const P=Math.max(I,V)/Je.shoulder_width;const N=1-Math.min(Math.max(P-5,0)/5,1);o/=.5+(1-.5)*N;i*=1-Math.min(o/G,1);h.x+=W.x*i;h.y+=W.y*i}else{z.timestamp=0}}let g,y,b;const C=(Me.motion_tracking?.hand_tracking?.stabilize_arm_disabled?0:tt.stabilize_arm)>(Me.motion_tracking_upper_body_only?0:1);const H="YZX";let v;let t=Me.motion_tracking?.arm_tracking?.data_filter?.[c=="左"?"left":"right"];if(t)t=Object.assign({},t);let w;let S=Me.motion_tracking?.arm_tracking?.off_screen_allowed?.[c=="左"?"left":"right"];if(l.score>0){let e;if(de&&tt.enabled&&tt.use_hands_worker==1&&!fe.handpose){if(tt.hand_visible_timestamp[c]+200>RAF_timestamp)M=e=true}let n,t;if(tt.enabled&&fe.handpose){n=fe.handpose.find(e=>e.label==(c=="左"?"Left":"Right"));if(n){M=true}}if(n){tt.hand_visible_timestamp[c]=RAF_timestamp;if(!de)tt.hand_visible_session[c]=RAF_timestamp}if(tt.enabled&&de){let t;let i=tt.hand_visible_session[c]||0;if(n||e){if(i<1e3){tt.hand_visible_session[c]=1e3;if(!tt.stabilize_arm_time){v=true}else{t=true}}else if(i<1200){tt.hand_visible_session[c]+=Je._t_hands;if(tt.hand_visible_session[c]>1e3+tt.stabilize_arm_time){v=true}else{t=true}}else{tt.hand_visible_session[c]=RAF_timestamp}}else{tt.hand_visible_timestamp[c]=0;let e=!M;if(M&&i<1e3+tt.stabilize_arm_time){if(i>=1e3)i=tt.hand_visible_session[c]=201;e=true;t=true}if(e){v=M;if(!i){tt.hand_visible_session[c]=0;t=true}else if(i>200){tt.hand_visible_session[c]=200}else{tt.hand_visible_session[c]-=Je._t_hands;if(tt.hand_visible_session[c]<0)tt.hand_visible_session[c]=0}}}if(C){if(t){let e=S||!Me.motion_tracking_upper_body_only;let t=e&&S;let i,a;i=!e;if(!e||M){l.score=0;if(!e&&_t.skin[c+"ひじ"]?.[0].rot.w!=1){_t.add("skin",c+"ひじ",{absolute:true,no_blending:i,blending_ratio:a,rot:new THREE.Quaternion})}}if(e&&!l.score){w=true}if(!t&&_t.skin[c+"手首"]?.[0].rot.w!=1){_t.add("skin",c+"手首",{after_IK:true,absolute:true,no_blending:i,blending_ratio:a,rot:new THREE.Quaternion});_t.add("skin",c+"手捩",{after_IK:true,absolute:true,no_blending:i,blending_ratio:a,rot:new THREE.Quaternion})}if(!t&&(e&&tt.enabled)){let o;Ve.forEach((t,e)=>{let i=e==0?0:1;for(let e=i;e<i+3;e++){const n=c+t+"指"+Ge[e];if(_t.skin[n]?.[0].rot.w!=1){o=o||new THREE.Quaternion;_t.add("skin",n,{absolute:true,blending_ratio:a,rot:o})}}})}M=false;n=null}}}le.push({pos:l.position,dir:i,d:c,visible:M,off_screen_allowed:S,handpose:n,palm_offset:t})}else{tt.hand_visible_session[c]=0}const e=Te[c].filters[0].filter;if(v){if(!t)t={};t.minCutOff=Math.min(t.minCutOff||1,1);t.beta=Math.min(t.beta||1,.1);t.dCutOff=Math.min(t.dCutOff||1,.1)}else if(!M&&de){if(!t)t={};t.minCutOff=Math.min(t.minCutOff||1,.25);t.beta=Math.min(t.beta||1,.25);t.dCutOff=Math.min(t.dCutOff||1,.5)}let A=0;if(t){A=!v&&Me.motion_tracking_upper_body_only?_t.get_blend_default_motion("skin",c+(ge[c]?"足ＩＫ":"腕ＩＫ"))?0:1:1;if(t.weight_by_magnet){const Y=Me.motion_tracking.arm_tracking?.transformation?.position?.magnet?.find(e=>e.magnet_id==t.weight_by_magnet.id);A=Y&&Y._frame_count_>=EV_sync_update.count_frame-1-(tt.use_hands_worker==1?6:0)?Y._weight_:0}}const D=de?.5:2;e.minCutOff=D*(1-A)+(t?.minCutOff||D)*A;e.beta=D*(1-A)+(t?.beta||D)*A;e.dCutOff=1*(1-A)+(t?.dCutOff||1)*A;const B=ze[c].filters[0].filter;B.beta=e.beta;B.minCutOff=e.minCutOff;B.dCutOff=e.dCutOff;const E=c+(ge[c]?"足ＩＫ":"腕ＩＫ");let O=true;if(ue&&d.score>0){if(!S&&C&&!M&&de&&!Me.motion_tracking_upper_body_only){const Z=MMD_SA._v3b.copy(u).sub(f);if(l.score>0){const $=Z.length();const j=MMD_SA.TEMP_v3.copy(h).sub(f);f.z=u.z;const J=MMD_SA._v3b.copy(u).sub(f).length()/$;j.multiplyScalar(J).add(f);h.x=j.x;h.y=j.y;h.z=j.z}f.z=u.z}g=MMD_SA._v3b.copy(u).sub(f).normalize().applyQuaternion(re);y=MMD_SA.TEMP_v3.set(L,0,0);b=(new THREE.Quaternion).setFromUnitVectors(y,g);ye[n]=Be.setFromVectorSpherical(y,g).z}let k;if(l.score>0){if(ue){let e=d.score>0?MMD_SA.TEMP_v3.copy(u).distanceTo(f)+MMD_SA.TEMP_v3.copy(f).distanceTo(h):.5;let t=Math.min(MMD_SA.TEMP_v3.copy(u).sub(h).length()/e,1);let l;if(d.score>0){let e=MMD_SA_options.model_para_obj.colliders_for_hands?.chest?.scale;if(e>1&&Je.body_collider.mode>(de?0:1)){let r=MMD_SA._v3a.copy(u).sub(h).applyQuaternion(re);r.normalize().multiplyScalar(t*MMD_SA_options.model_para_obj.left_arm_length);const ee=c=="左"?-1:1;let _=THREE.Math.clamp(r.x/MMD_SA_options.model_para_obj.shoulder_width*ee,0,1)*THREE.Math.clamp(1-r.y/(MMD_SA_options.model_para_obj.shoulder_width*.75),0,1)*THREE.Math.clamp(1-(r.z-MMD_SA_options.model_para_obj.left_arm_length*.5)/(MMD_SA_options.model_para_obj.left_arm_length*.5),0,1);_=Math.sin(_*Math.PI/2)*Math.sin(Math.min((e-1)*.5,1)*Math.PI/2)*2;if(_){l=true;r=MMD_SA._v3a.copy(u).sub(h).normalize();let e=MMD_SA.TEMP_q.setFromAxisAngle(r,-Math.PI/4*_*ee);const t=u;const i=qe.copy(h).sub(t);const n=f;const o=(n.x*i.x+n.y*i.y+n.z*i.z-(t.x*i.x+t.y*i.y+t.z*i.z))/i.lengthSq();const a=MMD_SA._v3b.set(t.x+i.x*o,t.y+i.y*o,t.z+i.z*o);let s=MMD_SA.TEMP_v3.copy(f).sub(a);s.applyQuaternion(e).add(a);f.x=s.x;f.y=s.y;f.z=s.z}}}let i=MMD_SA._v3a.copy(u).sub(h);i.normalize().multiplyScalar(t*MMD_SA_options.model_para_obj.left_arm_length);if(Me.motion_tracking_upper_body_only&&!ge[c]&&_t._skin["左腕"]?.pos_local&&_t._skin["右腕"]?.pos_local){l=true;const te=MMD_SA.TEMP_v3.copy(_t._skin["左腕"].pos_local).sub(_t._skin["右腕"].pos_local);let e=Math.min(te.z*(c=="左"?1:-1),0)*.75;let t=Math.min(Math.abs(te.x)-MMD_SA_options.model_para_obj.shoulder_width,0)*(c=="左"?1:-1)*.5;i.x-=t;i.z-=e;const ie=Math.min(i.length(),MMD_SA_options.model_para_obj.left_arm_length);i.normalize().multiplyScalar(ie);if(d.score>0){f.x+=t/2}}if(pe)i.applyQuaternion(pe);o=i.x;a=i.y;s=i.z;r=s;if(d.score>0){if(l){g=MMD_SA._v3b.copy(u).sub(f).normalize().applyQuaternion(re);y=MMD_SA.TEMP_v3.set(L,0,0);b=(new THREE.Quaternion).setFromUnitVectors(y,g);ye[n]=Be.setFromVectorSpherical(y,g).z}O=g.y<0;let e=nt.copy(f).sub(h);e.normalize().applyQuaternion(re).applyQuaternion(MMD_SA.TEMP_q.copy(b).conjugate());y=MMD_SA.TEMP_v3.set(L,0,0);if(!w){k=(new THREE.Quaternion).setFromUnitVectors(y,e)}}if(!p||d.score<=0){p=false;if(b){if(!p)b.fromArray(w&&ze[c].timestamp!=null?ze[c].filter(null,true):ze[c].filter(b.toArray()));we(b,c+"腕");_t.add("skin",c+"腕",{absolute:true,rot:b,priority:-1,onFinish:Se});const ne=_t.skin[c+"腕"];const F=We[c+"腕"];const oe=MMD_SA.TEMP_q.copy(b).premultiply(F.axis_rot_inv).multiply(F.axis_rot);ne[0]._elbow0=new THREE.Vector3((c=="左"?1:-1)*MMD_SA_options.model_para_obj.left_arm_length/2,0,0).applyQuaternion(oe);if(k){we(k,c+"ひじ");_t.add("skin",c+"ひじ",{absolute:true,rot:k,_IK_disabled:p,onFinish:Ae})}}}else{we(k,c+"ひじ");we(b,c+"腕");_t.add("skin",c+"腕",{absolute:true,rot:b,priority:-1,onFinish:Se});_t.add("skin",c+"ひじ",{absolute:true,rot:k})}}else{m=true;let e=_.position.x-l.position.x;let t=_.position.y-l.position.y;o=e/se*MMD_SA_options.model_para_obj.shoulder_width*ce;a=t/se*MMD_SA_options.model_para_obj.shoulder_width;if(d.score>0){let e=Math.min(Math.sqrt(Math.pow(l.position.x-d.position.x,2)+Math.pow(l.position.y-d.position.y,2))/se,1);let t=Math.min(Math.sqrt(Math.pow(_.position.x-d.position.x,2)+Math.pow(_.position.y-d.position.y,2))/se,1);r=(.25+(Math.sin(Math.acos(e))+Math.sin(Math.acos(t)))/2*.75)*MMD_SA_options.model_para_obj.left_arm_length}}}else{let i;if(d.score>0){if(ue){let e=!!b;let t;if(Me.motion_tracking_upper_body_only&&_t._skin[E]?._pos_&&_t.get_blend_default_motion("skin",E)%1){t=true;[o,a,s]=_t._skin[E]._pos_}else{g=MMD_SA._v3a.copy(u).sub(f).normalize();g.multiplyScalar(MMD_SA_options.model_para_obj.left_arm_length);g.x*=ce;o=g.x*ce;a=g.y;s=g.z}r=s;if(!p){p=false;if(t){e=false;const ae=_t._skin[E]._foot_;if(ae){i=true;_t.add("skin",c+"足首",{after_IK:true,rot:ae.rot,_finger_x:null,absolute:true,onFinish:De})}}}else{p=true}if(e){if(!p)b.fromArray(w&&ze[c].timestamp!=null?ze[c].filter(null,true):ze[c].filter(b.toArray()));we(b,c+"腕");_t.add("skin",c+"腕",{absolute:true,rot:b,priority:-1,onFinish:Se});const ne=_t.skin[c+"腕"];const F=We[c+"腕"];const oe=MMD_SA.TEMP_q.copy(b).premultiply(F.axis_rot_inv).multiply(F.axis_rot);ne[0]._elbow0=new THREE.Vector3((c=="左"?1:-1)*MMD_SA_options.model_para_obj.left_arm_length/2,0,0).applyQuaternion(oe)}}else{p=false;m=true;let e=_.position.x-d.position.x;let t=_.position.y-d.position.y;let i=Math.sqrt(e*e+t*t);let n=Math.asin(e/i);o=Math.sin(n)*MMD_SA_options.model_para_obj.left_arm_length*ce;a=Math.cos(n)*MMD_SA_options.model_para_obj.left_arm_length*Math.sign(t)}}else{if(ue){if(!Me.motion_tracking_upper_body_only)return;s=r=0}else{m=true}if(o==null){p=false;o=MMD_SA_options.model_para_obj.left_arm_to_IK_xy[1]*(c=="左"?1:-1)*.2;a=-Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-o*o)}}if(ge[c]){_t.add("skin",c+"手首",{rot:new THREE.Quaternion});if(!i){_t.remove("skin",c+"足首")}}}let q=!p;if(p){if(o!=null){_t.skin[c+"腕ＩＫ"]?.[0].pos.fromArray(Te[c].filter([o,a,s]))}}else if((Me.motion_tracking?.arm_tracking?.use_IK||de)&&!t?.disabled){if(w&&Te[c].timestamp!=null){q=false;[o,a,s]=Te[c].filter(null,true)}}if(Me.motion_tracking_upper_body_only&&_t._skin[E]){_t._skin[E]._pos_=[o,a,s]}_e.push({pos:{x:o,y:a,z:s,z_posenet:r},z_limited:O,dir:i,d:c,IK_disabled:p,IK_absolute:m,use_filter:q})});ye[0]=ye[0]==null?0:Math.max(ye[0]+Math.PI/2,0);ye[1]=ye[1]==null?0:Math.max(Math.PI/2-ye[1],0);const V=ye[0]>ye[1]?1:0;const G=Math.min(Math.abs(ye[0]-ye[1])/(Math.PI/2),1);ye[V==0?1:0]=1;ye[V]=1-G*G*.5;t.forEach(function(e,i){let n=i==0?"左":"右";if(be[i]){st[i]*=ye[i];let e=(Ze.enabled?st[2]:0)*(i==0?1:-1);let t=st[i]+e;const o=Math.PI/6;if(Math.abs(t)>o){e=Math.sign(e)*(o-Math.abs(st[i]));t=st[i]+e}t=ht[n].filter(t);be[i].multiply(MMD_SA.TEMP_q.set(0,0,Math.sin(t/2),Math.cos(t/2)));_t.add("skin",n+"肩",{priority:-2,absolute:!(Me.motion_tracking_upper_body_only&&Me.motion_tracking?.motion_default_weight?.shoulder),rot:be[i],_rot_z:st[i],_rot_shrug:e,_rot_total:t,onFinish:te})}})}else{de=true}const D=M;if(ue&&!Me.motion_tracking_upper_body_only){if(pe){S.premultiply(MMD_SA.TEMP_q.copy(pe).conjugate());M=D-MMD_SA.TEMP_v3.setEulerFromQuaternion(S,"YZX").z}}if(ue&&!de){Ne.get_hip_center(me);let e=ce==1?[1,0]:[0,1];let b=[];let t=[];let v=0;let i=[];const k=Ne.grounding_factor2<1?Math.max(Ne.grounding_factor2*.5,.2):10;for(let a=0;a<2;a++){const x=a==0?"左":"右";let e=Ce[x].filters[0].filter;e.minCutOff=k;e.beta=k*.2;e=He[x].filters[0].filter;e.minCutOff=k;e.beta=k*.2;let i=me.keypoints3D[11+a];let n=me.keypoints3D[13+a];let o=me.keypoints3D[15+a];if(n.score>0){let t=MMD_SA.TEMP_v3.copy(n).sub(i);const P=t.length();t.fromArray(Ce[x].filter(t.normalize().toArray())).normalize().multiplyScalar(P);t.add(i);t.sub(n);n.x+=t.x;n.y+=t.y;n.z+=t.z;if(o.score>0){o.x+=t.x;o.y+=t.y;o.z+=t.z;for(let e=0;e<2;e++){const R=me._keypoints3D[29+e*2+a];R.x+=t.x;R.y+=t.y;R.z+=t.z}}}if(o.score>0){const $=n.score>0?n:i;let t=MMD_SA.TEMP_v3.copy(o).sub($);const P=t.length();t.fromArray(He[x].filter(t.normalize().toArray())).normalize().multiplyScalar(P);t.add($);t.sub(o);o.x+=t.x;o.y+=t.y;o.z+=t.z;for(let e=0;e<2;e++){const R=me._keypoints3D[29+e*2+a];R.x+=t.x;R.y+=t.y;R.z+=t.z}}}let w=0;e.forEach(function(o,e){let a=e==0?"左":"右";let i=me.keypoints3D[11+o];let s=me.keypoints3D[13+o];let r=me.keypoints3D[15+o];let t,n,_;if(r.score>0){t=MMD_SA._v3a.copy(i).sub(r);let e=t.z;n=t.length();_=s.score>0?MMD_SA.TEMP_v3.copy(i).distanceTo(s)+MMD_SA.TEMP_v3.copy(s).distanceTo(r):.7;t.normalize().multiplyScalar(Math.min(n/_,1)*MMD_SA_options.model_para_obj.left_leg_length);t.z*=(e-w)/e}let l,c;let d;if(s.score>0){d=MMD_SA._v3b.copy(i).sub(s).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(S).conjugate());let e=MMD_SA.TEMP_v3.set(0,1,0);e.y*=-1;c=Be.setFromVectorSpherical(e,d);l=(new THREE.Quaternion).setFromEuler(c,"XZY");const t=nt.setFromVectorSpherical(e,MMD_SA._v3b.copy(i).sub(s).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(S).multiply(MMD_SA._q2.set(0,0,Math.sin(D/2),Math.cos(D/2))).multiply(MMD_SA._q1.set(Math.sin(A/2),0,0,Math.cos(A/2))).conjugate()));v+=t.x}let p=!Je.use_legIK;if(r.score>0){let i,n;if(s.score>0){i=nt.copy(s).sub(r).normalize().applyQuaternion(MMD_SA.TEMP_q.copy(S).conjugate());n=Oe.copy(i).applyQuaternion(MMD_SA.TEMP_q.copy(l).conjugate());n.z=Math.max(-n.z,0);n.x*=-1;let e=n.normalize().toSphericalCoords();let t=Math.sqrt(Math.min((Math.PI-e[2])/(Math.PI/2),1));c.y=e[1]*t;l.setFromEuler(c,"XZY")}if(!p||s.score<=0){Je.enable_IK(a+"足ＩＫ",true);b.push({pos:t.clone(),rot:[l],dir:o,d:a})}else{n=Oe.copy(i).applyQuaternion(MMD_SA.TEMP_q.copy(l).conjugate());let e=MMD_SA.TEMP_v3.set(0,1,0);e.y*=-1;let t=(new THREE.Quaternion).setFromVectorSpherical(e,n);Je.enable_IK(a+"足ＩＫ",false);b.push({rot:[l,t],dir:o,d:a})}const m=me._keypoints3D[29+o];const u=me._keypoints3D[31+o];if(m.score>0&&u.score>0){let e=MMD_SA._v3a_.copy(m).sub(r).normalize();let t=MMD_SA._v3b_.copy(m).sub(u).normalize();let i=nt.crossVectors(e,t).normalize();e.crossVectors(t,i);ot.set(i.x,i.y,i.z,0,e.x,e.y,e.z,0,t.x,t.y,t.z,0,0,0,0,1);Ke.setFromBasis(ot);let n=Ke.conjugate();const f=-Math.PI/(MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?10:8);n=n.clone().multiply(MMD_SA.TEMP_q.set(Math.sin(f/2),0,0,Math.cos(f/2)));if(pe)n.premultiply(pe);const h=Xe.copy(S);if(pe)h.premultiply(pe);const M=MMD_SA.TEMP_v3.setEulerFromQuaternion(h,"YZX");const g=Math.abs(M.y)%Math.PI;let o=g>Math.PI/2?1-(g-Math.PI/2)/(Math.PI/2):1;if(Je.use_legIK){const y=n.clone();if(o<1){M.x=M.z=0;y.slerp(Ue.setFromEuler(M,"YZX"),1-o)}b[b.length-1].rot[2]=y}if(Ne.grounding_factor2<1)n.slerp(MMD_SA.TEMP_q.set(0,0,0,1),1-Ne.grounding_factor2);_t.add("skin",a+"足首",{after_IK:true,absolute:true,parent_based:true,motion_recorder_disabled:Je.use_legIK,rot:n,ratio:o,ratio_euler:MMD_SA_options.user_camera.ML_models.pose.model_quality=="Best"?{x:1,y:1,z:.5,order:"YXZ"}:null})}}else{if(s.score>0){if(!p){t=MMD_SA._v3a.copy(i).sub(s).normalize().multiplyScalar(MMD_SA_options.model_para_obj.left_leg_length);if(pe)t.applyQuaternion(pe);Je.enable_IK(a+"足ＩＫ",true);b.push({pos:t.clone(),rot:[l],dir:o,d:a})}else{Je.enable_IK(a+"足ＩＫ",false);b.push({rot:[l],dir:o,d:a})}}else{t=MMD_SA._v3a.fromArray(Ce[a].filter([0,1,0]))}if(_t.skin[a+"足首"]?.[0].rot.w!=1)_t.add("skin",a+"足首",{after_IK:true,absolute:true,no_blending:true,rot:new THREE.Quaternion})}});let n=0;i.forEach(e=>{const t=e.y*(1-e.scale);if(t>0){n=Math.max(t,n)}else if(i.length>1){n=Math.max(t,n||t)}});if(n){Ne.v_hip.y+=n;it+="\nleg_offset_y:"+n+"\n"}v*=.5*.5;v+=A;v=at("hip_angle_x",v,!!de);let o=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(v,0,M),"YZX");_t.add("skin","下半身",{absolute:true,rot:o.clone()});if(!de){_t.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,onProcessPosition:ee})}o.conjugate();b.forEach(e=>{var t=e.d;if(e.rot[0]){e.rot[0].multiplyQuaternions(o,e.rot[0]);_t.add("skin",t+"足",{absolute:true,rot:e.rot[0]})}if(e.pos){e.pos.add(MMD_SA_options.model_para_obj.leg_IK_offset[t]);const i=e.rot[2]||_t.skin[t+"足ＩＫ"]?.[0].rot;_t.add("skin",t+"足ＩＫ",{absolute:true,pos:e.pos,rot:i,priority:999,onFinish:Tt});if(i&&!_t.skin[t+"足ＩＫ"][1].rot)_t.skin[t+"足ＩＫ"][1].rot=i}else{if(e.rot[1]){_t.add("skin",t+"ひざ",{absolute:true,rot:e.rot[1]})}else if(_t.skin[t+"ひざ"]?.[0].rot.w!=1){_t.add("skin",t+"ひざ",{absolute:true,no_blending:true,rot:new THREE.Quaternion})}}})}else{if(Me.motion_tracking_upper_body_only){Ne.get_hip_center(me);_t.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,onProcessPosition:ee})}else if(ue&&i.score>0&&n.score>0&&Ye.video_canvas.width){Ne.get_hip_center(me);_t.add("skin","全ての親",{pos:new THREE.Vector3,after_IK:true,priority:999,onProcessPosition:ee})}if(!ge["左"]||!ge["右"]){let t=at("hip_angle_x",0,!!de);if(M||t){let e=(new THREE.Quaternion).setFromEuler(MMD_SA.TEMP_v3.set(t,0,M),"YZX");_t.add("skin","下半身",{absolute:true,rot:e.clone()})}else{_t.add("skin","下半身",{is_dummy:true,rot:true})}}for(const T of["左","右"]){if(!ge[T]){_t.add("skin",T+"足ＩＫ",{is_dummy:true,pos:true,priority:999});_t.add("skin",T+"足",{is_dummy:true,rot:true});_t.add("skin",T+"ひざ",{is_dummy:true,rot:true});_t.add("skin",T+"足首",{is_dummy:true,after_IK:true,rot:true})}}}}}else{Je.data_detected=0}}if(Je.pose_enabled&&!Je.data_detected_stable&&!Qe){Qe=true;if(Me.motion_tracking_upper_body_only){_t.reset()}else if(Je.initial_data_detected){if(Je.hide_avatar_on_tracking_loss){System._browser.on_animation_update.add(()=>{a.mesh.visible=false},0,0)}}}let I;let A=[];const H=!tt.enabled&&me&&Je.use_3D_pose&&(!Ye.VMC_receiver.active||Ye.VMC_receiver.hand_independent<2);const s=ce==1?[1,0]:[0,1];const d={};const r=tt.enabled&&Je.shoulder_width?Math.min(Math.max(Math.max(Ye.video_canvas.width,Ye.video_canvas.height)/Je.shoulder_width-5,0)/5,1)*.5:0;const B={"左":r,"右":r};if(H||Je.pose_enabled&&!Me.motion_tracking_upper_body_only&&r){s.forEach(function(e,t){let i=t==0?"左":"右";if(!le.find(e=>e.d==i)?.visible)return;let n=me._keypoints3D[15+e];let o=me._keypoints3D[17+e];let a=me._keypoints3D[19+e];if(n.score<=0||o.score<=0||a.score<=0)return;let s=e==1?[a,o]:[o,a];let r=MMD_SA._v3a_.copy(n).sub(MMD_SA._v3b.copy(o).add(a).multiplyScalar(.5)).normalize();r.x=r.x*ce;let _=MMD_SA._v3b_.copy(s[0]).sub(s[1]).normalize();_.z=_.z*ce;_.y=_.y*ce;let l=MMD_SA.TEMP_v3.crossVectors(_,r).normalize();_.crossVectors(r,l);ot.set(_.x,_.y,_.z,0,r.x,r.y,r.z,0,l.x,l.y,l.z,0,0,0,0,1);Ke.setFromBasis(ot);let c=new THREE.Quaternion;c.copy(Ke).conjugate();if(pe)c.premultiply(pe);d[i]=c})}if(!Je.pose_enabled&&tt.enabled&&fe.handpose&&fe.handpose.length){s.forEach(function(e,t){let i=t==0?"左":"右";let n=fe.handpose.find(e=>e.label==(i=="左"?"Left":"Right"));if(n)le.push({dir:e,d:i,handpose:n,visible:true})})}if(tt.enabled&&fe.handpose&&fe.handpose.length&&le.length){const J=vt?1:2;fe.handpose.forEach(e=>{e._offset={};I=e.annotations;if(J>1){for(let e in I){I[e].forEach(e=>{e[2]*=J})}}});le.forEach((_,e)=>{var l=_.dir;let c=_.handpose;if(c&&_.visible){_.visible=true;c._used=true;let k=_.d;c._d=k;I=c.annotations;const d=qe.set(1,1,c.z_adjust_ratio||1);if(Je.pose_enabled){let e=_e.find(e=>e.dir==l);let t=Me.motion_tracking?.hand_tracking?.depth_adjustment_disabled?0:MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent/100;if(t&&de&&e.pos.z>0&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=k){const g=(MMD_SA._v3a.fromArray(I.palm[0]).multiply(d).distanceTo(MMD_SA._v3b.fromArray(I.middle[0]).multiply(d))+MMD_SA._v3a.fromArray(I.index[0]).multiply(d).distanceTo(MMD_SA._v3b.fromArray(I.pinky[0]).multiply(d)))/2/Je.shoulder_width;const y=MMD_SA_options.user_camera.ML_models.hands.palm_shoulder_scale_percent/100;const b=Math.max(Ye.video_canvas.width,Ye.video_canvas.height)/Je.shoulder_width;Fe.filter(Math.max(3-Math.max(b-5,0),0)/3);palm_far_scale=(1.8+(1-Math.min(Math.max(b-4,0),1))*.4)*((1-MMD_SA_options.user_camera.ML_models.hands.depth_scale_percent/100)*2);je[k].filter(Math.min(Math.max(g-y,0)/Math.max(y*palm_far_scale-y,.1),1))}}if(c.worldLandmarks){I=c.worldLandmarks.annotations;d.set(1,1,1)}A.push(k+"手");const p="pinky";let e=l==1?[I.index[0],I[p][0]]:[I[p][0],I.index[0]];let t,i,n;let o=MMD_SA._v3a_.fromArray(I.palm[0]).multiply(d).sub(MMD_SA._v3b.fromArray(I.middle[0]).multiply(d)).normalize();o.x=o.x*ce;let a=MMD_SA._v3b_.fromArray(e[0]).multiply(d).sub(MMD_SA._v3b.fromArray(e[1]).multiply(d)).normalize();a.z=a.z*ce;a.y=a.y*ce;let s=MMD_SA.TEMP_v3.crossVectors(a,o).normalize();a.crossVectors(o,s);ot.set(a.x,a.y,a.z,0,o.x,o.y,o.z,0,s.x,s.y,s.z,0,0,0,0,1);Ke.setFromBasis(ot);let r=new THREE.Quaternion;r.copy(Ke).conjugate();if(S.enabled){const v=S.angle*Math.PI/180;const w=MMD_SA._q2.set(Math.sin(v/2),0,0,Math.cos(v/2));r.premultiply(w)}const m=MMD_SA.TEMP_v3.setEulerFromQuaternion(r,"YXZ").y;const u=1;const M=(Math.abs(m)<Math.PI/6?1:Math.abs(Math.abs(m)-Math.PI)<Math.PI/6?-1:0)*u;const T=Math.max((Math.abs(m)-Math.PI/2)*u,0)/(Math.PI/2);let x=MMD_SA_options.model_para_obj.finger_base;let P=Xe.copy(Ke);P.x*=-1;P.z*=-1;let R=k=="左"?1:-1;let f=0;let h=0;Ve.forEach((e,t)=>{let i=x[(ce==1?k:k=="左"?"右":"左")+t];let n=i.base_index+(t==0?0:-1);let o=I[Mt[t]];let a=Ue.copy(P);const s="XZY";if(t==0||t==4)return;const r=gt[k][t];const _=MMD_SA.TEMP_v3.fromArray(I.palm[0]);let l=MMD_SA._v3a_.fromArray(o[0]).sub(_);let c=MMD_SA._v3b_.fromArray(o[1]).sub(_);l.y*=-1;c.y*=-1;l.applyQuaternion(a);c.applyQuaternion(a);let d=MMD_SA.TEMP_v3.set(0,1,0);let p=c.sub(l).normalize();let m=Be.setFromVectorSpherical(d,p);const u=1;f+=m.z*u;h+=u});f/=h;rot_y_offset=MMD_SA.TEMP_q.set(0,Math.sin(f/2),0,Math.cos(f/2));P.conjugate().multiply(rot_y_offset).conjugate();rot_y_offset.set(0,Math.sin(f/4),0,Math.cos(f/4));r.multiply(rot_y_offset);if(tt.wrist_enabled){_t.add("skin",k+"手首",{after_IK:true,rot:r,onProcessRotation:zt});_t.add("skin",k+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})}Ve.forEach((e,t)=>{let i=x[(ce==1?k:k=="左"?"右":"左")+t];let n=i.base_index+(t==0?0:-1);let o=I[Mt[t]];let a=Ue.copy(P);const s="XZY";const r=gt[k][t];const _=MMD_SA.TEMP_v3.fromArray(I.palm[0]);for(let e=0;e<4;e++){const l=r[e].pos.fromArray(o[e]).sub(_);l.y*=-1;l.applyQuaternion(a)}});Ve.forEach((p,m)=>{let u=x[(ce==1?k:k=="左"?"右":"左")+m];let f=u.base_index+(m==0?0:-1);let h=I[Mt[m]];let M;const g="XZY";const y=k+p+"指"+Ge[u.base_index];const b=m==0?1:0;for(let d=f;d<3;d++){let e=k+p+"指"+Ge[u.base_index+(d-f)];const v=gt[k][m];const w=MMD_SA.TEMP_v3.copy(v[d].pos);for(let e=d;e<4;e++){const S=v[e].pos;S.sub(w);if(M&&e>d)S.applyQuaternion(M)}M=Ue;let t=v[d+0].pos;let i=v[d+1].pos;let n=MMD_SA._v3a_.set(0,1,0);let o=MMD_SA._v3b_.copy(i).sub(t).normalize();let a=MMD_SA._q1.set(0,0,0,1);let s=v[d].rot;if(m>0||d==2){s.setFromVectorSpherical(n,o);a.setFromEuler(s,g)}else{a.setFromUnitVectors(n,o);s.setEulerFromQuaternion(a,g)}M=Ue.copy(a).conjugate();if(Math.abs(s.z)>Math.PI/(m==0?1.1:2.5)||s.x>Math.PI/(m==0?1.1:3)){s.set(-Math.abs(n.angleTo(o)),0,0)}let r;if(m==0&&d>f+1){}else if(s.x>0){if(m>0&&d==0&&T>.5&&s.x>Math.PI/8){s.x*=-T}else s.x*=m==0?1:d>f?v[0].rot.x<0?-Math.min(Math.abs(v[0].rot.x)/(Math.PI/3),1):0:.75}if(s.x<0){r=-Math.PI/(m==0?1.25:1.8)}if(m==0){if(d==f){s.z=s.z*(d==0?1.25:1)+(Math.PI/8+(d==0?Math.PI/8:0))*(k=="左"?1:-1)}else if(d==1){s.z-=Math.PI/8*(k=="左"?1:-1)}else if(d==2){s.x=0;const A=Math.min(Math.abs(s.z)/(Math.PI/2),1);if(s.z>0){s.y=-Math.PI/4*Math.min(A*2,1);s.z=Math.PI/2*A}else{s.z=-Math.PI/2*A*1.5}}}else{let e=Math.min(...v.filter((e,t)=>t<=d).map(e=>e.rot.x));if(d==0){if(m>2){s.z=R*Math.abs(s.z)}}else{let t=1-(e<-Math.PI/6?Math.min(Math.abs(e+Math.PI/6)/(Math.PI/2-Math.PI/6),1):0);s.z*=t*(d==0?1:d==1?.75:.5);if(t<1){if(a.w>1)a.normalize();let e=2*Math.acos(a.w);s.x=s.x*t+Math.sign(s.x)*Math.abs(e)*(1-t)}}}if(T&&m>0&&d==f){const e=MMD_SA._v3a.fromArray(h[d+1]);e.y*=-1;e.applyQuaternion(P);const D=MMD_SA._v3b.fromArray(h[d+3]);D.y*=-1;D.applyQuaternion(P);if(e.y>D.y){const E=T;let e=1-E;s.z*=e;if(a.w>1)a.normalize();let t=2*Math.acos(a.w);s.x=s.x*e+Math.sign(s.x)*Math.abs(t)*(1-e)}}if(r)s.x=Math.max(s.x,r);a.setFromEuler(s,g);let _=e;let l=a.toAxisAngle();axis=l[0];angle=l[1];axis.z*=-1;let c=!MMD_SA.THREEX.enabled&&m==0?Math.min((Math.PI/8-We[y]._axis_rot_offset_inv_z*R)/(Math.PI/8),1.5):1;if(!MMD_SA.THREEX.enabled&&m==0)axis.applyEuler(MMD_SA.TEMP_v3.set(0,Math.PI/4*R*c,0));axis.applyEuler(nt.set(MMD_SA.THREEX.enabled?Math.PI/2:0,-Math.PI/2*R,0),"YXZ");if(m==0&&MMD_SA.THREEX.enabled){a.setFromAxisAngle(axis,angle)}else{if(m==0&&!MMD_SA.THREEX.enabled&&c<.5){axis.applyQuaternion(MMD_SA.TEMP_q.set(0,0,0,1).slerp(We[_].axis_rot,c/.5));if(c<.5)c=.5+(1-c/.5)}else{axis.applyQuaternion(We[_].axis_rot)}a.setFromAxisAngle(axis,angle)}if(d==b)a.premultiply(MMD_SA.TEMP_q.set(0,0,0,1).slerp(We[y].axis_rot_offset_inv,m==0?.5*c:1));if(ge[k]){if(d==f){const e=_t.skin[k+"手首"][0];if(!e._finger_x)e._finger_x=[];e._finger_x[m]=s.x}}else{_t.add("skin",e,{absolute:true,rot:a.clone()})}}})}else{const e=_.d;if(Me.motion_tracking_upper_body_only&&(!Me.motion_tracking?.hand_tracking?.stabilize_arm_disabled&&tt.stabilize_arm)&&_t.get_blend_default_motion("skin",e+(ge[e]?"足首":"手首"))!=0){_.visible=false}}})}else if(H){s.forEach(function(e,t){let i=t==0?"左":"右";if(d[i]){_t.add("skin",i+"手首",{after_IK:true,rot:d[i],onProcessRotation:zt});_t.add("skin",i+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})}})}const O={};const q={};s.forEach(function(e,t){const s=t==0?"左":"右";const i=s=="左"?"left":"right";const n=Ft(i)||Me.motion_tracking?.hand_tracking?.rotation_reference?.[i];if(n){let a=n.weight!=null?n.weight:1;let e=rt(n);a*=e;let t;if(n.type=="object3D"){const o=MMD_SA.THREEX._XR_Animator_scene_.object3D_list.find(e=>e.id==n.name);if(!o)return;const r=MMD_SA.THREEX._object3d_list_.find(e=>e.uuid==o._object3d_uuid);if(r._rot_aligned_){if(r.parent_bone.name==s+"手首"){if(r._rot_aligned_weight_!=null){a=r._rot_aligned_weight_;t=r._rot_aligned_weight_absolute_}}}q[s]=n.weight_by_angle_difference;O[s]=n.constrained_direction}if(n.weight_by_magnet){const _=Me.motion_tracking.arm_tracking?.transformation?.position?.magnet?.find(e=>e.magnet_id==n.weight_by_magnet.id);a=_&&_._frame_count_>=EV_sync_update.count_frame-1-(tt.use_hands_worker==1?6:0)?_._weight_*(n.weight_by_magnet.max||a):0}if(!le.find(e=>e.d==s)?.handpose?._used){a=1}if(!t)a=Le[s].filter(a);B[s]=a;if(a){if(!_t.skin[s+"手首"]){const l=new THREE.Quaternion;_t.add("skin",s+"手首",{after_IK:true,rot:l,onProcessRotation:zt});_t.add("skin",s+"手捩",{after_IK:true,absolute:true,priority:1,no_blending:true,rot:new THREE.Quaternion})}else if(_t.skin[s+"手首"][0].timestamp<RAF_timestamp-100){_t.skin[s+"手首"][0]._rot_parent=null}}a=n.fingers_weight?n.fingers_weight*e:Math.min(a*(n.fingers_weight_scale||1),1);if(a){if(n.fingers_from_opposite_hand||n.fingers){const i=["０","１","２","３"];const c={thumb:"親",index:"人",middle:"中",ring:"薬",pinky:"小"};if(n.fingers_from_opposite_hand){const d=s=="左"?"右":"左";Object.values(c).forEach(o=>{i.forEach(e=>{const t=s+o+"指"+e;const i=d+o+"指"+e;let n=_t.skin[i]?.[0].rot;if(n){n=MMD_SA.TEMP_q.copy(n);n.y*=-1;n.z*=-1;if(!_t.skin[t]){_t.add("skin",t,{absolute:true,rot:n.clone()})}else{_t.skin[t][0].rot.slerp(n,a)}}})})}else if(n.fingers){for(const p in n.fingers){let[e,t]=p.split("|");e=c[e];t=i[parseInt(t)+(e=="親"?-1:0)];e=s+e+"指"+t;const m=_t.skin[e];if(m&&m[0].timestamp==RAF_timestamp){const u=n.fingers[p];let e=MMD_SA.TEMP_q;if(u.w==null){e=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(u).multiplyScalar(Math.PI/180));u.x=e.x;u.y=e.y;u.z=e.z;u.w=e.w}else{e.copy(u)}m[0].rot.slerp(e,a)}}}}}}});for(const T of["左","右"]){const z=_t.skin[T+"手首"];if(z){z[0]._rot_pose=d[T];z[0]._rot_pose_ratio=B[T];z[0]._rot_pose_constrained=O[T];z[0]._rot_pose_ratio_by_angle_difference=q[T];if(!z[0]._finger_x)z[0]._finger_x=z[1]._finger_x}}const g=[];_e.forEach(function(o){var a=o.d;const t=new THREE.Vector3;if(o.use_filter){const i=Te[a].filters[0].filter;const n=Ie[a].filters[0].filter;for(const e of["minCutOff","beta","dCutOff"])n[e]=i[e];t.fromArray(Ie[a].filter([o.pos.x,o.pos.y,o.pos.z]))}else{Ie[a].filter(null,true);t.copy(o.pos)}let s=Me.motion_tracking?.hand_tracking?.depth_adjustment_disabled?0:MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent/100;if(s&&tt.enabled&&de&&MMD_SA_options.Dungeon_options?.item_base.hand_camera?._hand_camera_side!=a){let i=je[a].filter();let e=(RAF_timestamp-je[a].timestamp)/1e3;let n=1-Math.min(Math.max(e-.2,0)/(1-.2),1);const r=C.para.spine_length/5;if(o.pos.z>=0){if(n){let e=Fe.filter();s*=n*e;let t=i*MMD_SA_options.model_para_obj.left_arm_length*s+o.pos.z*(1-s);o.pos.z=t}}if(o.pos.z<r&&o.z_limited)o.pos.z=r;const _=Math.sqrt(MMD_SA_options.model_para_obj.left_arm_length*MMD_SA_options.model_para_obj.left_arm_length-o.pos.x*o.pos.x-o.pos.y*o.pos.y)||0;if(Math.abs(o.pos.z)>_)o.pos.z=Math.sign(o.pos.z)*_}if(o.use_filter){const e=Te[a].filter([o.pos.x,o.pos.y,o.pos.z]);o.pos.x=e[0];o.pos.y=e[1];o.pos.z=e[2]}if(ge[a]){if(o.IK_disabled)return;Je.enable_IK(a+"足ＩＫ",true);if(_t.skin[a+"手首"]&&_t.skin[a+"腕"]&&_t.skin[a+"手首"][0].timestamp==_t.skin[a+"腕"][0].timestamp){let e;if(e){}else{const d=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(Math.PI/2,0,0));const p=_t.skin[a+"手首"][0].rot.premultiply(d).multiply(d.conjugate());if(_t._skin[a+"足ＩＫ"])_t._skin[a+"足ＩＫ"]._foot_={rot:p.clone(),_finger_x:_t.skin[a+"手首"][0]._finger_x};_t.add("skin",a+"足首",{after_IK:true,rot:p,_finger_x:_t.skin[a+"手首"][0]._finger_x,absolute:true,onFinish:De})}}else{const m=_t.skin[a+"足首"];if(m){m[0].rot_parent=m[0]._rot_parent}}_t.remove("skin",a+"手首");_t.remove("skin",a+"腕");_t.remove("skin",a+"ひじ");_t.remove("skin",a+"手捩");_t.remove("skin",a+"腕ＩＫ");if(tt.enabled){Ve.forEach((t,e)=>{let i=e==0?0:1;for(let e=i;e<i+3;e++)_t.remove("skin",a+t+"指"+Ge[e])})}const e=le.find(e=>e.d==a);if(!e?.visible){if(_t.skin[a+"足首"]&&_t.get_blend_default_motion("skin",a+"足首")%1==0)delete _t.skin[a+"足首"][0].onFinish}const l=(new THREE.Vector3).copy(o.pos);const t=M.transformation?.position;const c=It(a+"足ＩＫ",l,t,e=>{const t=MMD_SA_options.model_para_obj.left_leg_length;e.y+=t*1/3;e.z+=t*.25;e.multiplyScalar(1.5)});g.push({d:a,pos:l,rot:c[1]})}else{Je.enable_IK(a+"腕ＩＫ",!o.IK_disabled);if(!o.IK_disabled){if(o.pos.z==null)o.pos.z=o.pos.z_posenet||(Je.use_3D_pose?0:MMD_SA_options.model_para_obj.left_arm_length*.2);const u=le.find(e=>e.d==a);const f=(new THREE.Vector3).copy(o.pos);let e=Me.motion_tracking?.arm_tracking?.off_screen_allowed?.[a=="左"?"left":"right"];_t.add("skin",a+"腕ＩＫ",{priority:999,pos:f,_IK_absolute:o.IK_absolute,_hand_visible:e||u?.visible,_pos0:t,onProcessPosition:jt});const h=_t.skin[a+"腕ＩＫ"];if(!h[1]._pos0)h[1]._pos0=h[0]._pos0;if(h[0]!=h[1]&&h[0]._blending_ratio)h[0]._pos0.lerp(h[1]._pos0,1-h[0]._blending_ratio)}const e=_t.skin[a+"手首"];if(e){e[0].rot_parent=e[0]._rot_parent}}});if(g.length&&M.transformation?.position?.process)M.transformation.position.process(g);g.forEach(e=>{const t=e.d;const i=e.pos;i.y+=MMD_SA_options.model_para_obj.left_leg_IK[1]+(L["センター"].position.y-L["センター"].pmxBone.origin[1]);if(e.rot){_t.add("skin",t+"足",{absolute:true,rot:e.rot,onFinish:function(e,t){this.skin[t][0]._rot_=e.bones_by_name[t].quaternion.clone()}})}else{_t.remove("skin",t+"足")}_t.remove("skin",t+"ひざ");_t.add("skin",t+"足ＩＫ",{absolute:true,priority:999,pos:i})});if(!Je.pose_enabled){}else if(Qe){if(Me.motion_tracking_upper_body_only){for(const T of["左","右"]){Je.enable_IK(T+"腕ＩＫ",Me.has_arm_IK)}}}else if(Me.motion_tracking_upper_body_only){for(const T of["左","右"]){let e=Me.motion_tracking?.arm_tracking?.off_screen_allowed?.[T=="左"?"left":"right"];const z=le.find(e=>e.d==T);const j=e?false:!z?.visible;if(ge[T]){_t.set_blend_default_motion("skin",T+"足ＩＫ",j);_t.set_blend_default_motion("skin",T+"足",j);_t.set_blend_default_motion("skin",T+"ひざ",j);_t.set_blend_default_motion("skin",T+"足首",j)}else{if(Me.has_leg_IK){_t.set_blend_default_motion("skin",T+"足ＩＫ",true);_t.remove("skin",T+"足首")}else{_t.set_blend_default_motion("skin",T+"足",true);_t.set_blend_default_motion("skin",T+"ひざ",true);_t.set_blend_default_motion("skin",T+"足首",true)}Je.enable_IK(T+"足ＩＫ",Me.has_leg_IK);Je.enable_IK(T+"つま先ＩＫ",Me.has_leg_IK);_t.set_blend_default_motion("skin",T+"肩",j);_t.set_blend_default_motion("skin",T+"腕",j);_t.set_blend_default_motion("skin",T+"ひじ",j);_t.set_blend_default_motion("skin",T+"手捩",j);_t.set_blend_default_motion("skin",T+"手首",j);_t.set_blend_default_motion("skin",T+"腕ＩＫ",j);if(tt.enabled){Ve.forEach((t,e)=>{let i=e==0?0:1;for(let e=i;e<i+3;e++)_t.set_blend_default_motion("skin",T+t+"指"+Ge[e],j)})}}}}it+=MMD_SA_options.model_para_obj.colliders_for_hands?.debug_hit()||"";it+=!MMD_SA.THREEX.camera.control.enabled?"🔒(3D camera locked)\n":"";it+=System._browser.motion_control.debug_msg;it+=(it?"":"\n")+(_t.NaN_count?"❌"+_t.NaN_count+"\n":"")+"Pose-FPS:"+Math.round(ie)+"/"+Math.round(fe.fps||0)+(tt.use_hands_worker?"\nHand-FPS:"+Math.round(se):"");if(fe.object_detection)it+="\nObject-FPS:"+Math.round(1e3/fe.object_detection.t)+"(+"+et.detection_interval+"ms)";System._browser.motion_control.process({posenet_data:fe});if(Ye.motion_recorder.speed){const F=Ye.motion_recorder.stats;it+="\n🔴 "+Ye.motion_recorder.time+"(-"+F[0]+"/"+F[1]+"-"+F[3]+"/"+F[2]+"-"+F[4]+")"}if(it&&!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden&&(Je.use_holistic?!fe.facemesh:!Ze.enabled)){System._browser.on_animation_update.add(()=>{DEBUG_show((Je.use_holistic&&"(no facemesh data)"||"")+(ct?"\n"+ct+"\n":"")+it+"\n"+"FPS:"+EV_sync_update.fps_last)},0,0)}if(fe.facemesh){Ze.worker_onmessage({data:fe.facemesh})}if(Ze.draw_canvas&&me&&Ze.worker_initialized){let e={posenet:me,w:Ye.video_canvas.width,h:Ye.video_canvas.height,flip_canvas:Ye.display_flipped};if(fe.handpose&&fe.handpose.length)e.handpose=fe.handpose;if(fe.facemesh)e.facemesh=fe.facemesh.faces;if(Je.use_holistic||!Ze.enabled){e.draw_canvas=true;if(self.FacemeshAT){e.canvas=Ye.video_canvas_facemesh}else if(!Ye.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){e.canvas=Ye.video_canvas_facemesh.transferControlToOffscreen();Ye.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}}$e.postMessage(e,e.canvas?[e.canvas]:undefined)}et.process(fe.object_detection);if(!Ze.draw_canvas){Ze.wireframe._data.pose=me;Ze.wireframe._data.object_detection=et.data?.detections;if(fe.handpose)Ze.wireframe._data.handpose=fe.handpose;if(fe.facemesh)Ze.wireframe._data.facemesh=fe.facemesh.faces;if(fe.facemesh){Ze.wireframe._data.bb={x:0,y:0,w:Ye.video_canvas.width,h:Ye.video_canvas.height}}}dt=0}I()}}();function rt(e){const t=e?.mocap_factor;if(!t)return 1;if(!Ye.VMC_receiver.active)return 1;let i=Ye.VMC_receiver.prop_mocap_factor_percent/100;if(i==1)return 1;const n=t.type;if(n=="hand"){if(tt.enabled)return 1}else if(n=="wrist"){if(tt.wrist_enabled)return 1}else if(n=="pose"){if(Je.pose_enabled)return 1}const o=t.base||0;if(o<0){i=Math.pow(i,1-o)}else if(o<=1){i=o+(1-o)*i}return i}function Tt(e,t){if(Je.IK_disabled_check(t))return;var i=e.bones_by_name[t];var n=this.skin[t];var o=t.charAt(0);var a=MMD_SA.TEMP_v3.fromArray(e.bones_by_name[o+"足"].pmxBone.origin);var s=MMD_SA.get_bone_position(e,o+"足","全ての親").sub(a);s.sub(_t.skin["センター"]?.[0]._hip_adjustment_offset||MMD_SA.TEMP_v3.set(0,0,0));i.position.add(s);e.bones_by_name[o+"ひざ"].quaternion.set(0,0,0,1);if(lt.active){if(Je.use_legIK){const r=MMD_SA.TEMP_v3.copy(i.position);r.sub(nt.fromArray(e.bones_by_name[t].pmxBone.origin).sub(Be.fromArray(e.bones_by_name[t].parent?.pmxBone?.origin||[0,0,0])));lt.set_boneKey(t,r,n[0].rot?i.quaternion:null,true)}window.addEventListener("SA_MMD_model"+e._model_index+"_process_bones_after_IK",()=>{lt.set_boneKey(o+"足",null,e.bones_by_name[o+"足"].quaternion,false);lt.set_boneKey(o+"ひざ",null,e.bones_by_name[o+"ひざ"].quaternion,false)},{once:true})}i.quaternion.set(0,0,0,1)}var It=(()=>{const C=(()=>{const s={};let r,_;window.addEventListener("jThree_ready",()=>{r=new THREE.Vector3;_=new THREE.Quaternion});return function(e,t,i){const n=e.magnet_id||e.name;let o=s[n];if(!o){o=s[n]={};for(const a of["左","右"])o[a]={vector:new THREE.Vector3,f:new System._browser.data_filter([{type:"one_euro",id:"magnet_vector",para:[30,.5,.5,1,4]}])}}o=o[t];_.setFromUnitVectors(r.set(0,0,1),i);_.fromArray(o.f.filter(_.toArray()));return o.vector.set(0,0,1).applyQuaternion(_)}})();const n={};function o(e){if(!e.keep_validation_state_until_reset)return null;const t=e.magnet_id||e.name;let i=n[t];if(!i){i=n[t]={}}return i}function H(e,t){const i=o(e);return i?i[t]!==false:true}function B(e,t,i){const n=o(e);if(n)n[t]=i}const O=(()=>{const s={};return function(e,t,i){if(!e.use_reference_point_filter)return i;const n=e.magnet_id||e.name;let o=s[n];if(!o){o=s[n]={};for(const a of["左","右"])o[a]=new System._browser.data_filter([{type:"one_euro",id:"reference_point_filter",para:[30,.5,.5,1,3]}])}o=o[t];return i.fromArray(o.filter(i.toArray()))}})();const q=(()=>{const o={};window.addEventListener("jThree_ready",()=>{for(const e of["左","右"]){o["_"+e+"_"]={};o[e]={f:new System._browser.data_filter([{type:"one_euro",id:"magnet_offset_rot",para:[30,1,1,1,4]}])}}});return function(e,t){const i=o[t?e:"_"+e+"_"];if(i.timestamp!=RAF_timestamp){const n=K.get_bone_rotation_by_MMD_name(e+"手首",true);i.rot=t?n.fromArray(i.f.filter(n.toArray())):n}i.timestamp=RAF_timestamp;return i.rot}})();function X(e,t,i,n){const o=i.x;const a=i.y;const s=i.z;const r=e.x;const _=e.y;const l=e.z;const c=t.x-r;const d=t.y-_;const p=t.z-l;let m=c*c+d*d+p*p;let u=2*(r*c+_*d+l*p-c*o-d*a-p*s);let f=r*r-2*r*o+o*o+_*_-2*_*a+a*a+l*l-2*l*s+s*s-n*n;let h=u*u-4*m*f;let M=(-u-Math.sqrt(h))/(2*m);const g=[e.x*(1-M)+M*t.x,e.y*(1-M)+M*t.y,e.z*(1-M)+M*t.z];let y=(-u+Math.sqrt(h))/(2*m);const b=[e.x*(1-y)+y*t.x,e.y*(1-y)+y*t.y,e.z*(1-y)+y*t.z];if(h<0||M>1||y>1){return[]}else if(h==0){return[g]}else{return[g,b]}}let U,K;return function(E,k,i,e){function n(e,t,i,n){if(typeof e=="number")return Je.auto_scale_property(e,E,n);if(/^(\w+)([\+\-])([\d\.])$/.test(e)){const o=Je.auto_scale_property((RegExp.$2=="+"?1:-1)*parseFloat(RegExp.$3),E,n);const a=MMD_SA.TEMP_v3.copy(k);const s=RegExp.$1;if(s=="default"){a.copy(_t._skin[E].pos).sub(E.indexOf("腕")!=-1?MMD_SA_options.model_para_obj.arm_IK_offset[x]:MMD_SA_options.model_para_obj.leg_IK_offset[x]).applyQuaternion(_t._skin[E].rot_parent_inv)}else if(s=="elbow"){if(t=="y"){const r=L?.motion_tracking?.arm_tracking?.elbow_lock?.[x=="左"?"left":"right"]?._elbow_y;if(r!=null&&r!=0){a.y=r-MMD_SA.get_bone_position(R,x+"腕",R).y}}}return(a[t]+o)/i}return 0}const x=E.charAt(0);const o=E.indexOf("足")==-1?MMD_SA_options.model_para_obj.left_arm_length:MMD_SA_options.model_para_obj.left_leg_length;const P=x=="左"?"left":"right";U=THREE.MMD.getModels()[0];K=MMD_SA.THREEX.get_model(0);const R=U.mesh;const L=MMD_SA.motion[U.skin._motion_index].para_SA;let t;if(i){for(const c of["x","y","z"]){const d=i[c];if(!d)continue;const r=d.unit_length||o;let t=!MMD_SA.THREEX.enabled&&d.unit_length?d.auto_scale:false;if(d.scale!=null){let e=typeof d.scale?.[P]=="number"&&d.scale[P]||d.scale;k[c]*=1+(e-1)*rt(d.scale)}if(d.add){let e=n(d.add?.[P]||d.add,c,r,t)*r;k[c]+=e*rt(d.add)}if(d.min!=null){let e=n(d.min?.[P]||d.min,c,r,t)*r;k[c]=Math.max(k[c],e*(e<0?1:rt(d.min)))}if(d.max!=null){let e=n(d.max?.[P]||d.max,c,r,t)*r;k[c]=Math.min(k[c],e*(e>0?1:rt(d.max)))}}if(i.rotation)k.applyEuler(MMD_SA.TEMP_v3.copy(i.rotation).multiplyScalar(Math.PI/180));if(i.camera_weight&&E.indexOf("腕")==-1)k.applyQuaternion(MMD_SA.TEMP_q.set(0,0,0,1).slerp(_t._rot_camera,i.camera_weight));const l=i.position_to_rotation;if(l){const p=R.bones_by_name;const m=Oe.set(Math.atan2(k.z,k.y),0,-Math.atan2(k.x,k.z));const u={upper:{q:Xe},lower:{q:Ue}};for(const v of["upper","lower"]){const w=x+(v=="upper"?"足":"ひざ");const S=p[w];u[v].name=w;u[v].q.copy(S.quaternion);S.quaternion.set(0,0,0,1);if(!l[v])continue;const A=qe.set(0,0,0);for(const c of["x","y","z"]){const d=l[v][c];if(!d)continue;let e=0;const D=d.rot_formula?.[P]||d.rot_formula;if(D?.length==1){e=m[D]*180/Math.PI}if(d.add)e+=d.add?.[P]||d.add;if(d.scale!=null)e*=typeof d.scale?.[P]=="number"&&d.scale[P]||d.scale;if(d.curve){const I=d.curve?.[P]||d.curve;const z=(e-I.ini)/(I.end-I.ini);if(z>0&&z<1)e=Math.pow(z,I.pow_factor)*(I.end-I.ini)+I.ini}if(d.min!=null)e=Math.max(e,d.min?.[P]||d.min);if(d.max!=null)e=Math.min(e,d.max?.[P]||d.max);A[c]=e/180*Math.PI}S.quaternion.setFromEuler(A,"XZY");if(v=="upper")t=S.quaternion.clone()}const f=MMD_SA.get_bone_position(R,x+"足","全ての親");const h=MMD_SA.get_bone_position(R,x+"足首","全ての親");const M=Ye.x_flipped?-1:1;const g=Oe.fromArray(p[x+"足"].pmxBone.origin);const y=g.sub(f).negate();const b=f.sub(h);b.x*=M;b.y*=-1;b.z*=-1;b.add(MMD_SA_options.model_para_obj.leg_IK_offset[x]);b.add(y);b.y-=MMD_SA_options.model_para_obj.left_leg_IK[1]+(p["センター"].position.y-p["センター"].pmxBone.origin[1]);k.copy(b);for(const v in u)p[u[v].name].quaternion.copy(u[v].q)}}else{if(e)e(k)}const a=k.length();let s=typeof i?.length?.scale=="number"?i?.length?.scale:i?.length?.scale?.[P]||1;s=1+(s-1)*rt(i?.length?.scale);k.normalize().multiplyScalar(a*s);let T;i?.magnet?.forEach(i=>{if(i.is_parent){T={name:i.name}}else if(T&&!i.is_parent&&T.name==i.name&&!T.vector){return}const t=i.hand_affected[P];if(!t)return;if(!_t.skin[E]?.[0]._hand_visible)return;let n=MMD_SA._v3a.set(0,0,0);let o;let a=MMD_SA._q1.set(0,0,0,1);let s,r;if(i.type=="object3D"){s=MMD_SA.THREEX._XR_Animator_scene_?.object3D_list.find(e=>e.id==i.id);if(!s)return;r=MMD_SA.THREEX._object3d_list_.find(e=>e.uuid==s._object3d_uuid);n.copy(i.reference_point).multiply(r._mesh.scale);a=MMD_SA._q1.copy(R.quaternion).conjugate().multiply(i.use_default_rotation&&r.user_data._rot_default_||r._mesh.quaternion);n.applyQuaternion(a);o=MMD_SA._v3b.copy(r._mesh.position).sub(R.position).applyQuaternion(MMD_SA.TEMP_q.copy(R.quaternion).conjugate());n.add(o)}else if(i.type=="bone"){let t;i.name.split("|").some(e=>{t=MMD_SA.THREEX.VRM.bone_map_VRM_to_MMD[e]||!MMD_SA.THREEX.enabled&&e;return t});n=K.get_bone_position_by_MMD_name(t,true);if(i.offset){a=K.get_bone_rotation_by_MMD_name(t,true);n.add(MMD_SA._v3a.copy(i.offset).applyQuaternion(a))}}else{n.copy(i.position)}const _=K.get_bone_position_by_MMD_name(E.substring(0,2),true);n.sub(_);let l=1;if(MMD_SA.THREEX.enabled){l=MMD_SA_options.model_para_obj.left_arm_length/K.para.left_arm_length;n.multiplyScalar(l)}let e=MMD_SA._v3a_.set(0,0,0);if(t.offset){if(t.offset=="parent_bone"){pb=MMD_SA.THREEX._object3d_list_.find(e=>e.parent_bone?.name==x+"手首"&&!e.parent_bone.disabled)?.parent_bone;if(pb){e.fromArray(Je.auto_scale_property([pb.position.x,pb.position.y,-pb.position.z],"手首",MMD_SA.THREEX.enabled?false:t.auto_scale))}else{pb=s?.model_para?.parent_bone?.rotation?.align_with_external_point?.external_point?.offset;if(pb){e.fromArray(Je.auto_scale_property([pb.x,pb.y,pb.z],"手首",MMD_SA.THREEX.enabled?false:t.auto_scale));if(!K.is_T_pose)e.applyQuaternion(MMD_SA_options.model_para_obj.rot_arm_adjust[x+"腕"].axis_rot)}}}else{e.copy(t.offset);if(!K.is_T_pose)e.applyQuaternion(MMD_SA_options.model_para_obj.rot_arm_adjust[x+"腕"].axis_rot)}e.applyQuaternion(q(x,t.offset.use_filter))}k.add(e);const c=MMD_SA.THREEX.enabled||i.auto_scale===false?false:.9;let d=0;let p;if(i.magnet_type=="line"){const m=MMD_SA.THREEX.l1;m.start.copy(n);if(i.type=="object3D"){if(i.line_end){m.end.copy(i.line_end).multiply(r._mesh.scale).applyQuaternion(a);m.end.add(o)}else{m.end.copy(o||MMD_SA.TEMP_v3.set(0,0,0))}m.end.sub(_).multiplyScalar(l)}else if(i.type=="bone"){m.end.copy(i.line_end).applyQuaternion(a).multiplyScalar(l).add(n)}if(i.line_offset){const u=MMD_SA.TEMP_v3.copy(i.line_offset).multiply(r._mesh.scale).applyQuaternion(a).multiplyScalar(l);m.start.add(u);m.end.add(u)}m.closestPointToPoint(k,true,n);let e=k.distanceTo(n);let t=Je.auto_scale_property(i.effective_distance,"腕",c);if(e<t){p=Je.auto_scale_property(i.peak_distance||0,"腕",c);if(i.peak_barrier&&e<p){d=1}else{d=1-Math.abs(e-p)/(t-p);const f=(i.power||0)-(1-rt(i))*1;if(f)d=f>-9?Math.pow(d,1-f):0}}}else if(i.magnet_type=="plane"){const h=MMD_SA.TEMP_v3.copy(i.plane_normal);if(!i.plane_normal.absolute)h.applyQuaternion(a);const M=MMD_SA.THREEX.p1.setFromNormalAndCoplanarPoint(h,n);const m=MMD_SA.THREEX.l1;m.start.copy(k);m.end.copy(MMD_SA.TEMP_v3.copy(M.normal).multiplyScalar(999).add(k));let t=M.intersectsLine(m);if(t&&!i.plane_crossable){d=1}else{if(!t)m.end.sub(k).negate().add(k);const y=Math.abs(M.distanceToPoint(k));let e=Je.auto_scale_property(i.effective_distance,"腕",c);if(y<e){p=Je.auto_scale_property(i.peak_distance||0,"腕",c);d=1-Math.abs(y-p)/(e-p);const f=(i.power||0)-(1-rt(i))*1;if(f)d=f>-9?Math.pow(d,1-f):0}}const g=MMD_SA.THREEX.v1;M.intersectLine(m,g);n.copy(g)}else{const y=k.distanceTo(n);let e=Je.auto_scale_property(i.radius,"腕",c);if(y<e){p=Je.auto_scale_property(i.peak_radius||0,"腕",c);if(i.peak_barrier&&y<p){d=1}else{d=1-Math.abs(y-p)/(e-p);const f=(i.power||0)-(1-rt(i))*1;if(f)d=f>-9?Math.pow(d,1-f):0}}}if(d){if(p){const b=T&&!i.is_parent&&T.name==i.name?qe.copy(T.vector):qe.copy(k).sub(n).normalize();if(i.z_push){if(d==1){const v=H(i,x)&&(i.z_push.rotation_base?i.z_push.rotation_base===true?a:K.get_bone_rotation_by_MMD_name(i.z_push.rotation_base,true):null);if(i.z_push.validate?i.z_push.validate(k,b,v):(v?b.dot(MMD_SA.TEMP_v3.set(0,0,1).applyQuaternion(v)):b.z)>-0){_dir=Oe.set(0,0,999);if(v)_dir.applyQuaternion(v);linePoint0=MMD_SA._v3b_.copy(k).add(_dir);linePoint1=_dir.negate().add(k);const w=n;const S=p;let e=X(linePoint0,linePoint1,w,S).sort((e,t)=>t[2]-e[2]);n.fromArray(e[0]);const A=_t.skin[x+"手首"]?.[0].rot;if(A){const D=MMD_SA.TEMP_v3.set(1,0,0);if(v)D.applyQuaternion(v);D.applyQuaternion(A);_dir.set(0,0,1);if(v)_dir.applyQuaternion(v);n.add(_dir.multiplyScalar(t.offset.z*Math.abs(D.z)))}i.on_hit&&i.on_hit(i,x)}else{d=0}B(i,x,!!d)}else{d=0;B(i,x,null)}}else{let e;if(i.is_parent||i.use_vector_filter){e=C(i,x,b);b.copy(e)}n.add(b.multiplyScalar(p));if(i.is_parent){T.vector=e;d=0}if(d){i.on_hit&&i.on_hit(i,x)}}}k.add(O(i,x,MMD_SA.TEMP_v3.set(0,0,0).lerp(n.sub(k),d)))}else{O(i,x,MMD_SA.TEMP_v3.set(0,0,0));B(i,x,null)}i._frame_count_=EV_sync_update.count_frame;i._weight_=d;k.sub(e)});let r=k.length();for(const j of["max","min"]){const F="length_"+j;let e,t=o;if(i?.[F]||i?.length){if(typeof i[F]=="number"){e=i[F]}else{e=i.length[j];if(e==null)continue;if(typeof e!="number"){e=e[P];if(e==null)continue}if(i.length.unit_length)t=i.length.unit_length}}else{continue}if(j=="max"){if(r>t*e)r=t*e}else{if(r<t*e)r=t*e}}if(r!=a)k.normalize().multiplyScalar(r);const _=[k];if(t)_.push(t);return _}})();var zt=(()=>{let E={};window.addEventListener("jThree_ready",()=>{for(const e of["左","右"]){E[e]=new System._browser.data_filter([{type:"one_euro",id:"hand_rot_filter",para:[30,1,1,1,4]}])}});const k={"左":{},"右":{}};return function(e,t){var i=THREE.MMD.getModels()[e._model_index];const n=MMD_SA.THREEX.get_model(e._model_index);var o=n.is_T_pose;const a=e.bones_by_name[t];const s=t.charAt(0);const r=s=="左"?"left":"right";var _,l,c,d;var p=e.bones_by_name[s+"手捩"];var m;var u=this.skin[t];var f=Math.max(Math.min(u[0].t_delta/u[0].t_delta_frame,1),0);const h=MMD_SA.motion[i.skin._motion_index].para_SA;l=Xe.set(0,0,0,1);if(p){if(p.quaternion.x||p.quaternion.y||p.quaternion.z){p.quaternion.conjugate();i._update_IK_and_AddTrans(false,s+"手捩")}p.quaternion.set(0,0,0,1)}const M=s=="左"?1:-1;var g=u[0].rot_parent;if(!g){g=MMD_SA.get_bone_rotation(e,"上半身2",null,e);g.premultiply(Ue.copy(this._rot_body_offset).multiply(this._rot_camera).conjugate());g.multiply(MMD_SA.get_bone_rotation_parent(e,s+"手首","上半身2")).conjugate()}u[0]._rot_parent=g;const y=u[0].no_blending?Ce.copy(u[0].rot):Ce.copy(u[1].rot).slerp(u[0].rot,f);if(u[0]._rot_pose&&u[0]._rot_pose_ratio){let t=u[0]._rot_pose_ratio;if(u[0]._rot_pose_ratio_by_angle_difference){let e=MMD_SA.TEMP_q.copy(y).conjugate().multiply(u[0]._rot_pose).toAxisAngle()[1]%(Math.PI*2);if(e>Math.PI){e-=Math.PI*2}else if(e<-Math.PI){e+=Math.PI*2}const v=Math.pow(1-Math.abs(e)/Math.PI,1-u[0]._rot_pose_ratio_by_angle_difference);t*=v}if(u[0]._rot_pose_offset){y.multiply(u[0]._rot_pose)}else if(u[0]._rot_pose_constrained){const w=nt.setEulerFromQuaternion(y,"YXZ");const S=Be.setEulerFromQuaternion(u[0]._rot_pose,"YXZ");let e=Math.abs(w.y-S.y);if(e>Math.PI)e=Math.PI*2-e;if(e>Math.PI*2/3&&Math.abs(w.x)<Math.PI/3&&Math.abs(w.z)<Math.PI/3){y.setFromEuler(MMD_SA.TEMP_v3.copy(w).setY(0),"YXZ").slerp(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(S).setY(0),"YXZ"),t);let e=u[0]._rot_pose_constrained==1?S.y+(w.y>S.y?Math.PI*2:0)-w.y:-(w.y+(w.y<S.y?Math.PI*2:0)-S.y);y.premultiply(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0,w.y+e*t,0),"YXZ"));_rot_hand=y}else{y.slerp(u[0]._rot_pose,t)}}else{y.slerp(u[0]._rot_pose,t)}}l.multiply(y);if(tt.wrist_enabled||!Ye.VMC_receiver.wrist_pose_relative){if(u[0]._rot_pose_ratio==1){u[0]._rot_base=(u[0]._rot_base||new THREE.Quaternion).copy(l).multiply(He[M])}l.multiplyQuaternions(g,l).multiply(He[M])}const b=h.motion_tracking?.hand_tracking?.rotation_offset?.[r];if(b){const A=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(b).multiplyScalar(Math.PI/180));if(!o)l.fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(s+"手首",l.toArray()));l.multiply(A);if(!o)l.fromArray(MMD_SA.THREEX.utils.convert_T_pose_rotation_to_A_pose(s+"手首",l.toArray()))}if(tt.wrist_enabled&&u[0]._rot_pose_ratio!=1){l.fromArray(E[s].filter(l.toArray()))}a.quaternion.copy(l);if(p&&tt.wrist_enabled&&this.skin[s+"手捩"]){c=!MMD_SA.THREEX.enabled?p.pmxBone.fixedAxis:n.para.lower_arm_fixedAxis[s];if(c){c=MMD_SA._v3a.fromArray(c);if(!o)l.fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(s+"手首",l.toArray()));let t=nt.setEulerFromQuaternion(l,"YZX").x*-M;const D=k[s];if(D.angle!=null&&D.timestamp>RAF_timestamp-250&&Math.abs(t-D.angle)>Math.PI){let e=t+Math.PI*2*(t>0?-1:1);if(Math.abs(e)<Math.PI*(Math.sign(e)==M?1.5:1))t=e}D.angle=t;D.timestamp=RAF_timestamp;d=-t*.5;m=Ue.setFromAxisAngle(c,d);this.skin[s+"手捩"][0].rot.copy(m);a.quaternion.multiplyQuaternions(m.conjugate(),a.quaternion)}}if(lt.active){lt.set_boneKey(t,null,a.quaternion,true);if(!Je.IK_disabled_check(s+"腕ＩＫ")){lt.set_boneKey(s+"腕",null,e.bones_by_name[s+"腕"].quaternion,false);lt.set_boneKey(s+"ひじ",null,e.bones_by_name[s+"ひじ"].quaternion,false)}}}})();var jt=(()=>{const q={};const X={};window.addEventListener("jThree_ready",()=>{for(const e of["左","右"]){q[e]=new System._browser.data_filter([{type:"one_euro",id:"armIK",para:[30,1,1/5,1,3]}]);X[e]=new System._browser.data_filter([{type:"one_euro",id:"pos0_offset",para:[30,1,1,1,3]}])}});return function(i,e){if(Je.IK_disabled_check(e))return;let t=i.bones_by_name[e];let n=this.skin[e];let o=Math.max(Math.min(n[0].t_delta/n[0].t_delta_frame,1),0);let a=nt.copy(n[1].pos).lerp(n[0].pos,o);const s=e.charAt(0);const r=MMD_SA.MMD.motionManager.para_SA;const L=s=="左"?"left":"right";let _=r?.motion_tracking?.arm_tracking?.transformation;let l=_?.position?.magnet;const c=MMD_SA_options.model_para_obj.colliders_for_hands;const d=c.left_hand.children[0].offset;const p=.5;const C={left:{offset:{x:d[0]*p,y:d[1]*p,z:d[2]*p}},right:{offset:{x:-d[0]*p,y:d[1]*p,z:d[2]*p}}};let m;if(Je.body_collider.active){m=[];m=m.concat(c.head?.generate_colliders()||[]);m=m.concat(c.chest?.generate_colliders()||[]);m=m.concat(c.waist?.generate_colliders()||[]);m=m.concat(c.hip?.generate_colliders()||[])}if(!_&&m)_={position:{}};if(_&&m){if(!_.position)_.position={};_.position.magnet=m.concat(l||[])}const u=MMD_SA.get_bone_rotation_parent(i,e,i);let f=!n[0]._IK_absolute?this.offset_upper_body_camera_rotation(Xe.copy(u).conjugate(),r?.motion_tracking?.arm_tracking?.transformation?.position?.camera_weight||1):null;let h=ut.set(0,0,0,1);if(_){const v=_.position;It(s+"腕ＩＫ",a,v);let t=_.root_rotation?.[L];if(t){const w=s+"腕";h.setFromEuler(MMD_SA.TEMP_v3.set(t.x,t.y,t.z).multiplyScalar(Math.PI/180),t.order);let e=We[w];h.premultiply(e.axis_rot).multiply(e.axis_rot_inv);i.bones_by_name[w].quaternion.multiply(h)}if(_.position)_.position.magnet=l}if(n[0].data_filter||n[1].data_filter){a.fromArray(q[s].filter(a.toArray()))}if(f)a.applyQuaternion(f);const M=Je._arm_IK_adjust?.[s];if(M){const S=MMD_SA_options.model_para_obj.left_arm_length;const A=["x","y","z"];if(M.add){if(typeof M.min=="number"){}else{for(const b of A){if(M.add[b]!=null){a[b]+=M.add[b]*S}}}}if(M.min){if(typeof M.min=="number"){}else{for(const b of A){if(M.min[b]!=null){if(a[b]<M.min[b]*S)a[b]=M.min[b]*S}}}}if(M.scale){if(typeof M.scale=="number"){}else{for(const b of A){if(M.scale[b]){a.multiplyScalar(M.scale[b])}}}}}const g=this.skin[s+"腕"];const y=r.motion_tracking_upper_body_only?1-_t.get_blend_default_motion("skin",e):1;if(g?.[0]._elbow0&&n[0]._pos0&&y){const D=MMD_SA.TEMP_v3.copy(n[1]._pos0).lerp(n[0]._pos0,o);if(f)D.applyQuaternion(f);const E=Be.copy(a).sub(D).multiplyScalar(y);E.fromArray(X[s].filter(E.toArray()));const k=pt.set(0,0,0,1);const x=_t.skin[s+"肩"];if(x){let e=Math.max(Math.min(x[0].t_delta/x[0].t_delta_frame,1),0);k.premultiply(MMD_SA.TEMP_q.copy(x[1].rot).slerp(x[0].rot,e).conjugate())}if(MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only)k.premultiply(ft);k.multiply(h);const P=Oe.copy(g[0]._elbow0);const R=qe.copy(g[0]._elbow0);if(f){P.applyQuaternion(f);R.applyQuaternion(f)}P.add(E.multiplyScalar(.5)).normalize();R.normalize();if(f){const z=MMD_SA.TEMP_q.copy(f).conjugate();P.applyQuaternion(z);R.applyQuaternion(z)}P.applyQuaternion(k);R.applyQuaternion(k);const T=mt.setFromUnitVectors(R,P);const I=We[s+"腕"];T.premultiply(I.axis_rot).multiply(I.axis_rot_inv);i.bones_by_name[s+"腕"].quaternion.multiply(T)}var H=Be.fromArray(i.bones_by_name[s+"腕"].pmxBone.origin).sub(Oe.fromArray(t.parent.pmxBone.origin));var B=MMD_SA.get_bone_position(i,s+"腕",t.parent.name).sub(H);a.add(B);const b=this.arm_IK_constraint[s];if(b.enabled){arm0=MMD_SA.get_bone_position(i,s+"腕",i);const j=Be.copy(a).applyQuaternion(u).add(b.arm_pos);const F=Oe.copy(b.target).sub(j);if(!b.target_radius||F.length()>b.target_radius){const O=j.sub(b.target).add(F.normalize().multiplyScalar(b.target_radius));a.sub(O.applyQuaternion(u.conjugate()))}}a.add(MMD_SA_options.model_para_obj.arm_IK_offset[s]);t.position.copy(a)}})();function Ft(i){const n=i=="left"?"左":"右";let o;MMD_SA.THREEX._object3d_list_?.some(e=>{const t=e.parent_bone?.attached&&e.parent_bone.name==n+"手首"&&(e.parent_bone.motion_tracking||e.parent_bone.rotation?.align_with_external_point?.transfer_to_parent_bone)?.hand_tracking?.rotation_reference?.[i];if(t){o=t;return true}});return o}function I(e){async function t(){var e=Je.enabled&&Je.worker_initialized&&F&&!Je.busy&&C&&Je.camera_video_timestamp!=F;if(!e)return;dt=RAF_timestamp;Je.camera_video_timestamp=F;Je.camera_video_frame_id=L;if(Je.use_holistic){Ze.camera_video_timestamp=F;Ze.camera_video_frame_id=L}if(Je.use_holistic&&Ze.blink_detection){MMD_SA_options.auto_blink=Ze.auto_blink||false}let t,i,n;t=Ye.video_canvas;i=t.width;n=t.height;let o=self.PoseAT?t:H?await createImageBitmap(t):t.getContext("2d").getImageData(0,0,i,n).data.buffer;let a=et.get_options();let s=Je.pose_enabled||a?.enabled||Ze.enabled;let r=s&&!Je.use_holistic&&(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only||tt.constrain_tracking_region);Je._timestamp=Ye.video_timestamp_absolute;let _={rgba:o,w:i,h:n,options:{video_flipped:Ye.video_flipped,pose_enabled:s,object_detection:a,use_canvas_hands:r,use_holistic:Je.use_holistic,use_holistic_landmarker:Je.use_holistic_landmarker,use_holistic_legacy:Je.use_holistic_legacy,use_posenet:true,use_handpose:tt.enabled,use_hands_worker:tt.use_hands_worker,skip_hand_countdown_max:Je.skip_hand_countdown_max,model_quality:MMD_SA_options.user_camera.ML_models.pose.model_quality||"",z_depth_scale:MMD_SA_options.user_camera.ML_models.pose.z_depth_scale,timestamp:Je._timestamp}};Object.assign(_.options,MMD_SA.MMD.motionManager.para_SA.motion_tracking?.hand_tracking?.mocap_options);let l=[_.rgba];if(!Je.canvas_hands){const c=Je.canvas_hands=document.createElement("canvas");c.width=c.height=768;_.canvas_hands=c.transferControlToOffscreen();l.push(_.canvas_hands)}if(tt.use_hands_worker&&!tt.canvas_hands_worker){const c=tt.canvas_hands_worker=document.createElement("canvas");c.width=c.height=768;_.canvas_hands_worker=c.transferControlToOffscreen();l.push(_.canvas_hands_worker)}U.postMessage(_,l);l.length=0;l=undefined;_.rgba=o=undefined;_=undefined}if(e||self.PoseAT){setTimeout(()=>{t()},0)}else{t()}}var D=function(){const _=()=>{};var l,c;var Ee={};var ke={},xe={},Pe={};var Re={};var Te,Ie;window.addEventListener("jThree_ready",e=>{l=new THREE.Vector3;c=new THREE.Quaternion;for(const t of["センター","上半身","上半身2","首","頭"]){Ee[t]=new THREE.Quaternion}for(const i of["左","右"]){Re[i]={target:new THREE.Vector3,arm_pos:new THREE.Vector3};ke[i]={target:new THREE.Vector3,effector:new THREE.Quaternion,links:[]};xe[i]={effector:new THREE.Quaternion,links:[]};Pe[i]={effector:new THREE.Quaternion,parent:new THREE.Quaternion,links:[]};for(let e=0;e<2;e++){ke[i].links[e]=new THREE.Quaternion;xe[i].links[e]=new THREE.Quaternion;Pe[i].links[e]=new THREE.Quaternion}}Te=new System._browser.data_filter([{type:"one_euro",id:"hip_rot",para:[30,1,.2,.2,4]}]);Ie=new System._browser.data_filter([{type:"one_euro",id:"hip_mov",para:[30,1,.2,.2,3]}])});let r=250;let d=500;let p=0;function e(e,t,i){if(!this[e][t])return 0;const n=this[e][t][0];let o;if(n._blend_default_motion>0){o=Math.min((RAF_timestamp-n._blend_default_motion)/(d*Je.limb_return_duration_percent/100),1)}else if(n._blend_default_motion<0){o=1-Math.min((RAF_timestamp+n._blend_default_motion)/(r*Je.limb_entry_duration_percent/100),1)}else{o=0}if(o==0){this[e][t].forEach(e=>{if(e._blend_default_motion!=null)e._blend_default_motion=0})}else if(i){o=o<.5?(1-Math.cos(o*Math.PI))*.5:.5+Math.sin((o-.5)*Math.PI)*.5}return o}function t(e,t,i,n){if(!this[e][t]){if(!i)return;const o=t.indexOf("ＩＫ")!=-1;const a={_blend_default_motion:i?1:0};if(o)a.pos=new THREE.Vector3;else a.rot=new THREE.Quaternion;this.add("skin",t,a)}else{const s=this[e][t][1];if(i){if(this.reset_to_default_motion_once||s._blend_default_motion==null){s._idle_blend_default_motion=0;s._blend_default_motion=1}else if(s._blend_default_motion==0){if(!s._idle_blend_default_motion)s._idle_blend_default_motion=RAF_timestamp;if(RAF_timestamp-s._idle_blend_default_motion>=(typeof n=="number"?n:p)){s._idle_blend_default_motion=0;s._blend_default_motion=RAF_timestamp-RAF_timestamp_delta}}else if(s._blend_default_motion<0){s._blend_default_motion=RAF_timestamp-this.get_blend_default_motion(e,t)*(d*Je.limb_return_duration_percent/100)}}else{s._idle_blend_default_motion=0;if(s._blend_default_motion>0){s._blend_default_motion=-(RAF_timestamp-(1-this.get_blend_default_motion(e,t))*(r*Je.limb_entry_duration_percent/100))}}this[e][t][0]._blend_default_motion=s._blend_default_motion;this[e][t][0]._idle_blend_default_motion=s._idle_blend_default_motion}if(!this["_"+e][t])this["_"+e][t]={pos:new THREE.Vector3,rot:new THREE.Quaternion}}const i=new RegExp("("+toRegExp(["腕"],"|")+")$");const g={};function ze(i,n){const e=THREE.MMD.getModels()[i._model_index];const o=MMD_SA.motion[e.skin._motion_index].para_SA;let t;const a=i.bones_by_name;const s=a[n];const r=this.skin[n];if(r[0].info[1]=="facemesh"){}let _,l;r[0].t_delta+=RAF_timestamp_delta;let c=Math.max(Math.min(r[0].t_delta/r[0].t_delta_frame,1),0);if(r[0].rot){if(r[0].after_IK){t=!s._update_IK_and_AddTrans||s._update_IK_and_AddTrans.length;if(t){if(s.quaternion.x||s.quaternion.y||s.quaternion.z){s.quaternion.conjugate();e._update_IK_and_AddTrans(false,n);s.quaternion.conjugate()}}}if(r[0].onProcessRotation){r[0].onProcessRotation.call(this,i,n)}else{let t=Xe.set(0,0,0,1);if(r[0].absolute){s.quaternion.set(0,0,0,1)}else{let e;if(o.motion_tracking_upper_body_only){if(n.indexOf("上半身")!=-1){e=o.motion_tracking?.motion_default_weight?.upper_body}else if(n.indexOf("肩")!=-1){e=o.motion_tracking?.motion_default_weight?.shoulder}}if(e==null)e=1;if(e<1)s.quaternion.slerp(MMD_SA.TEMP_q.set(0,0,0,1),1-e)}if(r[0].parent_based){let e=r[0].rot_parent;if(!e){e=MMD_SA.get_bone_rotation_parent(i,n,i).conjugate()}r[0]._rot_parent=e;t.copy(e)}let e;if(r[0].rot_append){t.multiply(r[0].no_blending?MMD_SA.TEMP_q.copy(r[0].rot).multiply(r[0].rot_append):MMD_SA.TEMP_q.copy(r[1].rot).multiply(r[0].rot_append).slerp(Ue.copy(r[0].rot).multiply(r[0].rot_append),c));e=true}else{t.multiply(r[0].no_blending?r[0].rot:MMD_SA.TEMP_q.copy(r[1].rot).slerp(r[0].rot,c))}const p=r[0].ratio_euler;if(p){const u=MMD_SA.TEMP_v3.setEulerFromQuaternion(t,p.order);const f=r[0].ratio<1?r[0].ratio:1;u.x*=p.x*f;u.y*=p.y*f;u.z*=p.z*f;t.setFromEuler(u,p.order)}else if(r[0].ratio<1){t.slerp(Ue.set(0,0,0,1),1-r[0].ratio)}const m=MMD_SA_options.model_para_obj_all[i._model_index].skin_default[n];if(m&&m.rot_scale){if(typeof m.rot_scale=="number")m.rot_scale={x:m.rot_scale,y:m.rot_scale,z:m.rot_scale};t.setFromEuler(MMD_SA.TEMP_v3.setEulerFromQuaternion(t,"YXZ").multiply(m.rot_scale),"YXZ")}if(e){if(!g[n])g[n]={};if(!g[n].rot)g[n].rot=new System._browser.data_filter([{type:"one_euro",id:"bone_filter_rot_"+n,para:[30,2,1,1,4]}]);t.fromArray(g[n].rot.filter(t.toArray()))}s.quaternion.multiply(t);_=lt.active&&!r[0].motion_recorder_disabled&&n.indexOf("ＩＫ")==-1}}if(r[0].pos){if(r[0].onProcessPosition){r[0].onProcessPosition.call(this,i,n)}else{if(r[0].absolute)s.position.set(0,0,0);const h=MMD_SA.TEMP_v3.copy(r[1].pos).lerp(r[0].pos,c);s.position.add(h);l=lt.active&&!r[0].motion_recorder_disabled&&n.indexOf("ＩＫ")==-1}}r[0].onFinish&&r[0].onFinish.call(this,i,n);if(_||l){lt.set_boneKey(n,l?nt.copy(s.position).sub(Be.fromArray(n=="センター"?MMD_SA.THREEX.get_model(i._model_index).get_bone_origin_by_MMD_name("センター",true):s.pmxBone.origin)):null,_?s.quaternion:null,true)}let d=(r[0].reset_id!="VMC"||n.indexOf("手首")==-1)&&this.get_blend_default_motion("skin",n,true);if(d){if(r[0].rot&&this._skin[n]?.rot){const M=MMD_SA.TEMP_q.copy(this._skin[n].rot);s.quaternion.slerp(this._skin[n].onProcessRotation&&this._skin[n].onProcessRotation.call(this,i,n,M)||M,d)}if(r[0].pos&&this._skin[n]?.pos){s.position.lerp(this._skin[n].pos,d)}if(lt.active&&!r[0].motion_recorder_disabled){if(n.indexOf("ＩＫ")!=-1)lt.set_boneKey(n,r[0].pos&&s.position,r[0].rot&&s.quaternion,false)}}t&&e._update_IK_and_AddTrans(false,n)}var je=0;function n(e){function o(){if(T)return;T=Ee;for(const e of["センター","上半身","上半身2","首"]){const t=this.skin[e];if(!t){T[e].set(0,0,0,1);continue}if(e=="首"){T[e].copy(t[0]._rot_neck||t[1]._rot_neck||MMD_SA._q1.set(0,0,0,1));T["頭"].copy(t[0]._rot_head||t[1]._rot_head||MMD_SA._q1.set(0,0,0,1))}else{const i=MMD_SA._q1.set(0,0,0,1);const n=Math.max(Math.min((t[0].t_delta+RAF_timestamp_delta)/t[0].t_delta_frame,1),0);i.multiply(t[0].no_blending?t[0].rot:MMD_SA.TEMP_q.copy(t[1].rot).slerp(t[0].rot,n));if(t[0].ratio<1)i.slerp(MMD_SA._q2.set(0,0,0,1),1-t[0].ratio);T[e].copy(i)}}I=ut.copy(T["センター"]).multiply(T["上半身"]).multiply(T["上半身2"]).conjugate()}let L,C,H,k;function B(o){function a(){if(L==RAF_timestamp)return;L=RAF_timestamp;const e=MMD_SA.TEMP_q.copy(this._body_motion_rot[0]["上半身"]).multiply(this._body_motion_rot[0]["上半身2"]);H=1;C=mt.copy(I).conjugate().premultiply(e.conjugate().multiply(pt.copy(this._body_motion_rot[1]["上半身"]).multiply(this._body_motion_rot[1]["上半身2"]))).conjugate();const t=C.toAxisAngle();k=t[1]%(Math.PI*2);if(Math.abs(k)>Math.PI)k-=Math.sign(k)*Math.PI*2;k*=2/3;if(Math.abs(k)>Math.PI/4)k=Math.sign(k)*Math.PI/4}const e=["センター","上半身","上半身2","首","頭"];let n;const s=z&&z.parent;const r=nt.set(0,0,0);if(s){const g=s.name||o+"足";const y=g.charAt(0);const b=1-this.get_blend_default_motion("skin",g.indexOf("足")!=-1?y+"足ＩＫ":g,true);let t,i;switch(g){case"頭":n=b&&this.skin["首"];if(n){for(const g of["首","頭"]){P[g].quaternion.copy(T[g])}t=MMD_SA.get_bone_position(x,"頭","首").add(Be.set(0,.75,.75).applyQuaternion(MMD_SA.TEMP_q.copy(P["首"].quaternion).multiply(P["頭"].quaternion)));P["首"].quaternion.copy(this._body_motion_rot[0]["首"]);P["頭"].quaternion.copy(this._body_motion_rot[0]["頭"]);i=MMD_SA.get_bone_position(x,"頭","首").add(Be.set(0,.75,.75).applyQuaternion(MMD_SA.TEMP_q.copy(P["首"].quaternion).multiply(P["頭"].quaternion)))}break;case"左足":case"右足":n=b;if(n){if(!xe[y].updated){ke[y].enabled=true;n=false}}else{ke[y].enabled=false;xe[y].updated=0}if(n){const v=Be.fromArray(P[o+"ひざ"].pmxBone.origin).sub(Oe.fromArray(P[g].pmxBone.origin));t=Oe.copy(v).applyQuaternion(Xe.copy(Pe[y].parent).multiply(Pe[y].links[1]));i=v.applyQuaternion(Xe.copy(Pe[y].parent).multiply(xe[y].links[1]))}break}if(n){n=g;r.copy(t).sub(i);let e=s.weight||.5;if(typeof e=="object"){r.x*=r.x<0?e.x.left:e.x.right;r.y*=r.y<0?e.y.down:e.y.up;r.z*=r.z<0?e.z.backward:e.z.forward}else{r.multiplyScalar(e)}r.multiplyScalar(b)}}const t=Ye.x_flipped?-1:1;let i,_,l;let c;for(const g of e)P[g].quaternion.copy(this._body_motion_rot[0][g]);const d=R.motion_tracking?.arm_tracking?.elbow_lock?.[o=="左"?"left":"right"];if(d){d._elbow_y=d.y_absolute!=null?d.y_absolute:MMD_SA.get_bone_position(x,o+"ひじ",x).y+(d.y||0)}if(!n||n!="頭"){i=MMD_SA.get_bone_position(x,o+"腕",x);l=MMD_SA.get_bone_rotation_parent(x,o+"腕ＩＫ",x);_=!R.has_arm_IK?MMD_SA.get_bone_position(x,o+"手首",x):(new THREE.Vector3).copy(P[o+"腕ＩＫ"].position).sub(MMD_SA_options.model_para_obj.arm_IK_offset[o]).applyQuaternion(l).add(i);l.conjugate()}for(const g of e)P[g].quaternion.copy(this._body_motion_rot[1][g]);if(!i){i=MMD_SA.get_bone_position(x,o+"腕",x);l=MMD_SA.get_bone_rotation_parent(x,o+"腕ＩＫ",x);_=!R.has_arm_IK?MMD_SA.get_bone_position(x,o+"手首",x):(new THREE.Vector3).copy(P[o+"腕ＩＫ"].position).sub(MMD_SA_options.model_para_obj.arm_IK_offset[o]).applyQuaternion(l).add(i);l.conjugate()}for(const g of["センター","上半身","上半身2"]){let e;if(g.indexOf("上半身")!=-1)e=R.motion_tracking?.motion_default_weight?.upper_body;if(e==null)e=1;if(this.skin[g]){if(e<1)P[g].quaternion.slerp(MMD_SA.TEMP_q.set(0,0,0,1),1-e);P[g].quaternion.multiply(T[g]);if(g=="上半身2"&&this.skin["上半身2"]?.[0].rot_append)P[g].quaternion.multiply(this.skin["上半身2"][0].rot_append)}}let p=z&&z.default_position_weight;if(typeof p!="number")p=.5;const m=MMD_SA.get_bone_rotation_parent(x,o+"腕ＩＫ",x).conjugate();let u;let f=R.motion_tracking?.arm_tracking?.IK_constraint;if(f)f=f[o=="左"?"left":"right"]||f;if(f&&this.skin[o+"腕ＩＫ"]&&this.get_blend_default_motion("skin",o+"腕ＩＫ")<1){const w=Re[o];w.enabled=true;w.target.copy(_);w.target_radius=0;if(f.target_offset){const S=nt.fromArray(f.target_offset);w.target.add(S);w.target_radius=S.length()}if(f.target_radius)w.target_radius+=f.target_radius;u=MMD_SA.get_bone_position(x,o+"腕",x);w.arm_pos.copy(u)}u=p==0?i:(u||MMD_SA.get_bone_position(x,o+"腕",x)).lerp(i,1-p);const h=u.sub(_);if(p<1)m.slerp(l,1-p);h.x*=t;h.y*=-1;h.z*=-1;if(n&&n=="頭"){h.applyQuaternion(m)}else{h.applyQuaternion(m)}if(!this._skin[o+"腕ＩＫ"])this._skin[o+"腕ＩＫ"]={pos:new THREE.Vector3,rot:new THREE.Quaternion};if(!this._skin[o+"腕ＩＫ"].rot_parent_inv)this._skin[o+"腕ＩＫ"].rot_parent_inv=new THREE.Quaternion;this._skin[o+"腕ＩＫ"].rot_parent_inv.copy(m).conjugate();h.add(r);h.add(MMD_SA_options.model_para_obj.arm_IK_offset[o]);for(const g of e)P[g].quaternion.copy(this._body_motion_rot[1][g]);const M=this.skin[o+"手首"];if(M){if(V){M[0].after_IK=true;if(this._skin[o+"手首"])this._skin[o+"手首"]._rot_absolute=MMD_SA.get_bone_rotation(x,o+"手首",false,x)}if(this._skin[o+"手首"])this._skin[o+"手首"].onProcessRotation=O;if(this._skin[o+"手捩"])this._skin[o+"手捩"].onProcessRotation=q}if(this._skin[o+"腕"]){a.call(this);let e=Math.min(p*2,1);let t=Math.abs(k/(Math.PI/4))*e*H;const A=MMD_SA.TEMP_v3.setEulerFromQuaternion(this._skin[o+"腕"].rot_local,"YXZ");A.y+=Math.PI/32;t*=(A.y>0?1:-1)*Math.min(Math.abs(A.y)/(Math.PI/8),1)*(A.y>0?1:.5);const D=o=="左"?1:-1;let i=D*Math.PI/4*t;let n=pt.set(0,Math.sin(i),0,Math.cos(i));const E=We[o+"腕"];n.premultiply(E.axis_rot).multiply(E.axis_rot_inv);this._skin[o+"腕"].rot.premultiply(n)}return h}function O(e,t,i){const n=t.charAt(0);const o=R.motion_tracking&&R.motion_tracking.arm_default_stickiness&&(R.motion_tracking.arm_default_stickiness[n]||R.motion_tracking.arm_default_stickiness).default_rotation_weight;if(!o)return i;const a=MMD_SA.get_bone_rotation_parent(e,t,e).conjugate();const s=a.multiply(this._skin[t]._rot_absolute);return s.slerp(i,1-o)}function q(e,t,i){return i.set(0,0,0,1)}function t(){if(Je.data_detected){Fe();System._browser.on_animation_update.remove(t,0)}}const X=e.detail.model;const U=MMD_SA.THREEX.get_model(X._model_index);const K=U.is_T_pose;const x=X.mesh;const P=x.bones_by_name;const R=MMD_SA.motion[X.skin._motion_index].para_SA;for(const _ of["左","右"]){const W=_=="左"?"left":"right";const i=Ft(W)||R.motion_tracking?.hand_tracking?.rotation_reference?.[W];if(!i)continue;hand_f=_t.skin[_+"手首"]?.[0];if(!hand_f||!hand_f._rot_pose_ratio)continue;let e;if(i.type=="object3D"){const N=MMD_SA.THREEX._XR_Animator_scene_.object3D_list.find(e=>e.id==i.name);if(!N)return;const n=MMD_SA.THREEX._object3d_list_.find(e=>e.uuid==N._object3d_uuid);if(n._rot_aligned_&&n.parent_bone.name==_+"手首"){e=MMD_SA._q2.copy(n._rot_aligned_)}else{e=MMD_SA._q2.copy(n._mesh.quaternion)}if(i.offset){if(i.offset=="parent_bone"){const l=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(-n.parent_bone.rotation.x,-n.parent_bone.rotation.y,n.parent_bone.rotation.z).multiplyScalar(Math.PI/180),"YXZ").toAxisAngle();e.multiply(MMD_SA.TEMP_q.setFromAxisAngle(l[0].applyQuaternion(Xe.copy(He[_=="左"?1:-1]).conjugate()),l[1]))}else{if(i.offset.w==null){const c=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(i.offset).multiplyScalar(Math.PI/180),i.offset.order);i.offset.x=c.x;i.offset.y=c.y;i.offset.z=c.z;i.offset.w=c.w}const Y=MMD_SA.TEMP_q.copy(i.offset);e.multiply(Y)}}}else{if(i.rotation){if(i.rotation.w==null){const c=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(i.rotation).multiplyScalar(Math.PI/180));i.rotation.x=c.x;i.rotation.y=c.y;i.rotation.z=c.z;i.rotation.w=c.w}e=MMD_SA.TEMP_q.copy(i.rotation)}else if(i.offset){if(i.offset.w==null){const c=MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(i.offset).multiplyScalar(Math.PI/180),i.offset.order);i.offset.x=c.x;i.offset.y=c.y;i.offset.z=c.z;i.offset.w=c.w}e=MMD_SA.TEMP_q.copy(i.offset);hand_f._rot_pose_offset=true}}if(!hand_f._rot_pose)hand_f._rot_pose=new THREE.Quaternion;if(e){hand_f._rot_pose.copy(e)}else{hand_f._rot_pose.set(0,0,0,1)}}if((Je.pose_enabled||Ye.VMC_receiver.pose_enabled)&&!this._reset_disabled&&this._motion_path&&(this._motion_path!=R._path||this._motion_tracking_upper_body_only!=!!R.motion_tracking_upper_body_only)){this._motion_path=R._path;this._motion_tracking_upper_body_only=!!R.motion_tracking_upper_body_only;this.reset();for(const _ of["左","右"])Je.enable_IK(_+"腕ＩＫ",false);if(Je.pose_enabled){Le();Je.data_detected=0;Je.initial_data_detected=false;System._browser.on_animation_update.remove(t,0);System._browser.on_animation_update.add(t,0,0,-1)}return}this._motion_path=R._path;this._motion_tracking_upper_body_only=!!R.motion_tracking_upper_body_only;if(lt.enabled&&(!Je.enabled&&Ze.enabled||je!=Je.data_detected)){if(Je.enabled){je=Je.data_detected;lt.timestamp_for_recording=RAF_timestamp}else{lt.timestamp_for_recording=0}if(lt.active)window.dispatchEvent(new CustomEvent("SA_motion_recorder_on_active",e))}for(const _ of["左","右"]){this.arm_IK_constraint[_].enabled=false}ft.copy(this.get_upper_body_rotation()).multiply(this._rot_body_camera_offset);this.upper_body_rotation_limiter(ft);if(1&&R.motion_tracking_upper_body_only){for(const _ of["左","右"]){if(_t._skin[_+"腕"]){_t._skin[_+"腕"].pos_local=MMD_SA.get_bone_position(x,_+"腕",x);_t._skin[_+"腕"].rot_local=MMD_SA.get_bone_rotation(x,_+"腕",x)}}}let T,I,z,V;let G;let a,s;if(1){Je.hip_adjustment_set=MMD_SA.MMD.motionManager.filename;let t=Je.hip_adjustment_weight_percent/100;if(!R.motion_tracking_upper_body_only){const Z=Je.pose_enabled?Je._upper_body_only_mode:Ye.VMC_receiver.pose_upper_body;const $=at("hip_adjustment",Z?1:0,!!Z);t=t*$+t*Je.hip_adjustment_full_body_weighting_percent/100*(1-$)}G=t&&(Je.data_detected||!Je.enabled&&Ze.data_detected||Ye.VMC_receiver.mocap_enabled);if(G){o.call(this);const J=this.skin["上半身2"]?.[0].rot_append;const d=Xe.copy(I);const p=R.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(p.upper_rotation_offset){const te=p.upper_rotation_offset*Math.PI/180;d.premultiply(MMD_SA.TEMP_q.set(0,Math.sin(te/2),0,Math.cos(te/2)))}d.conjugate();const ee=R.motion_tracking?.hip_adjustment?.rotation_weight;const l=d.toAxisAngle();a=(new THREE.Quaternion).setFromAxisAngle(l[0],l[1]*((typeof ee=="number"?ee:.5)*t)*Je.hip_adjustment_rotation_percent/100);let n=Je.hip_adjustment_smoothing_percent/100;if(n)n=.1+(1-n)*(1-n)*.9;if(n){Te.filters[0].filter.minCutOff=n;a.fromArray(Te.filter(a.toArray()))}if(R.motion_tracking_upper_body_only){this.remove("skin","下半身");this.add("skin","下半身",{no_blending:true,rot:a})}if(this.skin["センター"]){let e=R.motion_tracking?.hip_adjustment?.displacement_weight;if(e==null)e=.25;const m=nt;const u=Be;if(typeof e=="number"){if(e){e*=t;m.set(0,MMD_SA_options.model_para_obj.left_leg_length/3*e,0);u.set(-1,1,-1)}}else{m.copy(e.axis||MMD_SA.TEMP_v3.set(0,e.weight,0)).multiplyScalar(MMD_SA_options.model_para_obj.left_leg_length/3*t);u.copy(e.scale)}u.x*=Je.hip_adjustment_scale_x_percent/100;u.y*=Je.hip_adjustment_scale_y_percent/100;u.z*=Je.hip_adjustment_scale_z_percent/100;const ie=Je.hip_adjustment_adjust_y_axis_percent/100;if(ie&&!e.axis){const ne=Math.PI/4*ie;const oe=m.y;m.y=oe*Math.cos(ne);m.z=oe*Math.sin(ne)}if(e){axis_default=Oe.copy(m);let e=MMD_SA.TEMP_q.copy(T["首"]);if(J)e.premultiply(MMD_SA._q1.set(0,0,0,1).slerp(J,.5));let t=MMD_SA.TEMP_v3.setEulerFromQuaternion(e,"YZX");t.x*=Je.hip_adjustment_head_pitch_rotation_percent/100;d.multiply(MMD_SA.TEMP_q.set(0,0,0,1).slerp(MMD_SA._q1.setFromEuler(t,"YZX"),Je.hip_adjustment_head_weight_percent/100));m.applyQuaternion(d);m.sub(axis_default).multiply(u);if(n){Ie.filters[0].filter.minCutOff=n;m.fromArray(Ie.filter(m.toArray()))}const ae=MMD_SA_options.model_para_obj.left_leg_length*.1;if(m.y>0)m.y=Math.pow(Math.min(m.y/(ae*4),1),.5)*ae;let i=R.motion_tracking?.hip_adjustment?.knee_fixed_weight;if(i){const f=new THREE.Vector3;for(const _ of["左","右"]){const h=MMD_SA.get_bone_position(x,_+"ひざ","全ての親");const se=Ce.copy(P["下半身"].quaternion);const re=MMD_SA.get_bone_position(x,_+"足","全ての親");P["下半身"].quaternion.multiply(a);P["センター"].position.add(m);const _e=MMD_SA.get_bone_position(x,_+"足","全ての親");const M=Oe.copy(h).sub(re);const le=M.length();M.normalize();const g=qe.copy(h).sub(_e);const ce=g.length();g.normalize();const de=MMD_SA._q1.copy(P["センター"].quaternion).multiply(se).conjugate();const pe=MMD_SA._v3a.copy(M).applyQuaternion(de);const me=MMD_SA._q2.copy(P["センター"].quaternion).multiply(T["センター"]).multiply(P["下半身"].quaternion).conjugate();const ue=MMD_SA._v3b.copy(g).applyQuaternion(me);const fe=MMD_SA.TEMP_q.setFromUnitVectors(pe,ue);if(i<1)fe.slerp(pt.set(0,0,0,1),i);P[_+"足"].quaternion.multiply(fe);const he=g.multiplyScalar(le).sub(h).negate();he.sub(_e);f.add(he);P["下半身"].quaternion.multiply(MMD_SA.TEMP_q.copy(a).conjugate());P["センター"].position.sub(m)}f.multiplyScalar(.5*i);m.add(f)}this.skin["センター"][0].pos=(this.skin["センター"][0].pos||new THREE.Vector3).copy(m);this.skin["センター"][0]._hip_adjustment_offset=(this.skin["センター"][0]._hip_adjustment_offset||new THREE.Vector3).copy(m);this.skin["センター"][1].pos=this.skin["センター"][1].pos?this.skin["センター"][1].pos.copy(this.skin["センター"][0].pos):this.skin["センター"][0].pos;s=this.skin["センター"][0].pos}}}}if(this.skin["首"]){const Me=new THREE.Quaternion;for(const y of["センター","上半身","上半身2"]){let e;if(y.indexOf("上半身")!=-1)e=R.motion_tracking?.motion_default_weight?.upper_body;if(e==null)e=1;const ge=Xe.copy(P[y].quaternion);if(e<1)ge.slerp(MMD_SA.TEMP_q.set(0,0,0,1),1-e);Me.multiply(ge)}this.skin["首"][0]._upper_body_default_offset=Me}if(1&&R.motion_tracking_upper_body_only&&(Je.pose_enabled||Ze.enabled||Ye.VMC_receiver.mocap_enabled)){const b=R.motion_tracking&&R.motion_tracking.arm_as_leg;const v={"左":b&&b.enabled&&(!b.linked_side||b.linked_side=="left"),"右":b&&b.enabled&&(!b.linked_side||b.linked_side=="right")};for(const y in this._skin){this._skin[y].pos.copy(P[y].position);this._skin[y].rot.copy(P[y].quaternion)}for(const _ of["左","右"]){const w=_=="左"?"left":"right";z=R.motion_tracking&&R.motion_tracking.arm_default_stickiness&&(R.motion_tracking.arm_default_stickiness[w]||R.motion_tracking.arm_default_stickiness);V=z&&z.default_rotation_weight;let i=R.motion_tracking?.hip_adjustment?.[w]?R.motion_tracking.hip_adjustment[w].feet_fixed_weight:R.motion_tracking?.hip_adjustment?.feet_fixed_weight;if(typeof i!="number")i=1;if(i<1||(G||v[_])&&!R.has_leg_IK){const y=_+"足ＩＫ";let e,t;if(a){e=Xe.copy(P["下半身"].quaternion);P["下半身"].quaternion.multiply(a)}if(s){t=nt.copy(P["センター"].position);P["センター"].position.add(s)}const ye=R.has_leg_IK?null:MMD_SA.get_bone_position(x,_+"足","全ての親");const S=i<1?MMD_SA.get_bone_position(x,_+"足首","全ての親"):Be;if(e)P["下半身"].quaternion.copy(e);if(s)P["センター"].position.copy(t);const A=R.has_leg_IK||i>0?MMD_SA.get_bone_position(x,_+"足首","全ての親"):S;const be=Ye.x_flipped?-1:1;if(R.has_leg_IK){const D=nt.copy(A).sub(S.lerp(A,i));D.x*=be;D.y*=-1;D.z*=-1;if(!this._skin[y])this._skin[y]={pos:new THREE.Vector3,rot:new THREE.Quaternion};this._skin[y].pos.add(D);P[y].position.add(D)}else{const ve=nt.fromArray(P[_+"足"].pmxBone.origin);const we=ve.sub(ye).negate();const D=ye.sub(S.lerp(A,i));D.x*=be;D.y*=-1;D.z*=-1;D.add(MMD_SA_options.model_para_obj.leg_IK_offset[_]);D.add(we);if(!this._skin[y])this._skin[y]={pos:new THREE.Vector3,rot:new THREE.Quaternion};this._skin[y].pos.copy(D);if(!v[_]){Je.enable_IK(y,true);if(!this.skin[y])this.add("skin",y,{absolute:true,is_dummy:true,pos:true,priority:999})}else{Je.enable_IK(_+"つま先ＩＫ",false)}P[y].position.copy(D);if(Je.data_detected)P[_+"ひざ"].quaternion.set(0,0,0,1)}P[y].position.y+=this._skin[y]._offset_y_||0}if(v[_]){o.call(this);const D=B.call(this,_);P[_+"腕ＩＫ"].position.copy(D);Je.enable_IK(_+"腕ＩＫ",true)}else{const y=_+"腕ＩＫ";let e;const Se=this.skin[_+"手首"];if(Se){o.call(this);if(!Je.IK_disabled_check(y)){e=B.call(this,_)}else{this._skin[_+"腕"]?.rot?.premultiply(I);this._skin[_+"手首"]?.rot?.premultiply(MMD_SA.TEMP_q.copy(I).conjugate())}}if(e)this._skin[y].pos.copy(e)}if(ke[_].enabled){const Ae=P[_+"足ＩＫ"];const E=ke[_];E.target.copy(Ae.position);const j=Ae.pmxBone.IK;E.effector.copy(x.bones[j.effector].quaternion);for(let e=0;e<j.links.length;e++)E.links[e].copy(x.bones[j.links[e].bone].quaternion);window.addEventListener("SA_IK_"+(_+"足ＩＫ")+"_onupdate",e=>{e.detail.result.links=E;e.detail.result.links_result=xe[_]},{once:true});window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const t=Pe[_];t.parent.copy(MMD_SA.get_bone_rotation_parent(x,_+"足","全ての親"));t.effector.copy(x.bones[j.effector].quaternion);for(let e=0;e<j.links.length;e++)t.links[e].copy(x.bones[j.links[e].bone].quaternion)},{once:true})}}for(let e=0;e<2;e++){const _=e==0?"左":"右";const F=this.skin[_+"肩"];if(F&&this._skin[_+"肩"]){let e=Math.max(Math.min((F[0].t_delta+RAF_timestamp_delta)/F[0].t_delta_frame,1),0);const De=(F[0]._rot_total||0)*e+(F[1]._rot_total||0)*(1-e);this._skin[_+"肩"].rot.premultiply(MMD_SA.TEMP_q.set(0,0,Math.sin(De/2),Math.cos(De/2)))}}const p=R.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(p.upper_rotation_offset){window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const t=e.detail.model;const i=t.mesh.bones_by_name;let n=p.upper_rotation_offset*Math.PI/180;const o=MMD_SA.TEMP_q.set(0,Math.sin(n/2*-.5),0,Math.cos(n/2*-.5));i["上半身"].quaternion.premultiply(o);i["上半身2"].quaternion.premultiply(o);o.set(0,Math.sin(n/2),0,Math.cos(n/2));i["全ての親"].quaternion.premultiply(o);if(lt.active){lt.set_boneKey("上半身",null,i["上半身"].quaternion,false);lt.set_boneKey("上半身2",null,i["上半身2"].quaternion,false);lt.set_boneKey("全ての親",null,i["全ての親"].quaternion,false)}},{once:true})}if(lt.active){window.addEventListener("SA_camera_poseNet_process_bones_onended",e=>{const t=e.detail.model;const a=t.mesh.bones_by_name;for(const o of["左","右"]){lt.set_boneKey(o+"足",null,a[o+"足"].quaternion,false);lt.set_boneKey(o+"ひざ",null,a[o+"ひざ"].quaternion,false);lt.set_boneKey(o+"足首",null,a[o+"足首"].quaternion,false);if(a[o+"足先EX"])lt.set_boneKey(o+"足先EX",null,a[o+"足先EX"].quaternion,false);for(const e of[o+"肩",o+"腕",o+"ひじ",o+"手首"]){if(a[e])lt.set_boneKey(e,null,a[e].quaternion,false)}Ve.forEach((i,e)=>{let n=e==0?0:1;for(let t=n;t<n+3;t++){const e=o+i+"指"+Ge[t];if(a[e]&&!this.skin[e])lt.set_boneKey(e,null,a[e].quaternion,false)}})}},{once:true})}}if(s){if(this.skin["センター"][0]._pos_center)this.skin["センター"][0].pos.add(this.skin["センター"][0]._pos_center);if(this.skin["センター"][1]._pos_center&&this.skin["センター"][0].pos!=this.skin["センター"][1].pos)this.skin["センター"][1].pos.add(this.skin["センター"][1]._pos_center)}if(Je.data_detected)this.reset_to_default_motion_once=false;if(!this._z_max_timestamp)this._z_max_timestamp=RAF_timestamp;for(const y of["左足ＩＫ","右足ＩＫ"]){if(this._skin[y])this._z_max=Math.max(RAF_timestamp>this._z_max_timestamp+1e3?this._z_max||0:0,this._skin[y].pos.z)}window.dispatchEvent(new CustomEvent("SA_camera_poseNet_process_bones_onstart",e));var r=this.skin;var Q=Object.keys(r).filter(e=>!r[e][0].after_IK).sort((e,t)=>{let i=r[e][0].priority||0;let n=r[t][0].priority||0;return i-n});Q.forEach(e=>{let t=P[e];if(!t&&!/_DUMMY_/.test(e))return;var i=r[e][0].info[1];if((!i||/pose/.test(i))&&!R.motion_tracking_enabled)return;ze.call(this,x,e)})}function o(e){var t=e.detail.model;var n=t.mesh;var o=MMD_SA.motion[t.skin._motion_index].para_SA;if(o.motion_tracking_upper_body_only){for(const s of["左","右"]){const r=o.motion_tracking?.arm_tracking?.elbow_lock?.[s=="左"?"left":"right"];if(r){const _=r._elbow_y!=null?r._elbow_y:null;if(_!=null)w(r,n,s)}}}var a=this.skin;var i=Object.keys(a).filter(e=>a[e][0].after_IK).sort((e,t)=>{let i=a[e][0].priority||0;let n=a[t][0].priority||0;return i-n});i.forEach(e=>{let t=n.bones_by_name[e];if(!t&&!/_DUMMY_/.test(e))return;var i=a[e][0].info[1];if((!i||/pose/.test(i))&&!o.motion_tracking_enabled)return;ze.call(this,n,e)});window.dispatchEvent(new CustomEvent("SA_camera_poseNet_process_bones_onended",e))}function a(e){if(!Je.use_head_mocap)return;var _=e.detail.model;var l=_.mesh;var c=_.morph.targets;_.pmx.morphs.forEach(function(e){if(e.panel!=3)return;var t=e.name;if(!_.pmx.morphs_weight_by_name[t])return;var i=_.morph.target_index_by_name[t];if(i==null)return;var n=c[i];var o=n.keys[0];if(o.morph_type==1){l.morphTargetInfluences[i]=0}else{let e={name:t,weight:0,morph_type:o.morph_type,morph_index:o.morph_index};_.morph.onupdate(e,e,0,i)}});var d=MMD_SA_options.model_para_obj.facemesh_morph;var p=this.morph;var m={};var o=0;Object.keys(p).forEach(function(e){let t=p[e];if(t.disabled)return;t[0].t_delta+=RAF_timestamp_delta;let i=Math.max(Math.min(t[0].t_delta/t[0].t_delta_frame,1),0);let n=t[0].weight*i+t[1].weight*(1-i);m[e]=n;if(n)o++});Object.keys(m).forEach(function(t){let e=p[t];let i=m[t];if(i<0){lt.morph_active&&lt.set_morphKey(t,0,true);switch(t){case"にやり":t="ω";break;case"口角上げ":t="口角下げ";break;case"上":t="下";break}i=-i}if(lt.morph_active){let e=t;if(t=="まばたきL")e="ウィンク";else if(t=="まばたきR")e="ウィンク右";lt.set_morphKey(e,i,true)}let n=d[t];let o=n&&n.name||t;let a=_.morph.target_index_by_name[o];if(a==null)return;i*=n&&n.weight||1;let s=c[a];let r=s.keys[0];if(r.morph_type==1){l.morphTargetInfluences[a]=i}else{let e={name:o,weight:i,morph_type:r.morph_type,morph_index:r.morph_index};_.morph.onupdate(e,e,0,a)}})}let m=0;let s=[];function u(e,t,i){function n(){m++}i.name=t;i.info=e.split("|");let o=i.info[0];let a=this[o][t];if(i.is_dummy){if(a&&a[0].is_dummy)return;i.no_blending=true;i.onProcessPosition=i.onProcessRotation=_;if(i.pos)i.pos=l;if(i.rot)i.rot=c}else{if(i.pos){if(isNaN(i.pos.x)||isNaN(i.pos.y)||isNaN(i.pos.z)){n();i.pos.copy(a?.[0].pos||new THREE.Vector3)}}if(i.rot){if(isNaN(i.rot.x)||isNaN(i.rot.y)||isNaN(i.rot.z)||isNaN(i.rot.w)){n();i.rot.copy(a?.[0].rot||new THREE.Quaternion)}}if(i.weight!=null){if(isNaN(i.weight)){n();i.weight=a?.[0].weight||0}}}const s=t.indexOf("指")!=-1||t.indexOf("手首")!=-1;i.timestamp=RAF_timestamp;i.t_delta=0;if(i.t_delta_frame==null)i.t_delta_frame=tt.enabled&&s&&this.t_delta_hands||this.t_delta||0;i.t_delta_frame=Math.max(Math.min(i.t_delta_frame,200),1e3/60);if(Ye.mocap_data_smoothing<2&&t!="両目"){if(Ye.mocap_data_smoothing==1){i.blending_ratio=.75}else{if(t.indexOf("指")!=-1){i.blending_ratio=.75}else{i.blending_ratio=1}}}if(a&&a[0].reset_id&&a[0].reset_id!=i.reset_id){a=null}if(a){const r=RAF_timestamp==a[0].timestamp?1:0;if(!i.no_blending&&!Ye.video?.paused){let e=i._blending_ratio=i.blending_ratio!=null?i.blending_ratio:.5+Math.max(Math.min((Math.max(i.t_delta_frame,(RAF_timestamp-a[r].timestamp)*(lt.speed||1))-50)/150,1),0)*.5;if(i._blending_start)e*=i._blending_start;if(e<1){if(i.pos&&a[r].pos){i.pos.lerp(a[r].pos,1-e)}if(i.rot&&a[r].rot){i.rot.slerp(a[r].rot,1-e)}if(i.weight!=null&&a[r].weight!=null){i.weight=i.weight*e+a[r].weight*(1-e)}}}if(r==1){a[0]=Object.assign(a[0],i)}else{this[o][t]=[i,a[0]]}i._blend_default_motion=a[1]._blend_default_motion;i._idle_blend_default_motion=a[1]._idle_blend_default_motion}else{this[o][t]=[i,i]}if(lt.speed)i.no_blending=true}function f(e,t){delete this[e][t]}function h(){this.skin={};this.morph={};this._skin={};this._morph={};this.reset_to_default_motion_once=true;this._motion_path="";this.reset_timestamp=RAF_timestamp;Je.enable_IK()}function Fe(){Le();window.addEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_before_IK",this.process_bones);window.addEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}function Le(){window.removeEventListener("SA_MMD_model"+this.model_num+"_process_morphs",this.process_morphs);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_before_IK",this.process_bones);window.removeEventListener("SA_MMD_model"+this.model_num+"_process_bones_after_IK",this.process_bones_after_IK)}var M=function(e){this.model_num=e;this.reset();this._body_motion_rot=[{},{}];this._rot_body_motion=new THREE.Quaternion;this._rot_body_camera=new THREE.Quaternion;this._rot_body_camera_offset=new THREE.Quaternion;this._rot_head_camera=new THREE.Quaternion;this._rot_head_camera_offset=new THREE.Quaternion;this._rot_body_offset=new THREE.Quaternion;this._rot_camera=new THREE.Quaternion;this._rot_camera_angle=0;this.process_bones=n.bind(this);this.process_bones_after_IK=o.bind(this);this.process_morphs=a.bind(this)};M.prototype.set_upper_body_rotation=function(e,t){if(!(Ye.ML_enabled||Ye.VMC_receiver.mocap_enabled)||this.model_num!=e)return;const i=THREE.MMD.getModels()[this.model_num].mesh.bones_by_name;for(const n of["センター","上半身","上半身2","首","頭"]){if(!i[n])continue;let e=this._body_motion_rot[t][n];if(!e)e=this._body_motion_rot[t][n]=new THREE.Quaternion;e.copy(i[n].quaternion)}};M.prototype.get_upper_body_rotation=function(){const e=THREE.MMD.getModels()[this.model_num].mesh.bones_by_name;this._rot_camera.setFromEuler(MMD_SA.TEMP_v3.set(MMD_SA._rx_last,MMD_SA._ry_last,0));this._rot_camera_angle=this._rot_camera.toAxisAngle()[1];const t=Xe.set(0,0,0,1);const i=Ue.set(0,0,0,1);for(const o of["センター","上半身","上半身2"]){t.multiply(this._body_motion_rot[0][o]||e[o].quaternion);i.multiply(this._body_motion_rot[1][o]||e[o].quaternion)}this._rot_body_camera.copy(t).conjugate().multiply(i);this._rot_body_camera_offset.copy(this._rot_body_camera).conjugate().multiply(this._rot_camera);this._rot_body_motion.copy(t);const n=Ce.copy(t).conjugate();return n};M.prototype.upper_body_rotation_limiter=function(t,i=Math.PI/3){var n=t.toAxisAngle();var o=n[1];this._rot_body_offset.set(0,0,0,1);if(Math.abs(o)>i){let e;if(Math.abs(o)<i*2){e=Math.sign(o)*i}else{e=Math.sign(o)*i*(1-(o-i*2)/(Math.PI-i*2))}t.setFromAxisAngle(n[0],e);this._rot_body_offset.setFromAxisAngle(n[0],e-o)}return this._rot_body_offset};M.prototype.offset_upper_body_camera_rotation=function(e,t=1){return e.premultiply(this._q2.copy(this._rot_body_offset).multiply(t==1?this._rot_body_camera:this._q1.set(0,0,0,1).slerp(this._rot_body_camera,t))).multiply(t==1?this._rot_body_camera_offset:this._q1.set(0,0,0,1).slerp(this._rot_body_camera_offset,t))};Object.defineProperty(M.prototype,"camera_weight",{get:function(){return Math.max((Math.PI/2-Math.abs(this._rot_camera_angle))/(Math.PI/2),0)}});Object.defineProperty(M.prototype,"arm_IK_constraint",{get:function(){return Re}});Object.defineProperty(M.prototype,"NaN_count",{get:function(){return m}});Object.defineProperty(M.prototype,"NaN_data",{get:function(){return s}});M.prototype.add=u;M.prototype.remove=f;M.prototype.reset=h;M.prototype.add_events=Fe;M.prototype.remove_events=Le;M.prototype.get_blend_default_motion=e;M.prototype.set_blend_default_motion=t;return M}();let _t;window.addEventListener("jThree_ready",()=>{D.prototype._q1=new THREE.Quaternion;D.prototype._q2=new THREE.Quaternion;_t=new D(0)});var lt=function(){function _(e,t,i,n){this.name=e;this.pos=t&&t.toArray()||[0,0,0];this.rot=i&&i.toArray()||[0,0,0,1];this.time=n;c[e].index=l.boneKeys.length}function r(e,t,i){this.name=e;this.weight=t;this.time=i;d[e].index=l.morphKeys.length}var l;var c,d;var p=0;var n=0;var m=0;var u=0;var o;var a=0;var i=0;const f=2;return{timestamp_for_recording:0,get enabled(){return i&&!Ye.video.paused},get morph_active(){return Je.enabled?this.enabled:this.active},get active(){if(!this.enabled)return false;if(this.timestamp_for_recording&&this.timestamp_for_recording!=RAF_timestamp)return false;if(o!=L){let e=1;if(o){e=this.get_frame(L)-this.get_frame(o);if(e<0||e>30)e=1;if(e>1){const t=e-1;n+=t;for(const i in c){c[i].frame_length+=t}for(const i in d){d[i].frame_length+=t}}}p+=e;o=L;a=RAF_timestamp}if(a==RAF_timestamp){return true}return false},get_frame:function(e){var t=e.split(":");return parseInt(t[0])*30+(parseInt(t[1])-1)},get frame_count(){return p},get stats(){return[n,l.boneKeys.length,l.morphKeys.length,m,u]},get time(){return Math.floor(p/30)+":"+(p%30+1)},get speed(){return i},set speed(e){i=e;if(e){this.start(e);MMD_SA.playbackRate=e}else{this.stop();MMD_SA.playbackRate=1}},get vmd(){return i?null:l},set vmd(e){l=null},set_boneKey:function(e,t,i,n){if(e.indexOf("腕ＩＫ")!=-1)return;let o=c[e];if(o==null){o=c[e]={frame_length:1};if(p>0)l.boneKeys.push(new _(e,null,null,0))}if(n&&_t.skin[e]&&o.timestamp==_t.skin[e][0].timestamp){let e;if(o.frame_count==p){const a=l.boneKeys[o.index];e=(!t||a.pos)&&(!i||a.rot)}else e=true;if(e){if(o.frame_count!=p){o.frame_length++;m++}return}}if(!t&&i&&o.is_rot_identity&&i.w==1){m++;return}o.is_rot_identity=i?i.w==1:o.is_rot_identity;if(o.frame_count==p){const a=l.boneKeys[o.index];if(t)a.pos=t.toArray();if(i)a.rot=i.toArray()}else{if(o.index!=null&&e.indexOf("手")==-1&&e.indexOf("指")==-1){const a=l.boneKeys[o.index];const s=Math.round(p-a.time*30);if(s>o.frame_length||s>10){const r=new _(e,null,null,(p-1)/30);r.pos=a.pos;r.rot=a.rot;l.boneKeys.push(r);m--}}o.timestamp=_t.skin[e]&&_t.skin[e][0].timestamp||0;l.boneKeys.push(new _(e,t,i,p/30))}o.frame_length=1;o.frame_count=p;return true},set_morphKey:(()=>{function n(e,t,i){let n=d[e];if(n==null){n=d[e]={frame_length:1};if(p>0)l.morphKeys.push(new r(e,0,0))}if(i&&_t.morph[e]&&n.timestamp==_t.morph[e][0].timestamp){if(n.frame_count!=p){n.frame_length++;u++}return}const o=50;t=Math.round(t*o)/o;if(t==n.weight){u++;return}if(n.frame_count==p){const a=l.morphKeys[n.index];a.weight=t}else{if(n.index!=null){const a=l.morphKeys[n.index];const s=Math.round(p-a.time*30);if(s<f){n.frame_length++;return}if(s>n.frame_length||s>10){l.morphKeys.push(new r(e,a.weight,(p-f)/30));u--}}n.timestamp=_t.morph[e]&&_t.morph[e][0].timestamp||0;l.morphKeys.push(new r(e,t,p/30))}n.weight=t;n.frame_length=1;n.frame_count=p;return true}return function(e,t,i){window.addEventListener("SA_motion_recorder_on_active",()=>{n.call(this,e,t,i)},{once:true})}})(),start:function(e){i=e;if(MMD_SA.THREEX.get_model(0).use_faceBlendshapes){MMD_SA.THREEX.get_model(0)._disable_faceBlendshapes=true;for(const t of Ze.faceBlendshapes_list){_t.remove("morph",t)}}o="";a=0;if(Ye.is_local_video){Ye.video.playbackRate=e;if(e<1)Ye.video.muted=true;Ye.video.loop=false;Ye.video.pause();MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed.begin_recording"),5*1e3);C_media_control.style.visibility="inherit"}p=-1;n=0;m=0;u=0;c={};d={};l={boneKeys:[],morphKeys:[]}},stop:function(){i=0;MMD_SA.THREEX.get_model(0)._disable_faceBlendshapes=false;if(Ye.is_local_video){Ye.video.playbackRate=1;Ye.video.muted=false;Ye.video.loop=true;Ye.video.pause();MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed.begin_recording.recording_stopped"),5*1e3)}else if(Ye.is_local_photo){l.boneKeys=l.boneKeys.filter(e=>e.time==0);l.morphKeys=l.morphKeys.filter(e=>e.time==0);l.boneKeys=l.boneKeys.concat(l.boneKeys.map(e=>{const t={name:e.name,pos:e.pos.slice(),rot:e.rot.slice(),time:60};return t}));l.morphKeys=l.morphKeys.concat(l.morphKeys.map(e=>{const t={name:e.name,weight:e.weight,time:60};return t}))}}}}();const E=(()=>{function r(){p=p.slice(Math.max(p.length-8,0),p.length);MMD_SA_options.Dungeon.run_event([[{message:{content:p.join("\n")+"\n("+System._browser.translation.get("XR_Animator.UI.streamer_mode.press_x_to_abort")+")",para:f,branch_list:[{key:"X",is_closing_event:true,event_id:{func:()=>{u=true;if(m)m()},ended:true}}]}}]])}function _(){if(--i==0){p.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_model_loaded"));if(m)m()}}function l(e){if(!Ze.calibrated){i++;window.addEventListener("SA_camera_facemesh_calibrating",c);p.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrating")+"...");r()}_(e)}function c(e){const t=e.detail.percent;if(t>=100){window.removeEventListener("SA_camera_facemesh_calibrating",c);MMD_SA.SpeechBubble.list[1].message(0,"("+System._browser.translation.get("XR_Animator.UI.streamer_mode.calibrating_face_data")+" - 100%)",0,f);p.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrated"));_()}else{MMD_SA.SpeechBubble.list[1].message(0,"("+System._browser.translation.get("XR_Animator.UI.streamer_mode.calibrating_face_data")+" - "+t+"%)\n"+System._browser.translation.get("XR_Animator.UI.streamer_mode.face_data_calibrating_message"),0,f)}}let d;let p=[];let i;let m;let u;const f={font_scale:1,font:'"Segoe UI",Roboto,Ubuntu,"SF Pro"'};const e={get running(){return d},get mocap_ready(){return Ye.ML_enabled&&i===0?true:false},init_mocap:function(e){function t(){if(d){if(MMD_SA_options.user_camera.streamer_mode.motion_id!=null){const e=typeof MMD_SA_options.user_camera.streamer_mode.motion_id=="number"?MMD_SA_options.user_camera.streamer_mode.motion_id+(System._browser.camera.facemesh.enabled&&!System._browser.camera.poseNet.enabled?1:0):MMD_SA_options._XRA_pose_list?.[2].findIndex(e=>e.name==MMD_SA_options.user_camera.streamer_mode.motion_id);if(typeof e=="number"&&e>=0)MMD_SA_options.Dungeon_options.item_base.pose?._change_motion_(e,true);return new Promise(t=>{window.addEventListener("SA_MMD_model0_onmotionchange",e=>{p.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.motion_changed")+" ("+e.detail.motion_new.filename+")");t()},{once:true})})}}if(MMD_SA.WebXR.user_camera.poseNet.enabled){if(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_enabled)MMD_SA_options.Dungeon_options.item_base.pose?._change_motion_(0,true)}}switch(e){case"Face":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=false;MMD_SA.WebXR.user_camera.handpose.enabled=false;DEBUG_show("Facemesh AI:ON",2);i=1;break;case"Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=false;MMD_SA.WebXR.user_camera.facemesh.enabled=false;DEBUG_show("Pose AI:ON",3);i=1;break;case"Body+Hands":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;MMD_SA.WebXR.user_camera.facemesh.enabled=false;DEBUG_show("Pose/Hands AI:ON",3);i=1;break;case"Face+Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=false;DEBUG_show("Facemesh/Pose AI:ON",3);i=2;break;case"Full Body":MMD_SA.WebXR.user_camera.poseNet.use_holistic=false;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;DEBUG_show("Facemesh/Pose/Hands AI:ON",4);i=2;break;case"Full Body Holistic":MMD_SA.WebXR.user_camera.poseNet.use_holistic=true;MMD_SA.WebXR.user_camera.poseNet.use_holistic_legacy=true;MMD_SA.WebXR.user_camera.facemesh.enabled=true;MMD_SA.WebXR.user_camera.poseNet.enabled=true;MMD_SA.WebXR.user_camera.handpose.enabled=true;DEBUG_show("Facemesh/Pose/Hands AI:ON",4);i=2;break;default:return}MMD_SA_options.user_camera.streamer_mode.mocap_type=e;return t()},start:async function(){function e(){p.length=0;m=null;u=false;d=false}function t(){e();MMD_SA_options.Dungeon.event_mode=false}if(MMD_SA.WebXR.user_camera.bodyPix.enabled){DEBUG_show("(You can't enable motion capture and Selfie Segmentation AI at the same time.)",5);return}if(d){DEBUG_show("(Streamer mode running)");return}e();d=true;MMD_SA_options.Dungeon.event_mode=true;const i=Ye.stream&&MMD_SA_options.user_camera.streamer_mode.camera_preference.label;MMD_SA.WebXR.user_camera.video_flipped=!!MMD_SA_options.user_camera.streamer_mode.camera_preference.video_flipped;if(0){Ye.init_stream(toFileProtocol(System.Gadget.path+"/TEMP/_.mp4"))}else{const o=await Ye.start();if(!o){MMD_SA.SpeechBubble.message(0,System._browser.translation.get("XR_Animator.UI.streamer_mode.webcam_not_accessible"),5*1e3);t();return}if(i!=MMD_SA_options.user_camera.streamer_mode.camera_preference.label)p.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.webcam_on")+" ("+MMD_SA_options.user_camera.streamer_mode.camera_preference.label+")")}let n;if(webkit_electron_mode&&MMD_SA.THREEX.enabled){n=!!MMD_SA_options.user_camera.streamer_mode.VMC_sender_enabled;if(n){if(!MMD_SA.OSC.VMC.sender_enabled){MMD_SA_options.user_camera.streamer_mode.VMC_sender_enabled=MMD_SA.OSC.VMC.sender_enabled=true;p.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.VMC_protocol_on"));MMD_SA.OSC.VMC.send_camera_data=!!MMD_SA_options.user_camera.streamer_mode.VMC_send_camera_data;if(MMD_SA.OSC.VMC.send_camera_data)p.push("✅- "+System._browser.translation.get("XR_Animator.UI.streamer_mode.VMC_protocol_on.send_camera_data"));System._browser.update_tray()}}}if(!Ye.ML_enabled){const a=MMD_SA_options.user_camera.streamer_mode.mocap_type||(is_mobile?System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.face","en"):System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.full_body","en"));const s=MMD_SA_options.user_camera.streamer_mode.mocap_type||(is_mobile?System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.face"):System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing.full_body"));p.push("✅"+System._browser.translation.get("XR_Animator.UI.streamer_mode.mocap_initializing")+" ("+s+")...");r();await new Promise(e=>{m=e;if(/Face|Full Body/.test(a))window.addEventListener("SA_camera_facemesh_update",l,{once:true});if(/Body/.test(a))window.addEventListener("SA_camera_poseNet_update",_,{once:true});const t=E.init_mocap(a);if(t)t.then(r)})}if(u){window.removeEventListener("SA_camera_poseNet_update",_);window.removeEventListener("SA_camera_facemesh_update",l);window.removeEventListener("SA_camera_facemesh_calibrating",c);MMD_SA.SpeechBubble.list.forEach(e=>{e.hide()});t();return}m=null;MMD_SA.SpeechBubble.hide();if(MMD_SA_options._XRA_headless_mode)System._browser.on_animation_update.add(()=>{document.dispatchEvent(new KeyboardEvent("keydown",{code:"Escape"}))},0,0);if(n){if(p.length){await new Promise(e=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.UI.streamer_mode.finish_VMC"),para:f,index:1,branch_list:[{key:1,event_id:{func:()=>{MMD_SA.hide_3D_avatar=true;System._browser.update_tray();e()},ended:true}},{key:"X",is_closing_event:true,event_id:{func:()=>{e()},ended:true}}]}}]])})}}else{if(p.length){await new Promise(e=>{MMD_SA_options.Dungeon.run_event([[{message:{content:System._browser.translation.get("XR_Animator.UI.streamer_mode.finish"),para:f,index:1,branch_list:[{key:1,event_id:{func:()=>{System._browser.overlay_mode=1;e()},ended:true}},{key:"X",is_closing_event:true,event_id:{func:()=>{e()},ended:true}}]}}]])})}}if(!p.length)MMD_SA.SpeechBubble.message(0,"XR Animator is ready!",3e3);if(Ye.initialized&&Ye.visible)Ye.hide();t()}};return e})();var Lt=[{},{}];var k=e.get("camera_hidden");var x;var P;Ye={initialized:false,get ML_enabled(){return h},get ML_busy(){return Ze.busy||Je.busy},get ML_fps(){return 1e3/(Je.enabled&&Je._t||Ze.enabled&&Ze._t||1e3)},get mocap_enabled(){return this.ML_enabled||this.VMC_receiver.enabled},get mocap_data_smoothing(){return P==null?2:P},set mocap_data_smoothing(e){P=e},get ML_warmed_up(){var e=Lt[Je.use_holistic?1:0];var t=!Ze.enabled||e.facemesh;var i=!Je.enabled||e.poseNet;var n=!tt.enabled||e.handpose;return t&&i&&n},get target_devicePixelRatio(){return c||window.devicePixelRatio},set target_devicePixelRatio(e){c=e==window.devicePixelRatio?0:e},get double_flip_mode(){return t&&!Ye.mirror_3D},set double_flip_mode(e){t=e},get video_flipped(){return!h?_:!!_^!!Ye.double_flip_mode},set video_flipped(e){_=e;this.reset_video_canvas()},get display_flipped(){return Ye.mirror_3D?false:_!=Ye.video_flipped},get mirror_3D(){return!h||!MMD_SA_options.user_camera.mirror_3D?false:MMD_SA_options.user_camera.mirror_3D==1?Ye.visible:true},get x_flipped(){return Ye.double_flip_mode||Ye.mirror_3D},get hidden_enforced(){return k||(MMD_SA_options.user_camera.display.video.hidden==null?!!this.stream:MMD_SA_options.user_camera.display.video.hidden)||System._browser.overlay_mode>0||this.stream&&MMD_SA_options.user_camera.display.video.hidden_on_webcam},get display_floating(){return MMD_SA_options.user_camera.display.floating||x},set display_floating(e){x=e;if(this.video_host)this.video_host.style.zIndex=this.display_floating?2:0},get video_timestamp(){return Ye.video.currentTime==null?performance.now()/2:Ye.video.currentTime*1e3},get video_frame_id(){const e=this.video_timestamp/1e3;const t=Math.floor(e);return t+":"+Math.floor((e-t)*30+1)},get is_local_media(){return this.local_src&&!this.stream},get is_local_video(){return this.is_local_media&&this.video.currentTime!=null},get is_local_photo(){return this.is_local_media&&this.video.currentTime==null},get media_control_enabled(){return u},set media_control_enabled(e){if(u==!!e)return;u=!!e;this.video.removeEventListener("timeupdate",f,true);if(u){MMD_SA.motion_player_control.enabled=false;this.video.addEventListener("timeupdate",f,true);SL_MC_simple_mode=true;SL_MC_video_obj=Ye.video;SL_MC_Place(1,0,-64)}else{SL_MC_Place(-1);if(!MMD_SA.motion_player_control.enabled&&MMD_SA_options._XRA_pose_list?.[0].find(e=>e.is_custom_motion&&e.name==MMD_SA.MMD.motionManager.filename)!=null){MMD_SA.motion_player_control.enabled=true}}},DEBUG_show:(()=>{let n="";let o="";let a=0;let s=[];window.addEventListener("MMDStarted",()=>{System._browser.on_animation_update.add(()=>{s=s.filter(e=>RAF_timestamp<e.timestamp+e.duration);o=s.length?s.map(e=>e.msg).join("\n")+"\n":"";ct=o+n},0,0,-1)});return function(e,t,i){if(!Ye.ML_enabled||!Je.data_detected&&!Ze.data_detected||Ye.video?.paused){DEBUG_show(e,t,i);return}if(t){s.push({msg:e,duration:t*1e3,timestamp:RAF_timestamp});return}if(a!=RAF_timestamp){a=RAF_timestamp;n=""}n=(n?n+"\n":n)+e;ct=o+n}})(),update_display_floating:function(){this.display_floating=MMD_SA_options.user_camera.display.floating_auto!==false&&(MMD_SA.THREEX.scene.background||MMD_SA_options.mesh_obj_by_id["DomeMESH"]?._obj.visible||MMD_SA.THREEX._object3d_list_?.some(e=>!e.parent_bone))},motion_recorder:lt,tilt_adjustment:{enabled:false,angle:0,pose_weight:.5},camera_list:null,deviceId:null,start:async function(i){async function n(){try{stream=await navigator.mediaDevices.getUserMedia(r);return stream}catch(e){console.error(e)}}var e=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;this._update_camera_reset();if(this.initialized&&!E.running){if(this.visible){this.hide();DEBUG_show("User camera:HIDDEN",2);return}}var r={video:this.set_constraints()};try{if(i){this.init_stream(i)}else{if(is_mobile){r.video.facingMode="user"}if(MMD_SA_options.Dungeon){MMD_SA_options.Dungeon.run_event([[{message:{get content(){return System._browser.translation.get("XR_Animator.UI.webcam_media.finding_camera")}}},{goto_branch:0}]])}let t;if(is_mobile){if(!this.stream)t=await n();if(MMD_SA_options.Dungeon)MMD_SA_options.Dungeon.run_event(null,0,2);if(!this.stream&&!t){DEBUG_show("(Camera not accessible)",3);return}}else{let s=this.camera_list;if(!s){try{if(mac_mode)await SA_require("electron").systemPreferences.askForMediaAccess("camera");if(browser_native_mode&&!this.camera_requested){console.log("(Requesting camera access)");this.camera_requested=true;await navigator.mediaDevices.getUserMedia({video:true})}s=await navigator.mediaDevices.enumerateDevices();s=s.filter(e=>e.kind=="videoinput");const o=MMD_SA_options.user_camera.streamer_mode.camera_preference?.label&&{label:{test:e=>e.indexOf(MMD_SA_options.user_camera.streamer_mode.camera_preference.label)!=-1}}||MMD_SA_options.user_camera.preference;s.sort((e,t)=>o?.label?.test(e.label)&&-1||o?.label?.test(t.label)&&1||/warudo/i.test(e.label)&&1||/warudo/i.test(t.label)&&-1||0);if(E.running&&!s.length)throw new Error("(No camera detected)")}catch(e){console.error(e);if(MMD_SA_options.Dungeon)MMD_SA_options.Dungeon.run_event(null,0,2);DEBUG_show("(No camera detected)",3);return}}let e;if(MMD_SA_options.Dungeon){await new Promise(o=>{let a=0;MMD_SA_options.Dungeon.run_event([[{message:{get content(){let i=[];if(s.length){i.push(System._browser.translation.get("XR_Animator.UI.webcam_media.choose_an_input"));for(let e=a,t=Math.min(a+6,s.length);e<t;e++)i.push(e-a+1+". "+s[e].label.substring(0,25))}else{i.push(System._browser.translation.get("XR_Animator.UI.webcam_media.no_camera"))}i.push("A. "+System._browser.translation.get("XR_Animator.UI.webcam_media.local_media_file"));if(s.length>6)i.push("B. ⏭️"+System._browser.translation.get("XR_Animator.UI.webcam_media.next_6_webcams"));i.push("X. "+System._browser.translation.get("Misc.cancel"));return i.join("\n")},para:{row_max:11,no_word_break:true},bubble_index:3,branch_list:[{key:"any",func:t=>{if(/^[1-6]$/.test(t.key)){let e=parseInt(t.key)+a-1;const i=s[e];if(!i)return false;const n=i.label;MMD_SA_options.user_camera.streamer_mode.camera_preference=Object.assign(MMD_SA_options.user_camera.streamer_mode.camera_preference||{},{label:n,video_flipped:!!_});s.sort((e,t)=>e.label==n&&-1||t.label==n&&1||0);r.video.deviceId=i.deviceId;o()}else{return false}MMD_SA_options.Dungeon.run_event(null,0,1);return true}},{key:"A",func:function(){if(Ye.local_src){i=Ye.local_src;o();this.event_index=1}else{DEBUG_show("(No local media file found)",3);this.event_index=0}},event_index:0},{key:"B",func:()=>{a=a+6>=s.length?0:a+6;MMD_SA_options.Dungeon.run_event(null,0,0)},event_index:0},{key:"X",func:()=>{e=true;o()},event_index:1,is_closing_event:true}]}}]]);if(E.running&&MMD_SA_options.user_camera.streamer_mode.camera_preference?.label!=null){document.dispatchEvent(new KeyboardEvent("keydown",{key:"1"}))}})}if(e){DEBUG_show("(Canceled)",2);return}if(!i&&r.video.deviceId!=this.deviceId){t=await n();if(!t){DEBUG_show("(Camera not accessible)",3);return}}}if(i){Ye.init_stream(i)}else if(t){Ye.init_stream(t);this.deviceId=r.video.deviceId}if(e&&e.dom_overlay)e.dom_overlay.use_dummy_webgl=true;DEBUG_show("(User camera:ON)",2)}if(!this.visible){this.show();DEBUG_show("User camera:VISIBLE",2)}return E.running}catch(e){if(MMD_SA_options.Dungeon&&MMD_SA_options.Dungeon.event_mode)MMD_SA_options.Dungeon.run_event({ended:true});Ye.init_stream();console.error(e);DEBUG_show("(ERROR: Camera unavailable, using fallback video instead)",3)}},_update_camera_reset:function(){MMD_SA.reset_camera();this._camera_reset=MMD_SA._trackball_camera.object.clone();this._camera_reset.children.length=0;this._camera_reset.quaternion.set(0,0,0,1);this._camera_reset.updateMatrixWorld();Je.frames._z_max=Je.frames._z_max_timestamp=0},init_stream:function(e){if(!this.initialized){this.video=this._video=document.createElement("video");this.video.autoplay=true;let e;this.video_host=document.createElement("div");e=this.video_host.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=this.display_floating?2:0;e.visibility=System._browser.overlay_mode?"hidden":"inherit";e.display=System._browser.overlay_mode?"none":"block";SL_Host.appendChild(this.video_host);this.video_canvas=document.createElement("canvas");e=this.video_canvas.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas);this.video_canvas_bodyPix=document.createElement("canvas");e=this.video_canvas_bodyPix.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_bodyPix);this.video_canvas_face_detection=document.createElement("canvas");e=this.video_canvas_face_detection.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_face_detection);this.video_canvas_facemesh=document.createElement("canvas");e=this.video_canvas_facemesh.style;e.position="absolute";e.left="0px";e.top="0px";e.zIndex=0;e.visibility="hidden";this.video_host.appendChild(this.video_canvas_facemesh);is_mobile&&window.addEventListener("resize",function(){Ye.video_track?.applyConstraints(Ye.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update")})});try{navigator.mediaDevices?.addEventListener("devicechange",()=>{console.log("mediaDevices: new device detected");this.camera_list=null})}catch(e){}}this.initialized=true;if(this.stream){this.stream.getTracks().forEach(e=>{e.stop()});this.video.srcObject=this.stream=this.video_track=this.deviceId=null;console.log("(Previous stream stopped)")}if(!e||typeof e=="string"){m(e)}else{this.stream=e;this.video_id=e.id;this.video_track=e.getVideoTracks()[0];this.video=this._video;this.video.srcObject=e;console.log("(New stream started)");setTimeout(function(){let e=Ye.video_track.getCapabilities?.();if(!e)return;System._browser.console.log(Object.entries(e).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n"));let t=Ye.video_track.getSettings();const i=Object.entries(t).map(e=>e[0]+":"+JSON.stringify(e[1])).join("\n");console.log("MediaTrackCapabilities",i);if(is_mobile)System._browser.console.log()},2e3)}this.show();if(Ze.enabled)Ze.reset_calibration()},get use_armIK(){return this.ML_enabled||this.VMC_receiver.mocap_enabled},bodyPix:function(){var n;var i=false;p={get enabled(){return i},set enabled(e){if(i==!!e)return;i=!!e;const t=MMD_SA.THREEX.SL;if(i){MMD_SA._renderer.devicePixelRatio=1;MMD_SA._renderer.__resize(EV_width,EV_height);t.style.visibility="hidden"}else{MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);t.style.visibility="inherit";Ye.video_canvas_bodyPix.style.visibility="hidden"}},busy:0,mask:null,allPoses:null,use_bodySegmentation:true,load:async function(e){this.enabled=true;if(n)return;if(!this.mask){this.mask=document.createElement("canvas");d.load_face_cover()}if(this.use_bodySegmentation){const t=bodySegmentation.SupportedModels.MediaPipeSelfieSegmentation;const i={runtime:"mediapipe",solutionPath:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"};n=await bodySegmentation.createSegmenter(t,i)}else{n=await bodyPix.load(e||(1||is_mobile)?{architecture:"MobileNetV1",outputStride:16,multiplier:.5,quantBytes:2}:{architecture:"ResNet50",outputStride:32,quantBytes:2})}console.log("bodyPix loaded")},segmentPerson:async function(e,t){await this.load();if(this.use_bodySegmentation){return await n.segmentPeople(e)}else{return await n.segmentPerson(e,t||{flipHorizontal:false,internalResolution:"medium",segmentationThreshold:.7})}},toMask:async function(e,t,i){const n=await this.segmentPerson(e,t);i=i||{foregroundColor:{r:0,g:0,b:0,a:255},backgroundColor:{r:0,g:0,b:0,a:0}};if(this.use_bodySegmentation){return await bodySegmentation.toBinaryMask(n,i.foregroundColor,i.backgroundColor)}else{this.allPoses=n.allPoses;return bodyPix.toMask(n,i.foregroundColor,i.backgroundColor)}},update_frame:async function(e=Ye.video_canvas,t,i,n){const o=MMD_SA.THREEX.SL;if(System._browser.snapshot.check_bodyPix()){Ye.video_canvas.style.visibility="inherit";Ye.video_canvas_bodyPix.style.visibility="hidden";o.style.visibility="inherit";return}if(this.busy)return;this.busy=RAF_timestamp;const a=await this.toMask(e,t,i);this.busy=0;if(!this.enabled)return;if(this.mask.width!=a.width||this.mask.height!=a.height){this.mask.width=a.width;this.mask.height=a.height}this.mask.getContext("2d").putImageData(a,0,0);const s=o.width;const r=o.height;if(Ye.video_canvas_bodyPix.width!=s||Ye.video_canvas_bodyPix.height!=r){Ye.video_canvas_bodyPix.width=s;Ye.video_canvas_bodyPix.height=r}const _=s/r/(e.width/e.height);const l=Math.round(s*Math.min(1/_,1));const c=Math.round(r*Math.min(_,1));const d=(s-l)/2;const p=(r-c)/2;const m=Ye.video_canvas_bodyPix.getContext("2d");m.globalCompositeOperation="copy";m.filter="blur("+Math.ceil(3/window.devicePixelRatio)+"px)";m.drawImage(this.mask,0,0,a.width,a.height,d,p,l,c);m.globalCompositeOperation="source-out";m.filter="none";m.save();if(Ye.mirror_3D){m.translate(s,0);m.scale(-1,1)}m.drawImage(o,0,0);m.restore();m.globalCompositeOperation="destination-over";m.drawImage(e,0,0,e.width,e.height,d,p,l,c);Ye.video_canvas_bodyPix.style.visibility="inherit";o.style.visibility="hidden";this.update_frame_for_face_detection();System._browser.snapshot.check_bodyPix()},update_frame_for_face_detection:function(){let e=d.face_cover;if(!d.enabled||!e.complete)return;Ye.video_canvas_face_detection.style.visibility="hidden";let t=e.width;let s=e.height;let r=[];this.allPoses.forEach(function(e){let t=e.keypoints;let i=t.find(e=>e.part=="nose");if(!i)return;let n=t.find(e=>e.part=="leftEye");let o=t.find(e=>e.part=="rightEye");let a;if(n&&o){let e=n.position.x-o.position.x;let t=n.position.y-o.position.y;a=Math.sqrt(e*e+t*t)*4}else{a=s}r.push([i.position.y,i.position.x,Math.max(a,s/2),100])});this.allPoses=undefined;d.update_frame_local(Ye.video_canvas_bodyPix,r)}};return p}(),face_detection:function(){var t=false;function i(){d.initialized=true;if(!self.OffscreenCanvas)d.load_face_cover();r=new Worker("js/pico.worker.js");r.onmessage=function(e){var t=typeof e.data=="string"&&e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;if(typeof t==="string"){DEBUG_show(t,2);d.worker_initialized=true}else{Ye._needs_RAF=true;if(t._t)DEBUG_show(t._t);d.dets=t.dets;d.busy=0;Ye.video_canvas_face_detection.style.left=Ye.video_canvas.style.left;Ye.video_canvas_face_detection.style.top=Ye.video_canvas.style.top;if(!self.OffscreenCanvas){System._browser.on_animation_update.add(function(){d.update_frame_local(null,d.dets)},0,0)}}d.update_frame()}}d={initialized:false,worker_initialized:false,get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){this.dets=null;if(!this.initialized)i()}else{if(Ye.initialized)Ye.video_canvas_face_detection.style.visibility="hidden"}},load_face_cover:function(){if(!this.face_cover){this.face_cover=new Image;this.face_cover.src="images/laughing_man_134x120.png"}},dets:null,camera_video_timestamp:0,update_frame:function(e){function t(){var e=d.enabled&&d.worker_initialized&&F&&!d.busy&&C&&d.camera_video_timestamp!=F;if(!e)return;d.busy=RAF_timestamp;d.camera_video_timestamp=F;d.camera_video_frame_id=L;Ye.video_canvas_face_detection.style.visibility="inherit";let t,i,n;t=Ye.video_canvas;i=t.width;n=t.height;let o=t.getContext("2d").getImageData(0,0,i,n).data.buffer;let a=Ye.video_canvas_face_detection.style;if(a.width!=t.style.width||a.height!=t.style.height){a.width=t.style.width;a.height=t.style.height}let s={rgba:o,w:i,h:n};if(!Ye.video_canvas_face_detection._offscreen&&self.OffscreenCanvas){s.canvas=Ye.video_canvas_face_detection.transferControlToOffscreen();Ye.video_canvas_face_detection._offscreen=true;console.log("(Face detection: use offscreen canvas)")}r.postMessage(s,s.canvas?[s.canvas,s.rgba]:[s.rgba]);s.rgba=o=undefined;s=undefined}if(e||self.PoseAT){setTimeout(()=>{t()},0)}else{t()}},update_frame_local:function(e,i){let t=Ye.video_canvas.width;let n=Ye.video_canvas.height;let o;if(!e){e=Ye.video_canvas_face_detection;if(e.width!=t||e.height!=n){e.width=t;e.height=n}o=e.getContext("2d");o.clearRect(0,0,t,n)}else{o=e.getContext("2d")}o.globalCompositeOperation="source-over";let a=this.face_cover;let s=a.width;let r=a.height;let _,l,c,d;if(i.length){let t=1;i.forEach(function(e){_=e[2]*t;l=_*s/r;c=e[1]*t-l/2;d=e[0]*t-_/2;o.drawImage(a,0,0,s,r,c,d,l,_)})}else{_=Math.min(t,n);l=_*s/r;c=(t-l)/2;d=(n-_)/2;o.drawImage(a,0,0,s,r,c,d,l,_)}}};return d}(),streamer_mode:E,facemesh:function(){var i=false;var je=0;var Fe=0;var Le=true;var Ce=0;var He=[];var Be;var Oe;var g;var qe=[];var Xe=[];var Ue;var A=false;var Ke;var M=-1;var t;function n(e){if(!e&&t&&t==Ye.video_id)return;t=Ye.video_id;je=0;Fe=0;Le=true;Ce=0;He=[];Be={};Oe={L:[],R:[]};g=0;qe=[];Ze.face_width_average=0;Xe=[];var n={L:[159,145],R:[386,374]};["L","R"].forEach(function(t){for(var i=0;i<1;i++){let e=Oe[t][i]={};e.index=i;e._eye_open_average=0;e.eye_open_average=0;e.eye_open_lower=999;e.eye_open_data=[];e.height_ref_pts=n[t]}Be[t]={_height_average:0,height_average:0,height_data:[],height_ref_pts:t=="R"?[334,330]:[105,101],_brow_offset_average:0,brow_offset_average:0,brow_offset_data:[]}});Ke={sad:0,angry:0,surprise:0,blush:0,tongue_out:0}}var o;var We=[];var Ve,Ne,D;Ve=!is_mobile;D=!is_chrome||is_mobile;var x;function y(){if(Ze.initialized)return;Ze.initialized=true;for(var e=0;e<4;e++)We[e]=new THREE.Vector3;var n=[];if(System._browser.use_WASM_SIMD){n.push("simd=1")}if(Z){Ve=true}if(D){Ve=true;n.push("use_mediapipe_facemesh=1")}if(Ve){Ve=true;if(Ze.blink_detection==null)Ze.blink_detection=true;n.push("use_face_landmarks=1")}if(Ne){n.push("use_human_facemesh=1")}var t;if(MMD_SA_options.user_camera.ML_models.facemesh.worker_disabled){t=new Promise((e,t)=>{$e={postMessage:function(e,t){FacemeshAT.onmessage({data:e})}};let i=document.createElement("script");i.onload=async function(){await FacemeshAT.init($e,n);e()};i.src="js/facemesh_lib.js";document.head.appendChild(i)})}else{$e=new Worker("js/facemesh_worker.js"+(n.length?"?"+n.join("&"):""))}$e.onmessage=v;if(!Ze.draw_canvas){fetch("js/facemesh_triangulation.json").then(e=>e.json()).then(e=>{x=e});System._browser.on_animation_update.add(()=>{Ge.draw()},0,1,-1);console.log("(Facemesh: drawing wireframe in main thread)")}return t}const Ge=(()=>{var v;var w;var S;function e(e,t,i,n){function o(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}const a=Math.round(t/2);const s=Math.round(i/2);if(D.width!=a||D.height!=s){D.width=a;D.height=s}E.globalAlpha=.5;E.save();if(v){E.translate(D.width,0);E.scale(-1,1)}E.clearRect(0,0,a,s);E.fillStyle="black";E.fillRect(0,0,a,s);if(!x||!e.length){S=false;E.restore();return}S=true;const r=e[0].bb;if(w){E.globalAlpha=1;E.drawImage(w,r.x/2,r.y/2,r.w/2,r.h/2)}E.fillStyle="#32EEDB";E.strokeStyle="#32EEDB";E.lineWidth=.5;const _=e[0].scaledMesh;for(let e=0,t=x.length/3;e<t;e++){const l=[x[e*3],x[e*3+1],x[e*3+2]].map(e=>_[e]);A(E,l,true)}if(w&&Ve){const c=E;const d=468;const p=5;const m="#FF2C35";c.strokeStyle=m;c.lineWidth=1;const u=_[d];const f=o(_[d+4],_[d+2]);const h=o(_[d+3],_[d+1]);c.beginPath();c.ellipse(u[0]/2,u[1]/2,h/2/2,f/2/2,0,0,2*Math.PI);c.stroke();if(_.length>d+p){const M=_[d+p];const g=o(_[d+p+2],_[d+p+4]);const y=o(_[d+p+3],_[d+p+1]);c.beginPath();c.ellipse(M[0]/2,M[1]/2,y/2/2,g/2/2,0,0,2*Math.PI);c.stroke()}}else{k.forEach(function(e){if(!e)return;var t=e[0]/2;var i=e[1]/2;E.beginPath();E.arc(t,i,1,0,2*Math.PI,false);E.lineWidth=3;E.strokeStyle="red";E.stroke()})}if(r.w<t||r.h<i){E.globalAlpha=1/3;E.strokeStyle="white";E.lineWidth=3;const b=new Path2D;b.moveTo(r.x/2,r.y/2);b.lineTo(r.x/2+r.w/2,r.y/2);b.lineTo(r.x/2+r.w/2,r.y/2+r.h/2);b.lineTo(r.x/2,r.y/2+r.h/2);b.closePath();E.stroke(b)}E.restore()}function A(e,t,i){const n=new Path2D;n.moveTo(t[0][0]/2,t[0][1]/2);for(let e=1;e<3;e++){const o=t[e];n.lineTo(o[0]/2,o[1]/2)}if(i){n.closePath()}e.stroke(n)}var t,i,n;var o;var a,s=0;var l,r;var c=[["leftHip","leftShoulder"],["leftElbow","leftShoulder"],["leftElbow","leftWrist"],["leftHip","leftKnee"],["leftKnee","leftAnkle"],["rightHip","rightShoulder"],["rightElbow","rightShoulder"],["rightElbow","rightWrist"],["rightHip","rightKnee"],["rightKnee","rightAnkle"],["leftShoulder","rightShoulder"],["leftHip","rightHip"]];function _(){if(Je.pose_enabled&&(!t||t.score<.1))return;E.save();if(v){E.translate(D.width,0);E.scale(-1,1)}if(Je.pose_enabled){var r=i/l*2;var _={};t.keypoints.forEach(function(e,t){_[e.part]=e;if(e.score<=0)return;if(/nose|Eye|Ear/.test(e.part)&&S)return;const{y:i,x:n}=e.position;E.beginPath();E.arc(n/r,i/r,3,0,2*Math.PI);E.fillStyle="aqua";E.fill()});c.forEach(function(e){var t=_[e[0]];var i=_[e[1]];if(t.score<=0||i.score<=0)return;var n=t.position.x,o=t.position.y,a=i.position.x,s=i.position.y;E.beginPath();E.moveTo(n/r,o/r);E.lineTo(a/r,s/r);E.lineWidth=2;E.strokeStyle="aqua";E.stroke()})}p();E.restore()}var d={thumb:[0,1,2,3,4],index:[0,5,6,7,8],middle:[0,9,10,11,12],ring:[0,13,14,15,16],pinky:[0,17,18,19,20]};function p(){if(!o||!o.length)return;var a=i/l*2;E.strokeStyle="pink";E.fillStyle="pink";o.forEach(function(e){const o=e.keypoints;o.forEach(function(e){E.beginPath();E.arc((e[0]-2)/a,(e[1]-2)/a,3,0,2*Math.PI);E.fill()});Object.keys(d).forEach(function(e){const t=d[e].map(e=>o[e]);const i=new Path2D;i.moveTo(t[0][0]/a,t[0][1]/a);for(let e=1;e<t.length;e++){const n=t[e];i.lineTo(n[0]/a,n[1]/a)}E.stroke(i)})})}let D,E;let k;const m={};return{_data:m,draw:function(){if(this._skip_frame){this._skip_frame=false;return}if(!Ye.ML_enabled)return;D=Ye.video_canvas_facemesh;if(!D)return;if(System._browser.overlay_mode||D.style.visibility=="hidden")return;if(!Ze.enabled)m.faces=null;if(!Je.enabled)m.pose=null;if(!tt.enabled)m.handpose=null;E=D.getContext("2d");v=Ye.display_flipped;l=Ye.video_canvas.width;r=Ye.video_canvas.height;if(m.faces?.[0]){k=m.faces?.[0].eyes;m.faces[0].bb=m.bb}e(m.faces||[],l,r);if(m.pose||m.handpose){t=m.pose;o=m.handpose;i=l;n=r;let e=RAF_timestamp;if(o){a=o;s=e}else{o=a;if(e-s>500)a=undefined}_();t=o=null}if(!et.enabled)m.object_detection=null;if(m.object_detection){E.save();E.fillStyle=E.strokeStyle="#FFEA00";E.lineWidth=2;E.font="bold 16px sans-serif";E.textBaseline="top";m.object_detection.forEach(e=>{const t=e.boundingBox;const i=t.originX;const n=t.originY;const o=t.width;const a=t.height;const s=[[i,n],[i+o,n],[i+o,n+a],[i,n+a]];const r=new Path2D;r.moveTo(s[0][0]/2,s[0][1]/2);for(let e=1;e<s.length;e++){const _=s[e];r.lineTo(_[0]/2,_[1]/2)}r.closePath();E.stroke(r);E.fillText(e.categories[0].categoryName+":"+Math.round(e.categories[0].score*100)+"%",s[0][0]/2+2,s[0][1]/2+2)});E.restore()}}}})();const e=["_neutral","BrowInnerUp","BrowDownLeft","BrowDownRight","BrowOuterUpLeft","BrowOuterUpRight","EyeLookUpLeft","EyeLookUpRight","EyeLookDownLeft","EyeLookDownRight","EyeLookInLeft","EyeLookInRight","EyeLookOutLeft","EyeLookOutRight","EyeBlinkLeft","EyeBlinkRight","EyeSquintRight","EyeSquintLeft","EyeWideLeft","EyeWideRight","CheekPuff","CheekSquintLeft","CheekSquintRight","NoseSneerLeft","NoseSneerRight","JawOpen","JawForward","JawLeft","JawRight","MouthFunnel","MouthPucker","MouthLeft","MouthRight","MouthRollUpper","MouthRollLower","MouthShrugUpper","MouthShrugLower","MouthClose","MouthSmileLeft","MouthSmileRight","MouthFrownLeft","MouthFrownRight","MouthDimpleLeft","MouthDimpleRight","MouthUpperUpLeft","MouthUpperUpRight","MouthLowerDownLeft","MouthLowerDownRight","MouthPressLeft","MouthPressRight","MouthStretchLeft","MouthStretchRight","TongueOut"];let Qe;const b=["あ","い","う","え","お","にやり","ω","口角上げ","口角下げ","ぺろっ","上","下","にこり","困る","怒り","照れ","まばたき","笑い","びっくり","まばたきL","まばたきR"];var v=function(){function Ee(e){if(!e||Qe)return;Qe={};e.categories.forEach((e,t)=>{const i=e.categoryName;Qe[i.charAt(0)+i.substring(1)]=t})}var ke;var xe=0,Pe=0,Re=0,Te=0;const Ie={};window.addEventListener("jThree_ready",()=>{for(const e of b.concat(["両目"])){Ie[e]=new System._browser.data_filter([{type:"one_euro",id:e,para:e=="両目"?[30,1,5,1,4]:[30,1,1,1,1]}])}});const r=["happy","sad","angry","surprise","disgust","fear","neutral"];const _={};const l={};let t,c;let d;function ze(i){const n={};const e=i[i.length-1];const o=e.detection_id;if(c!=o){c=o;d=RAF_timestamp;Object.assign(_,l);let e=Ze.emotion_AI_detection_neutralness_percent/100;let t=Ze.emotion_AI_detection_percent/100;r.forEach(e=>{l[e]=0});i.forEach(e=>{if(l[e.emotion]!=null)l[e.emotion]=e.score});const a=l.neutral;for(const s in l){if(s!="neutral"){l[s]=Math.min(Math.max(l[s]-a*e,0)*(1-a*(1-e))*t,1)}}for(const s in l){let e=l[s];switch(s){case"disgust":l.angry=Math.max(e*.75,l.angry);l.sad=Math.max(e*.75,l.sad);break;case"fear":l.sad=Math.max(e*.75,l.sad);l.surprise=Math.max(e*.75,l.surprise);break;default:l[s]=Math.max(e,l[s])}}}if(t!=_t.reset_timestamp){t=_t.reset_timestamp;d=RAF_timestamp;Object.assign(_,l);Object.assign(n,l)}else{let t=Math.min((RAF_timestamp-d)/(Ze.emotion_AI_detection_interval/(lt.speed||1)),1);r.forEach(e=>{n[e]=l[e]*t+_[e]*(1-t)})}return n}return function(S){var A=typeof S.data=="string"&&S.data.charAt(0)==="{"?JSON.parse(S.data):S.data;if(typeof A==="string"){if(A=="OK"){Ze.worker_initialized=true}else{DEBUG_show(A,2);System._browser.console.log(A)}}else if(A.posenet){Rt({data:A})}else if(Ze.enabled){window.dispatchEvent(new CustomEvent("SA_camera_facemesh_update"));Ye._needs_RAF=true;const e=Lt[Je.use_holistic?1:0];if(!e.facemesh){e.facemesh=true;DEBUG_show("Facemesh ML ready",2)}let w="";if(A.faces.length){Ze.data_detected++}else{Ze.data_detected=0}if(A.faces.length&&A.faces[0].bb_center){E=A.faces[0].bb_center;k=A.faces[0].bb_scale}else if(!Je.enabled){E=[.5,.5];k=0}if(A.faces.length&&Ze.data_detected_stable){if(!Ze.draw_canvas)Ge._data.faces=A.faces;let E=A.faces[0];Ee(E.faceBlendshapes);let c=Ye.x_flipped?1:-1;const D={facemesh_data:E};let k,x,l;if(E.rotation){const q=E.rotation.matrix;ot.set(q[0],q[1],q[2],0,q[3],q[4],q[5],0,q[6],q[7],q[8],0,0,0,0,1)}else{let e=MMD_SA._v3a_.fromArray(E.mesh[152]).sub(MMD_SA._v3b.fromArray(E.mesh[10])).normalize();let t=MMD_SA._v3b_.fromArray(E.mesh[454]).sub(MMD_SA._v3b.fromArray(E.mesh[234])).normalize();let i=MMD_SA.TEMP_v3.crossVectors(t,e).normalize();t.crossVectors(e,i);ot.set(t.x,t.y,t.z,0,e.x,e.y,e.z,0,i.x,i.y,i.z,0,0,0,0,1)}let e=MMD_SA.TEMP_v3.setEulerFromRotationMatrix(ot,"YZX");k=-e.x;x=-e.y;l=-e.z;let t=E.scaledMesh[454][0]-E.scaledMesh[234][0];let i=E.scaledMesh[454][1]-E.scaledMesh[234][1];let n;if(A.recalculate_z_rotation_from_scaledMesh){t/=Math.cos(x);i/=Math.cos(k);n=Math.sqrt(t*t+i*i)}else{t/=Math.cos(l);n=Math.abs(t/Math.cos(x))}Ze.face_width=n;let o;if(A.recalculate_z_rotation_from_scaledMesh){o=Math.asin(i/n)}else{o=l}let a=new THREE.Quaternion;let s=MMD_SA._v3a.set(k,x*c,o*c);a.setFromEuler(s,"YZX");Ze.calculate_neck_data({is_face:true,timestamp:Ze.camera_video_frame_id,f_axis:nt.set(E.scaledMesh[454][0],E.scaledMesh[454][1],0).add(MMD_SA.TEMP_v3.set(E.scaledMesh[234][0],E.scaledMesh[234][1],0)).multiplyScalar(.5).setZ(0).toArray(),face_width:Ze.face_width,face_rot:a.toArray()});const fe=MMD_SA.MMD.motionManager.para_SA;let r=0;let _=fe.motion_tracking?.camera?.tilt_adjustment||Ye.tilt_adjustment;if(_.enabled){r=_.angle*Math.PI/180;const he=MMD_SA._q2.set(Math.sin(r/2),0,0,Math.cos(r/2));a.premultiply(he)}let d=Ye.video_timestamp_absolute;let p=0;if(Te){p=Math.max(Math.min(d-Te,1e3),10);Re+=p;if(++Pe>=20){xe=1e3/(Re/Pe);Pe=Re=0}}Te=d;Ze._t=A._t;_t.t_delta=xe&&1e3/xe||p||A.fps&&1e3/A.fps||A._t;ke="";if(Ze.head_pose_enabled){if(System._browser.motion_control.enabled)D.head_rot=MMD_SA._v3a.clone();let e,t;const X=_t.skin["首"]?.[0];if(X&&X?.info[1]!="facemesh"){t=.5+.5*(X._rot_mixed_ratio||0);const U=.5;e=1-(1-U)*((X._blending_ratio_factor||1)-U)/(1-U)*(1-(X._rot_mixed_ratio||0))}_t.add("skin|facemesh","首",{after_IK:true,rot:a,_blending_start:t,_blending_ratio_factor:e||X?._blending_ratio_factor,_rot_ratio:Ze.face_width/Math.min(Ye.video_canvas.width,Ye.video_canvas.height),_rot_chest_offset:X?._rot_chest_offset,onProcessRotation:Et})}je+=Math.min(A._t,75);if(Le){Fe=~~(Math.min(je/5e3,He.length/60,Ue?Oe.L[0].eye_open_data.length/60:1,Je.enabled?qe.length/60:1,1)*100);Le=Fe<100;window.dispatchEvent(new CustomEvent("SA_camera_facemesh_calibrating",{detail:{percent:Fe}}))}let m=E.faceInViewConfidence>(Ne?.75:.9)&&(Ye.video==Ye._image||!Ye.video.paused&&Math.abs(x)<Math.PI/4&&Math.abs(k+r)<Math.PI/6);if(Le&&m&&Ve){["L","R"].some(function(e){let t=Oe[e][0];let i=E.faceBlendshapes?Math.max(1-E.faceBlendshapes.categories[Qe["eyeBlink"+(e=="L"?"Left":"Right")]].score*.9,.2):MMD_SA._v3a.fromArray(E.mesh[t.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(E.mesh[t.height_ref_pts[1]]));if(i<.5){m=false;return true}})}if(Le&&m){Xe.push(Ze.face_width/Math.max(Ye.video_canvas.width,Ye.video_canvas.height));let e=parseInt(Xe.length*.3);Ze.face_width_average=Xe.sort((e,t)=>e-t).slice(e,Xe.length-e).reduce((e,t)=>e+t)/(Xe.length-e*2)}let u=MMD_SA._v3a.fromArray(E.mesh[13]).distanceTo(MMD_SA._v3b.fromArray(E.mesh[14]));let f=E.faceBlendshapes?E.faceBlendshapes.categories[Qe["mouthPucker"]].score:MMD_SA._v3a.fromArray(E.mesh[61]).distanceTo(MMD_SA._v3b.fromArray(E.mesh[291]));let h=Ce;if(!h){if(m&&u<2*(1+Math.abs(r)/(Math.PI/4)*4))He.push(f);if(!He.length){h=0}else{let e=parseInt(He.length*.3);h=He.sort((e,t)=>e-t).slice(e,He.length-e).reduce((e,t)=>e+t)/(He.length-e*2);if(!Le){Ce=h||Number.MIN_VALUE}}}let M=0;let P=0;let g=0;let y=0;["L","R"].forEach(function(e){let t=Be[e];t.height=E.faceBlendshapes?E.faceBlendshapes.categories[Qe["eyeSquint"+(e=="L"?"Left":"Right")]].score:MMD_SA._v3a.fromArray(E.mesh[t.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(E.mesh[t.height_ref_pts[1]]));t._height_average=t.height_average;if(!t._height_average){if(m)t.height_data.push(t.height);if(!t.height_data.length){t._height_average=t.height}else{let e=parseInt(t.height_data.length*.3);t._height_average=t.height_data.sort((e,t)=>e-t).slice(e,t.height_data.length-e).reduce((e,t)=>e+t)/(t.height_data.length-e*2);if(!Le){t.height_average=t._height_average||Number.MIN_VALUE}}}g+=t.height/t._height_average;if(!E.faceBlendshapes)return;t.brow_offset=E.faceBlendshapes.categories[Qe["browOuterUp"+(e=="L"?"Left":"Right")]].score-E.faceBlendshapes.categories[Qe["browDown"+(e=="L"?"Left":"Right")]].score;t._brow_offset_average=t.brow_offset_average;if(!t._brow_offset_average){if(m)t.brow_offset_data.push(t.brow_offset);if(!t.brow_offset_data.length){t._brow_offset_average=t.brow_offset}else{let e=parseInt(t.brow_offset_data.length*.3);t._brow_offset_average=t.brow_offset_data.sort((e,t)=>e-t).slice(e,t.brow_offset_data.length-e).reduce((e,t)=>e+t)/(t.brow_offset_data.length-e*2);if(!Le){t.brow_offset_average=t._brow_offset_average||Number.MIN_VALUE}}}});g/=2;g=(g-1)/.25*(g>1?2:1);if(h){if(f>h*1.05){P=Math.sqrt(Math.min((f-h*1.05)/(h*.25),1))}else if(f<h*.98){P=-Math.sqrt(Math.min((h*.98-f)/(h*.2),1))}if(u>2){M=Math.pow(Math.min((u-2)/(h*1/3),1),.5);if(P>.25)y=(P-.25)/.75*.3}}let R=0;let T=0;let I=0;let b=0;let z=0;let j=0;const C=Ze.face_width/Math.min(Ye.video_canvas.width,Ye.video_canvas.height);const H=MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only||C>.2?1:Math.max(1-(.2-C)*8,0);let v={L:[0],R:[0]};if(Ve){["L","R"].forEach(function(t){let i=0;v[t][i]=0;let n=Oe[t][i];let o=E.faceBlendshapes?Math.max(1-E.faceBlendshapes.categories[Qe["eyeBlink"+(t=="L"?"Left":"Right")]].score*.9,.2):MMD_SA._v3a.fromArray(E.mesh[n.height_ref_pts[0]]).distanceTo(MMD_SA._v3b.fromArray(E.mesh[n.height_ref_pts[1]]));let a=n.eye_open_average;if(!a){if(m){n.eye_open_data.push(o);let e=parseInt(n.eye_open_data.length*.3);a=n.eye_open_data.sort((e,t)=>e-t).slice(e,n.eye_open_data.length-e).reduce((e,t)=>e+t)/(n.eye_open_data.length-e*2);if(!Le){n.eye_open_average=a}}else{a=n._eye_open_average}}if(m){if(n.eye_open_lower>o)n.eye_open_lower=o}n._eye_open_average=a;if(a){if(o>a){v[t][i]=Math.min(o/a,1.25)}else{let e=Math.min(n.eye_open_lower,a/2);v[t][i]=Math.max((o-e)/(a-e),0)}}})}const B=MMD_SA.THREEX.get_model(0).use_faceBlendshapes;if(E.faceBlendshapes){const K=E.faceBlendshapes.categories;if(!Ze.eye_tracking){K.forEach(e=>{if(e.categoryName.indexOf("eye")!=-1)e.score=0})}const _=[K[Qe["eyeBlinkLeft"]].score,K[Qe["eyeBlinkRight"]].score];_.forEach((e,t)=>{const i=t==0?"L":"R";const n=Oe[i][0];const o=1-(1-Math.max(n._eye_open_average||0,.5))*.8;const a=Math.min(n.eye_open_lower,.3);const s=o-a;e=Math.min(Math.max(e-(1-o),0)/s,1);const r=1.5*Ze.blink_clarity;_[t]=e<.5?Math.pow(e*2,r)/2:Math.pow((e-.5)*2,1/r)/2+.5});const V=!Ze.blink_sync;const G=(V?Math.min(Math.abs(_[0]-_[1])/.4,1):0)*H;let e=V?Math.min(..._):(_[0]+_[1])/2;K[Qe["eyeBlinkLeft"]].score=_[0]*G+e*(1-G);K[Qe["eyeBlinkRight"]].score=_[1]*G+e*(1-G);for(const W of["eyeSquintLeft","eyeSquintRight"]){const N=W=="eyeSquintLeft"?"L":"R";const Y=Math.min(Math.max((Be[N]._height_average||0)*.8,.2),.5);K[Qe[W]].score=Math.max(K[Qe[W]].score-Y,0)/(1-Y)}for(const Z of["L","R"]){const N=Z=="L"?"Left":"Right";const S=Be[Z];let i=S._brow_offset_average||0;i=i>0?Math.max(i-.05,0):Math.min(i+.05,0);if(i){let e=K[Qe["browOuterUp"+N]].score;let t=K[Qe["browDown"+N]].score;if(i>0){K[Qe["browOuterUp"+N]].score=Math.max(e-i,0)/(1-i);i-=.1;if(i>0)t=K[Qe["browDown"+N]].score=Math.pow(t,Math.max(1-i,.5));if(i-e>0)K[Qe["browDown"+N]].score=Math.min(t+(i-e),1)}else{i=-i;K[Qe["browDown"+N]].score=Math.max(t-i,0)/(1-i);i-=.1;if(i>0)e=K[Qe["browOuterUp"+N]].score=Math.pow(e,Math.max(1-i,.5));if(i-t>0)K[Qe["browOuterUp"+N]].score=Math.min(e+(i-t),1)}}}const Q=Math.min(Math.max((h||0)*.8,.2),.6);K[Qe["mouthPucker"]].score=Math.pow(Math.max(K[Qe["mouthPucker"]].score-Q,0)/(1-Q),2);if(B){K.forEach(e=>{let t=e.score;const i=e.categoryName;if(Ye.VMC_receiver.mocap_expression_constraint==1&&/jaw|mouth/i.test(i)&&!/mouth(Left|Right)/i.test(i)){const o=Ye.VMC_receiver.vowel_max;t*=Math.pow(1-o,2)}let n=i.charAt(0).toUpperCase()+i.substring(1);n=n.indexOf("Left")!=-1?n.replace("Left","Right"):n.replace("Right","Left");_t.add("morph|facemesh",n,{weight:t})})}}let F;let L=Ze.emotion_AI_detection_neutralness_percent/100;if(Array.isArray(E.emotion)){const Me=E.emotion[E.emotion.length-1];const ge=Math.round(1e3/Me.t);ke+="Emotion"+"-FPS:"+ge+"(+"+Ze.emotion_AI_detection_interval+"ms)\n";F=ze(E.emotion)}const O=MMD_SA.THREEX.get_model(0);if(E.faceBlendshapes){const $=O.type=="VRM";const K=E.faceBlendshapes.categories;let i=K[Qe["jawOpen"]].score;let n=(K[Qe["mouthSmileLeft"]].score+K[Qe["mouthSmileRight"]].score)/2;let o=(K[Qe["mouthUpperUpLeft"]].score+K[Qe["mouthUpperUpRight"]].score)/2;let a=(K[Qe["mouthLowerDownLeft"]].score+K[Qe["mouthLowerDownRight"]].score)/2;let s=K[Qe["mouthPucker"]].score;let r=K[Qe["mouthFunnel"]].score;let e=K[Qe["mouthShrugLower"]].score;e*=e;let t=K[Qe["browInnerUp"]].score;t*=t;let _=(K[Qe["browOuterUpLeft"]].score+K[Qe["browOuterUpRight"]].score)/2;let l=(K[Qe["browDownLeft"]].score+K[Qe["browDownRight"]].score)/2;const ye=.3*(k>0?1-Math.min(k/(Math.PI/12),1):1);T=Math.min(Math.max(e-ye,0)/.7,1);if(k<0){const re=Math.min(Math.abs(k)/(Math.PI/4),1);T=Math.pow(Math.max(T-re*.5,0)/(1-re*.5),re*3)}T=Math.max(T,Math.pow(Math.max(l-.15,0)/(1-.15),.4));let c=0,d=0,p=0,m=0,u=0;const J=Math.min(Ze.mouth_tracking_sensitivity,2)/2;const ee=Math.max(Ze.mouth_tracking_sensitivity-1,0)/2;const te=.2+.1*J;if(i<.2){if(s>.1){p=s;if(r>.1)u=(r-.1)/2}else{d=Math.pow(Math.min(o+a/2,1),1-.5*ee);m=Math.pow(Math.min((n+o/2)*(i/.1),1),1-.5*ee);const re=Math.min(n*(i/.1)/(o+a||.1),1);d*=1-re;m*=re}let e=1-i/.2*.5;let t=1-Math.min(Math.max(d,p,m,u),.2)/.2;t=e-t*.3;t=1-(1-t)*J;c=Math.pow(i/.2,t)*te;if(B){i=c;_t.morph["JawOpen"][0].weight=i}}else{let e=te+Math.pow((i-.2)/.8,1-.5*ee)*(1-te);i=te+(i-.2)/.8*(1-te);if(B)_t.morph["JawOpen"][0].weight=i;u=Math.min(e+r/2,1);c=Math.min(e+(n+o)/3,1);if(s>.1){const re=Math.min((s-.1)*5,1);u*=re;c*=1-re}else{u=0}}if(r>.1){P=-(r-.1)*.75}else{P=Math.min(Math.max(n-.2,0)*1+Math.max(o-.5,0)*1.5,1);if(P>.5)m*=1-(P-.5)*2*.25}R=Math.max(P,0);R=R*1.5-T;if(R<0){T=-R;R=0}else{T=0;R=Math.min(R*1.5,1)}const ie=.2+s/2;I=Math.max(K[Qe["mouthLeft"]].score-ie,K[Qe["mouthRight"]].score-ie,0);const ne=.4;n=Math.min(R*.8,$?.7-Math.max(R*.4-.3,0):.6);R*=ne;T*=.5;I=Math.max(I-R,0);let f=Math.max(Math.max((K[Qe["mouthPressLeft"]].score+K[Qe["mouthPressRight"]].score)/2,(K[Qe["mouthRollLower"]].score+K[Qe["mouthRollUpper"]].score)/2)-.2,0);if(l>.1){_=-(l-.1)/.9}else if(t>.1&&_>.1){_=((t-.1)/.9+(_-.1)/.9)/2}let h=(K[Qe["eyeBlinkRight"]].score+K[Qe["eyeBlinkLeft"]].score)/2;z=_>0?Math.max(Math.pow(_,2/3)-Math.pow(h,3/2)-.1,0):0;z=z*z*2/3;if($)z=Math.min(z*Math.max(i*3,1),1);let M=1;const oe=Ze.use_tongue_out&&O.blendshape_map_by_MMD_name?.["ぺろっ"];let g=Math.min(Ze.emotion_weight_percent/100/.75,1)*Ze.emotion_tongue_out_percent/100;const be=g&&(O.use_tongue_out||oe);let y=Math.min(K[Qe["mouthLowerDownLeft"]].score,K[Qe["mouthLowerDownRight"]].score);if(be&&y>.2+.1*(1-g)&&i>.35+.15*(1-g)){let e=Math.max(K[Qe["mouthUpperUpLeft"]].score,K[Qe["mouthUpperUpRight"]].score);j=Math.max(y-e*(1.2+.1*(1-g)),0);if(Math.abs(x)>Math.PI/18){M=Math.max(1-(Math.abs(x)-Math.PI/18)/(Math.PI/4),1/3);j*=M}if(j<.1){j=0}else{j=Math.min(j*(1+(K[Qe["mouthDimpleLeft"]].score+K[Qe["mouthDimpleRight"]].score)/2),1)}}let b=Ze.emotion_weight_percent/100;if(B)b*=b;if(F){R=Math.max(F.happy,R);const we=T;T=F.sad;I=F.angry;z=Math.max(F.surprise,z);const _e=R;const le=Math.max(T,I);R=Math.max(R-le*L,0);if(_e<le){n*=1-le*L}T+=Math.min((le-T)*Math.min(we*Math.max(1+(.5-i),0),1),T*2);T=Math.max(T-_e*L,0);I+=Math.min((le-I)*i,I*2);I=Math.max(I-_e*L,0);let e=T-I;const ce=Ze.emotion_weight_by_name("sad");const de=Ze.emotion_weight_by_name("angry");let t=THREE.Math.clamp(T>I?de/ce||2:ce/de||2,.5,2);T-=e*.25*t;I+=e*.25*t;R=Math.min(R,ne);T=Math.min(T,.5);I=Math.min(I,.5);z=Math.min(z,.5)}for(const pe in Ke){let e=Ke[pe];let t=Ze.emotion_weight_by_name(pe,b,1);let i=-1,n=1;let o=$?1:t*.8;let a=t*.75;let s=0;let r;switch(pe){case"sad":s=T;r=.25;break;case"angry":s=I;r=.25;break;case"surprise":s=z;if($){r=.25}break;case"blush":s=f;r=.2;n=.5;o=1;break;case"tongue_out":s=j;r=.2;a=.6;o=1;break}if(r){let e=Math.min(s/r,1);e*=e;o=Math.min(s+Math.max(o-s,0)*e*(e<1?a:1),o);i=s*e*n}Ke[pe]=THREE.Math.clamp(Math.max(e,s)+i*Ze._t/1e3*4,0,o)}({sad:T,angry:I,surprise:z,blush:f,tongue_out:j}=Ke);if(j){if(oe){j=j<.5?(1-Math.cos(j*Math.PI))*.5:.5+Math.sin((j-.5)*Math.PI)*.5}else{if(j<.5){j=0}else{j=Math.sqrt(j);c*=1-j+j/2}}}if(B&&!oe)_t.add("morph|facemesh","TongueOut",{weight:j});if(!$){b=Math.min(b/.75,1);if(f)T+=f*.25*b}const ve=Math.max(R/ne,T,I);const ae=Ze.emotion_weight_by_name("smile",Math.sqrt(b));n=Math.min(n*ae,1);R=Math.min(R*ae,1);const se=1-Math.max((T+I-1.5)/2,0);T=Math.min(T,Ze.emotion_weight_by_name("sad",b))*se;I=Math.min(I,Ze.emotion_weight_by_name("angry",b))*se;f=Math.min(f,Math.min(Ze.emotion_weight_by_name("blush",b)/.75,1));z=Math.min(z,Ze.emotion_weight_by_name("surprise",b));if($)z*=z;z*=1-Math.max(ve-.5,0);if($&&!B){const Se=Math.max(R,n,T,I,z);let e=Ze.emotion_vowel_percent/100;e=e+(1-e)*(1-Se);if(e<1){const me=e+(1-e)*.5;c=Math.pow(c,me)*e;d=Math.pow(d,me)*e;p=Math.pow(p,me)*e;m=Math.pow(m,me)*e;u=Math.pow(u,me)*e}}if(!Ye.VMC_receiver.mocap_expression_constraint){_t.add("morph|facemesh","あ",{weight:c});_t.add("morph|facemesh","い",{weight:d});_t.add("morph|facemesh","う",{weight:p});_t.add("morph|facemesh","え",{weight:m});_t.add("morph|facemesh","お",{weight:u})}_t.add("morph|facemesh","にやり",{weight:P});_t.add("morph|facemesh","口角上げ",{weight:o-Math.max(e,T,I)});_t.add("morph|facemesh","上",{weight:_});_t.add("morph|facemesh","にこり",{weight:n});_t.add("morph|facemesh","困る",{weight:T});_t.add("morph|facemesh","怒り",{weight:I});_t.add("morph|facemesh","笑い",{weight:R});_t.add("morph|facemesh","びっくり",{weight:z});_t.add("morph|facemesh","照れ",{weight:f});_t.add("morph|facemesh","ぺろっ",{weight:j});const V=!Ze.blink_sync&&THREE.MMD.getModels()[0].pmx.morphs_index_by_name["まばたきL"]!=null;if(V){_t.add("morph|facemesh","まばたきL",{weight:Math.max(K[Qe["eyeBlinkRight"]].score-R,0)});_t.add("morph|facemesh","まばたきR",{weight:Math.max(K[Qe["eyeBlinkLeft"]].score-R,0)});_t.add("morph|facemesh","まばたき",{weight:0})}else{_t.add("morph|facemesh","まばたきL",{weight:0});_t.add("morph|facemesh","まばたきR",{weight:0});_t.add("morph|facemesh","まばたき",{weight:Math.max(h-R,0)})}let v,w,S,A;if(Ze.auto_look_at_camera){const Ae=THREE.MMD.getModels()[0].mesh;const De=MMD_SA.TEMP_v3.copy(MMD_SA._trackball_camera.object.position).sub(MMD_SA._head_pos).normalize().applyQuaternion(MMD_SA.get_bone_rotation(Ae,"頭").conjugate());const ue=MMD_SA._v3b.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromUnitVectors(MMD_SA._v3a.set(0,0,1),De));v=-Math.sign(ue.x)*Math.min(Math.abs(ue.x/(Math.PI/4)),1);w=-Math.sign(ue.y)*Math.min(Math.abs(ue.y/(Math.PI/4)),1);A=1}else{v=(K[Qe["eyeLookUpLeft"]].score+K[Qe["eyeLookUpRight"]].score)/2-(K[Qe["eyeLookDownLeft"]].score+K[Qe["eyeLookDownRight"]].score)/2;w=(K[Qe["eyeLookInRight"]].score+K[Qe["eyeLookOutLeft"]].score)/2-(K[Qe["eyeLookInLeft"]].score+K[Qe["eyeLookOutRight"]].score)/2;A=Ze.eye_bone_rotation_percent/100}let D=1-(K[Qe["eyeBlinkLeft"]].score+K[Qe["eyeBlinkRight"]].score)/2;if(D<.5)D=Math.pow(Math.max(D-.1,0)/.4,2)/2;S={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-v*15/180*Math.PI,-w*20/180*Math.PI,0).multiplyScalar(A),"YZX"),blending_ratio:Math.min(D,.5)};_t.add("skin|facemesh","両目",S)}else{let e=R-(T+I+b+z*.5);if(e<0){y*=Math.max(1+e*2,0)}else{y=Math.min(e*.2+y*(1+e*.5),.4)}_t.add("morph|facemesh","にこり",{weight:Ie["にこり"].filter(Math.min(y+R*.75,.75))});_t.add("morph|facemesh","困る",{weight:Ie["困る"].filter(Math.min((T+b)/2*.75+(g<0?Math.max(-g*1-Math.max(P,0)*.5,0):0),.75))});_t.add("morph|facemesh","怒り",{weight:Ie["怒り"].filter(Math.min(I*.75,.75))});g+=z*.2;_t.add("morph|facemesh","笑い",{weight:Ie["笑い"].filter(y)});_t.add("morph|facemesh","びっくり",{weight:Ie["びっくり"].filter(z*.75)});_t.add("morph|facemesh","にやり",{weight:Ie["にやり"].filter(P)});let i=MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(k,x,l),"YZX").conjugate();let n=[];[13,14,61,291].forEach(function(e,t){n[e]=We[t].fromArray(E.mesh[e]).applyQuaternion(i).setZ(0)});let t=MMD_SA._v3a.copy(n[61]).add(n[291]).multiplyScalar(.5);let o=n[61].distanceTo(n[291])*.5;let a=Math.atan2(n[13].y-t.y,o);let s=Math.atan2(n[14].y-t.y,o);let r=Math.max(-(a+s)*180/Math.PI+20*M,0);if(r)r=Math.min(r/20,.75);r=Math.min(r+T*.25,1);r*=.5;M=M*(1-r);_t.add("morph|facemesh","あ",{weight:Ie["あ"].filter(M)});_t.add("morph|facemesh","お",{weight:Ie["お"].filter(r)});let _={L:[],R:[]};if(!Ze.eye_tracking){}else if(Ve){let i=[0,0];let n=[0,0];E.eyes.forEach(function(e,t){if(e){i[t]=Math.max(Math.min((e[3]*2+k/(Math.PI/2))*(1-Math.abs(k)/Math.PI),1),-1);n[t]=Math.max(Math.min((e[2]*2-x/(Math.PI/2))*(1-Math.abs(x)/Math.PI),1),-1)}});let e=(v.L[0]+v.R[0])/2;if(e>1)g+=(e-1)*2;else g-=(1-e)*.5;g=Math.min(g,1);let t=v.L[0]+v.R[0];if(t)t=v.L[0]/t;else t=.5;let o=i[0]*t+i[1]*(1-t);let a=n[0]*t+n[1]*(1-t);let s={absolute:true,rot:(new THREE.Quaternion).fromArray(Ie["両目"].filter(MMD_SA.TEMP_q.setFromEuler(MMD_SA._v3a.set(-(o-.3)*15/180*Math.PI,a*c*20/180*Math.PI,0),"YZX").toArray()))};_t.add("skin|facemesh","両目",s);let r=!Ze.blink_sync&&THREE.MMD.getModels()[0].pmx.morphs_index_by_name["まばたきL"]!=null;let _=(r?Math.min(Math.max(Math.abs(v.L[0]-v.R[0])-(.25+(1-Math.min(Math.max((Math.PI/6-Math.abs(x))/(Math.PI/12),0),1))*1),0)/.25,1):0)*H;let l=r?Math.min(v.L[0],v.R[0]):(v.L[0]+v.R[0])/2;v.L[0]=v.L[0]*_+l*(1-_);v.R[0]=v.R[0]*_+l*(1-_);if(r){let e="まばたき"+(c==1?"L":"R");_t.add("morph|facemesh",e,{weight:Ie[e].filter(Math.max(Math.min(1-v.L[0]*.8-y,1),0))});e="まばたき"+(c==1?"R":"L");_t.add("morph|facemesh",e,{weight:Ie[e].filter(Math.max(Math.min(1-v.R[0]*.8-y,1),0))});_t.add("morph|facemesh","まばたき",{weight:0})}else{_t.add("morph|facemesh","まばたきL",{weight:0});_t.add("morph|facemesh","まばたきR",{weight:0});_t.add("morph|facemesh","まばたき",{weight:Ie["まばたき"].filter(Math.max(Math.min(1-v.L[0]*.8-y,1),0))})}}else{let e=E.eyes[0];let t=0;let i=0;if(e){t=Math.max(Math.min((e[3]*2+k/(Math.PI/2))*(1-Math.abs(k)/Math.PI),1),-1);i=Math.max(Math.min((e[2]*2-x/(Math.PI/2))*(1-Math.abs(x)/Math.PI),1),-1)}let n=g*.25;if(n<0)n=Math.min(n+y,0);let o=Math.max(Math.min(.1-t*(t<0?2:1)*.2-n,.5),0);_t.add("morph|facemesh","まばたき",{weight:o});let a=1.25+Math.pow((v.L[0]+v.R[0])/2,2)*1.75;t=Math.sign(t)*Math.pow(Math.abs(t),a);i=Math.sign(i)*Math.pow(Math.abs(i),a);let s={absolute:true,rot:(new THREE.Quaternion).setFromEuler(MMD_SA._v3a.set(-t*15/180*Math.PI,i*c*20/180*Math.PI,0),"YZX")};_t.add("skin|facemesh","両目",s)}if(Ze.eye_tracking)_t.add("morph|facemesh","上",{weight:Ie["上"].filter(Math.max(Math.min(g,1),-1))})}xt();w=w||E.eyes.length&&[(!Je.enabled?Ye.video_canvas.width+"x"+Ye.video_canvas.height+"("+Ze.camera_video_frame_id+")\n":"")+(Le?"⚙️Calibrating("+Fe+"%):Make a calm face!":"(face data calibrated)")+"/"+Math.round(E.faceInViewConfidence*100)+"%"].join("\n");if(ke)w+="\n"+ke;w+=(it||!Je.enabled?ct?"\n"+ct+"\n":"":"")+(it||"");System._browser.motion_control.process(D)}else{if(!Ze.draw_canvas)Ge._data.faces=[];w="(no facemesh data)"+it}if(!System._browser.overlay_mode&&!MMD_SA_options.user_camera.ML_models.debug_hidden){System._browser.on_animation_update.add(()=>{DEBUG_show(w&&w+(!Je.enabled||!Je.use_holistic?"\nFace-FPS:"+Math.round(xe)+"/"+Math.round(A.fps||0):"")+"\n"+"FPS:"+EV_sync_update.fps_last||"")},0,0)}Ze.busy=0}Ze.update_frame()}}();var P=document.createElement("canvas");var a=true;var s;var r;var _;var l,c,d,p,m,u,f;var w,S,R;var T;var I;var z;var E=[];var k=0;var j=0;var h=0;Ze={initialized:false,worker_initialized:false,faceBlendshapes_list:e,MMD_morph_list:b,wireframe:Ge,draw_canvas:false,get data_detected(){return j},set data_detected(e){if(e){if(!j){h=RAF_timestamp}}else{h=0}j=e},get data_detected_stable(){return i&&h&&RAF_timestamp-h>250/(lt.speed||1)},get head_pose_enabled(){return!i||Ye.VMC_receiver.mocap_head_constraint?false:this.data_detected_stable||!Je.enabled},get blink_detection(){return Ue},set blink_detection(e){Ue=e;if(i){if(Ue){n()}else{MMD_SA_options.auto_blink=o!=null?o:MMD_SA_options.auto_blink}}},get blink_clarity(){return I==null?1:I},set blink_clarity(e){I=e},get auto_blink(){return A},set auto_blink(e){A=e},get eye_bone_rotation_percent(){return z==null?100:z},set eye_bone_rotation_percent(e){z=e},get eye_tracking(){return a==null?true:a},set eye_tracking(e){a=e;a=this.eye_tracking;if(a){this.blink_detection=!!Ve}else{this.blink_detection=false}if(i){if(!a){_t.remove("skin","両目");_t.remove("morph","まばたきL");_t.remove("morph","まばたきR");_t.remove("morph","まばたき");_t.remove("morph","上");_t.remove("morph","下")}}},get use_faceLandmarksDetection(){return Ve},set use_faceLandmarksDetection(e){if(!this.initialized)Ve=e},get use_mediapipe(){return D||Je.enabled&&Je.use_holistic},set use_mediapipe(e){return D=e},get use_faceBlendshapes(){return!Je.enabled||!Je.use_holistic_legacy},get calibrated(){return!Le&&Fe>=100},get mouth_tracking_sensitivity(){return _==null?1:_},set mouth_tracking_sensitivity(e){_=e},get model_inference_device(){return s==null?"CPU":s},set model_inference_device(e){s=e},get lean_tracking(){return r==null?2:r},set lean_tracking(e){r=e},get emotion_weight_percent(){return l==null?75:l},set emotion_weight_percent(e){l=e},get emotion_joy_fun_percent(){return c==null?100:c},set emotion_joy_fun_percent(e){c=e},get emotion_angry_percent(){return d==null?100:d},set emotion_angry_percent(e){d=e},get emotion_sorrow_percent(){return p==null?100:p},set emotion_sorrow_percent(e){p=e},get emotion_surprised_percent(){return m==null?100:m},set emotion_surprised_percent(e){m=e},get emotion_tongue_out_percent(){return u==null?100:u},set emotion_tongue_out_percent(e){u=e},get emotion_others_percent(){return f==null?100:f},set emotion_others_percent(e){f=e},get emotion_AI_detection_percent(){return w==null?0:w},set emotion_AI_detection_percent(e){w=e},get emotion_AI_detection_interval(){return S==null?500:S},set emotion_AI_detection_interval(e){S=e},get emotion_AI_detection_neutralness_percent(){return R==null?50:R},set emotion_AI_detection_neutralness_percent(e){R=e},get use_emotion_AI(){return!!(this.emotion_weight_percent&&this.emotion_AI_detection_percent)},get emotion_vowel_percent(){return T==null?100:T},set emotion_vowel_percent(e){T=e},emotion_weight_by_name:function(e,t=1,i=2){switch(e){case"smile":t*=this.emotion_joy_fun_percent/100;break;case"angry":t*=this.emotion_angry_percent/100;break;case"sad":t*=this.emotion_sorrow_percent/100;break;case"surprise":t*=this.emotion_surprised_percent/100;break;case"tongue_out":t*=this.emotion_tongue_out_percent/100;break;case"blush":t*=this.emotion_others_percent/100;break}return Math.min(t,i)},export_calibration:function(){const e={facemesh_calibration_type:Je.use_holistic_legacy?"holistic_legacy":"facemesh",lips_width_average:Ce,eyebrow_data:{L:{height_average:Be.L.height_average,brow_offset_average:Be.L.brow_offset_average},R:{height_average:Be.R.height_average,brow_offset_average:Be.R.brow_offset_average}},eye_data:{L:{eye_open_average:Oe.L[0].eye_open_average},R:{eye_open_average:Oe.R[0].eye_open_average}},neck_length_average:g};System._browser.save_file("facemesh_calibration.json",JSON.stringify(e,null,"\t"),"application/json")},import_calibration:function(e){this.reset_calibration();Ce=e.lips_width_average;for(const t of["L","R"]){Object.assign(Be[t],e.eyebrow_data[t]);Object.assign(Oe[t][0],e.eye_data[t])}g=e.neck_length_average||1.25;Fe=100;Le=false},face_width:0,_neck:{},calculate_neck_data:(()=>{let m,u,f;let h;let M;window.addEventListener("jThree_ready",()=>{m=new THREE.Vector3;u=new THREE.Vector3;f=new THREE.Vector3;h=new THREE.Quaternion;M=new System._browser.data_filter([{type:"one_euro",id:"neck_length",para:[30,1,1,1,1]}])});return function(t){if(!Je.enabled||!Ze.enabled||!this._neck.data)return false;let e=this._neck.data.find(e=>e.timestamp===t.timestamp);if(!e){this._neck.data.unshift(t);return false}Object.assign(e,t);if(!(e.is_pose&&e.is_face))return false;const i=m.fromArray(e.f_axis);const n=u.fromArray(e.shoulder_center).setZ(0);const o=f.set(0,0,e.face_width/3).applyQuaternion(h.fromArray(e.face_rot).conjugate()).setZ(0).y;const a=MMD_SA.MMD.motionManager.para_SA;let s=a.motion_tracking?.camera?.tilt_adjustment||Ye.tilt_adjustment;let r=s.enabled?s.angle*Math.PI/180:0;const _=a.motion_tracking?.ML_models?.pose||MMD_SA_options.user_camera.ML_models.pose;if(_.upper_rotation_offset){const p=_.upper_rotation_offset*Math.PI/180;r*=Math.cos(p)}const l=e.spine_rot_absolute[0]+r;this._neck._spine_rot_absolute=e.spine_rot_absolute.slice();this._neck._spine_rot_absolute[0]+=r;let c=M.filter(i.distanceTo(n)+o)/e.face_width/Math.max(Math.abs(Math.cos(l)));if(Le){window.addEventListener("SA_camera_facemesh_calibrating",()=>{qe.push(c);let e=parseInt(qe.length*.3);g=qe.sort((e,t)=>e-t).slice(e,qe.length-e).reduce((e,t)=>e+t)/(qe.length-e*2)},{once:true})}this._neck.data.length=0;if(!g)return false;let d=c/g;st[2]=!Je.shoulder_tracking||d>.95?0:(1-Math.max((d/.95-.8)/(1-.8),0))*Math.PI/8;if(t.is_pose)return true;return true}})(),get enabled(){return i},set enabled(e){if(i==!!e)return;i=!!e;B();this.busy=0;this.data_detected=0;E[0]=E[1]=.5;this._neck={data:[]};if(i){window.dispatchEvent(new CustomEvent("SA_camera_facemesh_on_enabled"));if(!this.initialized)y();o=MMD_SA_options.auto_blink;const t=Je.use_holistic_legacy?1:0;n(M!=t);M=t}else{MMD_SA_options.auto_blink=o}V()},get bb_center(){return E},set bb_center(e){E=e},reset_calibration:n,get frames(){return _t},init:y,worker_onmessage:v,camera_video_timestamp:0,update_frame:(()=>{let w,S;async function t(){var e=Ze.enabled&&Ze.worker_initialized&&F&&!Ze.busy&&!(Je.enabled&&Je.use_holistic)&&C&&Ze.camera_video_timestamp!=F;if(!e)return;Ze.busy=RAF_timestamp;Ze.camera_video_timestamp=F;Ze.camera_video_frame_id=L;if(Ue){MMD_SA_options.auto_blink=A||false}let o;let a,s;let r,_;let l,c;let t;o=Ye.video_canvas;let i=o.width,n=o.height;l=c=0;a=r=i;s=_=n;let d=1;let p=MMD_SA_options.user_camera.pixel_limit.facemesh;if(p){if(a*s>p[0]*p[1]){d=Math.sqrt(a*s/(p[0]*p[1]));a=r=Math.round(a/d);s=_=Math.round(s/d);o=P;t=true}}let m,u,f;if(MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio){m=MMD_SA_options.user_camera.pixel_limit.facemesh_bb_ratio;f=Math.round(Math.min(a,s)*m);r=f;_=f;w=m;if(!Ze.data_detected&&m<1&&!Je.enabled){w=S=1;t=true}else if(k>m/w){w=Math.min(k*1.5,1);t=true}if(S&&S!=w){const y=.05;if(w>S){w=Math.min(S+y,w)}else{w=Math.max(S-y,w)}t=true}S=w;if(t){f=Math.round(Math.min(a,s)*w);u=m/w;m=w;o=P}l=Math.max(Math.min(a*E[0]-f/2,a-f),0);c=Math.max(Math.min(s*E[1]-f/2,s-f),0)}let h=o.getContext("2d");if(t){h.globalCompositeOperation="copy";let e=l,t=c,i=r,n=_;if(u){i=n=f;if(o.width!=r||o.height!=_){o.width=r;o.height=_}}else{if(o.width!=r||o.height!=_){o.width=r;o.height=_;console.log("Facemesh canvas("+a+"x"+s+")")}}h.drawImage(Ye.video_canvas,Math.round(e*d),Math.round(t*d),Math.round(i*d),Math.round(n*d),0,0,r,_)}let M=H&&D?await createImageBitmap(o,t?0:l,t?0:c,r,_):h.getImageData(t?0:l,t?0:c,r,_).data.buffer;Ze._timestamp=Ye.video_timestamp_absolute;let g={rgba:M,w:a*(u||1),h:s*(u||1),options:{use_facemesh:true,draw_canvas:Ze.draw_canvas,flip_canvas:Ye.display_flipped,object_detection:{enabled:Ze.use_emotion_AI,detection_interval:Ze.emotion_AI_detection_interval/(lt.speed||1)},model_inference_device:Ze.model_inference_device,bb:{x:Math.round(l),y:Math.round(c),w:r,h:_,ratio:m||0,scale:u||1,timestamp:Ze._timestamp}}};if(Ze.draw_canvas){if(self.FacemeshAT){g.canvas=Ye.video_canvas_facemesh}else if(!Ye.video_canvas_facemesh._offscreen&&self.OffscreenCanvas){g.canvas=Ye.video_canvas_facemesh.transferControlToOffscreen();Ye.video_canvas_facemesh._offscreen=true;console.log("(Facemesh: use offscreen canvas)")}}else{const b=Object.assign({},g.options.bb);const v=1/b.scale;b.w*=v;b.h*=v;Ze.wireframe._data.bb=b}$e.postMessage(g,g.canvas?[g.canvas,g.rgba]:[g.rgba]);g.rgba=M=undefined;g=undefined}return function(e){if(e||self.FacemeshAT){setTimeout(()=>{t()},0)}else{t()}}})()};return Ze}(),poseNet:function(){var i=false;var C=true;var H=true;var o={};var t=null;var n=null;var a=null;var s=0;var r=0;var _=0;var l=null;var c=null;var d=0;var p;var m;var u,f,h,M;var g,y,b,v,w;var S;var A;let D={};let E={_default_:{}};let k="_default_";var x,P,R;var T,I;var z;var j;var F,L,B,O;var q;Je={get enabled(){return i},set enabled(e){if(i==!!e)return;i=!!e;dt=0;Qe=false;this.data_detected=0;this.initial_data_detected=false;_=0;THREE.MMD.getModels()[0].mesh.visible=true;Y.set(0,0,0);if(i){if(!this.initialized)ee();if($){worker_id=Je.use_holistic?"legacy_holistic":"tasks_vision";if(!X[worker_id]){Lt=[{},{}];U.terminate();for(const t in X)delete X[t];U=new Worker($);U.onmessage=Rt;K=worker_id;X[K]=new J(K,U)}console.log("Web worker ID:"+K);U=X[K].worker;Q=X[K].initialized}MMD_SA_options.user_camera.ML_models.pose.events.enabled&&MMD_SA_options.user_camera.ML_models.pose.events.enabled()}else{window.dispatchEvent(new CustomEvent("SA_camera_poseNet_on_disabled"));THREE.MMD.getModels()[0].resetPhysics();MMD_SA_options.user_camera.ML_models.pose.events.disabled&&MMD_SA_options.user_camera.ML_models.pose.events.disabled();MMD_SA.TEMP_v3.set(0,0,0);MMD_SA.Camera_MOD.adjust_camera("hip_camera",MMD_SA.TEMP_v3,MMD_SA.TEMP_v3)}V();if(Je.use_holistic){setTimeout(()=>{if(i)Ze.enabled=tt.enabled=true;else tt.enabled=false;DEBUG_show("(Holistic Mode:"+(i?"ON":"OFF")+")",2)},0)}},get pose_enabled(){return this.enabled&&!Ye.VMC_receiver.pose_enabled},get data_detected(){return s},set data_detected(e){this._RAF_timestamp=RAF_timestamp;if(e){if(!s){r=RAF_timestamp}if(this.data_detected_stable){_=0}}else{r=0;if(!_){_=RAF_timestamp}}s=e},get data_detected_stable(){return i&&(!_||this._RAF_timestamp-_<250/(lt.speed||1)||r&&this._RAF_timestamp-r>500/(lt.speed||1))},get no_pose_data(){return this.enabled&&Qe},get use_head_mocap(){return(!this.enabled||this.data_detected_stable)&&(Ze.enabled||!MMD_SA.MMD.motionManager.para_SA.is_custom_motion||!MMD_SA.vmd_by_filename[MMD_SA.MMD.motionManager.filename]?.morphKeys?.length)},get use_3D_pose(){return i&&C&&bt},set use_3D_pose(e){C=e},get use_holistic(){return t==null?Z:t},set use_holistic(e){t=e},get _use_holistic_(){return Z},set _use_holistic_(e){Z=e},get use_holistic_landmarker(){return this.use_holistic&&n},set use_holistic_landmarker(e){n=e;a=!e},get use_holistic_legacy(){return this.use_holistic&&a},set use_holistic_legacy(e){n=!e;a=e},get skip_hand_countdown_max(){return 0},set IK_disabled(e){H=e},get use_legIK(){return MMD_SA_options.user_camera.ML_models.pose.use_legIK||(this.enabled||Ye.VMC_receiver.pose_enabled)&&this.hip_adjustment_full_body_weighting_percent>0},set use_legIK(e){MMD_SA_options.user_camera.ML_models.pose.use_legIK=e},get auto_grounding(){return l!=null?l:MMD_SA_options.user_camera.ML_models.pose.auto_grounding||MMD_SA.WebXR.session},set auto_grounding(e){l=e},get ground_plane_visible(){return c!=null?c:!i||!!this.auto_grounding||MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only},set ground_plane_visible(e){c=e},get spine_length_ref(){if(d)return d;const e=MMD_SA.THREEX.get_model(0).para.spine_length;return e},set spine_length_ref(e){d=e},get shoulder_tracking(){return p==null?1:p},set shoulder_tracking(e){p=e},get hip_camera(){return m==null?false:m},set hip_camera(e){m=e;if(!e){MMD_SA.TEMP_v3.set(0,0,0);MMD_SA.Camera_MOD.adjust_camera("hip_camera",MMD_SA.TEMP_v3,MMD_SA.TEMP_v3)}},get hip_adjustment(){return E},set hip_adjustment(e){E=e||{_default_:{}}},get hip_adjustment_set_by_motion_name(){return D},set hip_adjustment_set_by_motion_name(e){D=e||{}},get hip_adjustment_set(){return k},set hip_adjustment_set(e){k=e&&MMD_SA.MMD.motionManager.filename=="stand_simple"&&!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only?"_default_full_body_":E[e]?e:D[e];if(!k)k="_default_";if(!E[k])E[k]={};({hip_adjustment_weight_percent:u,hip_adjustment_head_weight_percent:f,hip_adjustment_adjust_y_axis_percent:h,hip_adjustment_smoothing_percent:M,hip_adjustment_scale_x_percent:g,hip_adjustment_scale_y_percent:y,hip_adjustment_scale_z_percent:b,hip_adjustment_head_pitch_rotation_percent:v,hip_adjustment_head_chest_rotation_offset_percent:w,hip_adjustment_rotation_percent:S,hip_adjustment_full_body_weighting_percent:A}=E[k])},get hip_adjustment_weight_percent(){return u==null?100:u},set hip_adjustment_weight_percent(e){E[k].hip_adjustment_weight_percent=u=e},get hip_adjustment_head_weight_percent(){return f==null?100:f},set hip_adjustment_head_weight_percent(e){E[k].hip_adjustment_head_weight_percent=f=e},get hip_adjustment_adjust_y_axis_percent(){return h==null?66:h},set hip_adjustment_adjust_y_axis_percent(e){E[k].hip_adjustment_adjust_y_axis_percent=h=e},get hip_adjustment_scale_x_percent(){return g==null?100:g},set hip_adjustment_scale_x_percent(e){E[k].hip_adjustment_scale_x_percent=g=e},get hip_adjustment_scale_y_percent(){return y==null?100:y},set hip_adjustment_scale_y_percent(e){E[k].hip_adjustment_scale_y_percent=y=e},get hip_adjustment_head_pitch_rotation_percent(){return v==null?100:v},set hip_adjustment_head_pitch_rotation_percent(e){E[k].hip_adjustment_head_pitch_rotation_percent=v=e},get hip_adjustment_head_chest_rotation_offset_percent(){return w==null?20:w},set hip_adjustment_head_chest_rotation_offset_percent(e){E[k].hip_adjustment_head_chest_rotation_offset_percent=w=e},get hip_adjustment_scale_z_percent(){return b==null?100:b},set hip_adjustment_scale_z_percent(e){E[k].hip_adjustment_scale_z_percent=b=e},get hip_adjustment_smoothing_percent(){return M==null?0:M},set hip_adjustment_smoothing_percent(e){E[k].hip_adjustment_smoothing_percent=M=e},get hip_adjustment_rotation_percent(){return S==null?100:S},set hip_adjustment_rotation_percent(e){E[k].hip_adjustment_rotation_percent=S=e},get hip_adjustment_full_body_weighting_percent(){return A==null?0:A},set hip_adjustment_full_body_weighting_percent(e){E["_default_full_body_"].hip_adjustment_full_body_weighting_percent=A=e},get hip_depth_scale_percent(){return x==null?100:x},set hip_depth_scale_percent(e){x=e},get hip_z_position_offset_percent(){return P==null?0:P},set hip_z_position_offset_percent(e){P=e},get hip_y_position_offset_percent(){return R==null?0:R},set hip_y_position_offset_percent(e){R=e},get limb_entry_duration_percent(){return T==null?100:T},set limb_entry_duration_percent(e){T=e},get limb_return_duration_percent(){return I==null?100:I},set limb_return_duration_percent(e){I=e},get hide_avatar_on_tracking_loss(){return z==null?1:z},set hide_avatar_on_tracking_loss(e){z=e},auto_scale_property:function(e,t,i){if(i===false)return e;let n,o;if(t.indexOf("腕")!=-1){n="left_arm_length";o=5.153592238246502}else if(t.indexOf("手首")!=-1){n="left_palm_length";o=.9020481908808872}else if(t.indexOf("上半身")!=-1){n="spine_length";o=4.97462}else if(t=="ROOT"){n="left_leg_length";o=10.569580078125}else{return e}let a=.9;let s=typeof i=="number"?i:1;let r=MMD_SA.THREEX.get_model(0).para[n]/o;r=r>1?Math.max(r*a,1):Math.min(r/a,1);r=1+(r-1)*s;return Array.isArray(e)?e.map(e=>e*r):e*r},body_collider:{get mode(){return j==null?1:j},set mode(e){j=e;if(Je.enabled){_t.reset()}},get enabled(){return this.mode>0&&["head","chest","waist","hip"].some(e=>this[e].enabled)},get active(){return this.enabled&&(Je.pose_enabled?Je._upper_body_only_mode||this.mode>1:false)},head:{get enabled(){return!!this.size_percent},get size_percent(){return F==null?0:F},set size_percent(e){F=e},get reaction_type(){return q==null?"z_push":q},set reaction_type(e){q=e}},chest:{get enabled(){return!!this.size_percent},get size_percent(){return L==null?125:L},set size_percent(e){L=e}},waist:{get enabled(){return!!this.size_percent},get size_percent(){return B==null?100:B},set size_percent(e){B=e}},hip:{get enabled(){return!!this.size_percent},get size_percent(){return O==null?100:O},set size_percent(e){O=e}}},IK_disabled_check:function(){var n=new RegExp("("+toRegExp(["腕ＩＫ","足ＩＫ","つま先ＩＫ"],"|")+")$");var e=new RegExp("("+toRegExp(["腕ＩＫ"],"|")+")$");return function(e){const t=MMD_SA.MMD.motionManager.para_SA;if(!H||!t.motion_tracking_enabled||!this.data_detected&&!Ye.VMC_receiver.mocap_enabled&&(this.enabled||!Ze.enabled||!Ze.data_detected))return null;let i=!e||n.test(e);if(i&&e){if(o[e])i=false}return i}}(),enable_IK:function(e,t){if(!e){o={}}else{o[e]=t}},get frames(){return _t},camera_video_timestamp:0,get busy(){return dt},get initialized(){return G},get worker_initialized(){return Q},set worker_initialized(e){Q=e;if(!self.PoseAT)X[K].initialized=e}};return Je}(),object_detection:(()=>{let t=true;let i;let r={};let _={};const e={MediaPipe:{"efficientdet_lite0_INT8.tflite":{option_name:"①EfficientDet-Lite0 (CPU)"},"efficientdet_lite0_FP32.tflite":{option_name:"②EfficientDet-Lite0 (GPU)"},"efficientdet_lite2_INT8.tflite":{option_name:"③EfficientDet-Lite2 (CPU)"},"efficientdet_lite2_FP32.tflite":{option_name:"④EfficientDet-Lite2 (GPU)"}},"Transformers.js":{"onnx-community/yolov10s":{option_name:"①YOLOv10 Small (GPU)"},"onnx-community/yolov10m":{option_name:"②YOLOv10 Medium (GPU)"}}};const n={MediaPipe:{"efficientnet_lite0_INT8.tflite":{option_name:"①EfficientNet-Lite0 (CPU)"},"efficientnet_lite2_INT8.tflite":{option_name:"②EfficientNet-Lite2 (CPU)"}},"Transformers.js":{"Xenova/mobilevit-small":{option_name:"①MobileViT Small (GPU)"},"Xenova/convnextv2-tiny-22k-224":{option_name:"②ConvNeXt V2 Tiny (GPU)"},"onnx-community/dinov2-with-registers-small-imagenet1k-1-layer":{option_name:"③DINOv2+registers S (GPU)"}}};window.addEventListener("SA_camera_poseNet_on_disabled",()=>{i=null;r={}});let o,a;let s,l;let c,d;let p;et={get enabled(){return t&&Je.enabled&&Object.keys(_).length},set enabled(e){t=e},get _enabled(){return t},framework_model:e,framework_model_classification:n,get data(){if(!this.enabled){i=null;r={}}return i},set data(e){i=e},get data_by_class_name(){return r},set data_by_class_name(e){r=e},get options_by_class_name(){return _},set options_by_class_name(e){_=e},get detection_score_threshold_percent(){return c==null?50:c},set detection_score_threshold_percent(e){c=e},get tracking_score_threshold_percent(){return d==null?20:d},set tracking_score_threshold_percent(e){d=e},get framework(){return o==null?"MediaPipe":o},set framework(e){o=e},get model(){return a==null?this.framework=="MediaPipe"?"efficientdet_lite0_INT8.tflite":"onnx-community/yolov10s":a},set model(e){a=e},get framework_classification(){return s==null?"MediaPipe":s},set framework_classification(e){s=e},get model_classification(){return l==null?this.framework_classification=="MediaPipe"?"efficientnet_lite0_INT8.tflite":"onnx-community/yolov10s":l},set model_classification(e){l=e},get detection_interval(){return p==null?500:p},set detection_interval(e){p=e},get_options:function(){return this.enabled?{enabled:true,framework:this.framework,model:this.model,framework_classification:this.framework_classification,model_classification:this.model_classification,detection_interval:this.detection_interval,categoryAllowlist:Object.keys(_)}:null},process:function(s){if(!this.enabled)return;i=s;let n=Object.keys(r);if(s){if(!s._detections_cleaned){s._detections_cleaned=true;const o={};s.detections=s.detections.filter(e=>{const t=e.categories[0].categoryName;if(o[t])return false;o[t]=(o[t]||0)+1;let i=r[t]?_[t]?.tracking_score_threshold_percent||this.tracking_score_threshold_percent:_[t]?.detection_score_threshold_percent||this.detection_score_threshold_percent;return e.categories[0].score>i/100})}s.detections.forEach(e=>{const t=e.categories[0].categoryName;const i=r[t]=r[t]||{};if(!i.detection_id||i.detection_id!=s.detection_id){i.detection_id=s.detection_id;i.hand=e._hand;i.frames_hidden=0;n=n.filter(e=>e!=t)}})}n.forEach(e=>{const t=r[e];if(!t)return;let i;if(!s){i=true}else{const n=_[e];const o=n?.hide_on_frames_hidden;if(!n?.ignore_hand&&!o&&s.hand_visible.findIndex(e=>e==t.hand)==-1){i=true}else{if(t.detection_id!=s.detection_id){t.frames_hidden++;if(o){const a=1e3/(this.detection_interval||50);let e=Math.round(Math.max(t.frames_hidden/20-1/a,0)*a)}else if(n?.ignore_hand&&(n.ignore_hand===true?s.hand_visible.length<2:s.hand_visible.findIndex(e=>e!=n.ignore_hand)==-1)){i=true}}}}if(i){r[e]=null}})}};return et})(),VMC_receiver:(()=>{class I{constructor(e){this.index=e;this.VMC=new MMD_SA.OSC.VMC_class({plugin:{open:{port:this.config.port}}})}get config(){return I.options.receiver[this.index]}#_enabled=false;#_initialized=false;get enabled(){return this.#_enabled}set enabled(e){this.config.enabled=!!e;if(L.enabled){if(!e&&L.receiver.every(e=>!e.config.enabled)){L.enabled=false;return}}else{if(e){L.enabled=true;return}}if(!this.VMC.vmc){this.#_initialized=false}this.#_enabled=this.VMC.receiver_enabled=!!e;this.reset();if(e){if(!this.#_initialized){this.#_initialized=true;System._browser.on_animation_update.add(()=>{this.VMC.vmc.on("/VMC/Ext/Bone/Pos",e=>{this.process_bones(e)});this.VMC.vmc.on("/VMC/Ext/Blend/Val",e=>{this.process_expressions(e)});this.VMC.vmc.on("/VMC/Ext/Root/Pos",e=>{this.process_root(e)})},0,0)}}}reset(){this.timestamp=0;this.expression_timestamp=0;I._expression={};T.set(0,0,0,1);for(const e of["左","右"]){F[e].set(0,0,0,1)}z.set(0,0,0);j.set(0,0,0,1);_t.reset()}get active(){return this.enabled&&this.timestamp}get pose_enabled(){return this.enabled&&this.config.pose}get pose_upper_body(){return this.enabled&&this.config.pose==1}get pose_full_body(){return this.enabled&&this.config.pose==2}get hand_independent(){return this.enabled&&!this.config.pose&&this.config.hand||0}get face_independent(){return this.enabled&&!this.config.pose&&this.config.face||0}get expression_active(){return this.enabled&&this.expression_timestamp}get expression_independent(){this.enabled&&this.config.face}static _name_skipped={};static _expression={};process_expressions(e){if(!this.enabled)return;if(!this.config.face&&!this.config.pose)return;if(!this.config.face&&L.expression_independent)return;if(Ze.enabled&&!L.mocap_expression_constraint)return;const[t,i]=e.args;let n=t.charAt(0).toLowerCase()+t.substring(1);let o=MMD_SA.THREEX.get_model(0).blendshape_map_name(n,1);if(o==n)o=t;if(Ze.enabled&&L.mocap_expression_constraint==1&&!/jaw|mouth|aa|ih|ou|ee|oh/i.test(o))return;let a=RAF_timestamp-(_t.skin[o]?.[0].timestamp||RAF_timestamp);if(a<1e3/45)a=1e3/60;I._expression[o]=i;_t.add("morph|facemesh",o,{weight:i});this.expression_timestamp=RAF_timestamp}#turn_active(){const e=!this.timestamp;this.timestamp=RAF_timestamp;if(e){if(I.receiver.some(e=>e.pose_full_body)){MMD_SA_options.Dungeon_options.item_base.pose?._change_motion_(0,true)}else if(L.bone_enabled){if(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only)MMD_SA_options.Dungeon_options.item_base.pose?._change_motion_(1,true)}}}process_root(e){if(!this.enabled)return;if(this.config.pose!=2)return;const[t,i,n,o,a,s,r,_]=e.args;j.set(-a,-s,r,_);z.set(-i,n,o).multiplyScalar(MMD_SA.THREEX.VRM.vrm_scale)}process_bones(e){if(!this.enabled)return;const[i,t,n,o,a,s,r,_]=e.args;let l;let c,d;const p=/Metacarpal|Proximal|Intermediate|Distal/i.test(i);const m=/hand/i.test(i);const u=/neck/i.test(i);const f=/head/i.test(i);const h=[];const M=[];if(this.pose_enabled){l=MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only||this.pose_upper_body;if(l)M.push(!/leg|foot|toe/i.test(i));let e=tt.enabled?tt.wrist_enabled?2:1:L.hand_independent;if(e){M.push(!p);if(e>1)M.push(!m)}let t=Ze.enabled&&!L.mocap_head_constraint?2:L.face_independent;if(t)h.push(f||(t>2?false:u));if(M.length&&!M.every(e=>e))return;if(h.length&&h.some(e=>e))return}else{let e;c=this.hand_independent>1;let t=this.face_independent;d=t>1;if(this.config.hand){if(!tt.enabled){M.push(p)}else{e=p}if(c&&!tt.wrist_enabled){M.push(m)}}if(this.config.face&&d){const E=f||(t>2?u:false);if(!Ze.enabled||L.mocap_head_constraint){M.push(E)}else{e=E}}if(!M.some(e=>e)){if(e)this.#turn_active();return}}let g=i;if(g.indexOf("ThumbMetacarpal")!=-1){this.use_VRM1_bone_name=true}else if(g.indexOf("ThumbIntermediate")!=-1){this.use_VRM1_bone_name=false}if(!this.use_VRM1_bone_name)g=MMD_SA.THREEX.VRM.bone_map_VRM0_to_VRM1[g];g=g.charAt(0).toLowerCase()+g.substring(1);const y=MMD_SA.THREEX.VRM.bone_map_VRM_to_MMD[g];if(!y){I._name_skipped[y]=true;return}const b=MMD_SA.THREEX.get_model(0);const v=new THREE.Quaternion(-a,-s,r,_);b.process_rotation(v);let w,S;if(y=="センター"&&!l){const k=THREE.MMD.getModels()[0].mesh;const x=MMD_SA_options.model_para_obj_all[b.index];const P=b.para.left_leg_length/x.left_leg_length;w=new THREE.Vector3(t,n,-o);b.process_position(w);w.sub(MMD_SA.TEMP_v3.fromArray(b.para.pos0["hips"])).multiplyScalar(1/P).multiplyScalar(MMD_SA.THREEX.VRM.vrm_scale).add(MMD_SA.TEMP_v3.fromArray(k.geometry.bones[k.bones_by_name["センター"]._index].pos));const R=MMD_SA._v3a.fromArray(x._hip_offset["センター"]);w.sub(MMD_SA._v3b.copy(R).applyQuaternion(v).sub(R));w.applyQuaternion(j);v.premultiply(b.process_rotation(MMD_SA.TEMP_q.copy(j)));w.add(z);S=new THREE.Vector3}let A=RAF_timestamp-(_t.skin[y]?.[0].timestamp||RAF_timestamp);if(A<1e3/45)A=1e3/60;const D=l?!/hip|spine|chest|neck|head/i.test(i):true;_t.add("skin",y,{no_blending:false,blending_ratio:1,t_delta_frame:A,absolute:D,rot:v,pos:w,_pos_center:S,reset_id:"VMC"});if(S)S.copy(w);if(c&&y.indexOf("手首")!=-1){const T=_t.skin[y];T[0].after_IK=true;T[0].onProcessRotation=zt}if(y=="頭"){const T=_t.skin[y];T[0].after_IK=true;T[0]._rot_chest_offset=T[1]._rot_chest_offset;T[0].onProcessRotation=Et}this.#turn_active()}static receiver=[];static options={receiver:[]};static receiver_max=4;static initialized=false;static init(){if(I.initialized)return;I.initialized=true;for(let e=0;e<I.receiver_max;e++){const t=I.receiver[e]=new I(e)}window.addEventListener("SA_camera_facemesh_on_enabled",()=>{I._expression={}})}static preprocess(){function t(e){if(!e)return;if(e[0].no_blending)return e[0].rot;const t=e[0].t_delta+RAF_timestamp_delta;let i=Math.max(Math.min(t/e[0].t_delta_frame,1),0);return i==1?e[0].rot:MMD_SA.TEMP_q.copy(e[1].rot).slerp(e[0].rot,i)}const i=THREE.MMD.getModels()[0].mesh.bones_by_name;const e=MMD_SA.THREEX.get_model(0);let n;if(L.pose_enabled){Je.enable_IK();const o=L.pose_upper_body;if(o){const _=_t.skin["センター"];if(_){const l=_t.skin["上半身"];if(l){for(let e=0;e<2;e++){E[e].copy(_[e].rot);k[e].copy(l[e].rot);if(e==0||l[0].rot!=l[1].rot){l[e].rot.premultiply(_[e].rot)}if(e==1||_[0].rot!=_[1].rot){_[e].rot.set(0,0,0,1)}}System._browser.on_animation_update.add(()=>{for(let e=0;e<2;e++){_[e].rot.copy(E[e]);l[e].rot.copy(k[e])}},0,1)}}}const a=_t.skin["上半身2"];const s=_t.skin["上半身3"];if(a&&s){for(let e=0;e<2;e++){x[e].copy(a[e].rot);P[e].copy(s[e].rot);if(e==0||a[0].rot!=a[1].rot){a[e].rot.multiply(s[e].rot)}if(e==1||s[0].rot!=s[1].rot){s[e].rot.set(0,0,0,1)}}System._browser.on_animation_update.add(()=>{for(let e=0;e<2;e++){_t.skin["上半身2"]?.[e].rot.copy(x[e]);_t.skin["上半身3"]?.[e].rot.copy(P[e])}},0,1)}if(a){a[0].rot_append=_t.skin["頭"]?.[0]._rot_chest_offset||_t.skin["首"]?.[0]._rot_chest_offset}T.set(0,0,0,1);const r=MMD_SA._q2.set(0,0,0,1);for(const c of["センター","上半身","上半身2"]){const d=_t.skin[c];if(!d)continue;const p=t(d);T.multiply(p);if(c=="センター")r.copy(p)}if(o||1){for(const m of["左","右"]){const u=m=="左"?"left":"right";const p=MMD_SA._q1.copy(T);let e=_t.skin[m+"肩"];if(e){p.multiply(MMD_SA.TEMP_q.fromArray(MMD_SA.THREEX.utils.convert_T_pose_rotation_to_A_pose(m+"肩",t(e).toArray())))}e=_t.skin[m+"腕"];if(e){p.multiply(MMD_SA.TEMP_q.fromArray(MMD_SA.THREEX.utils.convert_T_pose_rotation_to_A_pose(m+"腕",t(e).toArray())))}const f=MMD_SA.TEMP_v3.fromArray(i[m+"ひじ"].pmxBone.origin).sub(MMD_SA._v3b.fromArray(i[m+"腕"].pmxBone.origin)).applyQuaternion(p);e=_t.skin[m+"ひじ"];if(e){p.multiply(MMD_SA.TEMP_q.fromArray(MMD_SA.THREEX.utils.convert_T_pose_rotation_to_A_pose(m+"ひじ",t(e).toArray())))}const h=MMD_SA._v3a.fromArray(i[m+"手首"].pmxBone.origin).sub(MMD_SA._v3b.fromArray(i[m+"ひじ"].pmxBone.origin)).applyQuaternion(p);const M=h.clone().add(f);Je.enable_IK(m+"腕ＩＫ",true);_t.add("skin",m+"腕ＩＫ",{no_blending:false,blending_ratio:1,t_delta_frame:RAF_timestamp_delta,priority:999,pos:M,_IK_absolute:false,_hand_visible:true,_pos0:null,onProcessPosition:jt});const g=!tt.wrist_enabled&&_t.skin[m+"手首"];if(g){const y=g[0];F[m].set(0,0,0,1);for(const c of["肩","腕","ひじ"]){const d=_t.skin[m+c];if(d)F[m].multiply(t(d))}y.after_IK=true;y.onProcessRotation=zt;const b=m=="左"?1:-1;const v=MMD_SA.THREEX.q1.copy(T).multiply(F[m]);const w=MMD_SA.THREEX.q2.copy(MMD_SA_options.model_para_obj.rot_hand_adjust_base[b]).conjugate();const S=g[0]==g[1]?1:2;for(let e=0;e<S;e++){R[m][e].copy(g[e].rot);g[e].rot.premultiply(v).multiply(w)}System._browser.on_animation_update.add(()=>{for(let e=0;e<S;e++){_t.skin[m+"手首"]?.[e].rot.copy(R[m][e])}},0,1)}}}else{for(const m of["左","右"]){Je.enable_IK(m+"腕ＩＫ",false);_t.remove("skin",m+"腕ＩＫ")}}if(o){n=true}else if(Je.use_legIK){for(const m of["左","右"]){const u=m=="左"?"left":"right";const b=m=="左"?1:-1;const p=MMD_SA._q1.copy(r);let e=_t.skin[m+"足"];if(e){p.multiply(t(e))}const A=MMD_SA.TEMP_v3.fromArray(i[m+"ひざ"].pmxBone.origin).sub(MMD_SA._v3b.fromArray(i[m+"足"].pmxBone.origin)).applyQuaternion(p);e=_t.skin[m+"ひざ"];if(e){p.multiply(t(e))}const D=MMD_SA._v3a.fromArray(i[m+"足首"].pmxBone.origin).sub(MMD_SA._v3b.fromArray(i[m+"ひざ"].pmxBone.origin)).applyQuaternion(p);const M=D.clone().add(A);M.add(MMD_SA_options.model_para_obj.leg_IK_offset[m]);Je.enable_IK(m+"足ＩＫ",true);_t.add("skin",m+"足ＩＫ",{no_blending:false,blending_ratio:1,t_delta_frame:RAF_timestamp_delta,absolute:true,pos:M,rot:null,priority:999,onFinish:Tt})}}else{for(const m of["左","右"]){Je.enable_IK(m+"足ＩＫ",false);_t.remove("skin",m+"足ＩＫ")}}}else{n=L.face_independent>1;if(n){xt()}}if(n){for(const m of["左","右"]){Je.enable_IK(m+"足ＩＫ",true);_t.add("skin",m+"足ＩＫ",{is_dummy:true,pos:true,priority:999});_t.add("skin",m+"足",{is_dummy:true,rot:true});_t.add("skin",m+"ひざ",{is_dummy:true,rot:true});_t.add("skin",m+"足首",{is_dummy:true,after_IK:true,rot:true})}}}static reset(){if(!L.enabled)return;System._browser.on_animation_update.add(()=>{I.receiver.forEach(e=>{if(e.enabled)e.reset()})},0,0)}}for(let e=0;e<I.receiver_max;e++){I.options.receiver[e]={enabled:false,port:39540+e,port_default:39540+e,face:0,pose:0,hand:0}}const E=[];const k=[];const x=[];const P=[];const R={};let z;let j;let T;const F={};window.addEventListener("jThree_ready",()=>{for(let e=0;e<2;e++){E[e]=new THREE.Quaternion;k[e]=new THREE.Quaternion;x[e]=new THREE.Quaternion;P[e]=new THREE.Quaternion}for(const t of["左","右"]){R[t]=[];for(let e=0;e<2;e++){R[t][e]=new THREE.Quaternion}}z=new THREE.Vector3;j=new THREE.Quaternion;T=new THREE.Quaternion;for(const t of["左","右"]){F[t]=new THREE.Quaternion}});let t;const L={init:function(){I.init()},reset:function(){I.reset()},get enabled(){return t},set enabled(e){if(!!e==t)return;t=!!e;if(t){this.init();I.receiver.forEach(e=>{e.enabled=e.config.enabled});_t.add_events();System._browser.on_animation_update.remove(I.preprocess,0);System._browser.on_animation_update.add(I.preprocess,0,0,-1)}else{I.receiver.forEach(e=>{e.enabled=false});System._browser.on_animation_update.remove(I.preprocess,0);if(!Ye.mocap_enabled)_t.remove_events()}DEBUG_show("VMC receiver:"+(t?"ON":"OFF"),3)},get receiver(){return I.receiver},get receiver_max(){return I.receiver_max},get options(){return I.options},get _name_skipped(){return I._name_skipped},get active(){if(!I.initialized)return false;return I.receiver.some(e=>e.active)},get expression_active(){if(!I.initialized)return false;return I.receiver.some(e=>e.expression_active)},get pose_enabled(){if(!I.initialized)return false;return I.receiver.some(e=>e.active&&e.pose_enabled)},get pose_upper_body(){if(!I.initialized)return false;return!this.pose_enabled||MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only||I.receiver.some(e=>e.pose_upper_body)},get pose_full_body(){if(!I.initialized)return false;return this.pose_enabled&&(!MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only||I.receiver.some(e=>e.pose_full_body))},get mocap_enabled(){if(!I.initialized)return false;return this.pose_enabled||I.receiver.some(e=>e.active&&e.config.face>1)},get bone_enabled(){if(!I.initialized)return false;return this.mocap_enabled||I.receiver.some(e=>e.active&&e.config.hand)},get hand_enabled(){if(!I.initialized)return false;return I.receiver.some(e=>e.active&&(e.config.pose||e.config.hand))},get hand_independent(){if(!I.initialized)return false;return I.receiver.find(e=>e.hand_independent)?.hand_independent||0},get face_independent(){if(!I.initialized)return false;return I.receiver.find(e=>e.face_independent)?.face_independent||0},get expression_independent(){if(!I.initialized)return false;return I.receiver.find(e=>e.expression_independent)},get vowel_max(){if(!I.initialized)return 0;let e=0;for(const t of["aa","ih","ou","ee","oh"])e=Math.max(I._expression[t]||0,e);return e},get head_pose_relative(){if(!I.initialized)return false;return!I.receiver.some(e=>e.active&&e.config.face==2)},get wrist_pose_relative(){if(!I.initialized)return false;return I.receiver.some(e=>e.active&&e.config.hand>2)},get rot_body(){return T},get rot_arm(){return F},get mocap_wrist_constraint(){if(!I.initialized||!I.receiver.some(e=>e.active))return false;if(this.config.mocap_wrist_constraint)return true;return false},get mocap_head_constraint(){if(!I.initialized||!I.receiver.some(e=>e.active))return false;if(this.config.mocap_head_constraint)return true;return false},get mocap_expression_constraint(){if(!I.initialized||!I.receiver.some(e=>e.enabled&&(e.config.pose||e.config.face)))return 0;return this.config.mocap_expression_constraint||0},get prop_mocap_factor_percent(){return this.config.prop_mocap_factor_percent},config:{prop_mocap_factor_percent:50}};return L})(),handpose:function(){var t=false;var i={};var n={};var o,a;var s;tt={get enabled(){return t},set enabled(e){if(t==!!e)return;t=!!e;if(t){i={};n={};if(!this.initialized)ee()}},get wrist_enabled(){return this.enabled&&!Ye.VMC_receiver.mocap_wrist_constraint},get hand_visible_timestamp(){return i},get hand_visible_session(){return n},get frames(){return _t},get busy(){return dt},get initialized(){return G},get worker_initialized(){return Q},set worker_initialized(e){Q=X[K].initialized=e},get stabilize_arm(){return o==null?2:o},set stabilize_arm(e){o=e},get stabilize_arm_time(){return a==null?0:a},set stabilize_arm_time(e){a=e},get stabilize_hand_percent(){return s==null?20:s},set stabilize_hand_percent(e){s=e},_hand_last:{"左":{},"右":{}}};return tt}(),reset_video_canvas:function(){if(this.video_canvas){this.video_canvas.width=this.video_canvas.height=F=0;L=""}},show:function(){if(!this.initialized||this.visible)return;this.visible=true;if(Ye.target_devicePixelRatio!=window.devicePixelRatio){Ye.target_devicePixelRatio=0;Ye.video_track.applyConstraints(Ye.set_constraints()).then(function(){DEBUG_show("(camera size updated)",2)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update")})}a();if(this.hidden_enforced){this.hide()}},hide:function(){if(!this.initialized||!this.visible)return;this.visible=false;this.video_canvas.style.visibility="hidden";d.enabled=false;p.enabled=false;s()},set_constraints:function(e){var t={};const i=window.devicePixelRatio/this.target_devicePixelRatio;let n,o;const a=is_mobile?Math.min(270/Math.min(window.innerWidth,window.innerHeight),i):i;n=Math.round(window.innerWidth*a);o=Math.round(window.innerHeight*a);let s=MMD_SA_options.user_camera.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_;if(!c){if(MMD_SA_options.user_camera.pixel_limit.fixed){n=s[0];o=s[1]}else if(n*o>s[0]*s[1]){const r=Math.sqrt(n*o/(s[0]*s[1]));n=Math.round(n/r);o=Math.round(o/r)}}Ye.target_width=n;Ye.target_height=o;if(!MMD_SA_options.user_camera.pixel_limit.disabled){let e=!is_mobile||!screen.orientation||/landscape/.test(screen.orientation.type);if(MMD_SA_options.user_camera.portrait_mode==1)e=!e;if(e){t.width=n;t.height=o}else{t.width=o;t.height=n;if(MMD_SA_options.user_camera.portrait_mode==1){Ye.target_width=o;Ye.target_height=n}}}t.frameRate=MMD_SA_options.user_camera.fps||{ideal:30};if(e)t=Object.assign(t,e);console.log("Camera constraints",t);return t}};Object.defineProperty(Ye,"video_timestamp_absolute",(()=>{let t=0;window.addEventListener("jThree_ready",()=>{timestamp_base=RAF_timestamp;System._browser.on_animation_update.add(()=>{let e=1;if(!Ye.video||!Ye.initialized||!Ye.ML_enabled){e=1}else if(Ye.video?.paused){e=0}else if(Ye.video.currentTime==null){e=.5}else if(lt.speed){e=lt.speed}t+=RAF_timestamp_delta*e},0,0,-1)});return{get:function(){return t}}})());return Ye}(),data_filter:function(){class e{constructor(){}filter(e){return e}}class o{constructor(e){this.filters=e;e.forEach(e=>{switch(e.type){case"one_euro":if(e.transition_time){e.para[1]=o.calculate_one_euro_minCutoff_from_transition_time(e.transition_time)}e.filter=new OneEuroFilter(...e.para||[]);break}if(e.id)e.filter.id=e.id})}static calculate_one_euro_minCutoff_from_transition_time(e){return 1/(1/(1/e/60)-1)*60/(2*Math.PI)}static#get_timestamp(){return System._browser.camera.video_timestamp_absolute}filter(t,i=o.#get_timestamp(),n=1){if(t!=null){if(Array.isArray(t)?t.some(e=>isNaN(e)):isNaN(t)){console.error("Data filter error",this.filters[0].id);return t}this.filters.forEach(e=>{if(!e.condition||e.condition()){this.data=e.filter.filter(t,i,n);this.timestamp=RAF_timestamp}})}else{if(i!=null){if(i===true)i=o.#get_timestamp();this.filters.forEach(e=>{e.filter.lasttime=i;if(this.timestamp!=null)this.timestamp=RAF_timestamp})}}return this.data}}return o}(),motion_control:function(){var s,m,p,i,_,u;var d;var f;var h=function(){var r={};var a={};return{pressed:r,map:a,temp:{},set_options:function(e){if(!l)return;if(!e.timeout_list){const t=["W","A","S","D"];for(const i of["L","R"]){for(const n in e[i]){const o=e[i][n];if(o.press)t.push(...o.press)}}e.timeout_list=t.map(e=>u[e])}if(!e.clear_list)e.clear_list={};for(const i of["L","R"]){if(!e.clear_list[i]){const t=i=="L"?["W","A","S","D"]:[];for(const n in e[i]){const o=e[i][n];if(o.press)t.push(...o.press)}e.clear_list[i]=t.map(e=>[u[e]])}}this.temp={};Object.assign(a,e);console.log(a)},action:function(e,t,i){var n=a[t][i]||{};return{press:n.press&&(!n.press_check||n.press_check(e))&&n.press||[],release:n.release||[],click:n.click&&(!n.click_check||n.click_check(e))&&n.click||[]}},activate:async function(e,t,i,n=[]){const o=this.action(e,t,i);if(o.click.length)await h.click(...o.click.map(e=>[u[e]]));if(o.press.length){const a=o.press.map(e=>u[e]);n=[...n.filter(e=>a.indexOf(e[0])==-1),...o.release.map(e=>[u[e]])];if(n.length)await h.releaseKey(...n);await h.pressKey(...a.map(e=>[e]))}},clear_list:function(e){return a.clear_list[e]},pressKey:async function(...e){let t=Array.isArray(e[0])&&e||[e];var i=[];for(const n of t){const o=n.filter(e=>!r[e]);if(o.length){for(const s of o)r[s]=-1;await _.pressKey(...o);const a=o.filter(e=>r[e]==-2);if(a.length){await _.releaseKey(...a);for(const s of a)r[s]=0;console.log("key released enforced",a.length)}}for(const s of n){if(r[s])r[s]=RAF_timestamp}}},releaseKey:async function(...e){const t=!e.length?Object.keys(r).map(e=>[parseInt(e)]):Array.isArray(e[0])&&e||[e];const i=[];for(const n of t){const o=n.filter(e=>r[e]>0);if(o.length){i.push(_.releaseKey(...o).then(()=>{for(const e of o)r[e]=0}))}const a=n.filter(e=>r[e]<0);a.forEach(e=>{r[e]=-2})}if(i.length){await Promise.all(i)}},releaseIdleKey:async function(...e){const t=!e.length?Object.keys(r).map(e=>[parseInt(e)]):Array.isArray(e[0])&&e||[e];const i=t.map(e=>e.filter(e=>r[e]&&(a.timeout_list.indexOf(e)==-1||RAF_timestamp-(r[e]>0?r[e]:RAF_timestamp)>500))).filter(e=>e.length);if(i.length){await h.releaseKey(...i)}},click:async function(...e){const t=Array.isArray(e[0])&&e||[e];await this.pressKey(...t);await this.releaseKey(...t)}}}();var M={custom:{},list:[],estimate:function(e,t,i=9){const n=e.estimate(t.keypoints,i);if(n.gestures.length){n.gestures.forEach(e=>{e._d=t._d;e.hand_facing=this.list[0].hand_facing[t._d];e.hand_rot_YXZ=this.list[0].hand_rot_YXZ[t._d];e.thumb_out=this.list[0].thumb_out[t._d];e.poseData=n.poseData});this.list[0].gestures=this.list[0].gestures.concat(n.gestures)}return n},search:function(i,o={}){function a(e){return e.gestures.find(t=>i.split("|").some(e=>t.name==e&&(!o.hand||o.hand._d==t._d)&&(!o.hand_facing||o.hand_facing===t.hand_facing)&&(o.thumb_out==null||o.thumb_out===t.thumb_out)&&(!o.condition||t._condition_passed||o.condition(t)&&(t._condition_passed=true))))}var e=o.time_limit||0;var t;for(let i=0,n=this.list.length;i<n;i++){const s=this.list[i];if(s.timestamp<RAF_timestamp-e)break;const r=a(s);if(!r)continue;if(o.duration&&i<n-1){let e=s.timestamp-this.list[i+1].timestamp;let t;for(t=i+1;t<n;t++){const _=this.list[t];if(a(_)){e=t==n-1?9999:s.timestamp-this.list[t+1].timestamp;if(e>=o.duration)break}else break}if(e<o.duration){i=t;continue}}t=r;t.search_para=Object.assign({},o);break}return t}};var g,y,b,v;var e,t,n,o;var a=false;var l,c;var r=false;var w;var S=true;async function A(){async function e(){if(l)return;l=true;g=new THREE.Vector3;y=new THREE.Vector3;b=new THREE.Vector3;v=new THREE.Vector3;c=true;await System._browser.load_script("js/fingerpose.js");const t=new fp.GestureDescription("index_up");t.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);t.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){t.addCurl(e,fp.FingerCurl.FullCurl,1);t.addCurl(e,fp.FingerCurl.HalfCurl,.9)}M.custom.index_up=t;const i=new fp.GestureDescription("index_thumb");i.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);i.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalLeft,1);i.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalRight,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){i.addCurl(e,fp.FingerCurl.FullCurl,1);i.addCurl(e,fp.FingerCurl.HalfCurl,.9)}M.custom.index_thumb=i;const n=new fp.GestureDescription("index_middle");n.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,1);n.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpRight,1);n.addCurl(fp.Finger.Middle,fp.FingerCurl.NoCurl,1);n.addDirection(fp.Finger.Middle,fp.FingerDirection.VerticalUp,1);n.addDirection(fp.Finger.Middle,fp.FingerDirection.DiagonalUpLeft,1);n.addDirection(fp.Finger.Middle,fp.FingerDirection.DiagonalUpRight,1);for(let e of[fp.Finger.Ring,fp.Finger.Pinky]){n.addCurl(e,fp.FingerCurl.FullCurl,1);n.addCurl(e,fp.FingerCurl.HalfCurl,.9)}M.custom.index_middle=n;const o=new fp.GestureDescription("index_pinky");o.addCurl(fp.Finger.Index,fp.FingerCurl.NoCurl,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.VerticalUp,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpLeft,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.DiagonalUpRight,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalLeft,1);o.addDirection(fp.Finger.Index,fp.FingerDirection.HorizontalRight,1);o.addCurl(fp.Finger.Pinky,fp.FingerCurl.NoCurl,1);for(let e of[fp.Finger.Middle,fp.Finger.Ring]){o.addCurl(e,fp.FingerCurl.FullCurl,1);o.addCurl(e,fp.FingerCurl.HalfCurl,.9)}M.custom.index_pinky=o;for(const a of["thumb","thumb_index","thumb_palm"]){const s=new fp.GestureDescription(a);for(const r of[fp.Finger.Index,fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){const _=a=="thumb_palm"||(r==fp.Finger.Index?a=="thumb_index":false);if(_){s.addCurl(r,fp.FingerCurl.NoCurl,1);if(a=="thumb_palm")s.addCurl(r,fp.FingerCurl.HalfCurl,.7)}else{s.addCurl(r,fp.FingerCurl.FullCurl,1);s.addCurl(r,fp.FingerCurl.HalfCurl,.9)}}M.custom[a]=s}const e=new fp.GestureDescription("palm_open");for(const r of[fp.Finger.Thumb,fp.Finger.Index,fp.Finger.Middle,fp.Finger.Ring,fp.Finger.Pinky]){e.addCurl(r,fp.FingerCurl.NoCurl,1)}e.addDirection(fp.Finger.Middle,fp.FingerDirection.VerticalUp,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.DiagonalUpLeft,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.DiagonalUpRight,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.HorizontalLeft,1);e.addDirection(fp.Finger.Thumb,fp.FingerDirection.HorizontalRight,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpLeft,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.DiagonalUpRight,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.HorizontalLeft,1);e.addDirection(fp.Finger.Pinky,fp.FingerDirection.HorizontalRight,1);M.custom.palm_open=e;d=new fp.GestureEstimator([M.custom.index_up]);System._browser.on_animation_update.add(()=>{const t=M.list;for(let e=t.length-1;e>=0;e--){if(t[e].timestamp>RAF_timestamp-3e3){if(e<t.length-1)t.length=e+1;break}}},0,1,-1);DEBUG_show("Motion control initialized",3)}async function t(){if(w)return;w=true;return;({getActiveWindow:s,Point:m,centerOf:p,mouse:i,keyboard:_,Key:u}=require("node_modules.asar/nut.js/node_modules/@nut-tree/nut-js"));i.config.autoDelayMs=0;_.config.autoDelayMs=0;r=true}await e();await t();c=false}function D(e,t){var i=t.annotations.thumb;var n=[t.annotations.index[0][1],t.annotations.middle[0][1],t.annotations.ring[0][1],t.annotations.pinky[0][1]];var o=i[1][1]>Math.max(...n);var a,s;if(o){s=e.hand_rot_YXZ[1];if(s<=20)a="Horizontal Left";else if(s>20&&s<=50)a="Diagonal Down Left";else if(s>130&&s<=160)a="Diagonal Down Right";else if(s>160)a="Horizontal Right";else a="Vertical Down";if(!e.thumb_out&&/Horizontal/.test(a)){a="";s=0}}else{if(!e.thumb_out){a="";s=0}else{const r=-(i[3][1]-i[1][1]);const _=i[3][0]-i[1][0];s=Math.atan2(r,_)*180/Math.PI-90;if(s<-180)s+=360;s=-s;if(s>20&&s<=60)a="Diagonal Up Right";else if(s>60&&s<=120)a="Horizontal Right";else if(s<-20&&s>=-60)a="Diagonal Up Left";else if(s<-60&&s>=-120)a="Horizontal Left";else a="Vertical Up"}}return[a+"\n"+(i[1][1]>Math.max(...n))+"\n"+e.hand_rot_YXZ.join("\n"),s]}var E=function(){var i,n,o,e,a;return function(){if(e!=RAF_timestamp){e=RAF_timestamp;i=null;a=[];s().then(async e=>{[n,o]=await Promise.all([e.title,e.region]);i=e;const t={w:i,title:n,region:o};a.forEach(e=>{e(t)})})}return new Promise((e,t)=>{if(i){e({w:i,title:n,region:o})}else{a.push(e)}})}}();var k=["０","１","２","３"];var x=[];var P=[];const R={get enabled(){return a},set enabled(e){if(a==!!e)return;a=!!e;if(a){A()}else{this.setMousePosition(null)}DEBUG_show("Motion control:"+(a?"ON":"OFF"),3)},get enabled_nut(){return r},get ready(){return a&&!c},get handedness(){return f},get off_hand(){return f=="左"?"右":"左"},get window_active(){return window_active},get _debug_msg(){return x},get debug_msg(){return a&&x.length?x.join("\n")+"\n":""},get Key(){return u},get key_pressed(){return h.pressed},gestures:M,get plugins(){return P},add_plugin:function(e){if(P.indexOf(e)==-1)P.push(e)},process:async function(t){if(!this.ready)return;if(t.posenet_data){if(!M.list.length||M.list[0].timestamp!=RAF_timestamp){M.list.unshift({timestamp:RAF_timestamp,gestures:[]})}x=["Motion control"+(S?"(PAUSED)":"")+":"];const e=t.posenet_data.handpose;if(e&&e.length){const _={};const l={};const c={};e.forEach(e=>{if(!e._used)return;const t=System._browser.camera.poseNet.frames.skin[e._d+"手首"];if(!t)return;const i=MMD_SA.TEMP_v3.setEulerFromQuaternion(t[0].rot,"YXZ");l[e._d]=i.toArray().map(e=>e*180/Math.PI);_[e._d]=Math.abs(i.y)<Math.PI/4?"front":Math.abs(Math.abs(i.y)-Math.PI)<Math.PI/4?"back":"sideway";const n=e.annotations;const o=g.fromArray(n.index[0]);const a=y.fromArray(n.middle[0]).sub(o);const s=MMD_SA._v3a.fromArray(n.thumb[3]);const r=(s.x*a.x+s.y*a.y+s.z*a.z-(o.x*a.x+o.y*a.y+o.z*a.z))/a.lengthSq();c[e._d]=-r>1.3*Math.abs(Math.abs(l[e._d][1])-90)/90+.2});M.list[0].hand_rot_YXZ=l;M.list[0].hand_facing=_;M.list[0].thumb_out=c;e.forEach(e=>{if(!r)return;if(!e._used)return;if(S){M.estimate(d,e);const t=M.search("index_up",{duration:1e3,hand_facing:"front",thumb_out:false});if(t){S=false;f=t._d;DEBUG_show("Motion control:READY",2)}}else if(e._d==f){M.estimate(d,e);const t=M.search("index_up",{duration:1e3,hand_facing:"back",thumb_out:false});if(t){S=true;DEBUG_show("Motion control:PAUSED",2)}}})}}else if(t.facemesh_data){}P.forEach(e=>{e.process(t)});if(!r)return;if(S)return;this.virtual_mouse.process(t);this.game01.process(t)},setMousePosition:function(){var t;return async function(e){if(e===null){t=null;return}if(!a)return;if(!r)return;if(e){t=e}else if(!e){return}await i.setPosition(t)}}(),game01:function(){var t,e;var i={id:"PSO2NGS",L:{thumb:{release:["Space","X"]},thumb_index:{press:["X"],release:["Space"]},thumb_palm:{press:["Space"],release:["X"]}},R:function(){function e(e){const t=h.temp.index_middle||0;const i=e.thumb_out?1:0;h.temp.index_middle=i;return t!=i}return{index_thumb:{press:["Tab"],press_check:function(){if(!h.temp.index_thumb)h.temp.index_thumb={};h.temp.index_thumb.clicked=true;return true}},index_up:{press:["Q"],press_check:function(){var e=h.temp.index_thumb&&h.temp.index_thumb.clicked;if(e)h.temp.index_thumb.clicked=false;return e}},index_middle1:{press:["Period"],click:["Semicolon"],click_check:e},index_middle2:{press:["Slash"],click:["Semicolon"],click_check:e},index_middle3:{press:["Quote"],click:["Semicolon"],click_check:e},thumb_palm:{press:["Backslash"]}}}()};var c;var n,o;function d(){if(e)return;c=new fp.GestureEstimator([M.custom.index_up,M.custom.index_thumb,M.custom.index_middle,M.custom.index_pinky,M.custom.palm_open,M.custom.thumb,M.custom.thumb_index,M.custom.thumb_palm]);h.set_options(i);e=true}return{get enabled(){return t},set enabled(e){t=e;if(t){h.set_options(i)}else{}},process:async function(i){if(!this.enabled){await h.releaseKey();return}d();const a=await E();const e=await a.title;if(i.facemesh_data&&i.head_rot){let e=i.head_rot.x*180/Math.PI;let t=i.head_rot.y*180/Math.PI;let n=Math.round(Math.sign(e)*Math.pow(Math.min(Math.max((Math.abs(e)-8)/15,0),1),2)*40);let o=Math.round(Math.sign(t)*Math.pow(Math.min(Math.max((Math.abs(t)-10)/20,0),1),2)*40);x.push(e,t,o,n);Promise.resolve(a.region).then(async e=>{const t=await p(e);const i=e.width-1280<64?[1280,720]:[1920,1080];t.y+=Math.round((e.height-i[1]-(e.width-i[0]))/2);t.x+=o;t.y+=n;t.y+=1;t.x+=1;await R.setMousePosition(t)})}let t;if(i.posenet_data){t=i.posenet_data.handpose;let e="";if(!t||!t.length){t=null;if(M.search("palm_open",{time_limit:500,hand_facing:"front",condition:()=>{}})){e+="/CANCEL";await h.releaseKey()}else{await h.releaseIdleKey()}}x.push((t?"":"(no hand data)")+e+"/key active:"+Object.keys(h.pressed).filter(e=>h.pressed[e]).join(","))}if(!t)return;for(const o of t){if(!o._used)continue;const s=o._d==f?"R":"L";x.push(s+":");M.estimate(c,o);let i;i=M.search("palm_open",{hand:o,hand_facing:"front",condition:function(e){const t=this.hand;const i=g.fromArray(t.annotations.index[0]).sub(y.fromArray(t.annotations.index[3]));const n=b.fromArray(t.annotations.pinky[0]).sub(v.fromArray(t.annotations.pinky[3]));return i.angleTo(n)*180/Math.PI>30}});if(i){x.push("CANCEL");await h.releaseKey(...h.clear_list(s));continue}if(o._d==f){i=M.search("index_thumb",{hand:o,hand_facing:"back",thumb_out:true});if(i){await h.activate(i,s,i.name,h.clear_list(s));x.push("index_thumb");continue}i=M.search("index_up",{hand:o,hand_facing:"front",thumb_out:true});if(i){await h.activate(i,s,i.name,h.clear_list(s));x.push("index_up");continue}i=M.search("index_middle",{hand:o});if(i){let e=i.name;switch(i.poseData[1][2]){case"Vertical Up":e+=2;break;case"Diagonal Up Left":e+=f=="右"?1:3;break;case"Diagonal Up Right":e+=f=="右"?3:1;break}await h.activate(i,s,e,h.clear_list(s));x.push(e);continue}i=M.search("thumb_palm",{hand:o,condition:function(e){if(!/(Horizontal|Diagonal Up)/.test(e.poseData[2][2]))return false;const t=this.hand;const i=g.fromArray(t.annotations.index[0]).sub(y.fromArray(t.annotations.index[3]));const n=b.fromArray(t.annotations.pinky[0]).sub(v.fromArray(t.annotations.pinky[3]));return i.angleTo(n)*180/Math.PI<20}});if(i){await h.activate(i,s,i.name,h.clear_list(s));x.push("thumb_palm");continue}i=M.search("thumb",{hand:o});if(i){x.push("CANCEL");await h.releaseKey(...h.clear_list(s));continue}i=M.search("index_pinky",{hand:o});if(i){x.push("index_pinky");continue}}else{i=M.search("thumb_palm|thumb_index|thumb",{hand:o,condition:function(e){if(e.name!="thumb_palm")return true;const t=this.hand;const i=g.fromArray(t.annotations.index[0]).sub(y.fromArray(t.annotations.index[3]));const n=b.fromArray(t.annotations.pinky[0]).sub(v.fromArray(t.annotations.pinky[3]));return i.angleTo(n)*180/Math.PI<20}});if(i){const r=D(i,o);const _=r[0];let e=[];let t=[];switch(_){case"Vertical Up":e.push("W");t.push("A","S","D");break;case"Diagonal Up Right":e.push("W","A");t.push("S","D");break;case"Horizontal Right":e.push("A");t.push("W","S","D");break;case"Diagonal Up Left":e.push("W","D");t.push("A","S");break;case"Horizontal Left":e.push("D");t.push("W","A","S");break;case"Diagonal Down Right":e.push("S","A");t.push("W","D");break;case"Diagonal Down Left":e.push("S","D");t.push("W","A");break;case"Vertical Down":e.push("S");t.push("W","A","D");break;default:t.push("W","A","S","D")}var n=h.action(i,s,i.name);if(n.press.length)e.push(...n.press);if(n.release.length)t.push(...n.release);if(e.length)await h.pressKey(...e.map(e=>[u[e]]));if(t.length)await h.releaseKey(...t.map(e=>[u[e]]));x.push([i.name,_].join("/")+"/"+RAF_timestamp);continue}}if(!i)await h.releaseIdleKey(...h.clear_list(s))}for(const l of[[0,t.findIndex(e=>e._used&&e._d==f)],[1,t.findIndex(e=>e._used&&e._d!=f)]]){if(l[1]!=-1)continue;const s=l[0]==0?"R":"L";if(M.search("palm_open",{time_limit:500,hand:{_d:l[0]==0?f:R.off_hand},hand_facing:"front",condition:()=>{}})){await h.releaseKey(...h.clear_list(s))}else{await h.releaseIdleKey(...h.clear_list(s))}}}}}(),virtual_mouse:function(){var e;var t;function p(){if(e)return;t=new fp.GestureEstimator([fp.Gestures.VictoryGesture,fp.Gestures.ThumbsUpGesture,M.custom.index_up]);e=true}return{enabled:false,process:async function(e){if(!this.enabled)return;if(!e.posenet_data)return;p();const t=e.posenet_data.handpose;if(!t||!t.length)return;const i=t[0]._d==f?0:1;const n=f=="右"?0:1;if(!t[i]||!t[i]._used)return;const o=screen.width/2;const a=screen.height/2;const s=System._browser.camera.video_canvas;const r=s.width/s.height/(o/a);const _=.5;const l=t[i].annotations.index[0];const c={x:-(-s.width/2+l[0])/(s.width/2*_),y:(-s.height/2+l[1])/(s.height/2*_)};c.x=Math.round(o+THREE.Math.clamp(c.x*r,-1,1)*o);c.y=Math.round(a+THREE.Math.clamp(c.y/r,-1,1)*a);const d=new m(c.x,c.y);await R.setMousePosition(d)}}}()};return R}(),snapshot:function(){var i=false;var n=false;var o;var a;function s(){const e=MMD_SA.THREEX.SL;const t=System._browser.camera;var i=Math.ceil(3-(Date.now()-o)/1e3);if(i<=0){if(!t.visible){l(e);return}DEBUG_show("Capturing...");if(!t.stream){if(!t.bodyPix.enabled){r();return}n=true}else{t.target_devicePixelRatio=1;t.video_track.applyConstraints(t.set_constraints()).then(function(){System._browser.console.log("(Ready to capture)");System._browser.on_animation_update.add(function(){MMD_SA._renderer.devicePixelRatio=window.devicePixelRatio;MMD_SA._renderer.__resize(EV_width,EV_height);if(!t.bodyPix.enabled){System._browser.on_animation_update.add(function(){r()},0,1);return}n=true},0,0)}).catch(function(e){DEBUG_show("ERROR:camera size failed to update");_()})}System._browser.on_animation_update.remove(s,0)}else if(a!=i){a=i;DEBUG_show(a)}}function r(){const e=MMD_SA.THREEX.SL;const t=System._browser.camera;let i=t.video_canvas_bodyPix;i.width=e.width;i.height=e.height;let n=i.getContext("2d");n.globalCompositeOperation="source-over";const o=t.video_canvas.width;const a=t.video_canvas.height;const s=Math.min(e.width/o,e.height/a);const r=Math.round(o*s);const _=Math.round(a*s);n.drawImage(t.video_canvas,0,0,o,a,(e.width-r)/2,(e.height-_)/2,r,_);if(t.face_detection.enabled)n.drawImage(t.video_canvas_face_detection,0,0);n.save();n.translate(i.width,0);n.scale(-1,1);n.drawImage(e,0,0);n.restore();l(i)}function l(e){i=true;n=false;System._browser.on_animation_update.remove(s,0);e.toBlob(function(e){if(webkit_electron_mode){System._browser.save_file("snapshot_"+Date.now()+".png",e)}else{const t=URL.createObjectURL(e);window.open(t)}_()})}function _(){const e=System._browser.camera;Ldebug.style.posLeft=Ldebug.style.posTop=0;Ldebug.style.transform=Ldebug.style.transformOrigin="";DEBUG_show();n=false;e.target_devicePixelRatio=0;i=false}const e={init:function(){if(i){return true}const e=MMD_SA.THREEX.SL;const t=System._browser.camera;if(MMD_SA.WebXR.session){let e=MMD_SA_options.WebXR&&MMD_SA_options.WebXR.AR;if(!e.dom_overlay||!e.dom_overlay.use_dummy_webgl){DEBUG_show("(No snapshot in AR WebGL)",3);return true}}if(!t.visible){l(e)}else{i=true;o=Date.now();Ldebug.style.posLeft=Ldebug.style.posTop=50;Ldebug.style.transformOrigin="0 0";Ldebug.style.transform="scale(5,5)";a=3;DEBUG_show();DEBUG_show(a);System._browser.on_animation_update.add(s,0,0,-1)}},check_bodyPix:function(){if(!i)return false;const e=System._browser.camera;if(n){l(e.video_canvas_bodyPix)}return true}};return e}(),video_capture:(()=>{const l=document.createElement("canvas");function r(){const e=m.get_specs();l.width=e.width;l.height=e.height;m._fps=e.fps;m.mime_type=e.mime_type;System._browser.on_animation_update.add(t,0,1,-1)}function t(){const e=MMD_SA.THREEX.SL;const t=l.getContext("2d");if(MMD_SA.music_mode){const i=SL_MC_video_obj.vo.media_linked&&SL_MC_video_obj.vo.media_linked.find(e=>e.id=="motion_bg_video");if(i&&i.style.visibility!="hidden"){const n=Math.min(i.videoWidth/i.videoHeight,l.width/l.height);const o=Math.round(Math.min(i.videoWidth,i.videoHeight)*n);const a=Math.min(o,i.videoWidth);const s=Math.min(o,i.videoHeight);const r=(i.videoWidth-a)/2;const _=(i.videoHeight-s)/2;t.drawImage(i,r,_,a,s,0,0,l.width,l.height)}}else{t.fillStyle=document.body.style.backgroundColor||"white";t.fillRect(0,0,l.width,l.height)}if(l.width==e.width&&l.height==e.height){t.drawImage(e,0,0)}else{t.drawImage(e,0,0,l.width,l.height)}}let _;function c(){if(!m.media_recorder||m.started)return;m.started=true;m.media_recorder.start();if(_&&m.stream.getAudioTracks().length&&(MMD_SA.music_mode?SL_MC_video_obj.vo.audio_obj.paused:MMD_SA.motion_player_control.enabled&&MMD_SA.motion_player_control.paused)){SL_MC_Play()}}function d(){System._browser.video_capture.stop()}var p=[];const m={enabled:false,started:false,fps:undefined,target_width:undefined,target_height:undefined,FFmpeg:(()=>{var e;var t;var o;var a;const i={enabled:webkit_electron_mode,load:async function(){if(e)return;e=true;return new Promise(n=>{o=new Worker("js/ffmpeg_worker.js");o.onmessage=e=>{const t=e.data;if(typeof t==="string"){if(t=="OK"){n()}}else{const i=new Blob([t.buffer],{type:t.output_type});return a(i)}}})},encode:async function(...e){await this.load();const t={inputs:[]};for(const i of e){if(i.blob)i.blob=await i.blob.arrayBuffer();t.inputs.push(i)}o.postMessage(t,t.inputs.filter(e=>e.blob).map(e=>e.blob));return new Promise(e=>{a=e})}};return i})(),get_specs:function(){const e=MMD_SA.THREEX.SL;const t=e.width*e.height;let i=this.target_width,n=this.target_height,o=this.fps;if(!i){if(is_mobile){i=1280;n=720;if(e.width<e.height){const r=i;i=n;n=r}}else{if(System._browser.camera.ML_enabled||System._browser.camera.bodyPix.enabled){i=1280;n=720}else{i=1920;n=1080}}}if(!o){if(is_mobile){o=30}else{if(System._browser.camera.ML_enabled||System._browser.camera.bodyPix.enabled){o=30}else if(Math.min(i*n,t)<=1280*720){o=-1}else{o=30}}}if(t>i*n){const _=Math.min(i/e.width,n/e.height);i=Math.min(Math.round(e.width*_/4)*4,i);n=Math.min(Math.round(e.height*_/4)*4,n)}else{i=e.width;n=e.height}const a=["video/webm;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"];let s;for(const l of a){if(MediaRecorder.isTypeSupported(l)){s=l;break}}return{width:i,height:n,fps:o,mime_type:s}},start:function(){if(this.busy){DEBUG_show("(Media recorder still in use)",3);return}if(this.enabled)return;this.enabled=true;r();const e=this._fps==-1?undefined:this._fps;const t=l.captureStream(e);this.stream=new MediaStream;this.stream.addTrack(t.getTracks()[0]);this.audio_src=MMD_SA.music_mode&&SL_MC_video_obj.vo.audio_obj.src;if(this.audio_src&&(!this.FFmpeg.enabled||this.target_mime_type||!SL_MC_video_obj.vo.motion_by_song_name_mode||SL_MC_video_obj.vo.audio_obj.currentTime)){const o=SL_MC_video_obj.vo.audio_obj.captureStream();this.stream.addTrack(o.getTracks()[0])}this.file_ext="."+(this.mime_type.indexOf("x-matroska")!=-1?"mkv":this.mime_type.replace(/^.+[\/]/,"").replace(/\;.+$/,""));this.media_recorder=new MediaRecorder(this.stream,{videoBitsPerSecond:l.width*l.height*4,mimeType:this.mime_type});p.length=0;this.media_recorder.addEventListener("dataavailable",async e=>{p.push(e.data);if(!this.enabled){let e=new Blob(p,{type:this.mime_type});this.stream.getTracks().forEach(e=>{e.stop()});let t=this.file_ext;this.busy=true;if(this.FFmpeg.enabled&&/h264/.test(this.mime_type)&&!this.target_mime_type){try{DEBUG_show("Encoding MP4...");const i=[{name:"video",blob:e}];if(this.audio_src){const n={name:"audio"};if(!this.stream.getAudioTracks().length)n.blob=await fetch(this.audio_src).then(e=>e.blob());i.push(n)}e=await this.FFmpeg.encode(...i);t=".mp4"}catch(e){console.error(e);this.FFmpeg.enabled=false}}this.busy=false;p.length=0;DEBUG_show("🔴Video Capture:OFF",5);System._browser.save_file("video_"+Date.now()+t,e)}});const i=new Promise(e=>{_=e;this.media_recorder.addEventListener("start",()=>{DEBUG_show();DEBUG_show("🔴Video Capture:ON ("+(l.width+"x"+l.height+(m._fps>-1?"/"+m._fps+"fps":""))+"/"+m.mime_type+")",10);if(MMD_SA.music_mode?SL_MC_video_obj.vo.audio_obj.paused:MMD_SA.motion_player_control.enabled&&MMD_SA.motion_player_control.paused){SL_MC_Play()}_();_=null},{once:true})});DEBUG_show();const n=MMD_SA.THREEX.get_model(0).animation.time;if(n||(MMD_SA.music_mode?!SL_MC_video_obj.vo.motion_by_song_name_mode||!SL_MC_video_obj.vo.audio_obj.paused:!MMD_SA.motion_player_control.enabled||!MMD_SA.motion_player_control.paused)){c()}else{if(m.audio_src){window.addEventListener("SA_audio_onended",e=>{System._browser.video_capture.stop()},{once:true})}else if(MMD_SA.motion_player_control.enabled){const s=MMD_SA.THREEX.get_model(0).animation;if(s.enabled){s.mixer.addEventListener("loop",d,{once:true});s.mixer.addEventListener("finished",d,{once:true})}else{window.addEventListener("SA_MMD_model0_onmotionended",d,{once:true})}}const a=MMD_SA_options.reset_rigid_body_physics_step;MMD_SA_options.reset_rigid_body_physics_step=0;new Promise(e=>{DEBUG_show("(Resetting physics)",3);let t=60*3;System._browser.on_animation_update.add(()=>{MMD_SA.seek_motion(n,true);if(MMD_SA.THREEX.get_model(0).animation.enabled)THREE.MMD.getModels()[0].seekMotion(0);if(--t==0)e()},0,0,t)}).then(()=>{MMD_SA.seek_motion(n);if(MMD_SA.motion_player_control.enabled){MMD_SA.motion_player_control.pause()}else{jThree.MMD.pause()}MMD_SA_options.reset_rigid_body_physics_step=a;c()})}DEBUG_show("🔴Video Capture",3);return i},stop:function(){if(!this.media_recorder)return;if(!this.enabled)return;this.enabled=false;System._browser.on_animation_update.remove(t,1);const e=MMD_SA.THREEX.get_model(0).animation;if(e.enabled){e.mixer.removeEventListener("loop",d);e.mixer.removeEventListener("finished",d)}else{window.removeEventListener("SA_MMD_model0_onmotionended",d)}this.media_recorder.stop();this.media_recorder=undefined;this.started=false},pause:function(){if(this.started&&this.media_recorder.state!="paused")this.media_recorder.pause()},resume:function(){if(this.started&&this.media_recorder.state=="paused")this.media_recorder.resume()}};return m})(),hotkeys:(()=>{class a{constructor(e,t){this.id=e.id;this.index=t;this.config=a.config_by_id[this.id]=e;this.event={};this.accelerator=e.accelerator[t];const i=this.accelerator.split("+");i.forEach(e=>{if(/^(Cmd|Command|Ctrl|Control)$/.test(e)){this.event.ctrlKey=true}else if(e=="Shift"){this.event.shiftKey=true}else if(e=="Alt"){this.event.altKey=true}else if(/^[0-9]$/.test(e)){this.event.code="Digit"+e}else if(/^num([0-9])$/.test(e)){this.event.code="Numpad"+RegExp.$1}else if(/^[A-Z]$/.test(e)){this.event.code="Key"+e}})}static config_by_id={};static get_config(e){return a.config_by_id[e]}static accelerators={};static register(e,t,i){if(!a.unregister(e))return false;const n=a.get_config(e);if(i)Object.assign(n,i);n.accelerator=t;t.forEach((e,t)=>{a.accelerators[e]=new a(n,t)});return a.enable_global(e)}static unregister(e){const t=a.get_config(e);if(!t)return false;t.accelerator.forEach(e=>{if(a.accelerators[e].is_global){try{webkit_electron_remote.globalShortcut.unregister(e)}catch(e){}}delete a.accelerators[e]});return true}static enable_global(e,i){if(!webkit_electron_mode)return true;const t=a.get_config(e);if(!t)return;let n=i==null?!!a.accelerators[t.accelerator[0]].config.global_disabled:!i;i=n?false:a.is_global;let o=true;t.accelerator.forEach(e=>{const t=a.accelerators[e];t.config.global_disabled=n;try{if(i){if(!t.is_global&&!t.config.global_disabled)webkit_electron_remote.globalShortcut.register(e,()=>{SA_topmost_window.SA_OnKeyDown(t.event)})}else{if(t.is_global)webkit_electron_remote.globalShortcut.unregister(e)}t.is_global=webkit_electron_remote.globalShortcut.isRegistered(t.accelerator);if(o&&i&&!t.config.global_disabled)o=t.is_global}catch(e){}});return o}static remove(e){if(a.unregister(e))delete a.config_by_id[e]}static add(i){a.remove(i.id);i.accelerator.forEach((e,t)=>{a.accelerators[e]=new a(i,t)});a.enable_global(i.id)}static _is_global=null;static get is_global(){return this._is_global==null?true:this._is_global}static set is_global(e){this._is_global=e}static disabled=false;static register_global(t){if(browser_native_mode){DEBUG_show("(Global hotkey is for app mode only.)",5);return}a.is_global=t==null?a.is_global:t;DEBUG_show("Global hotkey:"+(t?"ON":"OFF"),3);Object.values(a.accelerators).forEach(e=>{try{if(t){if(!e.is_global&&!e.config.global_disabled)webkit_electron_remote.globalShortcut.register(e.accelerator,()=>{SA_topmost_window.SA_OnKeyDown(e.event)})}else{if(e.is_global)webkit_electron_remote.globalShortcut.unregister(e.accelerator)}e.is_global=webkit_electron_remote.globalShortcut.isRegistered(e.accelerator)}catch(e){}})}}window.addEventListener("SA_keydown",n=>{if(a.disabled)return;const o=n.detail.e;Object.values(a.config_by_id).some(e=>{const t=e.accelerator.some(e=>{const t=a.accelerators[e].event;if(t.code&&t.code!=o.code)return false;if(t.ctrlKey&&!o.ctrlKey)return false;if(t.shiftKey&&!o.shiftKey)return false;if(t.altKey&&!o.altKey)return false;return true});if(t){const i=e.process(n);if(i!==false)n.detail.result.return_value=true;return true}})});return a})(),load_script:function(){var o={};var a=function(e,t){this.url=e;this.name=e.replace(/^.+[\/\\]/,"");this.loaded=false;this.resolve_list=[];this.reject_list=[];if(t){const i=this;import(e).then(e=>{i.module=e;i.check_loaded()})}else{const n=document.createElement("script");n.onload=this.check_loaded.bind(this);n.src=e;document.head.appendChild(n)}};a.prototype.check_loaded=function(){this.loaded=true;console.log(this.name+" loaded");this.resolve_list.forEach(e=>{e(this.module)})};a.prototype.make_promise=function(e,t){this.resolve_list.push(e);if(t)this.reject_list.push(t)};return function(e,t){var i=e.replace(/^.+[\/\\]/,"");var n=o[i]=o[i];if(n){if(n.loaded)return Promise.resolve(n.module)}else{n=o[i]=new a(e,t)}return new Promise((e,t)=>{n.make_promise(e,t)})}}(),save_file:function(){var a;return function(e,t,i){let n;if(i=="Data URL"){n=t}else{const o=!i?t:new Blob([t],{type:i});n=URL.createObjectURL(o)}if(!a){a=document.createElement("a");a.style.display="none";document.body.appendChild(a)}else{URL.revokeObjectURL(a.href)}a.href=n;a.download=e||"";a.click()}}(),update_obj_url:async function(t,i){if(/^(.+\.zip)\#[\/\\](.+)$/i.test(t)){const e=SA_topmost_window.DragDrop._obj_url[t];if(!e||t==e){const n=XMLHttpRequestZIP.zip_by_url(RegExp.$1);let e=await n.file(RegExp.$2.replace(/\\/g,"/")).async("blob");if(i)e=new Blob([e],{type:i});console.log("Object URL (inside zip) updated",t);SA_topmost_window.DragDrop._obj_url[t]=SA_topmost_window.URL.createObjectURL(e)}}},skip_background_rendering:true,skip_rendering:false,rendering_check:function(){if(this.skip_rendering&&!this.hidden)return false;if(!returnBoolean("DisableBackgroundThrottling"))return true;const e=this.skip_background_rendering&&this.hidden;return!e},console:{content_list:[],log:function(){for(var e=0;e<arguments.length;e++){this.content_list.push(arguments[e])}},reset:function(){this.content_list=[]},get output_text(){return this.content_list.join("\n")||"(EMPTY)"}},get use_screen_data(){if(this._use_screen_data)return true;if(!webkit_electron_mode)return false;let e,t;if(!SA_topmost_window.returnBoolean("AutoItStayOnDesktop")){e=System.Gadget.Settings.readString("OpacityOnHover");t=SA_topmost_window.returnBoolean("IgnoreMouseEventsPartial")}let i=e||t;let n=i||self.MMD_SA&&MMD_SA.MMD_started&&MMD_SA_options.look_at_mouse;return n},set use_screen_data(e){this._use_screen_data=e},translation:(()=>{var t,o,i;const n=navigator.language+"-default";var a;var e={ja:'"Meiryo UI"',zh:'"Microsoft JhengHei UI"'};const s={get language(){return o},set language(e){t=e||n;o=t.split("-")[0].toLowerCase();if(t==n){i="System default"}else{switch(o){case"en":i="English";break;case"ja":i="日本語";break;case"zh":i="繁體中文";break;default:i="System default"}}},get language_full(){return t},get language_info(){return i},get language_default(){return n},get dictionary(){return a},set dictionary(e){a=Object.assign(a||{},e)},get font(){return e[o]},get:function(e,t=o){if(!a)return"(Now loading...)";let i=a;e.split(".").every(e=>{i=i[e];return i});const n=i&&(i._translation_?.[t]||i._translation_?._default_);return n!=null?n:"("+e+")"}};s.language=null;return s})(),DEBUG_show:function(){const t=self.DEBUG_show;self.DEBUG_show=function(...e){if(System._browser.overlay_mode>0){if(!e.length)t()}else{t(...e)}};return t}(),WebSocket:(()=>{let n,o;let a;const s={};const e={init_server:function(t=13939){if(a)return;if(!n)n=require("http");if(!o)o=require("node_modules.asar/ws");const i=n.createServer();const e=new o.Server({server:i});e.on("connection",e=>{e.on("message",e=>{window.dispatchEvent(new CustomEvent("SA_WebSocket_server_on_message",{detail:{message:e.toString()}}))})});return new Promise(e=>{i.listen(t,()=>{console.log(`Data stream server started on port ${t}`);a=true;e()})})},init_client:function(n){if(!n)return;if(s[n])return s[n];s[n]=new Promise(t=>{const i=new WebSocket(n);i.addEventListener("error",e=>{setTimeout(()=>{s[n]=null},1e3)});i.addEventListener("open",e=>{console.log("WebSocket initialized => "+n);i.addEventListener("message",e=>{console.log("Message from server ",e.data)});i.addEventListener("close",e=>{console.log("WebSocket closed => "+n);s[n]=null});s[n]=i;t(i)})});return s[n]},send_message:async function(e,t){const i=await this.init_client(e);if(i)i.send(t)}};return e})()},_hash_sha256:{_hash_cache:{},hash:function(e){if(webkit_electron_mode){var t=webkit_electron_remote.getGlobal("HASH_SHA256");if(t)return t.hash(e)}var i=this._hash_cache[e];if(i)return i;var n=require("crypto").createHash("sha256");n.update(e);i=this._hash_cache[e]=n.digest("hex");return i}},_media_objs_paused_:[],_gadget_resume:function(e){if(e&&!SA_topmost_window.EV_sync_update.RAF_auto_paused)return false;if(!SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=false;SA_topmost_window.EV_sync_update.RAF_auto_paused=false;SA_topmost_window.System._media_objs_paused_.forEach(function(e){if(e.SL_MC_Play)e.SL_MC_Play();else if(e.paused)e.play()});SA_topmost_window.System._media_objs_paused_=[];System._browser.update_tray();return true},_gadget_pause:function(e){if(SA_topmost_window.EV_sync_update.RAF_paused)return false;SA_topmost_window.EV_sync_update.RAF_paused=true;SA_topmost_window.EV_sync_update.RAF_auto_paused=e;var s=SA_topmost_window.System._media_objs_paused_;var t=[top];for(var i=0;i<SA_child_animation_max;i++){if(SA_topmost_window.SA_child_animation[i])t.push(SA_topmost_window.document.getElementById("Ichild_animation"+i).contentWindow)}var r=0;var _=0;var l=0;t.forEach(function(e){for(var t in e.seq_items){var i=e.seq_items[t];if(!i._gadget_pause_disabled&&!i.paused&&i.count){r++;i.pause();s.push(i)}}var n=[];var o;o=document.getElementById("VdesktopBG");if(o)n.push(o);o=e.CANVAS_Video_Overlay&&e.CANVAS_Video_Overlay._video;if(o)n.push(o);n.forEach(function(e){if(e&&!e.paused&&!e.ended){_++;e.pause();s.push(e)}});if(e.SL&&e.SL._mouse_event_main&&e.SL._mouse_event_main()){var a;if(e.SL_MC_simple_mode)a=e.SL_MC_video_obj.paused;else if(e.MMD_SA)a=e.SL_MC_video_obj.vo.audio_obj.paused;else if(e.use_WMP&&e.WMP.in_use)a=e.WMP.player.playState!=3;else a=e.SL_MC_video_obj&&e.SL_MC_video_obj.paused;if(!a){l++;e.SL_MC_Play();s.push(e)}}});console.log("Gadget PAUSED (Seq/Video/MC):"+[r,_,l].join("/"));System._browser.update_tray();return true},_returnRelativePath:function(e){if(!WallpaperEngine_CEF_mode)return e;if(System.Gadget.path&&e.indexOf(System.Gadget.path)==0)e=e.substr(System.Gadget.path.length);e=/\:/.test(e)?toFileProtocol(e):e.replace(/\\/g,"/").replace(/^\//,"");return e}};System._init();return System}();
