// XR Animator
// (2024-05-18)

var MMD_SA_options = {

  model_path: System.Gadget.path + "/jThree/model/alicia.min.zip#/Alicia_solid_v02.pmx"  //Appearance Miku.zip#/Appearance Miku_BDEF_mod-v04.pmx"//

 ,motion: [

//  { path:System.Gadget.path + '/MMD.js/motion/stand.vmd'}
//  { path:System.Gadget.path + '/MMD.js/motion/swing.vmd'}
  { must_load:true, no_shuffle:true, path:System.Gadget.path + '/MMD.js/motion/motion_basic_pack01.zip#/standmix2_modified.vmd'}
//  { path:Settings.f_path + '/motion/_sleep90.vmd'}

   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/magic_of_xyz/magic_of_xyz.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/HeartBeats配布用.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/suki_yuki_maji_magic/suki_yuki_maji_magic.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/galaxias_motion/galaxias_miku_v2.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/after_school_stride/after_school_stride.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\シューティングスター/SS_準標準ボーン必須.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/HAL Dance.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/恋空予報モーション.vmd'
    }

//   ,{ path:Settings.f_path + '/motion/sweetmagic-left.vmd' }
   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/STEP/1_step-motion1.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/wavefile_motion/wavefile_lat.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/HCPえりかver（Lat式用）.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/てるてる(通常モデル用).vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/まっさらブルージーンズ.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/demo/love&joyお面無しver.vmd'
    }

//15

   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/mozuya/monstar.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/mozuya/Walka_Not_A_Talka.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/mozuya/louboutins.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/mozuya/black_n_gold.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\百舌谷 - motion\\motion\\Ass_On_The_Floor.vmd'
    }


   ,{
      path:'F:\\MMD\\motions\\メダモーション\\メダロット・ハク.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\Circus - Britney Spears\\Circus\\circus.vmd'
    }

   ,{
      path:System.Gadget.path + '/MMD.js/motion/motion_demo_pack01.zip#/demo/lupin/lupin.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\Good Feeling\\Good Feeling - Flo Rida\\Good Feeling.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\It makes me ill - NSYNC\\It makes me ill - modified.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\Do What U Want モーションセット（配布用）\\Do What U Want モーションセット\\DoWhatUWant（ダンスモーション）.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\SlavetotheRhythm\\SlavetotheRhythmダンス.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\Bout it - Yung Joc feat. 3LW\\bout it.vmd'
    }


   ,{
      path:'F:\\MMD\\motions\\Tipsy - J-Kwon\\Tipsy.vmd'
    }

   ,{
      path:'F:\\MMD\\motions\\ゆっきゆっきゆっきダンス・ライクーP\\ゆっきゆっきゆっきダンス・ライクーP.vmd'
    }

// 30

// must-load list
//  ,{ must_load:true, no_shuffle:true, path:'C:\\Users\\User\\Downloads\\MikuMikuDanceE_v739\\MikuMikuDanceE_v739\\UserFile\\Motion\\Muuubu Rin -Append-\\motion_BAL3.vmd'}
//   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/model/gal_model_motion_with_legs-2_loop_v01.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/motion_misc.zip#/壁穴モーション/壁穴_モデルモーション_loop.vmd'}

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_お辞儀1.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_お辞儀2.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_肯定する1.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_肯定する2.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_照れる1.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_照れる2.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/surrender_v03.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/surrender-R_v03.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_歓迎する1.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_歓迎する2.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_がっかり1.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_がっかり2.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_肩をすくめる1.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_肩をすくめる2.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_すねる1.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_すねる2.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_よろめく1.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_よろめく2.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/emote/emote-mod_おどろく1.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/chair_sit01_armIK.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/i-shaped_balance/i-shaped_balance_TDA_f0-50.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/leg_hold.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/stand_simple.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/sit_simple.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/Mixamo - Sitting02.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/Mixamo - Sitting Idle01.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/Mixamo - Sitting Idle02.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/Mixamo - Female Sitting Pose01.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/Mixamo - Female Sitting Pose02.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/Mixamo - Happy Idle.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/Mixamo - Female Laying Pose01.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy01.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy02.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy03.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy04.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy05.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy06.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy07.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy08.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy09.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/sitting_sexy10.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/prone_pose01.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/model_pose01.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/model_pose02.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/model_pose03.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/walk_n_run/walk_A34_f0-42.vmd' }
   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/motion/tsuna/モブ歩き男80f.vmd' }

   ,{ must_load:true, no_shuffle:true, path:Settings.f_path + '/assets/assets.zip#/baseball_throw/baseball_throw.vmd' }

// roomba
//   ,{ must_load:true, no_shuffle:true, path:'F:\\Programs Portable\\node-webkit\\_TEMP\\gura_x_roomba\\data\\gura_sit_01.vmd' }
  ]


 ,motion_shuffle_pool_size: 9
 ,motion_shuffle: [1,3,3+15, 0+15,1+15,2+15, 7+15,9,4]

//,motion_shuffle_pool_size: 9 +5
//,motion_shuffle: [0+15,1+15,2+15, 7+15,9,6, 3+15,4+15,6+15, 4,12+15,9+15,1,3]

// ,motion_shuffle_pool_size: 9
// ,motion_shuffle: [1,3,3+15, 0+15,1+15,4+15, 6,9,4]

 ,motion_shuffle_list_default: [30]//[0]

// ,motion_shuffle_list: [4,4,4,4,4,4,4,4]

 ,motion_shuffle_by_song_name: {
  }

//,random_range_disabled:true


 ,motion_para: {
    "stand" : { onended: function () { MMD_SA._no_fading=true; } }
   ,"standmix" : { onended: function () { MMD_SA._no_fading=true; } }
   ,"standmix2_modified" : { onended: function () { MMD_SA._no_fading=true; }

,allows_kissing: true
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]

,adjustment_per_model: {
    _default_ : {
  skin_default: {
    "左足ＩＫ": { keys: [{time:0, pos:{x: 0.2, y:0, z:0}, rot:{x:0, y: 10, z:0}}] }
   ,"右足ＩＫ": { keys: [{time:0, pos:{x:-0.2, y:0, z:0}, rot:{x:0, y:-10, z:0}}] }
  }
    }
}

    }
   ,"_sleep90" : { onended: function () { MMD_SA._no_fading=true; } }

   ,"恋はきっと☆まままＧＵＭＩ用 - modified" : { loop:[1,2], range:[{time:[4079,4278]}], BPM:{rewind:true, BPM: 143, beat_frame: 13 +60/143*30} }
   ,"真ん中_0-250_v2_GUMI" : { loop:[2,2], range:[{time:[0,150+22]}], BPM:{rewind:true, BPM: 115, beat_frame: 134} }
   ,"メダロット・ハク" : { loopback_fading:true, BPM:{rewind:true, BPM: 111.87, beat_frame: 204} }
   ,"after_school_stride" : { center_view:[-2.5,0,7.5], loopback_fading:true, BPM:{rewind:true, BPM: 112.5, beat_frame: 287} }
   ,"Masked bitcH" : { loopback_fading:true, BPM:{rewind:true, BPM: 125, beat_frame: 431} }
   ,"HAL Dance" : { center_view:[0,0,2.5], range:[{time:[407,0]}], loopback_fading:true, BPM:{rewind:true, BPM: 97.54*1.5, beat_frame: 446} }
   ,"Telephoneダンスモーション" : { loopback_fading:true, BPM:{rewind:true, BPM: 122, beat_frame: 4025} }
   ,"GetLucky(MP3)" : { range:[{time:[591,0]}], BPM:{rewind:true, BPM: 117.06, beat_frame: 767} }
   ,"It makes me ill - modified" : { loopback_fading:true, BPM:{rewind:true, BPM: 104.5, beat_frame: 119} }
   ,"magic_of_xyz" : { center_view:[0,0,2.5], loopback_fading:true, BPM:{rewind:true, BPM: 130, beat_frame: 498} }
   ,"monstar" : { center_view:[0,0,20], loopback_fading:true, BPM:{rewind:true, BPM: 116.03, beat_frame: 273} }
   ,"Walka_Not_A_Talka" : { center_view:[0,0,10], loopback_fading:true, BPM:{rewind:true, BPM: 106.7, beat_frame: 696} }
   ,"Ass_On_The_Floor" : { center_view:[-10,0,10], loopback_fading:true, BPM:{rewind:true, BPM: 127.03, beat_frame: 840} }
   ,"black_n_gold" : { center_view:[-2.5,0,12.5], loopback_fading:true, BPM:{rewind:true, BPM: 136.01, beat_frame: 96} }
   ,"louboutins" : { loopback_fading:true, BPM:{rewind:true, BPM: 105.03, beat_frame: 110} }
   ,"HeartBeats配布用" : { loopback_fading:true, range:[{time:[120,120+(30*(60+54)+21)]},{time:[120+(30*(180+31)),120+(30*(300)+10)]}], BPM:{rewind:true, BPM: 128.01, beat_frame: 820} }
   ,"circus" : { center_view:[-5,0,12.5], loopback_fading:true, range:[{time:[120,0]}], BPM:{rewind:true, BPM: 115, beat_frame: 834, match_even_beats_only:true} }
   ,"matryoshka_motion_0-5151" :  { center_view:[0,0,15], loopback_fading:true, range:[{time:[210,210+(30*(120+23)+10)]}], BPM:{rewind:true, BPM: 102.48, beat_frame: 959} }
   ,"musclecar" : { center_view:[2.5,0,5], loopback_fading:true, range:[{time:[300,0]}], BPM:{rewind:true, BPM: 129.13, beat_frame: 1055} }
   ,"まっさらブルージーンズ" : { center_view:[0,0,2.5], loopback_fading:true, range:[{time:[300,0]}], BPM:{rewind:true, BPM: 154.97, beat_frame: 704} }
   ,"sweetmagic-left" : { center_view:[-10,0,0], loopback_fading:true, BPM:{rewind:true, BPM: 123, beat_frame: 884} }
   ,"てるてる(通常モデル用)" : { center_view:[0,0,2.5], loopback_fading:true, range:[{time:[300,0]}], BPM:{rewind:true, BPM: 170.02, beat_frame: 1587} }
   ,"wavefile_lat" : { loopback_fading:true, range:[{time:[30,0]}], BPM:{rewind:true, BPM: 135.01, beat_frame: 427} }
   ,"love&joyお面無しver" : { center_view:[0,0,2.5], loopback_fading:true, range:[{time:[600,600+(30*(60+46)+2)]},{time:[600+(30*(120+8)+8),7780]}], BPM:{rewind:true, BPM: 173.03, beat_frame: 1393} }
   ,"HCPえりかver（Lat式用）" : { center_view:[0,0,0], loopback_fading:true, range:[{time:[90,0]}], BPM:{rewind:true, BPM: 164.01, beat_frame: 206} }
   ,"suki_yuki_maji_magic" : { center_view:[0,0,0], loopback_fading:true, range:[{time:[0,6145]}], BPM:{rewind:true, BPM: 167.02, beat_frame: 101} }
   ,"SS_準標準ボーン必須" : { center_view:[0,0,0], loopback_fading:true, range:[{time:[12*30,(2*60+33)*30]},{time:[(2*60+44)*30,0]}], BPM:{rewind:true, BPM: 144.01, beat_frame: 652+1} }
   ,"Tipsy" : { center_view:[0,0,15], loopback_fading:true, range:[{time:[133,0]}], BPM:{rewind:true, BPM: 93*1.5, beat_frame: 193} }
   ,"bout it" : { center_view:[0,0,12.5], loopback_fading:true, BPM:{rewind:true, BPM: 100*1.5, beat_frame: 306} }
   ,"恋空予報モーション" : { center_view:[0,0,0], loopback_fading:true, BPM:{rewind:true, BPM: 132.02, beat_frame: 110} }
   ,"SlavetotheRhythmダンス" :  { center_view:[0,0,7.5], loopback_fading:true, range:[{time:[230,1635]}], BPM:{rewind:true, BPM: 128, beat_frame: 480} }
   ,"DoWhatUWant（ダンスモーション）" : { center_view:[0,0,30], loopback_fading:true, range:[{time:[524,2470]}], BPM:{rewind:true, BPM: 97.51, beat_frame: 650} }
   ,"nyan - modified" : { center_view:[0,0,0], range:[{time:[282,1093]}], BPM:{rewind:true, BPM: 142.01, beat_frame: 282} }
   ,"lupin" : { center_view:[0,0,25], loopback_fading:true, range:[{time:[90,0]}], BPM:{rewind:true, BPM: 136.01, beat_frame: 1697} }
   ,"galaxias_miku_v2" : { center_view:[0,0,5], loopback_fading:true, range:[{time:[450,0]}], BPM:{rewind:true, BPM: 122.99, beat_frame: 835} }
   ,"Good Feeling" : { center_view:[-10,0,7.5], loopback_fading:true, range:[{time:[672,0]}], BPM:{rewind:true, BPM: 128, beat_frame: 1159} }
   ,"1_step-motion1" : { loopback_fading:true, BPM:{rewind:true, BPM: 123, beat_frame: 38} }
   ,"ゆっきゆっきゆっきダンス・ライクーP" : { loopback_fading:true, BPM:{rewind:true, BPM: 125.98, beat_frame: 190} }

//   ,"私の時間_short_Lat式ミク - with skirt physics" : { BPM:{rewind:true, BPM: 145, beat_frame: 603} }

//   ,"Viva Happy Motion (Imai)" : { BPM:{rewind:true, BPM: 147.98, beat_frame: 657} }
//   ,"tik tok" : { center_view:[0,0,0], loopback_fading:true, BPM:{rewind:true, BPM: 120*1.03, beat_frame: 142} }
//   ,"nekomimi_lat" : { center_view:[0,0,0], loopback_fading:true, range:[{time:[30,30+(30*(60+59)+27)]}], BPM:{rewind:true, BPM: 160, beat_frame: 1124} }
//   ,"you make me happy rea - MODIFIED" : { center_view:[0,0,0], loopback_fading:true, range:[{time:[0,0]}], BPM:{rewind:true, BPM: 124.06, beat_frame: 338} }

   ,"壁穴_モデルモーション_loop" : {
  random_range_disabled:true
 ,_cover_undies: false

 ,get look_at_screen_ratio() {
var f = THREE.MMD.getModels()[0].skin.time*30
var ratio = 1
if (f<=100)
  ratio = 0
else if ((f>100) && (f<130))
  ratio = (f-100)/30
else if ((f>184) && (f<=285))
  ratio = Math.max(1-(f-184)/16, 0)
else if ((f>285) && (f<330))
  ratio = (f-285)/45
else if ((f>625) && (f<=930))
  ratio = Math.max(1-(f-625)/55, 0)
else if ((f>930) && (f<960))
  ratio = (f-930)/30
else if ((f>1020) && (f<=1085))
  ratio = Math.max(1-(f-1020)/10, 0)
else if ((f>1085) && (f<1105))
  ratio = (f-1085)/20
else if ((f>1380) && (f<=1430))
  ratio = Math.max(1-(f-1380)/10, 0)
else if ((f>1430) && (f<1450))
  ratio = (f-1430)/20
else if (f>2015)
  ratio = Math.max(1-(f-2015)/5, 0)

return ratio
  }

 ,look_at_screen_bone_list: [
{ name:"両目", weight_screen:0.3, weight_motion:1 }
//    { name:"首", weight_screen:0.5, weight_motion:1/3 }
//   ,{ name:"頭", weight_screen:0.5, weight_motion:1/3 }
  ]

 ,onended: function (loop_end) {
MMD_SA._no_fading=true;

if (!loop_end) {
  MMD_SA.WebXR._wall.visible = false
}
  }
/*
 ,onstart: function (changed) {
if (!changed) return

var model = THREE.MMD.getModels()[0].mesh
MMD_SA.WebXR._wall.position.copy(model.position)
MMD_SA.WebXR._wall.quaternion.copy(model.quaternion)
MMD_SA.WebXR._wall.visible = true
  }
*/

// update every frame
 ,process_bones: function (model) {
if (!MMD_SA_options.WebXR.AR._adult_mode) return

var xr = MMD_SA.WebXR
var zoom_scale = xr.zoom_scale

var model_mesh = model.mesh
model_mesh.position.y = -11.5 + (xr.hitMatrix_anchor._hit_wall_y_ - xr.hit_ground_y)*10*zoom_scale;

xr._wall.position.copy(model_mesh.position)
xr._wall.quaternion.copy(model_mesh.quaternion)
xr._wall.scale.set(zoom_scale,zoom_scale,zoom_scale)
xr._wall.visible = true
  }

 ,_cover_undies: false
 ,object_click_disabled: true

 ,adjustment_per_model: {
    _default_ : {
  skin_default: {
  "全ての親": { pos_add:{ x:0, y:0, z:1 } }
  }
    }
  }
    }

   ,"gal_model_motion_with_legs-2_loop_v01" : {
  look_at_screen_angle_x_limit: [Math.PI*0.25, -Math.PI*0.5]

 ,center_view: [0,0,7.5]

 ,motion_tracking_enabled: true, motion_tracking_upper_body_only: true
 ,motion_tracking: {
    look_at_screen: true,
  }

// ,loop:[1,1]
 ,onended: function (last_frame) { MMD_SA._no_fading=last_frame&&(!this.loop||this.loop_count); }

 ,_cover_undies: false
 ,object_click_disabled: true

// ,gravity: [0,-0.1,0]
// ,gravity_reset: [0,0.5,0]
 ,gravity: [0,0,0]
 ,gravity_reset: [0,-0.5,0]

 ,adjustment_per_model: {
    _default_ : {
  skin_default: {
    "全ての親": { keys:
  [
    {time:0, pos:{x:0, y:4, z:-10}}
   ,{time:390*0.5/30, pos:{x:0, y:6, z:-10}}
   ,{time:390/30, pos:{x:0, y:4, z:-10}}
  ]
    }
//  "全ての親": { pos_add:{ x:-6.56+4, y:0+0.25, z:-6.47-3 }, rot_add:{ x:0, y:-54.4+20, z:0 } } 
  }
 ,morph_default:{
  "あ":{weight_scale:2/3}
 ,"High Heels OFF": { weight:1 }
// ,"素足":{weight:1}
  }
    }
  }

// ,center_view: [5-1,-5-2-1.05,-10] ,center_view_lookAt: [0-1,0-2+0.75,0] ,SpeechBubble_pos_mod: [-11+8,2,7]

// ,center_view: [5-1,-5-2,-10] ,center_view_lookAt: [0-1,0-2,0],SpeechBubble_pos_mod: [-1,2,8]
// ,center_view: [0,0-2.5,-30] ,center_view_lookAt: [20,5,20] ,SpeechBubble_pos_mod: [-8,6,10-2]
//[0,10,30], [0,10,0]
//,center_view: [0,0,-20-2.5] ,center_view_lookAt: [20,0,10+2.5] ,SpeechBubble_pos_mod: [-17,0,-10]


// ,SpeechBubble_flipH: true
// ,SpeechBubble_pos_mod: [0-8,4,-2+12]
//,SpeechBubble_pos_mod: [0,3,8]

 ,get look_at_screen_ratio() {
if (System._browser.camera.poseNet.enabled) return 1;

var f = THREE.MMD.getModels()[0].skin.time*30
var ratio = 1
if (f >= 157) {
  if (f <= 180)
    ratio = (180-f)/23
  else if (f <= 210)
    ratio = 0
  else if (f <= 233)
    ratio = (f-210)/23
}

return ratio
  }

 ,get look_at_screen_bone_list() {
var f = THREE.MMD.getModels()[0].skin.time*30
var ratio = 1
if (f >= 157) {
  if (f <= 180)
    ratio = (180-f)/23
  else if (f <= 210)
    ratio = 0
  else if (f <= 233)
    ratio = (f-210)/23
}

return (System._browser.camera.poseNet.enabled) ? [
  { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:0 },
  { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:0 },
  { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
] : (System._browser.camera.facemesh.enabled) ? [
  { name:"首", weight_screen:0.5*ratio, weight_motion:1*(1-ratio) }
 ,{ name:"頭", weight_screen:0.5*ratio, weight_motion:1*(1-ratio) }
] : [
  { name:"首", weight_screen:0.4*ratio, weight_motion:1*(1-ratio) }
 ,{ name:"頭", weight_screen:0.4*ratio, weight_motion:1*(1-ratio) }
 ,{ name:"両目", weight_screen:0.2*ratio, weight_motion:1*(1-ratio), weight_screen_pow:2 }
];
  }

// ,look_at_mouse_z: -1

// ,look_at_screen_bone_list: [{ name:"両目", weight_screen:0.2, weight_motion:0}]
// ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].skin.mesh.bones_by_name["頭"].quaternion.clone(); }

 ,IK_disabled: { test: function (name) { return (name.indexOf("足ＩＫ")!=-1) || (name.indexOf("つま先ＩＫ")!=-1); } }
    }

   ,"emote-mod_お辞儀1": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started && MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
  MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + "!\nCongratulations!", 3*1000)
}
else {
  MMD_SA.SpeechBubble.message(0, "Thank you. 2 meter is what we need.", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(2,4))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(2,4))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_お辞儀2": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started && MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
  MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + "!\nExcellent!", 3*1000)
}
else {
  MMD_SA.SpeechBubble.message(0, "Thank you. 2 meter is the distance we need.", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(2,4))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(2,4))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_肯定する1": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started && MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
  MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + "! You are great!", 3*1000)
}
else {
  MMD_SA.SpeechBubble.message(0, "You got it, 2 meter~!", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(2,4))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(2,4))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_肯定する2": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started && MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
  MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + "! Cool!", 3*1000)
}
else {
  MMD_SA.SpeechBubble.message(0, "This is it, 2 meter~!", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(2,4))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(2,4))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_照れる1": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
MMD_SA.SpeechBubble.message(0, "Hey... too close...", 3*1000)
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(0.75,2))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((Date.now() > this._duration_end_) || !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(0.75,2)) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_照れる2": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
MMD_SA.SpeechBubble.message(0, "Isn't it too close...", 3*1000)
  }

/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(0.75,2))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((Date.now() > this._duration_end_) || !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(0.75,2)) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"surrender_v03": {
  onstart: function () {
MMD_SA.SpeechBubble.message(0, "I surrender! Please, stay back! >_<", 3*1000)
  } 
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
MMD_SA._freeze_onended=MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(0,1.5)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
//DEBUG_show(model.skin.time+'\n'+mm._timeMax)
if (model.skin.time > mm._timeMax) {
//MMD_SA._custom_skin = [{ key:{ name:"全ての親", pos:[Math.random(),Math.random(),Math.random()] ,rot:[0,0,0,1] ,interp:MMD_SA._skin_interp_default }, idx:model.mesh.bones_by_name["全ての親"]._index }]
  if (!MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(0,1.5)) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
  else if ((parseInt(model.skin.time) % 10 == 0) && !MMD_SA.SpeechBubble.visible) {
    MMD_SA.SpeechBubble.message(0, "I surrender! Please, stay back! >_<", 3*1000)
  }
}
  }

 ,auto_blink: false
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"surrender-R_v03": {
  onstart: function () {} 
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(999,999)
  }
 ,auto_blink: false
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_歓迎する1": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
MMD_SA.SpeechBubble.message(0, "Hey! Come closer~!", 3*1000)
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(4,6))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((Date.now() > this._duration_end_) || !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(4,6)) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_歓迎する2": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
MMD_SA.SpeechBubble.message(0, "Come on! I won't bite~!", 3*1000)
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(4,6))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((Date.now() > this._duration_end_) || !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(4,6)) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_がっかり1": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started) {
  if (MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
    MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + ". Not bad.", 3*1000)
  }
  else {
    MMD_SA.SpeechBubble.message(0, "It's too close to throw the ball...", 3*1000)
  }
}
else {
  MMD_SA.SpeechBubble.message(0, "That's a lot more than 2 meter...", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(6,8))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(6,8))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_がっかり2": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started) {
  if (MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
    MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + ". It's ok.", 3*1000)
  }
  else {
    MMD_SA.SpeechBubble.message(0, "I need more distance...", 3*1000)
  }
}
else {
  MMD_SA.SpeechBubble.message(0, "No, not that far away...", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(6,8))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(6,8))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_肩をすくめる1": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started) {
  if (MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
    MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + ". Do better next time.", 3*1000)
  }
  else {
    MMD_SA.SpeechBubble.message(0, "Isn't it too close...", 3*1000)
  }
}
else {
  MMD_SA.SpeechBubble.message(0, "What's the point to stand so far away...", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(6,8))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(6,8))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_肩をすくめる2": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started) {
  if (MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
    MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + ". Still room for improvement.", 3*1000)
  }
  else {
    MMD_SA.SpeechBubble.message(0, "5 meters apart at least, please...?", 3*1000)
  }
}
else {
  MMD_SA.SpeechBubble.message(0, "Come on, not that far away...", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(6,8))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(6,8))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_すねる1": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started && MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
  MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + "... oh well...", 3*1000)
}
else {
  MMD_SA.SpeechBubble.message(0, "You don't like me, do you...", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(8,999))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(8,999))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_すねる2": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started && MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
  MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + "...", 3*1000)
}
else {
  MMD_SA.SpeechBubble.message(0, "This is so boring...", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(8,999))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(8,999))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_よろめく1": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started) {
  if (MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
    MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + "... isn't it too bad...", 3*1000)
  }
  else {
    MMD_SA.SpeechBubble.message(0, "You think I can throw a magical curveball...?", 3*1000)
  }
}
else {
  MMD_SA.SpeechBubble.message(0, "Am I a joke to you...", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(8,999))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(8,999))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_よろめく2": {
  onstart: function () {
this._duration_end_ = Date.now() + (MMD_SA.MMD.motionManager._timeMax + Math.random()*3+0.5)*1000
if (MMD_SA_options.Dungeon_options.item_base.baseball._started) {
  if (MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para) {
    MMD_SA.SpeechBubble.message(0, "Your score is " + MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score + "... oh no...", 3*1000)
  }
  else {
    MMD_SA.SpeechBubble.message(0, "Can you stand in front of me, please...", 3*1000)
  }
}
else {
  MMD_SA.SpeechBubble.message(0, "Oh my God... do you have to stand so far away...", 3*1000)
}
  }
/*
 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(8,999))
  MMD_SA._freeze_onended=(Date.now()<this._duration_end_)
  }
*/

 ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > mm._timeMax) {
  if ((MMD_SA_options.Dungeon_options.item_base.baseball._started) ? ((Date.now() > this._duration_end_) ? !MMD_SA_options.Dungeon_options.item_base.baseball.action._distance_check()||true : false) || (Date.now() > this._duration_end_) : (Date.now() > this._duration_end_) || (MMD_SA_options.Dungeon_options.item_base.social_distancing._started && !MMD_SA_options.Dungeon_options.item_base.social_distancing.action._social_distance_check(8,999))) {
    MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
    MMD_SA._force_motion_shuffle = true;
  }
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
    }

   ,"emote-mod_おどろく1": {
  onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice();
  }

 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time > 1) {
  if (MMD_SA._v3a.copy(MMD_SA.camera_position).setY(0).distanceTo(MMD_SA._v3b.copy(model.mesh.position).setY(0))/10 / MMD_SA.WebXR.zoom_scale < 1) {
    model.skin.time = 1
    model.morph.time = 1
  }
}
  }

 ,auto_blink: false//true
 ,adjust_center_view_disabled: true
/*
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.75, weight_motion:1 }
]
*/
    }

   ,"baseball_throw": {
  onstart: function () {
MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para = null
MMD_SA.SpeechBubble.message(0, "Catch this~!", 1*1000)
  }

 ,onended: function (loop_end) {
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
if (!loop_end) return;

var score = MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_para.hit_score
if (score > 75) {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_お辞儀1"], MMD_SA_options.motion_index_by_name["emote-mod_お辞儀2"], MMD_SA_options.motion_index_by_name["emote-mod_肯定する1"], MMD_SA_options.motion_index_by_name["emote-mod_肯定する2"]]
}
else if (score > 40) {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_がっかり1"], MMD_SA_options.motion_index_by_name["emote-mod_がっかり2"], MMD_SA_options.motion_index_by_name["emote-mod_肩をすくめる1"], MMD_SA_options.motion_index_by_name["emote-mod_肩をすくめる2"]]
}
else {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_すねる1"], MMD_SA_options.motion_index_by_name["emote-mod_すねる2"], MMD_SA_options.motion_index_by_name["emote-mod_よろめく1"], MMD_SA_options.motion_index_by_name["emote-mod_よろめく2"]]
}

MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice()
MMD_SA._force_motion_shuffle = true
  }

// ,freeze_onended: true
 ,onplaying: function (model_index) {
var mm = MMD_SA.MMD.motionManager
var model = THREE.MMD.getModels()[model_index]
if (model.skin.time >= 140/30) {
  MMD_SA_options.Dungeon_options.item_base.baseball.action._ball_fly()
}
  }

 ,auto_blink: true
 ,adjust_center_view_disabled: true
 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"上半身",  weight_screen:1/3, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:2/3, weight_motion:1 }
]
    }

   ,"chair_sit01_armIK": (function () {
      return {
  onstart: function () {
this._ground_plane_visible = MMD_SA.WebXR.ground_plane.visible
  }

 ,onended: function (loop_end) {
if (MMD_SA.WebXR.session)
  MMD_SA.WebXR.ground_plane.visible = this._ground_plane_visible;
MMD_SA._no_fading=true; MMD_SA._ignore_physics_reset=true;
//MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice();
  }

 ,onplaying: function () {
if (MMD_SA.WebXR.session)
  MMD_SA.WebXR.ground_plane.visible = false;
//var model_para = MMD_SA_options.model_para_obj
//model_para._custom_skin = [{ key:{ name:"右腕ＩＫ", pos:[0,1,0] ,rot:[0,0,0,1] ,interp:MMD_SA._skin_interp_default }, idx:mesh.bones_by_name["右腕ＩＫ"]._index }]
  }

 ,center_view: [0,-7.5,7.5]

 ,mirror_disabled: true

 ,motion_tracking_enabled: true, motion_tracking_upper_body_only: true

 ,motion_tracking: {
    lean_reduction_power: 1.5,
    arm_as_leg: {
      enabled: true,
      transformation: {

        position: {
          x: { unit_length:1, scale:2 },
          y: { add:-0.1, min:0.05, scale:2 },
          z: { unit_length:1, add:0, min:7, scale:3 },
          length_max: 1.2,
        },

        rotation: {
//          y: { scale:1.25 },
          y: { foot_ratio:0.5 },
        },
      },
    }
  }

 ,process_bones: function (model, skin) {
var mesh = model.mesh
var chair_ground_y = mesh.bones_by_name["下半身"].pmxBone.origin[1] - 8
mesh.bones_by_name["全ての親"].position.y -= chair_ground_y

var xr = MMD_SA.WebXR
if (!xr.session) {
  xr.hit_ground_y = 0
  xr.hit_ground_y_lowest = -0.1
}

var ground_y_diff = (xr.hit_ground_y - xr.hit_ground_y_lowest) * 10 * xr.zoom_scale - chair_ground_y
if (ground_y_diff >= 0)
  return

if (ground_y_diff < -chair_ground_y)
  ground_y_diff = -chair_ground_y

var posL = mesh.bones_by_name["左足ＩＫ"].position
var posR = mesh.bones_by_name["右足ＩＫ"].position
posL.y -= ground_y_diff
posL.z -= ground_y_diff
posR.y -= ground_y_diff
posR.z -= ground_y_diff

//DEBUG_show(posL.toArray().join('\n'))

if (skin.time < 1) {
  let factor = Math.min(skin.time/1,1)
  factor = (1 - factor*factor) * Math.abs(ground_y_diff/chair_ground_y)
  let leg_stretch = 5 * factor
  let ankle_rot = MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(-30*Math.PI/180*factor,0,0), "YZX")
  posL.z += leg_stretch
  posR.z += leg_stretch
  mesh.bones_by_name["左足ＩＫ"].quaternion.multiply(ankle_rot)
  mesh.bones_by_name["右足ＩＫ"].quaternion.multiply(ankle_rot)
}

System._browser.camera.poseNet.enable_IK('左腕ＩＫ', true)
System._browser.camera.poseNet.enable_IK('右腕ＩＫ', true)
  }

 ,freeze_onended: true

 ,object_click_disabled: true

 ,auto_blink: true
// ,adjust_center_view_disabled: true

 ,adjustment_per_model: {
    _default_ : {
  skin_default: {
//    "両目": { rot_add:{x:-5, y:2.5, z:0} }
    "頭": { keys:[{time:0, rot:{x:-11.3,y:0,z:0}}] }
   ,"下半身": { rot_add:{x:50, y:0, z:0} }
   ,"上半身": { rot_add:{x:10, y:0, z:0} }
   ,"上半身2": { rot_add:{x:-10, y:0, z:0} }
//,'左手捩': { keys:[{time:0, rot:{x:0,y:0,z:0}}] },'右手捩': { keys:[{time:0, rot:{x:0,y:0,z:0}}] }
  }
 ,morph_default:{
//    "笑い": { weight:0.2 }
  }
    }
  }

 ,get look_at_screen_parent_rotation() { return THREE.MMD.getModels()[0].mesh.quaternion; }
,look_at_screen_bone_list: [
  { name:"首", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"頭", weight_screen:0.5, weight_screen_y:0.25, weight_motion:1 }
 ,{ name:"上半身2", weight_screen:0.75, weight_screen_x:0,weight_screen_y:1, weight_motion:1 }
]
      };
    })()

   ,"walk_A34_f0-42": {
  adjustment_per_model: {
    _default_ : {
  skin_default: {
    "全ての親": { pos:{ x:0, y:0, z:5.1 } }
  }
    }
  },

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

  _speed: 360/1800 *30,

  SFX: [
    { frame:1,  sound:{} },
    { frame:21, sound:{} },
  ],

  motion_tracking_enabled: true, motion_tracking_upper_body_only: true,

  motion_tracking: {
    look_at_screen:true,
    motion_default_weight: {
      head: 0.5,
    },
    hip_adjustment: {
      rotation_weight: 0.5,
      displacement_weight: 1,
    },
  },
    }

   ,"モブ歩き男80f": {
  look_at_screen: false,

  _speed: 23.2/80 *30,

//  SFX: (()=>{ const s=[]; for (let i=0; i<12; i++) s.push({ frame:i*10+2, sound:{} }); return s; })(),

  SFX: [
    { frame:2,  sound:{} },
    { frame:22, sound:{} },
    { frame:42, sound:{} },
    { frame:62, sound:{} },
  ],

  motion_tracking_enabled: true, motion_tracking_upper_body_only: true,

  motion_tracking: {
    look_at_screen:true,
    motion_default_weight: {
      head: 1,
    },
    hip_adjustment: {
      rotation_weight: 0.5,
      displacement_weight: 1,
    },
  },
    }

   ,"stand_simple": {
  center_view_enforced: true

 ,_cover_undies: false

 ,trackball_camera_limit: { "min": { length:8 } }

 ,motion_tracking_enabled: true
 ,get motion_tracking_upper_body_only() { return this.center_view_enforced || !MMD_SA_options.Dungeon_options.character_movement_disabled; }

 ,motion_tracking: {
    hip_adjustment: {
      rotation_weight: 0.5,
      displacement_weight: 0.5,
    },
  }

 ,onstart: function () {
//let head_y = (MMD_SA.THREEX.enabled) ? MMD_SA.THREEX.get_model(0).para.pos0['head'][1] * MMD_SA.THREEX.get_model(0).model_scale : THREE.MMD.getModels()[0].mesh.bones_by_name['頭'].pmxBone.origin[1];
//this.center_view = (this.center_view_enforced) ? [0, (head_y)*1.025-11.4, -20*MMD_SA_options.Dungeon_options.camera_position_z_sign] : [0,0,0];

if (this.center_view_enforced) {
  const modelX = MMD_SA.THREEX.get_model(0);
  const neck_y = modelX.get_bone_origin_by_MMD_name('首')[1];
//  const hips_y = modelX.get_bone_origin_by_MMD_name((MMD_SA.THREEX.enabled)?'センター':'下半身')[1];
  const height_ref = neck_y/3;//hips_y;//neck_y - hips_y;

// https://hofk.de/main/discourse.threejs/2022/CalculateCameraDistance/CalculateCameraDistance.html
  const d = height_ref / (2 * Math.tan(Math.PI/180 * 50 / 2));
//DEBUG_show(d+'/'+neck_y);
  this.center_view = [0, (neck_y-10), -(30-Math.max(d*1.7, 10))*MMD_SA_options.Dungeon_options.camera_position_z_sign];
}
else {
  this.center_view = [0,0,0];
}

  }

 ,object_click_disabled: true

 ,IK_disabled: { test:(name)=>false, _IK_name_list:[] }
//(name.indexOf('腕ＩＫ') != -1) && System._browser.camera.poseNet.IK_disabled

// ,get look_at_screen() { return !System._browser.camera.facemesh.enabled; }
    }

   ,"sit_simple": {
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

  center_view: [0,-3.5,5],

//  look_at_screen: true,
  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    hip_adjustment: {
      displacement_weight: 0.1
    }
  }
    }

   ,"i-shaped_balance_TDA_f0-50": {
  freeze_onended: true

 ,motion_tracking_enabled: true, motion_tracking_upper_body_only: true
 ,motion_tracking: {
    look_at_screen:true,
    hip_adjustment: {
      rotation_weight: 0.5,
      displacement_weight: 1,
    },
    arm_default_stickiness: { default_rotation_weight:0.5 },
  }

 ,adjustment_per_model: {
    _default_ : {
  skin_default: {
    "センター": (function () {
var scale
function get_scale() {
// 10.56958
  if (!scale) {
    let model = THREE.MMD.getModels()[0]
    let bones_by_name = model.mesh.bones_by_name
    let leg_length = MMD_SA._v3a.fromArray(bones_by_name["左足"].pmxBone.origin).distanceTo(MMD_SA._v3b.fromArray(bones_by_name["左足ＩＫ"].pmxBone.origin));
    scale = leg_length/10.56958
  }
  return scale;
}
return { keys_mod: [{ frame:50, pos:{ get x() { return 2.53*get_scale(); }, get y() { return 4.78*get_scale(); }, z:0.79 } }] };
    })()

   ,"左腕": { keys_mod: [{ frame:50, rot:{ x:8.3, y:23.7-15, z:-33.2-10 } }] }
   ,"右腕": { keys_mod: [{ frame:50, rot:{ x:8.0-3, y:2.3, z:79.6 } }] }
   ,"cover_undies": {
      "左腕": { rot:{x:-19.3, y:26.9, z:-20.6} }
     ,"左ひじ": { rot:{x:19.5+10, y:14.5, z:90.3-15} }

     ,"右腕": { rot:{x:23.1, y:-2.2, z:-66.2} }
     ,"右ひじ": { rot:{x:-1.5, y:27.8, z:-61.9} }
     ,"右手首": { rot:{x:-18.0, y:21.3, z:-23.8} }
    }
  }
    }
  }

    }

   ,"leg_hold": (function () {
      var _pos_, _rot_, _zoom_scale_;
      var cam_pos, cam_rot, cam_speed, cam_speed_rot;
      var model_speed;
      var timestamp;
      var _ground_plane_visible;
      var orgy_level, orgy_cooling, orgy_spasm;
      var orgy_morph = [
  {name:"あ",weight:0}, {name:"う",weight:0}
 ,{name:"笑い",weight:0.5}, {name:"びっくり",weight:0.5}
 ,{name:"あ２",alt:[{name:"あ",weight:1}],weight:0.75}, {name:"困る",weight:1}, {name:"涙",weight:1}, {name:"はぁと",alt:[{name:"瞳小"}],weight:1}, {name:"ぺろっ",weight:1}
      ];

      window.addEventListener("jThree_ready", function () {
cam_pos = new THREE.Vector3()
cam_rot = new THREE.Vector3()
cam_speed = new THREE.Vector3()
cam_speed_rot = new THREE.Vector3()
model_speed = new THREE.Vector3()
      });

      return {
  freeze_onended: true
// ,look_at_screen: false
 ,initial_physics_reset: true

 ,_cover_undies: false
// ,object_click_disabled: true

 ,look_at_screen_bone_list: [
    { name:"両目", weight_screen:0.3, weight_motion:1 }
  ]

 ,onstart: function () {
var model = THREE.MMD.getModels()[0].mesh
_pos_ = model.position.clone()
_rot_ = model.quaternion.clone()

_zoom_scale_ = MMD_SA.WebXR.zoom_scale
MMD_SA.WebXR.zoom_scale = 1

var camera = MMD_SA._trackball_camera.object
cam_pos.copy(camera.position)
cam_rot.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromRotationMatrix(camera.matrixWorld),"YZX")
cam_speed.set(0,0,0)
cam_speed_rot.set(0,0,0)
model_speed.set(0,0,0)
timestamp = RAF_timestamp

_ground_plane_visible = MMD_SA.WebXR.ground_plane.visible

// lower the ground to prevent unexpected collisions due to .matrixWorld_physics_scale
jThree.MMD.groundLevel -= 10

orgy_level = 0
orgy_cooling = 0
orgy_spasm = 0
  }

 ,onended: function (loop_end) {
var model = THREE.MMD.getModels()[0].mesh
model.position.copy(_pos_)
model.quaternion.copy(_rot_)

MMD_SA.WebXR.zoom_scale = _zoom_scale_

MMD_SA.WebXR.ground_plane.visible = _ground_plane_visible

jThree.MMD.groundLevel = 0

MMD_SA_options.Dungeon.character.hp_add(9999)
  }

 ,onplaying: function () {
MMD_SA.WebXR.ground_plane.visible = false

var model = THREE.MMD.getModels()[0].mesh
var camera = MMD_SA._trackball_camera.object
model.position.copy(camera.position)
//model.position.y -= 11.5

var time_diff = (RAF_timestamp - timestamp) / 1000
var speed_ratio = Math.min(time_diff/0.2, 1)

var rot = MMD_SA.TEMP_v3.setEulerFromQuaternion(MMD_SA.TEMP_q.setFromRotationMatrix(camera.matrixWorld),"YZX")
var rot_speed = MMD_SA._v3a.copy(rot).sub(cam_rot).multiplyScalar(1/time_diff)
cam_speed_rot.multiplyScalar(1-speed_ratio).add(rot_speed.multiplyScalar(speed_ratio))

cam_rot.copy(rot)

rot.z = 0
rot.x = (rot.x < -0.9) ? (rot.x+0.9) : 0
//var rot_y = rot.y
//rot.y = 0
model.quaternion.setFromEuler(rot,"YZX")

var speed = MMD_SA.TEMP_v3.copy(camera.position).sub(cam_pos).multiplyScalar(1/time_diff)
cam_speed.multiplyScalar(1-speed_ratio)
cam_speed.add(speed.multiplyScalar(speed_ratio))
model_speed.copy(cam_speed).applyQuaternion(MMD_SA.TEMP_q.copy(model.quaternion).conjugate())

//model_speed.set(0,0,0)
cam_speed_rot.y = cam_speed_rot.y % (Math.PI*2);
if (cam_speed_rot.y > Math.PI)
  cam_speed_rot.y -= Math.PI*2
else if (cam_speed_rot.y < -Math.PI)
  cam_speed_rot.y += Math.PI*2
model_speed.x -= cam_speed_rot.y*3

//MMD_SA._custom_skin.push({ key:{ name:"全ての親", pos:[0,-11.5,0] ,rot:[0,0,0,1], interp:MMD_SA._skin_interp_default }, idx:model.bones_by_name["全ての親"]._index });
  }

 ,process_morphs: function (model, morph) {
var morph_name, _m_idx, _m;
var weight = model_speed.length()/5

var score = Math.min((Math.abs(model_speed.y)*3+Math.abs(model_speed.x)+Math.abs(model_speed.z))/20, 1)
var damage = (score > 0.5) ? -score : 0.1

MMD_SA_options.Dungeon.character.hp_add(damage, function (c) {
  var time_diff = (RAF_timestamp - timestamp) / 1000
  if (c.hp == 0) {
    orgy_cooling = 1
  }
  else {
// 10 sec to 0
    orgy_cooling = Math.max(orgy_cooling-time_diff/10, 0)
  }

  if (orgy_cooling) {
// 0.5 sec to max
    orgy_level = Math.min(orgy_level+time_diff*2, 1)
  }
  else {
    orgy_level = Math.max(orgy_level-time_diff*2, 0)
  }
  return {}
});

MMD_SA_options.auto_blink = !(orgy_level || (weight > 0.5));

if (orgy_level > 0.5) {
//DEBUG_show(orgy_level+'\n'+orgy_cooling)
  orgy_morph.forEach(function (m) {
    morph_name = m.name
    _m_idx = model.pmx.morphs_index_by_name[morph_name]
    if ((_m_idx == null) && m.alt) {
      m.alt.some(function (m2) {
        morph_name = m2.name
        _m_idx = model.pmx.morphs_index_by_name[morph_name]
        if (_m_idx != null) {
          if (m2.weight == null)
            m2.weight = m.weight
          m = m2
          return true
        }
      });
    }
    if (_m_idx != null) {
      _m = model.pmx.morphs[_m_idx]
      MMD_SA._custom_morph.push({ key:{ weight:m.weight, morph_type:_m.type, morph_index:_m_idx, override_weight:true }, idx:morph.target_index_by_name[morph_name] });
    }
   });

  return
}

weight = Math.min(weight, 1);

morph_name = "あ"
_m_idx = model.pmx.morphs_index_by_name[morph_name]
if (_m_idx != null) {
  _m = model.pmx.morphs[_m_idx]
  MMD_SA._custom_morph.push({ key:{ weight:0.1+weight*0.9, morph_type:_m.type, morph_index:_m_idx, override_weight:true }, idx:morph.target_index_by_name[morph_name] });
}

morph_name = "笑い"
_m_idx = model.pmx.morphs_index_by_name[morph_name]
if (_m_idx != null) {
  _m = model.pmx.morphs[_m_idx]
  MMD_SA._custom_morph.push({ key:{ weight:0.2+weight*0.2, morph_type:_m.type, morph_index:_m_idx }, idx:morph.target_index_by_name[morph_name] });
}

morph_name = "困る"
_m_idx = model.pmx.morphs_index_by_name[morph_name]
if (_m_idx != null) {
  _m = model.pmx.morphs[_m_idx]
  MMD_SA._custom_morph.push({ key:{ weight:0.5+weight*0.4, morph_type:_m.type, morph_index:_m_idx }, idx:morph.target_index_by_name[morph_name] });
}

morph_name = "涙"
_m_idx = model.pmx.morphs_index_by_name[morph_name]
if (_m_idx != null) {
  _m = model.pmx.morphs[_m_idx]
  MMD_SA._custom_morph.push({ key:{ weight:(weight>0.5)?1:0, morph_type:_m.type, morph_index:_m_idx }, idx:morph.target_index_by_name[morph_name] });
}
  }

 ,process_bones: function (model, skin) {
var mesh = model.mesh

var center = mesh.bones_by_name["センター"]
center.position.x -= Math.max(Math.min(model_speed.x/10, 2),-2)
center.position.y -= Math.max(Math.min(model_speed.y/10, 2),-2)

var rot

rot = MMD_SA.TEMP_v3.set(Math.max(Math.min(model_speed.y/50-model_speed.z/100, Math.PI/4),-Math.PI/4), 0, Math.max(Math.min(model_speed.x/100, Math.PI/4),-Math.PI/4));
if (orgy_level) {
  let time_diff = (RAF_timestamp - timestamp) / 1000
  orgy_spasm = (!orgy_spasm && (Math.random() < time_diff)) ? 2 : Math.max(orgy_spasm-time_diff*10, 0)
  let _ratio = orgy_level*orgy_level *(1+((orgy_spasm)?0.1*((orgy_spasm>1)?2-orgy_spasm:orgy_spasm):0)) *Math.PI/180
  rot.x += -30 *_ratio
  rot.z +=  15 *_ratio
}
rot = MMD_SA.TEMP_q.setFromEuler(rot.multiplyScalar(0.5), "YZX");
mesh.bones_by_name["首"].quaternion.multiply(rot)
mesh.bones_by_name["頭"].quaternion.multiply(rot)

rot = MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(Math.max(Math.min(model_speed.y/100, Math.PI/8),-Math.PI/8), Math.max(Math.min(model_speed.x/100, Math.PI/8),-Math.PI/8), 0), "YZX");
mesh.bones_by_name["左肩"].quaternion.multiply(rot)
mesh.bones_by_name["右肩"].quaternion.multiply(rot)

if (orgy_level > 0.5) {
  rot = MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(-10*Math.PI/180,0,0), "YZX");
  mesh.bones_by_name["両目"].quaternion.multiply(rot)
}

mesh.bones_by_name["全ての親"].position.setX(0).setY(-11.5).setZ(0)

// update at the very last (which should be process_bones)
timestamp = RAF_timestamp
cam_pos.copy(MMD_SA._trackball_camera.object.position)

//DEBUG_show(model_speed.toArray().join('\n'))
  }

 ,adjustment_per_model: {
    _default_ : {
  morph_default: {
    "涙": { weight:0 }
   ,"あ２": { weight:0 }
   ,"はぁと": { weight:0 }
   ,"ぺろっ": { weight:0 }
   ,"びっくり": { weight:0 }
  }
    }
  }


      };
    })()

   ,"Mixamo - Happy Idle": {
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

  motion_tracking_enabled: true, motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    motion_default_weight: {
      'head': 0.5,
    },
    hip_adjustment: {
      rotation_weight: 0.5,
      displacement_weight: 1,
    },
    arm_default_stickiness: { default_rotation_weight:0.5 },
  },
    }

   ,"Mixamo - Sitting Idle01": {
  adjustment_per_model: {
    _default_: {
  skin_default: {
    "左腕": { rot_add:{x:0, y:0, z:-15} }
  }
    },
    'ボサ髪_naked_feet.pmx': {
  skin_default: {
    "左腕": { rot_add:{x:0, y:0, z:-5} }
  }
    },
  },

  center_view: [0,-5,5],

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    arm_default_stickiness: {
      'right': { default_rotation_weight: 0.5 },
      'left' : { parent:{ weight:{x:{left:0.5,right:0.5}, y:{down:0.5,up:0.5}, z:{backward:0,forward:0.5}} } },
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'left',
      transformation: {
        position: {
          x: { scale:2 },
          y: { add:-0.1, min:0.05, scale:3 },
          z: { add:0.2, scale:2 },
          length_max: 1.2,
//          camera_weight: 0.5,
        },
        rotation: {
          y: { foot_ratio:0.5 },
        }
      },
    },
  }
    }

   ,"Mixamo - Sitting Idle02": {
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

  center_view: [0,-5,7.5],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    motion_default_weight: {
      'head': 0,
      'upper_body': 0.5,
    },
    hip_adjustment: {
      rotation_weight: 1/3,
      displacement_weight: 0.1,
      feet_fixed_weight:0.8,
    },
    arm_default_stickiness: {
      default_rotation_weight:1, default_position_weight:1,
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'left',
      transformation: {
        position: {
          x: { scale:1.5 },
          y: { add:0.4, scale:1.75 },
          z: { add:0.4, scale:2 },
          camera_weight: 0.75,
        },
        rotation: {
          y: { scale:1.25 },
        },
      },
    },
  }
    }

   ,"Mixamo - Sitting02": {
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

  center_view: [0,-3.5,5],

//  look_at_screen: true,
  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    arm_default_stickiness: {
      parent:{ weight: 1/3 },
    },
    hip_adjustment: {
      left: { feet_fixed_weight: 2/3 },
      right: { feet_fixed_weight: 0.9 },
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'left',
      transformation: {
        position: {
          x: { scale:1.5 },
          y: { add:0.4, scale:1.5 },
          z: { add:0.4, scale:2 },
          camera_weight: 0.75,
        },
      },
    },
  }
    }

   ,"kabedon_single_hand_v01": {
//  look_at_screen: true,
  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
//    look_at_screen: true,
    arm_default_stickiness: {
      default_rotation_weight: 0.5,
    },
    arm_as_leg: {
      enabled: true,
      linked_side: 'right',
      transformation: {
        position: {
          y: { add:1.5, scale:1.5 },
          z: { add:0.4, scale:1.5, max:1 },
        },
      },
    },
  }
    }

   ,"sitting_sexy01": {
//  look_at_screen: true,

  adjustment_per_model: {
    _default_: {
  skin_default: {
    '左足ＩＫ': { rot_add:{x:-30, y:0, z:0} },
//    '右足ＩＫ': { rot_add:{x:-15, y:0, z:0} }
  }
    },
    'DUMMY.pmx' : {
  skin_default: {
    '左足ＩＫ': { rot_add:{x:-30, y:0, z:0} },
    '右ひじ': { rot_add:{x:(31.4-(19)), y:(137.7-(153.5)), z:(74.7+10-(81.4))} },
    '右腕': { rot_add:{x:(6.9-(19.8)), y:(0.2-(11.9)), z:(-12-(-9.3))} },
  }
    },
  },

  center_view: [0,-2.5,5],

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

  auto_fit: {
    table: {
      reference_bones: ['右ひじ'],
      depth_scale: 0.1,
      rotation: { x:0, y:-90, z:0 },
    },
    chair: {
      depth_scale: 0.5,
      depth_rotation: { x:0, y:-90, z:0 },
    },
  },

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 2,
    motion_default_weight: {
      'head': 1
    },
    hip_adjustment: {
      'left' : { feet_fixed_weight:1 },
      'right': { feet_fixed_weight:2/3, },
    },
    arm_default_stickiness: {
      'right': { parent:{name:'頭', weight:{ x:{left:1.5, right:0.5}, y:{down:1.5, up:0.5}, z:{backward:0.5, forward:1.5} }}, default_position_weight:0.1, default_rotation_weight:0.8 },
      'left' : { default_position_weight:1, default_rotation_weight:1 },
    },
    arm_tracking: {
      elbow_lock: {
        right: {},
      }
    },
    arm_as_leg: {
//      enabled: true,
//toes_disabled: true,
      linked_side: 'right',
      transformation: {
        position: {
          x: { scale:1.5 },
          y: { add:0.4, scale:1.5 },
          z: { add:0.4, scale:2 },
          camera_weight: 0.75,
        },
        rotation: {
          y: { foot_ratio:0.5 },
        },
      },
    },
  }
    }

   ,"sitting_sexy02": {
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
  ],

  center_view: [0,2,10],

  auto_fit: {
    table: {
      reference_bones: ['左足首','右足首'],
//      depth_scale: 0.1,
    },
    chair: {
      depth_scale: 0.1,
    },
  },

//  look_at_screen: true,
  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 1.5,
    hip_adjustment: {
      rotation_weight: 0.5,
      feet_fixed_weight: 0.75,
    },
    arm_default_stickiness: {
      default_position_weight:1, default_rotation_weight:1,
    },
    arm_as_leg: {
//      enabled: true,
      transformation: {
        position: {
          x: { unit_length:1, add:{'left':-0, 'right':2}, min:{'left':-10, 'right':2.2-10.5}, max:{'left':10, 'right':2.2+10.5}, scale:{'left':1, 'right':1} },
          y: { unit_length:1, add:{'left':5, 'right':3}, min:{'left':4.5, 'right':3.5}, max:{'left':15, 'right':3.5+0.5},scale:{'left':1.75, 'right':0.3} },
          z: { unit_length:1, add:3, min:{'left':5, 'right':11.2-10}, max:{'left':12, 'right':11.2}, scale:{'left':2, 'right':2} },
/*
          process: (legs)=>{
if (legs.length < 2) return;

const diff = (1 - Math.abs(legs[0].pos.y - legs[1].pos.y)) / 2;
if (diff > 0) {

  if (legs[0].pos.y < legs[1].pos.y) {
    const y0 = legs[0].pos.y;
    legs[0].pos.y = legs[1].pos.y;
    legs[1].pos.y = y0;
  }

  const sign = (legs[0].pos.y > legs[1].pos.y) ? 1 : -1;
  legs[0].pos.y += diff * sign;
  legs[1].pos.y -= diff * sign;
}
          },
*/
        },
        rotation: {
          y: { foot_ratio:0.75 },
        },
      },
    },
  }
    }

   ,"Mixamo - Female Sitting Pose01": {
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
  ],

  center_view: [0,-3,5],

//  look_at_screen: true,
  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 2,
    hip_adjustment: {
      'left' : { feet_fixed_weight:1 },
      'right': { feet_fixed_weight:2/3, },
    },
    arm_default_stickiness: {
      'left': { parent:{ name:'右足', weight:1 } },
      'right': { parent:{ weight:1 } },
    },
/*
    arm_as_leg: {
//      enabled: true,
      linked_side: 'right',
      transformation: {
        position: {
          x: { scale:1.5 },
          y: { add:0.15, scale:1.5 },
          z: { add:0.4, scale:2 },
          rotation: { x:0, y:15, z:0 },
          camera_weight: 0.5,
        },
      },
    },
*/

    arm_as_leg: {
//      enabled: true,
      linked_side: 'right',
      transformation: {
        position: {
          x: { unit_length:1, add:1.5, min:-4, max:4, scale:1 },
          y: { unit_length:1, add:1, min:0, scale:1 },
          z: { unit_length:1, min:2, max:2 },
          length_max: 99,
//          length_min: 0.5,
//          camera_weight: 0.75,

          position_to_rotation: {

            upper: {
              x: { max:-100 },
              z: { rot_formula:"z", scale:-0.5 },
              y: { rot_formula:"z", scale:0.8 },
            },

            lower: {
//63.43494882292201 * 2
//, curve:{ini:0, end:120, pow_factor:1.5}
              x: { rot_formula:'x', min:0, add:-30, scale:1.5 },
            },
          },
        },

        rotation: {
          y: { foot_ratio:0.75 },
        },
      },
    },


  }
    }

   ,"Mixamo - Female Sitting Pose02": {
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
  ],

  center_view: [0,-3.5,5],

//  look_at_screen: true,
  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 2,
    motion_default_weight: {
      'head': 0.5,
      'upper_body': 0.75,
    },
    hip_adjustment: {
      feet_fixed_weight:1,
    },
    arm_default_stickiness: {
      'right': { parent:{ weight:0.8 } },
      'left': { parent:{ weight:0.8 } },
    },
/*
    arm_as_leg: {
//      enabled: true,
      linked_side: 'right',
      transformation: {
        position: {
          x: { scale:1.5 },
          y: { add:0.15, scale:1.5 },
          z: { add:0.4, scale:2 },
          rotation: { x:0, y:15, z:0 },
          camera_weight: 0.5,
        },
      },
    },
*/

    arm_as_leg: {
      transformation: {
        position: {
          x: { unit_length:1, add:{"left":8,"right":-8}, min:{"left":-0.25,"right":-8}, max:{"left":8,"right":0.25}, scale: 1 },
          y: { unit_length:1, add:1, min:0, scale:1 },
          z: { unit_length:1, min:2, max:2 },
          length_max: 99,
//          length_min: 0.5,
//          camera_weight: 0.75,

          position_to_rotation: {
            upper: {
              x: { max:-112 },
              z: { rot_formula:"z", scale:-0.35 },
              y: { rot_formula:"z", scale:0.08 },
            },
            lower: {
//63.43494882292201 * 2
//, curve:{ini:0, end:120, pow_factor:1.5}
              x: { rot_formula:'x', min:0, add:-30, scale:1.5 },
            },
          },
        },

        rotation: {
          y: { foot_ratio:0.5 },
        },
      },
    },

  }
    }

   ,"sitting_sexy03": {
  adjustment_per_model: {
    _default_: {
  skin_default: {
//    '右腕': { rot_add:{x:(39.5-(50.6))*0.5, y:(-7.9-(-4.3))*0.5, z:(-41.1-(-38.5))*0.5} },
  }
    },
    'DUMMY.pmx' : {
  skin_default: {
    '右腕': { rot_add:{x:(39.5-(50.6))*3, y:(-7.9-(-4.3))*3, z:(-41.1-(-38.5))*3} },
    '右ひじ': { rot_add:{x:0, y:0, z:15} },
  }
    },
  },


  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
  ],

  center_view: [-2.5,-5.5,10],

//  look_at_screen: false,
  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 1.5,
    motion_default_weight: {
      'head': 0.5,
    },
    hip_adjustment: {
      feet_fixed_weight:1,
    },
    arm_default_stickiness: {
      'right' : { parent:{ name:'頭', weight:{ x:{left:1.5, right:0.5}, y:{down:1.5, up:0.5}, z:{backward:0.5, forward:1.5} } }, default_position_weight:0.1, default_rotation_weight:0.5, },
      'left': { default_position_weight:1, default_rotation_weight:1, },
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'left',
      transformation: {
        position: {
          x: { scale:1.5 },
          y: { add:0.6, scale:1.5 },
          z: { add:0.4, scale:2 },
          rotation: { x:0, y:-20, z:0 },
          camera_weight: 0.5,
        },
      },
    },
  }
    }

   ,"sitting_sexy04": {
  adjustment_per_model: {
    'DUMMY.pmx' : {
  skin_default: {
    "左腕": { rot_add:{x:(45.4-(57.5))*1.5, y:(-23.4-(-35.7))*1.5, z:(24.9-(15.2))*1.5} },
    "左ひじ": { rot_add:{x:0, y:0, z:-30} },
  }
    }
  },

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
  ],

  center_view: [0,-6,7.5],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 1.5,
    motion_default_weight: {
      'head': 1,
    },
    hip_adjustment: {
      feet_fixed_weight:1,
    },
    arm_default_stickiness: {
      'left' : { parent:{ name:'頭', weight:{ x:{left:0.5, right:1.5}, y:{down:1.5, up:0.5}, z:{backward:0.5, forward:1.5} } }, default_position_weight:0.1, default_rotation_weight:0.5, },
      'right': { default_position_weight:0.5, default_rotation_weight:0.5, },
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'left',
      transformation: {
        position: {
/*
          x: { unit_length:1, scale:2 },
          y: { unit_length:1, min:8, add:5, scale:4 },
          z: { scale:0 },
          rotation: { x:-90, y:0, z:0 },
*/

          x: { scale:1.5 },
          y: { add:0.4, scale:1.5 },
          z: { add:0.3, scale:2 },
          camera_weight: 0.75,

        },
      },
    },
  }
    }

   ,"sitting_sexy05": {
  adjustment_per_model: {
    'DUMMY.pmx' : {
  skin_default: {
    '左足ＩＫ': { pos_add:{ x:0.4, y:0, z:0 } },
    '右足ＩＫ': { pos_add:{ x:-0.4, y:0, z:0 } },
  }
    }
  },

  onstart: (()=>{
    let adjusted;
    return function () {
if (adjusted) return;
adjusted = true;

const z_para = this.motion_tracking?.arm_as_leg?.transformation?.position?.z;
if (z_para) {
  z_para.min.left -= 0.4;
  z_para.max.left -= 0.4;
  z_para.min.right += 0.4;
  z_para.max.right += 0.4;
}
    };
  })(),

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
  ],

  center_view: [0,-6,7.5],

  mirror_disabled: true,

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 1.5,
    motion_default_weight: {
      'head': 0.5,
    },
    hip_adjustment: {
      feet_fixed_weight:0.9,
    },
    arm_default_stickiness: {
      parent:{ weight:0.5 }, default_position_weight:1, default_rotation_weight:0.5,
    },
    arm_as_leg: {
//      enabled: true,
//      linked_side: 'left',
      transformation: {
        position: {
/*
          x: { unit_length:1, min:{left:-0.85,right:0.5}, max:{left:-0.85,right:0.5}, scale:0.2 },
          y: { add:0.3, scale:1.5 },
          z: { add:0, min:0.75, scale:3 },
*/

          x: { add:0.75, min:0.75, scale:{left:1.5, right:-1.5} },
          y: { add:0.3, scale:1.5, min:0 },
          z: { unit_length:1, min:{left:0.85,right:-0.5}, max:{left:0.85,right:-0.5}, scale:0.2 },
          rotation: { x:0, y:-90, z:0 },

//          camera_weight: 0.5,
        },
        rotation: {
          y: { foot_ratio:0.5 },
        }
      },
    },
  }
    }

   ,"sitting_sexy06": {
  adjustment_per_model: {
    'DUMMY.pmx' : {
  skin_default: {
  }
    }
  },

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.75, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.25, weight_motion:1 },
  ],

  center_view: [0,-5,7.5],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    motion_default_weight: {
      'head': 0.5,
    },
    hip_adjustment: {
      feet_fixed_weight:1,
      rotation_weight:0.25,
      displacement_weight:0,
    },
    arm_default_stickiness: {
      'left' : { default_position_weight:1, default_rotation_weight:1, },
      'right': { default_position_weight:0.8, default_rotation_weight:0.5, },
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'right',
      transformation: {
        position: {
          x: { add:-0.3, max:-0.1, scale:3 },
          y: { unit_length:1, add:-1.5, min:0.5, scale:2 },
          z: { add:-0.3, min:0.1, scale:3 },
          length_max: 1.2,
          length_min: 0.5,
//          camera_weight: 0.75,
        },
      },
    },
  }
    }

   ,"sitting_sexy07": {
  adjustment_per_model: {
    _default_ : {
  skin_default: {
'左手首': { rot_add:{x:0, y:0, z:-5} },
'右手首': { rot_add:{x:0, y:0, z: 5} },
  }
    },
    'DUMMY.pmx' : {
  skin_default: {
'左ひじ': { rot_add:{x:(22.9-(18.7))*0.5, y:(-143.2-(-153.3))*0.5, z:(-59.5-(-63.1))*0.5-15} },
'右ひじ': { rot_add:{x:(22.8-(18.4))*0.5, y:(143.2-(153.9))*0.5, z:(58.9-(62.7))*0.5+15} },
'左手首': { rot_add:{x:0, y:0, z: 5} },
'右手首': { rot_add:{x:0, y:0, z:-5} },
  }
    },
    'AliciaSolid.vrm' : {
  skin_default: {
'左ひじ': { rot_add:{x:0, y:0, z:-20} },
'右ひじ': { rot_add:{x:0, y:0, z: 20} },
'左手首': { rot_add:{x:0, y:0, z: 10} },
'右手首': { rot_add:{x:0, y:0, z:-10} },
  }
    }
  },

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

//  look_at_screen: true,
  center_view: [0,0,5],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 2,
    motion_default_weight: {
      'head': 0.5,
    },
    hip_adjustment: {
      feet_fixed_weight:2/3,
//      rotation_weight:0.25,
//      displacement_weight:0,
    },
    arm_default_stickiness: {
      'left' : { parent:{ name:'頭', weight:{ x:{left:0.5, right:0.8}, y:{down:0.5, up:0.5}, z:{backward:0.5, forward:1.0} } }, default_position_weight:0.1, default_rotation_weight:0.75, },
      'right': { parent:{ name:'頭', weight:{ x:{left:0.8, right:0.5}, y:{down:0.5, up:0.5}, z:{backward:0.5, forward:1.0} } }, default_position_weight:0.1, default_rotation_weight:0.75, },
    },
    arm_tracking: {
      transformation: {
        position: {
          y: { unit_length:1, min:'elbow+0' },
        }
      },
      elbow_lock: {
        left: {},
        right: {},
      },
    },
    arm_as_leg: {
      transformation: {
        position: {
          x: { unit_length:1, add:{"left":-1.0,"right":1.0}, min:{"left":-0.25,"right":-4}, max:{"left":4,"right":0.25}, scale: 1 },
          y: { unit_length:1, add:1, min:0, scale:1 },
          z: { unit_length:1, min:2, max:2 },
          length_max: 99,
//          length_min: 0.5,
//          camera_weight: 0.75,

          position_to_rotation: {
            upper: {
              x: { max:-105 },
              z: { rot_formula:"z", scale:-0.2 },
              y: { rot_formula:"z", scale:0.8 },
            },
            lower: {
//63.43494882292201 * 2
//, curve:{ini:0, end:120, pow_factor:1.5}
              x: { rot_formula:'x', min:0, add:-30, scale:1.5 },
            },
          },
        },

        rotation: {
          y: { foot_ratio:0.5 },
        },
      },
    },
  }
    }

   ,"sitting_sexy08": {
  adjustment_per_model: {
    'AliciaSolid.vrm' : {
  skin_default: {
    "右ひじ": { rot_add:{x:0, y:0, z:30} },
  }
    }
  },

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

//  look_at_screen: true,
  center_view: [0,0,5],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 2,
    motion_default_weight: {
      'head': 0.5,
    },
    hip_adjustment: {
      feet_fixed_weight:2/3,
//      rotation_weight:0.25,
//      displacement_weight:0,
    },
    arm_default_stickiness: {
      'left' : { default_position_weight:1, default_rotation_weight:1, },
      'right': { parent:{ name:'頭', weight:{ x:{left:0.8, right:0.5}, y:{down:0.5, up:0.5}, z:{backward:0, forward:1.0} } }, default_position_weight:0.1, default_rotation_weight:0.75, },
    },
    arm_tracking: {
      transformation: {
        position: {
          y: { unit_length:1, min:'elbow+0' },
        }
      },
      elbow_lock: {
        left:{},
        right:{},
      },
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'right',
      transformation: {
        position: {
          x: { unit_length:1, add:1.5, min:-4, max:4, scale:1 },
          y: { unit_length:1, add:1, min:0, scale:1 },
          z: { unit_length:1, min:2, max:2 },
          length_max: 99,
//          length_min: 0.5,
//          camera_weight: 0.75,

          position_to_rotation: {
            upper: {
              x: { max:-105 },
              z: { rot_formula:"z", scale:-0.2 },
              y: { rot_formula:"z", scale:0.8 },
            },
            lower: {
//63.43494882292201 * 2
//, curve:{ini:0, end:120, pow_factor:1.5}
              x: { rot_formula:'x', min:0, add:-30, scale:1.5 },
            },
          },
        },

        rotation: {
          y: { foot_ratio:0.75 },
        },
      },
    },
  }
    }


   ,"sitting_sexy09": {
  adjustment_per_model: {
    _default_ : {
  skin_default: {
  }
    },
    'DUMMY.pmx' : {
  skin_default: {
  }
    },
    'AliciaSolid.vrm' : {
  skin_default: {
'左ひじ': { rot_add:{x:0, y:0, z:-5} },
  }
    }
  },

  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

//  look_at_screen: true,
  center_view: [0,-3.5,5],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    motion_default_weight: {
      'head': 0.5,
    },
    hip_adjustment: {
      feet_fixed_weight:0.9,
//      rotation_weight:0.25,
//      displacement_weight:0,
    },
    arm_default_stickiness: {
      'left' : { parent:{ name:'頭', weight:{ x:{left:0.5, right:0.8}, y:{down:0.5, up:0.5}, z:{backward:0.5, forward:1.0} } }, default_position_weight:0.1, default_rotation_weight:0.75, },
//      'right': { parent:{ name:'頭', weight:{ x:{left:0.8, right:0.5}, y:{down:0.5, up:0.5}, z:{backward:0.5, forward:1.0} } }, default_position_weight:0.1, default_rotation_weight:0.75, },
      'right' : { default_position_weight:1, default_rotation_weight:1, },
    },
				"arm_as_leg": {
					"transformation": {
						"position": {
							"x": {
								"unit_length": 1,
								"add": {
									"left": 1,
									"right":-1
								},
								"min": {
									"left": 0.5,
									"right": -4
								},
								"max": {
									"left": 4,
									"right": -0.5
								},
								"scale": 1
							},
							"y": {
								"unit_length": 1,
								"add": 1,
								"min": 0,
								"scale": 1
							},
							"z": {
								"unit_length": 1,
								"min": 2,
								"max": 2
							},
							"length_max": 99,
							"position_to_rotation": {
								"upper": {
									"x": {
										"max": -65
									},
									"z": {
										"rot_formula": "z",
										"scale": -0.5
									},
									"y": {
										"rot_formula": "z",
										"scale": 0.5
									}
								},
								"lower": {
									"x": {
										"rot_formula": "x",
										"min": 0,
										"add": -30,
										"scale": 1.5
									}
								}
							}
						},
						"rotation": {
							"y": {
								"foot_ratio": 0.25
							}
						}
					},
				}
  }
    }

   ,"sitting_sexy10": {
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"頭", weight_screen:0.5, weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身",  weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
    { name:"上半身2", weight_screen:0.5, weight_screen_x:0,weight_screen_y:0.5, weight_motion:1 },
  ],

  center_view: [0,-3.5,5],

//  look_at_screen: true,
  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 1.5,
    motion_default_weight: {
      'head': 0.5,
    },
    arm_default_stickiness: {
      left: { default_position_weight:1, default_rotation_weight:1, },
      right: { parent:{ weight: 2/3 } },
    },
    hip_adjustment: {
      left: { feet_fixed_weight: 0.9 },
      right: { feet_fixed_weight: 2/3 },
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'right',
      transformation: {
        position: {
          x: { add:0.2, scale:1.5 },
          y: { add:0.4, scale:1.5 },
          z: { add:0.4, scale:2 },
          camera_weight: 0.75,
        },
      },
    },
  }
    }


   ,"prone_pose01": {
  adjustment_per_model: {
    _default_ : {
  skin_default: {
  }
    },
    'DUMMY.pmx' : {
  skin_default: {
  }
    }
  },

  get look_at_screen() { return System._browser.camera.poseNet.enabled; },
  look_at_screen_bone_list: [
    { name:"首", weight_screen:0.4, weight_motion:1 },
    { name:"頭", weight_screen:0.4, weight_motion:1 },
//    { name:"両目", weight_screen:0.5, weight_motion:1 },
  ],

  center_view: [0,-6.5,7.5],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
    look_at_screen: true,
    lean_reduction_power: 3,
    motion_default_weight: {
      'head': 0,
    },
    hip_adjustment: {
      feet_fixed_weight:0.25,
      rotation_weight:0.25,
//      displacement_weight:0,
    },
    arm_default_stickiness: {
      'left' : { default_position_weight:1, default_rotation_weight:1, },
      'right': { default_position_weight:1, default_rotation_weight:1, },
    },
    arm_tracking: {
      transformation: {
        position: {
          x: { unit_length:1, scale:1 },
          y: { unit_length:1, add:-2.5, min:'default+0', scale:2 },
          z: { unit_length:1, add:-4, min:'default+0', scale:2 },
          camera_weight: 0.5,
//          length_max: 1.2,
//          length_min: 0.5,
        },
      },
//      elbow_lock: {},
    },
    arm_as_leg: {
//      enabled: true,
//      linked_side: 'right',
      transformation: {
        position: {
          x: { unit_length:1, add:{left:-1, right:1}, min:{left:0, right:-4}, max:{left:4, right:0}, scale:1 },
          y: { unit_length:1, add:1, min:0, scale:2 },
          z: { unit_length:1, min:2, max:2 },
          length_max: 99,
//          length_min: 0.5,
//          camera_weight: 0.75,

          position_to_rotation: {
            upper: {
              z: { rot_formula:'z', scale:-1.5, curve:{left:{ini:0, end:60, pow_factor:1.5}, right:{ini:0, end:-60, pow_factor:1.5}} },
            },
            lower: {
//63.43494882292201 * 2
//, curve:{ini:0, end:120, pow_factor:1.5}
              x: { rot_formula:'x', add:-90, min:0, scale:-2, curve:{ini:0, end:120, pow_factor:1.5} },
            },
          },
        },

        rotation: {
          y: { foot_ratio:0.5 },
        },
      },
    },
  }
    }


   ,"Mixamo - Female Laying Pose01": {
  adjustment_per_model: {
    _default_ : {
  skin_default: {
    "右腕": { rot_add:{x:(56.1-(43.7))*-1, y:(-33.4-(-50.8))*-1, z:(-3.3-(-16.8))*-1} },
    "左ひざ": { rot_add:{x:-5, y:0, z:0} },
  }
    }
  },

  look_at_screen: false,
  center_view: [2,-6,14],

  motion_tracking_enabled: true,
  motion_tracking_upper_body_only: true,
  motion_tracking: {
//    look_at_screen: true,
    head_rotation_weight: 0.75,
    lean_reduction_power: 2,
    motion_default_weight: {
      'head': 1,
      'upper_body': 1,
      'shoulder': 1,
    },
    hip_adjustment: {
      feet_fixed_weight:1,
      rotation_weight:0.25,
      displacement_weight:0,
    },
    arm_default_stickiness: {
      'left' : { default_position_weight:0.5, default_rotation_weight:0.5, },
      'right': { default_position_weight:0, default_rotation_weight:0.5, },
    },
    arm_tracking: {
      transformation: {
        position: {
          z: { "unit_length": 1, "add":{"right":1} },
          y: { unit_length:1, min:'elbow+0' },
          x: { add:{left:0, right:0}, scale:{left:1.5, right:1} },
        },
"root_rotation": {
	"left": {
		"x": 0,
		"y": 0,
		"z": 20,
		"order": "ZYX"
	},
	"right": {
		"x": 0,
		"y": -20,
		"z": 10,
		"order": "ZYX"
	}
}
      },
      elbow_lock: {
        right:{
          use_smallest_angle:true
        },
      },
    },
    arm_as_leg: {
//      enabled: true,
      linked_side: 'left',
      transformation: {
        position: {
          x: { add:0.2, min:0, scale:3 },
          y: { add:0.2, min:0, scale:3 },
          z: { min:0, scale:3 },
          length_max: 1.2,
          length_min: 0.4,
//          camera_weight: 0.75,
        },
      },
    },
  }
    }


   ,"model_pose01": {
  adjustment_per_model: {
    _default_ : {
  skin_default: {
'センター': { pos_add:{x:0, y:-0.5, z:0} },
  }
    },
  },
			"look_at_screen_bone_list": [
				{ "name":"首", "weight_screen":0.5, "weight_screen_y":0.5, "weight_motion":1 },	
				{ "name":"頭", "weight_screen":0.5, "weight_screen_y":0.5, "weight_motion":1 },
				{ "name":"上半身",  "weight_screen":0.5, "weight_screen_x":0, "weight_screen_y":0.5, "weight_motion":1 },
				{ "name":"上半身2", "weight_screen":0.5, "weight_screen_x":0, "weight_screen_y":0.5, "weight_motion":1 }
			],
//			"look_at_screen": true,
			"motion_tracking_enabled": true,
			"motion_tracking_upper_body_only": true,
			"motion_tracking": {
"look_at_screen": true,
"hip_adjustment": {
	"left": { "feet_fixed_weight":0.8 }, "right": { "feet_fixed_weight":1 },
	"rotation_weight":0.5,
	"displacement_weight":1
},
"arm_default_stickiness": {
	"default_position_weight":0.25
}
			}
    }

   ,"model_pose02": {
			"look_at_screen_bone_list": [
				{ "name":"首", "weight_screen":0.5, "weight_screen_y":0.5, "weight_motion":1 },	
				{ "name":"頭", "weight_screen":0.5, "weight_screen_y":0.5, "weight_motion":1 },
				{ "name":"上半身",  "weight_screen":0.5, "weight_screen_x":0, "weight_screen_y":0.5, "weight_motion":1 },
				{ "name":"上半身2", "weight_screen":0.5, "weight_screen_x":0, "weight_screen_y":0.5, "weight_motion":1 }
			],
//			"look_at_screen": true,
			"motion_tracking_enabled": true,
			"motion_tracking_upper_body_only": true,
"look_at_screen": true,
"center_view": [0,-3,5],
			"motion_tracking": {
"look_at_screen": true,
"hip_adjustment": {
	"feet_fixed_weight":0.75,
	"rotation_weight":0.25,
	"displacement_weight":0.75,
	"knee_fixed_weight":1
},
"arm_default_stickiness": {
	"default_position_weight":0.25
}
			}
    }

   ,"model_pose03": {
			"look_at_screen_bone_list": [
				{ "name":"首", "weight_screen":0.5, "weight_screen_y":0.5, "weight_motion":1 },	
				{ "name":"頭", "weight_screen":0.5, "weight_screen_y":0.5, "weight_motion":1 },
				{ "name":"上半身",  "weight_screen":0.5, "weight_screen_x":0, "weight_screen_y":0.5, "weight_motion":1 },
				{ "name":"上半身2", "weight_screen":0.5, "weight_screen_x":0, "weight_screen_y":0.5, "weight_motion":1 }
			],
//			"look_at_screen": true,
			"motion_tracking_enabled": true,
			"motion_tracking_upper_body_only": true,
			"motion_tracking": {
"look_at_screen": true,
"hip_adjustment": {
	"left": { "feet_fixed_weight":1 },
	"right": { "feet_fixed_weight":0.5 },
	"rotation_weight":0.5,
	"displacement_weight":1
},
"arm_default_stickiness": {
	"left": { "default_position_weight":0.5 },
	"right": { "default_position_weight":0 }
},
"arm_as_leg": {
	"linked_side": "right",
	"transformation": {
		"position": {
			"x": { "unit_length":1, "add":0.31, "scale":2 },
			"y": { "unit_length":1, "add":-5.639580078125, "scale":2 },
			"z": { "unit_length":1, "add":-1, "min":0.05, "scale":2 },
			"__camera_weight":0
		},
		"rotation": {
			"y": { "add":-45, "__foot_ratio":0.5 }
		}
	}
}
			}
    }


  }

 ,custom_action: [
  "cover_undies"
 ,"kissing"
  ]

 ,use_CircularSpectrum: true

 ,look_at_screen: true

// ,center_view: [0,0,20]//[0,5,0]
// ,camera_position: [10,20,20]

// ,light_position: [50,50,50]

 ,edgeScale: 0.75

 ,model_para: {
    "Alicia_solid.pmx": {
      "MME": {
"self_overlay":{"enabled":true,"opacity":0.5,"color_adjust":[1.5,0.5,0.75],"brightness":0.8},
"HDR":{"enabled":true,"opacity":0.2},
//"serious_shader":{"enabled":true,"shadow_opacity":0.3},
"SAO":{"disabled_by_material":[]}
      },
      "material_para": {
"_default_": { "transparent":true }
      },
      "facemesh_morph" : {
"mouth_narrow": { "name":"つ", "weight":0.5 }
      },
      "skin_default": {
"両目": { "rot_scale":3 }
      },
      "icon_path": "icon_v01.jpg"
    }
  }

/*
 ,MME: {
    self_overlay: {
  enabled: true
// ,opacity: 0.5
// ,brightness: 1
    }
   ,HDR: {
  enabled: true
// ,opacity: 0.5
    }
   ,serious_shader: {
  enabled: 1
// ,shadow_opacity: 0.5
 ,material: {
    "顔": { shadow_opacity: 0.25 }
  }
 ,OverBright: 1.1
    }

// 123

  }
*/

 ,use_speech_bubble: true
 ,onstart: (()=>{
    var initialized;
    function cancel_intro() {
if (initialized) return;
initialized = true;

if (MMD_SA_options.Dungeon.event_mode) return;

var msg_group = MMD_SA.SpeechBubble.msg_group
var group_name_current = msg_group.group_name_current
if (group_name_current) {
  delete msg_group.group_by_name[group_name_current]
  msg_group.group_name_current = ""
}

MMD_SA.SpeechBubble.hide();
    }

    return ()=>{
//MMD_SA.SpeechBubble.list.forEach(sb=>{sb.bubbles.forEach(b=>{  b.font = '"Segoe UI",Roboto,Ubuntu,"SF Pro"'; })});

window.addEventListener('SA_Dungeon_onstart', ()=>{
  document.body.addEventListener('drop', cancel_intro, {once:true});
  document.addEventListener('dblclick', cancel_intro, {once:true});
  document.addEventListener('keydown', cancel_intro, {once:true});

  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.intro.welcome'), 3*1000, {group_index:0, group:{name:"onstart", loop:2}});
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.intro.camera'), 5*1000, {group:{name:"onstart"}});
  if (webkit_electron_mode) MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.intro.move'), 4*1000, {group:{name:"onstart"}});
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.intro.mocap'), 4*1000, {group:{name:"onstart"}});
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.intro.webcam'), 4*1000, {no_word_break:true, group:{name:"onstart"}});
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.intro.motion'), 4*1000, {group:{name:"onstart"}});
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.intro.AR'), 4*1000, {group:{name:"onstart"}});

  System._browser.on_animation_update.add(()=>{
    window.addEventListener('MMDCameraReset_after', cancel_intro, {once:true});
  },1,0);
});
    };
  })()

 ,WebXR: {
    model_scale: (is_mobile) ? 0.9 : 1,
    AR: {
      dom_overlay: { root:"Lbody" }

     ,onwallhit: function (e) {
var model_mesh = THREE.MMD.getModels()[0].mesh
if (!model_mesh.visible) {
  DEBUG_show("(Place the model on the ground first.)", 3)
  return true
}

this._groundhit = false
this._wallhit = true
this._skip_charging_count = 10

var adult_mode = this._adult_mode
e.detail.result.update_obj = function (model_mesh, first_call) {
  var xr = MMD_SA.WebXR
  var axis = xr.hitMatrix_anchor.decomposed[3]

  model_mesh.quaternion.setFromEuler(MMD_SA.TEMP_v3.set(0,Math.atan2(axis.x,axis.z),0))
  MMD_SA_options.mesh_obj_by_id["CircularSpectrumMESH"] && MMD_SA_options.mesh_obj_by_id["CircularSpectrumMESH"]._obj.rotation.setEulerFromQuaternion(model_mesh.quaternion)

  if (adult_mode) {
// needed for .process_bones()
    xr.hitMatrix_anchor._hit_wall_y_ = xr.hitMatrix_anchor.decomposed[0].y;

    if (first_call) {
      MMD_SA_options.motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["壁穴_モデルモーション_loop"]]
      MMD_SA._force_motion_shuffle = true
    }
  }
  else {
// anchor offset away from the wall (x,z)
    xr.hitMatrix_anchor.decomposed[0].add(axis.clone().multiplyScalar(0.25).setY(0));
  }

// save some headache and always put the reference anchor on the ground
  xr.hitMatrix_anchor.decomposed[0].y = xr.hit_ground_y;
};
      }

     ,ongroundhit: function (e) {
this._groundhit = true
this._wallhit = false
this._skip_charging_count = 10

//DEBUG_show(9,0,1);return;
var model_mesh = THREE.MMD.getModels()[0].mesh
model_mesh.position.y = 0

if (MMD_SA_options.motion_shuffle_list_default && (MMD_SA_options.motion_shuffle_list_default[0] != MMD_SA_options._motion_shuffle_list_default[0])) {
  MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice()
  MMD_SA._force_motion_shuffle = true
}
      }
    }
  }

 ,user_camera: {
    enabled: true,
//    mirror_3D: 0,
    pixel_limit: {
//      _default_: [1280,720],//[1920,1080],//
      fixed: !is_mobile,
//      facemesh : [640,360],
      facemesh_bb_ratio: (is_mobile) ? 1 : 0.5,
    },
    display: (is_mobile) ? {} : {
//floating: true,
//floating_auto: false,
//floating_scale: 1,
video:{
//  hidden:true,
//  hidden_on_webcam: true,
  scale:0.4, top:-0.5,
//left:-0.5,//top:-1,
//scale:0.4*1,top:0,left:-3,
//scale:0.4*2,top:0,left:-1,
},
wireframe:{
//  hidden:true,
//  align_with_video:true,
  top:0.5,
//left:+(0.4),top:-1,
//left:1,
//top:0.8,left:0.4,
//top:0,left:3,
//top:0.5,left:1,
}
    },
    preference: {
      label: /Iriun/,
//      label: /OBS/,
    },
    ML_models: {
      enabled: true,
//      use_holistic: false,
//      worker_disabled: true,
//      debug_hidden: true,
      facemesh: {
//        use_mediapipe: true
      },
      pose: {
//        estimate_z_depth: false,
//        auto_grounding: true,
//        use_armIK: true,
//        use_legIK: true,
//        position_offset: {x:-7.5,y:0,z:0},
        events: {
          enabled:  ()=>{ MMD_SA.WebXR.ground_plane.visible=System._browser.camera.poseNet.ground_plane_visible; },
          disabled: ()=>{ MMD_SA.WebXR.ground_plane.visible=System._browser.camera.poseNet.ground_plane_visible; },
        }
      },
      hands: {
      }
    }
  }

 ,light_position: [0,1,0]

 ,use_shadowMap: true
 ,shadow_darkness: 0.1
 ,ground_shadow_only: true

 ,make_armIK: {
  }

 ,SpeechBubble_branch: {
//    confirm_keydown:true,
    RE: /^([\dA-Z])\.\s/
  }

 ,SpeechBubble_pos_fixed: true

 ,_SpeechBubble_scale_: 0
 ,get SpeechBubble_scale() {
    if (this._SpeechBubble_scale_) return this._SpeechBubble_scale_;

    let scale = 1.5;
    if (MMD_SA.THREEX.enabled) {
      if (window.innerHeight * window.devicePixelRatio < 720)
        scale = 2;
      scale /= MMD_SA.SpeechBubble.get_fov_factor();
    }

    return scale;
  }
 ,set SpeechBubble_scale(v) { this._SpeechBubble_scale_ = v; }

 ,use_THREEX: true
 ,THREEX_options: {
    enabled_by_default: true,

//    use_MMD: true,
    use_MMDAnimationHelper: true,

//    use_VRM1: false,

    use_OutlineEffect: true,

//    model_path: 'C:\\Users\\user\\Downloads\\EL-Pr213-BosaHair\\EL-Pr213-BosaHair\\ボサ髪_v01.pmx'//'C:\\Users\\user\\Downloads\\iroha+kazama+v1.0\\iroha kazama v1.0\\model\\iroha kazama ver1.0.pmx'//System.Gadget.path + '/TEMP/DEMO/models/AvatarSample_A.vrm'

    model_para: {
"AliciaSolid.vrm" : {
	"camera": {
		"poseNet": {
			"arm_horizontal_offset_percent": 50
		}
	}
}
    },

    model_path_extra: []
  }

 ,audio_to_dance_disabled: true

 ,is_XR_Animator: true

// END
};

(function () {
  if (browser_native_mode && !webkit_window) {
    MMD_SA_options.width  = screen.width
    MMD_SA_options.height = screen.height
  }
  else {
    MMD_SA_options.width  = 960
    MMD_SA_options.height = 540
  }

//  RAF_animation_frame_unlimited = true

// always restart the electron app by complete relaunching instead of just reloading the page
  System._restart_full = true;

  Settings_default._custom_.EventToMonitor = "SOUND_ALL"
  Settings_default._custom_.Use30FPS = "non_default"
//  Settings_default._custom_.Use60FPS = "non_default"
  if (use_SA_browser_mode && !is_SA_child_animation)
    Settings_default._custom_.WallpaperAsBG = "non_default"
  Settings_default._custom_.Display = "-1"

  if (is_SA_child_animation)
    parent.DragDrop.relay_id = SA_child_animation_id

  if (!webkit_electron_mode)
    self.SA_wallpaper_src = System.Gadget.path + "/images/wood_wallpaper_flip-h.jpg";

  MMD_SA_options.WebXR.AR._adult_mode = !!System._browser.url_search_params.adult_mode || webkit_electron_mode;

  fetch(toFileProtocol(Settings.f_path + '/translation.json')).then(response=>{
    response.json().then(json=>{
      System._browser.translation.dictionary = json;
console.log(json);
    });
  });


// roomba
  var _s_ = 1;

  MMD_SA_options.motion_para["gura_sit_01"] = { onended: function () { MMD_SA._no_fading=true; }
// ,model_index_list: [0,2,3,4]
// ,model_name_RegExp: /Gura/
 ,adjust_center_view_disabled:false
 ,center_view:[0,-1.25,12.5]

 ,motion_tracking_enabled: true
 ,motion_tracking_upper_body_only: true
 ,adjustment_per_model: {
    _default_ : {
  skin_default: {
    "全ての親": { pos_add:{x:0, y:5.5*_s_, z:0} },
    "Start_Tail": { keys:[{ pos:{x:0, y:0.75*_s_, z:0}, rot:{x:-80-10, y:0, z:0} }] },
"センター": { pos_add:{x:0, y:-0.5*_s_, z:0.25*_s_} }
  },
    },
    "gura_xmas.pmx" : {
  skin_default: {
    "全ての親": { pos_add:{x:0, y:(5.5-0.5+5)*_s_, z:(0.25+1)*_s_} },
"左足ＩＫ":{ keys:[{ pos:{x:0, y:0, z:0} }] },
"右足ＩＫ":{ keys:[{ pos:{x:0, y:0, z:0} }] },
"Tail": { keys:[{ rot:{x:-30, y:0, z:0} }] },
  },
    }
  }
 ,skin_filter: { test: (name)=>(!/_tail/i.test(name)) }
 ,reset_rigid_body_physics_step: 20
 ,process_bones: function (model, skin) {
    var mesh = model.mesh
    if (!mesh._reset_rigid_body_physics_) return

    var bone = mesh.bones_by_name
    if (bone['スカート_0_0']) {
      bone['スカート_0_0'].quaternion.setFromEuler(MMD_SA.TEMP_v3.set(-72,  0,  0).multiplyScalar(Math.PI/180), 'YXZ')
      bone['スカート_0_7'].quaternion.setFromEuler(MMD_SA.TEMP_v3.set(-75, 45,-90).multiplyScalar(Math.PI/180), 'YXZ')
      bone['スカート_0_6'].quaternion.setFromEuler(MMD_SA.TEMP_v3.set(  0,  0,-30).multiplyScalar(Math.PI/180), 'YXZ')
      bone['スカート_0_1'].quaternion.setFromEuler(MMD_SA.TEMP_v3.set(-75,-45, 90).multiplyScalar(Math.PI/180), 'YXZ')
      bone['スカート_0_2'].quaternion.setFromEuler(MMD_SA.TEMP_v3.set(  0,  0, 30).multiplyScalar(Math.PI/180), 'YXZ')
//      bone['スカート_0_3'].quaternion.setFromEuler(MMD_SA.TEMP_v3.set( 50,  0,  0).multiplyScalar(Math.PI/180), 'YXZ')
//      bone['スカート_0_4'].quaternion.setFromEuler(MMD_SA.TEMP_v3.set( 70,  0,  0).multiplyScalar(Math.PI/180), 'YXZ')
//      bone['スカート_0_5'].quaternion.setFromEuler(MMD_SA.TEMP_v3.set( 50,  0,  0).multiplyScalar(Math.PI/180), 'YXZ')
    }

    var rot_hair = MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(45,  0,  0).multiplyScalar(Math.PI/180))
    bone['中髪後２'] && bone['中髪後２'].quaternion.copy(rot_hair);
    bone['左髪後２'] && bone['左髪後２'].quaternion.copy(rot_hair);
    bone['右髪後２'] && bone['右髪後２'].quaternion.copy(rot_hair);
  }
/*
 ,onplaying: function (model_index) {
var model = THREE.MMD.getModels()[model_index]

var rot_y = Math.PI/4//(rot_y + Math.sign(pos_speed) * 60*Math.PI/180*RAF_timestamp_delta/1000) % (Math.PI*2)
model.mesh.quaternion.copy(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.set(0, rot_y, 0)));
  }
*/
  };

  window.addEventListener('MMDStarted', ()=>{
    if (!/_MissBigHK_\-ghost_buruma2/.test(MMD_SA_options.model_path)) return;

    System._browser.on_animation_update.add((function () {
      var canvas = document.createElement('canvas');
      canvas.width  = 512;
      canvas.height = 256;

      var context = canvas.getContext('2d');
      context.fillStyle = 'black';
      context.font = 'bold 60px "Segoe Print"';
      context.textBaseline = 'top';

      var tex = THREE.MMD.getModels()[0].mesh.material.materials.find(m=>m.name=='sweater+').map;

      var canvas_content = [];

      return function () {
var content = [];
if (System._browser.motion_control.enabled_nut && System._browser.motion_control.ready) {
  const Key = System._browser.motion_control.Key;
  const key_pressed = System._browser.motion_control.key_pressed;

  let txt = '';
  if (key_pressed[Key.W]) {
    if (key_pressed[Key.A])
      txt += '⬉'
    else if (key_pressed[Key.D])
      txt += '⬈'
    else
      txt += '⬆'
  }
  else if (key_pressed[Key.S]) {
    if (key_pressed[Key.A])
      txt += '⬋'
    else if (key_pressed[Key.D])
      txt += '⬊'
    else
      txt += '⬇'
  }
  else {
    if (key_pressed[Key.A])
      txt += '⬅'
    else if (key_pressed[Key.D])
      txt += '⮕'
  }

  if (txt) txt = '🎮' + txt;
  content.push(txt);
}
else {
  content.push('#XRAnimator');//'⬆️🎯🏃Ⓐ⌨️🎮🎥');
}

var content_txt = content.join()
if (canvas_content.join() == content_txt) return;
canvas_content = content;

context.clearRect(0,0,512,256);

if (content_txt) {
  let w_max = 0, h_max = 60;
  for (let i = 0, i_length = content.length; i < i_length; i++) {
    const m = context.measureText(content[i])
    if (w_max < m.width)
      w_max = m.width
  }

  let y = (256 - content.length*(h_max+10)) / 2;
  for (let i = 0, i_length = content.length; i < i_length; i++) {
    context.fillText(content[i], (512-w_max)/2, y + i*(h_max+10))
  }
}

tex.image = canvas;
tex.needsUpdate = true;
      };
    })(), 0,0,-1)
  });

  System._browser.video_capture.trigger_on_startup_motion = true;


// dungeon options START
MMD_SA_options.Dungeon_options = {

  transparent_background: true

 ,use_octree: true

 ,use_PC_click_reaction_default: true

 ,joystick_disabled: true

 ,use_point_light: false

 ,shadow_camera_width: 32

 ,falling_height_threshold: 30

 ,motion: {
    "PC movement forward": {
  path:System.Gadget.path + '/MMD.js/motion/motion_rpg_pack01.zip#/walk_n_run/run_H01_f0-24.vmd',
  para_SA: {
    adjust_center_view_disabled: false,

    _speed: 2000/1800 *30,
    SFX: [
      { frame:4,  sound:{} },
      { frame:16, sound:{} },
    ],

    motion_tracking_enabled: true,
    motion_tracking_upper_body_only: true,
    motion_tracking: {
//      hand_camera_disabled: true,
    },
  }
    },

    "PC default": {
  para_SA: {
    adjust_center_view_disabled: false,

    motion_tracking_enabled: true,
    motion_tracking_upper_body_only: true,
    motion_tracking: {
      hip_adjustment: {
        rotation_weight: 0.5,
        displacement_weight: 1,
      },
    }
  }
    },

  }

 ,grid_material_list: [
/*
    {
  map: System.Gadget.path + "/images/_dungeon/tex/3dtextures.me/Sand 002/Sand 002_COLOR_AO.jpg"
 ,normalMap: System.Gadget.path + "/images/_dungeon/tex/3dtextures.me/Sand 002/Sand 002_NRM_c80.jpg"
 ,specularMap: System.Gadget.path + "/images/_dungeon/tex/3dtextures.me/Sand 002/Sand 002_SPEC_c80.jpg"
 ,geo_by_lvl: [[1,1]]//[[1,1],[16,16],[32,32],[128,128]]//
 ,distance_by_lvl: []//[1,2,4]//
 ,repeat_base: [64,64]
 ,instanced_drawing_by_lvl: [99]
    }
*/
  ]

 ,object_base_list: [
/*
    {
  construction: {
    build: function () {
var that = this;
window.addEventListener("GOML_ready", function () {
  let geometry = new THREE.RingGeometry(19.5, 20.5, 24, 1);
  geometry.applyMatrix(new THREE.Matrix4().makeRotationX(THREE.Math.degToRad(-90)));
  let material = new THREE.MeshBasicMaterial({ color:0xDC143C });
  let circle_2m = new THREE.Mesh(geometry, material);

  MMD_SA.scene.add(circle_2m);

  circle_2m.visible = false;

  that.mesh_obj = { id:"circle_2m", _obj:circle_2m }
  MMD_SA_options.mesh_obj.push(that.mesh_obj)
});
    }
  }
 ,placement: {
    position: {x:0, y:0.1, z:0}
   ,hidden: true
  }
 ,no_collision: true
    }
*/
// 0
    {
  path: Settings.f_path + '/assets/assets.zip#/model/baseball/baseball_v01.x'
// ,is_dummy: true
// ,construction:{castShadow:true}
 ,placement: {
    grid_id_filter: function () {
function condition(x_object, model_index) {
  var skin0 = (model_index == 0) && THREE.MMD.getModels()[0].skin
  if (skin0 && /baseball_throw/.test(MMD_SA.motion[skin0._motion_index].filename)) {
    Object.assign(this, (skin0.time < 140/30) ? this._baseball_throw : this._null);
  }
  else {
    x_object._obj_proxy.visible = false
    return false
  }

  return true
}

return [
  {
    para:{
      parent_bone: {
  model_index: 0
 ,condition: condition
 ,_null: { name:"" }
 ,_baseball_throw: { name:"右手首", position:{x:-0.5,y:-1,z:0} }
      }
    }
  }
];
    }
   ,scale: 10
  }
 ,no_collision: true
    },
/*
// roomba
// 1
    {
  path: 'F:\\Programs Portable\\node-webkit\\_TEMP\\gura_x_roomba\\data\\roomba\\roomba_v01.x'
// ,is_dummy: true
// ,construction:{castShadow:true}
 ,placement: {
    grid_id_filter: function () {
function condition(x_object, model_index) {
  var skin0 = (model_index == 0) && THREE.MMD.getModels()[0].skin
  if (skin0 && /gura_sit/.test(MMD_SA.motion[skin0._motion_index].filename)) {
    Object.assign(this, this._roomba);
  }
  else {
    x_object._obj_proxy.visible = false
    return false
  }

  return true
}

return [
  {
    para:{
      parent_bone: {
  model_index: 0
 ,condition: condition
//{ name:'センター', position:(/gura_xmas/.test(MMD_SA_options.model_path))?{x:0, y:-6.7*_s_, z:1.95*_s_}:{x:0, y:-2.7*_s_, z:0.95*_s_}, rotation:{x:-10, y:0, z:0} }
 ,_roomba: { name:'センター', position:(/gura_xmas/.test(MMD_SA_options.model_path))?{x:0, y:-6.7*_s_, z:1.95*_s_}:{x:0, y:-2.7*_s_, z:0.95*_s_}, rotation:{x:-10, y:0, z:0} }
      }
    }
  }
];
    }
   ,scale: 22*_s_ *(MMD_SA_options.WebXR.model_scale || 0.9)
  }
 ,no_collision: true
    }
*/
  ]

 ,item_base: {
    "reticle" : {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/yellow-target_64x64.png'
 ,info_short: "AR reticle"

 ,is_base_inventory: is_mobile
// NOTE: use undefined for index_default ((null >= 0) is true...)
 ,index_default: undefined
// ,get index_default() { return (is_mobile) ? undefined : MMD_SA_options.Dungeon.inventory.max_base+1; }

 ,stock_default: (is_mobile) ? 1 : 0
 ,stock_max: 1
 ,action: {
    func: function (item) {
if (!MMD_SA.WebXR.session) {
//  DEBUG_show("(AR mode only)", 3); return true;
  MMD_SA_options.Dungeon.run_event("_ENTER_AR_",0)
}
else {
//SA_AR_dblclick
  const result = { return_value:null };
  window.dispatchEvent(new CustomEvent("SA_AR_dblclick", { detail:{ e:{}, is_item:true, result:result } }));
}
    }
  }
    }

   ,"streamer_mode": (()=>{
      const streamer_mode = {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/streamer_64x64.png'
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.streamer_mode.info_short'); }
// ,is_base_inventory: true

 ,index_default: (is_mobile) ? undefined : 0

 ,stock_max: 1
 ,stock_default: 1

 ,action: {
    func: function () { System._browser.camera.streamer_mode.start(); }
//    ,muted: true
//   ,anytime: true
  }

 ,get info() { return System._browser.translation.get('XR_Animator.UI.streamer_mode.info'); }
      };

      return streamer_mode;
    })()

   ,"pose": (function () {
      function morph_event(e) {
var mf = morph_form[morph_form_index]
if (mf) {
  let model = e.detail.model
  for (const morph_name in mf) {
    let _m_idx = model.pmx.morphs_index_by_name[morph_name]
    let _m = model.pmx.morphs[_m_idx]
    MMD_SA._custom_morph.push({ key:{ weight:mf[morph_name], morph_type:_m.type, morph_index:_m_idx }, idx:model.morph.target_index_by_name[morph_name] })
  }
}
//DEBUG_show(Date.now()+":"+MMD_SA._custom_morph.length)
      }

      let motion_loading = false;
      async function load_motion(index) {
// save some headaches and not using motion_loading to avoid using nested error handling if file loading fails
//motion_loading = true;
if (!MMD_SA.motion[index]) {
  const m = MMD_SA_options.motion[index];
  await MMD_SA.load_external_motion(m.path, false);
}
//motion_loading = false;
      }

      function load_motion_on_finish(index) {
MMD_SA_options._motion_shuffle_list_default = [index];
MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice();
MMD_SA._force_motion_shuffle = true;
window.addEventListener('SA_MMD_model0_onmotionchange', ()=>{ MMD_SA.WebXR.ground_plane.visible=System._browser.camera.poseNet.ground_plane_visible }, {once:true});

System._browser.on_animation_update.add(()=>{
  if (MMD_SA_options._XRA_pose_list?.[0].find(p=>p.is_custom_motion && p.name==MMD_SA.MMD.motionManager.filename) != null) {
//DEBUG_show(MMD_SA.MMD.motionManager._timeMax)
    MMD_SA.motion_player_control.enabled = true;
  }
}, 0,1);

MMD_SA_options.Dungeon_options.item_base.social_distancing && MMD_SA_options.Dungeon_options.item_base.social_distancing.reset();

if (System._browser.camera.initialized) System._browser.on_animation_update.add(()=>{ System._browser.camera._update_camera_reset(); }, 1,1);

if (MMD_SA_options.Dungeon._event_active.id == '_POSE_') MMD_SA_options.Dungeon.run_event(null,null,0);
      }

      async function change_motion(motion_index_absolute, ignore_event) {
const model_mesh = THREE.MMD.getModels()[0].mesh;
if (!model_mesh.visible) return true;

if (ignore_event) {
  if (motion_index_absolute == -1) {
    change_custom_motion();
    return;
  }
}
else if ((motion_index_absolute == null) && !MMD_SA_options.Dungeon.event_mode) {
  MMD_SA_options.Dungeon.run_event("_POSE_",0)
  return
}
else if ((motion_index_absolute != null) && (MMD_SA_options.Dungeon._event_active.id != "_POSE_"))
  return true

//DEBUG_show(MMD_SA.MMD.motionManager.filename)

if (!motion_loading) {//MMD_SA_options.motion_shuffle_list_default && (MMD_SA_options.motion_shuffle_list_default.indexOf(MMD_SA.MMD.motionManager._index) != -1)) {
  if (!morph_event_registered) {
    morph_event_registered = true
    window.addEventListener("SA_MMD_model0_process_morphs", morph_event)
  }

  let motion_list_index = (System._browser.camera.poseNet.enabled) ? 2 : 1;

  let motion_list = _motion_list[motion_list_index]
  if (motion_list_index != _motion_list_index) {
    motion_index = ((motion_list_index == 1) && (_motion_list_index == -1)) ? 0 : -1
  }
  _motion_list_index = motion_list_index

  if (motion_index_absolute != null)
    motion_index = motion_index_absolute
  else
    motion_index++

  if (motion_index >= motion_list.length) {
    motion_index = 0
    if (++morph_form_index == morph_form.length) morph_form_index = 0;
  }

  let motion_name = motion_list[motion_index].name
  motion_list[motion_index].action && motion_list[motion_index].action(motion_name)

  const motion_para = MMD_SA_options.motion_para[motion_name];
  if (motion_para?._speed && !MMD_SA_options.Dungeon_options.character_movement_disabled) {
    const mov = MMD_SA_options.Dungeon.motion['PC movement forward'];
    mov.index = motion_para._index;
    mov.name = motion_name;
    mov.path = motion_para._path;

    const id_to_include = ['keyCode','motion_id','mov_speed'];
    mov.para = Object.assign({}, mov.para);
    Object.keys(mov.para).filter(p=>id_to_include.indexOf(p)==-1).forEach(p=>{
      if (motion_para[p] == null)
        delete mov.para[p];
    });
    Object.assign(mov.para, motion_para);

    MMD_SA_options.Dungeon.motion_filename_by_id['PC movement forward'] = motion_name;
    MMD_SA_options.Dungeon.motion_id_by_filename[motion_name] = 'PC movement forward';

    return;
  }

  const index = MMD_SA_options.motion_index_by_name[motion_name];
  await load_motion(index);
  load_motion_on_finish(index);
}
else {
  System._browser.camera.DEBUG_show('(motion still loading)', 3);
  return true
}
      }

      function change_custom_motion() {
const animation = MMD_SA.THREEX.get_model(0).animation;
const MMD_animation_customized = MMD_SA_options.motion.length > MMD_SA.motion_max_default;
const MMD_animation_on = THREE.MMD.getModels()[0].skin._motion_index >= MMD_SA.motion_max_default;

let animation_on;

if (animation.has_clip && (!MMD_animation_customized || animation.enabled || MMD_animation_on)) {
  animation.enabled = !animation.enabled;
  animation_on = animation.enabled;
  if (animation_on) {
    if (MMD_animation_on) {
      animation._motion_index = MMD_SA_options._motion_shuffle_list_default[0];
      MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice();
      MMD_SA._force_motion_shuffle = true;
    }
  }
  else {
    MMD_SA.THREEX.get_model(0).animation._motion_index = null;
  }
}
else if (MMD_animation_customized) {
  animation_on = !MMD_animation_on;
  if (!animation_on) {
    MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice();
    MMD_SA._force_motion_shuffle = true;
  }
  else {
    const index = MMD_SA_options.motion.length-1;
    load_motion(index).then(()=>{
      load_motion_on_finish(index);
    });
  }
}

return animation_on;
      }

      var morph_event_registered = false

      var morph_form = [null]
      var morph_form_index = 0

      var _motion_list_index = -1
      var _motion_list = []

      var motion_index

      window.addEventListener("jThree_ready", function () {
function delay_dialogue() {
  MMD_SA_options.Dungeon.run_event();
}

function export_motion_config() {
  const motion_para = MMD_SA.MMD.motionManager.para_SA;
  const motion_id = motion_para._path.replace(/^.+[\/\\]/, '').replace(/\.\w{3,4}$/, '');
  const config = {
    System_Animator_motion_para: {}
  };
  config.System_Animator_motion_para[motion_id] = { motion_tracking: motion_para.motion_tracking || {} };

  let json;
  try {
    json = JSON.stringify(config, null, '\t');
  }
  catch (err) {
    DEBUG_show('ERROR: The config of the current motion is not exportable.', 3);
    return;
  }

  System._browser.save_file('motion_para.json', json, 'application/json');
}

function sort_by_index(a,b) {
  return a.index-b.index;
}

const index_first = 2;
function swap_motion(index, index_to_swap=0, is_swap) {
//DEBUG_show(index+'/'+index_to_swap+'/'+!!is_swap,0,1)
  let motion_id;
  if (index == null) {
    const motion_para = MMD_SA.MMD.motionManager.para_SA;
    motion_id = motion_para._path.replace(/^.+[\/\\]/, '').replace(/\.\w{3,4}$/, '');
    index = _motion_list[0].findIndex(m=>m.name==motion_id);
  }
  else {
    motion_id = _motion_list[0][index].name;
  }
//DEBUG_show(motion_id+'/'+index)
  if (index <= index_first) return;

  if (is_swap && (index_to_swap <= index_first))
    is_swap = false;

  if (is_swap) {
    const _index = _motion_list[0][index].index;
    _motion_list[0][index].index = _motion_list[0][index_to_swap].index;
    _motion_list[0][index_to_swap].index = _index;
  }
  else {
    _motion_list[0][index].index = Math.max(index_to_swap, index_first) + 0.5;
  }
  _motion_list[0].sort(sort_by_index);
  _motion_list[0].forEach((m,i)=>{ m.index=i; });

  for (let i = 1; i < _motion_list.length; i++)
    _motion_list[i].sort(sort_by_index);

  const list_index = (System._browser.camera.poseNet.enabled) ? 2 : 1;
  const index_new = _motion_list[list_index].findIndex(m=>m.name==motion_id);
  _motion_page = parseInt(index_new/9);
}

let motion_list_length_default;
function reset_list_order(order) {
  if (order) {
    _motion_list[0].sort((a,b)=>a.index_default-b.index_default);
    order.forEach((index,i)=>{
      if (index >= 1000) index = motion_list_length_default + (index - 1000);
      if (_motion_list[0][index])
        _motion_list[0][index].index = i;
    });
  }
  else {
    _motion_list[0].forEach(m=>{ m.index=m.index_default; });
  }

  for (let i = 0; i < _motion_list.length; i++)
    _motion_list[i].sort(sort_by_index);

  _motion_page = 0;
}

function clear_custom_motion() {
  let motion_list_index = (System._browser.camera.poseNet.enabled) ? 2 : 1;
  const reset_motion = _motion_list[motion_list_index].find(m=>m.is_custom_motion && m.name==MMD_SA.MMD.motionManager.filename);

  for (let i = 0; i < _motion_list.length; i++)
    _motion_list[i] = _motion_list[i].filter(m=>!m.is_custom_motion);

  if (reset_motion)
    change_motion(0, true);
}

function mirror_pose() {

function swap_LR(p, LR=['left','right']) {
  if ((p != null) && ((p[LR[0]] != null) || (p[LR[1]] != null))) {
    const _left = p[LR[0]];
    p[LR[0]] = p[LR[1]];
    p[LR[1]] = _left;
  }
}

const model_para = MMD_SA.MMD.motionManager.para_SA;
if (model_para.mirror_disabled) return;

const model = THREE.MMD.getModels()[0];
const mirror_scale = MMD_SA._v3a.set(1,-1,-1);
model.skin.targets.forEach(t=>{
  let b_name, b_idx;
  const k0 = t.keys[0];
  const is_LR = k0.name.charAt(0)=='左' || k0.name.charAt(0)=='右';
  if (is_LR) {
    b_name = ((k0.name.charAt(0)=='左')?'右':'左') + k0.name.substring(1);
    t.i = model.pmx.bones.findIndex(b=>b.name==b_name);
  }

  const k_length = t.keys.length;
  t.keys.forEach((k,i)=>{
    if (is_LR)
      k.name = b_name;
// skip cloned key
    if ((k_length > 1) && (i == k_length-1) && (t.keys[i-1].pos == k.pos)) return;

    k.pos[0] *= -1;

    MMD_SA.TEMP_v3.setEulerFromQuaternion(MMD_SA.TEMP_q.fromArray(k.rot), 'YXZ').multiply(mirror_scale);
    const rot = MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3, 'YXZ');
    k.rot[0] = rot.x;
    k.rot[1] = rot.y;
    k.rot[2] = rot.z;
    k.rot[3] = rot.w;
  });
});

if (model_para.center_view) {
  model_para.center_view[0] *= -1;
  MMD_SA.reset_camera();
}

const motion_tracking = [model_para.motion_tracking];

motion_tracking.forEach(mt=>{
  if (!mt) return;

  const hip_adjustment = mt.hip_adjustment;
  if (hip_adjustment) {
    swap_LR(hip_adjustment);
  }

  const arm_default_stickiness = mt.arm_default_stickiness;
  if (arm_default_stickiness) {
    if (arm_default_stickiness.left || arm_default_stickiness.right) {
      swap_LR(arm_default_stickiness);
    }
    for (const p of [arm_default_stickiness, arm_default_stickiness.left, arm_default_stickiness.right]) {
      const weight_x = p?.parent?.weight?.x;
      if (weight_x != null) {
        swap_LR(weight_x);
      }
    }
  }

  const arm_tracking = mt.arm_tracking;
  if (arm_tracking) {
    if (arm_tracking.elbow_lock) {
      swap_LR(arm_tracking.elbow_lock);
    }
  }

  const arm_as_leg = mt.arm_as_leg;
  if (arm_as_leg) {
    if (arm_as_leg.linked_side)
      arm_as_leg.linked_side = (arm_as_leg.linked_side == 'left') ? 'right' : 'left';
    const position = arm_as_leg.transformation?.position;
    if (position) {
      for (const a of ['x','y','z']) {
        if ((a == 'x') && position.x) {
          for (const m of ['min','max']) {
            const v = position.x[m];
            if (typeof v == 'number')
              position.x[m] = { left:v, right:v };
          }
          const L = { min:position.x?.max?.right, max:position.x?.min?.right };
          const R = { min:position.x?.max?.left,  max:position.x?.min?.left  };
          for (const m of ['min','max']) {
            if ((L[m] != null) && (R[m] != null)) {
              position.x[m] = { left:-L[m], right:-R[m] };
            }
            else if ((L[m] != null) || (R[m] != null)) {
              const v = (L[m] != null) ? L[m] : R[m];
              position.x[m] = { left:-v, right:-v };
            }
            else {
              delete position.x[m];
            }
          }
        }
        for (const p of ['add','scale']) {
          const para = position[a]?.[p];
          if (para != null) {
            swap_LR(para);
            if (a == 'x') {
              if (p == 'add') {
                if (typeof para == 'number') {
                  position.x.add *= -1;
                }
                else {
                  if (para.left != null)
                    para.left *= -1;
                  if (para.right != null)
                    para.right *= -1;
                }
              }
             }
          }
        }
      }

      const rotation = position.rotation;
      if (rotation && (rotation.y != null))
        rotation.y *= -1;

      const position_to_rotation = position.position_to_rotation;
      if (position_to_rotation) {
        for (const p of ['upper','lower']) {
          for (const a of ['x','y','z']) {
            swap_LR(position_to_rotation[p]?.[a]?.curve);
          }
        }
      }
    }
  }
});

}

window.addEventListener('SA_on_external_motion_loaded', (e)=>{
  const path = e.detail.path;
  if (/\.zip\#/i.test(path) || /_(camera|morph)\.vmd$/i.test(path)) return;

  if (_motion_list[0].some(m=>m.path==path)) return;

  const motion_id = path.replace(/^.+[\/\\]/, '').replace(/\.\w{3,4}$/, '');
  const para = MMD_SA_options.motion_para[motion_id];

  let info = motion_id.substring(0,20);
  info = info.substring(0, 10+Math.round(info.replace(/[^\u0000-\u00ff]/s, '').length/2));
  const m = { is_custom_motion:true, path:path, name:motion_id, info:'👤'+info+' (🙋)' };

  const i = e.detail.index || _motion_list[0].length;
  m.index_default = i;
  m.index = i;
  if (para && !para.motion_blending) {
    para.motion_blending = {
      fadein: {}
    };
  }

  _motion_list[0].push(m);
  _motion_list[1].push(m);
  _motion_list[2].push(m);
//  DEBUG_show(path);
});

var mf = MMD_SA_options.model_para_obj.morph_form
if (mf) {
  morph_form = morph_form.concat(Object.values(mf))
}

_motion_list[0] = [
  {name:"standmix2_modified", info:"Stand relaxed"},

  {
    name:"stand_simple", get info() { return 'Stand simple (💃➔' + System._browser.translation.get('XR_Animator.UI.pose.full_body_mocap') + ')'; },
    action: (name)=>{ MMD_SA_options.motion_para[name].center_view_enforced = false },
  },

  {
    name:"stand_simple", get info() { return 'Stand simple (🙋➔' + System._browser.translation.get('XR_Animator.UI.pose.upper_body_mocap') + ')'; },
    action: (name)=>{ MMD_SA_options.motion_para[name].center_view_enforced = true },
  },

// roomba
//{name:"gura_sit_01"},

  {name:"tsuna_standby", info:"Standby (🙋)"},

  {name:"Mixamo - Happy Idle", info:"Happy idle (🙋)"},

  {name:"i-shaped_balance_TDA_f0-50", info:"I-shaped balance (🙋)"},

//  {name:"leg_hold", info:"???", _MMD_only_:true},

  {name:"Mixamo - Sitting02", info:"Sit 01 (🙋/🦶)"},

  {name:"chair_sit01_armIK", info:"Sit 02 (🦶/🙋)"},

  {name:"Mixamo - Sitting Idle01", info:"Sit 03 (🙋/🦶)"},

  {name:"sitting_sexy01", info:"Sit 04 (🙋/🦶)"},

  {name:"Mixamo - Female Sitting Pose01", info:"Sit 05 (🙋/🦶))"},

  {name:"Mixamo - Female Sitting Pose02", info:"Sit 06 (🙋/🦶)"},

  {name:"sitting_sexy03", info:"Sit 07 (🙋/🦶)"},

  {name:"sitting_sexy04", info:"Sit 08 (🙋/🦶)"},

  {name:"Mixamo - Sitting Idle02", info:"Sit 09 (🙋/🦶)"},

//  {name:"gal_model_motion_with_legs-2_loop_v01", info:"Sit - Floating (🙋)"},

  {name:"sitting_sexy05", info:"Sit 10 (🙋/🦶)"},

  {name:"sitting_sexy06", info:"Sit 11 (🙋/🦶)"},

  {name:"sitting_sexy02", info:"Legs on table (🙋/🦶)"},

  {name:"prone_pose01", info:"Prone 01 (🙋/🦶)"},

  {name:"sitting_sexy07", info:"Sit 12 (🙋/🦶)"},

  {name:"sitting_sexy08", info:"Sit 13 (🙋/🦶)"},

  {name:"Mixamo - Female Laying Pose01", info:"Laying pose (🙋/🦶)"},

  {name:"モブ歩き男80f", info:"Walk (🙋/👟)"},

  {name:"walk_A34_f0-42", info:"Hip Walk (🙋/👟)"},

  {name:"run_H01_f0-24", info:"Run (🙋/👟)"},

  {name:"sitting_sexy09", info:"Sit 14 (🙋/🦶)"},

  {name:"sitting_sexy10", info:"Sit 15 (🙋/🦶)"},

  {name:"sit_simple", info:"Sit simple (🙋)"},

  {name:"model_pose01", info:"Model pose 01 (🙋)"},

  {name:"model_pose02", info:"Model pose 02 (🙋)"},

  {name:"model_pose03", info:"Model pose 03 (🙋/🦶)"},

].filter(m=>m!=null);

motion_list_length_default = _motion_list[0].length;

_motion_list[0].forEach(m=>{
  MMD_SA_options.motion_para[m.name].adjustment_by_scale = { 'センター':{ reference_value:11.36464 } };
});

_motion_list[1] = _motion_list[0].filter((m)=>!m._MMD_only_ || (!MMD_SA.THREEX.enabled/* && MMD_SA_options.WebXR.AR._adult_mode*/));

_motion_list[2] = _motion_list[0].filter((m)=>MMD_SA_options.motion_para[m.name].motion_tracking_enabled);

_motion_list[0].forEach((m,i)=>{
  const para = MMD_SA_options.motion_para[m.name];
  m.index_default = i;
  m.index = i;
  if (para && !para.motion_blending) {
    para.motion_blending = {
      fadein: {}
    };
  }
});

MMD_SA_options._XRA_pose_list = _motion_list;
MMD_SA_options._XRA_pose_reset = reset_list_order;
MMD_SA_options._XRA_clear_custom_motion = clear_custom_motion;
MMD_SA_options._XRA_mirror_pose = mirror_pose;

let _motion_page = 0;

let _has_custom_animation_;

function get_target_index(sb, key) {
  if (key != null) {
    const msg_branch_list = MMD_SA_options.Dungeon.dialogue_branch_mode.filter(b=>!b.sb_index);
    const branch = msg_branch_list?.findIndex(b=>((b.sb_index||0)==(sb.index||0)) && (b.key==key));
    return branch;
  }
}

const _on_drag = {
  outside_menu: {
    func: function (sb_drag, outside_menu) {
const list_index = (System._browser.camera.poseNet.enabled) ? 2 : 1;
const offset = list_index-1;

const index = get_target_index(sb_drag, sb_drag._drag_key_)+offset + _motion_page*9;

let index_to_swap;
//DEBUG_show(outside_menu)
if (outside_menu == 'bottom') {
  index_to_swap = 9999;
}
else if (outside_menu == 'left') {
  index_to_swap = index - 9-1;
}
else if (outside_menu == 'right') {
  index_to_swap = index + 9;
}
else {
  index_to_swap = 0;
}
//DEBUG_show(index+'/'+index_to_swap)
swap_motion(index, index_to_swap);

MMD_SA_options.Dungeon.run_event('_POSE_',0,0);
    }
  }
};

const _on_drop = {
  func: function (sb_drag, sb) {
const list_index = (System._browser.camera.poseNet.enabled) ? 2 : 1;
const offset = list_index-1;

let index = get_target_index(sb_drag, sb_drag._drag_key_)+offset + _motion_page*9;
let index_to_swap = get_target_index(sb, sb._branch_key_)+offset + _motion_page*9;
//DEBUG_show(index+'/'+index_to_swap+'/'+_motion_page,0,1)
if (index > index_to_swap) index_to_swap--;
swap_motion(index, index_to_swap, false);

MMD_SA_options.Dungeon.run_event('_POSE_',0,0);
  }
};

MMD_SA_options.Dungeon_options.events_default["_POSE_"] = [
//0
      [

        {
          func: ()=>{
if (THREE.MMD.motionPlaying) {
  window.addEventListener('SA_MMD_model0_process_bones_after_IK', delay_dialogue, {once:true});
}
else {
  MMD_SA_options.Dungeon.run_event();
}
          }
        },

        {
          message: {
  get content() {
const index = (System._browser.camera.poseNet.enabled) ? 2 : 1;
_has_custom_animation_ = (MMD_SA.THREEX.enabled && MMD_SA.THREEX.get_model(0).animation.has_clip) || (MMD_SA_options.motion.length > MMD_SA.motion_max_default);

if (_motion_page * 9 >= _motion_list[index].length)
  _motion_page = 0;
let ini = _motion_page * 9;

const content =  _motion_list[index].slice(ini, ini+9).map((m,i)=>{
  const motion_para = MMD_SA_options.motion_para[m.name];
  let info_prefix = '';
  let info_suffix = '';
  if (motion_para == MMD_SA.MMD.motionManager.para_SA) {
    if ((m.name != 'stand_simple') || (!motion_para.motion_tracking_upper_body_only == (m.info.indexOf(System._browser.translation.get('XR_Animator.UI.pose.full_body_mocap')) != -1)))
      info_prefix = '✔️';
  }
  if (motion_para?._speed && (MMD_SA_options.Dungeon.motion['PC movement forward'].name == m.name)) {
    info_suffix = '🏃';
  }

  return (i+1)+'. ' + info_prefix + (m.info||m.name) + info_suffix;
}).join('\n')
+ ((_has_custom_animation_) ? '\n0. (👤' + System._browser.translation.get('XR_Animator.UI.pose.custom_pose') + ')' : '');
//+ ((_has_custom_animation_) ? ('\n0. (👤Custom motion: ' + (((this._animation_on_ != null) ? this._animation_on_ : (MMD_SA.THREEX.enabled && MMD_SA.THREEX.get_model(0).animation.enabled) || (THREE.MMD.getModels()[0].skin._motion_index >= MMD_SA.motion_max_default))?'ON':'OFF') + ') (🙋)') : '');

//DEBUG_show(''+this._animation_on_,0,1)
//MMD_SA_options.SpeechBubble_branch.confirm_keydown=false

System._browser.on_animation_update.add(()=>{this._animation_on_ = null},0,0);

return content;
  },

  bubble_index: 3,
  para: { row_max:11, font_size:17, no_word_break:true },

  get branch_list() {
const index = (System._browser.camera.poseNet.enabled) ? 2 : 1;

let ini = _motion_page * 9;

return _motion_list[index].slice(ini, ini+9).map((m,i) => { return { key:i+1, on_drag:(_motion_page || (i > 3-index))?_on_drag:null, on_drop:_on_drop, event_id:{ func:()=>{ change_motion(ini+i); System._browser.on_animation_update.add(()=>{MMD_SA_options.Dungeon.run_event('_POSE_',0,0)},20,0); }, } }; })
  .concat((_has_custom_animation_)?[{ key:0, event_id:{ func:()=>{ this._animation_on_=change_custom_motion(); System._browser.on_animation_update.add(()=>{MMD_SA_options.Dungeon.run_event('_POSE_',0,0)},20,0); }, } }]:[]);
  },
          },

          next_step: {},
        },

        {
message: {
  index: 1,
  bubble_index: 3,
  para: { row_max:11 },
  get content() { return System._browser.translation.get('XR_Animator.UI.pose.pose') + (_motion_page*9+1) + '-' + (_motion_page*9+9) + ' (' + System._browser.translation.get('XR_Animator.UI.pose.page') + (_motion_page+1) + ')\n' + ((_motion_page <= 1) ? '・' + System._browser.translation.get('XR_Animator.UI.pose.hotkey') + ': ' + ((_motion_page == 0) ? 'Alt' : 'Ctrl') + '+Numpad' + ((_has_custom_animation_) ? 0 : 1) + '-9\n' : '・' + System._browser.translation.get('XR_Animator.UI.pose.hotkey') + ': N/A') + '\nA. ' + System._browser.translation.get('XR_Animator.UI.pose.next_poses') + '\nB. ' + System._browser.translation.get('XR_Animator.UI.pose.shoulder_adjust') + ': ' + System._browser.translation.get('XR_Animator.UI.pose.shoulder_adjust.' + (MMD_SA.THREEX.shoulder_adjust||'Default')) + '\n' + System._browser.translation.get('XR_Animator.UI.pose.extra'); },
  branch_list: [
    { key:'A', event_id:{ func:()=>{ _motion_page++ }, goto_event:{id:'_POSE_',branch_index:0} } },
    { key:'B', event_id:{ func:()=>{
const para = ['Full', '', 'Upper half', 'None'];
let index = (para.indexOf(MMD_SA.THREEX.shoulder_adjust||'')) + 1;
if (index >= para.length)
  index = 0;
MMD_SA.THREEX.shoulder_adjust = para[index];
System._browser.camera.DEBUG_show('NOTE: Restart the app for changes to apply to existing motions and poses.', 5);
      }, goto_event:{id:'_POSE_',branch_index:0} },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.pose.shoulder_adjust.tooltip')
);
      }
    },
    { key:'C', event_id:{ func:()=>{ mirror_pose(); }, goto_event:{id:'_POSE_',branch_index:0} },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.pose.mirror_current_pose.tooltip')
);
      }
    },
    { key:'D', event_id:{ func:()=>{ swap_motion(); }, goto_event:{id:'_POSE_',branch_index:0} },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.pose.push_current_pose_to_list_top.tooltip')
);
      }
    },
    { key:'E', event_id:{ func:()=>{ reset_list_order(); DEBUG_show('(pose list reset)',3); }, goto_event:{id:'_POSE_',branch_index:0} },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.pose.reset_pose_list_order.tooltip')
);
      }
    },
    { key:'F', event_id:{
        message: {
          index: 1,
          bubble_index: 3,
          content: System._browser.translation.get('XR_Animator.UI.pose.clear_all_custom_poses.confirm'),
          branch_list: [
            {key:'Y', event_id:{ func:()=>{ clear_custom_motion() }, goto_event:{id:'_POSE_',branch_index:0} } },
            {key:'N', branch_index:0 },
          ]
        },
      },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.pose.clear_all_custom_poses.tooltip')
);
      }
    },
    { key:'G', event_id:{ func:()=>{ export_motion_config() }, goto_event:{id:'_POSE_',branch_index:0} },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.pose.export_current_pose_config.tooltip') 
);
      }
    },
    { key:'X', is_closing_event:true, event_id:{ next_step:{} } },
  ]
}
        },

        {
          func: ()=>{
          },
          ended: true,
        }
      ]
];

      });

      var pose = {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/tap-dance_64x64.png'
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.pose.info_short'); }
// ,is_base_inventory: true
 ,stock_max: 1
 ,stock_default: 1

 ,_change_motion_: change_motion
 ,action: {
    set _motion_list_index(v) { _motion_list_index = v; },
    func: function () { change_motion() }
//    ,muted: true
//   ,anytime: true
  }
 ,reset: function () {
if (morph_event_registered) {
  morph_event_registered = false
  window.removeEventListener("SA_MMD_model0_process_morphs", morph_event)
}

MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["standmix2_modified"]]
  }

 ,get info() {
let info = '';

info = (System._browser.camera.ML_enabled) ? ((MMD_SA.MMD.motionManager.para_SA.motion_tracking_enabled) ? System._browser.translation.get('XR_Animator.UI.pose.info.ML_on.tracking_on').replace(/\<tracking_mode\>/, System._browser.translation.get('XR_Animator.UI.pose.info.ML_on.tracking_on.' + ((MMD_SA.MMD.motionManager.para_SA.motion_tracking_upper_body_only) ? 'upper_body' : 'full_body'))) : System._browser.translation.get('XR_Animator.UI.pose.info.ML_on.tracking_off')) : System._browser.translation.get('XR_Animator.UI.pose.info.ML_off');
info += '\n';

info += System._browser.translation.get('XR_Animator.UI.pose.info.extra').replace(/\<hotkey\>/, System._browser.hotkeys.config_by_id['arm_to_leg_control_mode']?.accelerator[0]||'');

return info;
  }
      };

      return pose;
    })()

   ,"selfie" : {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/' + ((is_mobile) ? 'selfie_64x64.png' : 'webcamera_64x64.png')
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.webcam_media.info_short.' + ((is_mobile) ? 'selfie_camera' : 'webcam_media')); }
// ,is_base_inventory: true
 ,stock_max: 1
 ,stock_default: 1

 ,action: {
    func: function (item) {
if (System._browser.camera.streamer_mode.running) return true;

if (MMD_SA.WebXR.session && !MMD_SA.WebXR.user_camera.initialized) {
  DEBUG_show("(You need to activate it before entering AR mode.)", 3)
  return true
}

if (!MMD_SA.WebXR.user_camera.initialized || !MMD_SA.WebXR.user_camera.visible) {
//  if (MMD_SA_options.Dungeon.inventory.action_disabled) return true
  MMD_SA_options.Dungeon.run_event("_SELFIE_",0)
}
else {
  MMD_SA.WebXR.user_camera.start()
}
    }
//   ,anytime: true
  }

 ,get info() {
var info = ''

if (System._browser.camera.visible) {
  if (System._browser.camera.ML_enabled) {
    info += System._browser.translation.get('XR_Animator.UI.webcam_media.info.camera_on.ML_on');
  }
  else {
    info += System._browser.translation.get('XR_Animator.UI.webcam_media.info.camera_on.ML_off');
  }
}
else {
  info += System._browser.translation.get('XR_Animator.UI.webcam_media.info.camera_off');
}

return info;
  }
    }

   ,"facemesh" : (()=>{
      function mocap_hotkeys(e) {
const ev = e.detail.e;
switch (ev.code) {
  case 'Pause':
    const camera = System._browser.camera;
    if (camera.initialized && camera.ML_enabled) {
      if (mocap_pause_timerID) {
        clearInterval(mocap_pause_timerID);
        mocap_pause_timerID = null;
      }

      if (camera.video.paused) {
        camera.video.play();
        camera.DEBUG_show('');
      }
      else {
        mocap_pause_countdown = 3;
        mocap_pause_timerID = setInterval(()=>{
          if (--mocap_pause_countdown == 0) {
            clearInterval(mocap_pause_timerID);
            mocap_pause_timerID = null;

            camera.video.pause();
            camera.DEBUG_show('⏸️PAUSED');
          }
          else {
            camera.DEBUG_show('⏸️Pausing in...' + mocap_pause_countdown);
          }
        }, 1000);

        camera.DEBUG_show('⏸️Pausing in...' + mocap_pause_countdown);
      }
    }
    break
  default:
    return;
}

e.detail.result.return_value = true;
      }

      let mocap_pause_timerID, mocap_pause_countdown;

      window.addEventListener('MMDStarted', ()=>{
        window.addEventListener('SA_keydown', mocap_hotkeys);
      });

      return {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/motion-capture_64x64.png'
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.motion_capture.info_short'); }
// ,is_base_inventory: true
 ,stock_max: 1
 ,stock_default: 1

 ,action: {
    func: function (item) {
if (MMD_SA.WebXR.user_camera.bodyPix.enabled) {
  DEBUG_show("(You can't enable motion capture and Selfie Segmentation AI at the same time.)", 5)
  return true
}

if (System._browser.camera.motion_recorder.speed) {
  System._browser.camera.motion_recorder.speed = 0
}
else if (!MMD_SA.WebXR.user_camera.ML_enabled) {
  MMD_SA_options.Dungeon.run_event("_FACEMESH_",0)
}
else  {
  MMD_SA_options.Dungeon.run_event("_FACEMESH_OPTIONS_",0)
}
    }
//   ,anytime: true
  }

 ,get info() {
var info = ''

if (System._browser.camera._info) {
  info += System._browser.camera._info;
}
else if (System._browser.camera.motion_recorder.speed) {
   info += System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed.begin_recording.info');
}
else if (System._browser.camera.ML_enabled) {
  if (!System._browser.camera.visible)
    info += System._browser.translation.get('XR_Animator.UI.motion_capture.info.ML_on.camera_off') + '\n';
  info += System._browser.translation.get('XR_Animator.UI.motion_capture.info.ML_on');
}
else {
  info += System._browser.translation.get('XR_Animator.UI.motion_capture.info.ML_off');
}

return info;
  }

//'123 \\A 123 \\A 789 \\A 789 \\A 789'
/*
 ,onmouseover: function (e, index) {
var SB = MMD_SA.SpeechBubble.list[1]
SB.message(0, 'Enable motion capture to control the avatar with your body.', 4*1000, {group_index:0, group:{name:"motion_capture", loop:1}})
SB.message(0, 'You can track your face, ' + ((System._browser.camera.poseNet.use_holistic) ? 'or full body (Holistic).' : 'full body, or something in between.'), 4*1000, {group:{name:"motion_capture"}})
  }
// ,onmouseout: function (e) {}
*/
      };
    })()

   ,"baseball" : (function () {
      var baseball_started;

      var v3a, v3b;
      window.addEventListener("jThree_ready", function () {
v3a = new THREE.Vector3()
v3b = new THREE.Vector3()
      });

      var baseball = {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/baseball_64x64.png'
 ,info_short: "Baseball catcher"
// ,is_base_inventory: true

 ,get index_default() { return (is_mobile) ? 5 : (MMD_SA_options.Dungeon.inventory.max_base+MMD_SA_options.Dungeon.inventory.max_base*(MMD_SA_options.Dungeon.inventory.max_row-1))+1; }
// ,get index_default() { return (is_mobile) ? undefined : MMD_SA_options.Dungeon.inventory.max_base+1; }

 ,stock_max: 1
 ,stock_default: 1

 ,action: {
    func: function (item) {
var model_mesh = THREE.MMD.getModels()[0].mesh
if (!model_mesh.visible)
  return true

var d = MMD_SA_options.Dungeon
if (d.event_mode && !baseball_started)
  return true

if (baseball_started) {
  item.reset()
  DEBUG_show("Baseball catcher:OFF", 2)

  return false
}
//DEBUG_show(MMD_SA.MMD.motionManager.filename)

if (!MMD_SA_options._XRA_pose_list[0].some(p=>p.name == MMD_SA.MMD.motionManager.filename))
  return true
if (MMD_SA_options.Dungeon_options.item_base.social_distancing._started)
  return

baseball_started = true

d._states.event_mode_locked = true

DEBUG_show("Baseball catcher:ON", 2)

this._ball_para = null
this._distance_check()
    }
   ,anytime: true

   ,_distance: function () {
return v3a.copy(MMD_SA.camera_position).distanceTo(v3b.copy(THREE.MMD.getModels()[0].mesh.position))/10// / MMD_SA.WebXR.zoom_scale;
    }

   ,_distance_check: function () {
this._ball_para = null

var dis = this._distance()

if (dis < 5) {
  if (MMD_SA_options._motion_shuffle_list_default[0] == MMD_SA_options.motion_index_by_name["emote-mod_がっかり1"])
    return true
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_がっかり1"], MMD_SA_options.motion_index_by_name["emote-mod_がっかり2"], MMD_SA_options.motion_index_by_name["emote-mod_肩をすくめる1"], MMD_SA_options.motion_index_by_name["emote-mod_肩をすくめる2"]]
}
else {
  let r = MMD_SA.face_camera(MMD_SA._head_pos, THREE.MMD.getModels()[0].mesh.quaternion.clone().conjugate(), true)
//DEBUG_show(r.x+'\n'+r.y)
  if ((Math.abs(r.x) > Math.PI/3) || (Math.abs(r.y) > Math.PI/3)) {
    if (MMD_SA_options._motion_shuffle_list_default[0] == MMD_SA_options.motion_index_by_name["emote-mod_すねる1"])
      return true
    MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_すねる1"], MMD_SA_options.motion_index_by_name["emote-mod_すねる2"], MMD_SA_options.motion_index_by_name["emote-mod_よろめく1"], MMD_SA_options.motion_index_by_name["emote-mod_よろめく2"]]
  }
  else {
    MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["baseball_throw"]]
  }
}

MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice()
MMD_SA._force_motion_shuffle = true
    }

   ,_ball_fly: function () {
var mesh = THREE.MMD.getModels()[0].mesh
var obj = MMD_SA_options.Dungeon.object_base_list[0].object_list[0]._obj

if (!this._ball_para) {
  let pos_ini = obj.position.clone()
  let pos_end = MMD_SA._trackball_camera.object.position.clone()

  let dis = pos_ini.distanceTo(pos_end)
  let f = Math.max(dis/100,1)
  let velocity = pos_end.clone().sub(pos_ini).multiplyScalar(1/f)

  let rot_ini = MMD_SA._v3a.set((Math.random()-0.5)*Math.PI/20/f, (Math.random()-0.5)*Math.PI/20/f, 0)
  let rot_end = MMD_SA._v3b.set((Math.random()-0.5)*Math.PI/10/f, (Math.random()-0.5)*Math.PI/10/f, 0)
//rot_ini.set(0,0,0);rot_end.set(0,0,0);

  this._ball_para = {
    pos_ini:pos_ini,
    pos_end:pos_end,
    velocity:velocity,
    rot_self: rot_end.clone(),
    rot_ini:new THREE.Quaternion().setFromEuler(rot_ini),
    rot_end:new THREE.Quaternion().setFromEuler(rot_end.add(rot_ini)),

    timestamp_ini:RAF_timestamp,
    timestamp:RAF_timestamp,
  };
}

var time_diff = (RAF_timestamp - this._ball_para.timestamp) / 1000
this._ball_para.timestamp = RAF_timestamp

var time = (RAF_timestamp - this._ball_para.timestamp_ini) / 1000

var v = MMD_SA._v3b.copy(this._ball_para.velocity).multiplyScalar(time_diff).applyQuaternion(MMD_SA.TEMP_q.copy(this._ball_para.rot_ini).slerp(this._ball_para.rot_end, Math.pow(Math.min(time, 1), 2)))
obj.position.add(v)
obj.quaternion.copy(MMD_SA.TEMP_q.setFromEuler(MMD_SA.TEMP_v3.copy(this._ball_para.rot_self).multiplyScalar(time*50)))

obj.matrixAutoUpdate = false
obj.updateMatrix()

var c_pos = this._ball_para.pos_ini
var c_to_camera = c_pos.distanceTo(MMD_SA._trackball_camera.object.position)
var c_to_ball = c_pos.distanceTo(obj.position)

//DEBUG_show(c_to_ball+'\n'+c_to_camera)
if (c_to_ball > c_to_camera) {
  if (this._ball_para.hit_score == null) {
    let v_path = MMD_SA._v3a_.copy(this._ball_para.ball_pos_last).sub(c_pos)
    let v_path_length = v_path.length()
    if (v_path_length < c_to_camera) {
      let v_scale = (c_to_camera-v_path_length)/v.length()
      v_path.copy(this._ball_para.ball_pos_last).add(v.multiplyScalar(v_scale)).sub(c_pos)
//DEBUG_show([c_to_camera,c_to_ball,v_path.length(),v_scale,Date.now()].join('\n'))
    }

    let v_axis = MMD_SA._v3a.copy(v_path).normalize()
    let z_axis = MMD_SA._v3b.set(0,0,1)
//    let q = MMD_SA.TEMP_q.setFromAxisAngle(MMD_SA.TEMP_v3.crossVectors(v_axis,z_axis).normalize(), v_axis.angleTo(z_axis))
    let q = MMD_SA.TEMP_q.setFromUnitVectors(v_axis,z_axis)
//DEBUG_show(v_path.clone().applyQuaternion(q).toArray().join('\n'))
    let v_path_camera = MMD_SA._v3a.copy(MMD_SA._trackball_camera.object.position).sub(c_pos)
    let v_score = MMD_SA._v3b.copy(v_path_camera).applyQuaternion(q)
    let score = Math.round(100 - Math.min(Math.max(Math.sqrt(v_score.x*v_score.x + v_score.y*v_score.y)-1, 0), 5) * 20)
//DEBUG_show(score)
//score = 100
    this._ball_para.hit_score = score

    let sprite_pos = v_path.normalize().lerp(v_path_camera.normalize(), 0.8).multiplyScalar(c_to_camera-2).add(c_pos)

    let para = { scale:1, speed:1 }
    para.pos = sprite_pos.clone()
    para.name = "hit_yellow_01"
/*
    if (score < 33) {
      para.scale *= 0.5
      para.speed *= 2
    }
    else if (score < 66) {
      para.scale *= 0.75
      para.speed *= 1.5
    }
    else {
      para.scale *= 1.5
      para.speed *= 1
    }
*/
    para.scale *= 0.1;
    para.scale *= 1.5;
    MMD_SA_options.Dungeon.sprite.animate(para.name, para)
    MMD_SA_options.Dungeon.sound.audio_object_by_name["hit-1"].play()
  }
}

this._ball_para.ball_pos_last = this._ball_para.ball_pos_last && this._ball_para.ball_pos_last.copy(obj.position) || obj.position.clone();
    }

  }
 ,reset: function () {
if (!baseball_started)
  return
baseball_started = false

MMD_SA_options.Dungeon._states.event_mode_locked = false

this.action._ball_para = null

MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["standmix2_modified"]]
MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice()
MMD_SA._force_motion_shuffle = true
  }

 ,get _started() { return baseball_started; }
      };

      return baseball;
    })()

   ,"hand_camera": (()=>{
      let camera_near_last;
      let no_camera_collision;
      let avatar_visible_distance;

      let camera_toggle_timestamp = 0;

      let selfie_mode;

      let fov_last;
      function update_fov(fov) {
if (MMD_SA._trackball_camera.object.fov != fov) {
  MMD_SA._trackball_camera.object.fov = fov;
  MMD_SA._trackball_camera.object.updateProjectionMatrix();
}
      }

      function hand_camera() {
const _hand_camera_active = hand_camera_active;
hand_camera_active = false;

if (!hand_camera_enabled) return;

if (!System._browser.camera.poseNet.enabled) {
  disable_hand_camera();
  return;
}

const d = hand_camera_side;
const motion_para = MMD_SA.MMD.motionManager.para_SA;

const model = THREE.MMD.getModels()[0];
const mesh = model.mesh;
const modelX = MMD_SA.THREEX.get_model(0);
const hand_pos = modelX.get_bone_position_by_MMD_name(d+'手首');//MMD_SA.get_bone_position(mesh, d+'手首');//

let selfie_mode = _hand_camera.selfie_mode;

let camera_off = !System._browser.camera.poseNet.data_detected || !motion_para.motion_tracking_enabled || motion_para.motion_tracking?.hand_camera_disabled || (motion_para.motion_tracking?.arm_as_leg?.enabled && (motion_para.motion_tracking.arm_as_leg.linked_side != ((d=='左')?'right':'left')));
if (motion_para.motion_tracking_upper_body_only) {
  camera_off = camera_off || (System._browser.camera.poseNet.frames.get_blend_default_motion('skin', d+'手首') > 0.5);
}
else {
  camera_off = camera_off || ((modelX.get_bone_position_by_MMD_name(d+'腕').y - hand_pos.y) > v1.fromArray(modelX.get_bone_origin_by_MMD_name(d+'手首')).distanceTo(v2.fromArray(modelX.get_bone_origin_by_MMD_name(d+'腕'))) * 0.5);
//  if (System._browser.camera.poseNet._upper_body_only_mode && !selfie_mode) camera_off = camera_off || ((System._browser.camera.handpose.hand_visible_session[d]||0) < 1000);
}

if (!motion_para.motion_tracking_upper_body_only && System._browser.camera.poseNet.data_detected && !(_hand_camera_active ^ camera_off)) {
  if (RAF_timestamp > camera_toggle_timestamp + 500) {
    camera_toggle_timestamp = RAF_timestamp;
  }
  else {
    camera_off = !_hand_camera_active;
  }
}

if (camera_off) {
  System._browser.camera.poseNet._arm_IK_adjust[hand_camera_side] = null;
  MMD_SA.Camera_MOD.adjust_camera('hand_camera', v1.set(0,0,0), v2.set(0,0,0), null);

  restore_camera();

  if (_hand_camera_active)
    MMD_SA.reset_camera();

  return;
}

hand_camera_active = true;

System._browser.camera.poseNet.frames._reset_disabled = true;

if (MMD_SA.THREEX.enabled) {
  const camera = MMD_SA.THREEX.data.camera;
  if (camera.near != 0.1) {
    camera_near_last = camera.near;
    camera.near = 0.1;
    camera.updateProjectionMatrix();
  }
  if (MMD_SA_options.Dungeon.no_camera_collision !== true) {
// convert to non-null boolean
    no_camera_collision = !!MMD_SA_options.Dungeon.no_camera_collision;
    MMD_SA_options.Dungeon.no_camera_collision = true;
  }
  avatar_visible_distance = MMD_SA_options.avatar_visible_distance;
  MMD_SA_options.avatar_visible_distance = 1;
}

if (!fov_last) fov_last = MMD_SA._trackball_camera.object.fov;
update_fov(_hand_camera.fov);

const frames = System._browser.camera.poseNet.frames;
if (System._browser.camera.handpose.enabled) {
  window.addEventListener('SA_camera_poseNet_process_bones_onended', ()=>{
    finger_list.forEach((f,i)=>{
      let ini = (i == 0) ? 0 : 1;
      for (let n = ini; n < ini+3; n++) {
        const f_name = d+f+'指'+nj_list[n];
        mesh.bones_by_name[f_name]?.quaternion.set(0,0,0,1);
      }
    });
  }, {once:true});
}

const sign_LR = (d=='左')?1:-1;

System._browser.camera.poseNet._arm_IK_adjust[hand_camera_side] = { add:{x:-0.08*sign_LR}, min:{z:0.5}, scale:{x:1.25,y:1,z:1.5} };
if (frames.skin[d+'腕ＩＫ']) frames.skin[d+'腕ＩＫ'][0].data_filter = {};

let target = v1;
if (selfie_mode) {
  const head_target = modelX.get_bone_position_by_MMD_name('首');
  const neck_y = modelX.get_bone_origin_by_MMD_name('頭')[1] - modelX.get_bone_origin_by_MMD_name('首')[1];
  head_target.y += neck_y*2;

  const arm_axis = modelX.get_bone_position_by_MMD_name(d+'ひじ').sub(hand_pos).negate().normalize();
  const arm_rot = q1.setFromUnitVectors(MMD_SA.TEMP_v3.set(sign_LR,0,0), arm_axis);
  hand_pos.add(v3.set(0,0.4,0).applyQuaternion(arm_rot));
  hand_pos.y += neck_y*2;

  window.addEventListener('SA_camera_poseNet_process_bones_onended', ()=>{
    mesh.bones_by_name[d+'手首'].quaternion.set(0,0,0,1);
    mesh.bones_by_name[d+'手捩']?.quaternion.set(0,0,0,1);
  }, {once:true});

  target.copy(head_target.sub(hand_pos)).normalize();
}
else {
  const hand_rot = modelX.get_bone_rotation_by_MMD_name(d+'手首');
//hand_rot.multiply(MMD_SA.TEMP_q.copy(mesh.quaternion).conjugate());

  target.set(0,-sign_LR,0);
  if (!MMD_SA.THREEX.enabled && MMD_SA_options.model_para_obj.rot_arm_adjust) target.applyQuaternion(MMD_SA_options.model_para_obj.rot_arm_adjust[d+'腕'].axis_rot);
  target.applyQuaternion(hand_rot).multiplyScalar(sign_LR);
//target.applyQuaternion(mesh.quaternion);
//hand_rot.multiply(mesh.quaternion);

//v2.setEulerFromQuaternion(hand_rot, 'ZYX').multiplyScalar(180/Math.PI);
//System._browser.camera.DEBUG_show(v2.toArray().join('\n')+'\n\n'+target.toArray().join('\n'))

  const hand_shift = v3.set(1,0,0);
  if (!MMD_SA.THREEX.enabled && MMD_SA_options.model_para_obj.rot_arm_adjust) hand_shift.applyQuaternion(MMD_SA_options.model_para_obj.rot_arm_adjust[d+'腕'].axis_rot);
  hand_shift.applyQuaternion(hand_rot).multiplyScalar(sign_LR);

  hand_pos.add(v2.copy(target).multiplyScalar(0.4)).add(hand_shift);
}

const filter = target_filter[d].filters[0].filter;
if (selfie_mode) {
  filter.minCutOff = 0.1;
  filter.beta = 0.2;
}
else {
  filter.minCutOff = 0.25;
  filter.beta = 0.5;
}
target.fromArray(target_filter[d].filter(target.toArray()));

target.multiplyScalar(30).add(hand_pos);

const c_base = MMD_SA.Camera_MOD.get_camera_base(['camera_lock','hip_camera']);
hand_pos.sub(c_base.pos);
target.sub(c_base.target);

MMD_SA.Camera_MOD.adjust_camera('hand_camera', hand_pos, target, null);
      }

      function restore_camera() {
System._browser.camera.poseNet.frames._reset_disabled = null;

if (MMD_SA.THREEX.enabled) {
  if (camera_near_last) {
    const camera = MMD_SA.THREEX.data.camera;
    camera.near = camera_near_last;
    camera.updateProjectionMatrix();
    camera_near_last = null;
  }
  if (no_camera_collision != null) {
    MMD_SA_options.Dungeon.no_camera_collision = no_camera_collision;
    no_camera_collision = null;
  }
  MMD_SA_options.avatar_visible_distance = avatar_visible_distance;
}

if (fov_last)
  update_fov(fov_last);
fov_last = null;
      }

      function disable_hand_camera() {
hand_camera_enabled = false;
hand_camera_active = false;
System._browser.camera.poseNet._arm_IK_adjust = {};

MMD_SA_options.look_at_screen = returnBoolean("MMDLookAtCamera");

restore_camera();

for (const d of ['左','右'])
  delete System._browser.camera.poseNet.frames.skin[d+'腕ＩＫ']?.[0]?.data_filter;

MMD_SA.Camera_MOD.adjust_camera('hand_camera', v1.set(0,0,0), v2.set(0,0,0), null);

System._browser.camera.DEBUG_show('Hand camera:OFF', 3);
      }

      var finger_list = ["親", "人", "中", "薬", "小"];
      var nj_list = ["０","１","２","３"];

      let hand_camera_enabled, hand_camera_active;
      let hand_camera_side;

      const target_filter = {};

      let v1, v2, v3;
      let q1;
      window.addEventListener('SA_Dungeon_onstart', ()=>{
v1 = new THREE.Vector3();
v2 = new THREE.Vector3();
v3 = new THREE.Vector3();
q1 = new THREE.Quaternion();

for (const d of ['左', '右']) target_filter[d] = new System._browser.data_filter([{ type:'one_euro', id:'target_filter', para:[30, 0.5,0.5,1, 3] }]);

window.addEventListener('MMDCameraReset', (e)=>{
  if (System._browser.camera.poseNet.frames._reset_disabled)
    e.detail.result.return_value = true;
});

//System._browser.on_animation_update.add(()=>{
window.addEventListener('SA_MMD_before_render', ()=>{
  hand_camera();
});
//}, 0,1,-1);
      });

      const _hand_camera = {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/hand_camera_64x64.png'
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.hand_camera.info_short'); }
// ,is_base_inventory: true

 ,get index_default() { return (is_mobile) ? undefined : 6; }
// ,get index_default() { return (is_mobile) ? undefined : (browser_native_mode) ? 4 : 6;}//MMD_SA_options.Dungeon.inventory.max_base+4; }

 ,stock_max: 1
 ,stock_default: 1

 ,get selfie_mode() { return selfie_mode; }
 ,set selfie_mode(v) { selfie_mode = v; }

 ,get _hand_camera_enabled() { return hand_camera_enabled; }
 ,get _hand_camera_active() { return hand_camera_enabled && hand_camera_active; }
 ,get _hand_camera_side() { return hand_camera_enabled && hand_camera_side; }

 ,action: {
    func: function (item) {
const c = System._browser.camera;
if (!c.poseNet.enabled) {
  DEBUG_show('(For mocap mode only)', 3);
  return true;
}

if (!hand_camera_enabled) {
  hand_camera_enabled = true;
  hand_camera_side = '右';

  System._browser.camera.poseNet._arm_IK_adjust = {};

  MMD_SA_options.look_at_screen = false;

  c.DEBUG_show('Hand camera:ON (left hand)', 5);
}
else {
  if (hand_camera_side == '右') {
    hand_camera_side = '左';

    System._browser.camera.poseNet._arm_IK_adjust = {};

    c.DEBUG_show('Hand camera:ON (right hand)', 5);
  }
  else {
    disable_hand_camera();
  }
}
    }
   ,anytime: true
  }

 ,get info() {
/*
return [
'- Press ' + (System._browser.hotkeys.config_by_id['hand_camera']?.accelerator[0]||'') + ' / double-click to use your hand as camera during mocap (status: ' + ((hand_camera_enabled) ? ((hand_camera_side == '右') ? 'left hand' : 'right hand') : 'OFF') + ').',
'- Repeat to switch among left hand, right hand, and OFF.',
'- Press ' + (System._browser.hotkeys.config_by_id['selfie_mode']?.accelerator[0]||'') + ' to toggle "Selfie mode" which automatically focuses on your face (status: ' + ((_hand_camera.selfie_mode) ? 'ON' : 'OFF') + ').',
'- Press ' + (System._browser.hotkeys.config_by_id['auto_look_at_camera']?.accelerator[0]||'') + ' to toggle auto "look at camera" (status: ' + ((System._browser.camera.facemesh.auto_look_at_camera) ? 'ON' : 'OFF') + ').',
  ].join('\n');
*/
return System._browser.translation.get('XR_Animator.UI.hand_camera.info').replace(/\<hand_camera_hotkey\>/, System._browser.hotkeys.config_by_id['hand_camera']?.accelerator[0]||'').replace(/\<hand_camera_status\>/, (hand_camera_enabled) ? ((hand_camera_side == '右') ? System._browser.translation.get('XR_Animator.UI.hand_camera.info.left_hand') : System._browser.translation.get('XR_Animator.UI.hand_camera.info.right_hand')) : 'OFF').replace(/\<selfie_mode_hotkey\>/, System._browser.hotkeys.config_by_id['selfie_mode']?.accelerator[0]||'').replace(/\<selfie_mode_status\>/, (_hand_camera.selfie_mode) ? 'ON' : 'OFF').replace(/\<auto_look_at_camera_hotkey\>/, System._browser.hotkeys.config_by_id['auto_look_at_camera']?.accelerator[0]||'').replace(/\<auto_look_at_camera_status\>/, (System._browser.camera.facemesh.auto_look_at_camera) ? 'ON' : 'OFF');
  }
      };

      return _hand_camera;
    })()

   ,"body_pix" : {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/selfie_segmentation_64x64.png'
 ,info_short: "Segmentation AI"
// ,is_base_inventory: true

// ,index_default: (is_mobile) ? undefined : 5
// ,get index_default() { return (is_mobile) ? undefined : MMD_SA_options.Dungeon.inventory.max_base + MMD_SA_options.Dungeon.inventory.max_base*(MMD_SA_options.Dungeon.inventory.max_row-1)*2 +3; }

// ,get index_default() { return (is_mobile) ? undefined : (browser_native_mode) ? 4 : 6;}//MMD_SA_options.Dungeon.inventory.max_base+4; }

 ,stock_max: 1
 ,stock_default: 1

 ,action: {
    func: (function () {
      var initialized, loading;

      var script_list;

      function load_script(idx, onFinish) {
var src = script_list[idx]
var name = src.replace(/^.+[\/\\]/, "")

let script = document.createElement('script');
script.onload = () => {
  if (++idx >= script_list.length) {
    onFinish()
  }
  else {
    load_script(idx, onFinish)
  }
};
script.src = src;
document.head.appendChild(script);

var msg = '(Loading ' + name + ')'
console.log(msg)
DEBUG_show(msg, 3)
      };

      async function init() {
if (!initialized) {
  await new Promise((resolve, reject) => {
loading = true

script_list = [];
if (MMD_SA.WebXR.user_camera.bodyPix.use_bodySegmentation) {
  script_list.push(
    'https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation',
    'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs',
    'https://cdn.jsdelivr.net/npm/@tensorflow-models/body-segmentation'
  );
}
else {
  script_list.push(
    'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs',
    'https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix'
  );
}

load_script(0, ()=>{
  loading = false
  initialized = true
  resolve();
});
  });
}

if (MMD_SA.WebXR.user_camera.bodyPix.enabled) {
  MMD_SA.WebXR.user_camera.bodyPix.enabled = false
  DEBUG_show("Selfie Segmentation AI:OFF", 2)
}
else {
  MMD_SA.WebXR.user_camera.bodyPix.enabled = true
  DEBUG_show("Selfie Segmentation AI:ON", 2)
}
      }

      return function (item) {
if (!MMD_SA.WebXR.user_camera.visible) {
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.UI.segmentation_AI.no_input'), 3*1000);
  return true
}
if (MMD_SA.WebXR.user_camera.ML_enabled) {
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.UI.segmentation_AI.mocap_on'), 5*1000);
  return true
}
if (System._browser.camera.hidden_enforced) {
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.UI.segmentation_AI.camera_hidden'), 3*1000);
  return true;
}
if (loading) {
  DEBUG_show("(Selfie Segmentation AI still loading)", 2)
  return true
}

init()
      };
    })()
//   ,anytime: true
  }

 ,get info() {
    return System._browser.translation.get('XR_Animator.UI.segmentation_AI.info').replace(/\<enable\>/, System._browser.translation.get('XR_Animator.UI.segmentation_AI.' + ((MMD_SA.WebXR.user_camera.bodyPix.enabled)?'disable':'enable')));
  }
    }

   ,"snapshot" : {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/taking-a-selfie_64x64.png'
 ,info_short: "Snapshot"
// ,is_base_inventory: true

 ,index_default: undefined

 ,stock_max: 1
 ,stock_default: (is_mobile) ? 1 : 0
 ,action: {
    func: function (item) {
return System._browser.snapshot.init();
    }
   ,anytime: true
  }
    }

   ,"rec" : (()=>{
      function snapshot(e) {
const ev = e.detail.e;
if (ev.altKey || ev.ctrlKey || ev.shiftKey) return;
switch (ev.code) {
  case 'F12':
    System._browser.snapshot.init();
    break
  case 'F9':
    System._browser.video_capture.start();
    break
  case 'F10':
    System._browser.video_capture.stop();
    break
  default:
    return;
}

e.detail.result.return_value = true;
      }

      window.addEventListener('MMDStarted', ()=>{
        window.addEventListener('SA_keydown', snapshot);
      });

      const rec = {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/rec_64x64.png'
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.media_recorder.info_short'); }
// ,is_base_inventory: true

 ,get index_default() { return (is_mobile) ? undefined : MMD_SA_options.Dungeon.inventory.max_base+1; }

 ,stock_max: 1
 ,stock_default: 1

 ,action: {
    func: function (item) {
MMD_SA_options.Dungeon.run_event('_MEDIA_RECORDER_OPTIONS_', 0);
    }
//   ,anytime: true
  }

 ,get info() { return System._browser.translation.get('XR_Animator.UI.media_recorder.info'); }
      };

      return rec;
    })()

   ,"XR_Animator_options" : {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/user-experience_64x64.png'
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.UI_options.info_short');}
// ,is_base_inventory: true

 ,index_default: (is_mobile) ? 4 : 5

 ,stock_max: 1
 ,stock_default: 1

 ,action: {
    func: function (item) {
MMD_SA_options.Dungeon.events["_FACEMESH_OPTIONS_"][0]._show_other_options_=true;setTimeout(()=>{MMD_SA_options.Dungeon.events["_FACEMESH_OPTIONS_"][0]._show_other_options_=false},0);
MMD_SA_options.Dungeon.run_event("_FACEMESH_OPTIONS_",0);
    }
//   ,anytime: true
  }

 ,get info() { return System._browser.translation.get('XR_Animator.UI.UI_options.info');}
    }

   ,"VMC_protocol" : {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/vmpc_logo_64x64.png'
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.VMC_protocol.info_short'); }
// ,is_base_inventory: true

 ,index_default: (is_mobile) ? undefined : 4
 ,stock_default: (is_mobile) ? 0 : 1

 ,stock_max: 1
 ,action: {
    func: function (item) {
if (!webkit_electron_mode || !MMD_SA.THREEX.enabled) {
  MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.UI.VMC_protocol.not_supported'), 5*1000);
  return true;
}

MMD_SA_options.Dungeon.run_event("_VMC_PROTOCOL_",0);
    }
//   ,anytime: true
  }

 ,get info() { return System._browser.translation.get('XR_Animator.UI.VMC_protocol.info'); }
    }

   ,"air_blower": (function () {
      function air_blower_frame() {
if (MMD_SA.ammo_proxy && MMD_SA.ammo_proxy._timeStep) return// {DEBUG_show(Date.now()); return; }

const t = Date.now();
let windPower = ( Math.sin( t * Math.PI / 3 ) + 1 ) / 2;
windPower = 0.5 + windPower*0.5;

let _air_vector = air_vector;
if (!_air_vector) {
  _air_vector = get_direction();
}

let gravity = MMD_SA.TEMP_v3.fromArray(_air_vector).multiplyScalar(windPower);
//DEBUG_show(gravity.toArray(),0,1)

THREE.MMD.setGravity( gravity.x*9.8*10, gravity.y*9.8*10, gravity.z*9.8*10 )
      }

      function get_direction() {
const camera = MMD_SA._trackball_camera.object;
const phase = Math.floor((state-1)/2);
return MMD_SA.TEMP_v3.copy(camera.position).sub(camera._lookAt).normalize().multiplyScalar(2 * ((phase == 1) ? 1 : -1)).toArray();
      }

      let state = 0;
      let air_vector;
      let msg = '';
      var air_blower = {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/hair-dryer_64x64.png'
 ,get info_short() { return System._browser.translation.get('XR_Animator.UI.air_blower.info_short'); }
// ,is_base_inventory: true

 ,index_default: undefined
// ,get index_default() { return (is_mobile) ? undefined : MMD_SA_options.Dungeon.inventory.max_base+2; }

 ,stock_max: 1
 ,stock_default: 1
 ,action: {
    func: function () {
var phase = 1
if (++state <= 4) {

  if (state % 2) {
    air_vector = null;
    if (state == 1) {
      System._browser.on_animation_update.add(air_blower_frame, 0,phase,-1)
      msg = '🌬️Air blowing';
    }
    else {
      msg = '🌬️Air sucking';
    }
  }
  else {
    air_vector = get_direction();
    msg += '/fixed direction';
  }
  DEBUG_show('(' + msg + ')', 3);
}
else {
  System._browser.on_animation_update.remove(air_blower_frame,phase)
  DEBUG_show("(🌬️Air blower stopped)", 3)
  air_blower.reset()
}
    }
   ,anytime: true
  }
 ,reset: function () {
if (!MMD_SA.MMD_started || !state) return

state = 0
var gravity = MMD_SA.MMD.motionManager.para_SA.gravity || [0,-1,0]
THREE.MMD.setGravity( gravity[0]*9.8*10, gravity[1]*9.8*10, gravity[2]*9.8*10 )
  }

 ,get info() { return System._browser.translation.get('XR_Animator.UI.air_blower.info'); }
      };

      return air_blower;
    })()

   ,"social_distancing": (function () {
      var social_distancing_started;

      var v3a, v3b;
      window.addEventListener("jThree_ready", function () {
v3a = new THREE.Vector3()
v3b = new THREE.Vector3()
      });

      var social_distancing = {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/coronavirus_social_distancing_64x64.png'
 ,info_short: "Social meter"
// ,is_base_inventory: true

 ,get index_default() { return (is_mobile) ? undefined : (MMD_SA_options.Dungeon.inventory.max_base+MMD_SA_options.Dungeon.inventory.max_base*(MMD_SA_options.Dungeon.inventory.max_row-1))+2; }
// ,get index_default() { return (is_mobile) ? undefined : MMD_SA_options.Dungeon.inventory.max_base+3; }

 ,stock_max: 1
 ,stock_default: 1//(is_mobile) ? 1 : 0
 ,action: {
    func: function (item) {
var model_mesh = THREE.MMD.getModels()[0].mesh
if (!model_mesh.visible)
  return true

var d = MMD_SA_options.Dungeon
if (d.event_mode && !social_distancing_started)
  return true

if (social_distancing_started) {
  if (MMD_SA.WebXR._circle_2m && MMD_SA.WebXR._circle_2m.visible) {
    d.run_event("circle_2m_hide")
    DEBUG_show("Social distancing:ON / Circle:OFF", 2)
  }
  else {
    item.reset()
    DEBUG_show("Social distancing:OFF", 2)
  }
  return false
}
//DEBUG_show(MMD_SA.MMD.motionManager.filename)

var dis = this._social_distance()

if (dis < 2)
  return true
if (!/standmix2_modified/.test(MMD_SA.MMD.motionManager.filename))
  return true
if (MMD_SA_options.Dungeon_options.item_base.baseball._started)
  return true

social_distancing_started = true

d.run_event("circle_2m_show")

d._states.event_mode_locked = true

DEBUG_show("Social distancing:ON / Circle:ON", 2)

this._social_distance_check(999,999)
    }
   ,anytime: true

   ,_social_distance: function () {
return v3a.copy(MMD_SA.camera_position).setY(0).distanceTo(v3b.copy(THREE.MMD.getModels()[0].mesh.position).setY(0))/10 / MMD_SA.WebXR.zoom_scale;
    }

   ,_social_distance_check: function (min, max) {
var dis = this._social_distance()
//DEBUG_show(dis)
if ((dis > min) && (dis < max))
  return true

if (/surrender_v03/.test(MMD_SA.MMD.motionManager.filename)) {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["surrender-R_v03"]]
}
else if (dis < 0.75) {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["surrender_v03"]]
}
else if (dis < 2) {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_照れる1"], MMD_SA_options.motion_index_by_name["emote-mod_照れる2"]]
}
else if (dis < 4) {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_お辞儀1"], MMD_SA_options.motion_index_by_name["emote-mod_お辞儀2"], MMD_SA_options.motion_index_by_name["emote-mod_肯定する1"], MMD_SA_options.motion_index_by_name["emote-mod_肯定する2"]]
}
else if (dis < 6) {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_歓迎する1"], MMD_SA_options.motion_index_by_name["emote-mod_歓迎する2"]]
}
else if (dis < 8) {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_がっかり1"], MMD_SA_options.motion_index_by_name["emote-mod_がっかり2"], MMD_SA_options.motion_index_by_name["emote-mod_肩をすくめる1"], MMD_SA_options.motion_index_by_name["emote-mod_肩をすくめる2"]]
}
else {
  MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["emote-mod_すねる1"], MMD_SA_options.motion_index_by_name["emote-mod_すねる2"], MMD_SA_options.motion_index_by_name["emote-mod_よろめく1"], MMD_SA_options.motion_index_by_name["emote-mod_よろめく2"]]
}

MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice()
MMD_SA._force_motion_shuffle = true
    }
  }
 ,reset: function () {
if (!social_distancing_started)
  return
social_distancing_started = false

MMD_SA_options.Dungeon.run_event("circle_2m_hide")

MMD_SA_options.Dungeon._states.event_mode_locked = false

MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name["standmix2_modified"]]
MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice()
MMD_SA._force_motion_shuffle = true
  }

 ,get _started() { return social_distancing_started; }
      };

      return social_distancing;
    })()

   ,"menu": {
  get index_default() { return MMD_SA_options.Dungeon.inventory.max_base + MMD_SA_options.Dungeon.inventory.max_base*(MMD_SA_options.Dungeon.inventory.max_row-1)*2 +1; }
    }

   ,"_map_": {
  get index_default() { return MMD_SA_options.Dungeon.inventory.max_base + MMD_SA_options.Dungeon.inventory.max_base*(MMD_SA_options.Dungeon.inventory.max_row-1)*2 +2; }
    }

   ,"bag01": {
  info_short: 'Bag (AR)',
  get index_default() { return MMD_SA_options.Dungeon.inventory.max_base; },
    }

  ,"bag02": {
  info_short: 'Bag (misc)',
  get index_default() { return MMD_SA_options.Dungeon.inventory.max_base * MMD_SA_options.Dungeon.inventory.max_row -1; },
    }


   ,"laughing_man" : {
  icon_path: Settings.f_path + '/assets/assets.zip#/icon/laughing_man_64x64.png'
 ,info_short: "Laughing Man"
// ,is_base_inventory: true
 ,stock_max: 1
 ,stock_default: 0//1
 ,action: {
    func: function (item) {
/*
if (!MMD_SA.WebXR.user_camera.visible) {
  DEBUG_show("(You need to activate selfie AR first.)", 3)
  return true
}
*/
if (MMD_SA.WebXR.user_camera.face_detection.enabled) {
  MMD_SA.WebXR.user_camera.face_detection.enabled = false
  DEBUG_show("Laughing Man:OFF", 2)
}
else {
  MMD_SA.WebXR.user_camera.face_detection.enabled = true
  DEBUG_show("Laughing Man:ON", 2)
}
    }
   ,anytime: true
  }
    }

  }

 ,inventory: {
    UI: {
      info: {
//        scale: 3
      },
//      muted: true,
    }
  }

 ,events_default: {
    "_SELFIE_": [
//0
      [
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.webcam_media'); }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, branch_index:1 }
   ,{ key:2, branch_index:2 }
   ,{ key:3, is_closing_event:true }
   ,{ key:4, branch_index:3 }
  ]
          }
        }
      ]
// 1
     ,[
        {
          func: function () {
MMD_SA.WebXR.user_camera.video_flipped=false;
MMD_SA.WebXR.user_camera.start((0&&webkit_electron_mode) ? toFileProtocol("C:\\Users\\user\\Documents\\_.mp4") : null);
          }
         ,ended: "_SELFIE_"
        }
      ]
// 2
     ,[
        {
          func: function () {
MMD_SA.WebXR.user_camera.video_flipped=true;
MMD_SA.WebXR.user_camera.start((0&&webkit_electron_mode) ? toFileProtocol("C:\\Users\\user\\Documents\\_.mp4") : null);
          }
         ,ended: "_SELFIE_"
        }
      ]

     ,...(()=>{
        var options;

        return [
//3
      [
        {
          func: function () {
options = {
  pixel_limit: {
    disabled: MMD_SA_options.user_camera.pixel_limit.disabled,
    current: MMD_SA_options.user_camera.pixel_limit.current?.slice(),
  },
  fps: MMD_SA_options.user_camera.fps
};
          },
          next_step: {}
        },

        {
          message: {
  get content() {
    return [
System._browser.translation.get('XR_Animator.UI.webcam_media.options.resolution_limit') + ': ' + ((options.pixel_limit.disabled) ? System._browser.translation.get('XR_Animator.UI.webcam_media.options.auto_no_limit') : (options.pixel_limit.current||MMD_SA_options.user_camera.pixel_limit._default_).join('x') + ((!options.pixel_limit.current) ? ' (' + System._browser.translation.get('Misc.default') + ')' : '')),
System._browser.translation.get('XR_Animator.UI.webcam_media.options.frame_rate') + ': ' + (options.fps || System._browser.translation.get('Misc.default')),
System._browser.translation.get('XR_Animator.UI.webcam_media.options.extra')
    ].join('\n');
  }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, branch_index:4,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.webcam_media.options.resolution_limit.tooltip')
);
      }
    }
   ,{ key:2, branch_index:5,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.webcam_media.options.frame_rate.tooltip')
);
      }
    }
   ,{ key:[3,'Esc'], branch_index:0,
      func: ()=>{
Object.assign(MMD_SA_options.user_camera.pixel_limit, options.pixel_limit);
MMD_SA_options.user_camera.fps = options.fps;

const camera = System._browser.camera;
camera.video_track?.applyConstraints(camera.set_constraints()).then(function () {
  camera.DEBUG_show("(camera size updated)", 3);
}).catch(function (err) {
  camera.DEBUG_show("ERROR:camera size failed to update", 5);
});
      }
    }
  ]
          }
        }
      ],
// 4
      [
        {
          func: function () {
const no_limit = 5;
let index = (options.pixel_limit.disabled) ? no_limit : ((options.pixel_limit.current) ? [[640,480], [1280,960], [1920,1080], [3840,2160]].findIndex(r=>r.every((v,i)=>v==options.pixel_limit.current[i]))+1 : 0);
if (++index > no_limit)
  index = 0;

switch (index) {
  case 1:
    options.pixel_limit.disabled = false;
    options.pixel_limit.current = [640,480];
    break;
  case 2:
    options.pixel_limit.disabled = false;
    options.pixel_limit.current = [1280,960];
    break;
  case 3:
    options.pixel_limit.disabled = false;
    options.pixel_limit.current = [1920,1080];
    break;
  case 4:
    options.pixel_limit.disabled = false;
    options.pixel_limit.current = [3840,2160];
    break;
  case no_limit:
    options.pixel_limit.disabled = true;
    options.pixel_limit.current = null;
    break;
  default:
    options.pixel_limit.disabled = false;
    options.pixel_limit.current = null;
    break;
}
          }
         ,goto_event: { branch_index:3, step:1 }
        }
      ],
// 5
      [
        {
          func: function () {
options.fps = (options.fps) ? null : 30;
          }
         ,goto_event: { branch_index:3, step:1 }
        }
      ],
        ];
      })()
    ]

   ,"_ENTER_AR_": [
//0
      [
        {
          message: {
  content: "Enter Augmented Reality (AR) mode?\n1. Yes\n2. No"
 ,bubble_index: 3
 ,branch_list: [
    { key:1, branch_index:1 }
   ,{ key:2, is_closing_event:true }
  ]
          }
        }
      ]
// 1
     ,[
        {
          func: function () {
MMD_SA.WebXR.enter_AR()
          }
         ,ended: true
        }
      ]
    ]

   ,"_FACEMESH_": [
//0
      [
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.motion_capture.ML_off'); }
 ,bubble_index: 3
 ,get branch_list() {
return [
    { key:1, branch_index:1 }
   ,{ key:2, branch_index:2 }
   ,{ key:3, branch_index:3 }
   ,{ key:4, branch_index:4 }
   ,{ key:5, branch_index:5,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.ML_off.full_body_mediapipe_vision.tooltip')
);
      }
    }
   ,{ key:6, branch_index:6,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.ML_off.full_body_legacy_holistic.tooltip')
);
      }
    }
   ,{ key:7, branch_index:7 }
   ,{ key:8, is_closing_event:true }
];
  }
          }
        }
      ]
// NOTE: Models that need to be used should be enabled first before disabling other models.
// 1
     ,[
        {
          func: function () {
System._browser.camera.streamer_mode.init_mocap('Face');
          }
         ,ended: true
        }
      ]
// 2
     ,[
        {
          func: function () {
System._browser.camera.streamer_mode.init_mocap('Body');
          }
         ,ended: true
        }
      ]
// 3
     ,[
        {
          func: function () {
System._browser.camera.streamer_mode.init_mocap('Body+Hands');
          }
         ,ended: true
        }
      ]
// 4
     ,[
        {
          func: function () {
System._browser.camera.streamer_mode.init_mocap('Face+Body');
          }
         ,ended: true
        }
      ]
// 5
     ,[
        {
          func: function () {
System._browser.camera.streamer_mode.init_mocap('Full Body');
          }
         ,ended: true
        }
      ]
// 6
     ,[
        {
          func: function () {
System._browser.camera.streamer_mode.init_mocap('Full Body Holistic');
          }
         ,ended: true
        }
      ]
// 7
     ,[
        {
          goto_event: { id:"_FACEMESH_OPTIONS_", get branch_index() { return MMD_SA_options._mocap_options_branch_; } }
        }
      ]
    ]

   ,"_VMC_PROTOCOL_": (()=>{
const branch_list = [
 { key:'any', func:(e)=>{
let cancel_default = true;

if (change_port) {
  if (/^\d$/.test(e.key)) {
    if (port.length == 5) port = '';
    port += e.key;
    MMD_SA_options.Dungeon.run_event(null,null,0);
  }
  else if (e.key == 'Enter') {
    const port_number = parseInt(port);
    const port_min = 99;
    if ((port_number > port_min) && (port_number < 65536)) {
      MMD_SA.OSC.VMC.options.plugin.send.port = port_number;
      if (MMD_SA.OSC.VMC.plugin)
        MMD_SA.OSC.VMC.plugin.options.send.port = port_number;

      MMD_SA_options.Dungeon.run_event(null,0,0);
    }
    else {
      msg = (port_number) ? ((port_number <= port_min) ? '(❌' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.port.3_digit_number_at_least') + ')' : '(❌' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.port.no_bigger_than_65535') + ')') : '(❌' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.port.invalid_port_number') + ')';
      port = '';
      MMD_SA_options.Dungeon.run_event(null,null,0);
    }
  }
  else if (e.code == 'KeyR') {
    port = MMD_SA.OSC.VMC.options_default.plugin.send.port;
    msg = '';
    MMD_SA_options.Dungeon.run_event(null,null,0);
  }
  else if (e.code == 'Escape') {
    port = '';
    MMD_SA_options.Dungeon.run_event(null,0,0);
  }
  else {
    cancel_default = false;
  }
}
else if (change_host) {
  if (/^[\d\.]$/.test(e.key)) {
    host += e.key;
    MMD_SA_options.Dungeon.run_event(null,null,0);
  }
  else if (e.key == 'Enter') {
    let valid_host;
    if (host == MMD_SA.OSC.VMC.options_default.plugin.send.host) {
      valid_host = true;
    }
    else if (/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/.test(host)) {
      valid_host = [RegExp.$1, RegExp.$2, RegExp.$3, RegExp.$4].every(d=>parseInt(d) < 256);
    }

    if (valid_host) {
      MMD_SA.OSC.VMC.options.plugin.send.host = host;
      if (MMD_SA.OSC.VMC.plugin)
        MMD_SA.OSC.VMC.plugin.options.send.host = host;

      MMD_SA_options.Dungeon.run_event(null,0,0);
    }
    else {
      msg = '(❌' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.host.invalid_IP_address') + ')';
      host = '';
      MMD_SA_options.Dungeon.run_event(null,null,0);
    }
  }
  else if (e.code == 'KeyR') {
    host = MMD_SA.OSC.VMC.options_default.plugin.send.host;
    msg = '';
    MMD_SA_options.Dungeon.run_event(null,null,0);
  }
  else if (e.code == 'Escape') {
    host = '';
    MMD_SA_options.Dungeon.run_event(null,0,0);
  }
  else {
    cancel_default = false;
  }
}
else {
  cancel_default = false;
}

return cancel_default;
  } },
  { key:'A', branch_index:1 },
  { key:'B', branch_index:2 },
  { key:1, event_id:{ func:()=>{ MMD_SA.OSC.VMC.sender_enabled   = MMD_SA_options.user_camera.streamer_mode.VMC_sender_enabled   = !MMD_SA.OSC.VMC.sender_enabled; System._browser.update_tray(); }, goto_event: { id:"_VMC_PROTOCOL_", branch_index:0 } },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.VMC_protocol.tooltip')
);
    }
  },
  { key:2, event_id:{ func:()=>{ MMD_SA.OSC.VMC.send_camera_data = MMD_SA_options.user_camera.streamer_mode.VMC_send_camera_data = !MMD_SA.OSC.VMC.send_camera_data; System._browser.update_tray(); }, goto_event: { id:"_VMC_PROTOCOL_", branch_index:0 } },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.VMC_protocol.send_camera_data.tooltip')
);
    }
  },
  { key:3, event_id:{ func:()=>{
const app_mode = [
  'Others',
  'Warudo',
  'VNyan',
  'VNyan(+Z)',
  'VSeeFace',
];

let app_index = Math.max(app_mode.indexOf(MMD_SA.OSC.app_mode), 0) + 1;
if (app_index >= app_mode.length)
  app_index = 0;
MMD_SA.OSC.app_mode = app_mode[app_index];

System._browser.update_tray();
    }, goto_event: { id:"_VMC_PROTOCOL_", branch_index:0 } },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.VMC_protocol.app_mode.tooltip')
);
    }
  },
  { key:4, event_id:{ func:()=>{ MMD_SA.hide_3D_avatar=!MMD_SA.hide_3D_avatar; System._browser.update_tray(); }, goto_event: { id:"_VMC_PROTOCOL_", branch_index:0 } },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.VMC_protocol.3D_avatar_display.tooltip')
);
    }
  },
  { key:'X', is_closing_event:true },
];

let change_port, change_host;
let port, host;
let msg;

return [
//0
      [
        {
          func: function () {
change_port = false;
change_host = false;

MMD_SA.SpeechBubble.list[1].hide();
          },
          message: {
  get content() {
    return [
System._browser.translation.get('XR_Animator.UI.VMC_protocol.parameters'),
'A. ┣ ' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.port') + ': ' + MMD_SA.OSC.VMC.options.plugin.send.port,
'B. ┗ ' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.host') + ': ' + MMD_SA.OSC.VMC.options.plugin.send.host,
'1. ' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.info_short') + ': ' + ((MMD_SA.OSC.VMC.sender_enabled) ? 'ON' : 'OFF'),
'2. ' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.send_camera_data') + ': ' + ((MMD_SA.OSC.VMC.send_camera_data) ? 'ON':  'OFF'),
'3. ' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.app_mode') + ': ' + ((MMD_SA.OSC.app_mode && (MMD_SA.OSC.app_mode != 'Others')) ? MMD_SA.OSC.app_mode : System._browser.translation.get('Misc.others')),
'4. ' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.3D_avatar_display') + ': ' + ((MMD_SA.hide_3D_avatar) ? 'OFF' : 'ON'),
'X. ' + System._browser.translation.get('Misc.done')
    ].join('\n');
  }
 ,bubble_index: 3
 ,branch_list: branch_list
          }
        }
      ],
//1
      [
        {
          func: function () {
if (!change_port) {
  msg = '';
  port = '';
}

change_port = true;
change_host = false;
          },
          message: {
  get content() {
return System._browser.translation.get('XR_Animator.UI.VMC_protocol.port.current_port') + ': ' + (port||MMD_SA.OSC.VMC.options.plugin.send.port) + ((msg) ? '\n'+msg : '') + '\n・' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.port.enter_valid_port') + '\n' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.port_host_extra');
  }
 ,index: 1
 ,bubble_index: 3
 ,branch_list: branch_list
          }
        }
      ],
//2
      [
        {
          func: function () {
if (!change_host) {
  msg = '';
  host = '';
}

change_port = false;
change_host = true;
          },
          message: {
  get content() {
return System._browser.translation.get('XR_Animator.UI.VMC_protocol.host.current_host') + ': ' + (host||MMD_SA.OSC.VMC.options.plugin.send.host) + ((msg) ? '\n'+msg : '') + '\n・' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.host.enter_valid_IP') + '\n' + System._browser.translation.get('XR_Animator.UI.VMC_protocol.port_host_extra');
  }
 ,index: 1
 ,bubble_index: 3
 ,branch_list: branch_list
          }
        }
      ],
];
    })()

   ,"_MEDIA_RECORDER_OPTIONS_": (()=>{

      return [
//0
  [
    {
       message: {
  get content() {
const vc = System._browser.video_capture;

const specs = vc.get_specs();

let type = specs.mime_type;
if (System._browser.video_capture.FFmpeg.enabled && /h264/.test(type))
  type = 'video/mp4';
console.log(specs)
type = type.replace(/\;.+$/, '');

return System._browser.translation.get('XR_Animator.UI.media_recorder.options') + '\n(' + (specs.width+'x'+specs.height + '/' + ((specs.fps==-1)?System._browser.translation.get('XR_Animator.UI.media_recorder.options.unlimited'):specs.fps) + ' fps') + '/' + (vc.target_mime_type||type).replace(/video\//, '') + ')\n1. ' + System._browser.translation.get('XR_Animator.UI.media_recorder.options.target_resolution') + ': ' + ((!vc.target_width) ? System._browser.translation.get('Misc.auto') : vc.target_width+'x'+vc.target_height) + '\n2. ' + System._browser.translation.get('XR_Animator.UI.media_recorder.options.target_fps') + ': ' + ((!vc.fps) ? System._browser.translation.get('Misc.auto') : (vc.fps == -1) ? System._browser.translation.get('XR_Animator.UI.media_recorder.options.Unlimited') : vc.fps) + ((webkit_electron_mode) ? '\n3. ' + System._browser.translation.get('XR_Animator.UI.media_recorder.options.output_format') + ': ' + (vc.target_mime_type||System._browser.translation.get('Misc.auto')) + '\n4. ' + System._browser.translation.get('Misc.done') : '\n3. ' + System._browser.translation.get('Misc.done'));
  },
  bubble_index: 3,
  get branch_list() { return [
    { key:1, branch_index:1 },
    { key:2, branch_index:2 },
  ].concat((System._browser.video_capture.FFmpeg.enabled) ? [
    { key:3, branch_index:3 },
    { key:4, is_closing_event:true },
  ] : [
    { key:3, is_closing_event:true },
  ])},
       }
    }
  ],
//1
  [
    {
      func: ()=>{
const vc = System._browser.video_capture;

let w, h;
if (!vc.target_width) {
  w = 1280;
  h = 720;
}
else if (vc.target_width == 1280) {
  w = 1920;
  h = 1080;
}

vc.target_width = w;
vc.target_height = h;
      },
      goto_branch: 0
    }
  ],
//2
  [
    {
      func: ()=>{
const vc = System._browser.video_capture;

if (!vc.fps) {
  vc.fps = -1;
}
else if (vc.fps == -1) {
  vc.fps = 30;
}
else {
  vc.fps = undefined;
}
      },
      goto_branch: 0
    }
  ],
//3
  [
    {
      func: ()=>{
const vc = System._browser.video_capture;

if (!vc.target_mime_type) {
  vc.target_mime_type = 'video/webm';
}
else {
  vc.target_mime_type = undefined;
}
      },
      goto_branch: 0
    }
  ],
      ];
    })()

   ,"_FACEMESH_OPTIONS_": (function () {
function speech_bubble2(msg, duration, para={}) {
  MMD_SA.SpeechBubble.list[1].message(3, msg, duration*1000, Object.assign({scale:0.75}, para));
}

var wallpaper_src;
function onDrop_change_wallpaper(item) {
  var src = item.path
  if (item.isFileSystem && /([^\/\\]+)\.(png|jpg|jpeg|bmp|mp4|mkv|webm)$/i.test(src)) {
    wallpaper_src = src;
    System._browser.updateWallpaper(toFileProtocol(src));
    LdesktopBG_host.style.display = 'block'
  }
  else {
    _onDrop_finish.call(DragDrop, item)
  }
}

async function onDrop_change_panorama(item) {
  var src = item.path
  if (item.isFileSystem && /([^\/\\]+)\.zip$/i.test(src)) {
    let zip_file = SA_topmost_window.DragDrop._path_to_obj && SA_topmost_window.DragDrop._path_to_obj[src.replace(/^(.+)[\/\\]/, "")];
    if (!zip_file) {
      const blob = await new Promise((resolve, reject) => {
const xhr = new XMLHttpRequestZIP;
xhr.onload = function () {
  resolve(this.response);
};
xhr.open( "GET", src, true );
xhr.responseType = "blob";
xhr.send();
      });

      const file = new File([blob], src);

// from SA_DragDropEMU()
      console.log("File input (emulated):", file);
      const dd = SA_topmost_window.DragDrop;
      if (!dd._path_to_obj) {
        dd._path_to_obj = {};
        dd._obj_url = {};
      }
      dd._path_to_obj[file.name.replace(/^(.+)[\/\\]/, "")] = file;

      zip_file = file;
    }

    const zip = await new self.JSZip().loadAsync(zip_file);

// will be called, even if content is corrupted

    XMLHttpRequestZIP.zip_by_url(src, zip);

    let panorama_list = zip.file(/\.(png|jpg|jpeg)$/i);
    if (!panorama_list.length) {
      DEBUG_show("(No panorama found)");
      return;
    }

    const panorama_filename = (panorama_list.filter(n=>!/_depth\.\w{3,4}$/i.test(n.name))[0] || panorama_list[0]).name;//.name;
    const panorama_path = src + "#/" + panorama_filename;
    const panorama_depth_filename = panorama_list.filter(n=>n.name.indexOf(panorama_filename.replace(/\.(\w{3,4})$/, '_depth')) == 0)[0]?.name;
    const panorama_depth_path = (panorama_depth_filename) ? src + "#/" + panorama_depth_filename : '';
    console.log(src, panorama_filename, panorama_depth_filename);

//    object3d_cache.set(model_path, null);

    const panorama_json = zip.file(/panorama\.json$/i);
    let json;
    if (panorama_json.length) {
      const json_text = await panorama_json[0].async("text");
      json = JSON.parse(json_text);
      console.log("(panorama.json updated)");
    }

    await System._browser.update_obj_url(panorama_path);
    if (panorama_depth_path)
      await System._browser.update_obj_url(panorama_depth_path);

    await change_panorama(0, panorama_path, { full_path:src, depth:panorama_depth_path, json:json });
  }
  else if (item.isFileSystem && /([^\/\\]+)\.(png|jpg|jpeg|bmp)$/i.test(src)) {
    await change_panorama(0, src)
  }
  else {
    _onDrop_finish.call(DragDrop, item)
  }
}

function onDrop_JSON_change_facemesh_calibration(e) {
  const json = e.detail.json;  
  if (json.facemesh_calibration_type) {
    e.detail.result.return_value = true;
    speech_bubble2('✅Facemesh calibration', 3, { no_word_break:true });
    System._browser.camera.facemesh.import_calibration(json);
  }
  MMD_SA_options.Dungeon.run_event(null,done_branch,0);
}

var object3d_list = [];
var object3d_index = 0;
var object3d_cache = new Map();

async function onDrop_add_object3D(item) {
  function update_model_para(url) {
    if (!item._obj_json) return;

    const model_filename = toLocalPath(url).replace(/^.+[\/\\]/, "");
    const model_filename_cleaned = model_filename.replace(/[\-\_]copy\d+\.(x|gltf|glb|bpm|jpg|jpeg|png|webp)$/, ".$1").replace(/[\-\_]v\d+\.(x|gltf|glb|bpm|jpg|jpeg|png|webp)$/, ".$1");
    const model_para = MMD_SA_options.model_para[model_filename] || MMD_SA_options.model_para[model_filename_cleaned] || {};

    MMD_SA_options.model_para[model_filename] = MMD_SA_options.model_para[model_filename_cleaned] = Object.assign(model_para, item._obj_json.model_para);
  }

  var src = item.path;
  if (item.isFileSystem && /([^\/\\]+)\.zip$/i.test(src)) {
    let zip_file = SA_topmost_window.DragDrop._path_to_obj && SA_topmost_window.DragDrop._path_to_obj[src.replace(/^(.+)[\/\\]/, "")];
    if (!zip_file) {
      const blob = await new Promise((resolve, reject) => {
const xhr = new XMLHttpRequestZIP;
xhr.onload = function () {
  resolve(this.response);
};
xhr.open( "GET", src, true );
xhr.responseType = "blob";
xhr.send();
      });

      const file = new File([blob], src);

// from SA_DragDropEMU()
      console.log("File input (emulated):", file);
      const dd = SA_topmost_window.DragDrop;
      if (!dd._path_to_obj) {
        dd._path_to_obj = {};
        dd._obj_url = {};
      }
      dd._path_to_obj[file.name.replace(/^(.+)[\/\\]/, "")] = file;

      zip_file = file;
    }

    const zip = await new self.JSZip().loadAsync(zip_file);

// will be called, even if content is corrupted

    XMLHttpRequestZIP.zip_by_url(src, zip);

    let model_list = (!MMD_SA.THREEX.enabled) ? zip.file(/\.pmx$/i) : [];
    if (!model_list.length) {
      model_list = zip.file(/\.x$/i);
    }

    if (model_list.length) {
      const model_filename = model_list[0].name.replace(/^.+[\/\\]/, "");
      const model_path = src + "#/" + model_list[0].name;
      console.log(src, model_filename, model_path);

//      object3d_cache.set(model_path, null);

      const model_json = zip.file(/model\.json$/i);
      if (model_json.length) {
        const json = await model_json[0].async("text");
        MMD_SA_options.model_para = Object.assign(MMD_SA_options.model_para, JSON.parse(json, function (key, value) {
          if (typeof value == "string") {
            if (/^eval\((.+)\)$/.test(value)) {
              value = eval(decodeURIComponent(RegExp.$1));
            }
          }
          return value;
        }));
        console.log("(model.json updated)");
      }

      update_model_para(model_path);

      await add_object3D(model_path);

      DEBUG_show('✅PMX/X model (' + model_filename + ')');
    }
    else {
      let panorama_list = zip.file(/\.(png|jpg|jpeg)$/i);
      if (!panorama_list.length) {
        DEBUG_show("(No model found)");
        return;
      }

      const panorama_filename = (panorama_list.filter(n=>!/_depth\.\w{3,4}$/i.test(n.name))[0] || panorama_list[0]).name;//.name;
      const panorama_path = src + "#/" + panorama_filename;
      const panorama_depth_filename = panorama_list.filter(n=>n.name.indexOf(panorama_filename.replace(/\.(\w{3,4})$/, '_depth')) == 0)[0]?.name;
      const panorama_depth_path = (panorama_depth_filename) ? src + "#/" + panorama_depth_filename : '';
      console.log(src, panorama_filename, panorama_depth_filename);

//    object3d_cache.set(model_path, null);

      const panorama_json = zip.file(/panorama\.json$/i);
      let json;
      if (panorama_json.length) {
        const json_text = await panorama_json[0].async("text");
        json = JSON.parse(json_text);
        console.log("(panorama.json updated)");
      }

      await System._browser.update_obj_url(panorama_path);
      if (panorama_depth_path)
        await System._browser.update_obj_url(panorama_depth_path);

      update_model_para(panorama_path);

      await add_object3D(panorama_path, { panorama:{ depth:panorama_depth_path, json:json } });

      DEBUG_show('✅Panorama mini (' + panorama_filename + ')');
    }
  }
  else if (item.isFileSystem && /([^\/\\]+)\.(gltf|glb)$/i.test(src)) {
    if (!MMD_SA.THREEX.enabled) {
      DEBUG_show('(GLTF/GLB not available in MMD mode)');
      return;
    }

    const model_filename = src.replace(/^.+[\/\\]/, "");

//    object3d_cache.set(src, null);

    update_model_para(src);

    await add_object3D(src);

    DEBUG_show('✅GLTF model (' + model_filename + ')');
  }
  else if (item.isFileSystem && /([^\/\\]+)\.(bpm|jpg|jpeg|png|webp|mp4|mkv|webm)$/i.test(src)) {
    const file_type = RegExp.$2.toUpperCase();
    const model_filename = src.replace(/^.+[\/\\]/, "");

//    object3d_cache.set(src, null);

    update_model_para(src);

    await add_object3D(src);

    DEBUG_show('✅' + file_type + ' (' + model_filename + ')');
  }
  else {
    _onDrop_finish.call(DragDrop, item)
  }
}

const add_object3D = (function () {
  let _Object3D_proxy;
  window.addEventListener('load', ()=>{
    _Object3D_proxy = class extends MMD_SA_options.Dungeon.Object3D_proxy_base {
      constructor (object3d) {
super(object3d);
      }

      set hidden(v) {
if (MMD_SA.THREEX.enabled) {
  this._parent._obj.visible = !v;
}
else {
  ((this._parent._obj.children[0]?.isMesh) ? this._parent._obj.children[0] : this._parent._obj).visible = !v;
}
if (this._parent.parent_bone) this._parent.parent_bone.disabled = v;
      }
    };
  });

  function onload_common(url, obj_all) {
const mesh = obj_all.scene;

const _THREE = MMD_SA.THREEX._THREE;
const THREE = MMD_SA.THREEX.THREE;
const THREEX = MMD_SA.THREEX.THREEX;

var model_filename = toLocalPath(url).replace(/^.+[\/\\]/, "");
var model_filename_cleaned = model_filename.replace(/[\-\_]copy\d+\.(x|gltf|glb)$/, ".$1").replace(/[\-\_]v\d+\.(x|gltf|glb)$/, ".$1");
var model_para = MMD_SA_options.model_para[model_filename] || MMD_SA_options.model_para[model_filename_cleaned] || {};

const is_X_model = /\.x/i.test(url);
if (!is_X_model && MMD_SA.THREEX.enabled && !MMD_SA.THREEX.utils.HDRI.path)
  change_HDRI(1, (MMD_SA.THREEX.utils.HDRI.mode == 1) ? false : null);

let material_para = model_para.material_para || {};
material_para = material_para._default_ || {};
if (material_para.receiveShadow != false) {
  mesh.traverse(obj=>{
    if (obj.isMesh) obj.receiveShadow = true;
  });
}

if (MMD_SA.THREEX.enabled) {
}
else {
  if (model_para.instanced_drawing)
    mesh.instanced_drawing = model_para.instanced_drawing
//  mesh.instanced_drawing = 99

  mesh.useQuaternion = true
}

//model_para = { placement:{scale:5}, parent_bone: { model_index:0, name:"右手首", position:{x:0,y:0,z:0}, rotation:{x:0,y:0,z:0} } };

var placement = model_para.placement || {};
mesh.position.copy(_THREE.MMD.getModels()[0].mesh.position);
if (placement.position)
  mesh.position.add(placement.position);
if (placement.rotation)
  mesh.quaternion.setFromEuler(e1.copy(placement.rotation).multiplyScalar(Math.PI/180));
mesh.scale.setScalar(placement.scale||((is_X_model) ? 10 : 1));

var object3d = Object.assign({}, model_para);
object3d.uuid = THREE.Math.generateUUID();
if (!object3d.user_data) object3d.user_data = {};
object3d._obj = object3d._mesh = mesh;
object3d._obj_proxy = new _Object3D_proxy(object3d);

var model_id = model_filename;
if (object3d_cache.get(url)) {
  model_id += '(cloned)';
}
else {
  object3d_cache.set(url, object3d);
}

const obj_cached = object3d_cache.get(url);
object3d._obj_base = obj_cached._obj_base || {
  octree_collider_radius: model_para.octree_collider_radius||1,
};

object3d.no_collision = true;
object3d.collision_by_mesh = true;
object3d.collision_by_mesh_sort_range = 1;

object3d_index = object3d_list.length;
object3d_list.push(object3d);
MMD_SA.THREEX._object3d_list_ = object3d_list;

if (object3d.parent_bone)
  MMD_SA_options.Dungeon.accessory_list.push(object3d);

object3d.user_data.id = model_id;
object3d.user_data.path = url;
object3d.user_data.obj_all = obj_all;

object3d.user_data._rotation_ = new THREE.Euler();
if (placement.rotation)
  object3d.user_data._rotation_.copy(placement.rotation).multiplyScalar(Math.PI/180);

object3d.user_data._default_state_ = {
  position: (object3d.parent_bone) ? new THREE.Vector3() : mesh.position.clone(),
  scale: mesh.scale.x,
  parent_bone_name: (object3d.parent_bone && object3d.parent_bone.name) || '',
};

if (obj_all.animations && obj_all.animations.length && !object3d.animation_disabled) {
  object3d.user_data.animation_clip = obj_all.animations[0];
  object3d.user_data.animation_mixer = new MMD_SA.THREEX.THREE.AnimationMixer(mesh);
  object3d.user_data.animation_mixer.clipAction(object3d.user_data.animation_clip).play();
}

console.log(object3d)

if (!object3d.parent_bone) {
//  System._browser.camera.poseNet.auto_grounding = true
  System._browser.camera.poseNet.ground_plane_visible = false
  MMD_SA.WebXR.ground_plane.visible = System._browser.camera.poseNet.ground_plane_visible

  System._browser.camera.display_floating = (MMD_SA_options.user_camera.display.floating_auto !== false);
}

MMD_SA.THREEX.scene.add(mesh);

build_octree(object3d);

if (placement.hidden) {
  object3d._obj_proxy.hidden = true;
}

// in explorer mode, make sure that collision is off at the beginning
//object3d.no_collision = true;
  }

  return async function (url, para={}) {
    return new Promise((resolve)=>{
      const obj_cached = object3d_cache.get(url);
      if (obj_cached) {
const obj_cloned = { scene:obj_cached.user_data.obj_all.scene.clone(), animations:obj_cached.user_data.obj_all.animations };
console.log('object3D cloned', url);

onload_common(url, obj_cloned);
resolve();
      }
      else if (/\.pmx$/i.test(url)) {

(()=>{

const model_index = THREE.MMD.getModels().length;

const model_filename_raw = url.replace(/^.+[\/\\]/, "");
const model_filename = model_filename_raw;
const model_filename_cleaned = model_filename.replace(/[\-\_]copy\d+\.pmx$/, ".pmx").replace(/[\-\_]v\d+\.pmx$/, ".pmx");

const model_para_obj = Object.assign({}, MMD_SA_options.model_para[model_filename_raw] || MMD_SA_options.model_para[model_filename] || MMD_SA_options.model_para[model_filename_cleaned] || {});
model_para_obj._filename_raw = model_filename_raw;
model_para_obj._filename = model_filename;
model_para_obj._filename_cleaned = model_filename_cleaned;

    if (!model_para_obj.skin_default)
      model_para_obj.skin_default = { _is_empty:true }
// save some headaches and make sure that every VMD has morph (at least a dummy) in "Dungeon" mode
  if (!model_para_obj.morph_default) model_para_obj.morph_default = {}//{ _is_empty:!MMD_SA_options.Dungeon }//

    if (!model_para_obj.MME)
      model_para_obj.MME = {}
    var MME_saved = MMD_SA_options.MME_saved[model_filename] || MMD_SA_options.MME_saved[model_filename_cleaned]
    if (MME_saved) {
      model_para_obj.MME.self_overlay = Object.clone(MME_saved.self_overlay)
      model_para_obj.MME.HDR = Object.clone(MME_saved.HDR)
      model_para_obj.MME.serious_shader = Object.clone(MME_saved.serious_shader)
    }
    else {
      model_para_obj.MME.self_overlay = model_para_obj.MME.self_overlay || { enabled:false }
      model_para_obj.MME.HDR = model_para_obj.MME.HDR || { enabled:false }
      model_para_obj.MME.serious_shader = model_para_obj.MME.serious_shader || { enabled:false }
    }

model_para_obj._model_index = model_para_obj._model_index_default = model_index;
model_para_obj.is_object = true;
model_para_obj.shadow_darkness = 1;
MMD_SA_options.model_para_obj_by_filename[model_filename_raw] = model_para_obj;

MMD_SA_options.model_para_obj_all.push(model_para_obj);

new THREE.MMD.PMX().load(url, (pmx)=>{
new THREE.MMD.Model( pmx ).create( {}, function( model ) {

			var mesh = model.mesh;
			mesh.material.materials.forEach( function(v) {
				v.fog = true; // use scene fog
				v.lights = true; // use scene light
			});
			THREE.MMD.addModel( model );

new MMD_SA.THREEX.MMD_dummy_obj(model_index);

const mesh_obj_id = 'mikuPmx' + model_index;
const mesh_obj = MMD_SA_options.mesh_obj_by_id['#'+mesh_obj_id] = MMD_SA_options.mesh_obj_by_id[mesh_obj_id] = {
  id: '#'+mesh_obj_id,
  scale: 1,
  _obj: mesh,
  hide: MMD_SA_options.mesh_obj_by_id['#mikuPmx0'].hide,
  show: MMD_SA_options.mesh_obj_by_id['#mikuPmx0'].show,
};
Object.defineProperty(mesh_obj, "visible", {
  get: function () {
return this._obj.visible
  }
 ,set: function (v) {
this._obj.visible = v
  }
});

const AP = MMD_SA.ammo_proxy;
if (AP) {
  const c_list = [AP.cache_by_model, AP.cache_by_model_next, AP.cache_by_model_temp];
  c_list.forEach(function (cache, idx) {
    var obj = cache.list[model_index] = { skin:{}, _skin:{} }
    obj.matrixWorld = new THREE.Matrix4()
    obj.matrixWorld_inv = new THREE.Matrix4()
    obj.q_matrixWorld_inv = new THREE.Quaternion()
  });
}

const _mesh = mesh;
mesh = new THREE.Object3D();
mesh.add(_mesh);

onload_common(url, {scene:mesh});
resolve();

System._browser.on_animation_update.add((()=>{
  const pos = mesh.position.clone();
  const rot = mesh.quaternion.clone();
  const scale = mesh.scale.clone();
//console.log(pos, rot, scale)
  return ()=>{
    mesh.position.copy(pos);
    mesh.quaternion.copy(rot);
    mesh.scale.copy(scale);
    _mesh.scale.setScalar(1);
  };
})(),0,0);

});});

})();

      }
      else if (/\.x$/i.test(url)) {
        new THREE.XLoader( url, function( mesh ) {
const THREE = MMD_SA.THREEX.THREE;

const _mesh = mesh;
mesh = new THREE.Object3D();
mesh.add(_mesh);

onload_common(url, {scene:mesh});
resolve();
        }, function() {
        });
      }
      else if (/.(gltf|glb)$/i.test(url)) {
        MMD_SA.THREEX.utils.load_GLTF(url, (gltf)=>{
onload_common(url, gltf);
resolve();
        });
      }
      else if (/.(bpm|jpg|jpeg|png|webp|mp4|mkv|webm)$/i.test(url)) {
        const is_video = /.(mp4|mkv|webm)$/i.test(url);
        const img = (is_video) ? document.createElement('video') : new Image();
        if (is_video) {
          img.autoplay = img.loop = true;
//          img.muted = true;
        }

        img.addEventListener((is_video)?'loadeddata':'load', async ()=>{
const THREE = MMD_SA.THREEX.THREE;

let mesh, geometry, texture, canvas;

if (para.panorama) {
  canvas = document.createElement('canvas');

  const cw = (is_mobile) ? 2048 : 4096;
  const ch = 2048;
  canvas.width  = cw
  canvas.height = ch

  canvas.getContext("2d").drawImage(img, 0,0,img.width,img.height, 0,0,cw,ch);

  texture = new THREE.Texture(canvas);
//THREE.BackSide,THREE.DoubleSide
  const material = new THREE.MeshBasicMaterial( { map:texture, side:THREE.BackSide, fog:false, transparent:true } );

  const sd = MMD_SA_options.Dungeon_options.skydome;
  let dw = para.panorama.json?.width_segments  || sd.width_segments;
  let dh = para.panorama.json?.height_segments || sd.height_segments;
  geometry = new THREE.SphereGeometry( 64*4, dw, dh );

  mesh = new THREE.Mesh(
    geometry,
    material,
  );

  if (para.panorama.depth) {
    await new Promise((resolve)=>{
      const image = new Image();
      image.onload = ()=>{
        update_panorama_depth(image, mesh, para.panorama.json);
        resolve();
      };
      image.onerror = ()=>{
//        panorama_loading = false;
        resolve();
      };
      image.src = toFileProtocol(para.panorama.depth);
    });
  }
}
else {
  if (is_video) {
    if (MMD_SA.THREEX.enabled) {
      texture = new THREE.VideoTexture(img);
    }
    else {
      canvas = document.createElement('canvas');
      canvas.width = 1024;//Math.min(img.videoWidth, 1080);
      canvas.height = 1024;//Math.min(img.videoHeight, 1080);
      texture = new THREE.Texture(canvas);
//texture.generateMipmaps = false;
    }
  }
  else {
    texture = new THREE.Texture(img);
  }

  geometry = new THREE.PlaneGeometry( (img.videoWidth||img.width)/100, (img.videoHeight||img.height)/100 );
  const material = new THREE.MeshBasicMaterial( {map:texture, side:THREE.DoubleSide} );

  mesh = new THREE.Mesh( geometry, material );
}

if (!MMD_SA.THREEX.enabled) mesh.useQuaternion = true;

if (MMD_SA.THREEX.enabled && MMD_SA.THREEX.use_sRGBEncoding) texture.colorSpace = THREE.SRGBColorSpace;
texture.needsUpdate = true;

const obj_all = { scene:mesh };

onload_common(url, obj_all);

if (is_video) {
  const obj = object3d_list[object3d_list.length-1];
  obj.user_data.video = img;
  obj.user_data.canvas = canvas;
}

resolve();
        });

        img.src = toFileProtocol(url);
      }
    });
  };
})();

function animate_object3D() {
  object3d_list.forEach(obj=>{
    const d = obj.user_data;
    if (d.animation_mixer)
      d.animation_mixer.update(RAF_timestamp_delta/1000);
    if (d.video && d.canvas) {
      const canvas = d.canvas;
      canvas.getContext('2d').drawImage(d.video, 0,0,canvas.width,canvas.height);
      obj._obj.material.map.needsUpdate = true;
    }
  });
}

const adjust_object3D = (function () {
  const parent_bone_list = ['ROOT', '頭','首', '上半身2','上半身','左腕','左ひじ','左手首','右腕','右ひじ','右手首', '左足','左ひざ','左足首','右足','右ひざ','右足首'];

  let pos_scale = 0;

  let use_avatar_as_center = false;

  return function(e) {
if (!object3d_list.length) return;

const THREE = MMD_SA.THREEX.THREE;
const _THREE = MMD_SA.THREEX._THREE;

const c_pos = _THREE.MMD.getModels()[0].mesh.position;

let obj = object3d_list[object3d_index];
let mesh = obj._obj;
let ds = obj.user_data._default_state_;

let p = (obj.parent_bone) ? obj.parent_bone : mesh;

let pos_inc = ((obj.parent_bone) ? 0.1 : 0.5) * Math.pow(2, pos_scale);

let rot_inc = Math.PI/90;

const sign_center = (use_avatar_as_center) ? -1 : 1;

const ev = e.detail.e;

let pos = v3a.set(0,0,0);
let rot = e1.set(0,0,0);
let scale = 1;
switch (e.detail.keyCode) {
// left
  case 37:
    if (ev.ctrlKey) {
      rot.y -= rot_inc;
    }
    else if (ev.shiftKey) {
      rot.z -= rot_inc;
    }
    else {
      pos.x -= pos_inc * sign_center;
    }
    break
// top
  case 38:
    if (ev.ctrlKey) {
      rot.x += rot_inc;
    }
    else if (ev.shiftKey) {
      pos.y += pos_inc * sign_center;
    }
    else if (ev.altKey) {
      if (explorer_mode)
        MMD_SA_options.Dungeon.para_by_grid_id[2].ground_y += pos_inc;
    }
    else {
      pos.z -= pos_inc * sign_center;
    }
    break;
// right
  case 39:
    if (ev.ctrlKey) {
      rot.y += rot_inc;
    }
    else if (ev.shiftKey) {
      rot.z += rot_inc;
    }
    else {
      pos.x += pos_inc * sign_center;
    }
    break
// down
  case 40:
    if (ev.ctrlKey) {
      rot.x -= rot_inc;
    }
    else if (ev.shiftKey) {
      pos.y -= pos_inc * sign_center;
    }
    else if (ev.altKey) {
      if (explorer_mode)
        MMD_SA_options.Dungeon.para_by_grid_id[2].ground_y -= pos_inc;
    }
    else {
      pos.z += pos_inc * sign_center;
    }
    break;
// +
  case 61:
  case 107:
    if (ev.shiftKey) {
    }
    else if (ev.ctrlKey) {
      pos_inc /= Math.pow(2, pos_scale);
      pos_scale = Math.min(pos_scale+1, 4);
      pos_inc *= Math.pow(2, pos_scale);
    }
    else {
      scale *= 1.1;
    }
    break;
// -
  case 109:
  case 173:
    if (ev.shiftKey) {
    }
    else if (ev.ctrlKey) {
      pos_inc /= Math.pow(2, pos_scale);
      pos_scale = Math.max(pos_scale-1, -4);
      pos_inc *= Math.pow(2, pos_scale);
    }
    else {
      scale *= 1/1.1;
    }
    break;
// B
  case 66:
    const parent_bone_index = (!obj.parent_bone) ? -1 : parent_bone_list.indexOf(obj.parent_bone.name);
    if (obj.parent_bone && (parent_bone_index == -1))
      parent_bone_list.push(obj.parent_bone.name);
    if ((parent_bone_index == -1) || (parent_bone_index < parent_bone_list.length-1)) {
      use_avatar_as_center = false;
      const parent_bone_name = parent_bone_list[parent_bone_index+1];
      obj.parent_bone = { model_index:0, name:parent_bone_name, position:{x:0,y:0,z:-1}, rotation:{x:0,y:0,z:0} };
      if (parent_bone_index == -1) {
        MMD_SA_options.Dungeon.accessory_list.push(obj);
      }
      p = obj.parent_bone;
    }
    else {
      delete obj.parent_bone;
      use_avatar_as_center = explorer_mode;
      MMD_SA_options.Dungeon.accessory_list = MMD_SA_options.Dungeon.accessory_list.filter(a => a !== obj);
      p = mesh;
      mesh.position.copy(c_pos);
// re-enable .matrixAutoUpdate as accessory disabled it
      mesh.matrixAutoUpdate = true;
    }
    obj.no_collision = !explorer_mode || !!obj.parent_bone;
    break;
// C
  case 67:
    if (obj.parent_bone) {
      speech_bubble2(System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.note_object_fixed_as_center'), 5);
      return;
    }
    if (explorer_mode) {
      speech_bubble2(System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.note_avatar_fixed_as_center'), 8);
      return;
    }
    use_avatar_as_center = !use_avatar_as_center;
    speech_bubble2(System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.' + ((use_avatar_as_center) ? 'avatar' : 'object') + '_as_center'), 2);
    break;
// O
  case 79:
    if (++object3d_index >= object3d_list.length)
      object3d_index = 0;

    obj = object3d_list[object3d_index];
    mesh = obj._obj;
    ds = obj.user_data._default_state_;

    p = (obj.parent_bone) ? obj.parent_bone : mesh;

    pos_inc = ((obj.parent_bone) ? 0.1 : 0.5) * Math.pow(2, pos_scale);
    break;
// R
  case 82:
    if (!e.detail.reset_confirmed) {
      MMD_SA_options.Dungeon.run_event({
message: {
  index: 1,
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.reset'); },
  para: { scale:0.75 },
  branch_list: [
    { key:8, event_id:{ sb_index:1, func:()=>{setTimeout(()=>{adjust_object3D({detail:{reset_confirmed:true,keyCode:82,ev:{},result:{}}})},0)}, ended:true } },
    { key:[9,'Esc'], event_id:{ sb_index:1, ended:true } },
  ]
}
      });
    }
    else {
      let p_rot;
      if (ds.parent_bone_name) {
        if (!obj.parent_bone) {
          obj.parent_bone = { model_index:0, name:ds.parent_bone_name, position:{x:0,y:0,z:-1}, rotation:{x:0,y:0,z:0} };
          MMD_SA_options.Dungeon.accessory_list.push(obj);
        }
        p = obj.parent_bone;
        p_rot = p.rotation;
      }
      else {
        if (obj.parent_bone) {
          delete obj.parent_bone;
          MMD_SA_options.Dungeon.accessory_list = MMD_SA_options.Dungeon.accessory_list.filter(a => a !== obj);
        }
        p = mesh;
        p_rot = obj.user_data._rotation_;
        p_rot.x = p_rot.y = p_rot.z = 0;
// re-enable .matrixAutoUpdate as accessory disabled it
        mesh.matrixAutoUpdate = true;
      }
      if (!obj.parent_bone) {
        mesh.position.copy(ds.position);
      }

      mesh.scale.setScalar(ds.scale);

      use_avatar_as_center = !ds.parent_bone_name && explorer_mode;

      speech_bubble2('(' + System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.reset.successful') + ')', 3);
    }
    break;
// X
  case 88:
    if (!e.detail.remove_confirmed) {
      MMD_SA_options.Dungeon.run_event({
message: {
  index: 1,
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.remove'); },
  para: { scale:0.75 },
  branch_list: [
    { key:8, event_id:{ sb_index:1, func:()=>{setTimeout(()=>{adjust_object3D({detail:{remove_confirmed:true,keyCode:88,ev:{},result:{}}})},0)}, ended:true } },
    { key:[9,'Esc'], event_id:{ sb_index:1, ended:true } },
  ]
}
      });
    }
    else {
      remove_object3D(object3d_index);

      if (!object3d_index.length) {
        System._browser.DEBUG_show();
        e.detail.result.return_value = true;
        return;
      }

      obj = object3d_list[object3d_index];
      mesh = obj._obj;
      ds = obj.user_data._default_state_;

      p = (obj.parent_bone) ? obj.parent_bone : mesh;

      pos_inc = ((obj.parent_bone) ? 0.1 : 0.5) * Math.pow(2, pos_scale);
    }
    break;
  default:
    return;
}

explorer_ground_y = MMD_SA_options.Dungeon.para_by_grid_id[2].ground_y;

if (use_avatar_as_center && !obj.parent_bone) {
  pos.add(v3b.copy(p.position).sub(c_pos).multiplyScalar(scale)).applyEuler(rot).add(c_pos);
}
else {
  pos.add(v3b.copy(p.position));
}

p.position.x = pos.x;
p.position.y = pos.y;
p.position.z = pos.z;

if (obj.parent_bone) {
  rot.fromArray(rot.toArray().slice(0,3).map(v=>Math.round(v*180/Math.PI)));
  p.rotation.x += rot.x;
  p.rotation.y += rot.y;
  p.rotation.z += rot.z;
}
else {
  obj.user_data._rotation_.add(rot);
}

mesh.scale.multiplyScalar(scale);

System._browser.DEBUG_show([
  (object3d_index+1) + '/' + object3d_list.length + ': ' + obj.user_data.id,
  '',
  'Position(±' + (Math.round(pos_inc*1000)/1000) + '): ' + ((obj.parent_bone) ? v3a.copy(p.position) : v3a.copy(p.position).sub(c_pos)).toArray().map(v=>Math.round(v*10)/10),
  'Rotation(±' + (2) + '°): ' + ((obj.parent_bone) ? e1.copy(p.rotation).toArray().slice(0,3) : e1.copy(obj.user_data._rotation_).toArray().slice(0,3).map(v=>Math.round(v*180/Math.PI))),
  'Scale: ' + Math.round(mesh.scale.x*10)/10,
  '',
  'Ground Y(±' + (Math.round(pos_inc*1000)/1000) + '): ' + Math.round(MMD_SA_options.Dungeon.para_by_grid_id[2].ground_y*10)/10,
  '',
  ((obj.parent_bone) ? 'Attach to: ' + (MMD_SA.THREEX.VRM.bone_map_MMD_to_VRM[obj.parent_bone.name] || obj.parent_bone.name) : 'Center: ' + ((use_avatar_as_center) ? 'Avatar' : 'Object')),
].join('\n'));

if (!obj.parent_bone)
  mesh.quaternion.setFromEuler(obj.user_data._rotation_);

highlight_object(obj);

e.detail.result.return_value = true;
  };
})();

var explorer_mode = false;
window.addEventListener('jThree_ready', ()=>{
  Object.defineProperty(MMD_SA_options, '_XRA_explorer_mode', {
    get: ()=>explorer_mode,
  });
});

function build_octree(object3d) {
  object3d.no_collision = !explorer_mode || !!object3d.parent_bone;

  if (!object3d.use_octree && (!explorer_mode || object3d.parent_bone)) return;

  const obj_cached = object3d_cache.get(object3d.user_data.path);
  const mesh_parent = obj_cached._obj;

  const bounding_host = MMD_SA.get_bounding_host(mesh_parent);
  if (!bounding_host.boundingBox) {
    bounding_host.boundingBox = MMD_SA.THREEX.utils.computeBoundingBox(mesh_parent);
  }
  if (!bounding_host.boundingBox_list)
    bounding_host.boundingBox_list = [bounding_host.boundingBox];
  if (!bounding_host.boundingSphere)
    bounding_host.boundingSphere = bounding_host.boundingBox.getBoundingSphere(new THREE.Sphere());

  if (!object3d._obj_base.octree) {
    const octree = new THREEX.Octree();
    octree.fromGraphNode( object3d._obj );
    object3d._obj_base.octree = octree;

    octree._is_back_side = (mesh_parent.material?.side == MMD_SA.THREEX.THREE.BackSide) ? true : false;

    console.log('octree', object3d);
  }
}

var grid_plane;
function add_grid() {
  if (grid_plane) {
    if (!explorer_mode) {
      grid_plane.visible = true;
      grid_plane.children.forEach(c=>c.visible=true);
    }
    return;
  }

  const THREE = MMD_SA.THREEX.THREE;
  const _THREE = MMD_SA.THREEX._THREE;

  const geometry_base = new THREE.PlaneGeometry( 30*5, 30*5 );
  const geometry = new THREE.PlaneGeometry( 30*5, 30*5, 30, 30 );

  const m4 = new THREE.Matrix4().makeRotationX(THREE.Math.degToRad(-90));
  geometry_base.applyMatrix(m4);
  geometry.applyMatrix(m4);

  let line;
  if (MMD_SA.THREEX.enabled) {
    line = new THREE.GridHelper( 30*5, 30, '#000', '#000' );
    line.material.transparent = true;
  }
  else {
    const material = new THREE.MeshBasicMaterial( { color:'#000', wireframe:true, transparent:true } );
    line = new THREE.Mesh( geometry, material );
  }

  grid_plane = new THREE.Object3D();
  grid_plane.add(line);

  const material_base = new THREE.MeshBasicMaterial( { color:'#FFF', transparent:true });
  const mesh_base = new THREE.Mesh(geometry_base, material_base);
  mesh_base.position.y -= 0.05;
  grid_plane.add(mesh_base);

  if (!MMD_SA.THREEX.enabled) grid_plane.useQuaternion = true;

  grid_plane.position.copy(_THREE.MMD.getModels()[0].mesh.position);
  grid_plane.position.y += 0.1;

  MMD_SA.THREEX.scene.add(grid_plane);

// can be changed only after scene.add for _THREE
  if (grid_plane.children[1])
    grid_plane.children[1].material.opacity = 0.5;
}

window.addEventListener('SA_Dungeon_onrestart', ()=>{remove_object3D()});
function remove_object3D(index) {
  ((index == null) ? object3d_list : [object3d_list[index]]).forEach(object3d => {
    MMD_SA.THREEX.scene.remove(object3d._obj);

    if (object3d.parent_bone)
      MMD_SA_options.Dungeon.accessory_list = MMD_SA_options.Dungeon.accessory_list.filter(a => a !== object3d);

    const d = object3d.user_data;
    if (d.animation_mixer) {
      d.animation_mixer.stopAllAction();
      d.animation_mixer.uncacheClip(d.animation_clip);
    }
    if (d.video) {
      d.video.pause();
      delete d.video;
    }

    MMD_SA.THREEX.utils.dispose(object3d._obj);

    delete object3d._obj;
    delete object3d._mesh;
  });

  if (index == null) {
    object3d_list.length = 0;
  }
  else {
    const path = object3d_list[index].user_data.path;
    object3d_list = MMD_SA.THREEX._object3d_list_ = object3d_list.filter(object3d=>object3d._obj);
//    if (!object3d_list.some(object3d=>object3d.user_data.path==path)) object3d_cache.delete(path);
  }

  object3d_index = 0;

  if (!object3d_list.length) {
    object3d_cache.clear();
    delete MMD_SA.THREEX._object3d_list_;
  }
}

var panorama_loading;
var panorama_src, panorama_index;
var panorama_list = [
  '',
  System.Gadget.path + '/images/_dungeon/tex/ryntaro_nukata/blue_sky.jpg',
  System.Gadget.path + '/images/_dungeon/tex/ryntaro_nukata/angel_staircase.jpg',
  System.Gadget.path + '/images/_dungeon/tex/stars_milky_way.jpg',
];

var canvas_dummy, canvas_dummy2;
function update_panorama_depth(image, mesh, para={}) {
  const THREE = MMD_SA.THREEX.THREE;

  const m = mesh.material;

  const canvas = document.createElement('canvas');
  canvas.width  = image.width; 
  canvas.height = image.height;

  const ctx = canvas.getContext('2d');
  ctx.globalCompositeOperation = 'source-over';
  ctx.drawImage(image, 0,0);

  canvas_dummy = canvas_dummy || document.createElement('canvas');
  canvas_dummy.width  = 1;
  canvas_dummy.height = image.height;
  const ctx_dummy = canvas_dummy.getContext('2d');
  ctx_dummy.globalCompositeOperation = 'source-over';
  ctx_dummy.globalAlpha = 1;
  ctx_dummy.drawImage(image, 0,0,1,image.height, 0,0,1,image.height);
  ctx_dummy.globalAlpha = 0.5;
  ctx_dummy.drawImage(image, image.width-1,0,1,image.height, 0,0,1,image.height);
  for (let x = 0; x < 1; x++) {
    ctx.drawImage(canvas_dummy, 0,0,1,image.height, x,0,1,image.height);
    ctx.drawImage(canvas_dummy, 0,0,1,image.height, image.width-1-x,0,1,image.height);
  }

  ctx.globalCompositeOperation = 'screen';
  ctx.drawImage(canvas, 0,0);

  if (m.transparent && para.depth_to_alpha) {
    canvas_dummy.width  = image.width; 
    canvas_dummy.height = image.height;
    ctx_dummy.globalAlpha = 1;
    ctx_dummy.drawImage(canvas, 0,0);

    const depth_to_alpha_fadeout_start = para.depth_to_alpha.fadeout_start || 0.3;
    const depth_to_alpha_fadeout_end   = para.depth_to_alpha.fadeout_end   || 0.1;
    ctx_dummy.globalAlpha = 1;

    let c = ~~((1-depth_to_alpha_fadeout_start)*256);
    ctx_dummy.fillStyle = 'rgb(' + [c,c,c].join(' ') + ')';
    ctx_dummy.globalCompositeOperation = 'lighter';
    ctx_dummy.fillRect(0,0,image.width,image.height);

    c = ~~((depth_to_alpha_fadeout_start * (1-depth_to_alpha_fadeout_end))*256);
    ctx_dummy.fillStyle = 'rgb(' + [c,c,c].join(' ') + ')';
    ctx_dummy.globalCompositeOperation = 'color-burn';
    ctx_dummy.fillRect(0,0,image.width,image.height);

  // CONV. STEP: move a component channel to alpha-channel
    let idata = ctx_dummy.getImageData(0, 0, canvas_dummy.width, canvas_dummy.height);
    let data32 = new Uint32Array(idata.data.buffer);
    let i = 0, len = data32.length;
    while(i < len) {
      data32[i] = data32[i++] << 8; // shift blue channel into alpha (little-endian)
    }
  // update canvas
    ctx_dummy.putImageData(idata, 0, 0); 
    idata = data32 = undefined;

    const canvas_color = m.map.image;
    const ctx_color = canvas_color.getContext('2d');
    ctx_color.globalCompositeOperation = 'destination-in';
    ctx_color.drawImage(canvas_dummy, 0,0,canvas_color.width,canvas_color.height);
    ctx_color.globalCompositeOperation = 'copy';
  }

  ctx.globalCompositeOperation = 'copy';
  ctx.filter = 'blur(16px)';
  ctx.drawImage(canvas, 0,0);
  ctx.filter = 'none';

  const canvas_disp = canvas_dummy2 = canvas_dummy2 || document.createElement('canvas');
  const sd = MMD_SA_options.Dungeon_options.skydome;
  let dw = canvas_disp.width  = para.width_segments  || sd.width_segments;
  let dh = canvas_disp.height = para.height_segments || sd.height_segments;
  const ctx_disp = canvas_disp.getContext('2d');
  ctx_disp.globalCompositeOperation = 'source-over';
  ctx_disp.globalAlpha = 1;
  ctx_disp.drawImage(canvas, 0,0,dw,dh);
  const depth_idata = ctx_disp.getImageData(0,0,dw,dh);

  if (MMD_SA.THREEX.enabled) {
    const pos = mesh.geometry.getAttribute('position');
    const uv  = mesh.geometry.getAttribute('uv');
//console.log(pos.count,uv.count,mesh.geometry.getIndex().count)
    for (let i = 0, i_max = pos.count; i < i_max; i++) {
      let x = uv.array[i*2];
      let y = uv.array[i*2+1];
      if (x < 0) x += 1;
      if (y < 0) y += 1;
      y = 1-y;

      x = Math.round(x*dw);
      y = Math.round(y*dh);
      if (x == dw) x = 0;
      if (y == dh) y = 0;

      const depth = 1 - depth_idata.data[(y*dw + x) * 4]/255 * (192/256);
//continue
      for (let j = 0; j < 3; j++)
        pos.array[i*3+j] *= depth;
    }
  }
  else {
    const pos  = mesh.geometry.vertices;
    const uv   = mesh.geometry.faceVertexUvs[0];
    const face = mesh.geometry.faces;

    const v_index = {};
    const face_a = ['a', 'b', 'c'];
    for (let i = 0, i_max = face.length; i < i_max; i++) {
      const f_obj = face[i];
      for (let f = 0; f < 3; f++) {
        const vi = f_obj[face_a[f]];
        if (v_index[vi]) break;
        v_index[vi] = true;

        let x = uv[i][f].x;
        let y = uv[i][f].y;
        if (x < 0) x += 1;
        if (y < 0) y += 1;
        y = 1-y;

        x = Math.round(x*dw);
        y = Math.round(y*dh);
        if (x == dw) x = 0;
        if (y == dh) y = 0;

        const depth = 1 - depth_idata.data[(y*dw + x) * 4]/255 * (192/256);
//continue
        pos[vi].multiplyScalar(depth);
      }
    }
  }

/*
  if (!m.displacementMap)
    m.displacementMap = new THREE.Texture(canvas);
  m.displacementMap.needsUpdate = true;
  m.displacementScale = -192;
*/
//ctx.drawImage(canvas_dummy, 0,0,canvas.width,canvas.height); return;
}

async function change_panorama(index, src, para={}) {
  function show() {
    panorama_loading = false;
    sd.texture_index = index;
    sd.texture_setup();
    System._browser.camera.display_floating = (MMD_SA_options.user_camera.display.floating || (MMD_SA_options.user_camera.display.floating_auto !== false));

    if (MMD_SA.THREEX.enabled) {
      MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.traverse(obj=>{
       obj.layers.enable(MMD_SA.THREEX.PPE.N8AO.NO_AO);
      });

      MMD_SA.THREEX.scene.background = null;
    }

    panorama_index = index;
    panorama_src = para.full_path || src;
  }

  var sd = MMD_SA_options.Dungeon_options.skydome
  if (panorama_loading) {
    DEBUG_show('(panorama still loading)', 2)
    return
  }
  if (index && sd.texture_cache_list[index] && sd.texture_cache_list[index].complete) {
    show()
    return
  }

  if (!src) src = panorama_list[index];

  panorama_loading = true;

  await new Promise((resolve)=>{
    const image = sd.texture_cache_list[index] = sd.texture_cache_list[index] || new Image();
    image.onload = ()=>{
      resolve();
    };
    image.onerror = ()=>{
      panorama_loading = false;
      resolve();
    };
    image.src = toFileProtocol(src);
  });

  if (panorama_loading && para.depth) {
    panorama_loading = true;
    await new Promise((resolve)=>{
      const image = sd.texture_cache_list[-1] = sd.texture_cache_list[-1] || new Image();
      image.onload = ()=>{
        update_panorama_depth(image, MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj, para.json);
        resolve();
      };
      image.onerror = ()=>{
//        panorama_loading = false;
        resolve();
      };
      image.src = toFileProtocol(para.depth);
    });
  }

  if (panorama_loading)
    show();
}

var dome_axis_angle = 0;
var dome_rotation_speed = 0;
var dome_rotation = 0;
function rotate_dome() {
  var axis = v3a.set(0,1,0);
  axis.applyEuler(e1.set(0, 0, dome_axis_angle/180*Math.PI));
  dome_rotation = (dome_rotation + RAF_timestamp_delta/(1000*60*10) * dome_rotation_speed * 360) % 360;

  MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.quaternion.setFromAxisAngle(axis, dome_rotation/180*Math.PI);

  if (!MMD_SA.THREEX.enabled) {
    MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.useQuaternion = true;
  }
  else {
    e1.setFromQuaternion(MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.quaternion);

    if (MMD_SA.THREEX.scene.environment)
      MMD_SA.THREEX.scene.environmentRotation.copy(e1);
    if (MMD_SA.THREEX.scene.background)
      MMD_SA.THREEX.scene.backgroundRotation.copy(e1);
  }
}

function remove_skybox() {
  MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.visible = false;
  MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.quaternion.set(0,0,0,1);

  dome_rotation = 0;
//  dome_axis_angle = 0;
//  dome_rotation_speed = 0;

  System._browser.on_animation_update.remove(rotate_dome,1);
}

const HDRI_list = [
  'colorful_studio.hdr',
  'rustig_koppie_puresky.hdr',
  'ballroom.hdr',
  'photo_studio_loft_hall.hdr',
  'blue_photo_studio.exr',
];

async function change_HDRI(index, use_background) {
  if ((use_background == null) || !MMD_SA.THREEX.utils.HDRI.mode)
    use_background = (!MMD_SA.THREEX.utils.HDRI.mode) ? false : ((MMD_SA.THREEX.utils.HDRI.mode == 1) ? (!MMD_SA_options.mesh_obj_by_id["DomeMESH"]?._obj.visible && (!!MMD_SA.THREEX.scene.background || !MMD_SA.THREEX._object3d_list_?.length)) : true);

  await MMD_SA.THREEX.utils.HDRI.load(System.Gadget.path + '/images/_dungeon/hdri/' + ((use_background)?'full/':'') + HDRI_list[index-1], use_background);

  if (use_background) {
    remove_skybox();

    if (dome_rotation_speed) {
      System._browser.on_animation_update.remove(rotate_dome,1);
      System._browser.on_animation_update.add(rotate_dome,0,1,-1);
    }
  }
}

function remove_HDRI() {
  if (!MMD_SA.THREEX.enabled) return;

  MMD_SA.THREEX.scene.background = null;
  MMD_SA.THREEX.scene.environment = null
  MMD_SA.THREEX.scene.environmentRotation.set(0,0,0);
  MMD_SA.THREEX.scene.backgroundRotation.set(0,0,0);

  System._browser.on_animation_update.remove(rotate_dome,1);
}

const scene_json_for_export = {
  XR_Animator_scene: {}
};

const onDrop_scene_JSON = (function () {
  const RE_arm = new RegExp("^(" + toRegExp(["左","右"],"|") + ")(" + toRegExp(["肩","腕","ひじ","手"],"|") + "|." + toRegExp("指") + ")(.*)$");

  function adjust_parent_bone(p_bone, is_T_pose) {
if (!RE_arm.test(p_bone.name)) return;

const pos_vector = MMD_SA.TEMP_v3.set(p_bone.position.x, p_bone.position.y, -p_bone.position.z);
const dir = (RegExp.$1 == '左') ? 1 : -1;
const rot_axis = MMD_SA.THREEX.rot_arm_axis[dir * ((is_T_pose) ? 1 : -1)];
pos_vector.applyQuaternion(rot_axis);
p_bone.position.x =  pos_vector.x;
p_bone.position.y =  pos_vector.y;
p_bone.position.z = -pos_vector.z;

const obj_rot = MMD_SA._q1.setFromEuler(MMD_SA.TEMP_v3.set(-p_bone.rotation.x, -p_bone.rotation.y, p_bone.rotation.z).multiplyScalar(Math.PI/180), 'YXZ');
/*
if (is_T_pose) {
  obj_rot.fromArray(MMD_SA.THREEX.utils.convert_A_pose_rotation_to_T_pose(p_bone.name, obj_rot.toArray()));
}
else {
  obj_rot.fromArray(MMD_SA.THREEX.utils.convert_T_pose_rotation_to_A_pose(p_bone.name, obj_rot.toArray()));
}
*/
obj_rot.premultiply(rot_axis);

const obj_rot_euler = MMD_SA.TEMP_v3.setEulerFromQuaternion(obj_rot, 'YXZ').multiplyScalar(180/Math.PI);
p_bone.rotation.x = -obj_rot_euler.x;
p_bone.rotation.y = -obj_rot_euler.y;
p_bone.rotation.z =  obj_rot_euler.z;

p_bone.is_T_pose = is_T_pose;
  }

  async function parse_scene(json, scene_src) {
    async function locate_file(zip, obj, type) {
      if (!obj || !obj.path) return false;

      switch (obj.path.replace(/^.+[\/\\]/, '').replace(/\.js$/i, '')) {
        case 'scene_auto_fit':
          obj.path = System.Gadget.path + '\\js\\scene_auto_fit.js';
          return true;
      }

      if (!/\.([a-z0-9]{1,4})$/i.test(obj.path))
        obj.path += (MMD_SA.THREEX.enabled) ? '.glb' : '.zip';

      const filename = obj.path.replace(/^.+[\/\\]/, '');
      if (!zip) {
        if (!/^\w+\:/.test(obj.path))
          obj.path = scene_src.replace(/[^\/\\]+$/, '') + obj.path.replace(/^[\/\\]/, '');
        if (FSO_OBJ.FileExists(obj.path)) return true;
        show_status('❌"' + filename + '"');
        return false;
      }

      const obj_list = zip.file(new RegExp(toRegExp(filename), "i"));
      if (!obj_list.length) {
        show_status('"' + filename + '" not found');
        return false;
      }
      obj.path = zip_path + '#\\' + obj_list[0].name.replace(/\//g, '\\');
      await System._browser.update_obj_url(obj.path, type);
      return true;
    }

    async function parse_motion(motion_list) {
      if (!motion_list) return;

      let load_count = 0
      const _motion_list = [];
      for (const motion of motion_list) {
        const filename = motion.path.replace(/^.+[\/\\]/, "").replace(/\.([a-z0-9]{1,4})$/i, "");
        if (MMD_SA_options.motion_index_by_name[filename] || MMD_SA_options._XRA_pose_list[0].find(m=>m.name==filename) || await locate_file(zip, motion))
          _motion_list.push(motion);
      }

      const promise_list = [];
      _motion_list.forEach((motion)=>{
        let p;
        const filename = motion.path.replace(/^.+[\/\\]/, "").replace(/\.([a-z0-9]{1,4})$/i, "");

        if (motion.para) {
          if (!MMD_SA_options.motion_para[filename]?.motion_tracking?._default_)
            MMD_SA_options.motion_para[filename] = Object.assign(MMD_SA_options.motion_para[filename]||{}, motion.para);
//console.log(Object.assign({}, MMD_SA_options.motion_para[filename]))
        }

        const motion_index = MMD_SA_options._XRA_pose_list[0].findIndex(m=>m.name==filename);
        if (motion_index != -1) {
          p = Promise.resolve(true);//new Promise((resolve)=>{ System._browser.on_animation_update.add(resolve, 1,0); });
          if (motion.play_on_ready) {
            p.then(()=>{ MMD_SA_options.Dungeon_options.item_base.pose._change_motion_(motion_index, true); });
          }
          else {
            const index = MMD_SA_options.motion_index_by_name[filename];
            if (!MMD_SA.motion[index]) {
              const m = MMD_SA_options.motion[index];
              p = MMD_SA.load_external_motion(m.path, false);
            }
          }
        }
        else {
          if (MMD_SA_options.motion_index_by_name[filename]) {
            p = Promise.resolve(true);
          }
          else {
            p = MMD_SA.load_external_motion(motion.path, false);
          }

          if (motion.play_on_ready) {
            p.then(()=>{
MMD_SA_options._motion_shuffle_list_default = [MMD_SA_options.motion_index_by_name[filename]];
MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice();
MMD_SA._force_motion_shuffle = true;
            });
          }
        }
        promise_list.push(p);
      });
      return Promise.all(promise_list);
    }

    async function parse_event(ev, event_name) {
      if (!ev) return;

      const e = ev[event_name];
      if (!e) return;

      const module_list = e.module || [e];

      for (let i = 0; i < module_list.length; i++) {
        const m = module_list[i];
        if (await locate_file(zip, m, 'text/javascript')) {
          const filename = m.path.replace(/^.+[\/\\]/, '').replace(/\.js$/i, '');
          const module = await import(toFileProtocol(m.path));
          await module[event_name](event_para);
          show_status('✅Event: ' + event_name + '(' + filename + ')');
        }
      }

      if (e.motion) {
        await parse_motion(e.motion);

        if (!e.motion.find(m=>m.play_on_ready)) {
          MMD_SA_options._motion_shuffle_list_default = e.motion.map(motion=>MMD_SA_options.motion_index_by_name[motion.path.replace(/^.+[\/\\]/, "").replace(/\.([a-z0-9]{1,4})$/i, "")]);
          MMD_SA_options.motion_shuffle_list_default = MMD_SA_options._motion_shuffle_list_default.slice();
          MMD_SA._force_motion_shuffle = true;
        }
      }
    }

    async function check_loaded(count=0) {
      loaded_count += count;
      if (loaded_counting || (loaded_count < loaded_count_max)) return;

      await parse_event(json.XR_Animator_scene.on, 'load');

      show_status('✅Scene loaded (' + (loaded_count + '/' + loaded_count_max) + ')', 5);
      resolve_func();
    }

    if (!json.XR_Animator_scene) {
      show_status('No scene data found');
      return;
    }

    show_status('Loading scene...', 99);

    const zip_path = (/.zip$/i.test(scene_src)) ? scene_src : null;

    const zip = (zip_path) ? XMLHttpRequestZIP.zip_by_url(zip_path) : null;

    let loaded_count = 0;
    let loaded_count_max = 0;
    let loaded_counting = true;
    let resolve_func;
    const promise = new Promise((resolve)=>{ resolve_func=resolve; });

    const event_para = { json:json, zip:zip, zip_path:zip_path, locate_file:locate_file };

    await parse_event(json.XR_Animator_scene.on, 'init');

    const wallpaper = json.XR_Animator_scene.wallpaper;
    if (wallpaper) {
      const v_bg = document.getElementById("VdesktopBG");
      if (v_bg) {
        v_bg.pause();
        v_bg.style.visibility = 'hidden';
      }

      if (wallpaper.path) {
        if (await locate_file(zip, wallpaper))
          onDrop_change_wallpaper({ isFileSystem:true, path:wallpaper.path });
      }
      if (wallpaper.color) {
        document.body.style.backgroundColor = wallpaper.color;
        if (!wallpaper_src)
          LdesktopBG_host.style.display = "none";
      }

      show_status('✅Wallpaper');
      loaded_count++;
      loaded_count_max++;
    }

    const HDRI = MMD_SA.THREEX.enabled && json.XR_Animator_scene.HDRI;
    if (HDRI) {
      if (HDRI.path) {
        if (!await locate_file(zip, HDRI)) {
          HDRI.path = null;
          HDRI.index = 1;
        }
      }
      if (HDRI.path || HDRI.index) {
        loaded_count_max++;

        MMD_SA.THREEX.utils.HDRI.mode = HDRI.mode;
        MMD_SA.THREEX.scene.environmentIntensity = MMD_SA.THREEX.scene.backgroundIntensity = HDRI.intensity || 1;

// use await to make sure that HDRI is loaded before 3D objects
        await ((HDRI.path) ? MMD_SA.THREEX.utils.HDRI.load(HDRI.path, HDRI.use_background) : change_HDRI(HDRI.index, HDRI.use_background));
        show_status('✅HDRI');
        check_loaded(1);

        if (HDRI.rotation_speed) {
          dome_axis_angle = panorama.axis_angle;
          dome_rotation_speed = panorama.rotation_speed;
          System._browser.on_animation_update.remove(rotate_dome,1);
          System._browser.on_animation_update.add(rotate_dome,0,1,-1);
        }
        else if (HDRI.axis_angle) {
          const a = HDRI.axis_angle * Math.PI/180;
          MMD_SA.THREEX.scene.backgroundRotation.y = MMD_SA.THREEX.scene.environmentRotation.y = a;
        }
      }
    }

    const panorama = !HDRI?.mode && json.XR_Animator_scene.panorama;
    if (panorama) {
      if (panorama.path) {
        if (!await locate_file(zip, panorama))
          panorama.index = -1;
      }
      if (panorama.index >= 0) {
        loaded_count_max++;
        ((panorama.index == 0) ? onDrop_change_panorama({isFileSystem:true, path:panorama.path}) : change_panorama(panorama.index, panorama.path)).then(()=>{
          show_status('✅Panorama');
          check_loaded(1);
        });

        if (panorama.rotation_speed) {
          dome_axis_angle = panorama.axis_angle;
          dome_rotation_speed = panorama.rotation_speed;
          System._browser.on_animation_update.remove(rotate_dome,1);
          System._browser.on_animation_update.add(rotate_dome,0,1,-1);
        }
        else if (panorama.axis_angle) {
          const a = panorama.axis_angle * Math.PI/180;
          MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.quaternion.copy(MMD_SA.TEMP_q.set(0,Math.sin(a),0, Math.cos(a)));
          if (!MMD_SA.THREEX.enabled)
            MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.useQuaternion = true;
        }
      }
    }

    const motion_list = json.XR_Animator_scene.motion_list;
    if (motion_list) {
      scene_json_for_export.XR_Animator_scene.motion_list = motion_list;

      loaded_count_max++;
      await parse_motion(motion_list);
      show_status('✅Motion');
      check_loaded(1);
    }

    const object3D_list = json.XR_Animator_scene.object3D_list;
    if (object3D_list) {
      const is_T_pose = MMD_SA.THREEX.get_model(0).is_T_pose;
      for (const obj of object3D_list) {
        if (obj.type == 'object3D') {
          if (!await locate_file(zip, obj)) continue;

          const filename = obj.path.replace(/^.+[\/\\]/, '');
          if (typeof obj.model_para.parent_bone == 'number') obj.model_para.parent_bone = obj.model_para.parent_bone_list[obj.model_para.parent_bone];
          const pb_list = [obj.model_para.parent_bone, ...(obj.model_para.parent_bone_list||[])];
          pb_list.forEach(p_bone=>{
            if (p_bone && (p_bone.is_T_pose != null) && ((p_bone.is_T_pose) ? !is_T_pose : is_T_pose)) {
              adjust_parent_bone(p_bone, is_T_pose);
            }
          });

          if (!obj.id) obj.id = filename.replace(/\.([a-z0-9]{1,4})$/i, '');

          loaded_count_max++;
// need to use await (i.e. loading in order) to work with cloned objects
          await onDrop_add_object3D({ isFileSystem:true, path:obj.path, _obj_json:obj });

          obj._object3d_uuid = object3d_list[object3d_list.length-1].uuid;

          show_status('✅"' + filename + '"');
          check_loaded(1);
        }
      }
    }

    const settings = json.XR_Animator_scene.settings;
    if (settings) {
      explorer_ground_y = settings.explorer_mode?.ground_y || 0;
      if (explorer_mode)
        MMD_SA_options.Dungeon.para_by_grid_id[2].ground_y = explorer_ground_y;

      if (settings.camera) {
        if (settings.camera.fov) {
          MMD_SA._trackball_camera.object.fov = settings.camera.fov;
          MMD_SA._trackball_camera.object.updateProjectionMatrix();
        }
      }
    }

    loaded_counting = false;
    check_loaded().then(()=>{
if (MMD_SA.THREEX._XR_Animator_scene_) {
  if (!json.XR_Animator_scene.on) {
    json.XR_Animator_scene.on = MMD_SA.THREEX._XR_Animator_scene_.on;
  }
  else if (!json.XR_Animator_scene.on?.gesture) {
    if (MMD_SA.THREEX._XR_Animator_scene_.on?.gesture)
      json.XR_Animator_scene.on.gesture = MMD_SA.THREEX._XR_Animator_scene_.on.gesture;
  }
  else {
    json.XR_Animator_scene.on.gesture = Object.assign(json.XR_Animator_scene.on.gesture||{}, MMD_SA.THREEX._XR_Animator_scene_.on?.gesture);
  }

  if (!json.XR_Animator_scene.object3D_list) {
    json.XR_Animator_scene.object3D_list = MMD_SA.THREEX._XR_Animator_scene_.object3D_list;
  }
  else {
    json.XR_Animator_scene.object3D_list = [...(MMD_SA.THREEX._XR_Animator_scene_.object3D_list||[]), ...json.XR_Animator_scene.object3D_list];
  }

  if (!json.XR_Animator_scene.auto_fit_list) {
    json.XR_Animator_scene.auto_fit_list = MMD_SA.THREEX._XR_Animator_scene_.auto_fit_list;
  }
  else {
    json.XR_Animator_scene.auto_fit_list = [...(MMD_SA.THREEX._XR_Animator_scene_.auto_fit_list||[]), ...json.XR_Animator_scene.auto_fit_list];
  }

  if (!json.XR_Animator_scene.settings) {
    json.XR_Animator_scene.settings = MMD_SA.THREEX._XR_Animator_scene_.settings;
  }
}

if (json.XR_Animator_scene.on) {
  scene_json_for_export.XR_Animator_scene.on = json.XR_Animator_scene.on;
}
else {
  json.XR_Animator_scene.on = {};
}

if (json.XR_Animator_scene.auto_fit_list) {
  scene_json_for_export.XR_Animator_scene.auto_fit_list = json.XR_Animator_scene.auto_fit_list;
}

if (json.XR_Animator_scene.settings) {
  scene_json_for_export.XR_Animator_scene.settings = settings;
}

MMD_SA.THREEX._XR_Animator_scene_ = json.XR_Animator_scene;
    });

    return promise;
  }

  function show_status(msg, duration=msg_duration) {
    msg_log.push(msg.toString().substring(0,30));
    msg_duration = duration;
    if (msg_log.length > 8) {
      const ini = msg_log.length - 8;
      msg_log = msg_log.slice(ini, ini+8);
    }
    speech_bubble2(msg_log.join('\n'), msg_duration);
  };

  var msg_log = [];
  var msg_duration = 5;

  return async function (item) {
    MMD_SA_options.Dungeon.run_event({ ended:true });

    msg_log.length = 0;
    msg_duration = 0;

    var src = item.path;
    if (item.isFileSystem && /([^\/\\]+)\.zip$/i.test(src)) {
      let zip_file = SA_topmost_window.DragDrop._path_to_obj && SA_topmost_window.DragDrop._path_to_obj[src.replace(/^(.+)[\/\\]/, "")];

      const zip = await new self.JSZip().loadAsync(zip_file);

// will be called, even if content is corrupted

      XMLHttpRequestZIP.zip_by_url(src, zip);

      const scene_list = zip.file(/scene\.json$/i);
      if (!scene_list.length) {
        show_status('No scene data found');
      }
      else {
        const txt = await scene_list[0].async("text");
        const json = JSON.parse(txt);

        parse_scene(json, src);
      }
    }
    else if (item.isFileSystem && /([^\/\\]+)\.json$/i.test(src)) {
      if (!webkit_electron_mode) {
        speech_bubble2('NOTE: In browser mode, you need to drop the zip including all assets and "scene.json".', 5);
      }
      else {
        window.addEventListener('SA_dragdrop_JSON', (e)=>{
          const json = e.detail.json;
          if (json.XR_Animator_scene) {
            e.detail.result.return_value = true;
            parse_scene(json, src);
          }
        }, {once:true});

        _onDrop_finish.call(DragDrop, item);
      }
    }
    else {
      _onDrop_finish.call(DragDrop, item)
    }

    reset_scene_UI();
  };
})();

function export_scene_JSON() {
  const scene_json = {};

  const object3D_list_json = scene_json.object3D_list = [];
  object3d_list.forEach(obj=>{
    const mesh = obj._obj;
    const ds = obj.user_data._default_state_;

    const obj_json = { type:'object3D', path:obj.user_data.path.replace(/(\.zip)\#[^\#]+$/i, '$1') }
    const model_para = obj_json.model_para = {};
    if (obj.VMC_tracker_index != null)
      model_para.VMC_tracker_index = obj.VMC_tracker_index;
    const placement = model_para.placement = (obj.placement?.scale_offset) ? { scale:obj.placement.scale, scale_offset:obj.placement.scale_offset } : { scale:mesh.scale.x };

    if (obj.parent_bone) {
      if (!obj.parent_bone_list) obj.parent_bone_list = [];
      obj.parent_bone_list[0] = obj.parent_bone;

      const parent_bone_list = [];
      obj.parent_bone_list.forEach(parent_bone=>{
        const pb = { model_index:0, is_T_pose:MMD_SA.THREEX.get_model(0).is_T_pose, name:parent_bone.name, position:parent_bone.position, rotation:parent_bone.rotation };
        if (parent_bone.disabled)
          pb.disabled = true;
        parent_bone_list.push(pb);
      });

      model_para.parent_bone = parent_bone_list[0];
      if (parent_bone_list.length > 1)
        model_para.parent_bone_list = parent_bone_list;
    }
    else {
      const c_pos = MMD_SA.THREEX._THREE.MMD.getModels()[0].mesh.position;
      const pos = v3a.copy(mesh.position).sub(c_pos);
      placement.position = { x:pos.x, y:pos.y, z:pos.z };

      const rot = e1.copy(obj.user_data._rotation_).multiplyScalar(180/Math.PI);
      placement.rotation = { x:Math.round(rot.x), y:Math.round(rot.y), z:Math.round(rot.z) };
    }

    object3D_list_json.push(obj_json);
  });

  if (wallpaper_src) {
    scene_json.wallpaper = { path:wallpaper_src, color:document.body.style.backgroundColor };
  }
  else if (LdesktopBG_host.style.display == 'none') {
    scene_json.wallpaper = { color:document.body.style.backgroundColor };
  }

  if (panorama_index != null) {
    scene_json.panorama = {
      index: panorama_index,
      axis_angle: dome_axis_angle,
      rotation_speed: dome_rotation_speed,
    };
    if (panorama_index == 0)
      scene_json.panorama.path = panorama_src;
  }

  const HDRI_path = MMD_SA.THREEX.utils.HDRI.path;
  if (HDRI_path) {
    let HDRI_filename = HDRI_path.replace(/^.+[\/\\]/, '');
    let HDRI_index = ((HDRI_path != HDRI_filename) && (HDRI_list.indexOf(HDRI_filename)+1)) || null;
    scene_json.HDRI = {
      index: HDRI_index,
      use_background: !!MMD_SA.THREEX.scene.background,
      mode: MMD_SA.THREEX.utils.HDRI.mode,
      intensity: MMD_SA.THREEX.scene.environmentIntensity,
      axis_angle: dome_axis_angle,
      rotation_speed: dome_rotation_speed,
    };
    if (!HDRI_index)
      scene_json.HDRI.path = MMD_SA.THREEX.utils.HDRI.path;
  }

  scene_json.settings = Object.assign({}, scene_json_for_export.XR_Animator_scene.settings||{});
  scene_json.settings.explorer_mode = {
    ground_y: explorer_ground_y,
  };
  delete scene_json_for_export.XR_Animator_scene.settings;

  Object.assign(scene_json, scene_json_for_export.XR_Animator_scene);

  System._browser.save_file('scene.json', JSON.stringify({ XR_Animator_scene:scene_json }, null, '\t'), 'application/json');
}

var v3a, v3b;
var e1, e2;
var q1, q2;
window.addEventListener('jThree_ready', ()=>{
  const THREE = MMD_SA.THREEX.THREE;
  v3a = new THREE.Vector3();
  v3b = new THREE.Vector3();
  e1 = new THREE.Euler();
  e2 = new THREE.Euler();
  q1 = new THREE.Quaternion();
  q2 = new THREE.Quaternion();

  MMD_SA.THREEX.utils.camera_auto_targeting({
    id:'face',
// use .condition instead of .enabled to save some headaches when .camera_face_locking can change at any time
//    enabled: MMD_SA_options.camera_face_locking,
    condition: ()=>{
return MMD_SA_options.camera_face_locking || ((MMD_SA_options.camera_face_locking !== false) && !explorer_mode && !MMD_SA_options.Dungeon_options.item_base.hand_camera._hand_camera_active && MMD_SA_options.Dungeon.started && (MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.visible || (MMD_SA.THREEX.enabled && MMD_SA.THREEX.scene.background) || object3d_list.some(obj=>!obj.parent_bone)) && !MMD_SA.THREEX._THREE.MMD.getCameraMotion().length);
    },
  });
});


function ML_off() {
  MMD_SA.WebXR.user_camera.facemesh.enabled = false;
  MMD_SA.WebXR.user_camera.poseNet.enabled = false;
  MMD_SA.WebXR.user_camera.handpose.enabled = false;
}

function mirror_3D_off() {
  if (MMD_SA_options.user_camera.mirror_3D) {
    System._browser.camera.hide()
    MMD_SA_options.user_camera.mirror_3D = 0
    System._browser.camera.show()
  }
}

var bg_state_default, bg_color_default, bg_wallpaper_default, webcam_as_bg_default;
var _onDrop_finish;

window.addEventListener('jThree_ready', (e)=>{
  bg_state_default = LdesktopBG_host.style.display;
  bg_color_default = document.body.style.backgroundColor;
  bg_wallpaper_default = LdesktopBG.style.backgroundImage;
  webcam_as_bg_default = !!MMD_SA_options.user_camera.display.webcam_as_bg;

  _onDrop_finish = DragDrop._ondrop_finish;
});

var explorer_ground_y = 0;

function reset_scene_explorer(enforced) {
  if (explorer_mode && !enforced) return;

  explorer_mode = false;
  MMD_SA_options.user_camera.ML_models.look_at_screen = null;

  MMD_SA_options.Dungeon._states.action_allowed_in_event_mode = false;
  MMD_SA_options.Dungeon_options.character_movement_disabled = true;

  if (MMD_SA_options.Dungeon_options.camera_position_z_sign != 1) {
    MMD_SA_options.Dungeon_options.camera_position_z_sign = 1;
    MMD_SA_options.Dungeon.update_camera_position_base();

    const c = MMD_SA_options.Dungeon.character;
    if (c.about_turn) {
      c.about_turn = false;
      c.rot.y += Math.PI;
    }
    c.pos_update();
  }

  MMD_SA_options.Dungeon.para_by_grid_id[2].ground_y = THREE.MMD.getModels()[0].mesh.position.y;//.ground_y_visible

  object3d_list.forEach(object3d=>{
    object3d.no_collision = true;
  });
}

var outline_para = {
  thickness: 0.01,
  color: [ 1, 1, 1 ],
  alpha: 0.8,
  visible: true,
};

function highlight_object(obj) {
  if (!MMD_SA.THREEX.enabled) return;

  MMD_SA.THREEX.use_OutlineEffect = true;

  clear_highlight();

  if (obj.user_data.highlighted) return;
  obj.user_data.highlighted = true;

  obj._obj.traverseVisible(obj=>{
    if (obj.isMesh) {
      obj.userData.outlineParameters = { visible:true };
      if (Array.isArray(obj.material)) {
        obj.material.forEach(m=>{
          m.userData.outlineParameters = outline_para;
        });
      }
      else {
        obj.material.userData.outlineParameters = outline_para;
      }
    }
  });
}

function clear_highlight() {
  if (!MMD_SA.THREEX.enabled) return;

  object3d_list.forEach(obj=>{
    if (!obj.user_data.highlighted) return;
    obj.user_data.highlighted = false;

    obj._obj.traverseVisible(obj=>{
      if (obj.isMesh && obj.userData.outlineParameters)
        obj.userData.outlineParameters.visible = false;
    });
  });
}

function reset_scene_UI() {
  reset_scene_explorer();

  clear_highlight();
  MMD_SA.THREEX.use_OutlineEffect = false;

  DragDrop.onDrop_finish = _onDrop_finish;
  for (const json_func of [onDrop_JSON_change_facemesh_calibration])
    window.removeEventListener('SA_dragdrop_JSON', json_func);
  window.removeEventListener('SA_keydown', adjust_object3D);

  System._browser.camera._info = '';
  Ldebug.style.transformOrigin = Ldebug.style.transform = '';
  DEBUG_show();
  if (grid_plane) {
    grid_plane.visible = false;
    grid_plane.children.forEach(c=>c.visible=false);
  }
}

var _overlay_mode = -1;

var bg_branch = 5;
var done_branch = bg_branch + 6;//11
var panorama_branch = done_branch + 1;//12
var object3D_branch = panorama_branch + 6;//18
var about_branch = object3D_branch + 3;//21
var export_motion_branch = about_branch + 1;//22
var other_options_branch = export_motion_branch + 1;//23
var record_motion_branch = export_motion_branch + 3;//25
var mocap_options_branch = MMD_SA_options._mocap_options_branch_ = record_motion_branch + 4;//29
var facemesh_options_branch = mocap_options_branch + 5;//34
var motion_control_branch = facemesh_options_branch + 6;//40

return [
//0
      [
        {
          _show_other_options_: false,

          message: {
  get content() { this._motion_for_export_ = /\.(bvh|fbx)$/i.test(MMD_SA.vmd_by_filename[MMD_SA.MMD.motionManager.filename].url) || System._browser.camera.motion_recorder.vmd; return (!MMD_SA_options.Dungeon.events["_FACEMESH_OPTIONS_"][0]._show_other_options_ && System._browser.camera.ML_enabled) ? ((this._motion_for_export_) ? ['export_motion_to_file','record_motion','mocap_options','mocap_off'].map((node,i)=>(i+1) + '. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.'+node)).join('\n') + '\n5. ' + System._browser.translation.get('Misc.cancel') : ['record_motion','mocap_options','mocap_off'].map((node,i)=>(i+1) + '. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.'+node)).join('\n') + '\n4. ' + System._browser.translation.get('Misc.cancel') /*\n4. Enable motion control\n5. Other options*/ ) : ['UI_and_overlays','scene','visual_effects','miscellaneous_options','export_motion_to_file','about_XR_Animator'].map((node,i)=>(i+1) + '. ' + System._browser.translation.get('XR_Animator.UI.UI_options.'+node)).join('\n') + '\n7. ' + System._browser.translation.get('Misc.cancel'); }//'1. UI and overlays\n2. BG/Scene/3D\n3. Visual effects\n4. Miscellaneous options\n5. Export motion to file\n6. About XR Animator\n7. Cancel'; }
 ,bubble_index: 3
 ,get branch_list() {
return (!MMD_SA_options.Dungeon.events["_FACEMESH_OPTIONS_"][0]._show_other_options_ && System._browser.camera.ML_enabled) ? ((this._motion_for_export_) ? [
  { key:1, branch_index:export_motion_branch },
  { key:2, branch_index:record_motion_branch },
  { key:3, branch_index:mocap_options_branch },
  { key:4, branch_index:2 },
//  { key:5, event_id:{ func:()=>{MMD_SA_options.Dungeon.events["_FACEMESH_OPTIONS_"][0]._show_other_options_=true;setTimeout(()=>{MMD_SA_options.Dungeon.events["_FACEMESH_OPTIONS_"][0]._show_other_options_=false},0);}, goto_event: { id:"_FACEMESH_OPTIONS_", branch_index:0 } } },
  { key:5, is_closing_event:true }
] : [
  { key:1, branch_index:record_motion_branch },
  { key:2, branch_index:mocap_options_branch },
  { key:3, branch_index:2 },
//  { key:4, branch_index:motion_control_branch },
//  { key:5, event_id:{ func:()=>{MMD_SA_options.Dungeon.events["_FACEMESH_OPTIONS_"][0]._show_other_options_=true;setTimeout(()=>{MMD_SA_options.Dungeon.events["_FACEMESH_OPTIONS_"][0]._show_other_options_=false},0);}, goto_event: { id:"_FACEMESH_OPTIONS_", branch_index:0 } } },
  { key:4, is_closing_event:true }
]) : [
  { key:1, branch_index:1 },
  { key:2, branch_index:3,
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.scene.tooltip')
);
    }
  },
  { key:3, event_id:{
      func:()=>{
        if (MMD_SA.THREEX.enabled) {
          if (MMD_SA.THREEX.PPE.initialized) {
            MMD_SA.THREEX.GUI.obj.visual_effects.show();
          }
          else {
            MMD_SA.SpeechBubble.list[1].message(3, 'Initializing visual effects plugins...', 1000);
            MMD_SA.THREEX.PPE.init().then(()=>{
              MMD_SA.THREEX.GUI.obj.visual_effects.show();
            });
          }
        }
        else {
          MMD_SA.THREEX.GUI.obj.visual_effects.show();
        }
        return true;
      }
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.visual_effects.tooltip')
);
    }
  },
  { key:4, branch_index:other_options_branch },
  { key:5, branch_index:export_motion_branch,
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.export_motion_to_file.tooltip')
);
    }
  },
  { key:6, branch_index:about_branch },
  { key:7, is_closing_event:true }
];
  }
          }
        }
      ]

     ,[
        {
          goto_event: { id:"_SETTINGS_", branch_index:11 }
        }
      ]

     ,[
        {
          func: function () {
ML_off()
          }
         ,ended: true
        }
      ]

     ,[
        {
          func: function () {
DragDrop.onDrop_finish = onDrop_scene_JSON;

window.removeEventListener('SA_MMD_before_render', animate_object3D);
window.addEventListener('SA_MMD_before_render', animate_object3D);
          }
         ,message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.message').replace(/\<zipped\>/, (webkit_electron_mode) ? '' : System._browser.translation.get('XR_Animator.UI.UI_options.scene.message.zipped')); }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, branch_index:bg_branch }
   ,{ key:2, branch_index:panorama_branch }
   ,{ key:3, branch_index:object3D_branch }
   ,{ key:4, event_id:{
        func:()=>{ export_scene_JSON(); }
       ,goto_event: { id:"_FACEMESH_OPTIONS_", branch_index:done_branch }
      },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.scene.export_scene_to_file')
);
      }
    }
   ,{ key:5, branch_index:4 }//keep_dialogue_branch_list:true, 
   ,{ key:6, is_closing_event:true }
  ]
          }
        }
      ]

     ,[
        {
          message: {
//  index: 1,
//  para: { scale:0.75 },
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.reset_scene_to_default'); },
  para: { no_word_break:true },
  branch_list: [
//    { key:8, event_index:1 },
//    { key:9, event_id:{ sb_index:1, ended:true } },
    { key:1, event_index:1 },
    { key:2, is_closing_event:true, event_index:999 },
  ]
          }
        },
        {
          func: function () {
const v_bg = document.getElementById("VdesktopBG");
if (v_bg) {
  v_bg.pause();
  v_bg.style.visibility = 'hidden';
}

LdesktopBG_host.style.display = bg_state_default;
document.body.style.backgroundColor = bg_color_default;
LdesktopBG.style.backgroundImage = bg_wallpaper_default;
MMD_SA_options.user_camera.display.webcam_as_bg = webcam_as_bg_default;

remove_skybox();
remove_HDRI();

remove_object3D();

scene_json_for_export.XR_Animator_scene = {};

System._browser.camera.display_floating = false

window.dispatchEvent(new CustomEvent("SA_XR_Animator_scene_onunload"));
          }
         ,goto_event: { id:"_FACEMESH_OPTIONS_", branch_index:done_branch }
        }
      ]
//5
     ,[
        {
          func: function () {
DragDrop.onDrop_finish = onDrop_change_wallpaper;
          }
         ,message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.background'); }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, branch_index:bg_branch+1 }
   ,{ key:2, branch_index:bg_branch+2 }
   ,{ key:3, branch_index:bg_branch+3 }
   ,{ key:4, branch_index:bg_branch+4 }
   ,{ key:5, branch_index:bg_branch+5 }
   ,{ key:6, is_closing_event:true, branch_index:bg_branch+6 }
  ]
          }
        }
      ]

     ,[
        {
          func: function () {
const v_bg = document.getElementById("VdesktopBG");
if (v_bg) {
  v_bg.pause();
  v_bg.style.visibility = 'hidden';
}

LdesktopBG_host.style.display = bg_state_default
document.body.style.backgroundColor = bg_color_default
LdesktopBG.style.backgroundImage = bg_wallpaper_default
MMD_SA_options.user_camera.display.webcam_as_bg = webcam_as_bg_default
          }
         ,goto_branch: bg_branch
        }
      ]

     ,[
        {
          func: function () {
const v_bg = document.getElementById("VdesktopBG");
if (v_bg) {
  v_bg.pause();
  v_bg.style.visibility = 'hidden';
}

LdesktopBG_host.style.display = "none"
document.body.style.backgroundColor = "#000000"
          }
         ,goto_branch: bg_branch
        }
      ]

     ,[
        {
          func: function () {
const v_bg = document.getElementById("VdesktopBG");
if (v_bg) {
  v_bg.pause();
  v_bg.style.visibility = 'hidden';
}

LdesktopBG_host.style.display = "none"
document.body.style.backgroundColor = "#FFFFFF"
          }
         ,goto_branch: bg_branch
        }
      ]

     ,[
        {
          func: function () {
const v_bg = document.getElementById("VdesktopBG");
if (v_bg) {
  v_bg.pause();
  v_bg.style.visibility = 'hidden';
}

LdesktopBG_host.style.display = "none"
document.body.style.backgroundColor = "#00FF00"
          }
         ,goto_branch: bg_branch
        }
      ]
// 10
     ,[
        {
          func: function () {
const v_bg = document.getElementById("VdesktopBG");
if (v_bg) {
  v_bg.pause();
  v_bg.style.visibility = 'hidden';
}

MMD_SA_options.user_camera.display.webcam_as_bg = true
DEBUG_show('(Use webcam as BG)', 2)
          }
         ,goto_branch: bg_branch
        }
      ]

     ,[
        {
          func: function () {
reset_scene_UI();
          }
         ,ended: true
        }
      ]

     ,(()=>{
        let skybox_option_active = 'rotation_axis_angle';
        let skybox_options = ['rotation_speed', 'rotation_axis_angle'];

        return [
          {
            func: function () {
DragDrop.onDrop_finish = onDrop_change_panorama;
            }
           ,message: {
  get content() {
return System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox').replace('<rotation_speed>', ((dome_rotation_speed)?'x'+dome_rotation_speed:0) + ((skybox_option_active == 'rotation_speed')?'⬅️➡️':'')).replace('<rotation_axis_angle>', dome_axis_angle + '°' + ((skybox_option_active == 'rotation_axis_angle')?'⬅️➡️':''));
  }
 ,bubble_index: 3
 ,para: { row_max:11 }
 ,branch_list: [
  { key:'any', func:(e)=>{
let step;

if (/Arrow(Up|Down)/.test(e.code)) {
  let index = skybox_options.findIndex(v=>v==skybox_option_active);
  index -= (e.code == 'ArrowUp') ? 1 : -1;
  if (index < 0) {
    index = skybox_options.length-1;
  }
  else if (index > skybox_options.length-1) {
    index = 0;
  }
  skybox_option_active = skybox_options[index];
}
else if (/Arrow(Left|Right)/.test(e.code)) {
  if (skybox_option_active == 'rotation_speed') {
    const v = (e.code == 'ArrowRight') ? 1 : -1;
    let speed_ini = dome_rotation_speed;
    dome_rotation_speed = THREE.Math.clamp(dome_rotation_speed+v, 0,16);
    if (!speed_ini) {
      if (dome_rotation_speed) {
        System._browser.on_animation_update.remove(rotate_dome,1);
        System._browser.on_animation_update.add(rotate_dome,0,1,-1);
      }
    }
    else {
      if (!dome_rotation_speed)
        System._browser.on_animation_update.remove(rotate_dome,1);
    }
  }
  else if (skybox_option_active == 'rotation_axis_angle') {
    const v = (e.code == 'ArrowRight') ? 5 : -5;
    dome_axis_angle = THREE.Math.clamp(dome_axis_angle+v, 0,360);
    if (!dome_rotation_speed) {
      const a = dome_axis_angle * Math.PI/180;
      MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.quaternion.copy(MMD_SA.TEMP_q.set(0,Math.sin(a),0, Math.cos(a)));
      if (!MMD_SA.THREEX.enabled) {
        MMD_SA_options.mesh_obj_by_id["DomeMESH"]._obj.useQuaternion = true;
      }
      else {
        MMD_SA.THREEX.scene.backgroundRotation.y = MMD_SA.THREEX.scene.environmentRotation.y = a;
      }
    }
  }
}
else if (MMD_SA.THREEX.enabled && ((e.key == '+') || (e.key == '-'))) {
  const v = (e.key == '+') ? 0.01 : -0.01;
  MMD_SA.THREEX.scene.environmentIntensity = MMD_SA.THREEX.scene.backgroundIntensity = THREE.Math.clamp(MMD_SA.THREEX.scene.environmentIntensity+v, 0,1);
}
else {
  return false;
}

MMD_SA_options.Dungeon.run_event(null, panorama_branch, 0);

return true;
  } }
   ,{ key:1, event_id: {
        func: function () {
          remove_skybox();
          remove_HDRI();
        },
        goto_branch: panorama_branch
      }
    }
   ,{ key:2, branch_index:panorama_branch+1 }
   ,{ key:3, branch_index:panorama_branch+2 }
   ,{ key:4, branch_index:panorama_branch+3 }
   ,{ key:5, event_id: {
        func: function () { skybox_option_active = 'rotation_speed'; },
        goto_branch: panorama_branch
      },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.rotation_speed') + ((skybox_option_active=='rotation_speed')?' (' + System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.press_to_change_value') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.rotation_speed.tooltip')
);
      }
    }
   ,{ key:6, event_id: {
        func: function () { skybox_option_active = 'rotation_axis_angle'; },
        goto_branch: panorama_branch
      },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.rotation_axis_angle') + ((skybox_option_active=='rotation_axis_angle')?' (' + System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.press_to_change_value') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.rotation_axis_angle.tooltip')
);
      }
    }
/*
   ,{ key:7, event_id:{ func:()=>{
var url = 'https://skybox.blockadelabs.com/';
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
      }, goto_branch:done_branch }
    }
*/
   ,{ key:'X', is_closing_event:true, branch_index:done_branch }
  ]
            },
            next_step: {}
          },
          {
            func: function () {
if (MMD_SA.THREEX.enabled) MMD_SA_options.Dungeon.run_event();
            }
          },
          {
            func: function () {}
           ,message: {
  get content() {
return System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.HDRI').replace(/\<HDRI_mode\>/, System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.HDRI.mode.' + MMD_SA.THREEX.utils.HDRI.mode)).replace(/\<HDRI_light_intensity\>/, Math.round(MMD_SA.THREEX.scene.environmentIntensity*100));
  },
  index: 1,
  bubble_index: 3,
  para: { row_max:11 },
  branch_list: [
    { key:'A', event_id: {
        func: function () { change_HDRI(1); },
        goto_branch: panorama_branch
      }
    },
    { key:'B', event_id: {
        func: function () { change_HDRI(2); },
        goto_branch: panorama_branch
      }
    },
    { key:'C', event_id: {
        func: function () { change_HDRI(3); },
        goto_branch: panorama_branch
      }
    },
    { key:'D', event_id: {
        func: function () { change_HDRI(4); },
        goto_branch: panorama_branch
      }
    },
    { key:'E', event_id: {
        func: function () { change_HDRI(5); },
        goto_branch: panorama_branch
      }
    },
    { key:'F', event_id: {
        func: function () {
if (++MMD_SA.THREEX.utils.HDRI.mode > 2)
  MMD_SA.THREEX.utils.HDRI.mode = 0;

if (MMD_SA.THREEX.utils.HDRI.mode == 2) {
  const HDRI_path = MMD_SA.THREEX.utils.HDRI.path;
  if (MMD_SA.THREEX.utils.HDRI.path) {
    let HDRI_filename = HDRI_path.replace(/^.+[\/\\]/, '');
    let HDRI_index = ((HDRI_path != HDRI_filename) && (HDRI_list.indexOf(HDRI_filename)+1)) || null;
    if (HDRI_index)
      change_HDRI(HDRI_index);
  }
}
        },
        goto_branch: panorama_branch
      },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.HDRI.mode.tooltip')
);
      }
    },
    { key:'G', event_id: {
        func: function () {},
        goto_branch: panorama_branch
      },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.scene.skybox.HDRI.light_intensity.tooltip')
);
      }
    },
    { key:'H', event_id:{ func:()=>{
var url = 'https://polyhaven.com/hdris';
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
        },
        goto_branch: panorama_branch
      }
    }
  ],
            }
          },
        ];
      })()

     ,[
        {
          func: function () {
change_panorama(1);
          }
         ,goto_branch: panorama_branch
        }
      ]

     ,[
        {
          func: function () {
change_panorama(2);
          }
         ,goto_branch: panorama_branch
        }
      ]
// 15
     ,[
        {
          func: function () {
change_panorama(3);
          }
         ,goto_branch: panorama_branch
        }
      ]
// 16
     ,[]
// 17
     ,[]
// 18
     ,[
        {
          func: function () {
MMD_SA_options.Dungeon._3D_scene_builder_mode_ = true;

if (_overlay_mode > -1)
  System._browser.overlay_mode = _overlay_mode;
_overlay_mode = -1;

DragDrop.onDrop_finish = onDrop_add_object3D;

add_grid();

Ldebug.style.transformOrigin = "0 0";
Ldebug.style.transform = "scale(1.5,1.5)";

window.removeEventListener('SA_keydown', adjust_object3D);
window.addEventListener('SA_keydown', adjust_object3D);
          }
         ,message: {
  get content() {
return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder').replace(/\<extra_model\>/, System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.' + ((MMD_SA.THREEX.enabled)?'THREEX':'MMD'))).replace(/\<explorer_mode\>/, (explorer_mode)?'ON':'OFF');
// return 'Drop a ' + ((MMD_SA.THREEX.enabled) ? 'GLB model, ' : 'zipped PMX model, ') + 'zipped .X model or image/video file as 3D object. Info about the active object is on the top left corner. Use keyboard for controls.\n1. Show keyboard controls\n2. Hide UI\n3. Export 3D scene JSON\n4. Explorer mode: ' + ((explorer_mode)?'ON':'OFF') + '\n5. Done';
  }
 ,para: { row_max:10 }
 ,bubble_index: 3
 ,get branch_list() { return [
    { key:1, event_id:[[
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.keyboard_controls.1'); }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, event_index:1 }
  ]
          }
        },
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.keyboard_controls.2').replace(/\<\explorer_mode>/, System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.keyboard_controls.2.' + ((explorer_mode)?'next':'back'))); }
 ,bubble_index: 3
 ,get branch_list() { return (explorer_mode) ? [
    { key:1, event_index:2 },
  ] : [
    { key:1, event_id:'_FACEMESH_OPTIONS_', branch_index:object3D_branch }
  ]; },
          }
        },
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.keyboard_controls.3'); }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, event_id:'_FACEMESH_OPTIONS_', branch_index:object3D_branch }
  ]
          }
        },
      ]]
    },
    { key:2, branch_index:object3D_branch+1 },
    { key:3, event_id:{
        func:()=>{ export_scene_JSON(); }
       ,goto_event: { id:"_FACEMESH_OPTIONS_", branch_index:object3D_branch }
      }
    },
    { key:4, branch_index:object3D_branch+2,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.explorer_mode.tooltip')
);
      }
    },
    { key:5, is_closing_event:true, func:()=>{MMD_SA_options.Dungeon._3D_scene_builder_mode_ = false}, branch_index:done_branch }
  ]; }
//  ].concat((explorer_mode) ? [] : [{ key:5, branch_index:done_branch }]); }
          }
        }
      ]
// 19
     ,[
        {
          func: function () {
if (0&& System._browser.overlay_mode == 0) {
  _overlay_mode = 0;
  System._browser.overlay_mode = 1;
}

DEBUG_show();
DEBUG_show((object3d_list.length) ? (object3d_index+1) + ': ' + object3d_list[object3d_index].user_data.id : '(Drag and drop a 3D object file to begin.)');
          }
         ,message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.restore_UI'); }
 ,duration: 3
 ,bubble_index: 3
 ,branch_list: [
    { key:[1,'Esc'], branch_index:object3D_branch }
  ]
          }
        }
      ]

// 20
     ,[
        {
          func: ()=>{
if (explorer_mode) {
  reset_scene_explorer(true);

  MMD_SA.reset_camera(true);

  MMD_SA_options.Dungeon.run_event("_FACEMESH_OPTIONS_", object3D_branch, 0);
  return;
}

if (!MMD_SA.OSC.VMC.sender_enabled) {
  if (!object3d_cache.size) {
    speech_bubble2(System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.explorer_mode.no_object'), 5, { no_word_break:true });
    MMD_SA_options.Dungeon.run_event("_FACEMESH_OPTIONS_", object3D_branch, 0);
    return;
  }

  let obj_count = 0;
  for (const value of object3d_cache.values()) {
    if (!value) {
      speech_bubble2(System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.explorer_mode.still_loading'), 5);
      MMD_SA_options.Dungeon.run_event("_FACEMESH_OPTIONS_", object3D_branch, 0);
      return;
    }
    if (!value.parent_bone) obj_count++;
  }

  if (!obj_count) {
    speech_bubble2(System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.explorer_mode.no_explorable_object'), 5);
    MMD_SA_options.Dungeon.run_event("_FACEMESH_OPTIONS_", object3D_branch, 0);
    return;
  }
}

MMD_SA_options.Dungeon.run_event();
          }
        },
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.explorer_mode.confirm'); }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, event_index:2 },
    { key:[2,'Esc'], branch_index:object3D_branch }
  ]
          }
        },
        {
          func: function () {
reset_scene_UI();

explorer_mode = true;
MMD_SA_options.user_camera.ML_models.look_at_screen = false;

use_avatar_as_center = true;

System._browser.on_animation_update.add(()=>{MMD_SA_options.Dungeon.run_event()},2*30,1);
          },
          next_step:{}
        },
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.scene.3D_scene_builder.explorer_mode.starting'); }
 ,bubble_index: 3
 ,branch_list: [
    { key:[1,'Esc'], event_index:3 },
  ]
          }
        },
        {
          func: function () {
object3d_list.forEach(object3d=>{
  build_octree(object3d);
});

window.addEventListener('SA_keydown', adjust_object3D);

MMD_SA_options.Dungeon._states.action_allowed_in_event_mode = true;
MMD_SA_options.Dungeon_options.character_movement_disabled = false;

MMD_SA_options.Dungeon_options.camera_position_z_sign = -1;
MMD_SA_options.Dungeon.update_camera_position_base();

const motion_list_index = (System._browser.camera.poseNet.enabled) ? 2 : 1;
if (MMD_SA.MMD.motionManager.para_SA._speed) {
  MMD_SA_options.Dungeon_options.item_base.pose._change_motion_(MMD_SA_options._XRA_pose_list[motion_list_index].findIndex(p=>p.name == MMD_SA.MMD.motionManager.filename), true);
}
MMD_SA_options.Dungeon_options.item_base.pose._change_motion_(MMD_SA_options._XRA_pose_list[motion_list_index].findIndex(p=>p.name == 'tsuna_standby'), true);

MMD_SA_options.Dungeon.para_by_grid_id[2].ground_y = explorer_ground_y;
          }
         ,goto_event: { id:"_FACEMESH_OPTIONS_", branch_index:object3D_branch }
        },
      ]

// 21
     ,[
        {
          message: {
  get content() { return 'XR Animator (v0.23.1)\n' + System._browser.translation.get('XR_Animator.UI.UI_options.about_XR_Animator.message'); }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, event_id: {
        func: function () {
var url = 'https://youtube.com/playlist?list=PLLpwhHMvOCSt3i7NQcyJq1fFhoMiSmm5H'
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
        }
       ,ended: true
      }
    }
   ,{ key:2, event_id: {
        func: function () {
var url = self._readme_url_ || 'https://github.com/ButzYung/SystemAnimatorOnline#readme'; //System.Gadget.path + '/readme.txt'
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
        }
       ,ended: true
      }
    }
   ,{ key:3, event_id: {
        func:()=>{
var url = 'https://github.com/ButzYung/SystemAnimatorOnline/releases'
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
        }
       ,ended: true
      }
    }
   ,{ key:4, event_id: {
        func:()=>{
var url = 'https://ko-fi.com/butzyung/shop'
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
        }
       ,ended: true
      }
    }
   ,{ key:5, event_index:1 }
   ,{ key:6, event_id: {
        func:()=>{
var url = 'https://github.com/ButzYung/SystemAnimatorOnline#contacts'
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
        }
       ,ended: true
      }
    }
   ,{ key:7, is_closing_event:true, event_index:99 }
  ]
          }
        },
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.about_XR_Animator.support') + ((0&&webkit_electron_mode) ? '\n3. 🟡Bitcoin\n4. Cancel' : '\n3. ' + System._browser.translation.get('Misc.cancel')); }
 ,bubble_index: 3
 ,get branch_list() { return [
    { key:1, event_id: {
        func:()=>{
var url = (System._browser.translation.language == 'ja') ? 'https://xra.fanbox.cc/' : 'https://ko-fi.com/butzyung';
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
        }
       ,ended: true
      }
    },
    { key:2, event_id: {
        func:()=>{
var url = 'https://www.paypal.me/AnimeThemeGadgets'
if (webkit_electron_mode)
  webkit_electron_remote.shell.openExternal(url)
else
  window.open(url)
        }
       ,ended: true
      }
    }
  ].concat((0&&webkit_electron_mode) ? [
    { key:3, event_id: {
        func:()=>{
navigator.clipboard.writeText('1KkHVxgn4tusMhXNt1qFqSpiCiDRcqUh8p').then(()=>{
  speech_bubble2('The following BTC address has been copied to the clipboard. Thanks in advance for any amount you will be sending!🙏\n・1KkHVxgn4tusMhXNt1qFqSpiCiDRcqUh8p', 10, { scale:1, no_word_break:true });
});
        }
       ,ended: true
      }
    },
    { key:4, is_closing_event:true }
  ] : [
    { key:3, is_closing_event:true }
  ]); }
          },
          next_step: {}
        },
        {
          message: {
get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.about_XR_Animator.support.sponsor').replace(/\<list\>/, System._browser.translation.get('XR_Animator.UI.UI_options.about_XR_Animator.support.sponsor.list')); },
bubble_index: 3,
index: 1,
bubble_index: 3,
          }
        }
      ]
// 22
     ,[
        {
          func: function () {
if (/\.(bvh|fbx)$/i.test(MMD_SA.vmd_by_filename[MMD_SA.MMD.motionManager.filename].url) || System._browser.camera.motion_recorder.vmd) return true;
          }
         ,message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.export_motion_to_file.no_motion'); },
  duration: 5,
  delay: 0.1
          }
         ,ended: true
        },
        {
          func: function () {
          }
         ,message: {
  get content() {
return System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.export_motion_to_file.choose_format') + '\n1. VMD' + ((MMD_SA.THREEX.enabled) ? '\n2. glTF\n3. BVH' : '') + '\nX. ' + System._browser.translation.get('Misc.cancel');
  } 
 ,bubble_index: 3
 ,get branch_list() {
return [
  { key:1, event_index:2 },
  ...((MMD_SA.THREEX.enabled) ? [{ key:2, event_index:3 },{ key:3, event_index:4 }] : []),
  { key:'X', is_closing_event:true, event_index:99 },
];
  }
          }
        },
        {
          func: function () {
var filename;
var vmd = System._browser.camera.motion_recorder.vmd;
if (vmd) {
  filename = 'motion.vmd'
}
else {
  vmd = System._browser.camera.motion_recorder.vmd || MMD_SA.vmd_by_filename[MMD_SA.MMD.motionManager.filename];
  filename = MMD_SA.MMD.motionManager.filename + '.vmd'
}

setTimeout(()=>{
  MMD_SA.VMD_FileWriter().then(()=>{
    VMD_FileWriter(filename, vmd.boneKeys,vmd.morphKeys);
//    System._browser.camera.motion_recorder.vmd = null;
  });
}, 0);
          }
         ,message: {
  content: 'Please wait while the file is being generated for saving.'
 ,duration: 3
          }
         ,ended: true
        },
        {
          func: function () {
var filename;
var vmd = System._browser.camera.motion_recorder.vmd;
if (vmd) {
  filename = 'motion.glb'
}
else {
  vmd = System._browser.camera.motion_recorder.vmd || MMD_SA.vmd_by_filename[MMD_SA.MMD.motionManager.filename];
  filename = MMD_SA.MMD.motionManager.filename + '.glb'
}

setTimeout(()=>{
  MMD_SA.THREEX.utils.export_GLTF_motion(filename, vmd);
}, 0);
          }
         ,message: {
  content: 'Please wait while the file is being generated for saving.'
 ,duration: 3
          }
         ,ended: true
        },
        {
          func: function () {
var filename;
var vmd = System._browser.camera.motion_recorder.vmd;
if (vmd) {
  filename = 'motion.bvh'
}
else {
  vmd = System._browser.camera.motion_recorder.vmd || MMD_SA.vmd_by_filename[MMD_SA.MMD.motionManager.filename];
  filename = MMD_SA.MMD.motionManager.filename + '.bvh'
}

setTimeout(()=>{
  System._browser.load_script(toFileProtocol(System.Gadget.path + '/js/BVH_filewriter.js')).then(()=>{
    BVH_FileWriter(filename, vmd.boneKeys);
//    System._browser.camera.motion_recorder.vmd = null;
  });
}, 0);
          }
         ,message: {
  content: 'Please wait while the file is being generated for saving.'
 ,duration: 3
          }
         ,ended: true
        },

      ]
// 23
     ,[
        {
          message: {
  get content() {
return System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.message').replace(/\<camera_face_locking\>/, (MMD_SA_options.camera_face_locking==null)?System._browser.translation.get('Misc.auto'):(MMD_SA_options.camera_face_locking)?'ON':'OFF').replace(/\<audio_visualizer\>/, (MMD_SA_options.use_CircularSpectrum)?'ON':'OFF');
//return '1. ⌨️Hotkey list and options\n2. Camera face-locking: ' + ((MMD_SA_options.camera_face_locking==null)?'Auto':(MMD_SA_options.camera_face_locking)?'ON':'OFF') + '\n3. Audio visualizer: ' + ((MMD_SA_options.use_CircularSpectrum) ? 'ON' : 'OFF') + '\n4. Export all settings\n5. Reset all settings\n6. Done';
  },
  bubble_index: 3,
  para: { no_word_break:true },
  branch_list: [
    { key:1, event_index:3 },
    { key:2, event_index:1,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.camera_face_locking.tooltip')
);
      }
    },
    { key:3, event_index:2,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.audio_visualizer.tooltip')
);
      }
    },
    { key:4, event_index:6,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.export_all_settings.tooltip')
);
      }
    },
    { key:5, event_index:7 },
    { key:6, is_closing_event:true, event_index:99 },
  ],
          }
        },
        {
          func: ()=>{
if (MMD_SA_options.camera_face_locking == null) {
  MMD_SA_options.camera_face_locking = true;
}
else if (MMD_SA_options.camera_face_locking) {
  MMD_SA_options.camera_face_locking = false;
}
else {
  MMD_SA_options.camera_face_locking = null;
}
//MMD_SA.THREEX.utils.camera_auto_targeting({ id:'face', enabled:MMD_SA_options.camera_face_locking });
          },
          goto_event: { event_index:0 },
        },
        {
          func: ()=>{
MMD_SA_options.use_CircularSpectrum = !MMD_SA_options.use_CircularSpectrum;
          },
          goto_event: { event_index:0 },
        },
// 3
        {
message: {
  index: 1,
  bubble_index: 3,
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.extra').replace(/\<switch_avatar_model\>/, (System._browser.hotkeys.config_by_id['switch_avatar_model'].accelerator[0] == 'Alt+1')?'Alt+1-4':'Ctrl+1-4'); }
},
next_step: {},
        },

        ...(()=>{
function get_state(id) {
  const hotkeys = System._browser.hotkeys

  let state = '✔️';
//  if (!id) return (hotkeys.is_global) ? '🌐' : state;

  const config = hotkeys.config_by_id[id];
  if (!config) return '❌';

  if (hotkeys.accelerators[config.accelerator[0]].is_global)
    state = '🌐';

  return state;
}

function check_hotkey(acc) {
  if (!acc) {
    if (!hotkey_combo || !hotkey_combo[0] || !hotkey_combo[1]) return false;
    acc = hotkey_combo.join('+');
  }

  let state;
  if (System._browser.hotkeys._hotkey_reserved.indexOf(acc) != -1) {
    state = false;
    hotkey_info = '❌' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.reserved');
  }
  else {
    state = browser_native_mode || !webkit_electron_remote.globalShortcut.isRegistered(acc);
    hotkey_info = (state) ? '✔️OK' : '❌' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.not_usable');
  }

  return state;
}

          var hotkey_id, hotkey_combo, hotkey_info, hotkey_acc;

          var branch_list = [
    { key:'any', func:(e)=>{
if (!hotkey_id) return false;
if (!hotkey_combo) return false;
if (hotkey_acc) return false;

if (e.code == 'Escape') {
  hotkey_acc = hotkey_combo = null;
  MMD_SA_options.Dungeon.run_event(null,null,5);
  return true;
}

if (/Alt|Control|Shift/.test(e.key)) {
  hotkey_combo[0] = e.key.replace(/Control/, 'Ctrl');
}
else if (/Key([A-Z])/.test(e.code)) {
  hotkey_combo[1] = RegExp.$1;
}

for (let i = 0; i < 2; i++) {
  if (!hotkey_combo[i])
    hotkey_combo[i] = '';
}

if (check_hotkey()) {
  hotkey_acc = hotkey_combo.join('+');
  hotkey_combo = null;
}

MMD_SA_options.Dungeon.run_event(null,null,5);

return true;
    } },
    ...['switch_motion','arm_to_leg_control_mode','mocap_auto_grounding','hand_camera','selfie_mode','auto_look_at_camera','hip_camera'].map((id,i)=>{
      return { key:i+1, event_id:{ func:()=>{
hotkey_id = id;
hotkey_combo = hotkey_info = hotkey_acc = null;
        }, goto_event:{event_index:5} }
      };
    }),

    { key:'A', event_id:{ func:()=>{
if (hotkey_id) return;

const id = 'switch_avatar_model';
const hotkeys = System._browser.hotkeys;
const config = hotkeys.config_by_id[id];
const acc = [];
const acc_command = (config.accelerator[0] == 'Alt+1') ? 'Ctrl' : 'Alt';
for (let i = 0; i < 4; i++) {
  acc[i] = acc_command + '+' + (i+1);
}

if (!hotkeys.register(id, acc)) {
  const acc_default = hotkeys._hotkey_config.find(c=>c.id==id).accelerator;
  hotkeys.register(id, acc_default);
  DEBUG_show('❌' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.not_registered') + ' (' + acc_default[0] + ')', 5);
}
      }, goto_event:{event_index:3} },
      sb_index: 1,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.extra.switch_avatar_model.tooltip')
);
      }
    },

    { key:'D', event_id:{ func:()=>{
if (!hotkey_id) return;

const hotkeys = System._browser.hotkeys
const config = hotkeys.config_by_id[hotkey_id];
hotkeys.enable_global(hotkey_id, !!hotkeys.accelerators[config.accelerator[0]].config.global_disabled);
    }, goto_event:{event_index:4} } },

    { key:'C', event_id:{ func:()=>{
if (!hotkey_id) return;
if (hotkey_id == 'switch_motion') return;

hotkey_combo = [];
hotkey_info = hotkey_acc = null;
    }, goto_event:{event_index:4} } },

    { key:'R', event_id:{ func:()=>{
if (!hotkey_id) return;
if (hotkey_id == 'switch_motion') return;

const hotkeys = System._browser.hotkeys;
const acc_default = hotkeys._hotkey_config.find(c=>c.id==hotkey_id).accelerator;

if (acc_default[0] == hotkeys.config_by_id[hotkey_id].accelerator[0]) {
  hotkey_info = (hotkey_acc) ? '✔️' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.reset') + ' (' + acc_default[0] + ')' : '(' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.already_default') + ')';
}
else {
  hotkeys.register(hotkey_id, acc_default);
  hotkey_info = '✔️' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.reset') + ' (' + acc_default[0] + ')';
}

hotkey_combo = hotkey_acc = null;
    }, goto_event:{event_index:4} } },

    { key:'F', event_id:{ func:()=>{
if (!hotkey_id) return;

const hotkeys = System._browser.hotkeys;
if (hotkey_acc) {
  const acc_default = hotkeys._hotkey_config.find(c=>c.id==hotkey_id).accelerator;
  if (!hotkeys.register(hotkey_id, [hotkey_acc])) {
    hotkeys.register(hotkey_id, acc_default);
    DEBUG_show('❌' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.not_registered') + ' (' + acc_default[0] + ')', 5);
  }
  else {
    DEBUG_show('✔️' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.registered') + ' (' + hotkey_acc + ')', 5);
  }
}

hotkey_id = hotkey_combo = hotkey_info = hotkey_acc = null;
    }, goto_event:{event_index:3} } },

    { key:'G', event_id:{ func:()=>{System._browser.hotkeys.register_global(!System._browser.hotkeys.is_global)}, goto_event:{event_index:3} },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.global_hotkey_mode.tooltip')
);
      }
    },
    { key:'X', is_closing_event:true, event_id:{ func:()=>{
hotkey_id = hotkey_combo = hotkey_info = hotkey_acc = null;
    }, goto_event:{event_index:99} } },
          ];

          return [
// 4
            {
              func: ()=>{
if (hotkey_id) MMD_SA_options.Dungeon.run_event();
              },
              message: {
  get content() {
const hotkeys = System._browser.hotkeys;

return [
  '1. ' + get_state('switch_motion') + 'Alt/Ctrl+Num0-9' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.switch_motion'),
  '2. ' + get_state('arm_to_leg_control_mode') + hotkeys.config_by_id['arm_to_leg_control_mode'].accelerator[0] + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.arm_as_leg_control'),
  '3. ' + get_state('mocap_auto_grounding') + hotkeys.config_by_id['mocap_auto_grounding'].accelerator[0] + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.auto_grounding'),
//  '・' + get_state('camera_3D_lock') + 'Ctrl+L to toggle 3D camera lock',
  '4. ' + get_state('hand_camera') + hotkeys.config_by_id['hand_camera'].accelerator[0] + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.hand_camera'),
  '5. ' + get_state('selfie_mode') + hotkeys.config_by_id['selfie_mode'].accelerator[0] + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.selfie_mode'),
  '6. ' + get_state('auto_look_at_camera') + hotkeys.config_by_id['auto_look_at_camera'].accelerator[0] + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.auto_look_at_camera'),
  '7. ' + get_state('hip_camera') + hotkeys.config_by_id['hip_camera'].accelerator[0] + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.hip_camera'),
  'G. ' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.global_hotkey_mode') + '🌐: ' + ((System._browser.hotkeys.is_global) ? 'ON' : 'OFF'),
  'X. ' + System._browser.translation.get('Misc.done'),
].join('\n');
  },
  bubble_index: 3,
  para: { no_word_break:true, font_scale:0.9 },
  branch_list: branch_list,
              },
            },

// 5
            {
              message: {
  get content() {
const hotkeys = System._browser.hotkeys
const config = hotkeys.config_by_id[hotkey_id];

return [
  get_state(hotkey_id) + hotkey_id,

  ...(()=>{
if (hotkey_id == 'switch_motion') return [System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.hotkey') + ': Alt/Ctrl+Num0-9'];

if (!hotkey_combo) return [System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.hotkey') + ': ' + (hotkey_acc||config.accelerator[0])];

let info = System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.valid_keys') + ':\n・Alt/Ctrl/Shift\n・A-Z\n' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.press_to_cancel');

if (!hotkey_combo.length) {
  return [
System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.current_hotkey') + ': ' + config.accelerator[0],
info,
  ];
}

return [
  System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.current_hotkey') + ': ' + hotkey_combo.join('+'),
  info,
];
  })(),

  ...((hotkey_info)?[hotkey_info]:[]),

  ...((hotkey_combo || browser_native_mode) ? [] : ['D. ' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.global_hotkey') + ': ' + ((hotkeys.accelerators[config.accelerator[0]].config.global_disabled) ? 'OFF' : 'ON')]),

  ...(()=>{
if ((hotkey_id == 'switch_motion') || hotkey_combo) return [];

if (!hotkey_combo) {
  return [
    'C. ' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.change_hotkey'),
    'R. ' + System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.hotkey.reset_hotkey'),
  ];
}
  })(),

  ...((hotkey_combo) ? [] : ['F. ' + System._browser.translation.get('Misc.finish')]),
].join('\n');
  },
  index: 1,
  bubble_index: 3,
  para: { font_scale:1 },
  branch_list: branch_list,
              },
            },
          ];
        })(),
// 6
        {
          func: ()=>{
const config = MMD_SA_options._XRA_settings_export();
const json = JSON.stringify({ XR_Animator_settings:config }, null, '\t');
System._browser.save_file('XRA_settings.json', json, 'application/json');
          },
          ended: true,
        },
// 7
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.UI_options.miscellaneous_options.reset_all_settings'); },
  bubble_index: 3,
  branch_list: [
    { key:1, event_index:8 },
    { key:2, is_closing_event:true, event_index:99 },
  ],
          }
        },
// 8
        {
          func: (()=>{
            const XRA_settings_default = {
	"XR_Animator_settings": {
		"user_camera": {
			"pixel_limit": {
				"disabled": false,
				"current": null
			},
			"display": {
				"video": {},
				"wireframe": {}
			},
			"ML_models": {
				"pose": {
					"shoulder_tracking": System._browser.camera.poseNet.shoulder_tracking,
					"hip_adjustment_weight_percent": System._browser.camera.poseNet.hip_adjustment_weight_percent,
					"hip_adjustment_head_weight_percent": System._browser.camera.poseNet.hip_adjustment_head_weight_percent,
					"hip_adjustment_adjust_y_axis_percent": System._browser.camera.poseNet.hip_adjustment_adjust_y_axis_percent,
					"hip_adjustment_scale_x_percent": System._browser.camera.poseNet.hip_adjustment_scale_x_percent,
					"hip_adjustment_scale_y_percent": System._browser.camera.poseNet.hip_adjustment_scale_y_percent,
					"hip_adjustment_scale_z_percent": System._browser.camera.poseNet.hip_adjustment_scale_z_percent,
					"hip_adjustment_smoothing_percent": System._browser.camera.poseNet.hip_adjustment_smoothing_percent,
				},
				"hands": {},
				"facemesh": {
					"eye_tracking": true,
					"emotion_weight_percent": System._browser.camera.facemesh.emotion_weight_percent,
					"emotion_joy_fun_percent": System._browser.camera.facemesh.emotion_joy_fun_percent,
					"emotion_angry_percent": System._browser.camera.facemesh.emotion_angry_percent,
					"emotion_sorrow_percent": System._browser.camera.facemesh.emotion_sorrow_percent,
					"emotion_surprised_percent": System._browser.camera.facemesh.emotion_surprised_percent,
					"emotion_others_percent": System._browser.camera.facemesh.emotion_others_percent,
				},
				"tilt_adjustment": Object.assign({}, System._browser.camera.tilt_adjustment),
			},
			"streamer_mode": {
				"camera_preference": {}
			}
		},
		"hotkeys": {
			"is_global": true
		},
		"audio_visualizer": true,
		"camera_face_locking": null,
		"shoulder_adjust": null,
        "selfie_mode": false,
		"video_capture": {},
		"pose": {},
		"VMC": {}
	}
            };

            return ()=>{
System.Gadget.Settings.writeString('LABEL_XRA_settings', '');

MMD_SA_options._XRA_pose_reset();
MMD_SA_options._XRA_clear_custom_motion();

if (MMD_SA.THREEX.enabled) {
  for (const PPE of ['UnrealBloom', 'N8AO', 'DOF']) {
    let param;
    switch (PPE) {
      case 'UnrealBloom':
        param = ['params', 'params_vrm'];
        break;
      case 'N8AO':
        param = ['effectController', 'effectController_vrm'];
        break;
      case 'DOF':
        param = ['effectController'];
        break;
    }

    param?.forEach(p=>{
      if (MMD_SA.THREEX.PPE.initialized) {
        MMD_SA.THREEX.PPE[PPE][p].reset?.();
        MMD_SA.THREEX.PPE[PPE].enabled = false;
      }
      else {
        MMD_SA.THREEX.PPE[PPE][p] = null;
      }
    });
  }
}

MMD_SA_options._XRA_settings_import(XRA_settings_default.XR_Animator_settings);
DEBUG_show('✅Settings reset', 3);
            };
          })(),

          ended: true,
        },
      ]
// 24
     ,[
      ]
// 25
     ,[
        {
          func: function () {
if (System._browser.camera.initialized) {
  if (!System._browser.camera.ML_warmed_up) {
    System._browser.on_animation_update.add(()=>{ MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.record_motion.model_warming_up'), 4*1000); }, 0,0);
    MMD_SA_options.Dungeon.run_event(null,done_branch,0);
  }
  else {
    MMD_SA_options.Dungeon.run_event()
  }
}
else {
  System._browser.on_animation_update.add(()=>{ MMD_SA.SpeechBubble.message(0, System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.record_motion.choose_input'), 4*1000); }, 0,0);
  MMD_SA_options.Dungeon.run_event(null,done_branch,0);
}
          }
        },
        {
          func: function () {
System._browser.camera._info = System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed.info');
          }
         ,message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.motion_capture.ML_on.record_motion.choose_speed'); }
 ,bubble_index: 3
 ,branch_list: [
  { key:1, branch_index:record_motion_branch+1 },
  { key:2, branch_index:record_motion_branch+2 },
  { key:3, branch_index:record_motion_branch+3 },
  { key:4, is_closing_event:true, branch_index:done_branch }
  ]
          }
        }
      ]
// 26
     ,[
        {
          func: function () {
mirror_3D_off()
System._browser.camera.motion_recorder.speed = 1
System._browser.camera._info = ''
DEBUG_show('(Motion recording STARTED / x1 speed)', 3)
          }
         ,ended: true
        }
      ]
// 27
     ,[
        {
          func: function () {
mirror_3D_off()
System._browser.camera.motion_recorder.speed = 0.5
System._browser.camera._info = ''
DEBUG_show('(Motion recording STARTED / x0.5 speed)', 3)
          }
         ,ended: true
        }
      ]
// 28
     ,[
        {
          func: function () {
mirror_3D_off()
System._browser.camera.motion_recorder.speed = 0.25
System._browser.camera._info = ''
DEBUG_show('(Motion recording STARTED / x0.25 speed)', 3)
          }
         ,ended: true
        }
      ]

// 29
     ,(()=>{
const hand_page_index = 6;
const tilt_page_index = 7;
return [
        {
          message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options') + '\n6. ' + System._browser.translation.get('Misc.done'); }
 ,bubble_index: 3
 ,branch_list: [
  { key:1, event_index:1 },
  { key:2, event_index:hand_page_index },
  { key:3, branch_index:facemesh_options_branch },
  { key:4, event_index:tilt_page_index },
  { key:5, branch_index:mocap_options_branch+4,
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.clear_bounding_box.tooltip')
);
    }
  },
  { key:6, is_closing_event:true, branch_index:done_branch }
  ]
          }
        },

        ...(()=>{
          let page2_index = 2;
          let option_plus_minus = 'arm_horizontal_offset';

          const hip_adjustment_index = 3;
          const body_collider_index = 4;
          const z_depth_scale_event_index = 5;

          let hip_adjustment_option_active = 'General weighting';
          const hip_adjustment_options = ['General weighting', 'Head motion weight', 'Head pitch rotation', 'Y-axis adjustment', 'Scale X', 'Scale Y', 'Scale Z', 'Smoothing'];

          let body_collider_option_active = 'Chest size';
          const body_collider_options = ['Head size', 'Chest size', 'Waist size', 'Hip size'];

          return [
            {
          message: {
  get content() {
    return [
'1. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.AI_model_quality') + ': ' + System._browser.translation.get('Misc.' + (MMD_SA_options.user_camera.ML_models.pose.model_quality || 'Normal')),
'2. ┗ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.AI_model_quality.z_depth_scale') + ': ' + ((MMD_SA_options.user_camera.ML_models.pose.model_quality == 'Best') ? System._browser.translation.get('Misc.' + ((MMD_SA_options.user_camera.ML_models.pose.z_depth_scale) ? ((MMD_SA_options.user_camera.ML_models.pose.z_depth_scale<3)?'Max':'Min'):'Medium')) : 'N/A'),
'3. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.arm_horizontal_offset') + ': ' + (System._browser.camera.poseNet.arm_horizontal_offset_percent||0) + '%' + ((option_plus_minus == 'arm_horizontal_offset') ? '➕➖' : ''),
'4. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.limb_entry_duration') + ': ' + System._browser.camera.poseNet.limb_entry_duration_percent + '%' + ((option_plus_minus == 'limb_entry_duration') ? '➕➖' : ''),
'5. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.limb_return_duration') + ': ' + System._browser.camera.poseNet.limb_return_duration_percent + '%' + ((option_plus_minus == 'limb_return_duration') ? '➕➖' : ''),
'6. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.upper_rotation_offset') + ': ' + ((MMD_SA.MMD.motionManager.para_SA.motion_tracking?.ML_models?.pose || MMD_SA_options.user_camera.ML_models.pose).upper_rotation_offset||0) + '°' + ((option_plus_minus == 'upper_rotation_offset') ? '➕➖' : ''),
'7. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment') + ' ' + ((page2_index!=hip_adjustment_index) ? '▶️' : '◀️'),
'8. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider') + ' ' + ((page2_index!=body_collider_index) ? '▶️' : '◀️'),

'X. ' + System._browser.translation.get('Misc.done'),
    ].join('\n');
  },
  bubble_index: 3,
//  para: { row_max:11 },
  branch_list: [
  { key:'any', func:(e)=>{
let step;

if ((page2_index == body_collider_index) && /Arrow(Up|Down)/.test(e.code)) {
  step = body_collider_index;

  let index = body_collider_options.findIndex(v=>v==body_collider_option_active);
  index -= (e.code == 'ArrowUp') ? 1 : -1;
  if (index < 0) {
    index = body_collider_options.length-1;
  }
  else if (index > body_collider_options.length-1) {
    index = 0;
  }
  body_collider_option_active = body_collider_options[index];
}
else if ((page2_index == body_collider_index) && /Arrow(Left|Right)/.test(e.code)) {
  step = body_collider_index;

  const bc = System._browser.camera.poseNet.body_collider;

  const v = (e.code == 'ArrowRight') ? 5 : -5;
  switch (body_collider_option_active) {
    case 'Head size':
bc.head.size_percent = THREE.Math.clamp(bc.head.size_percent + v, 45,300);
if (bc.head.size_percent < 50)
  bc.head.size_percent = (v < 0) ? 0 : 50;
      break;
    case 'Chest size':
bc.chest.size_percent = THREE.Math.clamp(bc.chest.size_percent + v, 45,300);
if (bc.chest.size_percent < 50)
  bc.chest.size_percent = (v < 0) ? 0 : 50;
      break;
    case 'Waist size':
bc.waist.size_percent = THREE.Math.clamp(bc.waist.size_percent + v, 45,300);
if (bc.waist.size_percent < 50)
  bc.waist.size_percent = (v < 0) ? 0 : 50;
      break;
    case 'Hip size':
bc.hip.size_percent = THREE.Math.clamp(bc.hip.size_percent + v, 45,300);
if (bc.hip.size_percent < 50)
  bc.hip.size_percent = (v < 0) ? 0 : 50;
      break;
    default:
      return false;
  }
}
else if ((page2_index == hip_adjustment_index) && /Arrow(Up|Down)/.test(e.code)) {
  step = hip_adjustment_index;

  let index = hip_adjustment_options.findIndex(v=>v==hip_adjustment_option_active);
  index -= (e.code == 'ArrowUp') ? 1 : -1;
  if (index < 0) {
    index = hip_adjustment_options.length-1;
  }
  else if (index > hip_adjustment_options.length-1) {
    index = 0;
  }
  hip_adjustment_option_active = hip_adjustment_options[index];
}
else if ((page2_index == hip_adjustment_index) && /Arrow(Left|Right)/.test(e.code)) {
  step = hip_adjustment_index;

  const v = (e.code == 'ArrowRight') ? 1 : -1;
  switch (hip_adjustment_option_active) {
    case 'General weighting':
System._browser.camera.poseNet.hip_adjustment_weight_percent = THREE.Math.clamp(System._browser.camera.poseNet.hip_adjustment_weight_percent + v, 0,200);
      break;
    case 'Head motion weight':
System._browser.camera.poseNet.hip_adjustment_head_weight_percent = THREE.Math.clamp(System._browser.camera.poseNet.hip_adjustment_head_weight_percent + v, 0,100);
      break;
    case 'Head pitch rotation':
System._browser.camera.poseNet.hip_adjustment_head_pitch_rotation_percent = THREE.Math.clamp(System._browser.camera.poseNet.hip_adjustment_head_pitch_rotation_percent + v*5, -200,200);
      break;
    case 'Y-axis adjustment':
System._browser.camera.poseNet.hip_adjustment_adjust_y_axis_percent = THREE.Math.clamp(System._browser.camera.poseNet.hip_adjustment_adjust_y_axis_percent + v, 0,100);
      break;
    case 'Scale X':
System._browser.camera.poseNet.hip_adjustment_scale_x_percent = THREE.Math.clamp(System._browser.camera.poseNet.hip_adjustment_scale_x_percent + v*5, -300,300);
      break;
    case 'Scale Y':
System._browser.camera.poseNet.hip_adjustment_scale_y_percent = THREE.Math.clamp(System._browser.camera.poseNet.hip_adjustment_scale_y_percent + v*5, -300,300);
      break;
    case 'Scale Z':
System._browser.camera.poseNet.hip_adjustment_scale_z_percent = THREE.Math.clamp(System._browser.camera.poseNet.hip_adjustment_scale_z_percent + v*5, -300,300);
      break;
    case 'Smoothing':
System._browser.camera.poseNet.hip_adjustment_smoothing_percent = THREE.Math.clamp(System._browser.camera.poseNet.hip_adjustment_smoothing_percent + v, 0,100);
      break;
    default:
      return false;
 }
}
else if ((e.key == '+') || (e.key == '-')) {
  step = 1;

  let inc = (e.key == '+') ? 1 : -1;
  if (option_plus_minus == 'arm_horizontal_offset') {
    System._browser.camera.poseNet.arm_horizontal_offset_percent = THREE.Math.clamp((System._browser.camera.poseNet.arm_horizontal_offset_percent||0) + inc*2, -200,200);
  }
  else if (option_plus_minus == 'limb_entry_duration') {
    System._browser.camera.poseNet.limb_entry_duration_percent = THREE.Math.clamp((System._browser.camera.poseNet.limb_entry_duration_percent||0) + inc*5, 25,400);
  }
  else if (option_plus_minus == 'limb_return_duration') {
    System._browser.camera.poseNet.limb_return_duration_percent = THREE.Math.clamp((System._browser.camera.poseNet.limb_return_duration_percent||0) + inc*5, 25,400);
  }
  else {
    const _pose = (MMD_SA.MMD.motionManager.para_SA.motion_tracking?.ML_models?.pose || MMD_SA_options.user_camera.ML_models.pose);
    _pose.upper_rotation_offset = ((_pose.upper_rotation_offset||0) + inc) % 360;
  }
}
else {
  return false;
}

MMD_SA_options.Dungeon.run_event(null, mocap_options_branch, step);

return true;
  } },

  { key:1, event_id: {
      func: function () {
MMD_SA_options.user_camera.ML_models.pose.model_quality = (!MMD_SA_options.user_camera.ML_models.pose.model_quality) ? 'Best' : undefined;
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.AI_model_quality.tooltip')
);
    }
  },
  { key:2, event_index:z_depth_scale_event_index,
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.AI_model_quality.z_depth_scale.tooltip')
);
    }
  },
  { key:3, event_id: {
      func: function () {
option_plus_minus = 'arm_horizontal_offset';
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.arm_horizontal_offset') + ((option_plus_minus == 'arm_horizontal_offset') ? ' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.press_to_change_value') + ')' : '') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.arm_horizontal_offset.tooltip')
);
    }
  },
  { key:4, event_id: {
      func: function () {
option_plus_minus = 'limb_entry_duration';
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.limb_entry_duration') + ((option_plus_minus == 'limb_entry_duration') ? ' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.press_to_change_value') + ')' : '') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.limb_entry_duration.tooltip')
);
    }
  },
  { key:5, event_id: {
      func: function () {
option_plus_minus = 'limb_return_duration';
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.limb_return_duration') + ((option_plus_minus == 'limb_return_duration') ? ' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.press_to_change_value') + ')' : '') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.limb_return_duration.tooltip')
);
    }
  },
  { key:6, event_id: {
      func: function () {
option_plus_minus = 'upper_rotation_offset';
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.upper_rotation_offset') + ((option_plus_minus == 'upper_rotation_offset') ? ' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.press_to_change_value') + ')' : '') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.upper_rotation_offset.tooltip')
);
    }
  },
  { key:7, event_id: {
      func: function () {
page2_index = (page2_index != hip_adjustment_index) ? hip_adjustment_index : 2;
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    }
  },
  { key:8, event_id: {
      func: function () {
page2_index = (page2_index != body_collider_index) ? body_collider_index : 2;
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    }
  },
  { key:'X', is_closing_event:true, branch_index:done_branch }
  ]
          },
          goto_event: { branch_index:mocap_options_branch, get step() { return page2_index; } }
            },
// 2
            {
          message: {
  get content() {
    let body_bend_reduction_power;
    switch (System._browser.camera.poseNet.body_bend_reduction_power) {
      case 0.25:
        body_bend_reduction_power = 'Small';
        break;
      case 0.5:
        body_bend_reduction_power = 'Medium';
        break;
      case 0.75:
        body_bend_reduction_power = 'Large';
        break;
      case 1:
        body_bend_reduction_power = 'Full';
        break;
    }

    return [
'A. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.shoulder_tracking') + ': ' + ((System._browser.camera.poseNet.shoulder_tracking) ? 'ON' : 'OFF'),
'B. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_bend_reduction') + ': ' + ((body_bend_reduction_power) ? System._browser.translation.get('Misc.' + body_bend_reduction_power) : 'OFF'),
'C. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.leg_IK') + ': ' + ((MMD_SA_options.user_camera.ML_models.pose.use_legIK)?'ON':'OFF'),
'D. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.auto_grounding') + ' (' + (System._browser.hotkeys.config_by_id['mocap_auto_grounding']?.accelerator[0]||'') + '): ' + ((!System._browser.camera.poseNet.auto_grounding)?'OFF':'ON'),
'E. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_camera') + ' (' + (System._browser.hotkeys.config_by_id['hip_camera']?.accelerator[0]||'') + '): ' + ((System._browser.camera.poseNet.hip_camera) ? 'ON' : 'OFF'),
    ].join('\n');
  },
  index: 1,
  bubble_index: 3,
//  para: { row_max:11 },
  branch_list: [
  { key:'A', event_id: {
      func: function () {
System._browser.camera.poseNet.shoulder_tracking = (System._browser.camera.poseNet.shoulder_tracking) ? 0 : null;
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.shoulder_tracking.tooltip')
);
    }
  },
  { key:'B', event_id: {
      func: function () {
let v = System._browser.camera.poseNet.body_bend_reduction_power || 0;
v += 0.25;
if (v > 1)
  v = 0;
System._browser.camera.poseNet.body_bend_reduction_power = v;
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_bend_reduction.tooltip')
);
    }
  },
  { key:'C', branch_index:mocap_options_branch+1,
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.leg_IK.tooltip')
);
    }
  },

  { key:'D', branch_index:mocap_options_branch+3,
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.auto_grounding.tooltip').replace(/\<hotkey\>/, System._browser.hotkeys.config_by_id['mocap_auto_grounding']?.accelerator[0]||'N/A')
);
    }
  },
  { key:'E', event_id: {
      func: function () {
System._browser.camera.poseNet.hip_camera = !System._browser.camera.poseNet.hip_camera;
      },
      goto_event: { branch_index:mocap_options_branch, step:1 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_camera.tooltip').replace(/\<hotkey\>/, System._browser.hotkeys.config_by_id['hip_camera']?.accelerator[0]||'N/A')
);
    }
  }
  ]
          }
            },
// 3
            {
              message: {
  get content() {
    const scale = System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.scale');

    return [
System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.upper_body_mocap'),
//'・Press ⬆️⬇️ to switch option',
'・' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value'),
'A. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.general_weighting') + ': ' + ((System._browser.camera.poseNet.hip_adjustment_weight_percent == 0) ? 'OFF' : System._browser.camera.poseNet.hip_adjustment_weight_percent + '%') + ((hip_adjustment_option_active=='General weighting')?'⬅️➡️':''),
'B. ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.head_motion_weight') + ': ' + ((System._browser.camera.poseNet.hip_adjustment_weight_percent == 0) ? 'N/A' : System._browser.camera.poseNet.hip_adjustment_head_weight_percent + '%') + ((hip_adjustment_option_active=='Head motion weight')?'⬅️➡️':''),
'C.     ┗ ' + ' ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.head_motion_weight.pitch_rotation') + ': ' + ((System._browser.camera.poseNet.hip_adjustment_weight_percent == 0) ? 'N/A' : System._browser.camera.poseNet.hip_adjustment_head_pitch_rotation_percent + '%') + ((hip_adjustment_option_active=='Head pitch rotation')?'⬅️➡️':''),
'D. ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.y_axis_adjustment') + ': ' + ((System._browser.camera.poseNet.hip_adjustment_weight_percent == 0) ? 'N/A' : System._browser.camera.poseNet.hip_adjustment_adjust_y_axis_percent + '%') + ((hip_adjustment_option_active=='Y-axis adjustment')?'⬅️➡️':''),
'E. ┣ ' + scale + ' X: ' + ((System._browser.camera.poseNet.hip_adjustment_weight_percent == 0) ? 'N/A' : System._browser.camera.poseNet.hip_adjustment_scale_x_percent + '%') + ((hip_adjustment_option_active=='Scale X')?'⬅️➡️':''),
'F. ┣ ' + scale + ' Y: ' + ((System._browser.camera.poseNet.hip_adjustment_weight_percent == 0) ? 'N/A' : System._browser.camera.poseNet.hip_adjustment_scale_y_percent + '%') + ((hip_adjustment_option_active=='Scale Y')?'⬅️➡️':''),
'G. ┣ ' + scale + ' Z: ' + ((System._browser.camera.poseNet.hip_adjustment_weight_percent == 0) ? 'N/A' : System._browser.camera.poseNet.hip_adjustment_scale_z_percent + '%') + ((hip_adjustment_option_active=='Scale Z')?'⬅️➡️':''),
'H. ┗ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.smoothing') + ': ' + ((System._browser.camera.poseNet.hip_adjustment_weight_percent == 0) ? 'N/A' : System._browser.camera.poseNet.hip_adjustment_smoothing_percent + '%') + ((hip_adjustment_option_active=='Smoothing')?'⬅️➡️':''),
    ].join('\n');
  },
  index: 1,
  bubble_index: 3,
  para: { row_max:11 },
  branch_list: [
  { key:'A', event_id: {
      func:()=>{
hip_adjustment_option_active = 'General weighting';
      },
      goto_event: { branch_index:mocap_options_branch, step:hip_adjustment_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.general_weighting') + ((hip_adjustment_option_active=='General weighting')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.general_weighting.tooltip')
);
    }
  },
  { key:'B', event_id: {
      func:()=>{
hip_adjustment_option_active = 'Head motion weight';
      },
      goto_event: { branch_index:mocap_options_branch, step:hip_adjustment_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.head_motion_weight') + ((hip_adjustment_option_active=='Head motion weight')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.head_motion_weight.tooltip')
);
    }
  },
  { key:'C', event_id: {
      func:()=>{
hip_adjustment_option_active = 'Head pitch rotation';
      },
      goto_event: { branch_index:mocap_options_branch, step:hip_adjustment_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.head_motion_weight.pitch_rotation') + ((hip_adjustment_option_active=='Head pitch rotation')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.head_motion_weight.pitch_rotation.tooltip')
);
    }
  },
  { key:'D', event_id: {
      func:()=>{
hip_adjustment_option_active = 'Y-axis adjustment';
      },
      goto_event: { branch_index:mocap_options_branch, step:hip_adjustment_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.y_axis_adjustment') + ((hip_adjustment_option_active=='Y-axis adjustment')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.y_axis_adjustment.tooltip')
);
    }
  },
  { key:'E', event_id: {
      func:()=>{
hip_adjustment_option_active = 'Scale X';
      },
      goto_event: { branch_index:mocap_options_branch, step:hip_adjustment_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.scale') + ' X' + ((hip_adjustment_option_active=='Scale X')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.scale.x.tooltip')
);
    }
  },
  { key:'F', event_id: {
      func:()=>{
hip_adjustment_option_active = 'Scale Y';
      },
      goto_event: { branch_index:mocap_options_branch, step:hip_adjustment_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.scale') + ' Y' + ((hip_adjustment_option_active=='Scale Y')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.scale.y.tooltip')
);
    }
  },
  { key:'G', event_id: {
      func:()=>{
hip_adjustment_option_active = 'Scale Z';
      },
      goto_event: { branch_index:mocap_options_branch, step:hip_adjustment_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.scale') + ' Z' + ((hip_adjustment_option_active=='Scale Z')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.scale.z.tooltip')
);
    }
  },
  { key:'H', event_id: {
      func:()=>{
hip_adjustment_option_active = 'Smoothing';
      },
      goto_event: { branch_index:mocap_options_branch, step:hip_adjustment_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.smoothing') + ((hip_adjustment_option_active=='Smoothing')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.hip_adjustment.smoothing.tooltip')

);
    }
  },
  ]
              }
            },
// 4
            {
              message: {
  get content() {
    const size = System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size');
    const bc = System._browser.camera.poseNet.body_collider;

    return [
System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider'),
'A. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.mode') + ': ' + ((bc.mode == 1) ? System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.upper_body_mocap') : ((bc.mode == 0) ? 'OFF' : System._browser.translation.get('Misc.full'))),
'B. ┗ ' + ' ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.head') + ': ' + ((bc.mode == 0) ? 'N/A' : bc.head.size_percent + '%') + ((body_collider_option_active=='Head size')?'⬅️➡️':''),
'C.     ┗ ' + ' ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.reaction_type') + ': ' + ((bc.mode == 0 || !bc.head.enabled) ? 'N/A' : System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.reaction_type.' + bc.head.reaction_type)),
'D. ┗ ' + ' ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.chest') + ': ' + ((bc.mode == 0) ? 'N/A' : bc.chest.size_percent + '%') + ((body_collider_option_active=='Chest size')?'⬅️➡️':''),
'E. ┗ ' + ' ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.waist') + ': ' + ((bc.mode == 0) ? 'N/A' : bc.waist.size_percent + '%') + ((body_collider_option_active=='Waist size')?'⬅️➡️':''),
'F. ┗ ' + ' ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.hip') + ': ' + ((bc.mode == 0) ? 'N/A' : bc.hip.size_percent + '%') + ((body_collider_option_active=='Hip size')?'⬅️➡️':''),
    ].join('\n');
  },
  index: 1,
  bubble_index: 3,
  para: { row_max:11 },
  branch_list: [
  { key:'A', event_id: {
      func:()=>{
const bc = System._browser.camera.poseNet.body_collider;
if (++bc.mode > 2)
  bc.mode = 0;
      },
      goto_event: { branch_index:mocap_options_branch, step:body_collider_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.tooltip')
);
    }
  },
  { key:'B', event_id: {
      func:()=>{
body_collider_option_active = 'Head size';
      },
      goto_event: { branch_index:mocap_options_branch, step:body_collider_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.head') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size.space') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size') + ((body_collider_option_active=='Head size')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.press_to_change_value') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size.tooltip')
);
    }
  },
  { key:'C', event_id: {
      func:()=>{
const bc = System._browser.camera.poseNet.body_collider;
bc.head.reaction_type = (bc.head.reaction_type == 'z_push') ? 'sphere' : 'z_push';
      },
      goto_event: { branch_index:mocap_options_branch, step:body_collider_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.reaction_type') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.reaction_type.tooltip')
);
    }
  },
  { key:'D', event_id: {
      func:()=>{
body_collider_option_active = 'Chest size';
      },
      goto_event: { branch_index:mocap_options_branch, step:body_collider_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.chest') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size.space') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size') + ((body_collider_option_active=='Chest size')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.press_to_change_value') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size.tooltip')
);
    }
  },
  { key:'E', event_id: {
      func:()=>{
body_collider_option_active = 'Waist size';
      },
      goto_event: { branch_index:mocap_options_branch, step:body_collider_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.waist') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size.space') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size') + ((body_collider_option_active=='Waist size')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.press_to_change_value') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size.tooltip')
);
    }
  },
  { key:'F', event_id: {
      func:()=>{
body_collider_option_active = 'Hip size';
      },
      goto_event: { branch_index:mocap_options_branch, step:body_collider_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.hip') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size.space') + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size') + ((body_collider_option_active=='Hip size')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.press_to_change_value') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.body_tracking_options.body_collider.size.tooltip')
);
    }
  },
  ]
              }
            }
          ];
        })(),
// 5
        {
          func: function () {
if (MMD_SA_options.user_camera.ML_models.pose.model_quality != 'Best') return;

if (MMD_SA_options.user_camera.ML_models.pose.z_depth_scale < 3)
  MMD_SA_options.user_camera.ML_models.pose.z_depth_scale = undefined;
else if (MMD_SA_options.user_camera.ML_models.pose.z_depth_scale > 3)
  MMD_SA_options.user_camera.ML_models.pose.z_depth_scale = 2;
else
  MMD_SA_options.user_camera.ML_models.pose.z_depth_scale = 4.5;
          },
          goto_event: { branch_index:mocap_options_branch, step:1 },
        },
// 6
        (()=>{
          let option_active = 'Depth adjustment';
          const options = ['Depth adjustment', 'IRL hand/shoulder scale', 'Depth scale'];
          return {
            message: {
  get content() {
return [
  '1. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment') + ': ' + ((MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent == 0) ? 'OFF' : MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent + '%') + ((option_active=='Depth adjustment')?'⬅️➡️':''),
//  '・Press ⬅️➡️ to change value',
  '2. ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.IRL_hand_shoulder_scale') + ': ' + ((MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent == 0) ? 'OFF' : MMD_SA_options.user_camera.ML_models.hands.palm_shoulder_scale_percent + '%') + ((option_active=='IRL hand/shoulder scale')?'⬅️➡️':''),
//\n' + '        ' + '┗ ' + palm_shoulder_scale() + '
  '3. ┗ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.depth_scale') + ': ' + ((MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent == 0) ? 'OFF' : MMD_SA_options.user_camera.ML_models.hands.depth_scale_percent + '%') + ((option_active=='Depth scale')?'⬅️➡️':''),
  '4. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.arm_stabilization') + ': ' + ((System._browser.camera.handpose.stabilize_arm == 2) ? 'ON' : ((System._browser.camera.handpose.stabilize_arm == 1) ? System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.arm_stabilization.upper_body_mocap') : 'OFF')),
  '5. ┗ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.arm_stabilization.time_to_stabilize') + ': ' + ((System._browser.camera.handpose.stabilize_arm) ? ((System._browser.camera.handpose.stabilize_arm_time) ? ((System._browser.camera.handpose.stabilize_arm_time == 1) ? '1 ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.arm_stabilization.time_to_stabilize.frame') : System._browser.camera.handpose.stabilize_arm_time + 'ms') : '0') : 'N/A'),
  '6. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.hand_stabilization') + ': ' + ((System._browser.camera.handpose.stabilize_hand_percent) ? System._browser.camera.handpose.stabilize_hand_percent + '%' : 'OFF') + '➕➖',
  '7. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.constrain_tracking_region') + ': ' + ((System._browser.camera.handpose.constrain_tracking_region) ? 'ON' : System._browser.translation.get('Misc.auto')),
  '8. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.standalone_web_worker') + ': ' + ((System._browser.camera.handpose.use_hands_worker) ? 'ON' : 'OFF'),
  '9. ' + System._browser.translation.get('Misc.done'),
].join('\n');
  }
 ,bubble_index: 3
 ,branch_list: [
  { key:'any', func:(e)=>{
if (/Arrow(Up|Down)/.test(e.code)) {
  let index = options.findIndex(v=>v==option_active);
  index -= (e.code == 'ArrowUp') ? 1 : -1;
  if (index < 0) {
    index = options.length-1;
  }
  else if (index > options.length-1) {
    index = 0;
  }
  option_active = options[index];
}
else if (/Arrow(Left|Right)/.test(e.code)) {
  const v = (e.code == 'ArrowRight') ? 1 : -1;
  switch (option_active) {
    case 'Depth adjustment':
MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent = THREE.Math.clamp(MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent + v, 0,100);
      break;
    case 'IRL hand/shoulder scale':
MMD_SA_options.user_camera.ML_models.hands.palm_shoulder_scale_percent = THREE.Math.clamp(MMD_SA_options.user_camera.ML_models.hands.palm_shoulder_scale_percent + v, 10,50);
      break;
    case 'Depth scale':
MMD_SA_options.user_camera.ML_models.hands.depth_scale_percent = THREE.Math.clamp(MMD_SA_options.user_camera.ML_models.hands.depth_scale_percent + v, 10,90);
      break;
    default:
      return false;
  }
}
else if ((e.key == '+') || (e.key == '-')) {
  const v = (e.key == '+') ? 1 : -1;
  System._browser.camera.handpose.stabilize_hand_percent = THREE.Math.clamp(System._browser.camera.handpose.stabilize_hand_percent + v, 0,100);
}
else {
  return false;
}

MMD_SA_options.Dungeon.run_event(null,mocap_options_branch,hand_page_index);

return true;
  } },

  { key:1, event_id: {
      func:()=>{
option_active = 'Depth adjustment';
      },
      goto_event: { branch_index:mocap_options_branch, step:hand_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment') + ((option_active=='Depth adjustment')?' (' +  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.press_to_change_value') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.tooltip')
);
    }
  },
  { key:2, event_id: {
      func:()=>{
option_active = 'IRL hand/shoulder scale';
      },
      goto_event: { branch_index:mocap_options_branch, step:hand_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.IRL_hand_shoulder_scale') + ((option_active=='IRL hand/shoulder scale')?' (' +  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.press_to_change_value') + ')' :'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.IRL_hand_shoulder_scale.tooltip')
);
    }
  },
  { key:3, event_id: {
      func:()=>{
option_active = 'Depth scale';
      },
      goto_event: { branch_index:mocap_options_branch, step:hand_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.depth_scale') + ((option_active=='Depth scale')?' (' +  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.press_to_change_value') + ')' :'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.depth_adjustment.depth_scale.tooltip')
);
    }
  },
  { key:4, event_id: {
      func:()=>{
if (--System._browser.camera.handpose.stabilize_arm < 0)
  System._browser.camera.handpose.stabilize_arm = 2
      },
      goto_event: { branch_index:mocap_options_branch, step:hand_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.arm_stabilization') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.arm_stabilization.tooltip')
);
    }
  },
  { key:5, event_id: {
      func:()=>{
if (!System._browser.camera.handpose.stabilize_arm_time) {
  System._browser.camera.handpose.stabilize_arm_time = 1;
}
else if (System._browser.camera.handpose.stabilize_arm_time == 1) {
  System._browser.camera.handpose.stabilize_arm_time = 100;
}
else if (System._browser.camera.handpose.stabilize_arm_time == 100) {
  System._browser.camera.handpose.stabilize_arm_time = 200;
}
else {
  System._browser.camera.handpose.stabilize_arm_time = 0;
}
      },
      goto_event: { branch_index:mocap_options_branch, step:hand_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.arm_stabilization.time_to_stabilize') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.arm_stabilization.time_to_stabilize.tooltip')
);
    }
  },
  { key:6, event_id: {
      goto_event: { branch_index:mocap_options_branch, step:hand_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.hand_stabilization') + ' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.hand_stabilization.press_to_change_value') + '):\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.hand_stabilization.tooltip')
);
    }
  },
  { key:7, event_id: {
      func:()=>{
System._browser.camera.handpose.constrain_tracking_region = !System._browser.camera.handpose.constrain_tracking_region;
      },
      goto_event: { branch_index:mocap_options_branch, step:hand_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.constrain_tracking_region') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.constrain_tracking_region.tooltip')
);
    }
  },
  { key:8, event_id: {
      func:()=>{
System._browser.camera.handpose.use_hands_worker = !System._browser.camera.handpose.use_hands_worker;
      },
      goto_event: { branch_index:mocap_options_branch, step:hand_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.standalone_web_worker') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.hand_tracking_options.standalone_web_worker.tooltip')
);
    }
  },
  { key:9, is_closing_event:true, branch_index:done_branch }
  ]
            }
          };
        })(),
// 7
        {
          message: {
get content() {
  const tilt_adjustment = MMD_SA.MMD.motionManager.para_SA.motion_tracking?.camera?.tilt_adjustment || System._browser.camera.tilt_adjustment;
  return [
    System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.webcam_angle_offset'),
    ((tilt_adjustment.enabled) ? '- ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.webcam_angle_offset.press_to_adjust_offset_angle') : ''),
    ((tilt_adjustment.enabled) ? '- ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.webcam_angle_offset.press_to_adjust_weighting_applied') : ''),
    '1. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.webcam_angle_offset.tilt_adjustment') + ': ' + ((tilt_adjustment.enabled) ? 'ON' : 'OFF'),
    ((tilt_adjustment.enabled) ? '    ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.webcam_angle_offset.angle') + ': ' + (tilt_adjustment.angle) + '° ⬆️⬇️' : ''),
    ((tilt_adjustment.enabled) ? '    ┗ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.webcam_angle_offset.weighting_body') + ': ' + Math.round(tilt_adjustment.pose_weight * 100) + '% ⬅️➡️' : ''),
    '2. ' + System._browser.translation.get('Misc.done'),
  ].filter(v=>v).join('\n');
},
bubble_index: 3,
branch_list: [
  { key:'any', func:(e)=>{
const tilt_adjustment = MMD_SA.MMD.motionManager.para_SA.motion_tracking?.camera?.tilt_adjustment || System._browser.camera.tilt_adjustment;
if (/Arrow(Up|Down)/.test(e.code)) {
  let a = tilt_adjustment.angle;
  a += (e.code == 'ArrowUp') ? 1 : -1;
  if (Math.abs(a) > 90)
    a = Math.sign(a) * 90;
  tilt_adjustment.angle = a;
}
else if (/Arrow(Left|Right)/.test(e.code)) {
  let p = Math.round(tilt_adjustment.pose_weight * 100);
  p += (e.code == 'ArrowRight') ? 1 : -1;
  tilt_adjustment.pose_weight = Math.min(Math.max(p,-100),100)/100;
}
else {
  return false;
}

MMD_SA_options.Dungeon.run_event(null,null,tilt_page_index);

return true;
  } },
  { key:1, event_id: {
      func:()=>{
const tilt_adjustment = MMD_SA.MMD.motionManager.para_SA.motion_tracking?.camera?.tilt_adjustment || System._browser.camera.tilt_adjustment;
tilt_adjustment.enabled = !tilt_adjustment.enabled;
      },
      goto_event: { branch_index:mocap_options_branch, step:tilt_page_index },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.webcam_angle_offset.tooltip')
);
    }
  },
  { key:2, is_closing_event:true, branch_index:done_branch }
],
          }
        },
      ];
})()

// 30
     ,[
        {
          func: function () {
MMD_SA_options.user_camera.ML_models.pose.use_legIK = !MMD_SA_options.user_camera.ML_models.pose.use_legIK;
if (MMD_SA_options.user_camera.ML_models.pose.use_legIK) {
  System._browser.camera.poseNet.frames.remove('skin', '左ひざ');
  System._browser.camera.poseNet.frames.remove('skin', '右ひざ');
}
          }
         ,goto_event: { branch_index:mocap_options_branch, step:1 }
        }
      ]
// 31
     ,[]
// 32
     ,[
        {
          func: function () {
System._browser.camera.poseNet.auto_grounding = !System._browser.camera.poseNet.auto_grounding;
          }
         ,goto_event: { branch_index:mocap_options_branch, step:1 }
        }
      ]
// 33
     ,[
        {
          func: function () {
const camera = System._browser.camera;
if (!camera.poseNet.enabled) {
  DEBUG_show('(Body mocap only)', 2);
  return;
}
if (!camera.video || (camera.video.pause && !camera.video.paused)) {
  DEBUG_show('(Paused video input required)', 2);
  return;
}
if (!camera.poseNet._bb) {
  DEBUG_show('(No bounding box to clear)', 2);
  return;
}

System._browser.camera.poseNet.bb_clear = 15
          }
         ,goto_branch: mocap_options_branch
        }
      ]

// 34
     ,(()=>{
        const branch_list_common = [
    { key:'any', func:(e)=>{
if (adjust_eye_bone_rotation(e)) {
  MMD_SA_options.Dungeon.run_event(null,facemesh_options_branch,0);
  return true;
}
return false;
      }
    },
    { key:1, branch_index:facemesh_options_branch+2,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.eye_tracking.tooltip')
);
      }
    },
    { key:2, branch_index:facemesh_options_branch+1,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.blink_LR_sync.tooltip')
);
      }
    },
    { key:3, event_id:{ func:()=>{ System._browser.camera.facemesh.auto_blink = !System._browser.camera.facemesh.auto_blink; }, goto_branch:facemesh_options_branch },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.auto_blink.tooltip')
);
      }
    },
    { key:4, event_id:{ func:()=>{ System._browser.camera.facemesh.auto_look_at_camera = !System._browser.camera.facemesh.auto_look_at_camera; }, goto_branch:facemesh_options_branch },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.auto_look_at_camera.tooltip').replace(/\<hotkey\>/, System._browser.hotkeys.config_by_id['auto_look_at_camera']?.accelerator[0]||'')
);
      }
    },
    { key:5, event_id:{ func:()=>{}, goto_branch:facemesh_options_branch },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.eye_bone_rotation.tooltip')
);
      }
    },
    { key:6, event_id:{ func:()=>{
if (++System._browser.camera.facemesh.mouth_tracking_sensitivity > 3)
  System._browser.camera.facemesh.mouth_tracking_sensitivity = 0;
      }, goto_branch:facemesh_options_branch },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.mouth_tracking_sensitivity.tooltip')
);
      }
    },
    { key:7, event_id:{ func:()=>{
if (++System._browser.camera.facemesh.lean_tracking > 3)
  System._browser.camera.facemesh.lean_tracking = 0;
      }, goto_branch:facemesh_options_branch },
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.lean_tracking.tooltip')
);
      }
    },
    { key:8, event_index:2,
      onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.tooltip')
);
      }
    },
        ];

        function branch_list() {
return [
    ...branch_list_common,
    ...((System._browser.camera.facemesh.enabled && System._browser.camera.video) ? [{
  key:9, event_index:1,
  onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.calibration_options.tooltip')
);
  }
    }] : []),
    { key:'X', is_closing_event:true, branch_index:done_branch },
];
        }

        function adjust_eye_bone_rotation(e) {
if ((e.key == '+') || (e.key == '-')) {
  const v = (e.key == '+') ? 2 : -2;
  System._browser.camera.facemesh.eye_bone_rotation_percent = THREE.Math.clamp(System._browser.camera.facemesh.eye_bone_rotation_percent + v, 0,200);
  MMD_SA.SpeechBubble.list[1].hide();
  return true;
}
return false;
        }

        return [
// 0
        {
          message: {
  get content() {
const camera = System._browser.camera;

let lean_tracking;
switch (System._browser.camera.facemesh.lean_tracking) {
  case 1:
    lean_tracking = 'Min';
    break;
  case 2:
    lean_tracking = 'Normal';
    break;
  case 3:
    lean_tracking = 'Max';
    break;
}
if (lean_tracking)
  lean_tracking = System._browser.translation.get('Misc.' + lean_tracking);

let mouth_tracking_sensitivity;
switch (System._browser.camera.facemesh.mouth_tracking_sensitivity) {
  case 1:
    mouth_tracking_sensitivity = 'High';
    break;
  case 2:
    mouth_tracking_sensitivity = 'Very high';
    break;
  case 3:
    mouth_tracking_sensitivity = 'Max';
    break;
  default:
    mouth_tracking_sensitivity = 'Normal';
}
mouth_tracking_sensitivity = System._browser.translation.get('Misc.' + mouth_tracking_sensitivity);

return [
  '1. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.eye_tracking') + ': ' + ((!System._browser.camera.facemesh.eye_tracking)?'OFF':'ON'),
  '2. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.blink_LR_sync') + ': ' + ((!System._browser.camera.facemesh.blink_sync)?'OFF':'ON'),
  '3. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.auto_blink') + ': ' + ((!System._browser.camera.facemesh.auto_blink)?'OFF':'ON'),
  '4. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.auto_look_at_camera') + ' (' + (System._browser.hotkeys.config_by_id['auto_look_at_camera']?.accelerator[0]||'') + '): ' + ((!System._browser.camera.facemesh.auto_look_at_camera)?'OFF':'ON'),
  '5. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.eye_bone_rotation') + ': ' + (System._browser.camera.facemesh.eye_bone_rotation_percent + '%') + '➕➖',
  '6. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.mouth_tracking_sensitivity') + ': ' + mouth_tracking_sensitivity,
  '7. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.lean_tracking') + ': ' + (lean_tracking || 'OFF'),
  '8. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options') + ' ▶️',
  ...((System._browser.camera.facemesh.enabled && System._browser.camera.video) ? ['9. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.calibration_options') + ' ▶️'] : []),
  'X. ' + System._browser.translation.get('Misc.done'),
].join('\n');
  }
 ,para: { row_max:11  }
 ,bubble_index: 3
 ,get branch_list() {
return branch_list();
  },
          }
        },
// 1
        {
          message: {
get content() { return System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.calibration_options.message'); },
index: 1,
bubble_index: 3,
get branch_list() {
  return branch_list().concat([
  { key:'A', branch_index:facemesh_options_branch+3 },
  { key:'B', branch_index:facemesh_options_branch+4 },
  { key:'C', branch_index:facemesh_options_branch+5 },
  ]);
},
          }
        },
// 2
        (()=>{
          let option_active = 'General weighting';

          const options = ['General weighting', 'Joy/Fun', 'Angry', 'Sorrow', 'Surprised', 'Tongue out', 'Others'];

          const _branch_list = [
  { key:'any', func:(e)=>{
if (adjust_eye_bone_rotation(e)) {
  MMD_SA_options.Dungeon.run_event(null,facemesh_options_branch,0);
  return true;
}

if (/Arrow(Up|Down)/.test(e.code)) {
  let index = options.findIndex(v=>v==option_active);
  index -= (e.code == 'ArrowUp') ? 1 : -1;
  if (index < 0) {
    index = options.length-1;
  }
  else if (index > options.length-1) {
    index = 0;
  }
  option_active = options[index];
}
else if (/Arrow(Left|Right)/.test(e.code)) {
  const v = (e.code == 'ArrowRight') ? 1 : -1;
  switch (option_active) {
    case 'General weighting':
System._browser.camera.facemesh.emotion_weight_percent = THREE.Math.clamp(System._browser.camera.facemesh.emotion_weight_percent + v, 0,100);
      break;
    case 'Joy/Fun':
System._browser.camera.facemesh.emotion_joy_fun_percent = THREE.Math.clamp(System._browser.camera.facemesh.emotion_joy_fun_percent + v, 0,100);
      break;
    case 'Angry':
System._browser.camera.facemesh.emotion_angry_percent = THREE.Math.clamp(System._browser.camera.facemesh.emotion_angry_percent + v, 0,100);
      break;
    case 'Sorrow':
System._browser.camera.facemesh.emotion_sorrow_percent = THREE.Math.clamp(System._browser.camera.facemesh.emotion_sorrow_percent + v, 0,100);
      break;
    case 'Surprised':
System._browser.camera.facemesh.emotion_surprised_percent = THREE.Math.clamp(System._browser.camera.facemesh.emotion_surprised_percent + v, 0,100);
      break;
    case 'Tongue out':
System._browser.camera.facemesh.emotion_tongue_out_percent = THREE.Math.clamp(System._browser.camera.facemesh.emotion_tongue_out_percent + v, 0,100);
      break;
    case 'Others':
System._browser.camera.facemesh.emotion_others_percent = THREE.Math.clamp(System._browser.camera.facemesh.emotion_others_percent + v, 0,100);
      break;
    default:
      return false;
  }
}
else {
  return false;
}

MMD_SA_options.Dungeon.run_event(null,facemesh_options_branch,2);

return true;
  } },
  { key:'A', event_id: {
      func:()=>{
option_active = 'General weighting';
      },
      goto_event: { branch_index:facemesh_options_branch, step:2 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.general_weighting') + ((option_active=='General weighting')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.general_weighting.tooltip')
);
    }
  },
  { key:'B', event_id: {
      func:()=>{
option_active = 'Joy/Fun';
      },
      goto_event: { branch_index:facemesh_options_branch, step:2 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.joy_fun') + ((option_active=='Joy/Fun')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.joy_fun.tooltip')
);
    }
  },
  { key:'C', event_id: {
      func:()=>{
option_active = 'Angry';
      },
      goto_event: { branch_index:facemesh_options_branch, step:2 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.angry') + ((option_active=='Angry')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.angry.tooltip')
);
    }
  },
  { key:'D', event_id: {
      func:()=>{
option_active = 'Sorrow';
      },
      goto_event: { branch_index:facemesh_options_branch, step:2 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.sorrow') + ((option_active=='Sorrow')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.sorrow.tooltip')
);
    }
  },
  { key:'E', event_id: {
      func:()=>{
option_active = 'Surprised';
      },
      goto_event: { branch_index:facemesh_options_branch, step:2 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.surprised') + ((option_active=='Surprised')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.surprised.tooltip')
);
    }
  },
  { key:'F', event_id: {
      func:()=>{
option_active = 'Tongue out';
      },
      goto_event: { branch_index:facemesh_options_branch, step:2 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.tongue_out') + ((option_active=='Tongue out')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.tongue_out.tooltip')
);
    }
  },
  { key:'G', event_id: {
      func:()=>{
option_active = 'Others';
      },
      goto_event: { branch_index:facemesh_options_branch, step:2 },
    },
    onmouseover: function (e) {
MMD_SA_options.Dungeon.utils.tooltip(
  e.clientX, e.clientY,
  System._browser.translation.get('Misc.others') + ((option_active=='Others')?' (' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.press_to_change_value.short') + ')':'') + ':\n' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.others.tooltip')
);
    }
  },
          ];

          return {
            message: {
  get content() {
    return [
System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.emotion_tracking'),
//'・Press ⬆️⬇️ to switch option',
'・' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.press_to_change_value'),
'A. ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.general_weighting') + ': ' + ((System._browser.camera.facemesh.emotion_weight_percent == 0) ? 'OFF' : System._browser.camera.facemesh.emotion_weight_percent + '%') + ((option_active=='General weighting')?'⬅️➡️':''),
'B. ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.joy_fun') + ': ' + ((System._browser.camera.facemesh.emotion_weight_percent == 0) ? 'N/A' : System._browser.camera.facemesh.emotion_joy_fun_percent + '%') + ((option_active=='Joy/Fun')?'⬅️➡️':''),
'C. ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.angry') + ': ' + ((System._browser.camera.facemesh.emotion_weight_percent == 0) ? 'N/A' : System._browser.camera.facemesh.emotion_angry_percent + '%') + ((option_active=='Angry')?'⬅️➡️':''),
'D. ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.sorrow') + ': ' + ((System._browser.camera.facemesh.emotion_weight_percent == 0) ? 'N/A' : System._browser.camera.facemesh.emotion_sorrow_percent + '%') + ((option_active=='Sorrow')?'⬅️➡️':''),
'E. ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.surprised') + ': ' + ((System._browser.camera.facemesh.emotion_weight_percent == 0) ? 'N/A' : System._browser.camera.facemesh.emotion_surprised_percent + '%') + ((option_active=='Surprised')?'⬅️➡️':''),
'F. ┣ ' + System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.emotion_tracking_options.tongue_out') + ': ' + ((System._browser.camera.facemesh.emotion_weight_percent == 0) ? 'N/A' : System._browser.camera.facemesh.emotion_tongue_out_percent + '%') + ((option_active=='Tongue out')?'⬅️➡️':''),
'G. ┗ ' + System._browser.translation.get('Misc.others') + ': ' + ((System._browser.camera.facemesh.emotion_weight_percent == 0) ? 'N/A' : System._browser.camera.facemesh.emotion_others_percent + '%') + ((option_active=='Others')?'⬅️➡️':''),
    ].join('\n');
  },
  index: 1,
  bubble_index: 3,
  para: { row_max:10 },
  get branch_list() {
    return _branch_list.concat(branch_list().filter(b=>b.key != 'any'));
  },
            }
          };
        })(),

        ];
      })()
// 35
     ,[
        {
          func: function () {
System._browser.camera.facemesh.blink_sync = !System._browser.camera.facemesh.blink_sync;
          }
         ,goto_branch: facemesh_options_branch
        }
      ]
// 36
     ,[
        {
          func: function () {
System._browser.camera.facemesh.eye_tracking = !System._browser.camera.facemesh.eye_tracking;
          }
         ,goto_branch: facemesh_options_branch
        }
      ]
// 37
     ,[
        {
          func: function () {
System._browser.camera.facemesh.reset_calibration(true);
MMD_SA_options.Dungeon.run_event(null,done_branch,0);
          }
        }
      ]
// 38
     ,[
        {
          func: function () {
MMD_SA.SpeechBubble.list[1].hide();
window.addEventListener('SA_dragdrop_JSON', onDrop_JSON_change_facemesh_calibration);
          }
         ,message: {
  get content() { return System._browser.translation.get('XR_Animator.UI.motion_capture.mocap_options.face_tracking_options.calibration_options.import_calibration'); }
 ,bubble_index: 3
 ,branch_list: [
    { key:1, is_closing_event:true, branch_index:done_branch }
  ]
          }
        }
      ]
// 39
     ,[
        {
          func: function () {
const facemesh = System._browser.camera.facemesh;

if (!facemesh.calibrated) {
//  System._browser.on_animation_update.add(()=>{MMD_SA.SpeechBubble.message(0, 'Calibration needs to be complete before it can be exported.', 3*1000);}, 0,0);
  System._browser.camera.DEBUG_show('(Calibration needs to be complete before it can be exported.)', 5); MMD_SA_options.Dungeon.run_event(null, facemesh_options_branch, 0); return;
}
else {
  facemesh.export_calibration();
}
MMD_SA_options.Dungeon.run_event(null,done_branch,0);
          }
        }
      ]

// 40
     ,[
        {
          func: function () {
if (1) {
  MMD_SA_options.Dungeon.run_event(null,done_branch,0)
  MMD_SA.SpeechBubble.message(0, '(🚧 Work in progress 🚧)', 3*1000)
}
else if (!webkit_electron_mode) {
  MMD_SA_options.Dungeon.run_event(null,done_branch,0)
  MMD_SA.SpeechBubble.message(0, 'This option is for native app mode only.', 3*1000)
}
else {
  MMD_SA_options.Dungeon.run_event()
}
          }
        }
       ,{
          message: {
  content: '1. Virtual mouse\n2. Game 01 (PSO2NGS) \n3. Cancel'
 ,bubble_index: 3
 ,branch_list: [
  { key:1, branch_index:motion_control_branch+1 },
  { key:2, branch_index:motion_control_branch+2 },
  { key:3, is_closing_event:true, branch_index:done_branch }
  ]
          }
        }
      ]
// 41
     ,[
        {
          func: function () {
System._browser.motion_control.virtual_mouse.enabled = true
System._browser.motion_control.enabled = true
MMD_SA.SpeechBubble.message(0, 'Hold an index-up gesture for 1 second to start, flipped backward for 1 second to end.', 3*1000)
          }
         ,ended: true
        }
      ]
// 42
     ,[
        {
          func: function () {
System._browser.motion_control.game01.enabled = true
System._browser.motion_control.enabled = true
MMD_SA.SpeechBubble.message(0, 'Hold an index-up gesture for 1 second to start, flipped backward for 1 second to end.', 3*1000)
          }
         ,ended: true
        }
      ]

];
    })()

  }

 ,skydome: {
    texture_path_list: [
//  System.Gadget.path + "/images/_dungeon/tex/ryntaro_nukata/angel_staircase.jpg"
//  System.Gadget.path + "/images/_dungeon/tex/ryntaro_nukata/blue_sky.jpg"
//  System.Gadget.path + "/images/_dungeon/tex/ryntaro_nukata/unknown_planet_v00_c95.jpg"

// ,'F:\\MMD\\stages\\Sky Dome\\スカイドームF2配布データVer1.3\\Skydome_F2_Ver1.3\\F201.jpg'
    ]
//   ,fog: {}
  }

 ,options_by_area_id: {
    "start": {

  RDG_options: {

    width:  1
   ,height: 1
   ,grid_array: [[2]]

/*
    width:  50,
    height: 50,
    minRoomSize: 3,
    maxRoomSize: 10
,DG_room_count: 10
*/
  }

 ,grid_size: 64 *10 *5

 ,floor_material_index_default: -1
 ,wall_material_index_default: -1
 ,ceil_material_index_default: -1

 ,ambient_light_color: "#FFF"
 ,light_color: '#606060'

 ,skydome: {
    visible: false
  }

// ,no_camera_collision: true
 ,camera_y_default_non_negative: false

 ,object_list: [
    {object_index:0},
// roomba
//    {object_index:1}
  ]

 ,events: {
    "onstart": [
      [
        {
          func: function () {
MMD_SA_options.Dungeon_options.character_movement_disabled = true
return true
          }
        }
/*
       ,{
  objects: {
    "object0_0": { hidden:false }
  }
 ,next_step: {}
        }
*/
/*
       ,{
  follow_PC: {
    "object0_0": {pos_base:{x:0,y:5,z:0}}
  }
 ,next_step: {}
        }
       ,{
          func: function () {
MMD_SA_options.Dungeon.character.pos_update()
MMD_SA_options.Dungeon.object_base_list[0].object_list[0]._obj.updateMatrix()
return true
          }
        }
*/
      ]
    ]

   ,"circle_2m_show": [
      [
/*
        {
  objects: {
    "object0_0": {
  placement: { hidden:false }
 ,func: function (obj) {
obj._zoom_scale_update_ = function () {
  var circle_2m = obj._obj
  var zoom_scale = MMD_SA.WebXR.zoom_scale
  circle_2m.scale.set(zoom_scale,1,zoom_scale)
  circle_2m.updateMatrix()
};
window.addEventListener("SA_AR_zoom_scale_update", obj._zoom_scale_update_);
  }
    }
  }
 ,next_step: {}
        }
*/

        {
          func: function () {
var circle_2m = MMD_SA.WebXR._circle_2m
circle_2m.position.copy(THREE.MMD.getModels()[0].mesh.position).y += 0.1
circle_2m.visible = true

circle_2m._zoom_scale_update_ = function () {
  var zoom_scale = MMD_SA.WebXR.zoom_scale
  circle_2m.scale.set(zoom_scale,1,zoom_scale)
//  circle_2m.updateMatrix()
};
window.addEventListener("SA_AR_zoom_scale_update", circle_2m._zoom_scale_update_);
return true;
          }
        }

      ]
    ]

   ,"circle_2m_hide": [
      [
/*
        {
  objects: {
    "object0_0": {
  placement: { hidden:true }
 ,func: function (obj) {
window.removeEventListener("SA_AR_zoom_scale_update", obj._zoom_scale_update_);
  }
    }
  }
 ,next_step: {}
        }
*/

        {
          func: function () {
var circle_2m = MMD_SA.WebXR._circle_2m
circle_2m.visible = false

window.removeEventListener("SA_AR_zoom_scale_update", MMD_SA.WebXR._circle_2m._zoom_scale_update_);
window.addEventListener("SA_AR_zoom_scale_update", circle_2m._zoom_scale_update_);
return true;
          }
        }

      ]
    ]

  }

    }
  }

};

MMD_SA_options.Dungeon_options.options_by_area_id.start.floor_material_index_default = MMD_SA_options.Dungeon_options.grid_material_list.length-1;
MMD_SA_options.Dungeon_options.options_by_area_id.start.wall_material_index_default = MMD_SA_options.Dungeon_options.grid_material_list.length-1;
MMD_SA_options.Dungeon_options.options_by_area_id.start.ceil_material_index_default = MMD_SA_options.Dungeon_options.grid_material_list.length-1;

MMD_SA_options.Dungeon_options.options_by_area_id.start.para_by_grid_id = { '2':{ ground_y:0, ground_y_visible:0 } };

//MMD_SA_options.Dungeon_options = null;
// END


  window.addEventListener("MMDStarted", function () {
MMD_SA.custom_action_default["cover_undies"].action._condition = function (is_bone_action, objs, _default) {
  if (/i\-shaped_balance/.test(MMD_SA.MMD.motionManager.filename) && (MMD_SA._ry > 1)) return true;

  return _default;
};

const use_THREEX = MMD_SA.THREEX.enabled;
const THREE = MMD_SA.THREEX.THREE;

let geometry = new THREE.PlaneGeometry(MMD_SA_options.Dungeon_options.options_by_area_id.start.grid_size*2, MMD_SA_options.Dungeon_options.options_by_area_id.start.grid_size*2);
/*
let tex = document.createElement("canvas")
tex.width = tex.height = 1
//let tex_context = tex.getContext("2d")
//tex_context.fillStyle = "rgba(0,0,0,0)"
//tex_context.fillRect(0,0,1,1)
tex = new THREE.Texture(tex)
tex.needsUpdate = true
*/
let material = (use_THREEX) ? new THREE.ShadowMaterial() : new THREE.MeshBasicMaterial({ color: 0x000000, transparent:true });//false });//
geometry.applyMatrix(new THREE.Matrix4().makeRotationX(THREE.Math.degToRad(-90)));
let ground = MMD_SA.WebXR.ground_plane = new THREE.Mesh(geometry, material);
ground.receiveShadow = true;
if (!use_THREEX) ground.receiveShadowAlpha = true;
MMD_SA.THREEX.scene.add(ground)

let wall_geo = new THREE.BoxGeometry(30,30,30);
wall_geo.applyMatrix(new THREE.Matrix4().makeTranslation(0,10,-15));
let wall = MMD_SA.WebXR._wall = new THREE.Mesh(wall_geo, material);
wall.receiveShadow = true;
if (!use_THREEX) {
  wall.useQuaternion = true;
  wall.receiveShadowAlpha = true;
}
MMD_SA.THREEX.scene.add(wall)

window.addEventListener("SA_MMD_toggle_shadowMap", function () {
  ground.receiveShadow = wall.receiveShadow = MMD_SA_options.use_shadowMap;
  if (!use_THREEX) ground.receiveShadowAlpha = wall.receiveShadowAlpha = MMD_SA_options.use_shadowMap;
  material.opacity = (MMD_SA_options.use_shadowMap) ? 0.5 : 0
  material.needsUpdate = true
});

// can be updated only AFTER scene.add
wall.visible = false
material.opacity = 0.5

let circle_2m_geometry = new THREE.RingGeometry(19.5, 20.5, 24, 1);
circle_2m_geometry.applyMatrix(new THREE.Matrix4().makeRotationX(THREE.Math.degToRad(-90)));
let circle_2m_material = new THREE.MeshBasicMaterial({ color:0xDC143C });
let circle_2m = MMD_SA.WebXR._circle_2m = new THREE.Mesh(circle_2m_geometry, circle_2m_material);
MMD_SA.THREEX.scene.add(circle_2m);
circle_2m_material.opacity = 0.5;
circle_2m.visible = false;


MMD_SA_options.WebXR.AR.item_reticle_id = "reticle"
Object.defineProperty(MMD_SA.WebXR, "_item_reticle", {
  get: function () {
    let item_reticle_id = MMD_SA_options.WebXR.AR.item_reticle_id
    return MMD_SA_options.Dungeon.inventory.list.find((item)=>item.item_id==item_reticle_id);
  }
});

window.addEventListener("SA_Dungeon_onstart", function () {

const THREE = self.THREE;

let v3a = new THREE.Vector3()
let v3b = new THREE.Vector3()
let v3c = new THREE.Vector3()

let _camera_position = new THREE.Vector3()
let _timestamp

window.addEventListener("SA_MMD_model0_onmotionplaying", function (e) {
  var model_mesh = THREE.MMD.getModels()[0].mesh
  if (!model_mesh.visible)
    return

  var mm = MMD_SA.MMD.motionManager
  if (!/standmix2_modified/.test(mm.filename))
    return

  if (MMD_SA.WebXR.user_camera.visible)
    return

  if (!MMD_SA.WebXR.session)
    return;

  var AR_options = MMD_SA_options.WebXR.AR
  var d = MMD_SA_options.Dungeon;
  var dis = v3a.copy(MMD_SA.camera_position).setY(0).distanceTo(v3b.copy(model_mesh.position).setY(0))/10 / MMD_SA.WebXR.zoom_scale;
  var speed = 0, cam_mov;
  if (_camera_position) {
    speed = (_camera_position.distanceTo(v3a)/10 / MMD_SA.WebXR.zoom_scale) / ((RAF_timestamp - _timestamp)/1000);
//DEBUG_show(speed)
    cam_mov = v3c.copy(_camera_position).sub(v3a);
  }

  _camera_position.copy(v3a)
  _timestamp = RAF_timestamp

  if (AR_options._skip_charging_count && --AR_options._skip_charging_count) return;
  if ((dis > 0.75) || (speed < 1)) return;

  var cam_dir = v3a.sub(v3b)
//  speed && cam_mov && DEBUG_show(cam_mov.angleTo(cam_dir));return;
  if (Math.abs(cam_mov.angleTo(cam_dir)) > Math.PI/4) return;

  if (AR_options._wallhit) {
    MMD_SA_options._motion_shuffle_list = [MMD_SA_options.motion_index_by_name["emote-mod_おどろく1"]]
    MMD_SA_options.motion_shuffle_list_default = null
    MMD_SA._force_motion_shuffle = true
    d.sound.audio_object_by_name["anime_wow"].play(model_mesh)
    return
  }

  var angle_y = Math.atan2(cam_dir.x,cam_dir.z) - v3b.setEulerFromQuaternion(model_mesh.quaternion).y

  if (Math.abs(angle_y) < Math.PI/2) {
    // use ._motion_shuffle_list instead, because we have multiple motions running in order, but .motion_shuffle_list_default can be shuffled.
    MMD_SA_options._motion_shuffle_list = [MMD_SA_options.motion_index_by_name["w01_すべって尻もち"], MMD_SA_options.motion_index_by_name["女の子座り→立ち上がる_gumi_v01"]]
    MMD_SA_options.motion_shuffle_list_default = null
    MMD_SA._force_motion_shuffle = true
  }
  else {
    // use ._motion_shuffle_list instead, because we have multiple motions running in order, but .motion_shuffle_list_default can be shuffled.
    MMD_SA_options._motion_shuffle_list = [MMD_SA_options.motion_index_by_name["r01_普通に転ぶ"], MMD_SA_options.motion_index_by_name["OTL→立ち上がり"]]
    MMD_SA_options.motion_shuffle_list_default = null
    MMD_SA._force_motion_shuffle = true
  }

  d.sound.audio_object_by_name["hit-3"].play(model_mesh)
});

if (MMD_SA.WebXR._item_reticle)
  document.getElementById("Ldungeon_inventory_item" + MMD_SA.WebXR._item_reticle.index + "_icon").style.opacity = 1;

window.addEventListener("SA_AR_onSessionStarted", function (e) {
  let item_reticle = MMD_SA.WebXR._item_reticle
  item_reticle._opacity_mod_ = -0.025
  document.getElementById("Ldungeon_inventory_item" + item_reticle.index + "_icon").style.opacity = 1
});

window.addEventListener("SA_AR_onSessionEnd", function (e) {
  document.getElementById("Ldungeon_inventory_item" + MMD_SA.WebXR._item_reticle.index + "_icon").style.opacity = 1
});

window.addEventListener("SA_AR_onARFrame", (function () {
  var timerID

  function item_reticle_flash() {
    timerID = null
    if (!MMD_SA.WebXR.session)
      return

    let item_reticle = MMD_SA.WebXR._item_reticle
    let icon = document.getElementById("Ldungeon_inventory_item" + MMD_SA.WebXR._item_reticle.index + "_icon").style
    let opacity = parseFloat(icon.opacity) + item_reticle._opacity_mod_
    icon.opacity = opacity
    if (opacity >= 1)
      item_reticle._opacity_mod_ = -Math.abs(item_reticle._opacity_mod_)
    else if (opacity <= 0.25)
      item_reticle._opacity_mod_ =  Math.abs(item_reticle._opacity_mod_)
//DEBUG_show(opacity+'/'+item_reticle._opacity_mod_)
  }

  return function (e) {
//    if (!MMD_SA.WebXR.session.domOverlayState) return
    if (!timerID)
      timerID = requestAnimationFrame(item_reticle_flash)
  };
})());


(()=>{
  const v1 = new THREE.Vector3();
  const v2 = new THREE.Vector3();
  const v3 = new THREE.Vector3();
  const q1 = new THREE.Quaternion();

  let camera_locked;
  function camera_lock() {
    const obj = MMD_SA._trackball_camera;

    camera_locked = !camera_locked;
    if (camera_locked) {
      const z = v1.setEulerFromQuaternion(obj.object.quaternion, 'YXZ').z;
      const pos = v2.copy(obj.object.position);
      const target = v3.copy(obj.target);

      MMD_SA.reset_camera(false);
      MMD_SA.Camera_MOD.adjust_camera('camera_lock', pos.sub(obj.object.position), target.sub(obj.target), z);
      MMD_SA.reset_camera();

      MMD_SA.THREEX.camera.control.enabled = false;
    }
    else {
      MMD_SA.Camera_MOD.adjust_camera('camera_lock', v1.set(0,0,0), v2.set(0,0,0), 0);
      MMD_SA.THREEX.camera.control.enabled = true;
      MMD_SA.reset_camera();
    }

    DEBUG_show('Camera lock:'+((camera_locked)?'ON':'OFF'), 3);
  }

  const hotkey_config = [
    {
      id: 'switch_motion',
      accelerator: (()=>{
const acc = [];
for (let i = 0; i < 10; i++)
  acc.push('Alt+num'+i, 'Ctrl+num'+i);
return acc;
      })(),
      process: (e)=>{
const ev = e.detail.e;
if (/Numpad(\d)/.test(ev.code) && (ev.altKey||ev.ctrlKey)) {
  const num = parseInt(RegExp.$1);
// e.detail.alt_location
  const motion_index = (num == 0) ? -1 : (num-1) + ((ev.altKey) ? 0 : 9);
//DEBUG_show(motion_index+'/'+Date.now(),0,1)
  MMD_SA_options.Dungeon_options.item_base.pose._change_motion_(motion_index, true);
}
      }
    },

    {

      id: 'switch_avatar_model',
      accelerator: (()=>{
const acc = [];
for (let i = 1; i <= 4; i++)
  acc.push('Alt+'+i);
return acc;
      })(),
      global_disabled: true,
      process: (e)=>{
const ev = e.detail.e;
const index = parseInt(ev.code.replace(/\D+/g, ''))-1;
const model_index = MMD_SA.THREEX.models.findIndex(m=>m.index_default==index);
if (model_index != -1) {
  MMD_SA.THREEX.VRM.swap_model(model_index);
}
else {
  const path = MMD_SA_options.THREEX_options.model_path_extra?.[index-1];
  if (path) {
    SA_DragDropEMU(path);
  }
  else {
    DEBUG_show('(No extra model available)', 3);
  }
}
      }
    },

    {
      id: 'mocap_auto_grounding',
      accelerator: ['Ctrl+G'],
      process: (e)=>{
System._browser.camera.poseNet.auto_grounding = !System._browser.camera.poseNet.auto_grounding;
DEBUG_show('Mocap auto-grounding:' + ((System._browser.camera.poseNet.auto_grounding) ? 'ON' : 'OFF'), 3);
      }
    },

    {
      id: 'camera_3D_lock',
      accelerator: ['Ctrl+L'],
      global_disabled: true,
      process: (e)=>{
camera_lock();
      }
    },

    {
      id: 'mirror_pose',
      accelerator: ['Ctrl+M'],
      global_disabled: true,
      process: (e)=>{
MMD_SA_options._XRA_mirror_pose();
      }
    },

    {
      id: 'hand_camera',
      accelerator: ['Ctrl+H'],
      process: (e)=>{
MMD_SA_options.Dungeon.item_base.hand_camera.action.func();
      }
    },

    {
      id: 'selfie_mode',
      accelerator: ['Alt+S'],
      process: (e)=>{
const m = !MMD_SA_options.Dungeon_options.item_base.hand_camera.selfie_mode;
MMD_SA_options.Dungeon_options.item_base.hand_camera.selfie_mode = m;
System._browser.camera.DEBUG_show('Selfie mode: ' + ((m)?'ON':'OFF'), 5);
      }
    },

    {
      id: 'auto_look_at_camera',
      accelerator: ['Ctrl+E'],
      process: (e)=>{
System._browser.camera.facemesh.auto_look_at_camera = !System._browser.camera.facemesh.auto_look_at_camera;
DEBUG_show('Auto "look at camera":' + ((System._browser.camera.facemesh.auto_look_at_camera) ? 'ON' : 'OFF'), 3);
      }
    },

    {
      id: 'hip_camera',
      accelerator: ['Alt+H'],
      process: (e)=>{
System._browser.camera.poseNet.hip_camera = !System._browser.camera.poseNet.hip_camera;
      }
    },
  ];

  const hotkey_reserved = [];
  hotkey_config.forEach(k=>k.accelerator.forEach(a=>{ hotkey_reserved.push(a) }));

  System._browser.hotkeys._hotkey_config = System._browser.hotkeys._hotkey_config.concat(hotkey_config);
  System._browser.hotkeys._hotkey_reserved = hotkey_reserved;
//console.log(System._browser.hotkeys._hotkey_config, hotkey_reserved)

  System._browser.hotkeys._hotkey_config.forEach(config=>{
    const _config = MMD_SA_options._XRA_settings_imported?.hotkeys?.configs?.find(c=>c.id==config.id);
    System._browser.hotkeys.add(Object.assign({}, config, _config||{}));
  });

//  if (webkit_electron_mode && (System._browser.hotkeys.is_global !== false)) System._browser.hotkeys.register_global(true);
})();


});

//console.log(ground,material)
  });

  System._browser.hotkeys._hotkey_config = [];

  MMD_SA_options._XRA_settings_export = ()=>{
function custom_motion() {
  const cm = (webkit_electron_mode) ? MMD_SA_options._XRA_pose_list[0].filter(m=>m.is_custom_motion).map(m=>m.path) : [];
  return cm.slice(Math.max(cm.length-10,0));
}

const config = {};

config.user_camera = {
  pixel_limit: {
    current: MMD_SA_options.user_camera.pixel_limit.current,
    disabled: MMD_SA_options.user_camera.pixel_limit.disabled,
  },

  fps: MMD_SA_options.user_camera.fps,

  display: {
    video: { hidden:MMD_SA_options.user_camera.display.video.hidden },
    wireframe: { hidden:MMD_SA_options.user_camera.display.wireframe.hidden },
  },

  ML_models: {
    pose: {
      model_quality: MMD_SA_options.user_camera.ML_models.pose.model_quality,
      z_depth_scale: MMD_SA_options.user_camera.ML_models.pose.z_depth_scale, 
      use_legIK: MMD_SA_options.user_camera.ML_models.pose.use_legIK,
      auto_grounding: System._browser.camera.poseNet.auto_grounding,
      shoulder_tracking: System._browser.camera.poseNet.shoulder_tracking,
      body_bend_reduction_power: System._browser.camera.poseNet.body_bend_reduction_power,
      hip_camera: System._browser.camera.poseNet.hip_camera,
      hip_adjustment_weight_percent: System._browser.camera.poseNet.hip_adjustment_weight_percent,
      hip_adjustment_head_weight_percent: System._browser.camera.poseNet.hip_adjustment_head_weight_percent,
      hip_adjustment_adjust_y_axis_percent: System._browser.camera.poseNet.hip_adjustment_adjust_y_axis_percent,
      hip_adjustment_scale_x_percent: System._browser.camera.poseNet.hip_adjustment_scale_x_percent,
      hip_adjustment_scale_y_percent: System._browser.camera.poseNet.hip_adjustment_scale_y_percent,
      hip_adjustment_head_pitch_rotation_percent: System._browser.camera.poseNet.hip_adjustment_head_pitch_rotation_percent,
      hip_adjustment_scale_z_percent: System._browser.camera.poseNet.hip_adjustment_scale_z_percent,
      hip_adjustment_smoothing_percent: System._browser.camera.poseNet.hip_adjustment_smoothing_percent,
      upper_rotation_offset: MMD_SA_options.user_camera.ML_models.pose.upper_rotation_offset,
      arm_horizontal_offset_percent: System._browser.camera.poseNet.arm_horizontal_offset_percent,
      limb_entry_duration_percent: System._browser.camera.poseNet.limb_entry_duration_percent,
      limb_return_duration_percent: System._browser.camera.poseNet.limb_return_duration_percent,

      body_collider: (()=>{
        const bc = {
          mode:  System._browser.camera.poseNet.body_collider.mode,
        };
        for (const part of ['head','chest','waist','hip'])
          bc[part] = { size_percent:System._browser.camera.poseNet.body_collider[part].size_percent };
        bc.head.reaction_type = System._browser.camera.poseNet.body_collider.head.reaction_type;
        return bc;
      })(),
    },
    hands: {
      stabilize_hand_percent: System._browser.camera.handpose.stabilize_hand_percent,
      stabilize_arm: System._browser.camera.handpose.stabilize_arm,
      stabilize_arm_time: System._browser.camera.handpose.stabilize_arm_time,
      use_hands_worker: System._browser.camera.handpose.use_hands_worker,
      depth_adjustment_percent: MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent,
      palm_shoulder_scale_percent: MMD_SA_options.user_camera.ML_models.hands.palm_shoulder_scale_percent,
      depth_scale_percent: MMD_SA_options.user_camera.ML_models.hands.depth_scale_percent,
      constrain_tracking_region: System._browser.camera.handpose.constrain_tracking_region,
    },
    facemesh: {
      eye_tracking: System._browser.camera.facemesh.eye_tracking,
      blink_sync: System._browser.camera.facemesh.blink_sync,
      auto_blink: System._browser.camera.facemesh.auto_blink,
      auto_look_at_camera: System._browser.camera.facemesh.auto_look_at_camera,
      eye_bone_rotation_percent: System._browser.camera.facemesh.eye_bone_rotation_percent,
      mouth_tracking_sensitivity: System._browser.camera.facemesh.mouth_tracking_sensitivity,
      lean_tracking: System._browser.camera.facemesh.lean_tracking,
      emotion_weight_percent: System._browser.camera.facemesh.emotion_weight_percent,
      emotion_joy_fun_percent: System._browser.camera.facemesh.emotion_joy_fun_percent,
      emotion_angry_percent: System._browser.camera.facemesh.emotion_angry_percent,
      emotion_sorrow_percent: System._browser.camera.facemesh.emotion_sorrow_percent,
      emotion_surprised_percent: System._browser.camera.facemesh.emotion_surprised_percent,
      emotion_tongue_out_percent: System._browser.camera.facemesh.emotion_tongue_out_percent,
      emotion_others_percent: System._browser.camera.facemesh.emotion_others_percent,
    },
    tilt_adjustment: Object.assign({}, System._browser.camera.tilt_adjustment),
    debug_hidden: MMD_SA_options.user_camera.ML_models.debug_hidden,
  },

  streamer_mode: MMD_SA_options.user_camera.streamer_mode,
};

config.model_path_extra = MMD_SA_options.THREEX_options.model_path_extra;

const hotkeys = System._browser.hotkeys;
config.hotkeys = {
  is_global: hotkeys.is_global,

  configs: hotkeys._hotkey_config.map(c=>{
    const _config = { id:c.id };

    const config = hotkeys.config_by_id[c.id];
    const global_disabled = hotkeys.accelerators[config.accelerator[0]].config.global_disabled;
    if (!!global_disabled !== !!c.global_disabled)
      _config.global_disabled = global_disabled;
    if (config.accelerator[0] != c.accelerator[0])
      _config.accelerator = config.accelerator;

    return _config;
  }),
};
config.camera_face_locking = MMD_SA_options.camera_face_locking;
config.audio_visualizer = MMD_SA_options.use_CircularSpectrum;

config.shoulder_adjust = MMD_SA.THREEX.shoulder_adjust;

config.selfie_mode = MMD_SA_options.Dungeon_options.item_base.hand_camera.selfie_mode;
config.hand_camera_fov = MMD_SA_options.Dungeon_options.item_base.hand_camera.fov;

const vc = System._browser.video_capture;
config.video_capture = {
  target_width: vc.target_width,
  target_height: vc.target_height,
  fps: vc.fps,
  target_mime_type: vc.target_mime_type,
};

config.UI_muted = MMD_SA_options.Dungeon.inventory.UI._muted;

config.language = (System._browser.translation.language && (System._browser.translation.language_full != System._browser.translation.language_default)) ? System._browser.translation.language : null;

config.pose = {
  order: MMD_SA_options._XRA_pose_list[0].map(m=>m.index_default),
  custom_motion: custom_motion(),
};

config.PPE = {
  UnrealBloom: {
    params: MMD_SA.THREEX.PPE.UnrealBloom.params,
    params_vrm: MMD_SA.THREEX.PPE.UnrealBloom.params_vrm,
  },
  N8AO: {
    effectController: MMD_SA.THREEX.PPE.N8AO.effectController,
    effectController_vrm: MMD_SA.THREEX.PPE.N8AO.effectController_vrm,
  },
  DOF: {
    effectController: MMD_SA.THREEX.PPE.DOF.effectController,
  },
};

config.VMC = {
  send: {
    port: MMD_SA.OSC.VMC.options.plugin.send.port,
    host: MMD_SA.OSC.VMC.options.plugin.send.host,
  },
  app_mode: MMD_SA.OSC.app_mode,
};

return config;
  };

  window.addEventListener('SA_writeSettings', ()=>{
if (!MMD_SA_options.Dungeon.started) return;

const config = MMD_SA_options._XRA_settings_export();

System.Gadget.Settings.writeString('LABEL_XRA_settings', JSON.stringify(config));
  });

  MMD_SA_options._XRA_settings_import = async (config=MMD_SA_options._XRA_settings_imported)=>{
function shoulder_adjust(p) {
  MMD_SA.THREEX.shoulder_adjust = config[p];

// always use the default (12.5) for MMD shoulder axis
  if (!MMD_SA.THREEX.enabled) return;

  const rot_shoulder_axis = MMD_SA.THREEX._rot_shoulder_axis;
  if (!rot_shoulder_axis[1])
    rot_shoulder_axis[1] = {};
  rot_shoulder_axis[1][ 1] = new THREE.Quaternion().setFromEuler(MMD_SA.THREEX.e1.set(0, 0, ((!MMD_SA.THREEX.shoulder_adjust)?12.5*0.5:((MMD_SA.THREEX.shoulder_adjust=='Full')?12.5:0)) /180*Math.PI));
  rot_shoulder_axis[1][-1] = rot_shoulder_axis[1][ 1].clone().conjugate();

// save some headaches and use the same shoulder adjust for convert_T_pose_rotation_to_A_pose
  if (!rot_shoulder_axis[0])
    rot_shoulder_axis[0] = {};
  rot_shoulder_axis[0][ 1] = rot_shoulder_axis[1][ 1]
  rot_shoulder_axis[0][-1] = rot_shoulder_axis[1][-1]

}

try {
  if (!config) {
    config = System.Gadget.Settings.readString('LABEL_XRA_settings');
    if (!config) return;

    config = JSON.parse(decodeURIComponent(config));
  }

  MMD_SA_options._XRA_settings_imported = config;

  for (const p in config) {
    switch (p) {
      case 'language':
        System._browser.translation.language = config[p];
        break;
    }
  }
  if (!loaded) return;

  if (!MMD_SA.THREEX.THREEX) return;

  for (const p in config) {
    switch (p) {
      case 'shoulder_adjust':
        shoulder_adjust(p);
        break;
    }
  }
  if (!MMD_SA.MMD_started) return;

  for (const p in config) {
    switch (p) {
      case 'user_camera':
        Object.assign(MMD_SA_options.user_camera.pixel_limit, config[p].pixel_limit);
        MMD_SA_options.user_camera.fps = config[p].fps;
        MMD_SA_options.user_camera.display.video.hidden = config[p].display.video.hidden;
        MMD_SA_options.user_camera.display.wireframe.hidden = config[p].display.wireframe.hidden;
        MMD_SA_options.user_camera.ML_models.debug_hidden = config[p].ML_models.debug_hidden;

        MMD_SA_options.user_camera.ML_models.pose.model_quality = config[p].ML_models.pose.model_quality;
        MMD_SA_options.user_camera.ML_models.pose.z_depth_scale = config[p].ML_models.pose.z_depth_scale;
        MMD_SA_options.user_camera.ML_models.pose.use_legIK = config[p].ML_models.pose.use_legIK;
        MMD_SA_options.user_camera.ML_models.pose.upper_rotation_offset = config[p].ML_models.pose.upper_rotation_offset;
        System._browser.camera.poseNet.auto_grounding = config[p].ML_models.pose.auto_grounding;
        System._browser.camera.poseNet.shoulder_tracking = config[p].ML_models.pose.shoulder_tracking;
        System._browser.camera.poseNet.body_bend_reduction_power = config[p].ML_models.pose.body_bend_reduction_power;
        System._browser.camera.poseNet.hip_camera = config[p].ML_models.pose.hip_camera;
        System._browser.camera.poseNet.arm_horizontal_offset_percent = config[p].ML_models.pose.arm_horizontal_offset_percent;
        System._browser.camera.poseNet.limb_entry_duration_percent = config[p].ML_models.pose.limb_entry_duration_percent;
        System._browser.camera.poseNet.limb_return_duration_percent = config[p].ML_models.pose.limb_return_duration_percent;
        System._browser.camera.poseNet.hip_adjustment_weight_percent = config[p].ML_models.pose.hip_adjustment_weight_percent;
        System._browser.camera.poseNet.hip_adjustment_head_weight_percent = config[p].ML_models.pose.hip_adjustment_head_weight_percent;
        System._browser.camera.poseNet.hip_adjustment_adjust_y_axis_percent = config[p].ML_models.pose.hip_adjustment_adjust_y_axis_percent;
        System._browser.camera.poseNet.hip_adjustment_scale_x_percent = config[p].ML_models.pose.hip_adjustment_scale_x_percent;
        System._browser.camera.poseNet.hip_adjustment_scale_y_percent = config[p].ML_models.pose.hip_adjustment_scale_y_percent;
        System._browser.camera.poseNet.hip_adjustment_head_pitch_rotation_percent = config[p].ML_models.pose.hip_adjustment_head_pitch_rotation_percent;
        System._browser.camera.poseNet.hip_adjustment_scale_z_percent = config[p].ML_models.pose.hip_adjustment_scale_z_percent;
        System._browser.camera.poseNet.hip_adjustment_smoothing_percent = config[p].ML_models.pose.hip_adjustment_smoothing_percent;

        System._browser.camera.poseNet.body_collider.mode = config[p].ML_models.pose.body_collider?.mode;
        for (const part of ['head','chest','waist','hip']) System._browser.camera.poseNet.body_collider[part].size_percent = config[p].ML_models.pose.body_collider?.[part]?.size_percent;
        System._browser.camera.poseNet.body_collider.head.reaction_type = config[p].ML_models.pose.body_collider?.head?.reaction_type;

        if (config[p].ML_models.hands.depth_adjustment_percent != null)
          MMD_SA_options.user_camera.ML_models.hands.depth_adjustment_percent = config[p].ML_models.hands.depth_adjustment_percent;
        if (config[p].ML_models.hands.palm_shoulder_scale_percent != null)
          MMD_SA_options.user_camera.ML_models.hands.palm_shoulder_scale_percent = config[p].ML_models.hands.palm_shoulder_scale_percent;
        if (config[p].ML_models.hands.depth_scale_percent != null)
          MMD_SA_options.user_camera.ML_models.hands.depth_scale_percent = config[p].ML_models.hands.depth_scale_percent;
        System._browser.camera.handpose.stabilize_arm = config[p].ML_models.hands?.stabilize_arm;
        System._browser.camera.handpose.stabilize_arm_time = config[p].ML_models.hands?.stabilize_arm_time;
        System._browser.camera.handpose.stabilize_hand_percent = config[p].ML_models.hands?.stabilize_hand_percent;
        System._browser.camera.handpose.constrain_tracking_region = config[p].ML_models.hands?.constrain_tracking_region;
        System._browser.camera.handpose.use_hands_worker = config[p].ML_models.hands?.use_hands_worker;

        System._browser.camera.facemesh.eye_tracking = config[p].ML_models.facemesh.eye_tracking;
        System._browser.camera.facemesh.blink_sync = config[p].ML_models.facemesh.blink_sync;
        System._browser.camera.facemesh.auto_blink = config[p].ML_models.facemesh.auto_blink;
        System._browser.camera.facemesh.auto_look_at_camera = config[p].ML_models.facemesh.auto_look_at_camera;
        System._browser.camera.facemesh.eye_bone_rotation_percent = config[p].ML_models.facemesh.eye_bone_rotation_percent;
        System._browser.camera.facemesh.mouth_tracking_sensitivity = config[p].ML_models.facemesh.mouth_tracking_sensitivity;
        System._browser.camera.facemesh.lean_tracking = config[p].ML_models.facemesh.lean_tracking;
        System._browser.camera.facemesh.emotion_weight_percent = config[p].ML_models.facemesh.emotion_weight_percent;
        System._browser.camera.facemesh.emotion_joy_fun_percent = config[p].ML_models.facemesh.emotion_joy_fun_percent;
        System._browser.camera.facemesh.emotion_angry_percent = config[p].ML_models.facemesh.emotion_angry_percent;
        System._browser.camera.facemesh.emotion_sorrow_percent = config[p].ML_models.facemesh.emotion_sorrow_percent;
        System._browser.camera.facemesh.emotion_surprised_percent = config[p].ML_models.facemesh.emotion_surprised_percent;
        System._browser.camera.facemesh.emotion_tongue_out_percent = config[p].ML_models.facemesh.emotion_tongue_out_percent;
        System._browser.camera.facemesh.emotion_others_percent = config[p].ML_models.facemesh.emotion_others_percent;

        MMD_SA_options.user_camera.streamer_mode = config[p].streamer_mode || { camera_preference:{} };
        Object.assign(System._browser.camera.tilt_adjustment, config[p].ML_models.tilt_adjustment||{});
        break;

      case 'model_path_extra':
        MMD_SA_options.THREEX_options.model_path_extra = config[p];
        break;

      case 'hotkeys':
        const hotkeys = System._browser.hotkeys;
        if (!MMD_SA_options.Dungeon.started) {
          hotkeys.is_global = config[p].is_global;
          break;
        }

        const is_global_now = hotkeys.is_global;
        hotkeys.is_global = config[p].is_global;
//        if (MMD_SA_options.Dungeon.started && (is_global_now != hotkeys.is_global)) System._browser.hotkeys.register_global(hotkeys.is_global);

        hotkeys.configs?.forEach(config=>{
          const config_default = hotkeys._hotkey_config.find(c=>c.id==config.id);
          if (config_default)
            hotkeys.add(Object.assign({}, config_default, config));
        });
        break;
      case 'camera_face_locking':
        MMD_SA_options.camera_face_locking = config[p];
        break;
      case 'audio_visualizer':
        MMD_SA_options.use_CircularSpectrum = config[p];
        break;

      case 'video_capture':
        Object.assign(System._browser.video_capture, config[p]);
        break;

      case 'selfie_mode':
        MMD_SA_options.Dungeon_options.item_base.hand_camera.selfie_mode = config[p];
        break;
      case 'hand_camera_fov':
        MMD_SA_options.Dungeon_options.item_base.hand_camera.fov = config[p];
        if (config[p] != null)
          MMD_SA.THREEX.GUI.obj.visual_effects.folders[0].children[1].controllers[1].setValue(config[p]);
        break;

      case 'UI_muted':
        MMD_SA_options.Dungeon.inventory.UI.muted = config[p];
        break;

      case 'pose':
        if (config[p].custom_motion) {
          for (let i = 0; i < config[p].custom_motion.length; i++) {
            const path = config[p].custom_motion[i];
            const name = path.replace(/^.+[\/\\]/, "").replace(/\.([a-z0-9]{1,4})$/i, "");
            if (MMD_SA_options.motion_index_by_name[name] == null) {
              const index = MMD_SA_options.motion.length;
              MMD_SA_options.motion_index_by_name[name] = index;
              MMD_SA_options.motion.push({ path:path });
              window.dispatchEvent(new CustomEvent("SA_on_external_motion_loaded", { detail:{ path:path, index:1000+(index-MMD_SA.motion_max_default), result:{ return_value:false } } }));
//          await MMD_SA.load_external_motion(config[p].custom_motion[i], false);
            }
          }
        }
        MMD_SA_options._XRA_pose_reset(config[p].order);
        break;

      case 'PPE':
        Object.keys(config[p]).forEach(effect=>{
          const ec = config[p][effect];
          switch (effect) {
            case 'UnrealBloom':
              const UnrealBloom = MMD_SA.THREEX.PPE.UnrealBloom;
              for (const param of ['params', 'params_vrm']) {
//console.log(param, ec[param])
                if (ec[param]) {
                  UnrealBloom[param] = Object.assign({}, ec[param]);
                }
              }
              break;
            case 'N8AO':
              const N8AO = MMD_SA.THREEX.PPE.N8AO;
              for (const param of ['effectController', 'effectController_vrm']) {
//console.log(param, ec[param])
                if (ec[param]) {
                  N8AO[param] = Object.assign({}, ec[param]);
                }
              }
              break;
            case 'DOF':
              const DOF = MMD_SA.THREEX.PPE.DOF;
              for (const param of ['effectController']) {
//console.log(param, ec[param])
                if (ec[param]) {
                  DOF[param] = Object.assign({}, ec[param]);
                }
              }
              break;
          }
        });
        break;

      case 'VMC':
        MMD_SA.OSC.VMC.options.plugin.send.port = parseInt(config[p].send?.port) || MMD_SA.OSC.VMC.options_default.plugin.send.port;
        MMD_SA.OSC.VMC.options.plugin.send.host = config[p].send?.host || MMD_SA.OSC.VMC.options_default.plugin.send.host;
        if (MMD_SA.OSC.VMC.plugin) {
          MMD_SA.OSC.VMC.plugin.options.send.port = MMD_SA.OSC.VMC.options.plugin.send.port;
          MMD_SA.OSC.VMC.plugin.options.send.host = MMD_SA.OSC.VMC.options.plugin.send.host;
        }

        MMD_SA.OSC.app_mode = config[p].app_mode;
        break;
    }
  }
}
catch (err) {
  console.error(err);
  System.Gadget.Settings.writeString('LABEL_XRA_settings', '');
}
  }

  window.addEventListener("load", () => {
window.addEventListener('SA_dragdrop_JSON', (e)=>{
  const json = e.detail.json;
  if (json.XR_Animator_settings) {
    e.detail.result.return_value = true;
    MMD_SA_options._XRA_settings_import(json.XR_Animator_settings);
    DEBUG_show('✅Settings imported', 3);
  }
});

MMD_SA_options._XRA_settings_import();
  });

  window.addEventListener('jThree_ready', ()=>{
MMD_SA_options._XRA_settings_import();
  });

  window.addEventListener('MMDStarted', ()=>{
    System._browser.on_animation_update.add(()=>{
MMD_SA_options._XRA_settings_import();
    }, 0,0);

    window.addEventListener("SA_MMD_model0_onmotionchange", (e)=>{
//{ detail:{ motion_old:mm_old, motion_new:mmd.motionManager } }));
if (!System._browser.camera.ML_enabled) return;

const mm = e.detail.motion_new;
if (mm.filename == 'stand_simple') {
  MMD_SA_options.user_camera.streamer_mode.motion_id = (mm.para_SA.motion_tracking_upper_body_only) ? 1 : 0;
}
else if (mm.para_SA.motion_tracking_enabled) {
  MMD_SA_options.user_camera.streamer_mode.motion_id = mm.filename;
}
    });
  });


  EV_sync_update.fps_control = (function () {
    var update_frame = false
    var cooling_count = 0
    return function () {
      var camera = System._browser.camera;

// when backgroundThrottling is disabled and the app is hidden (i.e. System._browser.hidden), every requestAnimationFrame must be called and drawn (with dummy stuff in this case) to prevent the frames from halting
      if (System._browser.hidden || (RAF_timestamp_delta > 25) || MMD_SA_options.user_camera.ML_models.worker_disabled || !camera.initialized || camera._needs_RAF || !camera.ML_busy || (!is_mobile && ((camera.ML_fps > 15) || (cooling_count=10)) && (!camera.video.paused && (--cooling_count < 0))) || (!(camera.facemesh.enabled && camera.facemesh.use_mediapipe) && !camera.poseNet.enabled)) {
        camera._needs_RAF = false
        update_frame = true
      }
      else {
        update_frame = !update_frame
      }

      RAF_timestamp_delta_accumulated = (update_frame) ? 0 : RAF_timestamp_delta_accumulated + RAF_timestamp_delta;

      System._browser.motion_control.setMousePosition();

      return update_frame
    };
  })();


  MMD_SA_options.motion_para['motion_ukulele'] = Object.assign({}, MMD_SA_options.motion_para['sitting_sexy09']);


})();


document.write('<script language="JavaScript" src="' + toFileProtocol(Settings.f_path + '/animate_customized.js') + '"></scr'+'ipt>');;

// main js
if (MMD_SA_options.Dungeon_options)
  document.write('<script language="JavaScript" src="js/dungeon.js"></scr'+'ipt>');
document.write('<script language="JavaScript" src="MMD.js/MMD_SA.js"></scr'+'ipt>');
